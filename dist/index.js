(()=>{function e(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function n(n){for(var a=1;a<arguments.length;a++){var o=null!=arguments[a]?arguments[a]:{};a%2?e(Object(o),!0).forEach((function(e){t(n,e,o[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(o)):e(Object(o)).forEach((function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(o,e))}))}return n}function t(e,n,t){return(n=function(e){var n=function(e,n){if("object"!=typeof e||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var a=t.call(e,n||"default");if("object"!=typeof a)return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===n?String:Number)(e)}(e,"string");return"symbol"==typeof n?n:n+""}(n))in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}const a="MazeMaster";let o=a;try{const e="file:///home/saintorphan/Projects/PMasterQuest/SillyTavern/public/scripts/extensions/third-party/MazeMaster/src/index.js".match(/\/scripts\/extensions\/third-party\/([^/]+)\//);e&&e[1]&&(o=e[1])}catch(e){const n=document.querySelectorAll('script[src*="MazeMaster"]');for(const e of n){const n=e.src.match(/\/scripts\/extensions\/third-party\/([^/]+)\//);if(n&&n[1]){o=n[1];break}}}const{saveSettingsDebounced:i,SlashCommandParser:s,SlashCommand:r,ARGUMENT_TYPE:l,SlashCommandNamedArgument:m,executeSlashCommandsWithOptions:c,getRequestHeaders:d,callGenericPopup:p,POPUP_TYPE:u,generateQuietPrompt:g,getPresetManager:b,mainApi:f}=SillyTavern.getContext(),h=["#e74c3c","#3498db","#2ecc71","#f39c12","#9b59b6","#1abc9c","#e67e22","#34495e","#e91e63","#00bcd4","#8bc34a","#ff5722"],v={fraction:1,halfseg:.5,doubleseg:2},z=["fraction","halfseg","doubleseg"],y={1:{zoneWidth:.4,traverseTime:3500},2:{zoneWidth:.32,traverseTime:3e3},3:{zoneWidth:.26,traverseTime:2500},4:{zoneWidth:.2,traverseTime:2e3},5:{zoneWidth:.15,traverseTime:1600}},_={profiles:{},battlebarProfiles:{},mazeProfiles:{},minions:{},minionProfiles:{},trapProfiles:{},currentProfile:"default",currentBattlebarProfile:"default",currentMazeProfile:"default",currentMinionProfile:"default",currentTrapProfile:"default",activeGameConfig:"wheel",llmEnabled:!0,llmPreset:""},x={"Reward Wheel":{segments:[{trigger:"",text:"Small Prize",command:"/echo You won a small prize!",size:"fraction",respin:!1},{trigger:"",text:"Medium Prize",command:"/echo You won a medium prize!",size:"fraction",respin:!1},{trigger:"",text:"Big Prize!",command:"/echo Amazing! You won the big prize!",size:"halfseg",respin:!1},{trigger:"",text:"Try Again",command:"/echo Better luck next time...",size:"fraction",respin:!1},{trigger:"",text:"JACKPOT!",command:"/echo JACKPOT! Incredible luck!",size:"halfseg",respin:!1},{trigger:"",text:"Bonus Spin",command:"/echo You get another spin!",size:"fraction",respin:!0}],randomize:!0,difficulty:1},"Challenge Wheel":{segments:[{trigger:"",text:"Easy Task",command:"/echo Easy task assigned!",size:"doubleseg",respin:!1},{trigger:"",text:"Medium Task",command:"/echo Medium task assigned!",size:"fraction",respin:!1},{trigger:"",text:"Hard Task",command:"/echo Hard task - good luck!",size:"halfseg",respin:!1},{trigger:"",text:"Free Pass",command:"/echo Lucky! You get a free pass!",size:"halfseg",respin:!1},{trigger:"",text:"Double or Nothing",command:"/echo Spin again - double stakes!",size:"fraction",respin:!0}],randomize:!1,difficulty:2}},w={"Easy Fight":{difficulty:2,hitsToWin:3,missesToLose:5,description:"A minor enemy blocks your path - a quick skirmish to test your reflexes.",hitCommand:"/echo Hit! Keep going!",missCommand:"/echo Missed! Watch the timing!",winCommand:"/echo Victory! You defeated the enemy!",loseCommand:"/echo Defeated... Try again!",mainTitle:"Goblin",images:[{imagePath:"images/easy_fight.jpeg",stageMessage:"The enemy appears!"},{imagePath:"images/easy_fight.jpeg",stageMessage:"You land a blow!"},{imagePath:"images/easy_fight.jpeg",stageMessage:"Almost there!"},{imagePath:"images/easy_fight.jpeg",stageMessage:"Victory!"}],keyDropChance:40,powDropChance:20,stealthDropChance:10},"Boss Battle":{difficulty:4,hitsToWin:5,missesToLose:3,description:"A fearsome boss enemy stands before you - a brutal fight for survival with no room for error.",hitCommand:"/echo Critical hit!",missCommand:"/echo The boss counters!",winCommand:"/echo The boss has been defeated!",loseCommand:"/echo The boss was too powerful...",mainTitle:"Death Knight",images:[{imagePath:"images/boss_battle.jpeg",stageMessage:"The boss towers before you!"},{imagePath:"images/boss_battle.jpeg",stageMessage:"You find an opening!"},{imagePath:"images/boss_battle.jpeg",stageMessage:"The boss staggers!"},{imagePath:"images/boss_battle.jpeg",stageMessage:"Keep attacking!"},{imagePath:"images/boss_battle.jpeg",stageMessage:"One more hit!"},{imagePath:"images/boss_battle.jpeg",stageMessage:"VICTORY!"}],keyDropChance:50,powDropChance:30,stealthDropChance:20}};function M(e){return e?e.startsWith("/")||e.startsWith("http")?e:"/scripts/extensions/third-party/".concat(o,"/").concat(e):""}const E={herald:{name:"Herald",imagePath:"images/herald.jpeg",type:"messenger",description:"A mysterious messenger cloaked in shadow who delivers cryptic warnings and hints about the maze ahead.",messages:["Greetings, traveler!","The maze master watches...","Beware what lies ahead!"],encounterScript:""},guardian:{name:"Guardian",imagePath:"images/guardian.jpeg",type:"battlebar",description:"A fearsome armored warrior who blocks the path, challenging all who dare to pass.",battlebarProfiles:["Easy Fight"],messages:["You shall not pass!","Prepare to fight!","Only the worthy may continue!"],encounterScript:""},fortune_teller:{name:"Fortune Teller",imagePath:"images/fortune_teller.jpeg",type:"prizewheel",description:"An enigmatic mystic with glowing eyes who offers to reveal your fate through a magical spinning wheel.",wheelProfiles:["Reward Wheel"],messages:["Spin the wheel of fate!","Let destiny decide!","What fortune awaits you?"],encounterScript:""},trader:{name:"Wandering Trader",imagePath:"images/merchant.jpeg",type:"merchant",description:"A cunning merchant draped in exotic fabrics who trades valuable items for powerful rewards.",merchantItemCount:{min:2,max:4},messages:["Care to make a trade?","I have something special...","A fair exchange benefits us both!"],encounterScript:""}},k={spike_trap:{name:"Spike Trap",imagePath:"images/spike_trap.jpg",message:"Sharp spikes shoot up from the floor!",script:"/echo You triggered a spike trap!"},poison_gas:{name:"Poison Gas",imagePath:"images/poison_trap.jpeg",message:"A cloud of noxious gas fills the corridor!",script:"/echo Poison gas surrounds you!"}},I={"Dungeon Crawl":{herald:{name:"Herald",imagePath:"images/herald.jpeg",type:"messenger",description:"A mysterious messenger cloaked in shadow who delivers cryptic warnings and hints about the maze ahead.",messages:["Greetings, traveler!","The maze master watches...","Beware what lies ahead!"],encounterScript:""},guardian:{name:"Guardian",imagePath:"images/guardian.jpeg",type:"battlebar",description:"A fearsome armored warrior who blocks the path, challenging all who dare to pass.",battlebarProfiles:["Easy Fight"],messages:["You shall not pass!","Prepare to fight!","Only the worthy may continue!"],encounterScript:""},fortune_teller:{name:"Fortune Teller",imagePath:"images/fortune_teller.jpeg",type:"prizewheel",description:"An enigmatic mystic with glowing eyes who offers to reveal your fate through a magical spinning wheel.",wheelProfiles:["Reward Wheel"],messages:["Spin the wheel of fate!","Let destiny decide!","What fortune awaits you?"],encounterScript:""},trader:{name:"Wandering Trader",imagePath:"images/merchant.jpeg",type:"merchant",description:"A cunning merchant draped in exotic fabrics who trades valuable items for powerful rewards.",merchantItemCount:{min:2,max:4},messages:["Care to make a trade?","I have something special...","A fair exchange benefits us both!"],encounterScript:""}}},C={"Dungeon Crawl":{spike_trap:{name:"Spike Trap",imagePath:"images/spike_trap.jpg",message:"Sharp spikes shoot up from the floor!",script:"/echo You triggered a spike trap!"},poison_gas:{name:"Poison Gas",imagePath:"images/poison_trap.jpeg",message:"A cloud of noxious gas fills the corridor!",script:"/echo Poison gas surrounds you!"}}},S={"Dungeon Crawl":{gridSize:10,winCommand:"/echo Congratulations! You escaped the dungeon!",loseCommand:"/echo The dungeon claims another victim...",winMessage:"You found the exit and escaped!",winImage:"",mainMinion:"guardian",mainMinionIntroMessage:"Welcome to my dungeon, adventurer. Find the exit... if you can!",mainMinionRandomChance:20,mainMinionRandomMessages:["Still wandering, I see...","The exit grows ever closer... or does it?","Many have tried. Few have succeeded.","Your persistence is... admirable."],mainMinionExitType:"battlebar",mainMinionExitProfile:"Boss Battle",minionEncounters:[{minionId:"herald",percent:15},{minionId:"guardian",percent:10},{minionId:"fortune_teller",percent:8},{minionId:"trader",percent:3}],trapEncounters:[{trapId:"spike_trap",percent:4},{trapId:"poison_gas",percent:3}],onBattlebarLoss:"respawn",chestTilePercent:15,chestLockedPercent:30,chestLockedBonusPercent:50,chestMimicPercent:15,chestLootMin:1,chestLootMax:3,chestKeyChance:35,chestPowChance:45,chestStealthChance:15,chestGrandpowChance:2,lockedChestKeyChance:25,lockedChestPowChance:55,lockedChestStealthChance:25,lockedChestGrandpowChance:8,startingInventory:{key:1,pow:0,stealth:1,grandpow:0},storyConfig:{mainStory:"You descend into the ancient dungeon. Shadows dance on the walls as torchlight flickers...",milestones:[{percent:25,storyUpdate:"You venture deeper. The air grows colder and the walls damper."},{percent:50,storyUpdate:"Halfway through! Strange sounds echo from the darkness ahead."},{percent:75,storyUpdate:"You sense the exit is near. But so is something else..."}]}}};let P={},B={segments:[],isOpen:!1,isSpinning:!1,pendingRespin:!1,hasRespun:!1},L={isOpen:!1,profile:null,hits:0,misses:0,arrowPosition:0,arrowDirection:1,zoneStart:0,zoneEnd:0,animationId:null,lastFrameTime:0,isVictory:!1,isDefeat:!1},T={isOpen:!1,profile:null,profileName:null,grid:[],size:10,playerX:0,playerY:0,exitX:0,exitY:0,visited:new Set,isVictory:!1,currentMinion:null,isPaused:!1,pendingEncounter:null,exitEncounterDone:!1,inventory:{key:0,stealth:0,pow:0,grandpow:0},pendingConfirmation:null,pendingChest:null};const O={wheel:{},battlebar:{},maze:{}},D=new WeakSet;async function N(e){const{minionName:n,minionDescription:t,baseMessage:a,mainStory:o,currentMilestone:i,minionType:s}=e;if(!a)return"";if(!1===P.llmEnabled)return console.log("[MazeMaster] LLM generation disabled, using base message"),a;if("function"!=typeof g)return console.log("[MazeMaster] generateQuietPrompt not available, using base message"),a;let r=[];o&&r.push("Story Setting: ".concat(o)),i&&r.push("Current Progress: ".concat(i));const l=t||{messenger:"a mysterious messenger who delivers cryptic hints",battlebar:"a guardian who challenges travelers to combat",prizewheel:"a fortune teller who offers games of chance",merchant:"a wandering trader who barters for rare items"}[s]||"a mysterious figure",m="You are ".concat(n,", ").concat(l,".\n\n").concat(r.length>0?r.join("\n")+"\n\n":"",'The player has encountered you in a maze. Based on this message template: "').concat(a,'"\n\nWrite a short, atmospheric response (1-2 sentences max, under 100 characters if possible). Stay in character. Be mysterious and engaging. Do not use quotation marks around your response.');try{console.log("[MazeMaster] Generating LLM message for:",n);const e=await g(m,{quietToLoud:!1,skipWIAN:!0,max_length:80});if(e&&e.trim()){let n=e.trim();return n=n.replace(/^["']|["']$/g,""),n=n.replace(/^["""''']|["""''']$/g,""),console.log("[MazeMaster] Generated message:",n),n}}catch(e){console.error("[MazeMaster] LLM generation failed:",e)}return a}function A(){var e;if(!T.isOpen||!T.profile)return null;const n=T.profile.storyConfig;if(!n||!n.milestones||0===n.milestones.length)return null;const t=T.size*T.size,a=((null===(e=T.visited)||void 0===e?void 0:e.size)||0)/t*100;let o=null;for(const e of n.milestones)a>=e.percent&&(o=e.storyUpdate);return o}function j(){var e;return T.isOpen&&T.profile&&(null===(e=T.profile.storyConfig)||void 0===e?void 0:e.mainStory)||null}function R(){return Object.keys(P.profiles||{})}function q(e){return P.profiles[e]}function W(){return Object.keys(P.battlebarProfiles||{})}function H(e){return P.battlebarProfiles[e]}function G(e,n){var t,a,o;P.battlebarProfiles[e]={mainTitle:n.mainTitle||"",description:n.description||"",difficulty:n.difficulty||3,hitsToWin:n.hitsToWin||5,missesToLose:n.missesToLose||3,hitCommand:n.hitCommand||"",missCommand:n.missCommand||"",winCommand:n.winCommand||"",loseCommand:n.loseCommand||"",images:n.images||[],keyDropChance:null!==(t=n.keyDropChance)&&void 0!==t?t:40,powDropChance:null!==(a=n.powDropChance)&&void 0!==a?a:20,stealthDropChance:null!==(o=n.stealthDropChance)&&void 0!==o?o:10},i(),console.log("[MazeMaster] Battlebar profile saved:",e,P.battlebarProfiles[e])}function F(){return Object.keys(P.mazeProfiles||{})}function Y(e){return P.mazeProfiles[e]}function U(e,n){P.mazeProfiles[e]={gridSize:n.gridSize||10,winCommand:n.winCommand||"",winImage:n.winImage||"",winMessage:n.winMessage||"",mainMinion:n.mainMinion||"",mainMinionIntroMessage:n.mainMinionIntroMessage||"",mainMinionRandomChance:n.mainMinionRandomChance||15,mainMinionRandomMessages:n.mainMinionRandomMessages||[],mainMinionExitType:n.mainMinionExitType||"messenger",mainMinionExitProfile:n.mainMinionExitProfile||"",minionEncounters:n.minionEncounters||[],onBattlebarLoss:n.onBattlebarLoss||"continue",loseCommand:n.loseCommand||"",chestTilePercent:n.chestTilePercent||10,chestLockedPercent:n.chestLockedPercent||30,chestLockedBonusPercent:n.chestLockedBonusPercent||50,chestMimicPercent:n.chestMimicPercent||15,chestLootMin:n.chestLootMin||1,chestLootMax:n.chestLootMax||2,chestKeyChance:n.chestKeyChance||30,chestPowChance:n.chestPowChance||50,chestStealthChance:n.chestStealthChance||0,lockedChestKeyChance:n.lockedChestKeyChance||40,lockedChestPowChance:n.lockedChestPowChance||60,lockedChestStealthChance:n.lockedChestStealthChance||30,chestGrandpowChance:n.chestGrandpowChance||0,lockedChestGrandpowChance:n.lockedChestGrandpowChance||5,startingInventory:n.startingInventory||{key:0,stealth:0,pow:0,grandpow:0},trapEncounters:n.trapEncounters||[],storyConfig:n.storyConfig||{mainStory:"",milestones:[]}},i(),console.log("[MazeMaster] Maze profile saved:",e,P.mazeProfiles[e])}function J(){return Object.keys(P.minions||{})}function V(e){return P.minions[e]}function K(e,n){P.minions[e]={name:n.name||"Unknown",imagePath:n.imagePath||"",description:n.description||"",type:n.type||"messenger",battlebarProfiles:n.battlebarProfiles||[],wheelProfiles:n.wheelProfiles||[],messages:n.messages||[],encounterScript:n.encounterScript||"",merchantItemCount:n.merchantItemCount||{min:1,max:3}},i(),console.log("[MazeMaster] Minion saved:",e,P.minions[e])}function X(){return Object.keys(P.traps||{})}function Q(e){var n;return null===(n=P.traps)||void 0===n?void 0:n[e]}function $(e,n){P.traps||(P.traps={}),P.traps[e]={name:n.name||"Unknown Trap",imagePath:n.imagePath||"",message:n.message||"You triggered a trap!",script:n.script||""},i(),console.log("[MazeMaster] Trap saved:",e,P.traps[e])}function Z(e){const t=q(e);return t&&t.segments&&0!==t.segments.length?(B.segments=t.segments.map(((e,t)=>n(n({},e),{},{units:v[e.size]||1,color:h[t%h.length]}))),B.isOpen=!1,B.isSpinning=!1,B.pendingRespin=!1,B.hasRespun=!1,{success:!0,count:B.segments.length}):{error:'Profile "'.concat(e,'" not found or empty')}}function ee(){const e=B.segments.filter((e=>"halfseg"===e.size)).length,n=B.segments.filter((e=>"doubleseg"===e.size)).length;return e!==n?(console.error("[MazeMaster] Wheel balance error: ".concat(e," halfseg(s) but ").concat(n," doubleseg(s). They must be equal.")),{valid:!1,error:"Wheel unbalanced: ".concat(e," halfseg(s) â‰  ").concat(n," doubleseg(s)")}):{valid:!0}}function ne(){return B.segments.reduce(((e,n)=>e+n.units),0)}function te(){const e=document.getElementById("mazemaster_wheel_modal");if(e&&e.remove(),!document.getElementById("mazemaster_wheel_styles")){const e=document.createElement("style");e.id="mazemaster_wheel_styles",e.textContent="\n        .mazemaster-wheel-overlay {\n            position: fixed;\n            top: 0;\n            left: 0;\n            right: 0;\n            bottom: 0;\n            background: rgba(0, 0, 0, 0.85);\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            z-index: 10002;\n        }\n\n        .mazemaster-wheel-container {\n            position: relative;\n            display: flex;\n            flex-direction: column;\n            align-items: center;\n            gap: 20px;\n        }\n\n        .mazemaster-wheel-pointer {\n            position: absolute;\n            top: -20px;\n            left: 50%;\n            transform: translateX(-50%);\n            width: 0;\n            height: 0;\n            border-left: 15px solid transparent;\n            border-right: 15px solid transparent;\n            border-top: 30px solid #fff;\n            z-index: 10;\n            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));\n        }\n\n        #mazemaster_wheel_canvas {\n            border-radius: 50%;\n            box-shadow: 0 0 30px rgba(0,0,0,0.5), inset 0 0 20px rgba(255,255,255,0.1);\n            transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99);\n        }\n\n        .mazemaster-spin-btn {\n            padding: 15px 40px;\n            font-size: 1.2em;\n            font-weight: bold;\n            background: linear-gradient(135deg, #e74c3c, #c0392b);\n            color: white;\n            border: none;\n            border-radius: 30px;\n            cursor: pointer;\n            display: flex;\n            align-items: center;\n            gap: 10px;\n            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);\n            transition: transform 0.2s, box-shadow 0.2s;\n        }\n\n        .mazemaster-spin-btn:hover {\n            transform: scale(1.05);\n            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.6);\n        }\n\n        .mazemaster-spin-btn:disabled {\n            background: #555;\n            cursor: not-allowed;\n            box-shadow: none;\n            transform: none;\n        }\n\n        .mazemaster-spin-btn.respin {\n            background: linear-gradient(135deg, #f39c12, #d68910);\n            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.4);\n        }\n\n        .mazemaster-spin-btn.respin:hover {\n            box-shadow: 0 6px 20px rgba(243, 156, 18, 0.6);\n        }\n    ",document.head.appendChild(e)}const n=document.createElement("div");n.innerHTML='\n        <div id="mazemaster_wheel_modal" class="mazemaster-wheel-overlay">\n            <div class="mazemaster-wheel-container">\n                <div class="mazemaster-wheel-pointer"></div>\n                <canvas id="mazemaster_wheel_canvas" width="400" height="400"></canvas>\n                <button id="mazemaster_spin_btn" class="mazemaster-spin-btn">\n                    <i class="fa-solid fa-play"></i> SPIN\n                </button>\n            </div>\n        </div>\n    ',document.body.appendChild(n.firstElementChild);const t=document.getElementById("mazemaster_wheel_canvas");t&&function(e){const n=e.getContext("2d"),t=e.width/2,a=e.height/2,o=Math.min(t,a)-10;n.clearRect(0,0,e.width,e.height);const i=ne();let s=-Math.PI/2;for(const e of B.segments){const r=e.units/i*2*Math.PI;n.beginPath(),n.moveTo(t,a),n.arc(t,a,o,s,s+r),n.closePath(),n.fillStyle=e.color,n.fill(),n.strokeStyle="#222",n.lineWidth=2,n.stroke();const l=s+r/2,m=.55*o,c=t+Math.cos(l)*m,d=a+Math.sin(l)*m;n.save(),n.translate(c,d),n.rotate(l),n.fillStyle="#fff",n.font="bold 12px Arial",n.textAlign="center",n.textBaseline="middle",n.shadowColor="rgba(0,0,0,0.5)",n.shadowBlur=3;let p=e.text||e.trigger;p.length>12&&(p=p.substring(0,10)+"..."),n.fillText(p,0,0),n.restore(),s+=r}n.beginPath(),n.arc(t,a,20,0,2*Math.PI),n.fillStyle="#333",n.fill(),n.strokeStyle="#555",n.lineWidth=3,n.stroke()}(t);const a=document.getElementById("mazemaster_spin_btn");a&&a.addEventListener("click",ae),B.isOpen=!0}async function ae(){var e,n;const t=document.getElementById("mazemaster_spin_btn");if(!t||B.isSpinning)return;t.disabled=!0,t.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> Spinning...',B.isSpinning=!0,B.pendingRespin=!1;const a=function(){const e=ne();let n=Math.random()*e;for(const e of B.segments)if(n-=e.units,n<=0)return e;return B.segments[B.segments.length-1]}(),o=document.getElementById("mazemaster_wheel_canvas");if(!o)return void(B.isSpinning=!1);const i=ne();let s=0;for(const e of B.segments){if(e===a)break;s+=e.units/i*360}const r=s+a.units/i*360/2,l=5+Math.floor(3*Math.random()),m=parseFloat((null===(e=o.style.transform)||void 0===e||null===(e=e.match(/rotate\((\d+\.?\d*)deg\)/))||void 0===e?void 0:e[1])||0)+360*l+(360-r);o.style.transition="transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99)",o.style.transform="rotate(".concat(m,"deg)"),await new Promise((e=>setTimeout(e,4200))),B.isSpinning=!1;const d=null===(n=P.profiles[P.currentProfile])||void 0===n||null===(n=n.segments)||void 0===n?void 0:n.find((e=>e.trigger===a.trigger));if(d&&d.command){console.log('[MazeMaster] Executing command for "'.concat(a.text,'": ').concat(d.command));try{await c(d.command)}catch(e){console.error("[MazeMaster] Error executing command:",e)}}O.wheel[P.currentProfile]={segmentName:a.text,command:(null==d?void 0:d.command)||"",timestamp:Date.now()},a.respin&&!B.hasRespun?(B.pendingRespin=!0,B.hasRespun=!0,t.disabled=!1,t.className="mazemaster-spin-btn respin",t.innerHTML='<i class="fa-solid fa-rotate"></i> RESPIN'):(!function(){const e=document.getElementById("mazemaster_wheel_modal");if(e&&e.remove(),B.isOpen=!1,T.isOpen&&T.pendingEncounter){const e=T.pendingEncounter.type;"exit_wheel"===e?(T.exitEncounterDone=!0,T.isPaused=!1,nn()):"wheel"===e&&Ne()}}(),B.segments=[],B.isOpen=!1,B.isSpinning=!1,B.pendingRespin=!1,B.hasRespun=!1)}function oe(){s.addCommandObject(r.fromProps({name:"wheel",callback:async e=>{const n=e.profile||"default",t=Z(n);if(t.error)return"Error: ".concat(t.error);const a=ee();return a.valid?(P.currentProfile=n,te(),'Wheel "'.concat(n,'" opened with ').concat(t.count," segments. Click SPIN!")):"Error: ".concat(a.error)},namedArgumentList:[m.fromProps({name:"profile",description:"Name of the wheel profile to use",typeList:[l.STRING],isRequired:!1,defaultValue:"default"})],helpString:'Open a wheel by profile name. Example: /wheel profile="mywheel"'})),s.addCommandObject(r.fromProps({name:"battlebar",callback:async e=>{const n=e.profile||"default",t=ie(n);return t.error?"Error: ".concat(t.error):'Battlebar "'.concat(n,'" started! Press SPACE when the arrow is in the green zone.')},namedArgumentList:[m.fromProps({name:"profile",description:"Name of the battlebar profile to use",typeList:[l.STRING],isRequired:!1,defaultValue:"default"})],helpString:'Start a battlebar challenge. Example: /battlebar profile="boss1"'})),s.addCommandObject(r.fromProps({name:"maze",callback:async e=>{const n=e.profile||P.currentMazeProfile||"default",t=Ce(n);return t.error?"Error: ".concat(t.error):'Maze "'.concat(n,'" started! Use arrow keys to navigate.')},namedArgumentList:[m.fromProps({name:"profile",description:"Name of the maze profile to use",typeList:[l.STRING],isRequired:!1})],helpString:'Start a maze game. Example: /maze profile="dungeon1"'})),s.addCommandObject(r.fromProps({name:"mazeminion",callback:async e=>{if(!T.isOpen)return"No maze is currently open.";const n=e.name,t=e.message||"",a=V(n);return T.currentMinion=a?{name:a.name,imagePath:a.imagePath,message:t}:{name:n||"Unknown",imagePath:"",message:t},Le(),""},namedArgumentList:[m.fromProps({name:"name",description:"Minion name (from config) or custom name",typeList:[l.STRING],isRequired:!1}),m.fromProps({name:"message",description:"Message to display",typeList:[l.STRING],isRequired:!1})],helpString:'Set the minion display in an active maze. Example: /mazeminion name="Goblin" message="You shall not pass!"'})),console.log("[MazeMaster] Slash commands registered")}function ie(e){const n=H(e);return n?(L={isOpen:!0,profile:n,hits:0,misses:0,arrowPosition:0,arrowDirection:1,zoneStart:0,zoneEnd:0,animationId:null,lastFrameTime:0,isVictory:!1,isDefeat:!1},ge(),function(){const e=document.getElementById("mazemaster_battlebar_modal");e&&e.remove();if(!document.getElementById("mazemaster_battlebar_styles")){const e=document.createElement("style");e.id="mazemaster_battlebar_styles",e.textContent="\n        .mazemaster-bb-overlay {\n            position: fixed;\n            top: 0;\n            left: 0;\n            right: 0;\n            bottom: 0;\n            background: rgba(0, 0, 0, 0.9);\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            z-index: 10010;\n        }\n\n        .mazemaster-bb-container {\n            display: flex;\n            flex-direction: column;\n            align-items: center;\n            gap: 15px;\n            padding: 25px;\n            background: #1a1a2e;\n            border-radius: 15px;\n            border: 2px solid #333;\n            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);\n            max-width: 95vw;\n            max-height: 95vh;\n            min-height: 500px;\n            min-width: 400px;\n            overflow-y: auto;\n        }\n\n        .mazemaster-bb-main-title {\n            font-size: 32px;\n            font-weight: bold;\n            color: #fff;\n            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);\n            text-align: center;\n        }\n\n        .mazemaster-bb-stage-title {\n            font-size: 20px;\n            color: #aaa;\n            text-align: center;\n            min-height: 24px;\n        }\n\n        .mazemaster-bb-image-display {\n            width: min(300px, 80vw);\n            height: min(300px, 40vh);\n            border: 3px solid #444;\n            border-radius: 10px;\n            overflow: hidden;\n            background: #222;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n        }\n\n        .mazemaster-bb-image-display img {\n            max-width: 100%;\n            max-height: 100%;\n            object-fit: contain;\n        }\n\n        .mazemaster-bb-stats {\n            display: flex;\n            gap: 30px;\n            font-size: 1.2em;\n            font-weight: bold;\n        }\n\n        .bb-stat-hits {\n            color: #27ae60;\n        }\n\n        .bb-stat-misses {\n            color: #e74c3c;\n        }\n\n        .mazemaster-bb-bar-container {\n            padding: 10px;\n        }\n\n        .mazemaster-bb-bar {\n            position: relative;\n            width: min(400px, 90vw);\n            height: 50px;\n            background: linear-gradient(to bottom, #c0392b, #a93226);\n            border-radius: 8px;\n            overflow: hidden;\n            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5), inset 0 2px 5px rgba(0, 0, 0, 0.3);\n        }\n\n        .mazemaster-bb-zone {\n            position: absolute;\n            height: 100%;\n            background: linear-gradient(to bottom, #27ae60, #1e8449);\n            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.2);\n        }\n\n        .mazemaster-bb-arrow {\n            position: absolute;\n            width: 6px;\n            height: 100%;\n            background: #fff;\n            box-shadow: 0 0 15px #fff, 0 0 30px rgba(255, 255, 255, 0.5);\n            left: 0;\n            transition: none;\n        }\n\n        .mazemaster-bb-instructions {\n            font-size: 1.1em;\n            color: #aaa;\n        }\n\n        .mazemaster-bb-instructions kbd {\n            background: #444;\n            padding: 5px 15px;\n            border-radius: 5px;\n            font-weight: bold;\n            color: #fff;\n            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);\n        }\n\n        .mazemaster-bb-bar.flash-hit {\n            animation: flashHit 0.3s ease;\n        }\n\n        .mazemaster-bb-bar.flash-miss {\n            animation: flashMiss 0.3s ease;\n        }\n\n        @keyframes flashHit {\n            0%, 100% { box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5); }\n            50% { box-shadow: 0 0 30px rgba(39, 174, 96, 0.8), 0 0 60px rgba(39, 174, 96, 0.5); }\n        }\n\n        @keyframes flashMiss {\n            0%, 100% { box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5); }\n            50% { box-shadow: 0 0 30px rgba(231, 76, 60, 0.8), 0 0 60px rgba(231, 76, 60, 0.5); }\n        }\n\n        .mazemaster-bb-hit-btn {\n            width: min(100%, 90vw);\n            max-width: 400px;\n            padding: 20px 30px;\n            font-size: 24px;\n            font-weight: bold;\n            background: linear-gradient(135deg, #27ae60, #2ecc71);\n            color: white;\n            border: none;\n            border-radius: 12px;\n            cursor: pointer;\n            margin-top: 10px;\n            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);\n            transition: transform 0.1s ease, box-shadow 0.1s ease;\n            touch-action: manipulation;\n            -webkit-tap-highlight-color: transparent;\n        }\n\n        .mazemaster-bb-hit-btn:hover {\n            transform: scale(1.02);\n            box-shadow: 0 8px 25px rgba(39, 174, 96, 0.5);\n        }\n\n        .mazemaster-bb-hit-btn:active {\n            transform: scale(0.98);\n            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);\n        }\n\n        .mazemaster-bb-hit-btn i {\n            margin-right: 10px;\n        }\n\n        .mazemaster-bb-hit-btn.victory {\n            background: linear-gradient(135deg, #f39c12, #e67e22);\n            box-shadow: 0 6px 20px rgba(243, 156, 18, 0.4);\n        }\n\n        .mazemaster-bb-hit-btn.victory:hover {\n            box-shadow: 0 8px 25px rgba(243, 156, 18, 0.5);\n        }\n\n        .mazemaster-bb-hit-btn.defeat {\n            background: linear-gradient(135deg, #c0392b, #e74c3c);\n            box-shadow: 0 6px 20px rgba(192, 57, 43, 0.4);\n        }\n\n        .mazemaster-bb-hit-btn.defeat:hover {\n            box-shadow: 0 8px 25px rgba(192, 57, 43, 0.5);\n        }\n    ",document.head.appendChild(e)}const n=document.createElement("div");n.innerHTML='\n        <div id="mazemaster_battlebar_modal" class="mazemaster-bb-overlay">\n            <div class="mazemaster-bb-container">\n                <div id="bb_main_title" class="mazemaster-bb-main-title"></div>\n                <div class="mazemaster-bb-image-display">\n                    <img id="mazemaster_bb_img" src="" alt="">\n                </div>\n                <div id="bb_stage_title" class="mazemaster-bb-stage-title"></div>\n                <div class="mazemaster-bb-stats">\n                    <span class="bb-stat bb-stat-hits">\n                        Hits: <span id="bb_current_hits">0</span>/<span id="bb_needed_hits">5</span>\n                    </span>\n                    <span class="bb-stat bb-stat-misses">\n                        Misses: <span id="bb_current_misses">0</span>/<span id="bb_max_misses">3</span>\n                    </span>\n                </div>\n                <div class="mazemaster-bb-bar-container">\n                    <div class="mazemaster-bb-bar">\n                        <div class="mazemaster-bb-zone" id="bb_zone"></div>\n                        <div class="mazemaster-bb-arrow" id="bb_arrow"></div>\n                    </div>\n                </div>\n                <div class="mazemaster-bb-instructions">\n                    Press <kbd>SPACE</kbd> when the arrow is in the green zone!\n                </div>\n                <div class="mazemaster-bb-action-buttons">\n                    <button id="mazemaster_bb_hit_btn" class="mazemaster-bb-hit-btn">\n                        <i class="fa-solid fa-bullseye"></i> HIT!\n                    </button>\n                    <button id="mazemaster_bb_pow_btn" class="mazemaster-bb-pow-btn" style="display: none;">\n                        <i class="fa-solid fa-bolt"></i> POW! (<span id="bb_pow_count">0</span>)\n                    </button>\n                    <button id="mazemaster_bb_grandpow_btn" class="mazemaster-bb-grandpow-btn" style="display: none;">\n                        <i class="fa-solid fa-star"></i> GRANDPOW! (<span id="bb_grandpow_count">0</span>)\n                    </button>\n                </div>\n            </div>\n        </div>\n    ',document.body.appendChild(n.firstElementChild),fe(),be(),he(),se();const t=document.getElementById("mazemaster_bb_hit_btn");t&&t.addEventListener("click",re);const a=document.getElementById("mazemaster_bb_pow_btn");a&&a.addEventListener("click",me);const o=document.getElementById("mazemaster_bb_grandpow_btn");o&&o.addEventListener("click",pe);le(),de()}(),function(){const e=100/y[L.profile.difficulty||3].traverseTime;function n(t){if(!L.isOpen)return;0===L.lastFrameTime&&(L.lastFrameTime=t);const a=t-L.lastFrameTime;L.lastFrameTime=t,L.arrowPosition+=e*a*L.arrowDirection,L.arrowPosition>=100?(L.arrowPosition=100,L.arrowDirection=-1):L.arrowPosition<=0&&(L.arrowPosition=0,L.arrowDirection=1),function(){const e=document.getElementById("bb_arrow");e&&(e.style.left="".concat(L.arrowPosition,"%"))}(),L.animationId=requestAnimationFrame(n)}L.lastFrameTime=0,L.animationId=requestAnimationFrame(n)}(),document.addEventListener("keydown",ve),{success:!0}):{error:'Battlebar profile "'.concat(e,'" not found')}}async function se(){const e=L.profile||{},n=document.getElementById("bb_main_title");n&&(n.textContent=e.mainTitle||"");const t=document.getElementById("bb_stage_title");if(t){const n=(e.images||[])[L.hits||0],o=(null==n?void 0:n.stageMessage)||"";if(t.textContent=o,o&&!1!==P.llmEnabled)try{var a;const n=await async function(e){const{battlebarName:n,description:t,stageMessage:a,mainStory:o,currentHits:i,hitsToWin:s}=e;if(!a)return"";if(!1===P.llmEnabled)return a;if("function"!=typeof g)return a;const r=void 0!==i&&s?"Progress: ".concat(i,"/").concat(s," hits"):"",l=t||"a challenging combat encounter",m='The player is in a battle called "'.concat(n,'" - ').concat(l,".\n\n").concat(o?"Story Setting: ".concat(o,"\n\n"):"").concat(r?r+"\n\n":"",'Based on this stage message: "').concat(a,'"\n\nWrite a short, intense combat narration (1-2 sentences, under 100 characters). Make it exciting and dramatic. Do not use quotation marks.');try{console.log("[MazeMaster] Generating LLM message for battlebar:",n);const e=await g(m,{quietToLoud:!1,skipWIAN:!0,max_length:80});if(e&&e.trim()){let n=e.trim();return n=n.replace(/^["']|["']$/g,""),n=n.replace(/^["""''']|["""''']$/g,""),console.log("[MazeMaster] Generated battlebar message:",n),n}}catch(e){console.error("[MazeMaster] Battlebar LLM generation failed:",e)}return a}({battlebarName:e.mainTitle||"Battle",description:e.description||"",stageMessage:o,mainStory:(null===(a=T.profile)||void 0===a||null===(a=a.storyConfig)||void 0===a?void 0:a.mainStory)||"",currentHits:L.hits,hitsToWin:e.hitsToWin});n&&n!==o&&(t.textContent=n)}catch(e){console.error("[MazeMaster] Battlebar LLM generation failed:",e)}}}function re(e){if(e.preventDefault(),!L.isOpen)return;if(L.isVictory||L.isDefeat)return void ue();const n=L.arrowPosition>=L.zoneStart&&L.arrowPosition<=L.zoneEnd;console.log("[MazeMaster] Hit check:",{arrowPosition:L.arrowPosition,zoneStart:L.zoneStart,zoneEnd:L.zoneEnd,inZone:n}),n?ze():ye()}function le(){const e=document.getElementById("mazemaster_bb_pow_btn"),n=document.getElementById("bb_pow_count");e&&T.isOpen&&T.inventory.pow>0?(e.style.display="",n&&(n.textContent=T.inventory.pow)):e&&(e.style.display="none")}function me(e){e.preventDefault(),!T.isOpen||T.inventory.pow<=0||L.isOpen&&(L.isVictory||L.isDefeat||(Re("pow"),le(),L.hits++,updateBattlebarDisplay(),L.hits>=L.profile.hitsToWin&&_e()))}function ce(){return T.pendingEncounter&&"exit_battlebar"===T.pendingEncounter.type}function de(){const e=document.getElementById("mazemaster_bb_grandpow_btn"),n=document.getElementById("bb_grandpow_count");e&&T.isOpen&&T.inventory.grandpow>0&&!ce()?(e.style.display="",n&&(n.textContent=T.inventory.grandpow)):e&&(e.style.display="none")}function pe(e){e.preventDefault(),!T.isOpen||T.inventory.grandpow<=0||L.isOpen&&(L.isVictory||L.isDefeat||(ce()?console.log("[MazeMaster] GRANDPOW cannot be used against the main minion!"):(Re("grandpow"),de(),L.hits=L.profile.hitsToWin,updateBattlebarDisplay(),_e())))}function ue(){const e=L.isVictory,n=L.isDefeat;L.animationId&&cancelAnimationFrame(L.animationId),document.removeEventListener("keydown",ve);const t=document.getElementById("mazemaster_battlebar_modal");if(t&&t.remove(),L.isOpen=!1,L.isVictory=!1,L.isDefeat=!1,T.isOpen&&T.pendingEncounter){const t=T.pendingEncounter.type;if(e)"exit_battlebar"===t?(T.exitEncounterDone=!0,T.isPaused=!1,nn()):Ne();else if(n){const e=T.profile.onBattlebarLoss||"continue";if("exit_battlebar"===t)"gameover"===e?Ze():en();else switch(e){case"gameover":Ze();break;case"respawn":en();break;default:Ne()}}}}function ge(){const e=L.profile.difficulty||3,n=y[e];if(!n)return void console.error("[MazeMaster] Invalid difficulty level:",e);const t=100*n.zoneWidth,a=100-t;L.zoneStart=Math.random()*a,L.zoneEnd=L.zoneStart+t,console.log("[MazeMaster] Zone randomized:",{difficulty:e,zoneWidth:t,zoneStart:L.zoneStart,zoneEnd:L.zoneEnd})}function be(){const e=document.getElementById("bb_zone");e&&(e.style.left="".concat(L.zoneStart,"%"),e.style.width="".concat(L.zoneEnd-L.zoneStart,"%"))}function fe(){const e=document.getElementById("bb_current_hits"),n=document.getElementById("bb_needed_hits"),t=document.getElementById("bb_current_misses"),a=document.getElementById("bb_max_misses");e&&(e.textContent=L.hits),n&&(n.textContent=L.profile.hitsToWin||5),t&&(t.textContent=L.misses),a&&(a.textContent=L.profile.missesToLose||3)}function he(){const e=document.getElementById("mazemaster_bb_img");if(!e)return;const n=L.profile.images||[];if(0===n.length)return void(e.style.display="none");const t=n[Math.min(L.hits,n.length-1)],a=t.imagePath||t.path||"";a?(e.src=M(a),e.style.display="block"):e.style.display="none"}function ve(e){if("Space"!==e.code||!L.isOpen)return;if(e.preventDefault(),L.isVictory||L.isDefeat)return void ue();L.arrowPosition>=L.zoneStart&&L.arrowPosition<=L.zoneEnd?ze():ye()}async function ze(){L.hits++;const e=document.querySelector(".mazemaster-bb-bar");if(e&&(e.classList.remove("flash-hit","flash-miss"),e.offsetWidth,e.classList.add("flash-hit")),fe(),he(),await se(),L.profile.hitCommand)try{await c(L.profile.hitCommand)}catch(e){console.error("[MazeMaster] Hit command error:",e)}L.hits>=(L.profile.hitsToWin||5)?await _e():(ge(),be())}async function ye(){L.misses++;const e=document.querySelector(".mazemaster-bb-bar");if(e&&(e.classList.remove("flash-hit","flash-miss"),e.offsetWidth,e.classList.add("flash-miss")),fe(),L.profile.missCommand)try{await c(L.profile.missCommand)}catch(e){console.error("[MazeMaster] Miss command error:",e)}L.misses>=(L.profile.missesToLose||3)&&await async function(){const e=P.currentBattlebarProfile||"default";O.battlebar[e]={result:"lose",hits:L.hits,misses:L.misses,timestamp:Date.now()},L.isDefeat=!0,L.animationId&&(cancelAnimationFrame(L.animationId),L.animationId=null);const n=document.querySelector(".mazemaster-bb-bar-container"),t=document.querySelector(".mazemaster-bb-instructions");n&&(n.style.display="none");t&&(t.style.display="none");const a=document.getElementById("bb_stage_title");a&&(a.textContent="Defeat...");const o=document.getElementById("mazemaster_bb_hit_btn");o&&(o.innerHTML='<i class="fa-solid fa-times"></i> Close',o.classList.add("defeat"));if(L.profile.loseCommand)try{await c(L.profile.loseCommand)}catch(e){console.error("[MazeMaster] Lose command error:",e)}}()}async function _e(){const e=P.currentBattlebarProfile||"default";if(O.battlebar[e]={result:"win",hits:L.hits,misses:L.misses,timestamp:Date.now()},L.isVictory=!0,T.isOpen&&T.pendingEncounter){var n,t,a;const e=L.profile;100*Math.random()<(null!==(n=e.keyDropChance)&&void 0!==n?n:40)&&je("key"),100*Math.random()<(null!==(t=e.powDropChance)&&void 0!==t?t:20)&&je("pow"),100*Math.random()<(null!==(a=e.stealthDropChance)&&void 0!==a?a:10)&&je("stealth")}L.animationId&&(cancelAnimationFrame(L.animationId),L.animationId=null);const o=document.querySelector(".mazemaster-bb-bar-container"),i=document.querySelector(".mazemaster-bb-instructions");o&&(o.style.display="none"),i&&(i.style.display="none");const s=L.profile.images||[],r=s.length>0?s[s.length-1]:null;if(r){const e=document.getElementById("mazemaster_bb_img");e&&(e.src="/"+r.path)}const l=document.getElementById("bb_stage_title");if(l){const e=(null==r?void 0:r.stageMessage)||"Victory!";l.textContent=e}const m=document.getElementById("mazemaster_bb_hit_btn");if(m&&(m.innerHTML='<i class="fa-solid fa-check"></i> Close',m.classList.add("victory")),L.profile.winCommand)try{await c(L.profile.winCommand)}catch(e){console.error("[MazeMaster] Win command error:",e)}}function xe(e){const n=[];for(let t=0;t<e;t++){n[t]=[];for(let a=0;a<e;a++)n[t][a]={walls:{top:!0,right:!0,bottom:!0,left:!0},visited:!1,minion:null,trap:null}}const t=[];let a={x:0,y:0};function o(t,a){const o=[];return a>0&&!n[a-1][t].visited&&o.push({x:t,y:a-1,dir:"top"}),t<e-1&&!n[a][t+1].visited&&o.push({x:t+1,y:a,dir:"right"}),a<e-1&&!n[a+1][t].visited&&o.push({x:t,y:a+1,dir:"bottom"}),t>0&&!n[a][t-1].visited&&o.push({x:t-1,y:a,dir:"left"}),o}for(n[0][0].visited=!0;;){const e=o(a.x,a.y);if(e.length>0){const o=e[Math.floor(Math.random()*e.length)];t.push(a),"top"===o.dir?(n[a.y][a.x].walls.top=!1,n[o.y][o.x].walls.bottom=!1):"right"===o.dir?(n[a.y][a.x].walls.right=!1,n[o.y][o.x].walls.left=!1):"bottom"===o.dir?(n[a.y][a.x].walls.bottom=!1,n[o.y][o.x].walls.top=!1):"left"===o.dir&&(n[a.y][a.x].walls.left=!1,n[o.y][o.x].walls.right=!1),a={x:o.x,y:o.y},n[a.y][a.x].visited=!0}else{if(!(t.length>0))break;a=t.pop()}}!function(e,n){const t=Math.floor(n*n*.08);for(let a=0;a<t;a++){we(e,1+Math.floor(Math.random()*(n-2)),1+Math.floor(Math.random()*(n-2)),["top","right","bottom","left"][Math.floor(4*Math.random())],n)}}(n,e);for(let t=0;t<e;t++)for(let a=0;a<e;a++)n[t][a].visited=!1;return n}function we(e,n,t,a,o){const i=e[t][n];"top"===a&&t>0?(i.walls.top=!1,e[t-1][n].walls.bottom=!1):"right"===a&&n<o-1?(i.walls.right=!1,e[t][n+1].walls.left=!1):"bottom"===a&&t<o-1?(i.walls.bottom=!1,e[t+1][n].walls.top=!1):"left"===a&&n>0&&(i.walls.left=!1,e[t][n-1].walls.right=!1)}function Me(e){const n=100*Math.random();return n<(e.chestMimicPercent||0)?"mimic":n<(e.chestMimicPercent||0)+(e.chestLockedPercent||0)?"locked":"normal"}function Ee(e,n,t){const a=[];for(let e=0;e<t;e++)for(let n=0;n<t;n++)0===n&&0===e||n===t-1&&e===t-1||a.push({x:n,y:e});!function(e){for(let n=e.length-1;n>0;n--){const t=Math.floor(Math.random()*(n+1));[e[n],e[t]]=[e[t],e[n]]}}(a);const o=function(e,n){const t={minionPlacements:[],trapPlacements:[],chestCount:0},a=e.chestTilePercent||0,o=e.minionEncounters||[],i=e.trapEncounters||[],s=a+o.reduce(((e,n)=>e+(n.percent||0)),0)+i.reduce(((e,n)=>e+(n.percent||0)),0);let r=1;s>100&&(r=100/s,console.log("[MazeMaster] Distribution over 100% (".concat(s,"%), scaling down by ").concat(r.toFixed(2)))),t.chestCount=Math.floor(n*(a*r)/100);for(const e of o){const a=(e.percent||0)*r,o=Math.floor(n*a/100);o>0&&t.minionPlacements.push({minionId:e.minionId,count:o})}for(const e of i){const a=(e.percent||0)*r,o=Math.floor(n*a/100);o>0&&t.trapPlacements.push({trapId:e.trapId,count:o})}return t}(n,a.length);let i=0;for(let t=0;t<o.chestCount&&i<a.length;t++){const t=a[i++],o=Me(n);e[t.y][t.x].chest={type:o,opened:!1}}const s=i;for(const n of o.minionPlacements)for(let t=0;t<n.count&&i<a.length;t++){const t=a[i++];e[t.y][t.x].minion={minionId:n.minionId,triggered:!1}}const r=i-s,l=i;for(const n of o.trapPlacements)for(let t=0;t<n.count&&i<a.length;t++){const t=a[i++];e[t.y][t.x].trap={trapId:n.trapId,triggered:!1}}const m=i-l;console.log("[MazeMaster] Placed ".concat(o.chestCount," chests, ").concat(r," minions, ").concat(m," traps"))}function ke(e){return e&&0!==e.length?e[Math.floor(Math.random()*e.length)]:null}function Ie(e){return e<=5?40:e<=7?35:e<=10?30:e<=12?26:e<=15?22:18}function Ce(e){var n;const t=Y(e);if(!t)return console.error('[MazeMaster] Maze profile "'.concat(e,'" not found')),{error:'Profile "'.concat(e,'" not found')};const a=t.gridSize||10,o=xe(a);Ee(o,t,a);const i=t.startingInventory||{key:0,stealth:0,pow:0,grandpow:0};let s={name:"The Maze",imagePath:"",message:"Find your way to the exit..."};const r=t.mainMinion?V(t.mainMinion):null;return null!==(n=t.storyConfig)&&void 0!==n&&n.mainStory?s={name:(null==r?void 0:r.name)||"Story",imagePath:(null==r?void 0:r.imagePath)||"",message:t.storyConfig.mainStory}:r&&(s={name:r.name,imagePath:r.imagePath,message:t.mainMinionIntroMessage||"Welcome to my maze..."}),T={isOpen:!0,profile:t,profileName:e,grid:o,size:a,playerX:0,playerY:0,exitX:a-1,exitY:a-1,visited:new Set(["0,0"]),isVictory:!1,currentMinion:s,isPaused:!1,pendingEncounter:null,exitEncounterDone:!1,pendingConfirmation:null,pendingChest:null,inventory:{key:i.key||0,stealth:i.stealth||0,pow:i.pow||0,grandpow:i.grandpow||0},shownMilestones:new Set},Se(),Be(),Le(),Ae(),document.addEventListener("keydown",Oe,{capture:!0}),console.log('[MazeMaster] Maze "'.concat(e,'" started (').concat(a,"x").concat(a,")")),{success:!0}}function Se(){var e,t;const a=document.getElementById("mazemaster_maze_modal");a&&a.remove();const o=Ie(T.size),s=document.createElement("div");s.id="mazemaster_maze_modal",s.innerHTML='\n        <div class="mazemaster-maze-overlay">\n            <div class="mazemaster-maze-container">\n                \x3c!-- Hero Section (Minion Area) --\x3e\n                <div class="mazemaster-maze-hero">\n                    <div id="maze_minion_name" class="maze-minion-name"></div>\n                    <div class="mazemaster-maze-hero-content">\n                        <div class="mazemaster-maze-hero-avatar">\n                            <img id="maze_minion_img" src="" alt="" style="display: none;">\n                            <div id="maze_generating_indicator" class="maze-generating-indicator">\n                                <i class="fa-solid fa-comment-dots"></i>\n                            </div>\n                        </div>\n                        <div id="maze_minion_message" class="maze-minion-message"></div>\n                    </div>\n                </div>\n\n                \x3c!-- Control Bar: Inventory | Actions | Save/Exit --\x3e\n                <div class="mazemaster-maze-control-bar">\n                    <div class="mazemaster-maze-inventory">\n                        <div class="inventory-item" title="Keys">\n                            <i class="fa-solid fa-key"></i>\n                            <span id="maze_inv_key">'.concat(T.inventory.key,'</span>\n                        </div>\n                        <div class="inventory-item" title="Stealth">\n                            <i class="fa-solid fa-user-ninja"></i>\n                            <span id="maze_inv_stealth">').concat(T.inventory.stealth,'</span>\n                        </div>\n                        <div class="inventory-item" title="POW">\n                            <i class="fa-solid fa-bolt"></i>\n                            <span id="maze_inv_pow">').concat(T.inventory.pow,'</span>\n                        </div>\n                        <div class="inventory-item grandpow" title="GRANDPOW - Instant Win!">\n                            <i class="fa-solid fa-star"></i>\n                            <span id="maze_inv_grandpow">').concat(T.inventory.grandpow,'</span>\n                        </div>\n                    </div>\n                    <div id="maze_encounter_confirm" class="maze-action-buttons">\n                        \x3c!-- Populated dynamically when encounter happens --\x3e\n                    </div>\n                    <div class="mazemaster-maze-save-exit">\n                        <button id="maze_save_exit_btn" class="menu_button maze-action-btn">\n                            <i class="fa-solid fa-floppy-disk"></i> Save\n                        </button>\n                        <button id="maze_exit_btn" class="menu_button maze-action-btn maze-exit-btn">\n                            <i class="fa-solid fa-door-open"></i> Exit\n                        </button>\n                    </div>\n                </div>\n\n                \x3c!-- Maze Area: Full width container with arrows left, grid centered --\x3e\n                <div class="mazemaster-maze-area">\n                    <div class="mazemaster-maze-arrows-left">\n                        <button class="maze-arrow-btn menu_button" data-dir="up">UP</button>\n                        <button class="maze-arrow-btn menu_button" data-dir="down">DOWN</button>\n                        <button class="maze-arrow-btn menu_button" data-dir="left">LEFT</button>\n                        <button class="maze-arrow-btn menu_button" data-dir="right">RIGHT</button>\n                    </div>\n                    <div class="mazemaster-maze-grid-wrapper">\n                        <div id="maze_grid" class="mazemaster-maze-grid" style="grid-template-columns: repeat(').concat(T.size,", ").concat(o,'px);">\n                            \x3c!-- Grid cells rendered dynamically --\x3e\n                        </div>\n                    </div>\n                </div>\n\n                \x3c!-- Close Button (shown on victory) --\x3e\n                <button id="maze_close_btn" class="menu_button menu_button_primary maze-close-btn" style="display: none;">\n                    <i class="fa-solid fa-check"></i> Close\n                </button>\n            </div>\n        </div>\n\n        <style>\n            .mazemaster-maze-overlay {\n                position: fixed;\n                top: 0; left: 0; right: 0; bottom: 0;\n                background: rgba(0, 0, 0, 0.95);\n                display: flex;\n                align-items: flex-start;\n                justify-content: center;\n                z-index: 10002;\n                overflow-y: auto;\n                padding: 10px 0;\n                -webkit-overflow-scrolling: touch;\n            }\n\n            .mazemaster-maze-container {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                gap: 8px;\n                padding: 15px;\n                max-width: 95vw;\n                max-height: none;\n                margin: auto;\n                background: #1a1a2e;\n                border-radius: 15px;\n                border: 2px solid #333;\n                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);\n            }\n\n            /* Hero Section - Minion Area */\n            .mazemaster-maze-hero {\n                display: flex;\n                flex-direction: column;\n                width: 550px;\n                max-width: 95vw;\n                height: 180px;\n                background: rgba(0, 0, 0, 0.3);\n                border-radius: 10px;\n                padding: 10px;\n                border: 1px solid #444;\n            }\n\n            .maze-minion-name {\n                font-weight: bold;\n                font-size: 1.1em;\n                color: #e94560;\n                text-align: center;\n                padding-bottom: 6px;\n                margin-bottom: 8px;\n                border-bottom: 1px solid #333;\n                flex-shrink: 0;\n            }\n\n            .mazemaster-maze-hero-content {\n                display: flex;\n                gap: 12px;\n                flex: 1;\n                min-height: 0;\n            }\n\n            .mazemaster-maze-hero-avatar {\n                width: 60px;\n                height: 60px;\n                min-width: 60px;\n                flex-shrink: 0;\n                border-radius: 6px;\n                overflow: hidden;\n                background: #16213e;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                position: relative;\n            }\n\n            .mazemaster-maze-hero-avatar img {\n                width: 100%;\n                height: 100%;\n                object-fit: cover;\n            }\n\n            /* LLM Generating Indicator - overlays the entire image */\n            .maze-generating-indicator {\n                position: absolute;\n                top: 0;\n                left: 0;\n                right: 0;\n                bottom: 0;\n                background: rgba(52, 152, 219, 0.7);\n                border-radius: 8px;\n                display: none;\n                align-items: center;\n                justify-content: center;\n                z-index: 10;\n            }\n\n            .maze-generating-indicator.active {\n                display: flex;\n            }\n\n            .maze-generating-indicator i {\n                color: #fff;\n                font-size: 32px;\n                animation: maze-pulse 1s ease-in-out infinite;\n                text-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);\n            }\n\n            @keyframes maze-pulse {\n                0%, 100% { transform: scale(1); opacity: 1; }\n                50% { transform: scale(1.2); opacity: 0.7; }\n            }\n\n            .maze-minion-message {\n                flex: 1;\n                color: #eee;\n                font-style: italic;\n                line-height: 1.4;\n                font-size: 0.95em;\n                overflow-y: auto;\n                padding-right: 8px;\n                max-height: 100%;\n            }\n\n            /* Control Bar */\n            .mazemaster-maze-control-bar {\n                display: flex;\n                justify-content: space-between;\n                align-items: center;\n                width: 550px;\n                max-width: 95vw;\n                padding: 6px 10px;\n                background: rgba(0, 0, 0, 0.2);\n                border-radius: 8px;\n                gap: 10px;\n            }\n\n            .maze-action-buttons {\n                display: flex;\n                gap: 6px;\n                min-width: 120px;\n            }\n\n            .mazemaster-maze-inventory {\n                display: flex;\n                gap: 12px;\n                background: rgba(0, 0, 0, 0.3);\n                padding: 6px 12px;\n                border-radius: 6px;\n            }\n\n            .inventory-item {\n                display: flex;\n                align-items: center;\n                gap: 4px;\n                font-size: 0.9em;\n            }\n\n            .inventory-item i { color: #f1c40f; }\n            .inventory-item.grandpow i { color: #e74c3c; }\n\n            .mazemaster-maze-save-exit {\n                display: flex;\n                gap: 6px;\n            }\n\n            /* Maze Area */\n            .mazemaster-maze-area {\n                display: flex;\n                align-items: flex-start;\n                width: 100%;\n            }\n\n            .mazemaster-maze-arrows-left {\n                display: flex;\n                flex-direction: column;\n                gap: 6px;\n                flex-shrink: 0;\n            }\n\n            .mazemaster-maze-arrows-left .maze-arrow-btn {\n                width: 80px;\n                padding: 12px 8px;\n                font-size: 0.85em;\n                font-weight: bold;\n            }\n\n            .mazemaster-maze-grid-wrapper {\n                flex: 1;\n                display: flex;\n                justify-content: center;\n            }\n\n            .mazemaster-maze-grid {\n                display: grid;\n                gap: 0;\n                background: #333;\n                padding: 2px;\n                border-radius: 5px;\n                border: 2px solid #555;\n            }\n\n            .maze-cell {\n                width: ').concat(o,"px;\n                height: ").concat(o,"px;\n                background: #1a1a2e;\n                position: relative;\n                box-sizing: border-box;\n            }\n\n            .maze-cell.hidden {\n                background: #0a0a0a;\n            }\n\n            .maze-cell.wall-top { border-top: 2px solid #fff; }\n            .maze-cell.wall-right { border-right: 2px solid #fff; }\n            .maze-cell.wall-bottom { border-bottom: 2px solid #fff; }\n            .maze-cell.wall-left { border-left: 2px solid #fff; }\n\n            .maze-cell.player::after {\n                content: '';\n                position: absolute;\n                top: 50%; left: 50%;\n                transform: translate(-50%, -50%);\n                width: 60%; height: 60%;\n                background: #3498db;\n                border-radius: 50%;\n                box-shadow: 0 0 10px #3498db;\n            }\n\n            .maze-cell.exit::before {\n                content: '';\n                position: absolute;\n                top: 50%; left: 50%;\n                transform: translate(-50%, -50%);\n                width: 70%; height: 70%;\n                background: #27ae60;\n                border-radius: 3px;\n            }\n\n            .maze-cell.visited:not(.hidden) {\n                background: #1e2a4a;\n            }\n\n            /* Arrow buttons */\n            .maze-arrow-btn {\n                width: 36px;\n                height: 36px;\n                font-size: 0.85em;\n                padding: 0;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n            }\n\n            /* Action buttons */\n            .maze-action-btn {\n                padding: 8px 14px;\n                font-size: 0.85em;\n                border-radius: 5px;\n                display: inline-flex;\n                align-items: center;\n                justify-content: center;\n                gap: 6px;\n            }\n\n            .maze-exit-btn {\n                background: linear-gradient(to bottom, #555, #444) !important;\n            }\n\n            .maze-close-btn {\n                padding: 10px 28px;\n                font-size: 1em;\n            }\n\n            .maze-cell.victory-glow {\n                animation: victoryPulse 1s infinite;\n            }\n\n            @keyframes victoryPulse {\n                0%, 100% { background: #27ae60; }\n                50% { background: #2ecc71; }\n            }\n        </style>\n    "),document.body.appendChild(s),s.querySelectorAll(".maze-arrow-btn").forEach((e=>{e.addEventListener("click",(()=>{const n=e.dataset.dir;"up"===n?De(0,-1):"down"===n?De(0,1):"left"===n?De(-1,0):"right"===n&&De(1,0)}))}));const r=document.getElementById("maze_close_btn");r&&r.addEventListener("click",Pe);null===(e=document.getElementById("maze_save_exit_btn"))||void 0===e||e.addEventListener("click",(async()=>{!function(){if(!T.isOpen||!T.profileName)return console.warn("[MazeMaster] No active maze to save"),!1;const e={profileName:T.profileName,size:T.size,playerX:T.playerX,playerY:T.playerY,exitX:T.exitX,exitY:T.exitY,visited:Array.from(T.visited),inventory:n({},T.inventory),exitEncounterDone:T.exitEncounterDone,shownMilestones:Array.from(T.shownMilestones||[]),grid:T.grid.map((e=>e.map((e=>({walls:e.walls,visited:e.visited,minion:e.minion,trap:e.trap,chest:e.chest}))))),timestamp:Date.now()};P.savedMazes[T.profileName]=e,i(),console.log('[MazeMaster] Maze progress saved for "'.concat(T.profileName,'"'))}(),Pe(),hn()}));null===(t=document.getElementById("maze_exit_btn"))||void 0===t||t.addEventListener("click",(async()=>{await p("Exit without saving? Progress will be lost.",u.CONFIRM)&&Pe()}))}function Pe(){T.isOpen=!1,document.removeEventListener("keydown",Oe,{capture:!0});const e=document.getElementById("mazemaster_maze_modal");e&&e.remove()}function Be(){const{grid:e,size:n,playerX:t,playerY:a,visited:o,exitX:i,exitY:s,isVictory:r}=T,l=document.getElementById("maze_grid");if(!l)return;const m=Ie(n);l.style.gridTemplateColumns="repeat(".concat(n,", ").concat(m,"px)"),l.innerHTML="";for(let c=0;c<n;c++)for(let d=0;d<n;d++){const n=e[c][d],p=document.createElement("div");p.className="maze-cell",p.style.width="".concat(m,"px"),p.style.height="".concat(m,"px");const u="".concat(d,",").concat(c),g=o.has(u),b=d===t&&c===a,f=d===i&&c===s;g?(p.classList.add("visited"),n.walls.top&&p.classList.add("wall-top"),n.walls.right&&p.classList.add("wall-right"),n.walls.bottom&&p.classList.add("wall-bottom"),n.walls.left&&p.classList.add("wall-left")):p.classList.add("hidden"),b&&p.classList.add("player"),f&&g&&(p.classList.add("exit"),r&&p.classList.add("victory-glow")),n.minion&&g&&(p.classList.add("has-minion"),n.minion.triggered&&p.classList.add("minion-triggered")),n.chest&&g&&(p.classList.add("has-chest"),"locked"===n.chest.type&&p.classList.add("chest-locked"),n.chest.opened&&p.classList.add("chest-opened")),n.trap&&g&&(p.classList.add("has-trap"),n.trap.triggered&&p.classList.add("trap-triggered")),l.appendChild(p)}}function Le(){const{currentMinion:e,isVictory:n,profile:t}=T,a=document.getElementById("maze_minion_img"),o=document.getElementById("maze_minion_name"),i=document.getElementById("maze_minion_message");n?(t.winImage&&a&&(a.src=M(t.winImage),a.style.display=""),o&&(o.textContent="Victory!"),i&&(i.textContent=t.winMessage||"You escaped the maze!")):e&&(e.imagePath&&a?(a.src=M(e.imagePath),a.style.display=""):a&&(a.style.display="none"),o&&(o.textContent=e.name||""),i&&(i.textContent=e.message||""))}function Te(e){const n=document.getElementById("maze_generating_indicator");n&&n.classList.toggle("active",e)}function Oe(e){if(!T.isOpen||T.isVictory)return;let n=0,t=0;if("ArrowUp"===e.key)t=-1;else if("ArrowDown"===e.key)t=1;else if("ArrowLeft"===e.key)n=-1;else{if("ArrowRight"!==e.key)return;n=1}e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),De(n,t)}function De(e,n){if(!T.isOpen||T.isVictory)return;if(T.isPaused)return;const{playerX:t,playerY:a,grid:o,size:i}=T,s=t+e,r=a+n;if(s<0||s>=i||r<0||r>=i)return;const l=o[a][t];if(1===e&&l.walls.right)return;if(-1===e&&l.walls.left)return;if(1===n&&l.walls.bottom)return;if(-1===n&&l.walls.top)return;if(T.playerX=s,T.playerY=r,T.visited.add("".concat(s,",").concat(r)),Be(),s===T.exitX&&r===T.exitY)return void async function(){const e=T.profile;if(!e.mainMinion||T.exitEncounterDone)return void nn();const n=V(e.mainMinion);if(!n)return void nn();T.isPaused=!0,T.currentMinion={name:n.name,imagePath:n.imagePath,message:"You've reached the exit... but first, face me!"},Le();const t=e.mainMinionExitType||"messenger",a=e.mainMinionExitProfile;switch(t){case"messenger":await(o=2e3,new Promise((e=>setTimeout(e,o)))),T.exitEncounterDone=!0,T.isPaused=!1,nn();break;case"battlebar":a?(T.pendingEncounter={type:"exit_battlebar",profile:a},ie(a)):(T.exitEncounterDone=!0,T.isPaused=!1,nn());break;case"prizewheel":a?(T.pendingEncounter={type:"exit_wheel",profile:a},Z(a),te()):(T.exitEncounterDone=!0,T.isPaused=!1,nn());break;default:nn()}var o}();const m=o[r][s];!m.chest||m.chest.opened?!m.minion||m.minion.triggered?!m.trap||m.trap.triggered?(async function(){const e=T.profile;if(!e.mainMinion)return;if(!e.mainMinionRandomChance)return;if(!e.mainMinionRandomMessages||0===e.mainMinionRandomMessages.length)return;if(100*Math.random()>e.mainMinionRandomChance)return;const n=V(e.mainMinion);if(!n)return;const t=ke(e.mainMinionRandomMessages);if(!t)return;T.currentMinion={name:n.name,imagePath:n.imagePath,message:"..."},Le(),Te(!0);let a=t;try{a=await N({minionName:n.name,minionDescription:n.description,baseMessage:t,mainStory:j(),currentMilestone:A(),minionType:n.type||"messenger"})}catch(e){console.error("[MazeMaster] Random message LLM generation error:",e)}Te(!1),T.currentMinion.message=a,Le()}(),function(){const e=T.profile;if(!e.storyConfig||!e.storyConfig.milestones||0===e.storyConfig.milestones.length)return;const n=T.size*T.size,t=T.visited.size,a=Math.floor(t/n*100);for(const n of e.storyConfig.milestones)if(a>=n.percent&&!T.shownMilestones.has(n.percent)){T.shownMilestones.add(n.percent);const t=e.mainMinion?V(e.mainMinion):null;return T.currentMinion={name:(null==t?void 0:t.name)||"Story",imagePath:(null==t?void 0:t.imagePath)||"",message:n.storyUpdate},void Le()}}()):async function(e,n,t){const a=Q(e);if(!a)return void console.warn('[MazeMaster] Trap "'.concat(e,'" not found'));T.grid[t][n].trap.triggered=!0,Be(),T.isPaused=!0,T.currentMinion={name:a.name,imagePath:a.imagePath,message:"..."},Le(),Te(!0);const o=a.message||"You triggered a trap!";let i=o;try{i=await async function(e){const{trapName:n,baseMessage:t,mainStory:a}=e;if(!t)return"";if(!1===P.llmEnabled)return t;if("function"!=typeof g)return t;const o='The player has triggered a trap called "'.concat(n,'" in a maze.\n\n').concat(a?"Story Setting: ".concat(a,"\n\n"):"",'Based on this trap description: "').concat(t,'"\n\nWrite a short, dramatic narration of the trap being triggered (1-2 sentences, under 100 characters). Make it visceral and immediate. Do not use quotation marks.');try{console.log("[MazeMaster] Generating LLM message for trap:",n);const e=await g(o,{quietToLoud:!1,skipWIAN:!0,max_length:80});if(e&&e.trim()){let n=e.trim();return n=n.replace(/^["']|["']$/g,""),n=n.replace(/^["""''']|["""''']$/g,""),console.log("[MazeMaster] Generated trap message:",n),n}}catch(e){console.error("[MazeMaster] Trap LLM generation failed:",e)}return t}({trapName:a.name,baseMessage:o,mainStory:j()})}catch(e){console.error("[MazeMaster] Trap LLM generation error:",e)}if(Te(!1),T.currentMinion.message=i,Le(),a.script&&a.script.trim())try{const{executeSlashCommandsWithOptions:e}=SillyTavern.getContext();e&&(console.log("[MazeMaster] Executing trap script for ".concat(a.name)),await e(a.script))}catch(e){console.error("[MazeMaster] Error executing trap script:",e)}!function(){var e;const n=document.getElementById("maze_encounter_confirm");if(!n)return;n.innerHTML='\n        <button id="maze_trap_continue" class="menu_button maze-confirm-btn">Continue</button>\n    ',n.style.display="flex",null===(e=document.getElementById("maze_trap_continue"))||void 0===e||e.addEventListener("click",(()=>{n.style.display="none",n.innerHTML="",Ne()}))}()}(m.trap.trapId,s,r):async function(e,n,t){var a;const o=V(e);if(!o)return void console.warn('[MazeMaster] Minion "'.concat(e,'" not found'));const i=T.grid[t][n];if(null!==(a=i.minion)&&void 0!==a&&a.triggered)return void console.log("[MazeMaster] Minion at ".concat(n,",").concat(t," already triggered, skipping"));i.minion.triggered=!0,console.log("[MazeMaster] Marked minion at ".concat(n,",").concat(t," as triggered")),T.isPaused=!0,T.currentMinion={name:o.name,imagePath:o.imagePath,message:"..."},Le(),Be();const s=ke(o.messages)||"You encountered ".concat(o.name,"!");Te(!0);let r=s;try{r=await N({minionName:o.name,minionDescription:o.description,baseMessage:s,mainStory:j(),currentMilestone:A(),minionType:o.type||"messenger"})}catch(e){console.error("[MazeMaster] LLM generation error:",e)}if(Te(!1),T.currentMinion.message=r,Le(),o.encounterScript&&o.encounterScript.trim())try{const{executeSlashCommandsWithOptions:e}=SillyTavern.getContext();e&&(console.log("[MazeMaster] Executing encounter script for ".concat(o.name)),await e(o.encounterScript))}catch(e){console.error("[MazeMaster] Error executing encounter script:",e)}const l=o.type||"messenger";!function(e,n,t,a){var o,i,s,r,l;const m=V(e),c="messenger"!==a&&"merchant"!==a&&T.inventory.stealth>0;T.pendingConfirmation={type:a,minionId:e,x:n,y:t,canSlipAway:c};const d=document.getElementById("maze_encounter_confirm");if(!d)return;let p="";if("messenger"===a)p='<button id="maze_confirm_ok" class="menu_button maze-confirm-btn">OK</button>';else if("merchant"===a){const e=m.merchantItemCount||{min:1,max:3},n=e.min+Math.floor(Math.random()*(e.max-e.min+1));T.pendingConfirmation.merchantItemCount=n;const t="I'll give you a GRANDPOW for ".concat(n," of your items...");T.currentMinion.message=t,Le(),p='\n            <button id="maze_confirm_accept" class="menu_button maze-confirm-btn maze-accept-btn">Accept</button>\n            <button id="maze_confirm_decline" class="menu_button maze-confirm-btn">Decline</button>\n        '}else{p='<button id="maze_confirm_action" class="menu_button maze-confirm-btn">'.concat("battlebar"===a?"Fight!":"Spin!","</button>"),c&&(p+='<button id="maze_confirm_slip" class="menu_button maze-confirm-btn maze-slip-btn">Slip Away</button>')}d.innerHTML=p,d.style.display="flex",null===(o=document.getElementById("maze_confirm_ok"))||void 0===o||o.addEventListener("click",Ve),null===(i=document.getElementById("maze_confirm_action"))||void 0===i||i.addEventListener("click",Ke),null===(s=document.getElementById("maze_confirm_slip"))||void 0===s||s.addEventListener("click",Xe),null===(r=document.getElementById("maze_confirm_accept"))||void 0===r||r.addEventListener("click",Qe),null===(l=document.getElementById("maze_confirm_decline"))||void 0===l||l.addEventListener("click",$e)}(e,n,t,l)}(m.minion.minionId,s,r):async function(e,n,t){var a;T.isPaused=!0,T.pendingChest={chestData:e,x:n,y:t};const o="locked"===e.type,i=T.inventory.key>0,s=o?i?"A locked chest! Use a key to open it?":"A locked chest! You need a Key to open it.":"You found a chest!";T.currentMinion={name:o?"Locked Chest":"Chest",imagePath:"",message:s},Le();const r=(null===(a=T.profile)||void 0===a||null===(a=a.storyConfig)||void 0===a?void 0:a.mainStory)||"";Te(!0);try{const e=await async function(e){const{chestType:n,baseMessage:t,mainStory:a,hasKey:o}=e;if(!t)return"";if(!1===P.llmEnabled)return t;if("function"!=typeof g)return t;const i="The player has discovered ".concat("locked"===n?o?"a locked treasure chest - the player has a key to open it":"a locked treasure chest - the player lacks the key":"a treasure chest waiting to be opened"," in a maze.\n\n").concat(a?"Story Setting: ".concat(a,"\n\n"):"",'Based on this chest discovery message: "').concat(t,'"\n\nWrite a short, atmospheric description of finding the chest (1-2 sentences, under 100 characters). Make it feel rewarding and mysterious. Do not use quotation marks.');try{console.log("[MazeMaster] Generating LLM message for chest");const e=await g(i,{quietToLoud:!1,skipWIAN:!0,max_length:80});if(e&&e.trim()){let n=e.trim();return n=n.replace(/^["']|["']$/g,""),n=n.replace(/^["""''']|["""''']$/g,""),console.log("[MazeMaster] Generated chest message:",n),n}}catch(e){console.error("[MazeMaster] Chest LLM generation failed:",e)}return t}({chestType:o?"locked":"normal",baseMessage:s,mainStory:r,hasKey:i});T.currentMinion.message=e,Le()}catch(e){console.error("[MazeMaster] Chest message generation failed:",e)}finally{Te(!1)}!function(e,n){var t,a,o;const i=document.getElementById("maze_encounter_confirm");if(!i)return;let s="";s=e?n?'\n                <button id="maze_chest_unlock" class="menu_button maze-confirm-btn">Unlock</button>\n                <button id="maze_chest_ignore" class="menu_button maze-confirm-btn">Ignore</button>\n            ':'\n                <button id="maze_chest_ignore" class="menu_button maze-confirm-btn">Continue</button>\n            ':'\n            <button id="maze_chest_open" class="menu_button maze-confirm-btn">Open</button>\n            <button id="maze_chest_ignore" class="menu_button maze-confirm-btn">Ignore</button>\n        ';i.innerHTML=s,i.style.display="flex",null===(t=document.getElementById("maze_chest_open"))||void 0===t||t.addEventListener("click",qe),null===(a=document.getElementById("maze_chest_unlock"))||void 0===a||a.addEventListener("click",We),null===(o=document.getElementById("maze_chest_ignore"))||void 0===o||o.addEventListener("click",He)}(o,i)}(m.chest,s,r)}function Ne(){T.isPaused=!1,T.pendingEncounter=null;const e=document.getElementById("maze_encounter_confirm");e&&(e.innerHTML="",e.style.display="none");const n=T.profile;if(n.mainMinion){const e=V(n.mainMinion);if(e)return T.currentMinion={name:e.name,imagePath:e.imagePath,message:"Continue onward..."},void Le()}T.currentMinion={name:"The Maze",imagePath:"",message:"Find your way to the exit..."},Le()}function Ae(){const e=document.getElementById("maze_inv_key"),n=document.getElementById("maze_inv_stealth"),t=document.getElementById("maze_inv_pow"),a=document.getElementById("maze_inv_grandpow");e&&(e.textContent=T.inventory.key),n&&(n.textContent=T.inventory.stealth),t&&(t.textContent=T.inventory.pow),a&&(a.textContent=T.inventory.grandpow||0)}function je(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;void 0!==T.inventory[e]&&(T.inventory[e]+=n,Ae())}function Re(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;void 0!==T.inventory[e]&&(T.inventory[e]=Math.max(0,T.inventory[e]-n),Ae())}function qe(){const e=document.getElementById("maze_encounter_confirm");e&&(e.style.display="none",e.innerHTML="");const{chestData:n,x:t,y:a}=T.pendingChest||{};n&&(T.grid[a][t].chest.opened=!0,Be(),"mimic"!==n.type?function(){T.pendingChest=null;const e=Ge(T.profile,!1);Fe(e),Ue(e,"Chest")}():Je(t,a))}function We(){const e=document.getElementById("maze_encounter_confirm");e&&(e.style.display="none",e.innerHTML="");const{chestData:n,x:t,y:a}=T.pendingChest||{};n&&(Re("key"),T.grid[a][t].chest.opened=!0,Be(),"mimic"!==n.type?function(){T.pendingChest=null;const e=Ge(T.profile,!0);Fe(e),Ue(e,"Locked Chest")}():Je(t,a))}function He(){const e=document.getElementById("maze_encounter_confirm");e&&(e.style.display="none",e.innerHTML=""),T.pendingChest=null,Ne()}function Ge(e,n){const t={key:0,pow:0,stealth:0,grandpow:0},a=e.chestLootMin||1,o=e.chestLootMax||2,i=a+Math.floor(Math.random()*(o-a+1)),s=n?{key:e.lockedChestKeyChance||40,pow:e.lockedChestPowChance||60,stealth:e.lockedChestStealthChance||30,grandpow:e.lockedChestGrandpowChance||5}:{key:e.chestKeyChance||30,pow:e.chestPowChance||50,stealth:e.chestStealthChance||0,grandpow:e.chestGrandpowChance||0};if(n){const n=1+(e.chestLockedBonusPercent||50)/100;s.key=Math.min(100,s.key*n),s.pow=Math.min(100,s.pow*n),s.stealth=Math.min(100,s.stealth*n),s.grandpow=Math.min(100,s.grandpow*n)}for(let e=0;e<i;e++)100*Math.random()<s.key&&t.key++,100*Math.random()<s.pow&&t.pow++,100*Math.random()<s.stealth&&t.stealth++,100*Math.random()<s.grandpow&&t.grandpow++;return t}function Fe(e){e.key>0&&je("key",e.key),e.pow>0&&je("pow",e.pow),e.stealth>0&&je("stealth",e.stealth),e.grandpow>0&&je("grandpow",e.grandpow)}function Ye(e,n){T.currentMinion={name:n,imagePath:"",message:e},Le()}function Ue(e,n){const t=[];e.key>0&&t.push("".concat(e.key," Key").concat(e.key>1?"s":"")),e.pow>0&&t.push("".concat(e.pow," POW").concat(e.pow>1?"s":"")),e.stealth>0&&t.push("".concat(e.stealth," Stealth").concat(e.stealth>1?"s":""));Ye(t.length>0?"You found: ".concat(t.join(", "),"!"):"The chest was empty!",n),setTimeout((()=>Ne()),2e3)}function Je(e,n){T.pendingChest=null;const t=W();if(t.length>0){const e=t[Math.floor(Math.random()*t.length)];T.pendingEncounter={type:"mimic_battlebar",profile:e},T.currentMinion={name:"Mimic!",imagePath:"",message:"The chest was a mimic! Prepare to fight!"},Le(),setTimeout((()=>{ie(e)}),1e3)}else Ye("The chest was empty... and creepy.","Mimic"),setTimeout((()=>Ne()),1500)}function Ve(){T.pendingConfirmation=null,Ne()}function Ke(){const e=T.pendingConfirmation;if(!e)return;const n=V(e.minionId);if(T.pendingConfirmation=null,"battlebar"===e.type){const e=ke(n.battlebarProfiles);e?(T.pendingEncounter={type:"battlebar",profile:e},ie(e)):Ne()}else if("prizewheel"===e.type){const e=ke(n.wheelProfiles);e?(T.pendingEncounter={type:"wheel",profile:e},Z(e),te()):Ne()}}function Xe(){T.inventory.stealth>0&&(Re("stealth"),T.pendingConfirmation=null,Ne())}function Qe(){const e=T.pendingConfirmation;if(!e||"merchant"!==e.type)return;const n=e.merchantItemCount||1,t=(T.inventory.key||0)+(T.inventory.stealth||0)+(T.inventory.pow||0);if(t<n){T.currentMinion.message="You don't have enough items! You need ".concat(n," but only have ").concat(t,"."),Le();const e=document.getElementById("maze_encounter_confirm");var a;if(e)e.innerHTML='<button id="maze_confirm_decline" class="menu_button maze-confirm-btn">OK</button>',e.style.display="flex",null===(a=document.getElementById("maze_confirm_decline"))||void 0===a||a.addEventListener("click",$e);return}let o=n;const i=["key","stealth","pow"];for(;o>0;){const e=i.filter((e=>T.inventory[e]>0));if(0===e.length)break;Re(e[Math.floor(Math.random()*e.length)]),o--}je("grandpow"),T.currentMinion.message="Pleasure doing business with you! Here's your GRANDPOW!",Le();const s=document.getElementById("maze_minion_message");if(s){var r;const e=s.innerHTML.split('<div class="maze-confirm-buttons">')[0];s.innerHTML=e+'<div class="maze-confirm-buttons">\n            <button id="maze_confirm_ok" class="menu_button maze-confirm-btn">OK</button>\n        </div>',null===(r=document.getElementById("maze_confirm_ok"))||void 0===r||r.addEventListener("click",Ve)}}function $e(){T.pendingConfirmation=null,Ne()}function Ze(){T.isVictory=!1,T.isPaused=!0,O.maze[T.profileName]={result:"lose",timestamp:Date.now()},document.getElementById("maze_minion_name").textContent="Defeat!",document.getElementById("maze_minion_message").textContent="You have been defeated...";const e=document.getElementById("maze_minion_img");e&&(e.style.display="none");const n=document.getElementById("maze_close_btn");n&&(n.style.display=""),T.profile.loseCommand&&c(T.profile.loseCommand),document.removeEventListener("keydown",Oe,{capture:!0})}function en(){T.playerX=0,T.playerY=0,T.isPaused=!1,T.pendingEncounter=null,Be();const e=T.profile;if(e.mainMinion){const n=V(e.mainMinion);if(n)return T.currentMinion={name:n.name,imagePath:n.imagePath,message:"Back to the beginning with you!"},void Le()}T.currentMinion={name:"The Maze",imagePath:"",message:"Find your way to the exit..."},Le()}async function nn(){T.isVictory=!0,O.maze[T.profileName]={result:"win",timestamp:Date.now()},Le(),Be();const e=document.getElementById("maze_close_btn");e&&(e.style.display="");const n=document.querySelector(".mazemaster-maze-controls");if(n&&(n.style.display="none"),document.removeEventListener("keydown",Oe,{capture:!0}),T.profile.winCommand)try{await c(T.profile.winCommand)}catch(e){console.error("[MazeMaster] Win command error:",e)}console.log('[MazeMaster] Maze "'.concat(T.profileName,'" completed!'))}function tn(){var e,n,t,a,o,i,s,r;const l=R(),m=P.currentProfile||"default",c=W(),d=P.currentBattlebarProfile||"default",p=H(d)||{},u=F(),g=P.currentMazeProfile||"default",b=Y(g)||{},f=J(),h=P.activeGameConfig||"wheel";return'\n        <div class="mazemaster-panel">\n            <div class="mazemaster-panel-header">\n                <h2><i class="fa-solid fa-gamepad"></i> MazeMaster</h2>\n            </div>\n            <div class="mazemaster-tabs">\n                <button class="mazemaster-tab" data-tab="game">Game</button>\n                <button class="mazemaster-tab active" data-tab="config">Config</button>\n            </div>\n            <div class="mazemaster-panel-content">\n                \x3c!-- GAME TAB --\x3e\n                <div class="mazemaster-tab-content" id="mazemaster-tab-game">\n                    <div class="mazemaster-game-launch">\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Maze Profile</label>\n                            <select id="mazemaster_play_profile" class="mazemaster-select">\n                                '.concat(0===u.length?'<option value="">No profiles</option>':"","\n                                ").concat(u.map((e=>'<option value="'.concat(on(e),'" ').concat(e===g?"selected":"",">").concat(on(e),"</option>"))).join(""),'\n                            </select>\n                        </div>\n                        <button id="mazemaster_play_maze" class="menu_button menu_button_primary mazemaster-play-btn">\n                            <i class="fa-solid fa-play"></i> Play Maze\n                        </button>\n                    </div>\n\n                    \x3c!-- LLM Generation Settings --\x3e\n                    <div class="mazemaster-section">\n                        <label class="mazemaster-label"><i class="fa-solid fa-brain"></i> LLM Message Generation</label>\n                        <div class="mazemaster-form-group">\n                            <label>Generation Preset</label>\n                            <select id="mazemaster_llm_preset" class="mazemaster-select">\n                                <option value="">(Use Current)</option>\n                                \x3c!-- Presets populated dynamically --\x3e\n                            </select>\n                        </div>\n                        <label class="mazemaster-checkbox-label">\n                            <input type="checkbox" id="mazemaster_llm_enabled" ').concat(!1!==P.llmEnabled?"checked":"",'>\n                            Enable LLM message generation\n                        </label>\n                    </div>\n\n                    \x3c!-- Saved Games in Game Tab --\x3e\n                    <div class="mazemaster-section">\n                        <label class="mazemaster-label"><i class="fa-solid fa-floppy-disk"></i> Saved Games</label>\n                        <div id="mazemaster_game_tab_saves" class="mazemaster-saved-games-list">\n                            \x3c!-- Saved games rendered here --\x3e\n                        </div>\n                    </div>\n                </div>\n\n                \x3c!-- CONFIG TAB --\x3e\n                <div class="mazemaster-tab-content active" id="mazemaster-tab-config">\n                    \x3c!-- Game Selector --\x3e\n                    <div class="mazemaster-game-selector">\n                        <button id="mazemaster_show_wheel" class="menu_button mazemaster-game-btn ').concat("wheel"===h?"active":"",'">\n                            <i class="fa-solid fa-dharmachakra"></i> Wheel\n                        </button>\n                        <button id="mazemaster_show_battlebar" class="menu_button mazemaster-game-btn ').concat("battlebar"===h?"active":"",'">\n                            <i class="fa-solid fa-bars-progress"></i> Battlebar\n                        </button>\n                        <button id="mazemaster_show_maze" class="menu_button mazemaster-game-btn ').concat("maze"===h?"active":"",'">\n                            <i class="fa-solid fa-border-all"></i> Maze\n                        </button>\n                        <button id="mazemaster_show_minions" class="menu_button mazemaster-game-btn ').concat("minions"===h?"active":"",'">\n                            <i class="fa-solid fa-ghost"></i> Minions\n                        </button>\n                        <button id="mazemaster_show_traps" class="menu_button mazemaster-game-btn ').concat("traps"===h?"active":"",'">\n                            <i class="fa-solid fa-dungeon"></i> Traps\n                        </button>\n                    </div>\n\n                    \x3c!-- WHEEL CONFIG --\x3e\n                    <div id="mazemaster_wheel_config" class="mazemaster-game-config" style="').concat("wheel"===h?"":"display: none;",'">\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Wheel Profile</label>\n                            <div class="mazemaster-profile-row">\n                                <select id="mazemaster_profile_select" class="mazemaster-select">\n                                    ').concat(0===l.length?'<option value="">No profiles</option>':"","\n                                    ").concat(l.map((e=>'<option value="'.concat(on(e),'" ').concat(e===m?"selected":"",">").concat(on(e),"</option>"))).join(""),'\n                                </select>\n                                <button id="mazemaster_new_profile_btn" class="menu_button menu_button_icon" title="New Profile">\n                                    <i class="fa-solid fa-plus"></i>\n                                </button>\n                                <button id="mazemaster_delete_profile_btn" class="menu_button menu_button_icon" title="Delete Profile">\n                                    <i class="fa-solid fa-trash"></i>\n                                </button>\n                                <button id="mazemaster_export_btn" class="menu_button menu_button_icon" title="Export Profile">\n                                    <i class="fa-solid fa-download"></i>\n                                </button>\n                                <button id="mazemaster_import_btn" class="menu_button menu_button_icon" title="Import Profile">\n                                    <i class="fa-solid fa-upload"></i>\n                                </button>\n                                <input type="file" id="mazemaster_import_file" accept=".json" style="display: none;">\n                                <button id="mazemaster_preview_wheel_btn" class="menu_button menu_button_icon" title="Preview Wheel">\n                                    <i class="fa-solid fa-eye"></i>\n                                </button>\n                            </div>\n                        </div>\n\n                        <div class="mazemaster-section mazemaster-profile-settings">\n                            <div class="mazemaster-profile-options">\n                                <label class="mazemaster-checkbox-label">\n                                    <input type="checkbox" id="mazemaster_randomize" ').concat(null!==(e=q(m))&&void 0!==e&&e.randomize?"checked":"",'>\n                                    Randomize segment positions\n                                </label>\n                                <div class="mazemaster-difficulty-row">\n                                    <label>Difficulty:</label>\n                                    <select id="mazemaster_difficulty" class="mazemaster-select-small">\n                                        ').concat([1,2,3,4,5].map((e=>{var n;return'<option value="'.concat(e,'" ').concat(((null===(n=q(m))||void 0===n?void 0:n.difficulty)||1)===e?"selected":"",">").concat(e,"</option>")})).join(""),'\n                                    </select>\n                                </div>\n                            </div>\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Segments</label>\n                            <div id="mazemaster_segments_list" class="mazemaster-segments-list">\n                                \x3c!-- Segments rendered here --\x3e\n                            </div>\n                            <button id="mazemaster_add_segment_btn" class="menu_button mazemaster-add-btn">\n                                <i class="fa-solid fa-plus"></i> Add Segment\n                            </button>\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <button id="mazemaster_save_btn" class="menu_button menu_button_primary mazemaster-save-btn">\n                                <i class="fa-solid fa-save"></i> Save Profile\n                            </button>\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <div class="mazemaster-help">\n                                <div class="mazemaster-help-title">Usage:</div>\n                                <code>/wheel profile="profileName"</code>\n                                <div class="mazemaster-help-title">Sizes:</div>\n                                <ul>\n                                    <li><code>fraction</code> - Normal (1x)</li>\n                                    <li><code>halfseg</code> - Half (0.5x)</li>\n                                    <li><code>doubleseg</code> - Double (2x)</li>\n                                </ul>\n                                <small>halfseg count must equal doubleseg count</small>\n                            </div>\n                        </div>\n                    </div>\n\n                    \x3c!-- BATTLEBAR CONFIG --\x3e\n                    <div id="mazemaster_battlebar_config" class="mazemaster-game-config" style="').concat("battlebar"===h?"":"display: none;",'">\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Battlebar Profile</label>\n                            <div class="mazemaster-profile-row">\n                                <select id="mazemaster_bb_profile_select" class="mazemaster-select">\n                                    ').concat(0===c.length?'<option value="">No profiles</option>':"","\n                                    ").concat(c.map((e=>'<option value="'.concat(on(e),'" ').concat(e===d?"selected":"",">").concat(on(e),"</option>"))).join(""),'\n                                </select>\n                                <button id="mazemaster_bb_new_profile_btn" class="menu_button menu_button_icon" title="New Profile">\n                                    <i class="fa-solid fa-plus"></i>\n                                </button>\n                                <button id="mazemaster_bb_delete_profile_btn" class="menu_button menu_button_icon" title="Delete Profile">\n                                    <i class="fa-solid fa-trash"></i>\n                                </button>\n                                <button id="mazemaster_bb_export_btn" class="menu_button menu_button_icon" title="Export Profile">\n                                    <i class="fa-solid fa-download"></i>\n                                </button>\n                                <button id="mazemaster_bb_import_btn" class="menu_button menu_button_icon" title="Import Profile">\n                                    <i class="fa-solid fa-upload"></i>\n                                </button>\n                                <input type="file" id="mazemaster_bb_import_file" accept=".json" style="display: none;">\n                                <button id="mazemaster_preview_battlebar_btn" class="menu_button menu_button_icon" title="Preview Battlebar">\n                                    <i class="fa-solid fa-eye"></i>\n                                </button>\n                            </div>\n                        </div>\n\n                        <div class="mazemaster-section mazemaster-profile-settings">\n                            <div class="mazemaster-bb-settings">\n                                <div class="mazemaster-bb-row">\n                                    <div class="mazemaster-bb-field">\n                                        <label>Difficulty</label>\n                                        <select id="mazemaster_bb_difficulty" class="mazemaster-select">\n                                            ').concat([1,2,3,4,5].map((e=>'<option value="'.concat(e,'" ').concat((p.difficulty||3)===e?"selected":"",">").concat(e,"</option>"))).join(""),'\n                                        </select>\n                                    </div>\n                                    <div class="mazemaster-bb-field">\n                                        <label>Hits to Win</label>\n                                        <input type="number" id="mazemaster_bb_hits" min="1" max="20" value="').concat(p.hitsToWin||5,'">\n                                    </div>\n                                    <div class="mazemaster-bb-field">\n                                        <label>Misses to Lose</label>\n                                        <input type="number" id="mazemaster_bb_misses" min="1" max="20" value="').concat(p.missesToLose||3,'">\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Main Title</label>\n                            <input type="text" id="mazemaster_bb_main_title" class="mazemaster-input" placeholder="e.g. Boss Battle!" value="').concat(on(p.mainTitle||""),'">\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Commands</label>\n                            <div class="mazemaster-bb-commands">\n                                <div class="mazemaster-bb-command">\n                                    <label>On Hit:</label>\n                                    <textarea id="mazemaster_bb_hit_cmd" placeholder="/echo Hit!">').concat(on(p.hitCommand||""),'</textarea>\n                                </div>\n                                <div class="mazemaster-bb-command">\n                                    <label>On Miss:</label>\n                                    <textarea id="mazemaster_bb_miss_cmd" placeholder="/echo Miss!">').concat(on(p.missCommand||""),'</textarea>\n                                </div>\n                                <div class="mazemaster-bb-command">\n                                    <label>On Win:</label>\n                                    <textarea id="mazemaster_bb_win_cmd" placeholder="/echo Victory!">').concat(on(p.winCommand||""),'</textarea>\n                                </div>\n                                <div class="mazemaster-bb-command">\n                                    <label>On Lose:</label>\n                                    <textarea id="mazemaster_bb_lose_cmd" placeholder="/echo Defeat!">').concat(on(p.loseCommand||""),'</textarea>\n                                </div>\n                            </div>\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Stages (click image to edit message)</label>\n                            <div id="mazemaster_bb_images_list" class="mazemaster-bb-images-list">\n                                \x3c!-- Images rendered here --\x3e\n                            </div>\n                            <button id="mazemaster_bb_add_image_btn" class="menu_button mazemaster-add-btn">\n                                <i class="fa-solid fa-plus"></i> Add Image\n                            </button>\n                            <input type="file" id="mazemaster_bb_image_file" accept="image/*" style="display: none;">\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Item Drops on Win (Maze Only)</label>\n                            <div class="mazemaster-row">\n                                <label>Key %</label>\n                                <input type="number" id="mazemaster_bb_key_drop" class="mazemaster-input-small" min="0" max="100" value="').concat(null!==(n=p.keyDropChance)&&void 0!==n?n:40,'">\n                            </div>\n                            <div class="mazemaster-row">\n                                <label>POW %</label>\n                                <input type="number" id="mazemaster_bb_pow_drop" class="mazemaster-input-small" min="0" max="100" value="').concat(null!==(t=p.powDropChance)&&void 0!==t?t:20,'">\n                            </div>\n                            <div class="mazemaster-row">\n                                <label>Stealth %</label>\n                                <input type="number" id="mazemaster_bb_stealth_drop" class="mazemaster-input-small" min="0" max="100" value="').concat(null!==(a=p.stealthDropChance)&&void 0!==a?a:10,'">\n                            </div>\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <button id="mazemaster_bb_save_btn" class="menu_button menu_button_primary mazemaster-save-btn">\n                                <i class="fa-solid fa-save"></i> Save Profile\n                            </button>\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <div class="mazemaster-help">\n                                <div class="mazemaster-help-title">Usage:</div>\n                                <code>/battlebar profile="profileName"</code>\n                                <div class="mazemaster-help-title">Difficulty:</div>\n                                <ul>\n                                    <li><code>1</code> - Easy (large zone, slow)</li>\n                                    <li><code>3</code> - Medium</li>\n                                    <li><code>5</code> - Hard (small zone, fast)</li>\n                                </ul>\n                            </div>\n                        </div>\n                    </div>\n\n                    \x3c!-- MAZE CONFIG --\x3e\n                    <div id="mazemaster_maze_config" class="mazemaster-game-config" style="').concat("maze"===h?"":"display: none;",'">\n                        \x3c!-- Profile Selection --\x3e\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Maze Profile</label>\n                            <div class="mazemaster-profile-row">\n                                <select id="mazemaster_maze_profile_select" class="mazemaster-select">\n                                    ').concat(0===u.length?'<option value="">No profiles</option>':"","\n                                    ").concat(u.map((e=>'<option value="'.concat(on(e),'" ').concat(e===g?"selected":"",">").concat(on(e),"</option>"))).join(""),'\n                                </select>\n                                <button id="mazemaster_maze_new_profile_btn" class="menu_button menu_button_icon" title="New Profile">\n                                    <i class="fa-solid fa-plus"></i>\n                                </button>\n                                <button id="mazemaster_maze_delete_profile_btn" class="menu_button menu_button_icon" title="Delete Profile">\n                                    <i class="fa-solid fa-trash"></i>\n                                </button>\n                            </div>\n                        </div>\n\n                        \x3c!-- Grid Size --\x3e\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Grid Size</label>\n                            <select id="mazemaster_maze_size" class="mazemaster-select">\n                                <option value="7" ').concat(7===(b.gridSize||10)?"selected":"",'>7x7 (Easy)</option>\n                                <option value="10" ').concat(10===(b.gridSize||10)?"selected":"",'>10x10 (Medium)</option>\n                                <option value="15" ').concat(15===(b.gridSize||10)?"selected":"",'>15x15 (Hard)</option>\n                                <option value="20" ').concat(20===(b.gridSize||10)?"selected":"",'>20x20 (Expert)</option>\n                            </select>\n                        </div>\n\n                        \x3c!-- COLLAPSIBLE: Main Minion --\x3e\n                        <div class="mazemaster-collapsible ').concat(b.mainMinion?"expanded":"",'">\n                            <button class="mazemaster-collapsible-header" data-target="main_minion_section">\n                                <i class="fa-solid fa-chevron-right mazemaster-collapse-icon"></i>\n                                <span>Main Minion</span>\n                                <span class="mazemaster-collapse-hint">(narrator/boss)</span>\n                            </button>\n                            <div id="main_minion_section" class="mazemaster-collapsible-content" style="display: ').concat(b.mainMinion?"block":"none",';">\n                                <div class="mazemaster-section">\n                                    <select id="mazemaster_maze_main_minion" class="mazemaster-select">\n                                        <option value="">None</option>\n                                        ').concat(f.map((e=>{const n=V(e);return'<option value="'.concat(on(e),'" ').concat(b.mainMinion===e?"selected":"",">").concat(on((null==n?void 0:n.name)||e),"</option>")})).join(""),'\n                                    </select>\n                                    <div class="mazemaster-help-small"><small>The main minion narrates the maze and guards the exit</small></div>\n                                </div>\n\n                                <div id="mazemaster_main_minion_settings" class="mazemaster-subsection" style="display: ').concat(b.mainMinion?"block":"none",';">\n                                    <div class="mazemaster-section">\n                                        <label class="mazemaster-label">Intro Message</label>\n                                        <input type="text" id="mazemaster_maze_intro_message" class="mazemaster-input" placeholder="Welcome to my maze..." value="').concat(on(b.mainMinionIntroMessage||""),'">\n                                    </div>\n\n                                    <div class="mazemaster-inline-row">\n                                        <div class="mazemaster-section mazemaster-flex-1">\n                                            <label class="mazemaster-label">Random Msg %</label>\n                                            <input type="number" id="mazemaster_maze_random_chance" class="mazemaster-input" min="0" max="100" value="').concat(b.mainMinionRandomChance||15,'">\n                                        </div>\n                                    </div>\n\n                                    <div class="mazemaster-section">\n                                        <label class="mazemaster-label">Random Messages (one per line)</label>\n                                        <textarea id="mazemaster_maze_random_messages" class="mazemaster-textarea" rows="2" placeholder="You\'re still here?&#10;Getting lost yet?">').concat(on((b.mainMinionRandomMessages||[]).join("\n")),'</textarea>\n                                    </div>\n\n                                    <div class="mazemaster-section">\n                                        <label class="mazemaster-label">Exit Encounter</label>\n                                        <div class="mazemaster-help-small"><small>What happens when the player reaches the exit</small></div>\n                                        <select id="mazemaster_maze_exit_type" class="mazemaster-select">\n                                            <option value="messenger" ').concat("messenger"===(b.mainMinionExitType||"messenger")?"selected":"",'>Message Only (no challenge)</option>\n                                            <option value="battlebar" ').concat("battlebar"===b.mainMinionExitType?"selected":"",'>Battlebar Fight</option>\n                                            <option value="prizewheel" ').concat("prizewheel"===b.mainMinionExitType?"selected":"",'>Prize Wheel</option>\n                                        </select>\n                                    </div>\n\n                                    <div id="mazemaster_exit_profile_section" class="mazemaster-section" style="display: ').concat(b.mainMinionExitType&&"messenger"!==b.mainMinionExitType?"block":"none",';">\n                                        <label class="mazemaster-label">Exit Game Profile</label>\n                                        <div class="mazemaster-help-small"><small>Which Battlebar/Wheel profile to use for the exit boss</small></div>\n                                        <select id="mazemaster_maze_exit_profile" class="mazemaster-select">\n                                            <option value="">Select...</option>\n                                        </select>\n                                    </div>\n\n                                    <div class="mazemaster-section">\n                                        <button id="mazemaster_maze_story_btn" class="menu_button">\n                                            <i class="fa-solid fa-book"></i> Story Milestones\n                                        </button>\n                                        <div class="mazemaster-help-small"><small>Configure story text shown as player progresses</small></div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n\n                        \x3c!-- COLLAPSIBLE: Encounters --\x3e\n                        <div class="mazemaster-collapsible expanded">\n                            <button class="mazemaster-collapsible-header" data-target="encounters_section">\n                                <i class="fa-solid fa-chevron-right mazemaster-collapse-icon"></i>\n                                <span>Encounters</span>\n                                <span class="mazemaster-collapse-hint">(minions & traps)</span>\n                            </button>\n                            <div id="encounters_section" class="mazemaster-collapsible-content" style="display: block;">\n                                <div class="mazemaster-section">\n                                    <label class="mazemaster-label">Minion Encounters</label>\n                                    <div id="mazemaster_maze_encounters_list" class="mazemaster-encounters-list">\n                                        \x3c!-- Encounter rows rendered here --\x3e\n                                    </div>\n                                    <button id="mazemaster_add_encounter_btn" class="menu_button mazemaster-add-btn">\n                                        <i class="fa-solid fa-plus"></i> Add Minion\n                                    </button>\n                                </div>\n\n                                <div class="mazemaster-section">\n                                    <label class="mazemaster-label">Trap Tiles</label>\n                                    <div id="mazemaster_maze_traps_list" class="mazemaster-encounters-list">\n                                        \x3c!-- Trap encounter rows rendered here --\x3e\n                                    </div>\n                                    <button id="mazemaster_add_trap_encounter_btn" class="menu_button mazemaster-add-btn">\n                                        <i class="fa-solid fa-plus"></i> Add Trap\n                                    </button>\n                                </div>\n\n                                <div class="mazemaster-section">\n                                    <button id="mazemaster_intelligent_distribute" class="menu_button mazemaster-distribute-btn">\n                                        <i class="fa-solid fa-wand-magic-sparkles"></i> Intelligent Distribute\n                                    </button>\n                                    <div class="mazemaster-help-small">\n                                        <small>Auto-sets tile percentages based on minion types</small>\n                                    </div>\n                                </div>\n\n                                <div class="mazemaster-section">\n                                    <label class="mazemaster-label">On Battlebar Loss</label>\n                                    <select id="mazemaster_maze_loss_action" class="mazemaster-select">\n                                        <option value="continue" ').concat("continue"===(b.onBattlebarLoss||"continue")?"selected":"",'>Continue (skip encounter)</option>\n                                        <option value="respawn" ').concat("respawn"===b.onBattlebarLoss?"selected":"",'>Respawn at Start</option>\n                                        <option value="gameover" ').concat("gameover"===b.onBattlebarLoss?"selected":"",'>Game Over</option>\n                                    </select>\n                                </div>\n                            </div>\n                        </div>\n\n                        \x3c!-- COLLAPSIBLE: Chests & Loot --\x3e\n                        <div class="mazemaster-collapsible">\n                            <button class="mazemaster-collapsible-header" data-target="chests_section">\n                                <i class="fa-solid fa-chevron-right mazemaster-collapse-icon"></i>\n                                <span>Chests & Loot</span>\n                            </button>\n                            <div id="chests_section" class="mazemaster-collapsible-content" style="display: none;">\n                                <div class="mazemaster-section">\n                                    <label class="mazemaster-label">Chest Distribution</label>\n                                    <div class="mazemaster-grid-2col">\n                                        <div class="mazemaster-row">\n                                            <label>Chest Tiles %</label>\n                                            <input type="number" id="mazemaster_maze_chest_percent" class="mazemaster-input-small" min="0" max="50" value="').concat(b.chestTilePercent||10,'">\n                                        </div>\n                                        <div class="mazemaster-row">\n                                            <label>Locked %</label>\n                                            <input type="number" id="mazemaster_maze_locked_percent" class="mazemaster-input-small" min="0" max="100" value="').concat(b.chestLockedPercent||30,'">\n                                        </div>\n                                        <div class="mazemaster-row">\n                                            <label>Locked Bonus %</label>\n                                            <input type="number" id="mazemaster_maze_locked_bonus" class="mazemaster-input-small" min="0" max="200" value="').concat(b.chestLockedBonusPercent||50,'">\n                                        </div>\n                                        <div class="mazemaster-row">\n                                            <label>Mimic %</label>\n                                            <input type="number" id="mazemaster_maze_mimic_percent" class="mazemaster-input-small" min="0" max="100" value="').concat(b.chestMimicPercent||15,'">\n                                        </div>\n                                    </div>\n                                </div>\n\n                                <div class="mazemaster-section">\n                                    <label class="mazemaster-label">Loot per Chest</label>\n                                    <div class="mazemaster-row">\n                                        <input type="number" id="mazemaster_maze_loot_min" class="mazemaster-input-small" min="1" max="10" value="').concat(b.chestLootMin||1,'" style="width:50px">\n                                        <span>to</span>\n                                        <input type="number" id="mazemaster_maze_loot_max" class="mazemaster-input-small" min="1" max="10" value="').concat(b.chestLootMax||2,'" style="width:50px">\n                                        <span>items</span>\n                                    </div>\n                                </div>\n\n                                <div class="mazemaster-section">\n                                    <label class="mazemaster-label">Regular Chest Loot %</label>\n                                    <div class="mazemaster-grid-4col">\n                                        <div class="mazemaster-row"><label>Key</label><input type="number" id="mazemaster_maze_chest_key" class="mazemaster-input-small" min="0" max="100" value="').concat(b.chestKeyChance||30,'"></div>\n                                        <div class="mazemaster-row"><label>POW</label><input type="number" id="mazemaster_maze_chest_pow" class="mazemaster-input-small" min="0" max="100" value="').concat(b.chestPowChance||50,'"></div>\n                                        <div class="mazemaster-row"><label>Stealth</label><input type="number" id="mazemaster_maze_chest_stealth" class="mazemaster-input-small" min="0" max="100" value="').concat(b.chestStealthChance||0,'"></div>\n                                        <div class="mazemaster-row"><label>G-POW</label><input type="number" id="mazemaster_maze_chest_grandpow" class="mazemaster-input-small" min="0" max="100" value="').concat(b.chestGrandpowChance||0,'"></div>\n                                    </div>\n                                </div>\n\n                                <div class="mazemaster-section">\n                                    <label class="mazemaster-label">Locked Chest Loot %</label>\n                                    <div class="mazemaster-grid-4col">\n                                        <div class="mazemaster-row"><label>Key</label><input type="number" id="mazemaster_maze_locked_key" class="mazemaster-input-small" min="0" max="100" value="').concat(b.lockedChestKeyChance||40,'"></div>\n                                        <div class="mazemaster-row"><label>POW</label><input type="number" id="mazemaster_maze_locked_pow" class="mazemaster-input-small" min="0" max="100" value="').concat(b.lockedChestPowChance||60,'"></div>\n                                        <div class="mazemaster-row"><label>Stealth</label><input type="number" id="mazemaster_maze_locked_stealth" class="mazemaster-input-small" min="0" max="100" value="').concat(b.lockedChestStealthChance||30,'"></div>\n                                        <div class="mazemaster-row"><label>G-POW</label><input type="number" id="mazemaster_maze_locked_grandpow" class="mazemaster-input-small" min="0" max="100" value="').concat(b.lockedChestGrandpowChance||5,'"></div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n\n                        \x3c!-- COLLAPSIBLE: Victory & Loss --\x3e\n                        <div class="mazemaster-collapsible">\n                            <button class="mazemaster-collapsible-header" data-target="victory_section">\n                                <i class="fa-solid fa-chevron-right mazemaster-collapse-icon"></i>\n                                <span>Victory & Loss</span>\n                            </button>\n                            <div id="victory_section" class="mazemaster-collapsible-content" style="display: none;">\n                                <div class="mazemaster-section">\n                                    <label class="mazemaster-label">Victory Message</label>\n                                    <input type="text" id="mazemaster_maze_win_message" class="mazemaster-input" placeholder="You escaped the maze!" value="').concat(on(b.winMessage||""),'">\n                                </div>\n\n                                <div class="mazemaster-section">\n                                    <label class="mazemaster-label">Victory Image</label>\n                                    <div class="mazemaster-maze-win-image-row">\n                                        <div class="mazemaster-maze-win-image-preview">\n                                            ').concat(b.winImage?'<img id="maze_win_image_preview" src="'.concat(on(b.winImage),'" alt="Victory">'):'<div id="maze_win_image_preview" class="no-image">No image</div>','\n                                        </div>\n                                        <button id="mazemaster_maze_win_image_btn" class="menu_button">\n                                            <i class="fa-solid fa-upload"></i> Upload\n                                        </button>\n                                    </div>\n                                    <input type="file" id="mazemaster_maze_win_image_file" accept="image/*" style="display: none;">\n                                </div>\n\n                                <div class="mazemaster-section">\n                                    <label class="mazemaster-label">Win Command</label>\n                                    <textarea id="mazemaster_maze_win_cmd" class="mazemaster-textarea" rows="2" placeholder="/echo Victory!">').concat(on(b.winCommand||""),'</textarea>\n                                </div>\n\n                                <div class="mazemaster-section">\n                                    <label class="mazemaster-label">Lose Command</label>\n                                    <textarea id="mazemaster_maze_lose_cmd" class="mazemaster-textarea" rows="2" placeholder="/echo Defeated...">').concat(on(b.loseCommand||""),'</textarea>\n                                </div>\n                            </div>\n                        </div>\n\n                        \x3c!-- COLLAPSIBLE: Starting Inventory --\x3e\n                        <div class="mazemaster-collapsible">\n                            <button class="mazemaster-collapsible-header" data-target="starting_inv_section">\n                                <i class="fa-solid fa-chevron-right mazemaster-collapse-icon"></i>\n                                <span>Starting Inventory</span>\n                            </button>\n                            <div id="starting_inv_section" class="mazemaster-collapsible-content" style="display: none;">\n                                <div class="mazemaster-section">\n                                    <div class="mazemaster-grid-4col">\n                                        <div class="mazemaster-row"><label><i class="fa-solid fa-key"></i> Keys</label><input type="number" id="mazemaster_start_key" class="mazemaster-input-small" min="0" max="99" value="').concat((null===(o=b.startingInventory)||void 0===o?void 0:o.key)||0,'"></div>\n                                        <div class="mazemaster-row"><label><i class="fa-solid fa-bolt"></i> POW</label><input type="number" id="mazemaster_start_pow" class="mazemaster-input-small" min="0" max="99" value="').concat((null===(i=b.startingInventory)||void 0===i?void 0:i.pow)||0,'"></div>\n                                        <div class="mazemaster-row"><label><i class="fa-solid fa-user-ninja"></i> Stealth</label><input type="number" id="mazemaster_start_stealth" class="mazemaster-input-small" min="0" max="99" value="').concat((null===(s=b.startingInventory)||void 0===s?void 0:s.stealth)||0,'"></div>\n                                        <div class="mazemaster-row"><label><i class="fa-solid fa-star"></i> G-POW</label><input type="number" id="mazemaster_start_grandpow" class="mazemaster-input-small" min="0" max="99" value="').concat((null===(r=b.startingInventory)||void 0===r?void 0:r.grandpow)||0,'"></div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n\n                        \x3c!-- Save Button --\x3e\n                        <div class="mazemaster-section">\n                            <button id="mazemaster_maze_save_btn" class="menu_button menu_button_primary mazemaster-save-btn">\n                                <i class="fa-solid fa-save"></i> Save Profile\n                            </button>\n                        </div>\n\n                        \x3c!-- Saved Games --\x3e\n                        <div class="mazemaster-collapsible">\n                            <button class="mazemaster-collapsible-header" data-target="saved_games_section">\n                                <i class="fa-solid fa-chevron-right mazemaster-collapse-icon"></i>\n                                <span>Saved Games</span>\n                            </button>\n                            <div id="saved_games_section" class="mazemaster-collapsible-content" style="display: none;">\n                                <div id="mazemaster_saved_games_list" class="mazemaster-saved-games-list">\n                                    \x3c!-- Saved games rendered here --\x3e\n                                </div>\n                            </div>\n                        </div>\n\n                        \x3c!-- Usage Help --\x3e\n                        <div class="mazemaster-section">\n                            <div class="mazemaster-help">\n                                <div class="mazemaster-help-title">Usage:</div>\n                                <code>/maze profile="profileName"</code>\n                            </div>\n                        </div>\n                    </div>\n\n                    \x3c!-- MINIONS CONFIG --\x3e\n                    <div id="mazemaster_minions_config" class="mazemaster-game-config" style="').concat("minions"===h?"":"display: none;",'">\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Minion Profile</label>\n                            <div class="mazemaster-profile-row">\n                                <select id="mazemaster_minion_profile_select" class="mazemaster-select">\n                                    <option value="">(Current Minions)</option>\n                                    ').concat(Object.keys(P.minionProfiles||{}).map((e=>'<option value="'.concat(on(e),'">').concat(on(e),"</option>"))).join(""),'\n                                </select>\n                                <button id="mazemaster_minion_profile_save_btn" class="menu_button menu_button_icon" title="Save Current as Profile">\n                                    <i class="fa-solid fa-floppy-disk"></i>\n                                </button>\n                                <button id="mazemaster_minion_profile_load_btn" class="menu_button menu_button_icon" title="Load Profile">\n                                    <i class="fa-solid fa-folder-open"></i>\n                                </button>\n                                <button id="mazemaster_minion_profile_delete_btn" class="menu_button menu_button_icon" title="Delete Profile">\n                                    <i class="fa-solid fa-trash"></i>\n                                </button>\n                            </div>\n                            <div class="mazemaster-help-small"><small>Save/load sets of minions as profiles</small></div>\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Minions</label>\n                            <div id="mazemaster_minions_list" class="mazemaster-minions-list">\n                                \x3c!-- Minions rendered here --\x3e\n                            </div>\n                            <button id="mazemaster_add_minion_btn" class="menu_button mazemaster-add-btn">\n                                <i class="fa-solid fa-plus"></i> Add Minion\n                            </button>\n                            <input type="file" id="mazemaster_minion_image_file" accept="image/*" style="display: none;">\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <div class="mazemaster-help">\n                                <div class="mazemaster-help-title">Usage:</div>\n                                <code>/mazeminion name="MinionName" message="Hello!"</code>\n                                <p><small>Sets the minion display in an active maze game.</small></p>\n                            </div>\n                        </div>\n                    </div>\n\n                    \x3c!-- TRAPS CONFIG --\x3e\n                    <div id="mazemaster_traps_config" class="mazemaster-game-config" style="').concat("traps"===h?"":"display: none;",'">\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Trap Profile</label>\n                            <div class="mazemaster-profile-row">\n                                <select id="mazemaster_trap_profile_select" class="mazemaster-select">\n                                    <option value="">(Current Traps)</option>\n                                    ').concat(Object.keys(P.trapProfiles||{}).map((e=>'<option value="'.concat(on(e),'">').concat(on(e),"</option>"))).join(""),'\n                                </select>\n                                <button id="mazemaster_trap_profile_save_btn" class="menu_button menu_button_icon" title="Save Current as Profile">\n                                    <i class="fa-solid fa-floppy-disk"></i>\n                                </button>\n                                <button id="mazemaster_trap_profile_load_btn" class="menu_button menu_button_icon" title="Load Profile">\n                                    <i class="fa-solid fa-folder-open"></i>\n                                </button>\n                                <button id="mazemaster_trap_profile_delete_btn" class="menu_button menu_button_icon" title="Delete Profile">\n                                    <i class="fa-solid fa-trash"></i>\n                                </button>\n                            </div>\n                            <div class="mazemaster-help-small"><small>Save/load sets of traps as profiles</small></div>\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Traps</label>\n                            <div id="mazemaster_traps_list" class="mazemaster-traps-list">\n                                \x3c!-- Traps rendered here --\x3e\n                            </div>\n                            <button id="mazemaster_add_trap_btn" class="menu_button mazemaster-add-btn">\n                                <i class="fa-solid fa-plus"></i> Add Trap\n                            </button>\n                            <input type="file" id="mazemaster_trap_image_file" accept="image/*" style="display: none;">\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <div class="mazemaster-help">\n                                <div class="mazemaster-help-title">Traps:</div>\n                                <p><small>Traps can be placed on maze tiles. When a player steps on a trap, it shows the image/message and runs the script.</small></p>\n                                <p><small>Add traps to maze profiles in the Maze tab under "Trap Tiles".</small></p>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n\n        <style>\n            .mazemaster-panel {\n                display: flex;\n                flex-direction: column;\n                height: 100%;\n            }\n\n            .mazemaster-panel-header {\n                padding: 10px 15px;\n                border-bottom: 1px solid var(--SmartThemeBorderColor, #555);\n            }\n\n            .mazemaster-panel-header h2 {\n                margin: 0;\n                font-size: 1.2em;\n                display: flex;\n                align-items: center;\n                gap: 10px;\n            }\n\n            .mazemaster-tabs {\n                display: flex;\n                border-bottom: 1px solid var(--SmartThemeBorderColor, #555);\n                padding: 0 10px;\n            }\n\n            .mazemaster-tab {\n                padding: 8px 16px;\n                background: transparent;\n                border: none;\n                border-bottom: 2px solid transparent;\n                cursor: pointer;\n                color: var(--SmartThemeBodyColor);\n                font-size: 0.9em;\n            }\n\n            .mazemaster-tab:hover {\n                background: rgba(255, 255, 255, 0.05);\n            }\n\n            .mazemaster-tab.active {\n                border-bottom-color: var(--SmartThemeQuoteColor, #4a7c59);\n                color: var(--SmartThemeQuoteColor, #4a7c59);\n            }\n\n            .mazemaster-panel-content {\n                flex: 1;\n                overflow-y: auto;\n                padding: 15px;\n            }\n\n            .mazemaster-tab-content {\n                display: none;\n            }\n\n            .mazemaster-tab-content.active {\n                display: block;\n            }\n\n            .mazemaster-section {\n                margin-bottom: 15px;\n            }\n\n            .mazemaster-label {\n                display: block;\n                font-weight: bold;\n                margin-bottom: 5px;\n                font-size: 0.9em;\n            }\n\n            .mazemaster-profile-row {\n                display: flex;\n                gap: 5px;\n            }\n\n            .mazemaster-profile-row select {\n                flex: 1;\n            }\n\n            .mazemaster-select {\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 6px 8px;\n                color: var(--SmartThemeBodyColor);\n            }\n\n            .mazemaster-segments-list {\n                display: flex;\n                flex-direction: column;\n                gap: 8px;\n                margin-bottom: 10px;\n                max-height: 300px;\n                overflow-y: auto;\n            }\n\n            .mazemaster-segment-item {\n                background: rgba(0, 0, 0, 0.2);\n                border-radius: 5px;\n                padding: 10px;\n            }\n\n            .mazemaster-segment-row {\n                display: flex;\n                gap: 8px;\n                margin-bottom: 8px;\n                align-items: center;\n            }\n\n            .mazemaster-segment-row:last-child {\n                margin-bottom: 0;\n            }\n\n            .mazemaster-segment-field {\n                flex: 1;\n                display: flex;\n                flex-direction: column;\n                gap: 2px;\n            }\n\n            .mazemaster-segment-field label {\n                font-size: 0.7em;\n                opacity: 0.7;\n            }\n\n            .mazemaster-segment-field input:not([type="checkbox"]),\n            .mazemaster-segment-field select,\n            .mazemaster-segment-field textarea {\n                width: 100%;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 5px 8px;\n                color: var(--SmartThemeBodyColor);\n                font-size: 0.85em;\n            }\n\n            .mazemaster-segment-field textarea {\n                min-height: 40px;\n                resize: vertical;\n                font-family: monospace;\n            }\n\n            .mazemaster-segment-field.small {\n                flex: 0 0 80px;\n            }\n\n            .mazemaster-segment-field.tiny {\n                flex: 0 0 100px;\n                overflow: visible;\n            }\n\n            .mazemaster-segment-checkbox {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                font-size: 0.85em;\n                cursor: pointer;\n                white-space: nowrap;\n                padding: 5px;\n                margin: 0;\n            }\n\n            .mazemaster-segment-checkbox input[type="checkbox"] {\n                width: 18px;\n                height: 18px;\n                min-width: 18px;\n                min-height: 18px;\n                cursor: pointer;\n                pointer-events: auto;\n                margin: 0;\n                flex-shrink: 0;\n            }\n\n            .mazemaster-profile-settings {\n                background: rgba(0, 0, 0, 0.15);\n                padding: 10px;\n                border-radius: 5px;\n            }\n\n            .mazemaster-profile-options {\n                display: flex;\n                flex-direction: column;\n                gap: 10px;\n            }\n\n            .mazemaster-checkbox-label {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                cursor: pointer;\n                font-size: 0.9em;\n            }\n\n            .mazemaster-checkbox-label input[type="checkbox"] {\n                width: 16px;\n                height: 16px;\n                cursor: pointer;\n            }\n\n            .mazemaster-difficulty-row {\n                display: flex;\n                align-items: center;\n                gap: 10px;\n                font-size: 0.9em;\n            }\n\n            .mazemaster-select-small {\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 4px 8px;\n                color: var(--SmartThemeBodyColor);\n                width: 60px;\n            }\n\n            .mazemaster-segment-delete {\n                padding: 5px 8px;\n            }\n\n            .mazemaster-add-btn,\n            .mazemaster-save-btn {\n                width: 100%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 5px;\n            }\n\n            .mazemaster-distribute-btn {\n                width: 100%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 8px;\n                background: linear-gradient(135deg, #9b59b6, #8e44ad) !important;\n                color: #fff !important;\n            }\n\n            .mazemaster-distribute-btn:hover {\n                background: linear-gradient(135deg, #8e44ad, #7d3c98) !important;\n            }\n\n            .mazemaster-help-small {\n                margin-top: 5px;\n                color: #888;\n                text-align: center;\n            }\n\n            .menu_button_primary {\n                background: var(--SmartThemeQuoteColor, #4a7c59) !important;\n            }\n\n            .mazemaster-help {\n                background: rgba(0, 0, 0, 0.2);\n                padding: 10px;\n                border-radius: 5px;\n                font-size: 0.85em;\n            }\n\n            .mazemaster-help-title {\n                font-weight: bold;\n                margin-bottom: 5px;\n                margin-top: 10px;\n            }\n\n            .mazemaster-help-title:first-child {\n                margin-top: 0;\n            }\n\n            .mazemaster-help code {\n                background: rgba(0, 0, 0, 0.3);\n                padding: 2px 6px;\n                border-radius: 3px;\n                font-family: monospace;\n                font-size: 0.9em;\n            }\n\n            .mazemaster-help ul {\n                margin: 5px 0;\n                padding-left: 20px;\n            }\n\n            .mazemaster-help li {\n                margin: 3px 0;\n            }\n\n            .mazemaster-help small {\n                opacity: 0.7;\n                display: block;\n                margin-top: 5px;\n            }\n\n            .mazemaster-empty-state {\n                text-align: center;\n                padding: 15px;\n                opacity: 0.6;\n            }\n\n            /* Game Selector */\n            .mazemaster-game-selector {\n                display: flex;\n                gap: 10px;\n                margin-bottom: 15px;\n            }\n\n            .mazemaster-game-btn {\n                flex: 1;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 8px;\n                padding: 10px;\n                border-radius: 5px;\n                transition: all 0.2s;\n            }\n\n            .mazemaster-game-btn.active {\n                background: var(--SmartThemeQuoteColor, #4a7c59) !important;\n                color: white;\n            }\n\n            .mazemaster-game-config {\n                animation: fadeIn 0.2s ease;\n            }\n\n            @keyframes fadeIn {\n                from { opacity: 0; }\n                to { opacity: 1; }\n            }\n\n            /* Battlebar Styles */\n            .mazemaster-bb-settings {\n                display: flex;\n                flex-direction: column;\n                gap: 10px;\n            }\n\n            .mazemaster-bb-row {\n                display: flex;\n                gap: 10px;\n            }\n\n            .mazemaster-bb-field {\n                flex: 1;\n                display: flex;\n                flex-direction: column;\n                gap: 4px;\n            }\n\n            .mazemaster-bb-field label {\n                font-size: 0.8em;\n                opacity: 0.8;\n            }\n\n            .mazemaster-bb-field input,\n            .mazemaster-bb-field select {\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 6px 8px;\n                color: var(--SmartThemeBodyColor);\n            }\n\n            .mazemaster-bb-commands {\n                display: flex;\n                flex-direction: column;\n                gap: 10px;\n            }\n\n            .mazemaster-bb-command {\n                display: flex;\n                flex-direction: column;\n                gap: 4px;\n            }\n\n            .mazemaster-bb-command label {\n                font-size: 0.85em;\n                font-weight: bold;\n            }\n\n            .mazemaster-bb-command textarea {\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 8px;\n                color: var(--SmartThemeBodyColor);\n                font-family: monospace;\n                font-size: 0.85em;\n                min-height: 40px;\n                resize: vertical;\n            }\n\n            .mazemaster-bb-images-list {\n                display: flex;\n                flex-wrap: wrap;\n                gap: 10px;\n                margin-bottom: 10px;\n            }\n\n            .mazemaster-input {\n                width: 100%;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 8px 10px;\n                color: var(--SmartThemeBodyColor, #fff);\n                font-size: 1em;\n            }\n\n            .mazemaster-input::placeholder {\n                color: var(--SmartThemeBodyColor, #888);\n                opacity: 0.6;\n            }\n\n            .mazemaster-bb-image-item {\n                position: relative;\n                width: 120px;\n                display: flex;\n                flex-direction: column;\n                border-radius: 5px;\n                overflow: hidden;\n                border: 2px solid var(--SmartThemeBorderColor, #444);\n                cursor: pointer;\n                background: rgba(0, 0, 0, 0.2);\n            }\n\n            .mazemaster-bb-image-item:hover {\n                border-color: var(--SmartThemeQuoteColor, #888);\n            }\n\n            .mazemaster-bb-image-item img {\n                width: 100%;\n                height: 80px;\n                object-fit: cover;\n            }\n\n            .mazemaster-bb-image-item .bb-image-index {\n                position: absolute;\n                top: 2px;\n                left: 2px;\n                background: rgba(0, 0, 0, 0.7);\n                color: white;\n                font-size: 0.7em;\n                padding: 2px 5px;\n                border-radius: 3px;\n            }\n\n            .mazemaster-bb-image-item .bb-image-message {\n                padding: 4px 6px;\n                font-size: 0.7em;\n                color: var(--SmartThemeBodyColor, #aaa);\n                text-align: center;\n                overflow: hidden;\n                text-overflow: ellipsis;\n                white-space: nowrap;\n                max-height: 20px;\n            }\n\n            .mazemaster-bb-image-item .bb-image-delete {\n                position: absolute;\n                top: 2px;\n                right: 2px;\n                background: rgba(231, 76, 60, 0.9);\n                color: white;\n                border: none;\n                width: 20px;\n                height: 20px;\n                border-radius: 50%;\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-size: 0.7em;\n            }\n\n            .mazemaster-bb-image-item .bb-image-delete:hover {\n                background: #c0392b;\n            }\n\n            /* Game Tab Styles */\n            .mazemaster-game-launch {\n                display: flex;\n                flex-direction: column;\n                gap: 15px;\n                padding: 10px 0;\n            }\n\n            .mazemaster-play-btn {\n                width: 100%;\n                padding: 15px 20px;\n                font-size: 1.2em;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 10px;\n            }\n\n            /* Maze Config Styles */\n            .mazemaster-textarea {\n                width: 100%;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 8px 10px;\n                color: var(--SmartThemeBodyColor, #fff);\n                font-family: monospace;\n                font-size: 0.9em;\n                min-height: 60px;\n                resize: vertical;\n            }\n\n            .mazemaster-maze-win-image-row {\n                display: flex;\n                gap: 10px;\n                align-items: flex-start;\n            }\n\n            .mazemaster-maze-win-image-preview {\n                width: 80px;\n                height: 80px;\n                border-radius: 5px;\n                border: 2px solid var(--SmartThemeBorderColor, #444);\n                overflow: hidden;\n                background: rgba(0, 0, 0, 0.2);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n            }\n\n            .mazemaster-maze-win-image-preview img {\n                width: 100%;\n                height: 100%;\n                object-fit: cover;\n            }\n\n            .mazemaster-maze-win-image-preview .no-image {\n                font-size: 0.7em;\n                opacity: 0.5;\n                text-align: center;\n            }\n\n            /* Maze Subsection Styles */\n            .mazemaster-subsection {\n                background: rgba(0, 0, 0, 0.15);\n                border-left: 3px solid var(--SmartThemeQuoteColor, #666);\n                padding: 10px;\n                margin: 10px 0;\n                border-radius: 0 5px 5px 0;\n            }\n\n            /* Encounters List Styles */\n            .mazemaster-encounters-list {\n                display: flex;\n                flex-direction: column;\n                gap: 8px;\n                margin-bottom: 10px;\n            }\n\n            .mazemaster-encounter-row {\n                display: flex;\n                gap: 8px;\n                align-items: center;\n            }\n\n            .mazemaster-encounter-row select {\n                flex: 1;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 6px 8px;\n                color: var(--SmartThemeBodyColor);\n            }\n\n            .mazemaster-encounter-row input[type="number"] {\n                width: 60px;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 6px 8px;\n                color: var(--SmartThemeBodyColor);\n                text-align: center;\n            }\n\n            .mazemaster-encounter-row .encounter-remove-btn {\n                padding: 5px 8px;\n            }\n\n            /* Maze Cell Minion Indicators */\n            .maze-cell.has-minion:not(.hidden)::before {\n                content: \'?\';\n                position: absolute;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                font-size: 0.7em;\n                color: #f39c12;\n                font-weight: bold;\n                z-index: 1;\n            }\n\n            .maze-cell.minion-triggered:not(.hidden)::before {\n                content: \'\\2713\';\n                color: #27ae60;\n            }\n\n            /* Maze Cell Chest Indicators */\n            .maze-cell.has-chest:not(.hidden)::before {\n                content: \'\\f187\';\n                font-family: \'Font Awesome 6 Free\';\n                font-weight: 900;\n                position: absolute;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                font-size: 0.6em;\n                color: #f39c12;\n                z-index: 1;\n            }\n\n            .maze-cell.chest-locked:not(.hidden)::before {\n                color: #95a5a6;\n            }\n\n            .maze-cell.chest-opened:not(.hidden)::before {\n                color: #666;\n                opacity: 0.5;\n            }\n\n            /* Maze Cell Trap Indicators */\n            .maze-cell.has-trap:not(.hidden)::before {\n                content: \'\\f6e2\';\n                font-family: \'Font Awesome 6 Free\';\n                font-weight: 900;\n                position: absolute;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                font-size: 0.6em;\n                color: #e74c3c;\n                z-index: 1;\n            }\n\n            .maze-cell.trap-triggered:not(.hidden)::before {\n                color: #666;\n                opacity: 0.5;\n            }\n\n            /* Inventory Display */\n            .mazemaster-maze-inventory {\n                display: flex;\n                justify-content: center;\n                gap: 12px;\n                padding: 6px 12px;\n                background: rgba(0, 0, 0, 0.4);\n                border-radius: 6px;\n                margin-bottom: 8px;\n            }\n\n            .inventory-item {\n                display: flex;\n                align-items: center;\n                gap: 4px;\n                font-size: 0.85em;\n                color: #fff;\n            }\n\n            .inventory-item i { font-size: 0.9em; }\n            .inventory-item i.fa-key { color: #f1c40f; }\n            .inventory-item i.fa-user-ninja { color: #9b59b6; }\n            .inventory-item i.fa-bolt { color: #e74c3c; }\n            .inventory-item.grandpow i.fa-star { color: #ffd700; text-shadow: 0 0 5px #ffd700; }\n            .inventory-item.grandpow { font-weight: bold; }\n\n            /* Encounter Confirmation Buttons */\n            .maze-confirm-buttons {\n                margin-top: 8px;\n                display: flex;\n                gap: 8px;\n                justify-content: center;\n            }\n\n            .maze-confirm-btn {\n                padding: 8px 16px;\n                font-size: 0.9em;\n                font-weight: bold;\n                border-radius: 6px;\n                background: linear-gradient(to bottom, #3498db, #2980b9);\n                color: #fff;\n                border: 2px solid #5dade2;\n                box-shadow: 0 2px 8px rgba(52, 152, 219, 0.4);\n                transition: all 0.2s;\n            }\n\n            .maze-confirm-btn:hover {\n                background: linear-gradient(to bottom, #5dade2, #3498db);\n                transform: scale(1.05);\n                box-shadow: 0 4px 12px rgba(52, 152, 219, 0.6);\n            }\n\n            .maze-slip-btn {\n                background: linear-gradient(to bottom, #9b59b6, #8e44ad);\n                border-color: #bb8fce;\n                box-shadow: 0 2px 8px rgba(155, 89, 182, 0.4);\n            }\n\n            .maze-slip-btn:hover {\n                background: linear-gradient(to bottom, #bb8fce, #9b59b6);\n                box-shadow: 0 4px 12px rgba(155, 89, 182, 0.6);\n            }\n\n            .maze-accept-btn {\n                background: linear-gradient(to bottom, #27ae60, #1e8449);\n                border-color: #58d68d;\n                box-shadow: 0 2px 8px rgba(39, 174, 96, 0.4);\n            }\n\n            .maze-accept-btn:hover {\n                background: linear-gradient(to bottom, #58d68d, #27ae60);\n                box-shadow: 0 4px 12px rgba(39, 174, 96, 0.6);\n            }\n\n            /* Battlebar Action Buttons */\n            .mazemaster-bb-action-buttons {\n                display: flex;\n                gap: 10px;\n                justify-content: center;\n                flex-wrap: wrap;\n                width: 100%;\n                max-width: 400px;\n            }\n\n            .mazemaster-bb-pow-btn,\n            .mazemaster-bb-grandpow-btn {\n                flex: 1;\n                min-width: 120px;\n                max-width: 180px;\n                padding: 12px 15px;\n                font-size: 1em;\n                border-radius: 10px;\n                cursor: pointer;\n                font-weight: bold;\n                border: none;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 8px;\n                transition: transform 0.1s, box-shadow 0.1s;\n            }\n\n            .mazemaster-bb-pow-btn {\n                background: linear-gradient(to bottom, #e74c3c, #c0392b);\n                color: #fff;\n                box-shadow: 0 4px 10px rgba(231, 76, 60, 0.3);\n            }\n\n            .mazemaster-bb-pow-btn:hover {\n                background: linear-gradient(to bottom, #c0392b, #a93226);\n                transform: scale(1.02);\n            }\n\n            .mazemaster-bb-grandpow-btn {\n                background: linear-gradient(135deg, #ffd700, #ffaa00);\n                color: #000;\n                text-shadow: 0 1px 0 rgba(255,255,255,0.5);\n                box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);\n            }\n\n            .mazemaster-bb-grandpow-btn:hover {\n                background: linear-gradient(135deg, #ffea00, #ffc400);\n                box-shadow: 0 4px 20px rgba(255, 215, 0, 0.6);\n                transform: scale(1.02);\n            }\n\n            /* Encounter Percent Label */\n            .encounter-percent-label {\n                font-size: 0.9em;\n                color: #888;\n            }\n\n            .encounter-percent-input {\n                width: 50px;\n            }\n\n            /* Small input for config rows */\n            .mazemaster-input-small {\n                width: 60px;\n                padding: 4px 8px;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                color: var(--SmartThemeBodyColor);\n            }\n\n            /* Grid layout for config rows */\n            .mazemaster-row {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                margin-bottom: 6px;\n            }\n\n            .mazemaster-row label {\n                min-width: 90px;\n                font-size: 0.85em;\n                color: var(--SmartThemeBodyColor);\n                opacity: 0.9;\n            }\n\n            /* Two-column grid for percentage fields */\n            .mazemaster-grid-2col {\n                display: grid;\n                grid-template-columns: 1fr 1fr;\n                gap: 8px 16px;\n            }\n\n            .mazemaster-grid-2col .mazemaster-row {\n                margin-bottom: 0;\n            }\n\n            .mazemaster-grid-2col .mazemaster-row label {\n                min-width: 80px;\n            }\n\n            /* Three-column grid for loot percentages */\n            .mazemaster-grid-3col {\n                display: grid;\n                grid-template-columns: repeat(3, 1fr);\n                gap: 8px;\n            }\n\n            .mazemaster-grid-3col .mazemaster-row {\n                flex-direction: column;\n                align-items: flex-start;\n                gap: 4px;\n                margin-bottom: 0;\n            }\n\n            .mazemaster-grid-3col .mazemaster-row label {\n                min-width: auto;\n                font-size: 0.8em;\n                opacity: 0.8;\n            }\n\n            .mazemaster-grid-3col .mazemaster-input-small {\n                width: 100%;\n            }\n\n            /* 4-column grid */\n            .mazemaster-grid-4col {\n                display: grid;\n                grid-template-columns: repeat(4, 1fr);\n                gap: 8px;\n            }\n\n            .mazemaster-grid-4col .mazemaster-row {\n                flex-direction: column;\n                align-items: flex-start;\n                gap: 2px;\n                margin-bottom: 0;\n            }\n\n            .mazemaster-grid-4col .mazemaster-row label {\n                min-width: auto;\n                font-size: 0.75em;\n                opacity: 0.8;\n            }\n\n            .mazemaster-grid-4col .mazemaster-input-small {\n                width: 100%;\n            }\n\n            /* Collapsible Sections */\n            .mazemaster-collapsible {\n                margin-bottom: 8px;\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 6px;\n                overflow: hidden;\n            }\n\n            .mazemaster-collapsible-header {\n                width: 100%;\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                padding: 10px 12px;\n                background: rgba(0, 0, 0, 0.2);\n                border: none;\n                cursor: pointer;\n                text-align: left;\n                font-size: 0.95em;\n                font-weight: 500;\n                color: inherit;\n                transition: background 0.2s;\n            }\n\n            .mazemaster-collapsible-header:hover {\n                background: rgba(0, 0, 0, 0.3);\n            }\n\n            .mazemaster-collapse-icon {\n                font-size: 0.8em;\n                transition: transform 0.2s;\n            }\n\n            .mazemaster-collapsible.expanded .mazemaster-collapse-icon {\n                transform: rotate(90deg);\n            }\n\n            .mazemaster-collapse-hint {\n                font-size: 0.8em;\n                opacity: 0.6;\n                margin-left: auto;\n            }\n\n            .mazemaster-collapsible-content {\n                padding: 12px;\n                border-top: 1px solid var(--SmartThemeBorderColor, #444);\n                background: rgba(0, 0, 0, 0.1);\n            }\n\n            .mazemaster-collapsible-content .mazemaster-section:last-child {\n                margin-bottom: 0;\n            }\n\n            /* Inline row */\n            .mazemaster-inline-row {\n                display: flex;\n                gap: 12px;\n            }\n\n            .mazemaster-flex-1 {\n                flex: 1;\n            }\n\n            /* Saved Games */\n            .mazemaster-saved-games-list {\n                display: flex;\n                flex-direction: column;\n                gap: 8px;\n            }\n\n            .mazemaster-saved-game {\n                display: flex;\n                justify-content: space-between;\n                align-items: center;\n                padding: 8px 12px;\n                background: rgba(0, 0, 0, 0.2);\n                border-radius: 4px;\n            }\n\n            .mazemaster-saved-game-info {\n                display: flex;\n                flex-direction: column;\n                gap: 2px;\n            }\n\n            .mazemaster-saved-game-name {\n                font-weight: 500;\n            }\n\n            .mazemaster-saved-game-details {\n                font-size: 0.8em;\n                opacity: 0.7;\n            }\n\n            .mazemaster-saved-game-actions {\n                display: flex;\n                gap: 6px;\n            }\n\n            .mazemaster-no-saves {\n                text-align: center;\n                opacity: 0.6;\n                padding: 12px;\n                font-style: italic;\n            }\n\n            /* Side-by-side sections */\n            .mazemaster-section-row {\n                display: grid;\n                grid-template-columns: 1fr 1fr;\n                gap: 16px;\n            }\n\n            .mazemaster-section-row .mazemaster-section {\n                margin-bottom: 0;\n            }\n\n            /* Minions Config Styles */\n            .mazemaster-minions-list {\n                display: flex;\n                flex-direction: column;\n                gap: 10px;\n                margin-bottom: 10px;\n            }\n\n            .mazemaster-minion-card {\n                display: flex;\n                gap: 10px;\n                align-items: center;\n                padding: 10px;\n                background: rgba(0, 0, 0, 0.2);\n                border-radius: 5px;\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n            }\n\n            .mazemaster-minion-card .minion-image {\n                width: 50px;\n                height: 50px;\n                border-radius: 5px;\n                overflow: hidden;\n                background: rgba(0, 0, 0, 0.3);\n                flex-shrink: 0;\n            }\n\n            .mazemaster-minion-card .minion-image img {\n                width: 100%;\n                height: 100%;\n                object-fit: cover;\n            }\n\n            .mazemaster-minion-card .minion-info {\n                flex: 1;\n            }\n\n            .mazemaster-minion-card .minion-row {\n                display: flex;\n                gap: 8px;\n                margin-bottom: 8px;\n            }\n\n            .mazemaster-minion-card .minion-name-input {\n                flex: 1;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 6px 8px;\n                color: var(--SmartThemeBodyColor);\n            }\n\n            .mazemaster-minion-card .minion-type-select {\n                width: 110px;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 6px 8px;\n                color: var(--SmartThemeBodyColor);\n            }\n\n            .mazemaster-minion-card .minion-profiles {\n                margin-top: 8px;\n            }\n\n            .mazemaster-minion-card .minion-profiles label {\n                display: block;\n                font-size: 0.85em;\n                color: var(--SmartThemeQuoteColor);\n                margin-bottom: 4px;\n            }\n\n            .mazemaster-minion-card .minion-profiles select {\n                width: 100%;\n                min-height: 60px;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 4px;\n                color: var(--SmartThemeBodyColor);\n            }\n\n            .mazemaster-minion-card .minion-profiles textarea {\n                width: 100%;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 6px 8px;\n                color: var(--SmartThemeBodyColor);\n                resize: vertical;\n            }\n\n            .mazemaster-minion-card .merchant-range-row {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n            }\n\n            .mazemaster-minion-card .merchant-range-row span {\n                color: var(--SmartThemeBodyColor);\n                opacity: 0.8;\n            }\n\n            .mazemaster-minion-card .minion-encounter-script {\n                margin-top: 10px;\n                padding-top: 10px;\n                border-top: 1px solid var(--SmartThemeBorderColor, #333);\n            }\n\n            .mazemaster-minion-card .minion-encounter-script label {\n                display: block;\n                font-size: 0.85em;\n                color: var(--SmartThemeQuoteColor);\n                margin-bottom: 4px;\n            }\n\n            .mazemaster-minion-card .minion-encounter-script textarea {\n                width: 100%;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 6px 8px;\n                color: var(--SmartThemeBodyColor);\n                resize: vertical;\n                font-family: monospace;\n            }\n\n            .mazemaster-minion-card .minion-delete-btn {\n                padding: 5px 8px;\n                flex-shrink: 0;\n                align-self: flex-start;\n            }\n\n            /* TRAP CARD STYLES */\n            .mazemaster-traps-list {\n                display: flex;\n                flex-direction: column;\n                gap: 10px;\n                margin-bottom: 10px;\n                max-height: 400px;\n                overflow-y: auto;\n            }\n\n            .mazemaster-trap-card {\n                display: flex;\n                gap: 10px;\n                background: rgba(0, 0, 0, 0.2);\n                border-radius: 8px;\n                padding: 10px;\n                align-items: flex-start;\n            }\n\n            .mazemaster-trap-card .trap-image {\n                width: 80px;\n                height: 80px;\n                flex-shrink: 0;\n                border-radius: 6px;\n                overflow: hidden;\n                background: rgba(0, 0, 0, 0.3);\n            }\n\n            .mazemaster-trap-card .trap-image img {\n                width: 100%;\n                height: 100%;\n                object-fit: cover;\n            }\n\n            .mazemaster-trap-card .trap-no-image {\n                width: 100%;\n                height: 100%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                color: var(--SmartThemeBodyColor);\n                opacity: 0.5;\n                font-size: 24px;\n            }\n\n            .mazemaster-trap-card .trap-info {\n                flex: 1;\n                display: flex;\n                flex-direction: column;\n                gap: 8px;\n            }\n\n            .mazemaster-trap-card .trap-row {\n                display: flex;\n                gap: 8px;\n            }\n\n            .mazemaster-trap-card .trap-name-input {\n                flex: 1;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 6px 8px;\n                color: var(--SmartThemeBodyColor);\n            }\n\n            .mazemaster-trap-card .trap-message-row,\n            .mazemaster-trap-card .trap-script-row {\n                display: flex;\n                flex-direction: column;\n                gap: 4px;\n            }\n\n            .mazemaster-trap-card .trap-message-row label,\n            .mazemaster-trap-card .trap-script-row label {\n                font-size: 0.75em;\n                opacity: 0.7;\n            }\n\n            .mazemaster-trap-card .trap-message-input,\n            .mazemaster-trap-card .trap-script-input {\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 6px 8px;\n                color: var(--SmartThemeBodyColor);\n                resize: vertical;\n                font-family: inherit;\n            }\n\n            .mazemaster-trap-card .trap-delete-btn {\n                padding: 5px 8px;\n                flex-shrink: 0;\n                align-self: flex-start;\n            }\n\n            /* Story Milestones Modal */\n            .mazemaster-story-modal {\n                position: fixed;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                background: rgba(0, 0, 0, 0.7);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                z-index: 10000;\n            }\n\n            .mazemaster-story-modal-content {\n                background: var(--SmartThemeBlurTintColor, #1a1a1a);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 10px;\n                padding: 20px;\n                width: 90%;\n                max-width: 600px;\n                max-height: 80vh;\n                overflow-y: auto;\n            }\n\n            .mazemaster-story-modal-content h3 {\n                margin: 0 0 15px 0;\n                display: flex;\n                align-items: center;\n                gap: 10px;\n            }\n\n            .mazemaster-story-textarea {\n                width: 100%;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 8px;\n                color: var(--SmartThemeBodyColor);\n                resize: vertical;\n                font-family: inherit;\n            }\n\n            .mazemaster-milestones-list {\n                display: flex;\n                flex-direction: column;\n                gap: 10px;\n                margin-bottom: 10px;\n                max-height: 200px;\n                overflow-y: auto;\n            }\n\n            .mazemaster-milestone-row {\n                display: flex;\n                gap: 10px;\n                align-items: flex-start;\n                background: rgba(0, 0, 0, 0.2);\n                padding: 10px;\n                border-radius: 6px;\n            }\n\n            .milestone-percent {\n                display: flex;\n                align-items: center;\n                gap: 4px;\n                flex-shrink: 0;\n            }\n\n            .milestone-percent-input {\n                width: 50px;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 6px;\n                color: var(--SmartThemeBodyColor);\n                text-align: center;\n            }\n\n            .milestone-text-input {\n                flex: 1;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 6px;\n                color: var(--SmartThemeBodyColor);\n                resize: vertical;\n                font-family: inherit;\n            }\n\n            .mazemaster-story-modal-buttons {\n                display: flex;\n                gap: 10px;\n                justify-content: flex-end;\n                margin-top: 15px;\n            }\n        </style>\n    ')}function an(){var e;const n=document.getElementById("mazemaster_segments_list");if(!n)return;const t=q(null===(e=document.getElementById("mazemaster_profile_select"))||void 0===e?void 0:e.value),a=(null==t?void 0:t.segments)||[];0!==a.length?(n.innerHTML=a.map(((e,n)=>'\n        <div class="mazemaster-segment-item" data-index="'.concat(n,'">\n            <div class="mazemaster-segment-row">\n                <div class="mazemaster-segment-field small">\n                    <label>Trigger</label>\n                    <input type="text" class="seg-trigger" value="').concat(on(e.trigger||""),'" placeholder="com1">\n                </div>\n                <div class="mazemaster-segment-field">\n                    <label>Display Text</label>\n                    <input type="text" class="seg-text" value="').concat(on(e.text||""),'" placeholder="Prize name">\n                </div>\n                <div class="mazemaster-segment-field small">\n                    <label>Size</label>\n                    <select class="seg-size">\n                        ').concat(z.map((n=>'<option value="'.concat(n,'" ').concat(e.size===n?"selected":"",">").concat(n,"</option>"))).join(""),'\n                    </select>\n                </div>\n                <button class="menu_button menu_button_icon mazemaster-segment-delete" title="Delete">\n                    <i class="fa-solid fa-trash"></i>\n                </button>\n            </div>\n            <div class="mazemaster-segment-row">\n                <div class="mazemaster-segment-field">\n                    <label>STScript Command</label>\n                    <textarea class="seg-command" placeholder="/echo You won!">').concat(on(e.command||""),'</textarea>\n                </div>\n                <div class="mazemaster-segment-field tiny">\n                    <label>&nbsp;</label>\n                    <label class="mazemaster-segment-checkbox">\n                        <input type="checkbox" class="seg-respin" ').concat(e.respin?"checked":"",">\n                        Respin\n                    </label>\n                </div>\n            </div>\n        </div>\n    "))).join(""),n.querySelectorAll(".mazemaster-segment-delete").forEach((e=>{e.addEventListener("click",(e=>{e.target.closest(".mazemaster-segment-item").remove()}))}))):n.innerHTML='<div class="mazemaster-empty-state">No segments. Click "Add Segment" to create one.</div>'}function on(e){const n=document.createElement("div");return n.textContent=e||"",n.innerHTML}function sn(){var e;const n=document.getElementById("mazemaster_bb_images_list");if(!n)return;const t=null===(e=document.getElementById("mazemaster_bb_profile_select"))||void 0===e?void 0:e.value;if(!t)return void(n.innerHTML='<div class="mazemaster-empty-state">Select or create a profile first.</div>');const a=(H(t)||{}).images||[];0!==a.length?(n.innerHTML=a.map(((e,n)=>'\n        <div class="mazemaster-bb-image-item" data-index="'.concat(n,'" title="Click to edit stage message">\n            <img src="/').concat(e.path,'" alt="').concat(on(e.stageMessage||""),'">\n            <span class="bb-image-index">').concat(n,'</span>\n            <div class="bb-image-message">').concat(on(e.stageMessage||"(no message)"),'</div>\n            <button class="bb-image-delete" title="Delete">\n                <i class="fa-solid fa-times"></i>\n            </button>\n        </div>\n    '))).join(""),n.querySelectorAll(".mazemaster-bb-image-item").forEach((e=>{e.addEventListener("click",(async n=>{var a;if(n.target.closest(".bb-image-delete"))return;const o=parseInt(e.dataset.index),i=H(t)||{},s=i.images||[],r=(null===(a=s[o])||void 0===a?void 0:a.stageMessage)||"",l=await p("Stage ".concat(o," Message:"),u.INPUT,r);null!=l&&(s[o].stageMessage=l,G(t,i),sn())}))})),n.querySelectorAll(".bb-image-delete").forEach((e=>{e.addEventListener("click",(async e=>{e.stopPropagation();const n=e.target.closest(".mazemaster-bb-image-item"),a=parseInt(n.dataset.index);if(!await p("Delete stage ".concat(a,"?"),u.CONFIRM))return;const o=H(t)||{};o.images=(o.images||[]).filter(((e,n)=>n!==a)),G(t,o),sn()}))}))):n.innerHTML='<div class="mazemaster-empty-state">No stages. Add images to create stages.</div>'}function rn(){var e,n,t,a;const o=null===(e=document.getElementById("mazemaster_maze_profile_select"))||void 0===e?void 0:e.value,s=Y(o)||{},r=document.getElementById("mazemaster_maze_size");r&&(r.value=s.gridSize||10);const l=document.getElementById("mazemaster_maze_win_cmd");l&&(l.value=s.winCommand||"");const m=document.getElementById("mazemaster_maze_lose_cmd");m&&(m.value=s.loseCommand||"");const c=document.getElementById("mazemaster_maze_win_message");c&&(c.value=s.winMessage||"");const d=document.getElementById("mazemaster_maze_main_minion");if(d){const e=J();d.innerHTML='<option value="">None</option>'+e.map((e=>{const n=V(e);return'<option value="'.concat(on(e),'" ').concat(s.mainMinion===e?"selected":"",">").concat(on((null==n?void 0:n.name)||e),"</option>")})).join("")}const p=document.getElementById("mazemaster_main_minion_settings");p&&(p.style.display=s.mainMinion?"block":"none");const u=document.getElementById("mazemaster_maze_intro_message");u&&(u.value=s.mainMinionIntroMessage||"");const g=document.getElementById("mazemaster_maze_random_chance");g&&(g.value=s.mainMinionRandomChance||15);const b=document.getElementById("mazemaster_maze_random_messages");b&&(b.value=(s.mainMinionRandomMessages||[]).join("\n"));const f=document.getElementById("mazemaster_maze_exit_type");f&&(f.value=s.mainMinionExitType||"messenger"),ln(s.mainMinionExitType||"messenger",s.mainMinionExitProfile);const h=document.getElementById("mazemaster_maze_loss_action");h&&(h.value=s.onBattlebarLoss||"continue");const v=document.querySelector(".mazemaster-maze-win-image-preview");v&&(s.winImage?v.innerHTML='<img id="maze_win_image_preview" src="'.concat(s.winImage,'" alt="Victory">'):v.innerHTML='<div id="maze_win_image_preview" class="no-image">No image</div>');const z=document.getElementById("mazemaster_maze_chest_percent");z&&(z.value=s.chestTilePercent||10);const y=document.getElementById("mazemaster_maze_locked_percent");y&&(y.value=s.chestLockedPercent||30);const _=document.getElementById("mazemaster_maze_locked_bonus");_&&(_.value=s.chestLockedBonusPercent||50);const x=document.getElementById("mazemaster_maze_mimic_percent");x&&(x.value=s.chestMimicPercent||15);const w=document.getElementById("mazemaster_maze_loot_min");w&&(w.value=s.chestLootMin||1);const M=document.getElementById("mazemaster_maze_loot_max");M&&(M.value=s.chestLootMax||2);const E=document.getElementById("mazemaster_maze_chest_key");E&&(E.value=s.chestKeyChance||30);const k=document.getElementById("mazemaster_maze_chest_pow");k&&(k.value=s.chestPowChance||50);const I=document.getElementById("mazemaster_maze_chest_stealth");I&&(I.value=s.chestStealthChance||0);const C=document.getElementById("mazemaster_maze_chest_grandpow");C&&(C.value=s.chestGrandpowChance||0);const P=document.getElementById("mazemaster_maze_locked_key");P&&(P.value=s.lockedChestKeyChance||40);const B=document.getElementById("mazemaster_maze_locked_pow");B&&(B.value=s.lockedChestPowChance||60);const L=document.getElementById("mazemaster_maze_locked_stealth");L&&(L.value=s.lockedChestStealthChance||30);const T=document.getElementById("mazemaster_maze_locked_grandpow");T&&(T.value=s.lockedChestGrandpowChance||5);let O=s.startingInventory||{};!(O.key||O.stealth||O.pow||O.grandpow)&&null!==(n=S[o])&&void 0!==n&&n.startingInventory&&(O=S[o].startingInventory,s.startingInventory=JSON.parse(JSON.stringify(O)),i());const D=document.getElementById("mazemaster_start_key");D&&(D.value=O.key||0);const N=document.getElementById("mazemaster_start_stealth");N&&(N.value=O.stealth||0);const A=document.getElementById("mazemaster_start_pow");A&&(A.value=O.pow||0);const j=document.getElementById("mazemaster_start_grandpow");j&&(j.value=O.grandpow||0);let R=s.minionEncounters||[],q=s.trapEncounters||[];0===R.length&&null!==(t=S[o])&&void 0!==t&&t.minionEncounters&&(R=S[o].minionEncounters,s.minionEncounters=JSON.parse(JSON.stringify(R)),i()),0===q.length&&null!==(a=S[o])&&void 0!==a&&a.trapEncounters&&(q=S[o].trapEncounters,s.trapEncounters=JSON.parse(JSON.stringify(q)),i()),function(e){const n=document.getElementById("mazemaster_maze_encounters_list");if(!n)return;const t=J();if(0===e.length)return void(n.innerHTML='<div class="mazemaster-empty-state" style="font-size: 0.85em;">No encounters. Minions will be randomly placed in the maze.</div>');n.innerHTML=e.map(((e,n)=>{V(e.minionId);return'\n            <div class="mazemaster-encounter-row" data-index="'.concat(n,'">\n                <select class="encounter-minion-select">\n                    ').concat(t.map((n=>{const t=V(n);return'<option value="'.concat(on(n),'" ').concat(e.minionId===n?"selected":"",">").concat(on((null==t?void 0:t.name)||n),"</option>")})).join(""),'\n                </select>\n                <input type="number" class="encounter-percent-input" min="1" max="100" value="').concat(e.percent||5,'" placeholder="%">\n                <span class="encounter-percent-label">%</span>\n                <button class="menu_button menu_button_icon encounter-remove-btn" title="Remove">\n                    <i class="fa-solid fa-trash"></i>\n                </button>\n            </div>\n        ')})).join(""),n.querySelectorAll(".mazemaster-encounter-row").forEach((e=>{var n,t,a;parseInt(e.dataset.index);null===(n=e.querySelector(".encounter-minion-select"))||void 0===n||n.addEventListener("change",(()=>{})),null===(t=e.querySelector(".encounter-percent-input"))||void 0===t||t.addEventListener("change",(()=>{})),null===(a=e.querySelector(".encounter-remove-btn"))||void 0===a||a.addEventListener("click",(()=>{e.remove()}))}))}(R),function(e){const n=document.getElementById("mazemaster_maze_traps_list");if(!n)return;const t=X();if(0===e.length)return void(n.innerHTML='<div class="mazemaster-empty-state" style="font-size: 0.85em;">No traps. Add traps to place trap tiles in the maze.</div>');n.innerHTML=e.map(((e,n)=>{Q(e.trapId);return'\n            <div class="mazemaster-encounter-row mazemaster-trap-encounter-row" data-index="'.concat(n,'">\n                <select class="trap-encounter-select">\n                    ').concat(t.map((n=>{const t=Q(n);return'<option value="'.concat(on(n),'" ').concat(e.trapId===n?"selected":"",">").concat(on((null==t?void 0:t.name)||n),"</option>")})).join(""),'\n                </select>\n                <input type="number" class="trap-encounter-percent-input" min="1" max="100" value="').concat(e.percent||5,'" placeholder="%">\n                <span class="encounter-percent-label">%</span>\n                <button class="menu_button menu_button_icon trap-encounter-remove-btn" title="Remove">\n                    <i class="fa-solid fa-trash"></i>\n                </button>\n            </div>\n        ')})).join(""),n.querySelectorAll(".mazemaster-trap-encounter-row").forEach((e=>{var n;null===(n=e.querySelector(".trap-encounter-remove-btn"))||void 0===n||n.addEventListener("click",(()=>{e.remove()}))}))}(q)}function ln(e,n){const t=document.getElementById("mazemaster_exit_profile_section"),a=document.getElementById("mazemaster_maze_exit_profile");if(!t||!a)return;if("messenger"===e)return void(t.style.display="none");t.style.display="block";let o=[];"battlebar"===e?(o=W(),0===o.length&&(o=Object.keys(w))):"prizewheel"===e&&(o=R(),0===o.length&&(o=Object.keys(x))),a.innerHTML='<option value="">Select...</option>'+o.map((e=>'<option value="'.concat(on(e),'" ').concat(e===n?"selected":"",">").concat(on(e),"</option>"))).join("")}function mn(){var e,n,t,a,o,i,s,r,l,m,c,d,p,u,g,b,f,h,v,z,y,_,x,w,M,E,k,I,C,S;const P=Y(null===(e=document.getElementById("mazemaster_maze_profile_select"))||void 0===e?void 0:e.value)||{},B=document.querySelectorAll("#mazemaster_maze_encounters_list .mazemaster-encounter-row"),L=[];B.forEach((e=>{var n,t;const a=null===(n=e.querySelector(".encounter-minion-select"))||void 0===n?void 0:n.value,o=parseInt(null===(t=e.querySelector(".encounter-percent-input"))||void 0===t?void 0:t.value)||5;a&&L.push({minionId:a,percent:o})}));const T=document.querySelectorAll("#mazemaster_maze_traps_list .mazemaster-trap-encounter-row"),O=[];T.forEach((e=>{var n,t;const a=null===(n=e.querySelector(".trap-encounter-select"))||void 0===n?void 0:n.value,o=parseInt(null===(t=e.querySelector(".trap-encounter-percent-input"))||void 0===t?void 0:t.value)||5;a&&O.push({trapId:a,percent:o})}));const D=((null===(n=document.getElementById("mazemaster_maze_random_messages"))||void 0===n?void 0:n.value)||"").split("\n").filter((e=>e.trim()));return{gridSize:parseInt(null===(t=document.getElementById("mazemaster_maze_size"))||void 0===t?void 0:t.value)||10,winCommand:(null===(a=document.getElementById("mazemaster_maze_win_cmd"))||void 0===a?void 0:a.value)||"",loseCommand:(null===(o=document.getElementById("mazemaster_maze_lose_cmd"))||void 0===o?void 0:o.value)||"",winMessage:(null===(i=document.getElementById("mazemaster_maze_win_message"))||void 0===i?void 0:i.value)||"",winImage:P.winImage||"",mainMinion:(null===(s=document.getElementById("mazemaster_maze_main_minion"))||void 0===s?void 0:s.value)||"",mainMinionIntroMessage:(null===(r=document.getElementById("mazemaster_maze_intro_message"))||void 0===r?void 0:r.value)||"",mainMinionRandomChance:parseInt(null===(l=document.getElementById("mazemaster_maze_random_chance"))||void 0===l?void 0:l.value)||15,mainMinionRandomMessages:D,mainMinionExitType:(null===(m=document.getElementById("mazemaster_maze_exit_type"))||void 0===m?void 0:m.value)||"messenger",mainMinionExitProfile:(null===(c=document.getElementById("mazemaster_maze_exit_profile"))||void 0===c?void 0:c.value)||"",minionEncounters:L,trapEncounters:O,onBattlebarLoss:(null===(d=document.getElementById("mazemaster_maze_loss_action"))||void 0===d?void 0:d.value)||"continue",chestTilePercent:parseInt(null===(p=document.getElementById("mazemaster_maze_chest_percent"))||void 0===p?void 0:p.value)||10,chestLockedPercent:parseInt(null===(u=document.getElementById("mazemaster_maze_locked_percent"))||void 0===u?void 0:u.value)||30,chestLockedBonusPercent:parseInt(null===(g=document.getElementById("mazemaster_maze_locked_bonus"))||void 0===g?void 0:g.value)||50,chestMimicPercent:parseInt(null===(b=document.getElementById("mazemaster_maze_mimic_percent"))||void 0===b?void 0:b.value)||15,chestLootMin:parseInt(null===(f=document.getElementById("mazemaster_maze_loot_min"))||void 0===f?void 0:f.value)||1,chestLootMax:parseInt(null===(h=document.getElementById("mazemaster_maze_loot_max"))||void 0===h?void 0:h.value)||2,chestKeyChance:parseInt(null===(v=document.getElementById("mazemaster_maze_chest_key"))||void 0===v?void 0:v.value)||30,chestPowChance:parseInt(null===(z=document.getElementById("mazemaster_maze_chest_pow"))||void 0===z?void 0:z.value)||50,chestStealthChance:parseInt(null===(y=document.getElementById("mazemaster_maze_chest_stealth"))||void 0===y?void 0:y.value)||0,chestGrandpowChance:parseInt(null===(_=document.getElementById("mazemaster_maze_chest_grandpow"))||void 0===_?void 0:_.value)||0,lockedChestKeyChance:parseInt(null===(x=document.getElementById("mazemaster_maze_locked_key"))||void 0===x?void 0:x.value)||40,lockedChestPowChance:parseInt(null===(w=document.getElementById("mazemaster_maze_locked_pow"))||void 0===w?void 0:w.value)||60,lockedChestStealthChance:parseInt(null===(M=document.getElementById("mazemaster_maze_locked_stealth"))||void 0===M?void 0:M.value)||30,lockedChestGrandpowChance:parseInt(null===(E=document.getElementById("mazemaster_maze_locked_grandpow"))||void 0===E?void 0:E.value)||5,startingInventory:{key:parseInt(null===(k=document.getElementById("mazemaster_start_key"))||void 0===k?void 0:k.value)||0,pow:parseInt(null===(I=document.getElementById("mazemaster_start_pow"))||void 0===I?void 0:I.value)||0,stealth:parseInt(null===(C=document.getElementById("mazemaster_start_stealth"))||void 0===C?void 0:C.value)||0,grandpow:parseInt(null===(S=document.getElementById("mazemaster_start_grandpow"))||void 0===S?void 0:S.value)||0},storyConfig:P.storyConfig||{mainStory:"",milestones:[]}}}async function cn(e,n){return new Promise(((t,a)=>{const o=new FileReader;o.onload=async o=>{try{const i=o.target.result.split(",")[1],s=e.name.split(".").pop().toLowerCase(),r=Date.now(),l="".concat(n,"_").concat(r),m=await fetch("/api/images/upload",{method:"POST",headers:d(),body:JSON.stringify({image:i,ch_name:"MazeMaster",filename:l,format:s})});if(m.ok)t("user/images/MazeMaster/".concat(l,".").concat(s));else{const e=await m.json().catch((()=>({})));a(new Error(e.error||"Upload failed"))}}catch(e){a(e)}},o.onerror=()=>a(new Error("Failed to read file")),o.readAsDataURL(e)}))}function dn(){const e=document.getElementById("mazemaster_minions_list");if(!e)return;const n=J();if(0===n.length)return void(e.innerHTML='<div class="mazemaster-empty-state">No minions. Add minions for use in the maze game.</div>');const t=W(),a=R();e.innerHTML=n.map((e=>{const n=V(e),o=n.type||"messenger",i=n.battlebarProfiles||[],s=n.wheelProfiles||[],r=n.messages||[],l=n.encounterScript||"",m=n.merchantItemCount||{min:1,max:3};return'\n            <div class="mazemaster-minion-card" data-id="'.concat(on(e),'">\n                <div class="minion-image">\n                    ').concat(n.imagePath?'<img src="'.concat(on(M(n.imagePath)),'" alt="').concat(on(n.name),'">'):"",'\n                </div>\n                <div class="minion-info">\n                    <div class="minion-row">\n                        <input type="text" class="minion-name-input" value="').concat(on(n.name),'" placeholder="Minion name">\n                        <select class="minion-type-select">\n                            <option value="messenger" ').concat("messenger"===o?"selected":"",'>Messenger</option>\n                            <option value="battlebar" ').concat("battlebar"===o?"selected":"",'>Battlebar</option>\n                            <option value="prizewheel" ').concat("prizewheel"===o?"selected":"",'>PrizeWheel</option>\n                            <option value="merchant" ').concat("merchant"===o?"selected":"",'>Merchant</option>\n                        </select>\n                    </div>\n                    <div class="minion-profiles battlebar-profiles" style="display: ').concat("battlebar"===o?"block":"none",';">\n                        <label>Battlebar Profiles:</label>\n                        <select multiple class="minion-battlebar-select">\n                            ').concat(t.map((e=>'<option value="'.concat(on(e),'" ').concat(i.includes(e)?"selected":"",">").concat(on(e),"</option>"))).join(""),'\n                        </select>\n                    </div>\n                    <div class="minion-profiles wheel-profiles" style="display: ').concat("prizewheel"===o?"block":"none",';">\n                        <label>Wheel Profiles:</label>\n                        <select multiple class="minion-wheel-select">\n                            ').concat(a.map((e=>'<option value="'.concat(on(e),'" ').concat(s.includes(e)?"selected":"",">").concat(on(e),"</option>"))).join(""),'\n                        </select>\n                    </div>\n                    <div class="minion-profiles messenger-messages" style="display: ').concat("messenger"===o?"block":"none",';">\n                        <label>Messages (one per line):</label>\n                        <textarea class="minion-messages-input" rows="2" placeholder="Hello traveler!&#10;Beware the maze...">').concat(on(r.join("\n")),'</textarea>\n                    </div>\n                    <div class="minion-profiles merchant-settings" style="display: ').concat("merchant"===o?"block":"none",';">\n                        <label>Trade Items Required:</label>\n                        <div class="merchant-range-row">\n                            <input type="number" class="merchant-min-input mazemaster-input-small" min="1" max="10" value="').concat(m.min,'">\n                            <span>to</span>\n                            <input type="number" class="merchant-max-input mazemaster-input-small" min="1" max="10" value="').concat(m.max,'">\n                            <span>items for 1 Grandpow</span>\n                        </div>\n                    </div>\n                    <div class="minion-encounter-script">\n                        <label>Encounter Script (STScript):</label>\n                        <textarea class="minion-script-input" rows="2" placeholder="/echo Custom action on encounter...">').concat(on(l),'</textarea>\n                    </div>\n                </div>\n                <button class="menu_button menu_button_icon minion-delete-btn" title="Delete Minion">\n                    <i class="fa-solid fa-trash"></i>\n                </button>\n            </div>\n        ')})).join(""),e.querySelectorAll(".mazemaster-minion-card").forEach((e=>{const n=e.dataset.id,t=e.querySelector(".minion-name-input");t&&t.addEventListener("change",(()=>{const e=V(n);e&&(e.name=t.value.trim()||"Unknown",K(n,e))}));const a=e.querySelector(".minion-type-select");a&&a.addEventListener("change",(()=>{const t=V(n);if(t){t.type=a.value,K(n,t);const o=e.querySelector(".battlebar-profiles"),i=e.querySelector(".wheel-profiles"),s=e.querySelector(".messenger-messages"),r=e.querySelector(".merchant-settings");o&&(o.style.display="battlebar"===t.type?"block":"none"),i&&(i.style.display="prizewheel"===t.type?"block":"none"),s&&(s.style.display="messenger"===t.type?"block":"none"),r&&(r.style.display="merchant"===t.type?"block":"none")}}));const o=e.querySelector(".minion-battlebar-select");o&&o.addEventListener("change",(()=>{const e=V(n);e&&(e.battlebarProfiles=Array.from(o.selectedOptions).map((e=>e.value)),K(n,e))}));const s=e.querySelector(".minion-wheel-select");s&&s.addEventListener("change",(()=>{const e=V(n);e&&(e.wheelProfiles=Array.from(s.selectedOptions).map((e=>e.value)),K(n,e))}));const r=e.querySelector(".minion-messages-input");r&&r.addEventListener("change",(()=>{const e=V(n);e&&(e.messages=r.value.split("\n").filter((e=>e.trim())),K(n,e))}));const l=e.querySelector(".merchant-min-input"),m=e.querySelector(".merchant-max-input");l&&l.addEventListener("change",(()=>{const e=V(n);e&&(e.merchantItemCount=e.merchantItemCount||{min:1,max:3},e.merchantItemCount.min=parseInt(l.value)||1,K(n,e))})),m&&m.addEventListener("change",(()=>{const e=V(n);e&&(e.merchantItemCount=e.merchantItemCount||{min:1,max:3},e.merchantItemCount.max=parseInt(m.value)||3,K(n,e))}));const c=e.querySelector(".minion-script-input");c&&c.addEventListener("change",(()=>{const e=V(n);e&&(e.encounterScript=c.value,K(n,e))}));const d=e.querySelector(".minion-delete-btn");d&&d.addEventListener("click",(async()=>{const e=V(n);var t;await p('Delete minion "'.concat((null==e?void 0:e.name)||n,'"?'),u.CONFIRM)&&(t=n,delete P.minions[t],i(),dn())}))}))}function pn(){const e=document.getElementById("mazemaster_traps_list");if(!e)return;const n=X();0!==n.length?(e.innerHTML=n.map((e=>{const n=Q(e);return'\n            <div class="mazemaster-trap-card" data-id="'.concat(on(e),'">\n                <div class="trap-image">\n                    ').concat(n.imagePath?'<img src="'.concat(on(M(n.imagePath)),'" alt="').concat(on(n.name),'">'):'<div class="trap-no-image"><i class="fa-solid fa-dungeon"></i></div>','\n                </div>\n                <div class="trap-info">\n                    <div class="trap-row">\n                        <input type="text" class="trap-name-input mazemaster-input" value="').concat(on(n.name),'" placeholder="Trap name">\n                    </div>\n                    <div class="trap-message-row">\n                        <label>Message:</label>\n                        <textarea class="trap-message-input" rows="2" placeholder="You triggered a trap!">').concat(on(n.message||""),'</textarea>\n                    </div>\n                    <div class="trap-script-row">\n                        <label>Script (STScript):</label>\n                        <textarea class="trap-script-input" rows="2" placeholder="/echo Trap triggered!">').concat(on(n.script||""),'</textarea>\n                    </div>\n                </div>\n                <button class="menu_button menu_button_icon trap-delete-btn" title="Delete Trap">\n                    <i class="fa-solid fa-trash"></i>\n                </button>\n            </div>\n        ')})).join(""),e.querySelectorAll(".mazemaster-trap-card").forEach((e=>{const n=e.dataset.id,t=e.querySelector(".trap-name-input");t&&t.addEventListener("change",(()=>{const e=Q(n);e&&(e.name=t.value.trim()||"Unknown Trap",$(n,e))}));const a=e.querySelector(".trap-message-input");a&&a.addEventListener("change",(()=>{const e=Q(n);e&&(e.message=a.value,$(n,e))}));const o=e.querySelector(".trap-script-input");o&&o.addEventListener("change",(()=>{const e=Q(n);e&&(e.script=o.value,$(n,e))}));const s=e.querySelector(".trap-delete-btn");s&&s.addEventListener("click",(async()=>{const e=Q(n);var t;await p('Delete trap "'.concat((null==e?void 0:e.name)||n,'"?'),u.CONFIRM)&&(t=n,delete P.traps[t],i(),pn())}))}))):e.innerHTML='<div class="mazemaster-empty-state">No traps. Add traps for use in maze profiles.</div>'}function un(){let e;console.log("[MazeMaster] initUI called");try{e=tn(),console.log("[MazeMaster] getPanelHtml succeeded")}catch(n){console.error("[MazeMaster] getPanelHtml FAILED:",n),e="<div>Error loading panel</div>"}const n=document.createElement("div");n.id="mazemaster-button",n.className="drawer",n.innerHTML='\n        <div class="drawer-toggle drawer-header">\n            <div class="drawer-icon fa-solid fa-dharmachakra fa-fw closedIcon" title="MazeMaster"></div>\n        </div>\n        <div id="mazemaster_drawer" class="drawer-content closedDrawer">\n            '.concat(e,"\n        </div>\n    ");const t=document.getElementById("extensions-settings-button");console.log("[MazeMaster] extensions-settings-button:",t),t?(t.after(n),console.log("[MazeMaster] Drawer inserted after extensions button")):console.error("[MazeMaster] extensions-settings-button NOT FOUND!");const a=n.querySelector(".drawer-toggle");if(a&&window.jQuery){const e=window.jQuery;e(a).on("click",(async function(){const n=e(this).find(".drawer-icon"),t=e(this).parent().find(".drawer-content");t.hasClass("openDrawer")||(e(".openDrawer:not(.pinnedOpen)").removeClass("openDrawer").addClass("closedDrawer"),e(".openIcon:not(.drawerPinnedOpen)").removeClass("openIcon").addClass("closedIcon")),n.toggleClass("openIcon closedIcon"),t.toggleClass("openDrawer closedDrawer")}))}vn(),an(),dn(),pn(),rn(),"battlebar"===P.activeGameConfig&&sn()}function gn(){var e;const n=document.getElementById("mazemaster_maze_chest_percent");n&&(n.value="15");const t=document.getElementById("mazemaster_maze_encounters_list"),a=(null==t?void 0:t.querySelectorAll(".mazemaster-encounter-row"))||[],o={messenger:10,prizewheel:6,battlebar:4,merchant:1};let i=0;const s=[];a.forEach((e=>{const n=e.getAttribute("data-minion-id");if(!n)return;const t=V(n),a=(null==t?void 0:t.type)||"battlebar",r=o[a]||4;i+=r,s.push({row:e,type:a,weight:r})}));i>0&&s.forEach((e=>{let{row:n,weight:t}=e;const a=Math.round(t/i*60),o=n.querySelector(".encounter-percent-input");o&&(o.value=a)}));const r=document.getElementById("mazemaster_maze_traps_list"),l=(null==r?void 0:r.querySelectorAll(".mazemaster-encounter-row"))||[];if(l.length>0){const e=Math.floor(5/l.length);l.forEach((n=>{const t=n.querySelector(".encounter-percent-input");t&&(t.value=e||1)}))}const m=null===(e=document.getElementById("mazemaster_maze_profile_select"))||void 0===e?void 0:e.value;if(m){U(m,mn()),loadMazeProfileSettings()}console.log("[MazeMaster] Intelligent Distribute applied: Chests 15%, Traps 5%, Minions distributed")}function bn(e){var t;const a=null===(t=P.savedMazes)||void 0===t?void 0:t[e];if(!a)return console.warn('[MazeMaster] No saved game for "'.concat(e,'"')),!1;const o=Y(e);if(!o)return console.error('[MazeMaster] Profile "'.concat(e,'" no longer exists')),!1;const i=a.grid.map((e=>e.map((e=>({walls:e.walls,visited:e.visited,minion:e.minion,trap:e.trap,chest:e.chest})))));let s={name:"The Maze",imagePath:"",message:"Find your way to the exit..."};const r=o.mainMinion?V(o.mainMinion):null;return r&&(s={name:r.name,imagePath:r.imagePath,message:"Continuing your journey..."}),T={isOpen:!0,profile:o,profileName:e,grid:i,size:a.size,playerX:a.playerX,playerY:a.playerY,exitX:a.exitX,exitY:a.exitY,visited:new Set(a.visited),isVictory:!1,currentMinion:s,isPaused:!1,pendingEncounter:null,exitEncounterDone:a.exitEncounterDone,pendingConfirmation:null,pendingChest:null,inventory:n({},a.inventory),shownMilestones:new Set(a.shownMilestones||[])},Se(),Be(),Le(),Ae(),document.addEventListener("keydown",Oe,{capture:!0}),console.log('[MazeMaster] Loaded saved maze "'.concat(e,'"')),!0}function fn(e){var n;return!(null===(n=P.savedMazes)||void 0===n||!n[e])&&(delete P.savedMazes[e],i(),console.log('[MazeMaster] Deleted saved maze "'.concat(e,'"')),!0)}function hn(){const e=["mazemaster_saved_games_list","mazemaster_game_tab_saves"],n=Object.keys(P.savedMazes||{});for(const t of e){const e=document.getElementById(t);e&&(0!==n.length?(e.innerHTML=n.map((e=>{const n=P.savedMazes[e],t=new Date(n.timestamp),a=n.visited?Math.round(n.visited.length/(n.size*n.size)*100):0;return'\n                <div class="mazemaster-saved-game" data-profile="'.concat(on(e),'">\n                    <div class="mazemaster-saved-game-info">\n                        <div class="mazemaster-saved-game-name">').concat(on(e),'</div>\n                        <div class="mazemaster-saved-game-details">').concat(a,"% explored - ").concat(t.toLocaleDateString(),'</div>\n                    </div>\n                    <div class="mazemaster-saved-game-actions">\n                        <button class="menu_button menu_button_icon saved-game-load" title="Resume">\n                            <i class="fa-solid fa-play"></i>\n                        </button>\n                        <button class="menu_button menu_button_icon saved-game-delete" title="Delete">\n                            <i class="fa-solid fa-trash"></i>\n                        </button>\n                    </div>\n                </div>\n            ')})).join(""),e.querySelectorAll(".mazemaster-saved-game").forEach((e=>{var n,t;const a=e.dataset.profile;null===(n=e.querySelector(".saved-game-load"))||void 0===n||n.addEventListener("click",(()=>{bn(a)})),null===(t=e.querySelector(".saved-game-delete"))||void 0===t||t.addEventListener("click",(async()=>{await p('Delete saved game "'.concat(a,'"?'),u.CONFIRM)&&(fn(a),hn())}))}))):e.innerHTML='<div class="mazemaster-no-saves">No saved games</div>')}}function vn(){const e=document.getElementById("mazemaster_profile_select");e&&e.addEventListener("change",(e=>{P.currentProfile=e.target.value,i(),function(){var e;const n=q(null===(e=document.getElementById("mazemaster_profile_select"))||void 0===e?void 0:e.value),t=document.getElementById("mazemaster_randomize");t&&(t.checked=(null==n?void 0:n.randomize)||!1);const a=document.getElementById("mazemaster_difficulty");a&&(a.value=(null==n?void 0:n.difficulty)||1)}(),an()}));const n=document.getElementById("mazemaster_new_profile_btn");n&&n.addEventListener("click",(async e=>{e.preventDefault(),e.stopPropagation();const n=await p("Enter new wheel profile name:",u.INPUT,"");if(n&&n.trim()){const e=n.trim();P.profiles[e]?await p('Profile "'.concat(e,'" already exists.'),u.TEXT):(P.profiles[e]={segments:[],randomize:!1,difficulty:1},P.currentProfile=e,i(),zn())}}));const t=document.getElementById("mazemaster_delete_profile_btn");t&&t.addEventListener("click",(async()=>{var e;const n=null===(e=document.getElementById("mazemaster_profile_select"))||void 0===e?void 0:e.value;if(n){await p('Delete wheel profile "'.concat(n,'"?'),u.CONFIRM)&&(!function(e){if(delete P.profiles[e],P.currentProfile===e){const e=R();P.currentProfile=e[0]||"default"}i()}(n),zn())}}));const a=document.getElementById("mazemaster_export_btn");a&&a.addEventListener("click",(()=>{var e;const n=null===(e=document.getElementById("mazemaster_profile_select"))||void 0===e?void 0:e.value;n?function(e){const n=q(e);if(!n)return void alert('Profile "'.concat(e,'" not found'));const t={name:e,profile:n,exportedAt:(new Date).toISOString(),version:"1.0"},a=JSON.stringify(t,null,2),o=new Blob([a],{type:"application/json"}),i=URL.createObjectURL(o),s=document.createElement("a");s.href=i,s.download="mazemaster-".concat(e,".json"),document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(i),console.log('[MazeMaster] Exported profile "'.concat(e,'"'))}(n):alert("No profile selected to export")}));const o=document.getElementById("mazemaster_import_btn"),s=document.getElementById("mazemaster_import_file");o&&s&&(o.addEventListener("click",(()=>{s.click()})),s.addEventListener("change",(async e=>{var n;const t=null===(n=e.target.files)||void 0===n?void 0:n[0];if(t){try{const e=await function(e){return new Promise(((n,t)=>{const a=new FileReader;a.onload=e=>{try{const a=JSON.parse(e.target.result);if(!a.profile||!a.name)return void t(new Error("Invalid profile format: missing name or profile data"));let o=a.name;if(P.profiles[o]){const e=prompt('Profile "'.concat(o,'" already exists. Enter a new name:'),"".concat(o,"_imported"));if(!e||!e.trim())return void t(new Error("Import cancelled"));o=e.trim()}const s=a.profile;s.segments&&Array.isArray(s.segments)||(s.segments=[]),"boolean"!=typeof s.randomize&&(s.randomize=!1),("number"!=typeof s.difficulty||s.difficulty<1||s.difficulty>5)&&(s.difficulty=1),P.profiles[o]=s,P.currentProfile=o,i(),console.log('[MazeMaster] Imported profile "'.concat(o,'":'),s),n(o)}catch(e){t(new Error("Failed to parse JSON: ".concat(e.message)))}},a.onerror=()=>t(new Error("Failed to read file")),a.readAsText(e)}))}(t);alert('Profile "'.concat(e,'" imported successfully!')),zn()}catch(e){alert("Import failed: ".concat(e.message))}s.value=""}})));const r=document.getElementById("mazemaster_add_segment_btn");r&&r.addEventListener("click",(()=>{const e=document.getElementById("mazemaster_segments_list");if(!e)return;const n=e.querySelector(".mazemaster-empty-state");n&&n.remove();const t=e.querySelectorAll(".mazemaster-segment-item").length,a=document.createElement("div");a.className="mazemaster-segment-item",a.dataset.index=t,a.innerHTML='\n                <div class="mazemaster-segment-row">\n                    <div class="mazemaster-segment-field small">\n                        <label>Trigger</label>\n                        <input type="text" class="seg-trigger" value="com'.concat(t+1,'" placeholder="com1">\n                    </div>\n                    <div class="mazemaster-segment-field">\n                        <label>Display Text</label>\n                        <input type="text" class="seg-text" value="" placeholder="Prize name">\n                    </div>\n                    <div class="mazemaster-segment-field small">\n                        <label>Size</label>\n                        <select class="seg-size">\n                            ').concat(z.map((e=>'<option value="'.concat(e,'" ').concat("fraction"===e?"selected":"",">").concat(e,"</option>"))).join(""),'\n                        </select>\n                    </div>\n                    <button class="menu_button menu_button_icon mazemaster-segment-delete" title="Delete">\n                        <i class="fa-solid fa-trash"></i>\n                    </button>\n                </div>\n                <div class="mazemaster-segment-row">\n                    <div class="mazemaster-segment-field">\n                        <label>STScript Command</label>\n                        <textarea class="seg-command" placeholder="/echo You won!"></textarea>\n                    </div>\n                    <div class="mazemaster-segment-field tiny">\n                        <label>&nbsp;</label>\n                        <label class="mazemaster-segment-checkbox">\n                            <input type="checkbox" class="seg-respin">\n                            Respin\n                        </label>\n                    </div>\n                </div>\n            '),a.querySelector(".mazemaster-segment-delete").addEventListener("click",(()=>{a.remove()})),e.appendChild(a)}));const l=document.getElementById("mazemaster_save_btn");l&&l.addEventListener("click",(()=>{var e,n,t;const a=null===(e=document.getElementById("mazemaster_profile_select"))||void 0===e?void 0:e.value;if(!a)return void alert("Please create a profile first");const o=function(){const e=document.querySelectorAll(".mazemaster-segment-item"),n=[];return e.forEach((e=>{const t=e.querySelector(".seg-trigger").value.trim(),a=e.querySelector(".seg-text").value.trim(),o=e.querySelector(".seg-command").value.trim(),i=e.querySelector(".seg-size").value,s=e.querySelector(".seg-respin").checked;(t||a)&&n.push({trigger:t,text:a,command:o,size:i,respin:s})})),n}(),s=(null===(n=document.getElementById("mazemaster_randomize"))||void 0===n?void 0:n.checked)||!1,r=parseInt(null===(t=document.getElementById("mazemaster_difficulty"))||void 0===t?void 0:t.value)||1;!function(e,n){let t=arguments.length>2&&void 0!==arguments[2]&&arguments[2],a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;P.profiles[e]={segments:n,randomize:t,difficulty:a},i(),console.log("[MazeMaster] Profile saved:",e,P.profiles[e])}(a,o,s,r),console.log('[MazeMaster] Saved profile "'.concat(a,'":'),{segments:o,randomize:s,difficulty:r}),alert('Profile "'.concat(a,'" saved!'))}));const m=document.getElementById("mazemaster_preview_wheel_btn");m&&m.addEventListener("click",(()=>{var e;const n=null===(e=document.getElementById("mazemaster_profile_select"))||void 0===e?void 0:e.value;if(!n)return void alert("Please select or create a wheel profile first");const t=Z(n);if(t.error)return void alert("Error: ".concat(t.error));const a=ee();a.valid?te():alert("Error: ".concat(a.error))}));const c=document.getElementById("mazemaster_preview_battlebar_btn");c&&c.addEventListener("click",(()=>{var e;const n=null===(e=document.getElementById("mazemaster_bb_profile_select"))||void 0===e?void 0:e.value;if(!n)return void alert("Please select or create a battlebar profile first");const t=ie(n);t.error&&alert("Error: ".concat(t.error))}));const g=document.getElementById("mazemaster_show_wheel"),f=document.getElementById("mazemaster_show_battlebar"),h=document.getElementById("mazemaster_show_maze"),v=document.getElementById("mazemaster_show_minions"),y=document.getElementById("mazemaster_show_traps"),_=document.getElementById("mazemaster_wheel_config"),x=document.getElementById("mazemaster_battlebar_config"),w=document.getElementById("mazemaster_maze_config"),M=document.getElementById("mazemaster_minions_config"),E=document.getElementById("mazemaster_traps_config");function k(e){P.activeGameConfig=e,i(),null==g||g.classList.toggle("active","wheel"===e),null==f||f.classList.toggle("active","battlebar"===e),null==h||h.classList.toggle("active","maze"===e),null==v||v.classList.toggle("active","minions"===e),null==y||y.classList.toggle("active","traps"===e),_&&(_.style.display="wheel"===e?"block":"none"),x&&(x.style.display="battlebar"===e?"block":"none"),w&&(w.style.display="maze"===e?"block":"none"),M&&(M.style.display="minions"===e?"block":"none"),E&&(E.style.display="traps"===e?"block":"none"),"battlebar"===e&&sn(),"minions"===e&&dn(),"traps"===e&&pn()}g&&g.addEventListener("click",(()=>k("wheel"))),f&&f.addEventListener("click",(()=>k("battlebar"))),h&&h.addEventListener("click",(()=>k("maze"))),v&&v.addEventListener("click",(()=>k("minions"))),y&&y.addEventListener("click",(()=>k("traps")));const I=document.querySelectorAll(".mazemaster-tab"),C=document.querySelectorAll(".mazemaster-tab-content");I.forEach((e=>{e.addEventListener("click",(()=>{const n=e.dataset.tab;I.forEach((n=>n.classList.toggle("active",n===e))),C.forEach((e=>{const t=e.id==="mazemaster-tab-".concat(n);e.classList.toggle("active",t)}))}))}));const S=document.getElementById("mazemaster_play_maze");S&&S.addEventListener("click",(()=>{const e=document.getElementById("mazemaster_play_profile");Ce((null==e?void 0:e.value)||P.currentMazeProfile||"default")})),function(){const e=document.getElementById("mazemaster_llm_preset");if(e){e.innerHTML='<option value="">(Use Current)</option>';try{if("function"==typeof b){const n=b();if(n&&"function"==typeof n.getAllPresets){const t=n.getAllPresets();t.forEach((n=>{const t=document.createElement("option");t.value=n,t.textContent=n,n===P.llmPreset&&(t.selected=!0),e.appendChild(t)})),console.log("[MazeMaster] Populated LLM preset dropdown with ".concat(t.length," presets"))}}}catch(e){console.warn("[MazeMaster] Could not populate LLM presets:",e)}}}();const B=document.getElementById("mazemaster_llm_preset");B&&B.addEventListener("change",(e=>{P.llmPreset=e.target.value,i()}));const L=document.getElementById("mazemaster_llm_enabled");L&&L.addEventListener("change",(e=>{P.llmEnabled=e.target.checked,i()}));const T=document.getElementById("mazemaster_bb_profile_select");T&&T.addEventListener("change",(e=>{P.currentBattlebarProfile=e.target.value,i(),function(){var e;const n=H(null===(e=document.getElementById("mazemaster_bb_profile_select"))||void 0===e?void 0:e.value)||{},t=document.getElementById("mazemaster_bb_difficulty");t&&(t.value=n.difficulty||3);const a=document.getElementById("mazemaster_bb_hits");a&&(a.value=n.hitsToWin||5);const o=document.getElementById("mazemaster_bb_misses");o&&(o.value=n.missesToLose||3);const i=document.getElementById("mazemaster_bb_hit_cmd");i&&(i.value=n.hitCommand||"");const s=document.getElementById("mazemaster_bb_miss_cmd");s&&(s.value=n.missCommand||"");const r=document.getElementById("mazemaster_bb_win_cmd");r&&(r.value=n.winCommand||"");const l=document.getElementById("mazemaster_bb_lose_cmd");l&&(l.value=n.loseCommand||"");const m=document.getElementById("mazemaster_bb_main_title");m&&(m.value=n.mainTitle||"")}(),sn()}));const O=document.getElementById("mazemaster_bb_new_profile_btn");O&&O.addEventListener("click",(async e=>{e.preventDefault(),e.stopPropagation();const n=await p("Enter new battlebar profile name:",u.INPUT,"");if(n&&n.trim()){const e=n.trim();P.battlebarProfiles[e]?await p('Battlebar profile "'.concat(e,'" already exists.'),u.TEXT):(G(e,{}),P.currentBattlebarProfile=e,i(),zn(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_battlebar"))||void 0===e||e.click()}),100))}}));const D=document.getElementById("mazemaster_bb_delete_profile_btn");D&&D.addEventListener("click",(async()=>{var e;const n=null===(e=document.getElementById("mazemaster_bb_profile_select"))||void 0===e?void 0:e.value;if(n){await p('Delete battlebar profile "'.concat(n,'"?'),u.CONFIRM)&&(!function(e){if(delete P.battlebarProfiles[e],P.currentBattlebarProfile===e){const e=W();P.currentBattlebarProfile=e[0]||"default"}i()}(n),zn(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_battlebar"))||void 0===e||e.click()}),100))}}));const N=document.getElementById("mazemaster_bb_export_btn");N&&N.addEventListener("click",(()=>{var e;const n=null===(e=document.getElementById("mazemaster_bb_profile_select"))||void 0===e?void 0:e.value;n?function(e){const n=H(e);if(!n)return void alert('Battlebar profile "'.concat(e,'" not found'));const t={name:e,type:"battlebar",profile:n,exportedAt:(new Date).toISOString(),version:"1.0"},a=JSON.stringify(t,null,2),o=new Blob([a],{type:"application/json"}),i=URL.createObjectURL(o),s=document.createElement("a");s.href=i,s.download="mazemaster-battlebar-".concat(e,".json"),document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(i),console.log('[MazeMaster] Exported battlebar profile "'.concat(e,'"'))}(n):alert("No profile selected to export")}));const A=document.getElementById("mazemaster_bb_import_btn"),j=document.getElementById("mazemaster_bb_import_file");A&&j&&(A.addEventListener("click",(()=>{j.click()})),j.addEventListener("change",(async e=>{var n;const t=null===(n=e.target.files)||void 0===n?void 0:n[0];if(t){try{var a;const e=await function(e){return new Promise(((n,t)=>{const a=new FileReader;a.onload=e=>{try{const a=JSON.parse(e.target.result);if(!a.profile||!a.name)return void t(new Error("Invalid profile format: missing name or profile data"));let o=a.name;if(P.battlebarProfiles[o]){const e=prompt('Battlebar profile "'.concat(o,'" already exists. Enter a new name:'),"".concat(o,"_imported"));if(!e||!e.trim())return void t(new Error("Import cancelled"));o=e.trim()}G(o,a.profile),P.currentBattlebarProfile=o,i(),console.log('[MazeMaster] Imported battlebar profile "'.concat(o,'":'),a.profile),n(o)}catch(e){t(new Error("Failed to parse JSON: ".concat(e.message)))}},a.onerror=()=>t(new Error("Failed to read file")),a.readAsText(e)}))}(t);alert('Battlebar profile "'.concat(e,'" imported successfully!')),zn(),null===(a=document.getElementById("mazemaster_show_battlebar"))||void 0===a||a.click()}catch(e){alert("Import failed: ".concat(e.message))}j.value=""}})));const J=document.getElementById("mazemaster_bb_save_btn");J&&J.addEventListener("click",(()=>{var e;const n=null===(e=document.getElementById("mazemaster_bb_profile_select"))||void 0===e?void 0:e.value;if(!n)return void alert("Please create a battlebar profile first");G(n,function(){var e,n,t,a,o,i,s,r,l,m,c,d,p,u,g;const b=H(null===(e=document.getElementById("mazemaster_bb_profile_select"))||void 0===e?void 0:e.value)||{};return{difficulty:parseInt(null===(n=document.getElementById("mazemaster_bb_difficulty"))||void 0===n?void 0:n.value)||3,hitsToWin:parseInt(null===(t=document.getElementById("mazemaster_bb_hits"))||void 0===t?void 0:t.value)||5,missesToLose:parseInt(null===(a=document.getElementById("mazemaster_bb_misses"))||void 0===a?void 0:a.value)||3,mainTitle:(null===(o=document.getElementById("mazemaster_bb_main_title"))||void 0===o?void 0:o.value)||"",hitCommand:(null===(i=document.getElementById("mazemaster_bb_hit_cmd"))||void 0===i?void 0:i.value)||"",missCommand:(null===(s=document.getElementById("mazemaster_bb_miss_cmd"))||void 0===s?void 0:s.value)||"",winCommand:(null===(r=document.getElementById("mazemaster_bb_win_cmd"))||void 0===r?void 0:r.value)||"",loseCommand:(null===(l=document.getElementById("mazemaster_bb_lose_cmd"))||void 0===l?void 0:l.value)||"",images:b.images||[],keyDropChance:null!==(m=parseInt(null===(c=document.getElementById("mazemaster_bb_key_drop"))||void 0===c?void 0:c.value))&&void 0!==m?m:40,powDropChance:null!==(d=parseInt(null===(p=document.getElementById("mazemaster_bb_pow_drop"))||void 0===p?void 0:p.value))&&void 0!==d?d:20,stealthDropChance:null!==(u=parseInt(null===(g=document.getElementById("mazemaster_bb_stealth_drop"))||void 0===g?void 0:g.value))&&void 0!==u?u:10}}()),alert('Battlebar profile "'.concat(n,'" saved!'))}));const V=document.getElementById("mazemaster_bb_add_image_btn"),ne=document.getElementById("mazemaster_bb_image_file");V&&ne&&(V.addEventListener("click",(()=>{ne.click()})),ne.addEventListener("change",(async e=>{var n,t;const a=null===(n=e.target.files)||void 0===n?void 0:n[0];if(!a)return;const o=null===(t=document.getElementById("mazemaster_bb_profile_select"))||void 0===t?void 0:t.value;if(!o)return alert("Please create a profile first"),void(ne.value="");try{const e=await async function(e,n){return new Promise(((t,a)=>{const o=new FileReader;o.onload=async o=>{try{const i=o.target.result.split(",")[1],s=e.name.split(".").pop().toLowerCase(),r=Date.now(),l="battlebar_".concat(n,"_").concat(r),m=await fetch("/api/images/upload",{method:"POST",headers:d(),body:JSON.stringify({image:i,ch_name:"MazeMaster",filename:l,format:s})});if(m.ok)t("user/images/MazeMaster/".concat(l,".").concat(s));else{const e=await m.json().catch((()=>({})));a(new Error(e.error||"Upload failed"))}}catch(e){a(e)}},o.onerror=()=>a(new Error("Failed to read file")),o.readAsDataURL(e)}))}(a,o),n=H(o)||{},t=n.images||[];t.push({path:e,name:a.name}),n.images=t,G(o,n),sn()}catch(e){alert("Image upload failed: ".concat(e.message))}ne.value=""})));const ae=document.getElementById("mazemaster_maze_profile_select");ae&&ae.addEventListener("change",(e=>{P.currentMazeProfile=e.target.value,i(),rn()}));const oe=document.getElementById("mazemaster_maze_new_profile_btn");oe&&oe.addEventListener("click",(async e=>{e.preventDefault(),e.stopPropagation();const n=await p("Enter new maze profile name:",u.INPUT,"");if(n&&n.trim()){const e=n.trim();P.mazeProfiles[e]?await p('Maze profile "'.concat(e,'" already exists.'),u.TEXT):(U(e,{gridSize:10}),P.currentMazeProfile=e,i(),zn(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_maze"))||void 0===e||e.click()}),100))}}));const se=document.getElementById("mazemaster_maze_delete_profile_btn");se&&se.addEventListener("click",(async()=>{var e;const n=null===(e=document.getElementById("mazemaster_maze_profile_select"))||void 0===e?void 0:e.value;if(n){await p('Delete maze profile "'.concat(n,'"?'),u.CONFIRM)&&(!function(e){if(delete P.mazeProfiles[e],P.currentMazeProfile===e){const e=F();P.currentMazeProfile=e[0]||"default"}i()}(n),zn(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_maze"))||void 0===e||e.click()}),100))}}));const re=document.getElementById("mazemaster_maze_save_btn");re&&re.addEventListener("click",(()=>{var e;const n=null===(e=document.getElementById("mazemaster_maze_profile_select"))||void 0===e?void 0:e.value;if(!n)return void alert("Please create a maze profile first");U(n,mn()),alert('Maze profile "'.concat(n,'" saved!'))}));const le=document.getElementById("mazemaster_maze_story_btn");le&&le.addEventListener("click",(()=>{!async function(){var e,n,t,a;const o=null===(e=document.getElementById("mazemaster_maze_profile_select"))||void 0===e?void 0:e.value;if(!o)return void alert("Please create a maze profile first");const i=Y(o)||{},s=i.storyConfig||{mainStory:"",milestones:[]},r='\n        <div id="mazemaster_story_modal" class="mazemaster-story-modal">\n            <div class="mazemaster-story-modal-content">\n                <h3><i class="fa-solid fa-book"></i> Story Milestones</h3>\n\n                <div class="mazemaster-section">\n                    <label class="mazemaster-label">Main Story</label>\n                    <textarea id="story_main_text" class="mazemaster-story-textarea" rows="4"\n                        placeholder="The maze stretches before you, filled with danger and mystery...">'.concat(on(s.mainStory||""),'</textarea>\n                </div>\n\n                <div class="mazemaster-section">\n                    <label class="mazemaster-label">Milestones</label>\n                    <div id="story_milestones_list" class="mazemaster-milestones-list">\n                        \x3c!-- Milestones rendered here --\x3e\n                    </div>\n                    <button id="story_add_milestone_btn" class="menu_button mazemaster-add-btn">\n                        <i class="fa-solid fa-plus"></i> Add Milestone\n                    </button>\n                </div>\n\n                <div class="mazemaster-story-modal-buttons">\n                    <button id="story_save_btn" class="menu_button menu_button_primary">\n                        <i class="fa-solid fa-save"></i> Save\n                    </button>\n                    <button id="story_cancel_btn" class="menu_button">\n                        Cancel\n                    </button>\n                </div>\n            </div>\n        </div>\n    '),l=document.createElement("div");l.innerHTML=r,document.body.appendChild(l.firstElementChild);const m=document.getElementById("mazemaster_story_modal"),c=document.getElementById("story_milestones_list");function d(){0!==s.milestones.length?(c.innerHTML=s.milestones.map(((e,n)=>'\n            <div class="mazemaster-milestone-row" data-index="'.concat(n,'">\n                <div class="milestone-percent">\n                    <input type="number" class="milestone-percent-input" min="1" max="99" value="').concat(e.percent||25,'" placeholder="%">\n                    <span>%</span>\n                </div>\n                <textarea class="milestone-text-input" rows="2" placeholder="Story update at this point...">').concat(on(e.storyUpdate||""),'</textarea>\n                <button class="menu_button menu_button_icon milestone-remove-btn" title="Remove">\n                    <i class="fa-solid fa-trash"></i>\n                </button>\n            </div>\n        '))).join(""),c.querySelectorAll(".milestone-remove-btn").forEach((e=>{e.addEventListener("click",(e=>{const n=e.target.closest(".mazemaster-milestone-row"),t=parseInt(n.dataset.index);s.milestones.splice(t,1),d()}))}))):c.innerHTML='<div class="mazemaster-empty-state">No milestones. Add milestones to show story updates at specific progress points.</div>'}d(),null===(n=document.getElementById("story_add_milestone_btn"))||void 0===n||n.addEventListener("click",(()=>{s.milestones.push({percent:50,storyUpdate:""}),d()})),null===(t=document.getElementById("story_save_btn"))||void 0===t||t.addEventListener("click",(()=>{var e;s.mainStory=(null===(e=document.getElementById("story_main_text"))||void 0===e?void 0:e.value)||"";const n=c.querySelectorAll(".mazemaster-milestone-row");s.milestones=[],n.forEach((e=>{var n,t;const a=parseInt(null===(n=e.querySelector(".milestone-percent-input"))||void 0===n?void 0:n.value)||25,o=(null===(t=e.querySelector(".milestone-text-input"))||void 0===t?void 0:t.value)||"";o.trim()&&s.milestones.push({percent:a,storyUpdate:o})})),s.milestones.sort(((e,n)=>e.percent-n.percent)),i.storyConfig=s,U(o,i),m.remove(),alert("Story milestones saved!")})),null===(a=document.getElementById("story_cancel_btn"))||void 0===a||a.addEventListener("click",(()=>{m.remove()})),m.addEventListener("click",(e=>{e.target===m&&m.remove()}))}()})),document.querySelectorAll(".mazemaster-collapsible-header").forEach((e=>{e.addEventListener("click",(()=>{const n=e.getAttribute("data-target"),t=document.getElementById(n),a=e.closest(".mazemaster-collapsible");if(t){const e="none"!==t.style.display;t.style.display=e?"none":"block",null==a||a.classList.toggle("expanded",!e)}}))})),hn();const me=document.getElementById("mazemaster_intelligent_distribute");me&&me.addEventListener("click",gn);const ce=document.getElementById("mazemaster_maze_win_image_btn"),de=document.getElementById("mazemaster_maze_win_image_file");ce&&de&&(ce.addEventListener("click",(()=>{de.click()})),de.addEventListener("change",(async e=>{var n,t;const a=null===(n=e.target.files)||void 0===n?void 0:n[0];if(!a)return;const o=null===(t=document.getElementById("mazemaster_maze_profile_select"))||void 0===t?void 0:t.value;if(!o)return alert("Please create a profile first"),void(de.value="");try{const e=await cn(a,"maze_win_".concat(o)),n=Y(o)||{};n.winImage=e,U(o,n);const t=document.querySelector(".mazemaster-maze-win-image-preview");t&&(t.innerHTML='<img id="maze_win_image_preview" src="'.concat(e,'" alt="Victory">'))}catch(e){alert("Image upload failed: ".concat(e.message))}de.value=""})));const pe=document.getElementById("mazemaster_maze_main_minion");pe&&pe.addEventListener("change",(e=>{const n=document.getElementById("mazemaster_main_minion_settings");n&&(n.style.display=e.target.value?"":"none")}));const ue=document.getElementById("mazemaster_maze_exit_type");ue&&ue.addEventListener("change",(()=>{ln(ue.value,"")}));const ge=document.getElementById("mazemaster_add_encounter_btn");ge&&ge.addEventListener("click",(()=>{const e=document.getElementById("mazemaster_maze_encounters_list");if(!e)return;const n=Object.keys(P.minions||{}).map((e=>{const n=P.minions[e];return'<option value="'.concat(e,'">').concat(n.name||e,"</option>")})).join(""),t=document.createElement("div");t.className="mazemaster-encounter-row",t.innerHTML='\n                <select class="encounter-minion-select">\n                    <option value="">Select Minion</option>\n                    '.concat(n,'\n                </select>\n                <input type="number" class="encounter-percent-input" min="1" max="100" value="5" placeholder="%">\n                <span class="encounter-percent-label">%</span>\n                <button class="encounter-remove-btn menu_button"><i class="fa-solid fa-trash"></i></button>\n            '),t.querySelector(".encounter-remove-btn").addEventListener("click",(()=>{t.remove()})),e.appendChild(t)}));const be=document.getElementById("mazemaster_add_trap_encounter_btn");be&&be.addEventListener("click",(()=>{const e=document.getElementById("mazemaster_maze_traps_list");if(!e)return;const n=X().map((e=>{const n=Q(e);return'<option value="'.concat(on(e),'">').concat(on((null==n?void 0:n.name)||e),"</option>")})).join("");if(!n)return void alert("No traps available. Create traps in the Traps tab first.");const t=document.createElement("div");t.className="mazemaster-encounter-row mazemaster-trap-encounter-row",t.innerHTML='\n                <select class="trap-encounter-select">\n                    <option value="">Select Trap</option>\n                    '.concat(n,'\n                </select>\n                <input type="number" class="trap-encounter-percent-input" min="1" max="100" value="5" placeholder="%">\n                <span class="encounter-percent-label">%</span>\n                <button class="trap-encounter-remove-btn menu_button"><i class="fa-solid fa-trash"></i></button>\n            '),t.querySelector(".trap-encounter-remove-btn").addEventListener("click",(()=>{t.remove()})),e.appendChild(t)}));const fe=document.getElementById("mazemaster_add_minion_btn"),he=document.getElementById("mazemaster_minion_image_file");fe&&he&&(fe.addEventListener("click",(()=>{he.click()})),he.addEventListener("change",(async e=>{var n;const t=null===(n=e.target.files)||void 0===n?void 0:n[0];if(t){try{const e="minion_".concat(Date.now()),n=await cn(t,e),a=await p("Enter minion name:",u.INPUT,"New Minion");a&&a.trim()&&(K(e,{name:a.trim(),imagePath:n}),dn())}catch(e){alert("Image upload failed: ".concat(e.message))}he.value=""}})));const ve=document.getElementById("mazemaster_minion_profile_save_btn");ve&&ve.addEventListener("click",(async()=>{const e=await p("Enter profile name:",u.INPUT,"My Minions");if(e&&e.trim()){const n=e.trim();P.minionProfiles[n]=JSON.parse(JSON.stringify(P.minions||{})),i(),alert('Minion profile "'.concat(n,'" saved!')),zn(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_minions"))||void 0===e||e.click()}),100)}}));const ze=document.getElementById("mazemaster_minion_profile_load_btn");ze&&ze.addEventListener("click",(async()=>{const e=document.getElementById("mazemaster_minion_profile_select"),n=null==e?void 0:e.value;if(!n)return void alert("Select a profile to load");await p('Load minion profile "'.concat(n,'"? This will replace your current minions.'),u.CONFIRM)&&(P.minions=JSON.parse(JSON.stringify(P.minionProfiles[n]||{})),i(),dn(),alert('Minion profile "'.concat(n,'" loaded!')))}));const ye=document.getElementById("mazemaster_minion_profile_delete_btn");ye&&ye.addEventListener("click",(async()=>{const e=document.getElementById("mazemaster_minion_profile_select"),n=null==e?void 0:e.value;if(!n)return void alert("Select a profile to delete");await p('Delete minion profile "'.concat(n,'"?'),u.CONFIRM)&&(delete P.minionProfiles[n],i(),zn(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_minions"))||void 0===e||e.click()}),100))}));const _e=document.getElementById("mazemaster_add_trap_btn"),xe=document.getElementById("mazemaster_trap_image_file");_e&&xe&&(_e.addEventListener("click",(()=>{xe.click()})),xe.addEventListener("change",(async e=>{var n;const t=null===(n=e.target.files)||void 0===n?void 0:n[0];if(t){try{const e="trap_".concat(Date.now()),n=await cn(t,e),a=await p("Enter trap name:",u.INPUT,"New Trap");a&&a.trim()&&($(e,{name:a.trim(),imagePath:n,message:"You triggered a trap!",script:""}),pn())}catch(e){alert("Image upload failed: ".concat(e.message))}xe.value=""}})));const we=document.getElementById("mazemaster_trap_profile_save_btn");we&&we.addEventListener("click",(async()=>{const e=await p("Enter profile name:",u.INPUT,"My Traps");if(e&&e.trim()){const n=e.trim();P.trapProfiles[n]=JSON.parse(JSON.stringify(P.traps||{})),i(),alert('Trap profile "'.concat(n,'" saved!')),zn(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_traps"))||void 0===e||e.click()}),100)}}));const Me=document.getElementById("mazemaster_trap_profile_load_btn");Me&&Me.addEventListener("click",(async()=>{const e=document.getElementById("mazemaster_trap_profile_select"),n=null==e?void 0:e.value;if(!n)return void alert("Select a profile to load");await p('Load trap profile "'.concat(n,'"? This will replace your current traps.'),u.CONFIRM)&&(P.traps=JSON.parse(JSON.stringify(P.trapProfiles[n]||{})),i(),pn(),alert('Trap profile "'.concat(n,'" loaded!')))}));const Ee=document.getElementById("mazemaster_trap_profile_delete_btn");Ee&&Ee.addEventListener("click",(async()=>{const e=document.getElementById("mazemaster_trap_profile_select"),n=null==e?void 0:e.value;if(!n)return void alert("Select a profile to delete");await p('Delete trap profile "'.concat(n,'"?'),u.CONFIRM)&&(delete P.trapProfiles[n],i(),zn(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_traps"))||void 0===e||e.click()}),100))}))}function zn(){const e=document.getElementById("mazemaster_drawer");e&&(e.innerHTML=tn(),vn(),an(),sn(),dn(),pn(),rn())}async function yn(e){if(D.has(e))return;if(e.classList.contains("streaming")||e.classList.contains("is-typing")||e.querySelector(".mes_text.streaming"))return;const n=e.querySelector(".mes_text .stle--content")||e.querySelector(".mes_text");if(!n)return;const t=n.textContent||"",a=/\{\{wheel:([^}]+)\}\}/gi,o=/\{\{battlebar:([^}]+)\}\}/gi,i=/\{\{maze:([^}]+)\}\}/gi,s=[],r=[],l=[];let m;for(;null!==(m=a.exec(t));)s.push({full:m[0],profile:m[1].trim()});for(;null!==(m=o.exec(t));)r.push({full:m[0],profile:m[1].trim()});for(;null!==(m=i.exec(t));)l.push({full:m[0],profile:m[1].trim()});if(0===s.length&&0===r.length&&0===l.length)return;D.add(e);const c=SillyTavern.getContext(),d=e.getAttribute("mesid");for(const n of s){console.log("[MazeMaster] Processing wheel macro: ".concat(n.full));if(!Z(n.profile).error){ee().valid&&te()}const t="[ðŸŽ¡ Wheel: ".concat(n.profile,"]");if(c.chat&&null!==d){const a=parseInt(d);if(c.chat[a]){const o=c.chat[a].mes,i=o.replace(n.full,"").replace(/\s+/g," ").trim(),s=o.replace(n.full,t);c.chat[a].mes=i;const r=e.querySelector(".mes_text");r&&(r.innerHTML=s)}}}for(const n of r){console.log("[MazeMaster] Processing battlebar macro: ".concat(n.full)),ie(n.profile);const t="[âš”ï¸ Battlebar: ".concat(n.profile,"]");if(c.chat&&null!==d){const a=parseInt(d);if(c.chat[a]){const o=c.chat[a].mes,i=o.replace(n.full,"").replace(/\s+/g," ").trim(),s=o.replace(n.full,t);c.chat[a].mes=i;const r=e.querySelector(".mes_text");r&&(r.innerHTML=s)}}}for(const n of l){console.log("[MazeMaster] Processing maze macro: ".concat(n.full)),Ce(n.profile);const t="[ðŸ›ï¸ Maze: ".concat(n.profile,"]");if(c.chat&&null!==d){const a=parseInt(d);if(c.chat[a]){const o=c.chat[a].mes,i=o.replace(n.full,"").replace(/\s+/g," ").trim(),s=o.replace(n.full,t);c.chat[a].mes=i;const r=e.querySelector(".mes_text");r&&(r.innerHTML=s)}}}}function _n(){const e=SillyTavern.getContext();if(!e||!e.eventSource||!e.eventTypes)return console.warn("[MazeMaster] Context not ready for macro hooks, retrying..."),void setTimeout(_n,500);e.eventTypes.USER_MESSAGE_RENDERED&&e.eventSource.on(e.eventTypes.USER_MESSAGE_RENDERED,(e=>{setTimeout((()=>{const n=document.querySelector('#chat .mes[mesid="'.concat(e,'"]'));n&&yn(n)}),500)})),e.eventTypes.CHARACTER_MESSAGE_RENDERED&&e.eventSource.on(e.eventTypes.CHARACTER_MESSAGE_RENDERED,(e=>{const n=function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;const a=document.querySelector('#chat .mes[mesid="'.concat(e,'"]'));if(!a)return;(a.classList.contains("streaming")||a.classList.contains("is-typing"))&&t<5?setTimeout((()=>n(t+1)),1e3):yn(a)};setTimeout((()=>n()),500)})),console.log("[MazeMaster] Macro hooks registered")}!function(){const e=SillyTavern.getContext();e.extensionSettings[a]||(e.extensionSettings[a]=JSON.parse(JSON.stringify(_))),P=e.extensionSettings[a];for(const e in _)void 0===P[e]&&(P[e]=JSON.parse(JSON.stringify(_[e])));P.profiles||(P.profiles={}),P.battlebarProfiles||(P.battlebarProfiles={}),P.mazeProfiles||(P.mazeProfiles={}),P.minions||(P.minions={}),P.traps||(P.traps={}),P.savedMazes||(P.savedMazes={}),P.minionProfiles||(P.minionProfiles={}),P.trapProfiles||(P.trapProfiles={});let n=!1;for(const[e,t]of Object.entries(x))P.profiles[e]||(P.profiles[e]=JSON.parse(JSON.stringify(t)),n=!0,console.log("[MazeMaster] Added default wheel profile: ".concat(e)));P.currentProfile||(P.currentProfile="Reward Wheel");for(const[e,t]of Object.entries(w))P.battlebarProfiles[e]||(P.battlebarProfiles[e]=JSON.parse(JSON.stringify(t)),n=!0,console.log("[MazeMaster] Added default battlebar profile: ".concat(e)));P.currentBattlebarProfile||(P.currentBattlebarProfile="Easy Fight");const t=w["Easy Fight"];for(const[e,a]of Object.entries(P.battlebarProfiles))for(const[o,i]of Object.entries(t))void 0===a[o]&&(a[o]=JSON.parse(JSON.stringify(i)),n=!0,console.log('[MazeMaster] Added missing field "'.concat(o,'" to battlebar profile: ').concat(e)));for(const[e,t]of Object.entries(E))P.minions[e]||(P.minions[e]=JSON.parse(JSON.stringify(t)),n=!0,console.log("[MazeMaster] Added default minion: ".concat(e)));for(const[e,t]of Object.entries(k))P.traps[e]||(P.traps[e]=JSON.parse(JSON.stringify(t)),n=!0,console.log("[MazeMaster] Added default trap: ".concat(e)));for(const[e,t]of Object.entries(I))P.minionProfiles[e]||(P.minionProfiles[e]=JSON.parse(JSON.stringify(t)),n=!0,console.log("[MazeMaster] Added default minion profile: ".concat(e)));for(const[e,t]of Object.entries(C))P.trapProfiles[e]||(P.trapProfiles[e]=JSON.parse(JSON.stringify(t)),n=!0,console.log("[MazeMaster] Added default trap profile: ".concat(e)));for(const[e,t]of Object.entries(S))if(P.mazeProfiles[e]){const a=P.mazeProfiles[e];for(const[o,i]of Object.entries(t)){const t=Array.isArray(a[o])&&0===a[o].length,s="object"==typeof a[o]&&null!==a[o]&&!Array.isArray(a[o])&&0===Object.keys(a[o]).length,r=void 0===a[o]||t||s,l="startingInventory"===o&&a[o]&&"object"==typeof a[o]&&0===(a[o].key||0)&&0===(a[o].stealth||0)&&0===(a[o].pow||0)&&0===(a[o].grandpow||0);(r||l)&&i&&(!Array.isArray(i)||i.length>0)&&(a[o]=JSON.parse(JSON.stringify(i)),n=!0,console.log("[MazeMaster] Added missing/empty field '".concat(o,"' to maze profile: ").concat(e)))}}else P.mazeProfiles[e]=JSON.parse(JSON.stringify(t)),n=!0,console.log("[MazeMaster] Added default maze profile: ".concat(e));P.currentMazeProfile||(P.currentMazeProfile="Dungeon Crawl"),n&&i(),console.log("[MazeMaster] Loaded settings:",P)}(),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",(()=>{un(),oe(),_n()})):(un(),oe(),_n()),console.log("[".concat(a,"] Extension loaded (folder: ").concat(o,")"))})();