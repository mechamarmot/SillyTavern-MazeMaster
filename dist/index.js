(()=>{function e(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function t(t){for(var a=1;a<arguments.length;a++){var o=null!=arguments[a]?arguments[a]:{};a%2?e(Object(o),!0).forEach((function(e){n(t,e,o[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(o)):e(Object(o)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(o,e))}))}return t}function n(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var a=n.call(e,t||"default");if("object"!=typeof a)return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}const a="MazeMaster";let o=a;try{const e="file:///home/saintorphan/Projects/ST-Extensions/SillyTavern-MazeMaster/src/index.js".match(/\/scripts\/extensions\/third-party\/([^/]+)\//);e&&e[1]&&(o=e[1])}catch(e){const t=document.querySelectorAll('script[src*="MazeMaster"]');for(const e of t){const t=e.src.match(/\/scripts\/extensions\/third-party\/([^/]+)\//);if(t&&t[1]){o=t[1];break}}}const{saveSettingsDebounced:i,SlashCommandParser:s,SlashCommand:r,ARGUMENT_TYPE:l,SlashCommandNamedArgument:c,executeSlashCommandsWithOptions:d,getRequestHeaders:m,callGenericPopup:p,POPUP_TYPE:u,generateQuietPrompt:h,getPresetManager:g,mainApi:f}=SillyTavern.getContext(),v=["#e74c3c","#3498db","#2ecc71","#f39c12","#9b59b6","#1abc9c","#e67e22","#34495e","#e91e63","#00bcd4","#8bc34a","#ff5722"],b={fraction:1,halfseg:.5,doubleseg:2},y=["fraction","halfseg","doubleseg"],z={minZoneWidth:.1,maxZoneWidth:.45,minTraverseTime:1200,maxTraverseTime:4e3};function x(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:5,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;const n=(Math.max(1,Math.min(10,e*t))-1)/9,a=z.maxTraverseTime-n*(z.maxTraverseTime-z.minTraverseTime);return{zoneWidth:z.maxZoneWidth-n*(z.maxZoneWidth-z.minZoneWidth),traverseTime:Math.round(a)}}const _={1:2,2:4,3:5,4:7,5:9},w={easy:{name:"Easy",gridSizeRange:{min:5,max:10},encounterDensityMult:1,trapFrequencyMult:.5,battlebarZoneMult:1.3,battlebarSpeedMult:.8,inventoryStartMult:1.5,minionAggressionMult:.5,chestLootMult:1.2,hpMult:1.3,damageMult:.7,healMult:1.2},normal:{name:"Normal",gridSizeRange:{min:5,max:20},encounterDensityMult:1.2,trapFrequencyMult:1,battlebarZoneMult:1,battlebarSpeedMult:1,inventoryStartMult:1,minionAggressionMult:1,chestLootMult:1,hpMult:1,damageMult:1,healMult:1},hard:{name:"Hard",gridSizeRange:{min:8,max:20},encounterDensityMult:1.5,trapFrequencyMult:1.5,battlebarZoneMult:.8,battlebarSpeedMult:1.2,inventoryStartMult:.7,minionAggressionMult:1.5,chestLootMult:.8,hpMult:.8,damageMult:1.3,healMult:.8},nightmare:{name:"Nightmare",gridSizeRange:{min:10,max:20},encounterDensityMult:1.8,trapFrequencyMult:2,battlebarZoneMult:.6,battlebarSpeedMult:1.4,inventoryStartMult:.5,minionAggressionMult:2,chestLootMult:.6,hpMult:.6,damageMult:1.6,healMult:.6}},k={fantasy:{name:"Fantasy",tileMappings:{wall:"stone wall",floor:"dungeon floor",chest:"treasure chest",exit:"portal to freedom",portal:"mystic gateway",trap:"arcane trap",stairUp:"ascending staircase",stairDown:"descending staircase",minion:"creature"},itemAliases:{key:"Iron Key",stealth:"Cloak of Shadows",strike:"Battle Fury",execute:"Divine Wrath",floorKey:"Stairway Key",portalStone:"Portal Stone",minionBane:"Monster Bane",mapFragment:"Ancient Map",timeShard:"Time Crystal",voidWalk:"Ghost Step Potion"},flavorMessages:{chestFind:"You discover an ancient treasure chest!",portalUse:"The mystic gateway shimmers and pulls you through!",trapTrigger:"An arcane glyph activates beneath your feet!",stairUp:"You ascend the ancient staircase...",stairDown:"You descend into the depths below...",victory:"Glory! You have conquered the dungeon!",defeat:"The darkness claims another soul..."},colors:{primary:"#2ecc71",secondary:"#27ae60",accent:"#f1c40f"}},horror:{name:"Horror",tileMappings:{wall:"blood-stained wall",floor:"creaking floorboard",chest:"ominous coffin",exit:"escape route",portal:"dark rift",trap:"deadly snare",stairUp:"rickety ladder up",stairDown:"descending pit",minion:"abomination"},itemAliases:{key:"Rusty Key",stealth:"Shadow Shroud",strike:"Adrenaline Rush",execute:"Survival Instinct",floorKey:"Cellar Key",portalStone:"Dark Crystal",minionBane:"Banishment Charm",mapFragment:"Torn Note",timeShard:"Slowing Serum",voidWalk:"Phase Vial"},flavorMessages:{chestFind:"A decrepit coffin... dare you open it?",portalUse:"The rift tears open, pulling you into darkness!",trapTrigger:"You hear a click... then screaming.",stairUp:"The ladder groans under your weight...",stairDown:"You descend into the suffocating darkness...",victory:"You escape... but the nightmares will follow.",defeat:"Your screams echo eternally in the void..."},colors:{primary:"#c0392b",secondary:"#8e1b1b",accent:"#7f8c8d"}},scifi:{name:"Sci-Fi",tileMappings:{wall:"reinforced bulkhead",floor:"metal grating",chest:"supply crate",exit:"escape pod",portal:"warp gate",trap:"security system",stairUp:"elevator up",stairDown:"elevator down",minion:"hostile entity"},itemAliases:{key:"Access Card",stealth:"Cloaking Device",strike:"Combat Stim",execute:"Overdrive Module",floorKey:"Deck Keycard",portalStone:"Teleport Beacon",minionBane:"EMP Grenade",mapFragment:"Data Pad",timeShard:"Temporal Disruptor",voidWalk:"Phase Shifter"},flavorMessages:{chestFind:"A sealed supply crate. Contents unknown.",portalUse:"Warp gate activated. Brace for teleportation.",trapTrigger:"SECURITY ALERT: Hostile detected!",stairUp:"Elevator ascending to upper deck...",stairDown:"Elevator descending to lower deck...",victory:"Mission complete. Extraction successful.",defeat:"SYSTEM FAILURE: Life signs terminated."},colors:{primary:"#3498db",secondary:"#2980b9",accent:"#1abc9c"}},action:{name:"Action",tileMappings:{wall:"concrete barrier",floor:"worn tile",chest:"ammo crate",exit:"extraction point",portal:"fast rope insertion",trap:"booby trap",stairUp:"ladder up",stairDown:"ladder down",minion:"hostile"},itemAliases:{key:"Master Key",stealth:"Smoke Grenade",strike:"Adrenaline Shot",execute:"Air Strike",floorKey:"Building Key",portalStone:"Zip Line",minionBane:"Flashbang",mapFragment:"Intel Report",timeShard:"Slow-Mo Serum",voidWalk:"Breach Charge"},flavorMessages:{chestFind:"Supply cache located. Check for booby traps.",portalUse:"Moving to new position!",trapTrigger:"Contact! Hostile fire!",stairUp:"Moving up! Watch your six!",stairDown:"Descending! Stay frosty!",victory:"Area secured. Good work, soldier.",defeat:"Man down! Mission failed."},colors:{primary:"#e67e22",secondary:"#d35400",accent:"#95a5a6"}},cyberpunk:{name:"Cyberpunk",tileMappings:{wall:"neon-lit barrier",floor:"chrome plating",chest:"data cache",exit:"extraction node",portal:"netrunner jack",trap:"ICE protocol",stairUp:"mag-lift up",stairDown:"mag-lift down",minion:"cyborg"},itemAliases:{key:"Access Chip",stealth:"Optical Camo",strike:"Combat Stims",execute:"Berserker Mode",floorKey:"Elevator Override",portalStone:"Fast Travel Chip",minionBane:"System Crash",mapFragment:"Hacked Schematic",timeShard:"Reflex Booster",voidWalk:"Ghost Protocol"},flavorMessages:{chestFind:"Data cache detected. Initiating decrypt...",portalUse:"Jacking in... connection established.",trapTrigger:"ICE DETECTED! Countermeasures active!",stairUp:"Mag-lift ascending to upper level...",stairDown:"Mag-lift descending to sub-level...",victory:"Run complete. Payout received, choom.",defeat:"Flatlined. Your chrome belongs to the corp now."},colors:{primary:"#ff00ff",secondary:"#00ffff",accent:"#ffff00"}},noir:{name:"Noir",tileMappings:{wall:"rain-streaked wall",floor:"wet pavement",chest:"locked safe",exit:"back alley exit",portal:"secret passage",trap:"hidden wire",stairUp:"fire escape up",stairDown:"cellar stairs",minion:"goon"},itemAliases:{key:"Skeleton Key",stealth:"Trench Coat",strike:"Brass Knuckles",execute:"Tommy Gun",floorKey:"Service Key",portalStone:"Secret Map",minionBane:"Blackmail File",mapFragment:"Case Notes",timeShard:"Pocket Watch",voidWalk:"Shadow Step"},flavorMessages:{chestFind:"A safe in the shadows. Someone has secrets...",portalUse:"The bookcase slides aside, revealing a passage.",trapTrigger:"You hear a click. This was a setup.",stairUp:"The fire escape groans in the rain...",stairDown:"Down into the cellar. Watch your back.",victory:"Case closed. Time for a drink.",defeat:"Another gumshoe lost to the city..."},colors:{primary:"#4a4a4a",secondary:"#2c2c2c",accent:"#c9a227"}},postapoc:{name:"Post-Apocalyptic",tileMappings:{wall:"crumbling rubble",floor:"irradiated ground",chest:"salvage pile",exit:"safe zone",portal:"collapsed tunnel",trap:"radiation hotspot",stairUp:"rusted ladder up",stairDown:"crater descent",minion:"mutant"},itemAliases:{key:"Vault Keycard",stealth:"Ghillie Wrap",strike:"Rad-X Boost",execute:"Mini Nuke",floorKey:"Bunker Code",portalStone:"Signal Flare",minionBane:"Purifier",mapFragment:"Scavenged Map",timeShard:"Stasis Field",voidWalk:"Hazmat Suit"},flavorMessages:{chestFind:"A salvage cache from the old world...",portalUse:"You squeeze through the collapsed tunnel.",trapTrigger:"GEIGER SPIKE! Radiation flooding the area!",stairUp:"The rusted ladder holds... barely.",stairDown:"Descending into the crater...",victory:"You survived. For now.",defeat:"The wasteland claims another soul..."},colors:{primary:"#8b7355",secondary:"#556b2f",accent:"#cd853f"}},comedy:{name:"Comedy",tileMappings:{wall:"suspiciously normal wall",floor:"slightly sticky floor",chest:"mystery box",exit:"extremely obvious exit",portal:"plot hole",trap:"banana peel",stairUp:"escalator (broken)",stairDown:"slide",minion:"weirdo"},itemAliases:{key:"Comically Large Key",stealth:"Cardboard Box",strike:"Energy Drink",execute:"Power of Friendship",floorKey:"Janitor's Master Key",portalStone:"Plot Device",minionBane:"Bad Pun",mapFragment:"Napkin Drawing",timeShard:"Dramatic Pause",voidWalk:"Fourth Wall Break"},flavorMessages:{chestFind:"Ooh, a mystery box! It could be anything!",portalUse:"You fall through a plot hole!",trapTrigger:"Classic banana peel. You saw it coming.",stairUp:"The escalator is broken. Guess it's just stairs now.",stairDown:"WHEEE! *slide noises*",victory:"You win! The crowd goes mild!",defeat:"Wah wah wahhh... Game Over, buddy."},colors:{primary:"#ff6b6b",secondary:"#feca57",accent:"#48dbfb"}},western:{name:"Western",tileMappings:{wall:"wooden planks",floor:"dusty floorboards",chest:"strongbox",exit:"town limits",portal:"mine shaft",trap:"rattlesnake den",stairUp:"rickety stairs up",stairDown:"cellar hatch",minion:"outlaw"},itemAliases:{key:"Skeleton Key",stealth:"Poncho",strike:"Whiskey Courage",execute:"Dynamite Bundle",floorKey:"Mine Key",portalStone:"Treasure Map",minionBane:"Silver Bullet",mapFragment:"Wanted Poster",timeShard:"High Noon Focus",voidWalk:"Tumbleweed Roll"},flavorMessages:{chestFind:"A locked strongbox. Could be gold inside...",portalUse:"You duck into the old mine shaft.",trapTrigger:"RATTLESNAKES! Draw!",stairUp:"The stairs creak with every step...",stairDown:"Down into the root cellar...",victory:"You ride off into the sunset, partner.",defeat:"This town wasn't big enough for both of ya."},colors:{primary:"#d2691e",secondary:"#8b4513",accent:"#ffd700"}}},C={fantasy:{adjectives:["Ancient","Mystical","Enchanted","Arcane","Forgotten"]},horror:{adjectives:["Blood-Stained","Haunted","Cursed","Rotting","Whispering"]},scifi:{adjectives:["Automated","Sterile","Malfunctioning","Quarantined","Pressurized"]},action:{adjectives:["Reinforced","Tactical","Fortified","Hostile","Secured"]},cyberpunk:{adjectives:["Neon-Lit","Chrome","Glitched","Hacked","Blackmarket"]},noir:{adjectives:["Shadowy","Smoky","Rain-Soaked","Dimly-Lit","Forgotten"]},postapoc:{adjectives:["Ruined","Overgrown","Irradiated","Collapsed","Scavenged"]},comedy:{adjectives:["Suspiciously Normal","Slightly Damp","Questionable","Overdecorated","Poorly Labeled"]},western:{adjectives:["Dusty","Sun-Bleached","Weathered","Abandoned","Rickety"]}},S={maze:{common:{prefixes:["Winding","Narrow","Long","Dark","Quiet"],nouns:["Corridor","Passage","Hallway","Path","Tunnel"],descriptions:["The walls press in from both sides.","Echoes fade into the distance.","The path stretches onward."]},junction:{prefixes:["Central","Open","Connecting","Main"],nouns:["Junction","Crossroads","Intersection","Hub"],descriptions:["Multiple paths branch from here.","A decision point in the maze.","Which way to go?"]},deadend:{prefixes:["Sealed","Blocked","Empty","Forgotten"],nouns:["Dead End","Alcove","Nook","Corner"],descriptions:["No way forward from here.","A quiet corner of the maze.","Time to backtrack."]},staircase:{names:["The Spiral Path","Winding Stairs","The Descent","Stone Steps"],descriptions:["Worn steps lead to another level.","The stairway beckons."]},portal:{names:["Mystic Gateway","Shimmering Portal","The Threshold","Warp Point"],descriptions:["Reality bends here.","Step through to somewhere else."]},chest:{names:["Treasure Alcove","Hidden Cache","Fortune's Corner","The Vault"],descriptions:["Something valuable awaits.","A promising discovery."]},minion:{names:["Guardian's Post","The Confrontation","Danger Zone","Enemy Territory"],descriptions:["You sense a presence.","Something stirs ahead."]},trap:{names:["Treacherous Ground","The Snare","Danger Ahead","False Safety"],descriptions:["The floor seems unstable.","Something feels wrong here."]},exit:{names:["The Final Gate","Freedom's Door","The End","Escape Route"],descriptions:["The exit is within reach!","Almost there..."]},start:{names:["The Beginning","Starting Point","Entry Hall","The Origin"],descriptions:["Your journey begins here.","The entrance to the maze."]}},dungeon:{common:{prefixes:["Damp","Crumbling","Moss-Covered","Torch-Lit","Stone"],nouns:["Corridor","Passage","Chamber","Tunnel","Crypt"],descriptions:["Water drips from the ceiling.","Ancient stones line the walls.","The air is thick and musty."]},junction:{prefixes:["Grand","Central","Ruined","Pillared"],nouns:["Hall","Atrium","Chamber","Rotunda"],descriptions:["Pillars support the vaulted ceiling.","Several passages meet here."]},deadend:{prefixes:["Collapsed","Sealed","Empty","Forgotten"],nouns:["Tomb","Cell","Alcove","Crypt"],descriptions:["The way is blocked by rubble.","Nothing but bones and dust."]},staircase:{names:["The Spiral Descent","Stone Stairwell","Dungeon Steps","The Deep Stairs"],descriptions:["Worn steps descend into darkness.","Each step echoes ominously."]},portal:{names:["Arcane Circle","The Dark Rift","Summoning Chamber","Void Gate"],descriptions:["Strange runes glow on the floor.","The air crackles with energy."]},chest:{names:["Treasure Vault","Burial Cache","Hidden Hoard","Ancient Coffer"],descriptions:["Gold glimmers in the torchlight.","What treasures lie within?"]},minion:{names:["Guardian's Lair","The Beast's Den","Cursed Chamber","Haunted Hall"],descriptions:["Something lurks in the shadows.","Eyes watch from the darkness."]},trap:{names:["Pressure Plates","Spike Corridor","The Gauntlet","Death Trap"],descriptions:["The floor has suspicious tiles.","Previous adventurers weren't so lucky."]},exit:{names:["Dungeon Gate","Surface Access","The Way Out","Freedom's Light"],descriptions:["Daylight streams through ahead!","The exit awaits!"]},start:{names:["Dungeon Entrance","The First Chamber","Entry Vault","Beginning of the End"],descriptions:["You enter the dungeon depths.","Adventure awaits within."]}},city:{common:{prefixes:["Narrow","Crowded","Busy","Quiet","Back"],nouns:["Street","Alley","Lane","Road","Avenue"],descriptions:["Buildings tower on either side.","The city hums around you.","Footsteps echo on cobblestones."]},junction:{prefixes:["Main","Central","Open","Market"],nouns:["Square","Plaza","Intersection","Crossroads"],descriptions:["Several streets converge here.","A bustling urban hub."]},deadend:{prefixes:["Blocked","Private","Forgotten","Secluded"],nouns:["Courtyard","Dead End","Cul-de-sac","Alley"],descriptions:["No way through here.","A quiet corner of the city."]},staircase:{names:["Fire Escape","Metro Stairs","Building Access","Service Stairwell"],descriptions:["Metal stairs lead up or down.","An urban vertical passage."]},portal:{names:["Subway Entrance","Secret Door","Hidden Passage","Underground Access"],descriptions:["A way to move quickly.","Not everyone knows about this."]},chest:{names:["Supply Cache","Abandoned Stash","Hidden Storage","Drop Point"],descriptions:["Someone left supplies here.","Could be useful items inside."]},minion:{names:["Gang Territory","Hostile Zone","Ambush Point","Danger Zone"],descriptions:["This area isn't safe.","Watch your back."]},trap:{names:["Construction Zone","Hazard Area","Unstable Ground","Danger Zone"],descriptions:["Caution signs litter the area.","Something's not right here."]},exit:{names:["City Limits","The Way Out","Freedom Boulevard","Exit Gate"],descriptions:["Safety is just ahead!","Almost out of the city!"]},start:{names:["Downtown Drop","Starting Block","Entry Point","Ground Zero"],descriptions:["Your urban adventure begins.","The city awaits."]}},forest:{common:{prefixes:["Overgrown","Shaded","Winding","Mossy","Dense"],nouns:["Path","Trail","Grove","Thicket","Clearing"],descriptions:["Leaves rustle overhead.","Sunlight filters through the canopy.","The forest is alive with sounds."]},junction:{prefixes:["Central","Open","Sunny","Ancient"],nouns:["Clearing","Glade","Meadow","Crossroads"],descriptions:["Several paths diverge here.","A peaceful clearing in the woods."]},deadend:{prefixes:["Tangled","Blocked","Overgrown","Dense"],nouns:["Thicket","Dead End","Brush","Undergrowth"],descriptions:["The vegetation is too thick to pass.","No way through this tangle."]},staircase:{names:["Root Steps","Cliff Path","Tree Ladder","Natural Stairs"],descriptions:["Natural formations create a path up or down.","The terrain changes elevation."]},portal:{names:["Fairy Ring","Ancient Tree","Spirit Gate","Enchanted Grove"],descriptions:["Magic lingers in this place.","The veil between worlds is thin here."]},chest:{names:["Hollow Tree","Hidden Cache","Nature's Gift","Forest Bounty"],descriptions:["Something hidden among the roots.","The forest provides."]},minion:{names:["Beast's Territory","Predator's Ground","Wild Zone","Creature's Lair"],descriptions:["Something territorial lives here.","The wildlife seems hostile."]},trap:{names:["Quicksand","Poison Ivy Patch","Hunter's Snare","Treacherous Ground"],descriptions:["The ground looks unstable.","Nature can be dangerous."]},exit:{names:["Forest Edge","The Clearing","Open Fields","Way Out"],descriptions:["The tree line ends ahead!","Almost out of the forest!"]},start:{names:["Forest Entrance","Trail Head","Woods Edge","Into the Wild"],descriptions:["The forest path begins here.","Adventure awaits in the trees."]}},outpost:{common:{prefixes:["Dusty","Wooden","Fortified","Patrol","Guard"],nouns:["Walkway","Corridor","Passage","Path","Route"],descriptions:["Wooden planks creak underfoot.","The outpost feels hastily constructed.","Frontier life is rough."]},junction:{prefixes:["Central","Main","Command","Trading"],nouns:["Courtyard","Square","Hub","Plaza"],descriptions:["The heart of the outpost.","People gather here."]},deadend:{prefixes:["Storage","Private","Blocked","Abandoned"],nouns:["Corner","Area","Section","Alcove"],descriptions:["This area is off-limits.","Nothing to see here."]},staircase:{names:["Watchtower Ladder","Rampart Stairs","Cellar Access","Tower Steps"],descriptions:["Rough-hewn steps lead up or down.","A vertical route through the outpost."]},portal:{names:["Secret Tunnel","Escape Route","Hidden Exit","Underground Path"],descriptions:["A hidden way to move quickly.","Not on any official maps."]},chest:{names:["Supply Crate","Armory Cache","Provisions Store","Trade Goods"],descriptions:["Frontier supplies are valuable.","Someone stockpiled resources here."]},minion:{names:["Hostile Territory","Raider Camp","Enemy Ground","Danger Zone"],descriptions:["This area isn't friendly.","Hostiles have been spotted here."]},trap:{names:["Perimeter Defense","Booby Trap","Defensive Line","Warning Zone"],descriptions:["The outpost has defenses.","Watch where you step."]},exit:{names:["Main Gate","Frontier Exit","The Way Out","Open Plains"],descriptions:["The frontier awaits beyond!","Almost to safety!"]},start:{names:["Outpost Gate","Arrival Point","Entry Post","Checkpoint"],descriptions:["Welcome to the frontier.","Your mission begins here."]}},spacestation:{common:{prefixes:["Pressurized","Maintenance","Crew","Service","Transit"],nouns:["Corridor","Deck","Section","Tube","Passageway"],descriptions:["The hum of life support fills the air.","Zero-G handles line the walls.","Status lights blink in sequence."]},junction:{prefixes:["Central","Main","Command","Hub"],nouns:["Atrium","Nexus","Hub","Junction"],descriptions:["Multiple decks connect here.","The station's central point."]},deadend:{prefixes:["Sealed","Depressurized","Locked","Abandoned"],nouns:["Airlock","Module","Section","Bay"],descriptions:["This section is sealed off.","No access beyond this point."]},staircase:{names:["Deck Ladder","Gravity Lift","Access Tube","Inter-deck Transit"],descriptions:["Vertical transit between decks.","Watch your head in zero-G."]},portal:{names:["Teleport Pad","Warp Gate","Transit Pod","Instant Travel"],descriptions:["Advanced technology enables instant travel.","Step on the pad to teleport."]},chest:{names:["Supply Locker","Cargo Pod","Equipment Bay","Resource Cache"],descriptions:["Standard station supplies.","Emergency equipment stored here."]},minion:{names:["Hostile Sector","Quarantine Zone","Breach Area","Danger Zone"],descriptions:["Security protocols are active.","Something hostile is aboard."]},trap:{names:["Radiation Leak","Decompression Risk","Electrical Hazard","System Failure"],descriptions:["Warning lights flash urgently.","Safety systems are offline."]},exit:{names:["Escape Pod Bay","Extraction Point","Docking Ring","The Way Out"],descriptions:["Rescue is just ahead!","Almost to the escape pods!"]},start:{names:["Docking Bay","Arrival Deck","Entry Point","Station Access"],descriptions:["Welcome aboard the station.","Your mission begins here."]}},college:{common:{prefixes:["Main","Academic","Student","Faculty","Campus"],nouns:["Hallway","Corridor","Wing","Path","Walkway"],descriptions:["Lockers line the walls.","Motivational posters are everywhere.","The smell of cafeteria food lingers."]},junction:{prefixes:["Central","Main","Student","Campus"],nouns:["Quad","Commons","Atrium","Hub"],descriptions:["Students gather between classes.","The heart of campus life."]},deadend:{prefixes:["Maintenance","Staff Only","Locked","Private"],nouns:["Closet","Office","Room","Storage"],descriptions:["This area is restricted.","Faculty only beyond this point."]},staircase:{names:["Main Stairwell","Fire Stairs","Back Stairs","Service Access"],descriptions:["Standard institutional stairs.","Watch out for students rushing to class."]},portal:{names:["Secret Passage","Underground Tunnel","Maintenance Route","Shortcut"],descriptions:["Not on the official campus map.","Students pass down secret knowledge."]},chest:{names:["Lost and Found","Supply Closet","Locker","Hidden Stash"],descriptions:["Someone left something behind.","Might find something useful."]},minion:{names:["Bully Territory","Staff Patrol","Security Zone","No-Go Area"],descriptions:["Best to avoid this area.","Someone unfriendly is here."]},trap:{names:["Wet Floor","Construction Zone","Prank Setup","Hazard Area"],descriptions:["Watch your step.","Something seems off here."]},exit:{names:["Main Exit","Campus Gate","Front Doors","Freedom"],descriptions:["School's out!","Almost to freedom!"]},start:{names:["Main Entrance","Welcome Hall","Registration","Starting Point"],descriptions:["Welcome to campus.","Your academic adventure begins."]}},apartment:{common:{prefixes:["Narrow","Dimly-Lit","Carpeted","Quiet","Long"],nouns:["Hallway","Corridor","Landing","Passage","Floor"],descriptions:["Apartment doors line both sides.","The building is eerily quiet.","Fluorescent lights flicker."]},junction:{prefixes:["Main","Central","Elevator","Stair"],nouns:["Lobby","Landing","Foyer","Hub"],descriptions:["Multiple hallways branch from here.","The building's central area."]},deadend:{prefixes:["Locked","Private","Utility","Maintenance"],nouns:["Apartment","Room","Closet","Unit"],descriptions:["This unit is locked.","No access here."]},staircase:{names:["Fire Stairs","Main Stairwell","Back Stairs","Service Stairs"],descriptions:["Concrete steps echo with each footfall.","Standard apartment building stairs."]},portal:{names:["Dumbwaiter","Laundry Chute","Hidden Panel","Secret Room"],descriptions:["A hidden way through the building.","Not everyone knows about this."]},chest:{names:["Storage Unit","Abandoned Locker","Supply Closet","Hidden Cache"],descriptions:["Someone left something behind.","Might contain useful items."]},minion:{names:["Hostile Unit","Occupied Floor","Danger Zone","Unfriendly Neighbors"],descriptions:["Something unfriendly lives here.","Best to be careful."]},trap:{names:["Broken Floor","Electrical Hazard","Gas Leak","Structural Damage"],descriptions:["The building isn't safe here.","Watch your step."]},exit:{names:["Main Exit","Front Door","Fire Exit","Street Access"],descriptions:["The street is just ahead!","Almost out of the building!"]},start:{names:["Building Entrance","Main Lobby","Entry Hall","Ground Floor"],descriptions:["You enter the apartment building.","Your urban exploration begins."]}},neotokyo:{common:{prefixes:["Neon","Crowded","Rain-Slicked","Holographic","Bustling"],nouns:["Street","Alley","Arcade","Passage","Lane"],descriptions:["Neon signs reflect off wet pavement.","Holographic ads fill the air.","The city never sleeps."]},junction:{prefixes:["Central","Shibuya-Style","Main","Mega"],nouns:["Crossing","Plaza","Square","Hub"],descriptions:["Thousands of screens illuminate the area.","A sensory overload of lights and sounds."]},deadend:{prefixes:["Sealed","Private","VIP","Restricted"],nouns:["Booth","Room","Alley","Zone"],descriptions:["No access without credentials.","This area is off-limits."]},staircase:{names:["Gravity Lift","Mag-Rail","Sky Bridge","Vertical Transit"],descriptions:["High-tech vertical transportation.","The city builds upward."]},portal:{names:["VR Hub","Data Port","Network Node","Fast Travel"],descriptions:["Jack in to move instantly.","The network connects all."]},chest:{names:["Vending Cache","Data Stash","Loot Box","Street Vendor"],descriptions:["Even garbage has value here.","Credits can buy anything."]},minion:{names:["Yakuza Turf","Corp Security","Gang Territory","Hostile Zone"],descriptions:["Someone owns this block.","You're not welcome here."]},trap:{names:["ICE Node","Security Grid","Drone Patrol","Surveillance Zone"],descriptions:["Automated defenses are active.","Big Brother is watching."]},exit:{names:["City Limits","Extraction Point","Safe House","The Way Out"],descriptions:["Almost out of the neon jungle!","Freedom awaits beyond!"]},start:{names:["Drop Zone","Street Level","Entry Point","Ground Zero"],descriptions:["Welcome to the future.","Your cyberpunk adventure begins."]}},arena:{common:{prefixes:["Stone","Sandy","Blood-Stained","Gladiator","Battle"],nouns:["Corridor","Passage","Tunnel","Path","Way"],descriptions:["The roar of the crowd echoes.","Sand and blood mix underfoot.","Glory or death awaits."]},junction:{prefixes:["Central","Main","Grand","Champion's"],nouns:["Arena","Ring","Pit","Stage"],descriptions:["The fighting grounds await.","All paths lead to battle."]},deadend:{prefixes:["Holding","Recovery","Equipment","Fighter's"],nouns:["Cell","Room","Bay","Quarters"],descriptions:["A moment of rest between fights.","Prepare for the next battle."]},staircase:{names:["Gladiator's Rise","Champion's Lift","Arena Access","Victory Steps"],descriptions:["The path to glory.","Rise to meet your opponent."]},portal:{names:["Fighter's Gate","Champion Portal","Mystery Entrance","Wild Card"],descriptions:["Where will you emerge?","The crowd loves surprises."]},chest:{names:["Weapon Rack","Prize Cache","Spoils of War","Victor's Reward"],descriptions:["The strong deserve rewards.","Claim your prize."]},minion:{names:["Fighter's Corner","Beast Pit","Champion's Ground","Battle Zone"],descriptions:["An opponent awaits.","Prepare for combat!"]},trap:{names:["Spike Pit","Fire Trap","Collapsing Floor","Arena Hazard"],descriptions:["The arena is dangerous.","Watch your footing!"]},exit:{names:["Victor's Gate","Champion's Exit","Freedom Gate","The Way Out"],descriptions:["Glory awaits the victor!","Survive and escape!"]},start:{names:["Challenger's Gate","Fighter's Entrance","Arena Entry","The Beginning"],descriptions:["The crowd awaits.","Prove your worth!"]}},hospital:{common:{prefixes:["Sterile","White","Quiet","Flickering","Abandoned"],nouns:["Corridor","Hallway","Ward","Wing","Section"],descriptions:["The smell of antiseptic lingers.","Medical equipment lies scattered.","Fluorescent lights hum overhead."]},junction:{prefixes:["Central","Main","Nurse's","Reception"],nouns:["Station","Hub","Desk","Lobby"],descriptions:["Multiple wards connect here.","The hospital's central hub."]},deadend:{prefixes:["Private","Quarantine","Restricted","Sealed"],nouns:["Room","Bay","Ward","Unit"],descriptions:["This area is restricted.","No access without clearance."]},staircase:{names:["Emergency Stairs","Service Elevator","Staff Access","Fire Stairs"],descriptions:["Standard hospital vertical access.","Watch for gurneys."]},portal:{names:["Morgue Tunnel","Utility Access","Hidden Passage","Underground Route"],descriptions:["Not on the hospital map.","A hidden way through."]},chest:{names:["Supply Closet","Medical Storage","Equipment Room","Pharmacy Cache"],descriptions:["Medical supplies could be useful.","Someone stockpiled resources."]},minion:{names:["Quarantine Zone","Infected Ward","Danger Area","Hostile Section"],descriptions:["Something isn't right here.","Proceed with caution."]},trap:{names:["Biohazard Zone","Contaminated Area","Structural Damage","Hazmat Zone"],descriptions:["Warning signs are everywhere.","This area isn't safe."]},exit:{names:["Emergency Exit","Main Entrance","Ambulance Bay","The Way Out"],descriptions:["Fresh air awaits!","Almost out of the hospital!"]},start:{names:["ER Entrance","Main Lobby","Admission","Ground Floor"],descriptions:["You enter the hospital.","Something feels wrong here."]}},highrise:{common:{prefixes:["Dusty","Abandoned","Crumbling","Empty","Dark"],nouns:["Hallway","Floor","Corridor","Office","Suite"],descriptions:["Abandoned furniture gathers dust.","The building creaks in the wind.","Nature reclaims the space."]},junction:{prefixes:["Main","Central","Executive","Open"],nouns:["Lobby","Atrium","Floor","Hub"],descriptions:["Once a place of business.","Multiple paths through the floor."]},deadend:{prefixes:["Collapsed","Sealed","Blocked","Destroyed"],nouns:["Office","Room","Section","Area"],descriptions:["The way is impassable.","Structural damage blocks the path."]},staircase:{names:["Fire Stairs","Emergency Exit","Service Stairs","Broken Elevator"],descriptions:["Concrete stairs wind upward.","The elevator hasn't worked in years."]},portal:{names:["Window Ledge","Broken Wall","Collapsed Floor","Vent Shaft"],descriptions:["An unconventional route.","Not for the faint of heart."]},chest:{names:["Old Safe","Forgotten Cache","Executive Stash","Supply Closet"],descriptions:["Something was left behind.","Previous occupants stored valuables."]},minion:{names:["Squatter's Territory","Hostile Floor","Danger Zone","Occupied Area"],descriptions:["Someone else calls this home.","You're not alone here."]},trap:{names:["Weak Floor","Broken Glass","Falling Debris","Structural Collapse"],descriptions:["The building is unstable.","Every step could be your last."]},exit:{names:["Ground Floor","Street Exit","Fire Escape","The Way Out"],descriptions:["Solid ground awaits!","Almost out of the building!"]},start:{names:["Rooftop Access","Upper Floor","Entry Point","The Beginning"],descriptions:["You enter the abandoned building.","Urban exploration begins."]}}};function M(e,t,n,a,o,i,s){const r=a.theme||"fantasy",l=a.mapStyle||"maze",c=function(e,t,n,a,o,i){if(0===t&&0===n)return"start";if(t===o&&n===i)return"exit";if(e.staircase)return"staircase";if(e.portal)return"portal";if(e.chest)return"chest";if(e.minion)return"minion";if(e.trap)return"trap";const s=[!e.walls.top,!e.walls.right,!e.walls.bottom,!e.walls.left].filter(Boolean).length;return s>=3?"junction":1===s?"deadend":"common"}(e,t,n,0,i,s),d=S[l]||S.maze,m=d[c]||d.common,p=C[r]||C.fantasy;let u,h;if(m.names)u=m.names[Math.floor(Math.random()*m.names.length)];else{const e=m.prefixes[Math.floor(Math.random()*m.prefixes.length)],t=m.nouns[Math.floor(Math.random()*m.nouns.length)];if(Math.random()<.3&&p.adjectives){const n=p.adjectives[Math.floor(Math.random()*p.adjectives.length)];u="".concat(n," ").concat(e," ").concat(t)}else u="".concat(e," ").concat(t)}return h=m.descriptions[Math.floor(Math.random()*m.descriptions.length)],{name:u,description:h,roomType:c}}function E(e,t,n,a,o){for(let i=0;i<n;i++)for(let s=0;s<n;s++){const n=e[i][s];n.roomInfo=M(n,s,i,t,0,a,o)}}class P{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.options=e,this.container=null,this.initialized=!1}getType(){return"base"}init(e,t){this.container=e,this.initialized=!0}getGridHTML(e){throw new Error("getGridHTML must be implemented by subclass")}getPlayerOverlayHTML(e){throw new Error("getPlayerOverlayHTML must be implemented by subclass")}getCellSize(e){return e<=5?50:e<=7?45:e<=10?38:e<=12?32:e<=15?26:22}render(e){throw new Error("render must be implemented by subclass")}updatePlayerPosition(e,t,n,a){throw new Error("updatePlayerPosition must be implemented by subclass")}highlightCell(e,t,n){}clearHighlights(){}playEffect(e,t,n){}getStyles(){return""}cleanup(){this.initialized=!1,this.container=null}}class I extends P{getType(){return"css-grid"}getStyleCSS(e){const t={dungeon:{filter:"saturate(0.7)",bg:"#1a1520",accent:"#6b5b7a"},maze:{filter:"hue-rotate(20deg)",bg:"#1a1828",accent:"#7866a0"},forest:{filter:"saturate(1.4) hue-rotate(-15deg)",bg:"#0d1a0d",accent:"#4a7a4a"},city:{filter:"saturate(0.6) contrast(1.1)",bg:"#161820",accent:"#6a7080"},spacestation:{filter:"saturate(1.2) hue-rotate(200deg)",bg:"#0d1525",accent:"#4080b0"},college:{filter:"sepia(0.3)",bg:"#1a1510",accent:"#9a8060"},apartment:{filter:"sepia(0.2)",bg:"#1a1612",accent:"#8a7660"},neotokyo:{filter:"saturate(1.5) hue-rotate(300deg)",bg:"#1a0d18",accent:"#b040a0"},arena:{filter:"hue-rotate(25deg) saturate(1.2)",bg:"#1a1408",accent:"#b07040"},hospital:{filter:"saturate(0.5) brightness(1.1)",bg:"#141a1a",accent:"#60a0a0"},highrise:{filter:"saturate(0.4) contrast(1.2)",bg:"#12121a",accent:"#606080"},outpost:{filter:"sepia(0.4) hue-rotate(15deg)",bg:"#1a1508",accent:"#a08040"}};return t[e]||t.dungeon}getGridHTML(e){const t=this.getCellSize(e);return'\n            <div id="maze_grid" class="maze-grid" style="\n                display: grid;\n                grid-template-columns: repeat('.concat(e,", ").concat(t,'px);\n                gap: 0;\n                position: relative;\n            "></div>\n        ')}getPlayerOverlayHTML(e){return'\n            <div id="maze_player_overlay" class="maze-player-overlay" style="width: '.concat(e,"px; height: ").concat(e,'px;">\n                <div class="maze-player-marker"></div>\n            </div>\n        ')}render(e){const{grid:t,size:n,playerX:a,playerY:o,visited:i,exitX:s,exitY:r,isVictory:l,profile:c,currentFloor:d,totalFloors:m}=e,p=document.getElementById("maze_grid");if(!p)return;const u=this.getCellSize(n),h=(null==c?void 0:c.mapVisibility)||(!1===(null==c?void 0:c.fogOfWar)?"showAll":"fogOfWar");p.style.gridTemplateColumns="repeat(".concat(n,", ").concat(u,"px)"),p.innerHTML="";const g=this.getStyleCSS(null==c?void 0:c.mapStyle);p.style.filter=g.filter,p.style.backgroundColor=g.bg,p.style.setProperty("--map-accent",g.accent);const f="".concat(d,":");for(let e=0;e<n;e++)for(let g=0;g<n;g++){const n=t[e][g],v=document.createElement("div");v.className="maze-cell",v.style.width="".concat(u,"px"),v.style.height="".concat(u,"px");const b="".concat(f).concat(g,",").concat(e),y="".concat(g,",").concat(e),z=i.has(b)||i.has(y),x=g===a&&e===o,_=g===s&&e===r;let w=!1,k=!1;"showAll"===h?w=!0:"hideUnexplored"===h?(w=z||x,k=!z&&!x):w=z||x,k?v.classList.add("completely-hidden"):w?(v.classList.add("visited"),n.walls.top&&v.classList.add("wall-top"),n.walls.right&&v.classList.add("wall-right"),n.walls.bottom&&v.classList.add("wall-bottom"),n.walls.left&&v.classList.add("wall-left")):v.classList.add("hidden"),x&&v.classList.add("player");if(_&&w&&d===m-1&&(v.classList.add("exit"),l&&v.classList.add("victory-glow")),n.minion&&w&&(v.classList.add("has-minion"),n.minion.triggered&&v.classList.add("minion-triggered")),n.chest&&w&&(v.classList.add("has-chest"),"locked"===n.chest.type&&v.classList.add("chest-locked"),n.chest.opened&&v.classList.add("chest-opened"),null!=c&&c.chestImage&&!n.chest.opened)){v.classList.add("has-custom-chest");const e=document.createElement("img");e.src=Ee(c.chestImage),e.className="maze-chest-img",e.style.cssText="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 70%; height: 70%; object-fit: cover; border-radius: 3px; z-index: 1;","locked"===n.chest.type&&(e.style.filter="grayscale(50%)"),v.appendChild(e)}n.trap&&w&&(v.classList.add("has-trap"),n.trap.triggered&&v.classList.add("trap-triggered")),n.portal&&w&&(v.classList.add("has-portal"),v.dataset.portalColor=n.portal.color||"#9b59b6",v.style.setProperty("--portal-color",n.portal.color||"#9b59b6"),n.portal.bidirectional||n.portal.isStart||v.classList.add("portal-exit-only")),n.staircase&&w&&(v.classList.add("has-staircase"),v.classList.add("up"===n.staircase.direction?"staircase-up":"staircase-down"),n.staircase.requireKey&&v.classList.add("staircase-locked")),n.safeRoom&&!n.safeRoom.exhausted&&w&&v.classList.add("safe-room"),v.dataset.x=g,v.dataset.y=e,p.appendChild(v)}}updatePlayerPosition(e,t,n,a){const o=document.getElementById("maze_player_overlay");if(!o)return;const i=e*a,s=t*a;o.style.transition=n?"transform 0.15s ease-out":"none",o.style.transform="translate(".concat(i,"px, ").concat(s,"px)"),n||requestAnimationFrame((()=>{o.style.transition="transform 0.15s ease-out"}))}highlightCell(e,t,n){const a=document.querySelector('.maze-cell[data-x="'.concat(e,'"][data-y="').concat(t,'"]'));a&&a.classList.add("highlight-".concat(n))}clearHighlights(){document.querySelectorAll('.maze-cell[class*="highlight-"]').forEach((e=>{e.className=e.className.replace(/highlight-\w+/g,"").trim()}))}playEffect(e,t,n){const a=document.querySelector('.maze-cell[data-x="'.concat(e,'"][data-y="').concat(t,'"]'));a&&(a.classList.add("effect-".concat(n)),setTimeout((()=>{a.classList.remove("effect-".concat(n))}),500))}}function T(e){const t={fantasy:"#ef4444",horror:"#5a5a6a",scifi:"#06b6d4",cyberpunk:"#ec4899",western:"#92400e",action:"#dc2626",comedy:"#84cc16",postapoc:"#78716c"};return t[e]||t.fantasy}class B extends P{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super(e),this.canvas=null,this.ctx=null,this.sprites={},this.tileSize=e.tileSize||32}getType(){return"canvas"}getGridHTML(e){const t=e*this.tileSize;return'\n            <canvas id="maze_canvas" width="'.concat(t,'" height="').concat(t,'" style="\n                display: block;\n                image-rendering: pixelated;\n            "></canvas>\n        ')}getPlayerOverlayHTML(e){return""}async loadSprites(e){const t=Object.entries(e).map((async e=>{let[t,n]=e;const a=new Image;a.src=n,await new Promise(((e,t)=>{a.onload=e,a.onerror=t})),this.sprites[t]=a}));await Promise.all(t)}init(e,t){super.init(e,t),this.canvas=document.getElementById("maze_canvas"),this.canvas&&(this.ctx=this.canvas.getContext("2d"))}render(e){if(!this.ctx)return;const{grid:t,size:n,playerX:a,playerY:o,visited:i,exitX:s,exitY:r,profile:l,currentFloor:c,totalFloors:d}=e,m=this.tileSize,p=(null==l?void 0:l.mapVisibility)||(!1===(null==l?void 0:l.fogOfWar)?"showAll":"fogOfWar");this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);const u="".concat(c,":");for(let e=0;e<n;e++)for(let h=0;h<n;h++){const n=t[e][h],g="".concat(u).concat(h,",").concat(e),f="".concat(h,",").concat(e),v=i.has(g)||i.has(f),b=h===a&&e===o;let y=!1,z=!1;if("showAll"===p?y=!0:"hideUnexplored"===p?(y=v||b,z=!v&&!b):y=v||b,!z)if(y){this.sprites.floor?this.ctx.drawImage(this.sprites.floor,h*m,e*m,m,m):(this.ctx.fillStyle="#2d2d44",this.ctx.fillRect(h*m,e*m,m,m)),this.ctx.strokeStyle="#8b5cf6",this.ctx.lineWidth=2,n.walls.top&&(this.ctx.beginPath(),this.ctx.moveTo(h*m,e*m),this.ctx.lineTo((h+1)*m,e*m),this.ctx.stroke()),n.walls.right&&(this.ctx.beginPath(),this.ctx.moveTo((h+1)*m,e*m),this.ctx.lineTo((h+1)*m,(e+1)*m),this.ctx.stroke()),n.walls.bottom&&(this.ctx.beginPath(),this.ctx.moveTo(h*m,(e+1)*m),this.ctx.lineTo((h+1)*m,(e+1)*m),this.ctx.stroke()),n.walls.left&&(this.ctx.beginPath(),this.ctx.moveTo(h*m,e*m),this.ctx.lineTo(h*m,(e+1)*m),this.ctx.stroke());if(h===s&&e===r&&c===d-1&&(this.sprites.exit?this.ctx.drawImage(this.sprites.exit,h*m,e*m,m,m):(this.ctx.fillStyle="#22c55e",this.ctx.fillRect(h*m+4,e*m+4,m-8,m-8))),n.chest&&!n.chest.opened&&(this.sprites.chest?this.ctx.drawImage(this.sprites.chest,h*m,e*m,m,m):(this.ctx.fillStyle="#f59e0b",this.ctx.fillRect(h*m+6,e*m+6,m-12,m-12))),n.minion&&!n.minion.triggered){const t=T(null==l?void 0:l.theme);this.sprites.minion?this.ctx.drawImage(this.sprites.minion,h*m,e*m,m,m):(this.ctx.fillStyle=t,this.ctx.beginPath(),this.ctx.arc(h*m+m/2,e*m+m/2,m/4,0,2*Math.PI),this.ctx.fill())}}else this.ctx.fillStyle="#1a1a2e",this.ctx.fillRect(h*m,e*m,m,m)}this.sprites.player?this.ctx.drawImage(this.sprites.player,a*m,o*m,m,m):(this.ctx.fillStyle="#3b82f6",this.ctx.beginPath(),this.ctx.arc(a*m+m/2,o*m+m/2,m/3,0,2*Math.PI),this.ctx.fill())}updatePlayerPosition(e,t,n,a){}getCellSize(e){return this.tileSize}}const D={renderers:{"css-grid":I,canvas:B,isometric:class extends B{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super(e),this.tileWidth=e.tileWidth||64,this.tileHeight=e.tileHeight||32,this.wallHeight=e.wallHeight||24,this.spriteCache={},this.spritesLoaded=!1,this.spritesLoading=!1,this.currentMapStyle="dungeon",this.spritePaths=this.getSpritePathsForStyle(this.currentMapStyle),this.palette={floor:{top:"#3d3d5c",light:"#4a4a6a",dark:"#2d2d44"},wall:{top:"#6b5b95",light:"#8b7bb5",dark:"#4b3b75"},fog:{top:"#2a2a4e",light:"#3a3a6a",dark:"#1a1a3a"},exit:{top:"#22c55e",light:"#4ade80",dark:"#16a34a"},chest:{top:"#f59e0b",light:"#fbbf24",dark:"#d97706"},chestOpen:{top:"#78716c",light:"#a8a29e",dark:"#57534e"},minion:{top:"#ef4444",light:"#f87171",dark:"#dc2626"},trap:{top:"#a855f7",light:"#c084fc",dark:"#9333ea"},portal:{top:"#06b6d4",light:"#22d3ee",dark:"#0891b2"},stairUp:{top:"#10b981",light:"#34d399",dark:"#059669"},stairDown:{top:"#f97316",light:"#fb923c",dark:"#ea580c"},player:{top:"#3b82f6",light:"#60a5fa",dark:"#2563eb"},safeRoom:{top:"#2dd4bf",light:"#5eead4",dark:"#14b8a6"}}}getType(){return"isometric"}getSpritePathsForStyle(e){const t=e||"dungeon";return{floor:"assets/isometric/".concat(t,"/floor.png"),wall:"assets/isometric/".concat(t,"/wall.png"),wallCorner:"assets/isometric/".concat(t,"/wall_corner.png"),fog:"assets/isometric/".concat(t,"/fog.png"),exit:"assets/isometric/".concat(t,"/exit.png"),chest:"assets/isometric/".concat(t,"/chest_closed.png"),chestOpen:"assets/isometric/".concat(t,"/chest_open.png"),portal:"assets/isometric/".concat(t,"/portal.png"),trap:"assets/isometric/".concat(t,"/trap.png"),minion:"assets/isometric/".concat(t,"/minion.png"),player:"assets/isometric/".concat(t,"/player.png"),stairsUp:"assets/isometric/".concat(t,"/stairs_up.png"),stairsDown:"assets/isometric/".concat(t,"/stairs_down.png")}}setMapStyle(e){const t=e||"dungeon";t!==this.currentMapStyle&&(this.currentMapStyle=t,this.spritePaths=this.getSpritePathsForStyle(t),this.spriteCache={},this.spritesLoaded=!1,this.spritesLoading=!1,this.loadSprites())}getStyleTint(e){const t={dungeon:{r:40,g:30,b:50,a:.25},maze:{r:60,g:50,b:80,a:.3},forest:{r:20,g:100,b:40,a:.35},city:{r:80,g:90,b:100,a:.3},spacestation:{r:30,g:60,b:120,a:.4},college:{r:100,g:80,b:50,a:.25},apartment:{r:90,g:70,b:50,a:.3},neotokyo:{r:140,g:40,b:100,a:.4},arena:{r:120,g:60,b:30,a:.35},hospital:{r:60,g:100,b:100,a:.35},highrise:{r:50,g:50,b:70,a:.4},outpost:{r:100,g:80,b:40,a:.35}};return t[e]||t.dungeon}getThemeMinionFilter(e){const t={fantasy:"hue-rotate(0deg) saturate(1.2) brightness(1.0)",horror:"hue-rotate(270deg) saturate(0.4) brightness(0.7) contrast(1.3)",scifi:"hue-rotate(180deg) saturate(1.5) brightness(1.2)",cyberpunk:"hue-rotate(300deg) saturate(2.0) brightness(1.1) contrast(1.2)",western:"hue-rotate(30deg) saturate(0.8) sepia(0.5) brightness(1.0)",action:"hue-rotate(0deg) saturate(1.4) contrast(1.3) brightness(1.1)",comedy:"hue-rotate(60deg) saturate(2.0) brightness(1.3)",postapoc:"hue-rotate(20deg) saturate(0.5) sepia(0.4) brightness(0.8)"};return t[e]||t.fantasy}getThemeMinionPalette(e){const t={fantasy:{top:"#ef4444",light:"#f87171",dark:"#dc2626"},horror:{top:"#4a4a5a",light:"#6a6a7a",dark:"#2a2a3a"},scifi:{top:"#06b6d4",light:"#22d3ee",dark:"#0891b2"},cyberpunk:{top:"#ec4899",light:"#f472b6",dark:"#db2777"},western:{top:"#92400e",light:"#b45309",dark:"#78350f"},action:{top:"#dc2626",light:"#ef4444",dark:"#b91c1c"},comedy:{top:"#84cc16",light:"#a3e635",dark:"#65a30d"},postapoc:{top:"#78716c",light:"#a8a29e",dark:"#57534e"}};return t[e]||t.fantasy}getStyleFilter(e){const t={dungeon:"saturate(0.7) contrast(1.1)",maze:"saturate(0.8) hue-rotate(20deg)",forest:"saturate(1.4) hue-rotate(-20deg) brightness(1.1)",city:"saturate(0.6) contrast(1.2) brightness(0.9)",spacestation:"saturate(1.2) hue-rotate(200deg) brightness(1.1)",college:"saturate(0.9) sepia(0.3) brightness(1.1)",apartment:"saturate(0.8) sepia(0.2) contrast(1.05)",neotokyo:"saturate(1.5) hue-rotate(300deg) contrast(1.2) brightness(1.1)",arena:"saturate(1.3) hue-rotate(30deg) contrast(1.15)",hospital:"saturate(0.5) brightness(1.2) contrast(0.9)",highrise:"saturate(0.4) contrast(1.3) brightness(0.7)",outpost:"saturate(1.1) sepia(0.4) hue-rotate(15deg)"};return t[e]||t.dungeon}getStyleBackground(e){const t={dungeon:"#0a0815",maze:"#0d0a18",forest:"#050d05",city:"#0a0c10",spacestation:"#050812",college:"#0f0c08",apartment:"#0c0a08",neotokyo:"#0f050a",arena:"#100a05",hospital:"#080c0c",highrise:"#080810",outpost:"#0d0a06"};return t[e]||t.dungeon}async loadSprites(){if(this.spritesLoaded||this.spritesLoading)return;this.spritesLoading=!0;const e=Object.entries(this.spritePaths).map((async e=>{let[t,n]=e;try{const e=new Image;e.src="/scripts/extensions/third-party/SillyTavern-MazeMaster/"+n,await new Promise(((t,n)=>{e.onload=t,e.onerror=n})),this.spriteCache[t]=e}catch(e){console.warn("[MazeMaster] Failed to load sprite: ".concat(n))}}));await Promise.all(e),this.spritesLoaded=!0,this.spritesLoading=!1,console.log("[MazeMaster] Isometric sprites loaded:",Object.keys(this.spriteCache)),this.lastMazeState&&this.render(this.lastMazeState)}gridToIso(e,t){return{x:(e-t)*(this.tileWidth/2),y:(e+t)*(this.tileHeight/2)}}isoToGrid(e,t){const n=(e/(this.tileWidth/2)+t/(this.tileHeight/2))/2,a=(t/(this.tileHeight/2)-e/(this.tileWidth/2))/2;return{x:Math.floor(n),y:Math.floor(a)}}getGridHTML(e){const t=this.getCellSize(e),n=t/2,a=e*n+2*t+n;return'\n            <canvas id="maze_canvas" width="'.concat((e+1)*t,'" height="').concat(a,'" style="\n                display: block;\n                image-rendering: crisp-edges;\n                max-width: 100%;\n            "></canvas>\n        ')}getPlayerOverlayHTML(){return""}getCellSize(e){return e<=7?76:e<=10?64:e<=15?52:e<=20?44:36}init(e,t){var n;if(null!=t&&t.size){const e=this.getCellSize(t.size);this.tileWidth=e,this.tileHeight=e/2,this.wallHeight=.375*e}null!=t&&null!==(n=t.profile)&&void 0!==n&&n.mapStyle&&this.setMapStyle(t.profile.mapStyle),super.init(e,t),this.loadSprites()}drawSprite(e,t,n){let a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;const o=this.spriteCache[e];if(!o)return!1;const i=o.height/o.width,s=this.tileWidth*a,r=s*i,l=t-s/2,c=n+this.tileHeight/2-r;return this.ctx.drawImage(o,l,c,s,r),!0}drawSpriteDirectional(e,t,n){let a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"south";const i=this.spriteCache[e];if(!i)return!1;const s=i.height/i.width,r=this.tileWidth*a,l=r*s,c=t-r/2,d=n+this.tileHeight/2-l;return"west"===o||"north"===o?(this.ctx.save(),this.ctx.translate(t,d+l/2),this.ctx.scale(-1,1),this.ctx.translate(-t,-(d+l/2)),this.ctx.drawImage(i,c,d,r,l),this.ctx.restore()):this.ctx.drawImage(i,c,d,r,l),!0}render(e){if(!this.ctx&&(this.canvas=document.getElementById("maze_canvas"),this.canvas&&(this.ctx=this.canvas.getContext("2d")),!this.ctx))return;this.lastMazeState=e;const{grid:t,size:n,playerX:a,playerY:o,visited:i,exitX:s,exitY:r,isVictory:l,currentFloor:c,totalFloors:d,profile:m,playerDirection:p}=e,u=(null==m?void 0:m.mapVisibility)||(!1===(null==m?void 0:m.fogOfWar)?"showAll":"fogOfWar"),h=2*this.tileWidth,g=(n+1)*this.tileWidth,f=n*this.tileHeight+h+this.tileHeight;this.canvas.width===g&&this.canvas.height===f||(this.canvas.width=g,this.canvas.height=f);const v=this.getStyleBackground(null==m?void 0:m.mapStyle);this.ctx.fillStyle=v,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);const b=document.querySelector(".mazemaster-maze-area");b&&(b.style.backgroundColor=v);const y=this.getStyleFilter(null==m?void 0:m.mapStyle);this.ctx.filter=y;const z=this.canvas.width/2,x=h,_="".concat(c,":");for(let e=0;e<n;e++)for(let h=0;h<n;h++){const g=t[e][h],f="".concat(_).concat(h,",").concat(e),v="".concat(h,",").concat(e),b=i.has(f)||i.has(v),y=this.gridToIso(h,e),w=y.x+z,k=y.y+x,C=h===a&&e===o;let S=!1,M=!1;if("showAll"===u?S=!0:"hideUnexplored"===u?(S=b||C,M=!b&&!C):S=b||C,!M)if(S){this.drawSprite("floor",w,k)||this.drawIsoDiamond(w,k,this.palette.floor),g.safeRoom&&!g.safeRoom.exhausted&&this.drawSafeRoomIndicator(w,k),g.walls.left&&this.drawWallLeft(w,k,this.palette.wall),g.walls.top&&this.drawWallTop(w,k,this.palette.wall);const t=h>=n-1,a="".concat(_).concat(h+1,",").concat(e),o="".concat(h+1,",").concat(e),f=i.has(a)||i.has(o),v=!t&&("showAll"===u||f),b=e>=n-1,y="".concat(_).concat(h,",").concat(e+1),z="".concat(h,",").concat(e+1),x=i.has(y)||i.has(z),S=!b&&("showAll"===u||x);g.walls.right&&!v&&this.drawWallRight(w,k,this.palette.wall),g.walls.bottom&&!S&&this.drawWallBottom(w,k,this.palette.wall);if(h===s&&e===r&&c===d-1&&(this.drawSprite("exit",w,k,1)||this.drawIsoBlock(w,k-2,l?this.palette.stairUp:this.palette.exit,4)),g.staircase){const e="up"===g.staircase.direction?"stairsUp":"stairsDown";if(!this.drawSprite(e,w,k,1)){const e="up"===g.staircase.direction?this.palette.stairUp:this.palette.stairDown;this.drawIsoBlock(w,k-2,e,6),this.drawStairIcon(w,k-6,g.staircase.direction)}}if(g.portal&&(this.drawSprite("portal",w,k,.8)||this.drawPortal(w,k)),g.chest){const e=g.chest.opened?"chestOpen":"chest";if(!this.drawSprite(e,w,k,.8)){const e=g.chest.opened?this.palette.chestOpen:this.palette.chest;this.drawChest(w,k,e,g.chest.opened)}}if(g.trap&&!g.trap.triggered&&(this.drawSprite("trap",w,k,1)||this.drawTrap(w,k)),g.minion&&!g.minion.triggered){const e=(null==m?void 0:m.theme)||"fantasy";if(this.ctx.filter=this.getThemeMinionFilter(e),!this.drawSprite("minion",w,k,1)){const t=this.palette.minion;this.palette.minion=this.getThemeMinionPalette(e),this.drawMinion(w,k),this.palette.minion=t}this.ctx.filter="none"}if(C){const e=p||"south";this.drawSpriteDirectional("player",w,k,1.15,e)||this.drawPlayerDirectional(w,k,e),this.drawPlayerIndicator(w,k)}}else this.drawIsoBlock(w,k,this.palette.fog,4),this.ctx.fillStyle="#5a5a8a",this.ctx.font="bold ".concat(Math.floor(this.tileWidth/3),"px Arial"),this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("?",w,k-2)}this.ctx.filter="none";const w=this.getStyleTint(null==m?void 0:m.mapStyle);w.a>0&&(this.ctx.globalCompositeOperation="multiply",this.ctx.fillStyle="rgba(".concat(w.r+100,", ").concat(w.g+100,", ").concat(w.b+100,", ").concat(.6*w.a,")"),this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.globalCompositeOperation="overlay",this.ctx.fillStyle="rgba(".concat(w.r,", ").concat(w.g,", ").concat(w.b,", ").concat(.4*w.a,")"),this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.globalCompositeOperation="source-over")}drawIsoDiamond(e,t,n){const a=this.tileWidth/2,o=this.tileHeight/2;this.ctx.fillStyle=n.top,this.ctx.beginPath(),this.ctx.moveTo(e,t-o),this.ctx.lineTo(e+a,t),this.ctx.lineTo(e,t+o),this.ctx.lineTo(e-a,t),this.ctx.closePath(),this.ctx.fill()}drawIsoBlock(e,t,n){let a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:8;const o=this.tileWidth/2,i=this.tileHeight/2;this.ctx.fillStyle=n.dark,this.ctx.beginPath(),this.ctx.moveTo(e-o,t),this.ctx.lineTo(e,t+i),this.ctx.lineTo(e,t+i+a),this.ctx.lineTo(e-o,t+a),this.ctx.closePath(),this.ctx.fill(),this.ctx.fillStyle=n.light,this.ctx.beginPath(),this.ctx.moveTo(e+o,t),this.ctx.lineTo(e,t+i),this.ctx.lineTo(e,t+i+a),this.ctx.lineTo(e+o,t+a),this.ctx.closePath(),this.ctx.fill(),this.drawIsoDiamond(e,t,n)}drawWallLeft(e,t,n){const a=this.tileWidth/2,o=this.tileHeight/2,i=this.wallHeight;this.ctx.fillStyle=n.dark,this.ctx.beginPath(),this.ctx.moveTo(e-a,t),this.ctx.lineTo(e-a,t-i),this.ctx.lineTo(e,t-o-i),this.ctx.lineTo(e,t-o),this.ctx.closePath(),this.ctx.fill(),this.ctx.fillStyle=n.top,this.ctx.fillRect(e-a-1,t-i-2,4,4)}drawWallTop(e,t,n){const a=this.tileWidth/2,o=this.tileHeight/2,i=this.wallHeight;this.ctx.fillStyle=n.light,this.ctx.beginPath(),this.ctx.moveTo(e,t-o),this.ctx.lineTo(e,t-o-i),this.ctx.lineTo(e+a,t-i),this.ctx.lineTo(e+a,t),this.ctx.closePath(),this.ctx.fill(),this.ctx.fillStyle=n.top,this.ctx.fillRect(e+a-2,t-i-2,4,4)}drawWallRight(e,t,n){const a=this.tileWidth/2,o=this.tileHeight/2,i=this.wallHeight;this.ctx.fillStyle=n.light,this.ctx.beginPath(),this.ctx.moveTo(e+a,t),this.ctx.lineTo(e+a,t-i),this.ctx.lineTo(e,t+o-i),this.ctx.lineTo(e,t+o),this.ctx.closePath(),this.ctx.fill(),this.ctx.fillStyle=n.top,this.ctx.fillRect(e+a-2,t-i-2,4,4)}drawWallBottom(e,t,n){const a=this.tileWidth/2,o=this.tileHeight/2,i=this.wallHeight;this.ctx.fillStyle=n.dark,this.ctx.beginPath(),this.ctx.moveTo(e,t+o),this.ctx.lineTo(e,t+o-i),this.ctx.lineTo(e-a,t-i),this.ctx.lineTo(e-a,t),this.ctx.closePath(),this.ctx.fill(),this.ctx.fillStyle=n.top,this.ctx.fillRect(e-a-1,t-i-2,4,4)}drawPlayer(e,t){const n=this.palette.player,a=this.tileWidth/5;this.ctx.fillStyle="rgba(0,0,0,0.3)",this.ctx.beginPath(),this.ctx.ellipse(e,t+2,a,a/2,0,0,2*Math.PI),this.ctx.fill();const o=this.ctx.createRadialGradient(e-a/3,t-a-a/2,0,e,t-a/2,1.5*a);o.addColorStop(0,n.light),o.addColorStop(.5,n.top),o.addColorStop(1,n.dark),this.ctx.fillStyle=o,this.ctx.beginPath(),this.ctx.arc(e,t-a/2,a,0,2*Math.PI),this.ctx.fill(),this.ctx.fillStyle="rgba(255,255,255,0.4)",this.ctx.beginPath(),this.ctx.arc(e-a/3,t-a,a/4,0,2*Math.PI),this.ctx.fill()}drawPlayerDirectional(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"south";const a=this.palette.player,o=this.tileWidth/5;this.ctx.fillStyle="rgba(0,0,0,0.3)",this.ctx.beginPath(),this.ctx.ellipse(e,t+2,o,o/2,0,0,2*Math.PI),this.ctx.fill();const i=this.ctx.createRadialGradient(e-o/3,t-o-o/2,0,e,t-o/2,1.5*o);i.addColorStop(0,a.light),i.addColorStop(.5,a.top),i.addColorStop(1,a.dark),this.ctx.fillStyle=i,this.ctx.beginPath(),this.ctx.arc(e,t-o/2,o,0,2*Math.PI),this.ctx.fill();const s="west"===n||"north"===n?o/3:-o/3;this.ctx.fillStyle="rgba(255,255,255,0.4)",this.ctx.beginPath(),this.ctx.arc(e+s,t-o,o/4,0,2*Math.PI),this.ctx.fill();const r={north:{dx:0,dy:1.3*-o},south:{dx:0,dy:.3*o},east:{dx:.9*o,dy:.4*-o},west:{dx:.9*-o,dy:.4*-o}},l=r[n]||r.south;this.ctx.fillStyle=a.light,this.ctx.beginPath(),this.ctx.arc(e+l.dx,t-o/2+l.dy,o/6,0,2*Math.PI),this.ctx.fill()}drawChest(e,t,n,a){const o=this.tileWidth/3,i=this.tileHeight/2;this.ctx.fillStyle=n.dark,this.ctx.fillRect(e-o/2,t-i,o,i),this.ctx.fillStyle=n.top,this.ctx.fillRect(e-o/2,t-i,o,i/3),a?(this.ctx.fillStyle=n.light,this.ctx.fillRect(e-o/2,t-i-4,o,4)):(this.ctx.fillStyle="#ffd700",this.ctx.fillRect(e-2,t-i/2-2,4,4))}drawMinion(e,t){const n=this.palette.minion,a=this.tileWidth/6;this.ctx.fillStyle="rgba(0,0,0,0.3)",this.ctx.beginPath(),this.ctx.ellipse(e,t+2,a,a/2,0,0,2*Math.PI),this.ctx.fill(),this.ctx.fillStyle=n.top,this.ctx.beginPath(),this.ctx.arc(e,t-a/2,a,0,2*Math.PI),this.ctx.fill(),this.ctx.fillStyle="#fff",this.ctx.beginPath(),this.ctx.arc(e-3,t-a/2,2,0,2*Math.PI),this.ctx.arc(e+3,t-a/2,2,0,2*Math.PI),this.ctx.fill()}drawPlayerIndicator(e,t){const n=Date.now()/300,a=4*Math.sin(n),o=t-this.tileHeight-25+a,i=Ye,s=i?"#f97316":"#3b82f6",r=i?"#fb923c":"#60a5fa",l=i?"#fdba74":"#93c5fd";this.ctx.save(),this.ctx.shadowColor=s,this.ctx.shadowBlur=i?15+5*Math.sin(2*n):10;this.ctx.fillStyle=r,this.ctx.beginPath(),this.ctx.moveTo(e,o+16),this.ctx.lineTo(e-8,o+8),this.ctx.lineTo(e,o),this.ctx.lineTo(e+8,o+8),this.ctx.closePath(),this.ctx.fill(),this.ctx.fillStyle=l,this.ctx.beginPath(),this.ctx.moveTo(e,o+12),this.ctx.lineTo(e-4,o+8),this.ctx.lineTo(e,o+4),this.ctx.lineTo(e+4,o+8),this.ctx.closePath(),this.ctx.fill(),this.ctx.restore(),this._animationFrame||(this._animationFrame=requestAnimationFrame((()=>{this._animationFrame=null,this.lastMazeState&&this.render(this.lastMazeState)})))}drawTrap(e,t){const n=this.palette.trap;this.ctx.fillStyle=n.top;for(let n=-1;n<=1;n++)this.ctx.beginPath(),this.ctx.moveTo(e+6*n-2,t),this.ctx.lineTo(e+6*n,t-6),this.ctx.lineTo(e+6*n+2,t),this.ctx.fill()}drawSafeRoomIndicator(e,t){const n=this.palette.safeRoom,a=this.tileWidth/2,o=this.tileHeight/2,i=this.ctx.createRadialGradient(e,t,0,e,t,a);i.addColorStop(0,n.light+"aa"),i.addColorStop(.6,n.top+"66"),i.addColorStop(1,"transparent"),this.ctx.fillStyle=i,this.ctx.beginPath(),this.ctx.moveTo(e,t-o),this.ctx.lineTo(e+a,t),this.ctx.lineTo(e,t+o),this.ctx.lineTo(e-a,t),this.ctx.closePath(),this.ctx.fill(),this.ctx.fillStyle=n.top,this.ctx.font="bold ".concat(Math.floor(this.tileWidth/4),"px Arial"),this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.ctx.fillText("",e,t-2)}drawPortal(e,t){const n=this.palette.portal,a=this.tileWidth/4,o=this.ctx.createRadialGradient(e,t-a/2,0,e,t-a/2,1.5*a);o.addColorStop(0,n.light),o.addColorStop(.5,n.top+"88"),o.addColorStop(1,"transparent"),this.ctx.fillStyle=o,this.ctx.beginPath(),this.ctx.arc(e,t-a/2,1.5*a,0,2*Math.PI),this.ctx.fill(),this.ctx.fillStyle=n.top,this.ctx.beginPath(),this.ctx.arc(e,t-a/2,a/2,0,2*Math.PI),this.ctx.fill()}drawStairIcon(e,t,n){this.ctx.fillStyle="#fff",this.ctx.font="bold 12px Arial",this.ctx.textAlign="center",this.ctx.fillText("up"===n?"":"",e,t)}updatePlayerPosition(e,t,n,a){}}},currentRenderer:null,currentType:"isometric",register(e,t){this.renderers[e]=t},create(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const n=this.renderers[e];return n?new n(t):(console.warn("[MazeMaster] Unknown renderer type: ".concat(e,", falling back to css-grid")),new I(t))},getRenderer(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return!t&&void 0!==Re&&null!==(e=Re)&&void 0!==e&&e.rendererType&&(t=Re.rendererType),t&&t!==this.currentType&&(this.currentRenderer&&this.currentRenderer.cleanup(),this.currentType=t,this.currentRenderer=this.create(t)),this.currentRenderer||(this.currentRenderer=this.create(this.currentType)),this.currentRenderer},getAvailableTypes(){return Object.keys(this.renderers)}};function L(){var e;const t=(null===(e=Re)||void 0===e?void 0:e.layoutMode)||"desktop";return"auto"===t?function(){const e=window.innerWidth;return window.innerHeight>e||e<768?"mobile":"desktop"}():t}function R(){const e=document.getElementById("mazemaster_maze_modal");if(!e)return;const t=L();e.classList.remove("layout-mobile","layout-desktop"),e.classList.add("layout-".concat(t));const n=e.querySelector(".maze-modal-container");n&&(n.classList.remove("layout-mobile","layout-desktop"),n.classList.add("layout-".concat(t)))}"undefined"!=typeof window&&window.addEventListener("resize",(()=>{var e;"auto"===(null===(e=Re)||void 0===e?void 0:e.layoutMode)&&R()}));const A={difficulty:"normal",theme:"fantasy",mapStyle:"maze",floors:1,mapVisibility:"fogOfWar",onMove:"",onMilestone:"",onExploreComplete:"",onItemAdd:"",onItemRemove:"",onChestOpen:"",onTrade:"",onEnemyMove:"",onTeleport:"",onObjectiveProgress:"",onObjectiveComplete:"",onAllObjectivesComplete:"",onDifficultySet:"",onStatUpdate:"",portals:[],objectives:[],hpEnabled:!0,maxHP:100,battlebarDamageMultiplier:1,battlebarDifficultyMultiplier:1,onDeath:"respawn",respawnHPPercent:50,safeRoomCount:3,safeRoomHealPercent:100,safeRoomUseLLM:!1,restEnabled:!0,restHealPercent:20,restCooldown:3,restInterruptChance:0,restInterruptScript:"",onDamage:"",onHeal:"",onPlayerDeath:"",fairness:{enabled:!0,keyPityThreshold:3,healingPityThreshold:4,lowHpThreshold:.4,mercyUnlock:!0,mercyUnlockThreshold:2},llmEnhanceRooms:!0,llmRoomPrompt:"Describe this {{roomType}} room in 1-2 vivid sentences. Theme: {{theme}}. Context: {{sessionNotes}}"};async function O(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e4;if(!e||"string"!=typeof e||""===e.trim())return null;try{const n=new Promise(((e,n)=>{setTimeout((()=>n(new Error("STScript timed out after ".concat(t,"ms")))),t)}));return await Promise.race([d(e),n])}catch(t){var n;return null!==(n=t.message)&&void 0!==n&&n.includes("timed out")?console.warn("[MazeMaster] STScript timed out: ".concat(e.substring(0,50),"...")):console.error("[MazeMaster] STScript error:",t),null}}async function H(e){var t;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const a=null===(t=Ge)||void 0===t?void 0:t.profile;if(!a)return;let o=a[e];if(o&&"string"==typeof o&&o.trim()){for(const[e,t]of Object.entries(n))o=o.replaceAll("{{".concat(e,"}}"),String(t));await O(o)}}function N(e){const t="string"==typeof e?e:(null==e?void 0:e.difficulty)||"normal";return w[t]||w.normal}function q(e){const t=N(e).hpMult||1,n=e.maxHP||100,a=Math.round(n*t);return{current:a,max:a,maxBonus:0,reviveCharges:0}}async function F(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"unknown";if(!Ge.hpEnabled||!Ge.hp)return!0;const n=Ge.hp.current;if(Ge.hp.current=Math.max(0,Ge.hp.current-e),U(),G(),function(){const e=document.createElement("div");e.className="maze-hp-flash damage",document.body.appendChild(e),setTimeout((()=>e.remove()),300)}(),await H("onDamage",{amount:e,source:t,previousHP:n,currentHP:Ge.hp.current,maxHP:Ge.hp.max+Ge.hp.maxBonus}),Oa("Combat","Took ".concat(e," damage! (").concat(Ge.hp.current,"/").concat(Ge.hp.max+Ge.hp.maxBonus," HP)")),Ge.hp.current<=0)return await async function(e){var t,n,a;if(console.log("[MazeMaster] handlePlayerDeath called, source:",e),Ge.hp.reviveCharges>0){Ge.hp.reviveCharges--;const t=Ge.hp.max+Ge.hp.maxBonus;return Ge.hp.current=Math.round(.25*t),U(),Oa("Revival","Your Revival Charm activates! You cheat death..."),Aa("Revival charm activated! Cheated death from ".concat(e),"Death"),void console.log("[MazeMaster] Revival charm used, HP restored")}Aa("DEATH: Killed by ".concat(e),"Death"),await H("onPlayerDeath",{source:e});const o=(null===(t=Ge.profile)||void 0===t?void 0:t.onDeath)||"respawn";switch(console.log("[MazeMaster] Death action:",o,"Profile onDeath:",null===(n=Ge.profile)||void 0===n?void 0:n.onDeath),o){case"respawn":console.log("[MazeMaster] Respawning player"),await W(100);break;case"respawnPenalty":const e=(null===(a=Ge.profile)||void 0===a?void 0:a.respawnHPPercent)||50;console.log("[MazeMaster] Respawning with penalty:",e+"%"),await W(e);break;default:console.log("[MazeMaster] Game over triggered"),vo()}}(t),!1;const a=Ge.hp.max+Ge.hp.maxBonus;return Ge.hp.current<=.25*a&&n>.25*a&&Oa("Warning","Your health is critically low!"),!0}async function j(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"unknown";if(!Ge.hpEnabled||!Ge.hp)return;const a=N(Ge.profile).healMult||1,o=Ge.hp.max+Ge.hp.maxBonus;let i=t?Math.round(e/100*o*a):Math.round(e*a);const s=Ge.hp.current;Ge.hp.current=Math.min(o,Ge.hp.current+i);const r=Ge.hp.current-s;U(),G(),r>0&&function(){const e=document.createElement("div");e.className="maze-hp-flash heal",document.body.appendChild(e),setTimeout((()=>e.remove()),300)}(),await H("onHeal",{amount:r,source:n,previousHP:s,currentHP:Ge.hp.current,maxHP:o}),r>0&&Oa("Healing","Restored ".concat(r," HP! (").concat(Ge.hp.current,"/").concat(o," HP)"))}async function W(e){Ge.playerX=0,Ge.playerY=0,Ge.isPaused=!1,Ge.pendingEncounter=null,Ge.pendingConfirmation=null;const t=Ge.hp.max+Ge.hp.maxBonus;Ge.hp.current=Math.round(t*(e/100)),U(),Ra(),ce(),Oa("Respawn","Returned to the start with ".concat(e,"% HP...")),setTimeout((()=>{"function"==typeof window.mazeCenterOnPlayer&&window.mazeCenterOnPlayer(!0)}),100);const n=Ge.profile;if(null!=n&&n.mainMinion){const e=St(n.mainMinion);e&&(Ge.currentMinion={name:e.name,imagePath:e.imagePath,message:"Back to the beginning with you!"},Na())}}async function Y(){var e,t,n;if(!Ge.isOpen||Ge.isPaused||Ge.isVictory)return;if(!Ge.hpEnabled||!Ge.hp)return;const a=Ge.profile||{};if(!a.restEnabled)return;if((Ge.restCooldown||0)>0)return void Oa("Rest","Cannot rest yet. Wait ".concat(Ge.restCooldown," more turn(s)."));const o=Ge.hp.max+(Ge.hp.maxBonus||0);if(Ge.hp.current>=o)return void Oa("Rest","You are already at full health.");await Z("moves",1);const i=null!==(e=a.restInterruptChance)&&void 0!==e?e:0;if(i>0){const e=100*Math.random();var s;if(e<i)return console.log("[MazeMaster] Rest interrupted (rolled ".concat(e.toFixed(1)," vs ").concat(i,"%)")),Ge.restCooldown=null!==(s=a.restCooldown)&&void 0!==s?s:3,G(),void(a.restInterruptScript&&a.restInterruptScript.trim()?(Oa("Interrupted!","Your rest is disturbed!"),await O(a.restInterruptScript)):await async function(){const e=Ge.profile||{},t=e.minionEncounters||[];if(0===t.length)return void Oa("Interrupted!","Something disturbs your rest, but nothing appears...");const n=t[Math.floor(Math.random()*t.length)].minionId;n?(Oa("Ambush!","You are caught off guard while resting!"),await Ya(n,Ge.playerX,Ge.playerY)):Oa("Interrupted!","Your rest is disturbed by strange noises...")}())}const r=null!==(t=a.restHealPercent)&&void 0!==t?t:20;await j(r,!0,"rest"),Ge.restCooldown=null!==(n=a.restCooldown)&&void 0!==n?n:3,G(),Oa("Rest","You take a moment to rest and recover ".concat(r,"% HP."))}function G(){var e,t,n;const a=document.getElementById("maze_rest_btn");if(!a)return;const o=Ge.profile||{};if(!Ge.hpEnabled||!o.restEnabled)return void(a.style.display="none");a.style.display="flex";const i=Ge.restCooldown||0,s=(null===(e=Ge.hp)||void 0===e?void 0:e.max)||100,r=(null===(t=Ge.hp)||void 0===t?void 0:t.maxBonus)||0,l=((null===(n=Ge.hp)||void 0===n?void 0:n.current)||0)>=s+r,c=i>0;if(a.disabled=c||l||Ge.isPaused,l)a.title="Already at full HP";else if(c)a.title="Rest available in ".concat(i," turn(s)");else{var d;const e=null!==(d=o.restHealPercent)&&void 0!==d?d:20;a.title="Rest to recover ".concat(e,"% HP")}const m=a.querySelector(".rest-cooldown-badge");m&&(c?(m.style.display="flex",m.textContent=i):m.style.display="none")}function U(){if(!Ge.hpEnabled||!Ge.hp)return;const e=document.getElementById("maze_hp_current"),t=document.getElementById("maze_hp_max"),n=document.getElementById("maze_hp_bar"),a=document.querySelector(".mazemaster-maze-container"),o=document.getElementById("maze_hp_overlay"),i=Ge.hp.current,s=Ge.hp.max+Ge.hp.maxBonus,r=Math.round(i/s*100);e&&(e.textContent=i),t&&(t.textContent=s),n&&(n.style.width="".concat(r,"%"),n.classList.remove("low","medium","high"),r<=25?n.classList.add("low"):r<=50?n.classList.add("medium"):n.classList.add("high")),o&&(o.style.display=Ge.hpEnabled?"":"none"),a&&(r<=25?a.classList.add("low-hp"):a.classList.remove("low-hp"))}async function K(e){if(Ge.hpEnabled&&Ge.hp&&Ge.inventory[e]&&!(Ge.inventory[e]<=0))switch(e){case"healingPotion":await Xa("healingPotion"),await j(25,!0,"potion");break;case"greaterHealing":await Xa("greaterHealing"),await j(50,!0,"potion");break;case"elixir":await Xa("elixir"),await j(100,!0,"elixir");break;case"heartCrystal":await Xa("heartCrystal"),await async function(e){Ge.hpEnabled&&Ge.hp&&(Ge.hp.maxBonus+=e,Ge.hp.current+=e,U(),Oa("Power Up","Max HP increased by ".concat(e,"!")))}(10);break;case"revivalCharm":Ge.hp.reviveCharges++,await Xa("revivalCharm"),Oa("Item","Revival Charm ready. You will cheat death once.")}}function V(e,t,n,a,o){var i,s;const r=null===(i=o[t])||void 0===i?void 0:i[e],l=null===(s=o[a])||void 0===s?void 0:s[n];if(!r)return!0;const c=n-e,d=a-t;if(1===c&&r.walls.right)return!0;if(-1===c&&r.walls.left)return!0;if(1===d&&r.walls.bottom)return!0;if(-1===d&&r.walls.top)return!0;if(l){if(1===c&&l.walls.left)return!0;if(-1===c&&l.walls.right)return!0;if(1===d&&l.walls.top)return!0;if(-1===d&&l.walls.bottom)return!0}return!1}function X(e,t,n,a,o){if(e===n&&t===a)return!0;const i=n-e,s=a-t,r=Math.abs(i),l=Math.abs(s),c=i>0?1:i<0?-1:0,d=s>0?1:s<0?-1:0;if(0===i||0===s){let i=e,s=t;for(;i!==n||s!==a;){const e=i+c,t=s+d;if(V(i,s,e,t,o))return!1;i=e,s=t}return!0}let m=e,p=t,u=r-l;for(;m!==n||p!==a;){const e=2*u;let t=m,n=p,a=!1,i=!1;if(e>-l&&(u-=l,t+=c,a=!0),e<r&&(u+=r,n+=d,i=!0),a&&i){const e=V(m,p,m+c,p,o)||V(m+c,p,t,n,o),a=V(m,p,m,p+d,o)||V(m,p+d,t,n,o);if(e&&a)return!1}else if(a){if(V(m,p,t,n,o))return!1}else if(i&&V(m,p,t,n,o))return!1;m=t,p=n}return!0}function J(e,t,n){var a;if(!Ge.isOpen)return;const o=function(){var e;if(!Ge.isOpen)return 1;const t=Ge.visibility||{baseRadius:1,tempBonus:0,permBonus:0},n=((null===(e=Ge.inventory)||void 0===e?void 0:e.lantern)||0)>0?1:0;return t.baseRadius+t.tempBonus+t.permBonus+n}(),i="".concat(Ge.currentFloor,":"),s=null===(a=Ge.floorsData)||void 0===a?void 0:a[Ge.currentFloor],r=(null==s?void 0:s.grid)||Ge.grid;if(r)for(let a=Math.max(0,t-o);a<=Math.min(n-1,t+o);a++)for(let s=Math.max(0,e-o);s<=Math.min(n-1,e+o);s++)Math.abs(s-e)+Math.abs(a-t)<=o&&X(e,t,s,a,r)&&Ge.visited.add("".concat(i).concat(s,",").concat(a))}function Q(){try{var e;const t=SillyTavern.getContext();return(null==t?void 0:t.name1)||(null==t?void 0:t.persona)||(null==t||null===(e=t.user_avatar)||void 0===e?void 0:e.replace(/\.[^/.]+$/,""))||"Default User"}catch(e){return console.warn("[MazeMaster] Could not get persona name:",e),"Default User"}}async function Z(e){var t;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;null!==(t=Ge)&&void 0!==t&&t.stats&&"number"==typeof Ge.stats[e]&&(Ge.stats[e]+=n,te(),await H("onStatUpdate",{statName:e,value:Ge.stats[e]}))}function $(){var e;if(null===(e=Ge)||void 0===e||null===(e=e.stats)||void 0===e||!e.startTime)return"0:00";const t=Math.floor((Date.now()-Ge.stats.startTime)/1e3),n=Math.floor(t/3600),a=Math.floor(t%3600/60),o=t%60;return n>0?"".concat(n,":").concat(a.toString().padStart(2,"0"),":").concat(o.toString().padStart(2,"0")):"".concat(a,":").concat(o.toString().padStart(2,"0"))}function ee(){var e,t;if(null===(e=Ge)||void 0===e||!e.visited||null===(t=Ge)||void 0===t||!t.size)return 0;const n=Ge.totalFloors||1,a=Ge.size*Ge.size*n;return Math.floor(Ge.visited.size/a*100)}function te(){var e;const t=document.getElementById("maze_stat_moves"),n=document.getElementById("maze_stat_time"),a=document.getElementById("maze_stat_explore");t&&(t.textContent=(null===(e=Ge)||void 0===e||null===(e=e.stats)||void 0===e?void 0:e.moves)||0),n&&(n.textContent=$()),a&&(a.textContent="".concat(ee(),"%")),function(){var e;const t=document.getElementById("maze_zone_display"),n=document.getElementById("maze_zone_name"),a=document.getElementById("maze_zone_progress");if(!t)return;const o=function(){var e,t;if(!Ge||!Ge.floorsData)return null;const n=Ge.floorsData[Ge.currentFloor];if(!n||!n.zones)return null;const a=null===(e=Ge.grid[Ge.playerY])||void 0===e?void 0:e[Ge.playerX],o=null!==(t=null==a?void 0:a.zoneId)&&void 0!==t?t:0,i=n.zones[o];if(!i)return null;const s=n.rooms.filter((e=>e.zoneId===o)),r=s.filter((e=>e.isCleared)).length,l=n.zones.find((e=>!e.isUnlocked));let c=null;if(l){const e=l.unlockCondition;if("clear"===(null==e?void 0:e.type)){const t=n.rooms.filter((t=>{var n;return t.zoneId===(null!==(n=e.targetZoneId)&&void 0!==n?n:l.id-1)})).filter((e=>e.isCleared)).length;c="Clear ".concat(e.requiredClears-t," more room(s) to unlock ").concat(l.name)}}return{zoneName:i.name,zoneId:o,totalRooms:s.length,clearedRooms:r,isUnlocked:i.isUnlocked,unlockHint:c}}();if(!o||null===(e=Ge.floorsData)||void 0===e||null===(e=e[Ge.currentFloor])||void 0===e||null===(e=e.zones)||void 0===e||!e.length)return void(t.style.display="none");if(Ge.floorsData[Ge.currentFloor].zones.length<=1)return void(t.style.display="none");t.style.display="",n&&(n.textContent=o.zoneName||"Zone ".concat(o.zoneId+1));a&&(o.unlockHint?(a.textContent="(".concat(o.clearedRooms,"/").concat(o.totalRooms,")"),a.title=o.unlockHint):(a.textContent="(".concat(o.clearedRooms,"/").concat(o.totalRooms,")"),a.title=""))}()}function ne(e,t,n,a,o){e.profileStats||(e.profileStats={});const i=e.profileStats[t]||{totalGames:0,wins:0,losses:0,bestTime:null,totalMoves:0};i.totalGames++,"win"===n?(i.wins++,(null===i.bestTime||a<i.bestTime)&&(i.bestTime=a)):i.losses++,i.totalMoves+=o,e.profileStats[t]=i,e.totalGames=(e.totalGames||0)+1,"win"===n?(e.wins=(e.wins||0)+1,(null===e.bestTime||a<e.bestTime)&&(e.bestTime=a)):e.losses=(e.losses||0)+1,e.totalMoves=(e.totalMoves||0)+o}function ae(e){var n,a;if(null===(n=Ge)||void 0===n||!n.profileName||null===(a=Ge)||void 0===a||!a.stats)return;const o=Ge.profileName,s=Q(),r=Date.now()-Ge.stats.startTime,l=Ge.stats.moves;Re.mazeStats||(Re.mazeStats={global:{totalGames:0,wins:0,losses:0,bestTime:null,totalMoves:0,profileStats:{}},personas:{}}),Re.mazeStats.global||function(){if(!Re.mazeStats)return;if(Re.mazeStats.global)return;const e=Re.mazeStats.profileStats||{};Re.mazeStats={global:{totalGames:0,wins:0,losses:0,bestTime:null,totalMoves:0,profileStats:t({},e)},personas:{}};for(const t in e){const n=e[t];Re.mazeStats.global.totalGames+=n.totalGames||0,Re.mazeStats.global.wins+=n.wins||0,Re.mazeStats.global.losses+=n.losses||0,Re.mazeStats.global.totalMoves+=n.totalMoves||0,null!==n.bestTime&&(null===Re.mazeStats.global.bestTime||n.bestTime<Re.mazeStats.global.bestTime)&&(Re.mazeStats.global.bestTime=n.bestTime)}console.log("[MazeMaster] Migrated stats to new global/persona format"),i()}(),ne(Re.mazeStats.global,o,e,r,l),Re.mazeStats.personas[s]||(Re.mazeStats.personas[s]={totalGames:0,wins:0,losses:0,bestTime:null,totalMoves:0,profileStats:{}}),ne(Re.mazeStats.personas[s],o,e,r,l),i()}let oe=null;function ie(){oe&&(clearInterval(oe),oe=null)}function se(e){const t=function(e){const t=(null==e?void 0:e.theme)||"fantasy",n=k[t]||k.fantasy;return(null==n?void 0:n.colors)||{primary:"#2ecc71",secondary:"#27ae60",accent:"#f1c40f"}}(e),n=document.querySelector(".mazemaster-maze-container");n&&(n.style.setProperty("--theme-primary",t.primary),n.style.setProperty("--theme-secondary",t.secondary),n.style.setProperty("--theme-accent",t.accent))}function re(){const e=document.getElementById("maze_dpad");if(!e||!e.classList.contains("floating"))return;const t=e.querySelector(".dpad-drag-handle");if(!t)return;let n=!1,a=0,o=0;const s=(t,i)=>{n=!0,a=t-e.offsetLeft,o=i-e.offsetTop,e.style.cursor="grabbing"},r=(t,i)=>{if(!n)return;const s=Math.max(0,Math.min(window.innerWidth-e.offsetWidth,t-a)),r=Math.max(0,Math.min(window.innerHeight-e.offsetHeight,i-o));e.style.left="".concat(s,"px"),e.style.top="".concat(r,"px"),e.style.right="auto",e.style.bottom="auto"},l=()=>{n&&(n=!1,e.style.cursor="",Re.dpadConfig||(Re.dpadConfig={enabled:!0,floating:!0,position:{}}),Re.dpadConfig.position={x:e.offsetLeft,y:e.offsetTop},i())};t.addEventListener("mousedown",(e=>{e.preventDefault(),s(e.clientX,e.clientY)})),document.addEventListener("mousemove",(e=>r(e.clientX,e.clientY))),document.addEventListener("mouseup",l),t.addEventListener("touchstart",(e=>{const t=e.touches[0];s(t.clientX,t.clientY)})),document.addEventListener("touchmove",(e=>{if(!n)return;const t=e.touches[0];r(t.clientX,t.clientY)})),document.addEventListener("touchend",l)}function le(){var e;const t=document.getElementById("maze_grid_container"),n=document.querySelector(".mazemaster-maze-area");if(!t||!n)return;const a=(null===(e=Ge)||void 0===e?void 0:e.size)||10;let o;o=a<=7?76:a<=10?64:a<=15?52:a<=20?44:36;const i=64/o*1.5;let s=i,r=0,l=0,c=!1,d=0,m=0,p=0,u=i;const h=function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];t.style.transition=e?"transform 0.3s ease-out":"none",t.style.transform="translate(".concat(r,"px, ").concat(l,"px) scale(").concat(s,")"),t.style.transformOrigin="0 0"},g=function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const a=t.querySelector(".player-marker, .maze-cell.current"),o=t.querySelector("canvas"),i=n.getBoundingClientRect();if(a){const n=a.getBoundingClientRect(),o=t.getBoundingClientRect(),c=n.left+n.width/2-o.left,d=n.top+n.height/2-o.top,m=i.width/2,p=i.height/2;r=m-c*s,l=p-d*s,h(e)}else if(o){const t=(e=>{if(!Ge||void 0===Ge.playerX)return null;const t=Ge.size||10;let n;n=t<=7?76:t<=10?64:t<=15?52:t<=20?44:36;const a=n/2,o=2*n,i=Ge.playerX,s=Ge.playerY,r=(i+s)*(a/2);return{x:n/2*(i-s)+e.width/2,y:r+o}})(o);if(t){const n=i.width/2,a=i.height/2;r=n-t.x*s,l=a-t.y*s,h(e)}else{const t=o.height,n=i.height;l=(n-t*s)/2+t*s*.45,h(e)}}};window.mazeCenterOnPlayer=function(){return g(!(arguments.length>0&&void 0!==arguments[0])||arguments[0])},setTimeout((()=>g(!1)),50),setTimeout((()=>g(!1)),150),setTimeout((()=>g(!1)),300),n.addEventListener("wheel",(e=>{e.preventDefault();const t=e.deltaY>0?.9:1.1;s=Math.max(.5,Math.min(4,s*t)),g(!1)}),{passive:!1}),n.addEventListener("mousedown",(e=>{e.target.closest(".maze-cell, canvas")&&(c=!0,d=e.clientX-r,m=e.clientY-l,n.style.cursor="grabbing",t.style.transition="none")})),document.addEventListener("mousemove",(e=>{c&&(r=e.clientX-d,l=e.clientY-m,h(!1))})),document.addEventListener("mouseup",(()=>{c=!1,n.style.cursor=""}));const f=e=>{if(e.length<2)return 0;const t=e[0].clientX-e[1].clientX,n=e[0].clientY-e[1].clientY;return Math.sqrt(t*t+n*n)};n.addEventListener("touchstart",(e=>{2===e.touches.length?(p=f(e.touches),u=s):1===e.touches.length&&(c=!0,d=e.touches[0].clientX-r,m=e.touches[0].clientY-l,t.style.transition="none")}),{passive:!0}),n.addEventListener("touchmove",(e=>{if(2===e.touches.length){e.preventDefault();const t=f(e.touches);if(p>0){const e=t/p;s=Math.max(.5,Math.min(4,u*e)),g(!1)}}else 1===e.touches.length&&c&&(r=e.touches[0].clientX-d,l=e.touches[0].clientY-m,h(!1))}),{passive:!1}),n.addEventListener("touchend",(()=>{c=!1,p=0,u=s}));let v=0;n.addEventListener("touchend",(e=>{const t=Date.now();t-v<300&&1===e.changedTouches.length&&(s=i,u=i,g(!0)),v=t})),n.style.cursor="grab"}function ce(){var e;const t=document.querySelector(".dpad-floor-up"),n=document.querySelector(".dpad-floor-down");if(!t||!n||!Ge)return;const a=null===(e=Ge.grid)||void 0===e||null===(e=e[Ge.playerY])||void 0===e?void 0:e[Ge.playerX],o=null==a?void 0:a.staircase;"up"===(null==o?void 0:o.direction)?t.classList.remove("hidden"):t.classList.add("hidden"),"down"===(null==o?void 0:o.direction)?n.classList.remove("hidden"):n.classList.add("hidden")}async function de(e){var t,n,a;if(null===(t=Ge)||void 0===t||!t.isOpen||Ge.isPaused)return!1;if(Ge.totalFloors<=1)return!1;const o=null===(n=Ge.grid)||void 0===n||null===(n=n[Ge.playerY])||void 0===n?void 0:n[Ge.playerX];if(null==o||!o.staircase)return console.log("[MazeMaster] Not on a staircase"),!1;if(o.staircase.direction!==e)return console.log("[MazeMaster] Staircase direction mismatch"),!1;if(o.staircase.requireKey&&"up"===e){if(!((null===(i=Ge)||void 0===i?void 0:i.inventory.floorKey)>0))return Ge.currentMinion={name:"Locked Staircase",imagePath:"",message:"This staircase is locked! You need a Floor Key to ascend."},Na(),!1;await async function(){var e;(null===(e=Ge)||void 0===e?void 0:e.inventory.floorKey)>0&&await Xa("floorKey",1)}()}var i;const s=o.staircase.targetFloor,r=o.staircase.targetX,l=o.staircase.targetY;if(s<0||s>=Ge.totalFloors)return console.error("[MazeMaster] Invalid target floor"),!1;Ge.currentFloor=s,Ge.grid=Ge.floors[s],Ge.playerX=r,Ge.playerY=l,Ge.visited.add("".concat(s,":").concat(r,",").concat(l)),Aa("".concat("up"===e?"Ascended":"Descended"," to Floor ").concat(s+1,"/").concat(Ge.totalFloors),"Floor");const c=k[null===(a=Ge.profile)||void 0===a?void 0:a.theme]||k.fantasy,d="up"===e?c.flavorMessages.stairUp:c.flavorMessages.stairDown;return Ge.currentMinion={name:"up"===e?"Ascending":"Descending",imagePath:"",message:d||"You ".concat("up"===e?"ascend":"descend"," to floor ").concat(s+1,"...")},Na(),await H("onMove",{x:r,y:l,direction:"up"===e?"floor-up":"floor-down",floor:s}),Ra(),ue(!1),te(),ce(),me(),"function"==typeof window.mazeCenterOnPlayer&&window.mazeCenterOnPlayer(!0),console.log("[MazeMaster] Changed to floor ".concat(s+1)),!0}function me(){const e=document.getElementById("maze_floor_current"),t=document.getElementById("maze_floor_total"),n=document.querySelector(".maze-floor-indicator");Ge.totalFloors<=1?n&&(n.style.display="none"):(n&&(n.style.display=""),e&&(e.textContent=Ge.currentFloor+1),t&&(t.textContent=Ge.totalFloors))}async function pe(e,t){await Xa("portalStone",1),Ge.playerX=e,Ge.playerY=t,Ge.visited.add("".concat(Ge.currentFloor,":").concat(e,",").concat(t)),ue(!0),Ra(),ce(),Ge.currentMinion={name:"Portal Stone",imagePath:"",message:"The portal stone crumbles as you are whisked through space!"},Na(),await H("onTeleport",{x:e,y:t,source:"portalStone"})}function ue(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(!Ge)return;const t=D.getRenderer(),n=Ta(Ge.size);t.updatePlayerPosition(Ge.playerX,Ge.playerY,e,n),Fa()}function he(e,t,n,a,o,i){const{x:s,y:r,originX:l,originY:c,movement:d}=e,m=(null==i?void 0:i.minionAggressionMult)||1,p=function(e,t,n,a){const o=[],i=n[t][e];if(!i.walls.top&&t>0){n[t-1][e].minion||0===e&&t-1==0||o.push({x:e,y:t-1})}if(!i.walls.bottom&&t<a-1){n[t+1][e].minion||e===a-1&&t+1===a-1||o.push({x:e,y:t+1})}if(!i.walls.left&&e>0){n[t][e-1].minion||e-1==0&&0===t||o.push({x:e-1,y:t})}if(!i.walls.right&&e<a-1){n[t][e+1].minion||e+1===a-1&&t===a-1||o.push({x:e+1,y:t})}return o}(s,r,t,n);if(0===p.length)return null;switch(d.type){case"patrol":{const e=d.patrolRadius||3,t=p.filter((t=>Math.abs(t.x-l)+Math.abs(t.y-c)<=e));return 0===t.length?null:t[Math.floor(Math.random()*t.length)]}case"chase":{const e=d.chaseRange||5,t=Math.ceil(e*m),n=Math.abs(s-a)+Math.abs(r-o);if(n>t)return p[Math.floor(Math.random()*p.length)];let i=null,l=n;for(const e of p){const t=Math.abs(e.x-a)+Math.abs(e.y-o);t<l&&(l=t,i=e)}return i&&Math.random()<1/m*.5?p[Math.floor(Math.random()*p.length)]:i||p[Math.floor(Math.random()*p.length)]}default:return null}}function ge(e){const t={},n=e.objectives||[];for(const e of n)t[e.id]={current:0,completed:!1,target:e.count||1};return t}async function fe(e,t){var n;let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;if(!Ge||null===(n=Ge.profile)||void 0===n||!n.objectives)return;const o=Ge.profile.objectives,i=Ge.objectiveProgress;for(const n of o){if(n.type!==e)continue;if(("collect"===e||"defeat"===e)&&n.target!==t)continue;const o=i[n.id];o&&!o.completed&&(o.current+=a,await H("onObjectiveProgress",{objectiveId:n.id,current:o.current,target:n.count||1}),o.current>=(n.count||1)&&!o.completed&&(o.completed=!0,await H("onObjectiveComplete",{objectiveId:n.id}),n.reward&&n.reward.trim()&&await O(n.reward),console.log('[MazeMaster] Objective "'.concat(n.id,'" completed!'))))}be(),ve()}async function ve(){var e;if(!Ge||Ge.allObjectivesComplete)return;const t=(null===(e=Ge.profile)||void 0===e?void 0:e.objectives)||[],n=Ge.objectiveProgress;t.every((e=>{var t;return!e.required||(null===(t=n[e.id])||void 0===t?void 0:t.completed)}))&&t.some((e=>e.required))&&(Ge.allObjectivesComplete=!0,await H("onAllObjectivesComplete",{}),console.log("[MazeMaster] All required objectives complete!"))}function be(){var e,t;const n=document.getElementById("maze_objectives_list");if(!n||!Ge)return;const a=(null===(e=Ge.profile)||void 0===e?void 0:e.objectives)||[],o=Ge.objectiveProgress;var i;if(0===a.length)return n.innerHTML="",void(null===(i=n.closest(".maze-objectives-section"))||void 0===i||i.classList.add("hidden"));null===(t=n.closest(".maze-objectives-section"))||void 0===t||t.classList.remove("hidden"),n.innerHTML=a.map((e=>{const t=o[e.id]||{current:0,completed:!1},n=t.completed,a=n?"fa-check-circle":e.required?"fa-circle":"fa-circle-o",i=n?"objective-complete":e.required?"objective-required":"objective-optional";return'\n            <div class="objective-item '.concat(i,'">\n                <i class="fa-solid ').concat(a,'"></i>\n                <span class="objective-description">').concat(_o(e.description||e.id),'</span>\n                <span class="objective-progress">').concat(t.current,"/").concat(e.count||1,"</span>\n            </div>\n        ")})).join("")}const ye={profiles:{},battlebarProfiles:{},mazeProfiles:{},minions:{},minionProfiles:{},trapProfiles:{},currentProfile:"default",currentBattlebarProfile:"default",currentMazeProfile:"default",currentMinionProfile:"default",currentTrapProfile:"default",activeGameConfig:"maze",layoutMode:"desktop",llmEnabled:!0,llmPreset:"",closeChatOnStart:!0,dpadConfig:{enabled:!0,floating:!0,position:{x:null,y:null}}},ze={"Blessing Wheel":{segments:[{trigger:"com0",text:"Key",command:"/echo You receive a Key!",size:"doubleseg",respin:!1},{trigger:"com1",text:"Strike",command:"/echo You receive a STRIKE!",size:"doubleseg",respin:!1},{trigger:"com2",text:"Stealth",command:"/echo You receive a Stealth!",size:"fraction",respin:!1},{trigger:"com3",text:"Double Key!",command:"/echo You receive 2 Keys!",size:"halfseg",respin:!1},{trigger:"com4",text:"EXECUTE!",command:"/echo You receive an EXECUTE!",size:"halfseg",respin:!1},{trigger:"com5",text:"Spin Again",command:"/echo Blessed luck! Spin again!",size:"fraction",respin:!0}],randomize:!0,difficulty:1},"Treasure Wheel":{segments:[{trigger:"com0",text:"Key",command:"/echo A key materializes!",size:"doubleseg",respin:!1},{trigger:"com1",text:"Strike",command:"/echo Power surges through you!",size:"doubleseg",respin:!1},{trigger:"com2",text:"Stealth",command:"/echo Shadows embrace you!",size:"fraction",respin:!1},{trigger:"com3",text:"Floor Key",command:"/echo A Floor Key appears!",size:"halfseg",respin:!1},{trigger:"com4",text:"Bonus Spin",command:"/echo Fortune favors you!",size:"halfseg",respin:!0},{trigger:"com5",text:"Portal Stone",command:"/echo A Portal Stone!",size:"fraction",respin:!1}],randomize:!0,difficulty:1},"Gambler's Wheel":{segments:[{trigger:"com0",text:"JACKPOT!",command:"/echo JACKPOT! You win big!",size:"halfseg",respin:!1},{trigger:"com1",text:"Win Key",command:"/echo You win a Key!",size:"doubleseg",respin:!1},{trigger:"com2",text:"Lose Key",command:"/echo You lose a Key...",size:"fraction",respin:!1},{trigger:"com3",text:"Double Down",command:"/echo Double or nothing!",size:"doubleseg",respin:!0},{trigger:"com4",text:"Nothing",command:"/echo The wheel mocks you...",size:"fraction",respin:!1},{trigger:"com5",text:"Lose Strike",command:"/echo Your power fades...",size:"halfseg",respin:!1}],randomize:!0,difficulty:2},"Mystery Wheel":{segments:[{trigger:"com0",text:"???",command:"/echo Something strange happens...",size:"doubleseg",respin:!1},{trigger:"com1",text:"Gain Item",command:"/echo You gain a random item!",size:"fraction",respin:!1},{trigger:"com2",text:"Lose Item",command:"/echo An item vanishes!",size:"fraction",respin:!1},{trigger:"com3",text:"Teleport",command:"/echo Reality shifts around you!",size:"halfseg",respin:!1},{trigger:"com4",text:"Nothing",command:"/echo The mystery remains...",size:"halfseg",respin:!1},{trigger:"com5",text:"Respin",command:"/echo Fate intervenes!",size:"doubleseg",respin:!0}],randomize:!0,difficulty:2},"Tech Lottery":{segments:[{trigger:"com0",text:"System Bonus",command:"/echo System grants bonus credits!",size:"doubleseg",respin:!1},{trigger:"com1",text:"Malfunction",command:"/echo System error! Item lost!",size:"fraction",respin:!1},{trigger:"com2",text:"Reboot",command:"/echo System rebooting...",size:"fraction",respin:!0},{trigger:"com3",text:"Data Key",command:"/echo Access key downloaded!",size:"doubleseg",respin:!1},{trigger:"com4",text:"Virus",command:"/echo Virus detected! Strike drained!",size:"halfseg",respin:!1},{trigger:"com5",text:"Jackpot",command:"/echo JACKPOT PROTOCOL ACTIVATED!",size:"halfseg",respin:!1}],randomize:!0,difficulty:2},"Cursed Wheel":{segments:[{trigger:"com0",text:"Lose Key",command:"/echo The curse claims your key!",size:"doubleseg",respin:!1},{trigger:"com1",text:"Lose Strike",command:"/echo Dark energy drains you!",size:"doubleseg",respin:!1},{trigger:"com2",text:"Lose Stealth",command:"/echo Shadows betray you!",size:"fraction",respin:!1},{trigger:"com3",text:"Nothing",command:"/echo You escape the curse... barely.",size:"fraction",respin:!1},{trigger:"com4",text:"Cursed Spin",command:"/echo The wheel demands another spin!",size:"halfseg",respin:!0},{trigger:"com5",text:"RARE: Blessing",command:"/echo Against all odds, a blessing!",size:"halfseg",respin:!1}],randomize:!0,difficulty:3},"Trap Wheel":{segments:[{trigger:"com0",text:"Spike Trap",command:"/echo Spikes shoot up! Lose 1 STRIKE!",size:"doubleseg",respin:!1},{trigger:"com1",text:"Poison Gas",command:"/echo Gas fills the room! Lose 1 Stealth!",size:"fraction",respin:!1},{trigger:"com2",text:"Lock Trap",command:"/echo Your key breaks! Lose 1 Key!",size:"fraction",respin:!1},{trigger:"com3",text:"Escape!",command:"/echo You dodge the trap!",size:"halfseg",respin:!1},{trigger:"com4",text:"Double Trap",command:"/echo Two traps trigger!",size:"halfseg",respin:!1},{trigger:"com5",text:"Trapped Again",command:"/echo Another trap awaits!",size:"doubleseg",respin:!0}],randomize:!0,difficulty:3},"Dark Bargain":{segments:[{trigger:"com0",text:"Sacrifice Key",command:"/echo Your key dissolves...",size:"doubleseg",respin:!1},{trigger:"com1",text:"Sacrifice Strike",command:"/echo Your power drains away...",size:"fraction",respin:!1},{trigger:"com2",text:"Sacrifice All",command:"/echo Everything fades...",size:"halfseg",respin:!1},{trigger:"com3",text:"EXECUTE!",command:"/echo The bargain pays off! EXECUTE!",size:"halfseg",respin:!1},{trigger:"com4",text:"Nothing",command:"/echo The darkness waits...",size:"doubleseg",respin:!1},{trigger:"com5",text:"Try Again",command:"/echo The darkness offers again...",size:"fraction",respin:!0}],randomize:!0,difficulty:4}},xe={"Training Dummy":{difficulty:2,hitsToWin:2,missesToLose:5,damage:15,description:"A simple training target - perfect for learning combat basics.",hitCommand:"/echo Nice hit! You're getting the hang of it!",missCommand:"/echo Missed! Try again, no rush.",winCommand:"/echo Training complete! You're ready for real combat.",loseCommand:"/echo Don't worry, practice makes perfect!",mainTitle:"Training Dummy",images:[],keyDropChance:30,strikeDropChance:15,stealthDropChance:5,executeDropChance:0,floorKeyDropChance:2,portalStoneDropChance:1,minionBaneDropChance:1,mapFragmentDropChance:5,timeShardDropChance:0,voidWalkDropChance:0},"Dungeon Guardian":{difficulty:4,hitsToWin:3,missesToLose:4,damage:20,description:"A stalwart guardian blocks your path through the dungeon.",hitCommand:"/echo Your blade finds its mark!",missCommand:"/echo The guardian deflects your attack!",winCommand:"/echo The guardian falls! The way is clear.",loseCommand:"/echo The guardian has bested you...",mainTitle:"Dungeon Guardian",images:[],keyDropChance:40,strikeDropChance:20,stealthDropChance:10,executeDropChance:1,floorKeyDropChance:4,portalStoneDropChance:2,minionBaneDropChance:3,mapFragmentDropChance:8,timeShardDropChance:1,voidWalkDropChance:0},"Knight's Challenge":{difficulty:5,hitsToWin:4,missesToLose:3,damage:25,description:"An armored knight demands honorable combat. Steel clashes against steel.",hitCommand:"/echo A solid blow! The knight staggers!",missCommand:"/echo The knight parries with practiced ease!",winCommand:"/echo The knight yields! Honor is satisfied.",loseCommand:"/echo The knight proves the superior warrior...",mainTitle:"Dark Knight",images:[],keyDropChance:50,strikeDropChance:25,stealthDropChance:15,executeDropChance:2,floorKeyDropChance:6,portalStoneDropChance:4,minionBaneDropChance:5,mapFragmentDropChance:10,timeShardDropChance:2,voidWalkDropChance:1},"Horror Encounter":{difficulty:5,hitsToWin:3,missesToLose:3,damage:25,description:"Something unspeakable lurches from the shadows. Fight or be consumed!",hitCommand:"/echo The creature screeches in pain!",missCommand:"/echo It's too fast! Your attack goes wide!",winCommand:"/echo The horror dissipates into mist...",loseCommand:"/echo The darkness claims another victim...",mainTitle:"The Horror",images:[],keyDropChance:35,strikeDropChance:25,stealthDropChance:20,executeDropChance:2,floorKeyDropChance:5,portalStoneDropChance:4,minionBaneDropChance:6,mapFragmentDropChance:8,timeShardDropChance:3,voidWalkDropChance:2},"Nightmare Battle":{difficulty:7,hitsToWin:4,missesToLose:2,damage:35,description:"A manifestation of pure terror. One wrong move could be your last.",hitCommand:"/echo You strike at the nightmare's core!",missCommand:"/echo The nightmare's form shifts! Impossible to hit!",winCommand:"/echo The nightmare shatters! Dawn breaks through.",loseCommand:"/echo You are lost in eternal darkness...",mainTitle:"Nightmare",images:[],keyDropChance:55,strikeDropChance:35,stealthDropChance:25,executeDropChance:4,floorKeyDropChance:8,portalStoneDropChance:6,minionBaneDropChance:7,mapFragmentDropChance:12,timeShardDropChance:4,voidWalkDropChance:2},"Security Drone":{difficulty:4,hitsToWin:3,missesToLose:4,damage:20,description:"Automated security has detected an intruder. Disable it before the alarm triggers.",hitCommand:"/echo Direct hit! Sparks fly!",missCommand:"/echo The drone evades with precise thrusters!",winCommand:"/echo System offline. Security bypassed.",loseCommand:"/echo ALERT: Intruder neutralized.",mainTitle:"SEC-BOT",images:[],keyDropChance:40,strikeDropChance:20,stealthDropChance:15,executeDropChance:1,floorKeyDropChance:5,portalStoneDropChance:3,minionBaneDropChance:4,mapFragmentDropChance:10,timeShardDropChance:2,voidWalkDropChance:1},"System Override":{difficulty:7,hitsToWin:5,missesToLose:3,damage:35,description:"The mainframe AI has activated combat protocols. Override or be terminated.",hitCommand:"/echo Firewall breached! Keep attacking!",missCommand:"/echo ACCESS DENIED. Countermeasures deployed.",winCommand:"/echo SYSTEM OVERRIDE COMPLETE. Full access granted.",loseCommand:"/echo USER TERMINATED. Memory wiped.",mainTitle:"MAINFRAME",images:[],keyDropChance:60,strikeDropChance:40,stealthDropChance:25,executeDropChance:5,floorKeyDropChance:10,portalStoneDropChance:8,minionBaneDropChance:6,mapFragmentDropChance:15,timeShardDropChance:5,voidWalkDropChance:3},"Street Fight":{difficulty:5,hitsToWin:4,missesToLose:3,damage:25,description:"Fists and chrome clash in the neon-lit alley. No rules, no mercy.",hitCommand:"/echo That's gonna leave a mark!",missCommand:"/echo They're fast - street smart!",winCommand:"/echo They hit the ground. You walk away.",loseCommand:"/echo Concrete meets face. Lights out.",mainTitle:"Street Thug",images:[],keyDropChance:45,strikeDropChance:25,stealthDropChance:15,executeDropChance:2,floorKeyDropChance:5,portalStoneDropChance:4,minionBaneDropChance:5,mapFragmentDropChance:10,timeShardDropChance:2,voidWalkDropChance:1},Showdown:{difficulty:5,hitsToWin:3,missesToLose:3,damage:25,description:"High noon. One chance. Draw!",hitCommand:"/echo Quick draw! Right on target!",missCommand:"/echo Dust in your eyes! Shot goes wide!",winCommand:"/echo They fall. There's a new fastest gun in town.",loseCommand:"/echo Not fast enough, partner...",mainTitle:"Outlaw",images:[],keyDropChance:45,strikeDropChance:30,stealthDropChance:10,executeDropChance:2,floorKeyDropChance:6,portalStoneDropChance:3,minionBaneDropChance:4,mapFragmentDropChance:12,timeShardDropChance:2,voidWalkDropChance:1},"Elite Combat":{difficulty:9,hitsToWin:5,missesToLose:2,damage:40,description:"The elite of the elite. Every move must be perfect. There are no second chances.",hitCommand:"/echo Perfect strike! They're vulnerable!",missCommand:"/echo Countered! They're impossibly fast!",winCommand:"/echo Against all odds... victory is yours.",loseCommand:"/echo Outmatched. Outplayed. Eliminated.",mainTitle:"Elite Operative",images:[],keyDropChance:65,strikeDropChance:45,stealthDropChance:30,executeDropChance:8,floorKeyDropChance:12,portalStoneDropChance:10,minionBaneDropChance:8,mapFragmentDropChance:18,timeShardDropChance:6,voidWalkDropChance:4}},_e={"Training Bout":{difficulty:2,playerHP:100,enemyHP:50,playerAttack:15,playerDefense:5,enemyAttack:8,enemyDefense:2,turnOrder:"player_first",fleeChance:80,critChance:15,critMultiplier:1.5,damage:15,description:"A practice fight against a training dummy. Perfect for learning the combat system.",mainTitle:"Training Bout",enemyName:"Training Dummy",onTurnStart:"",onAttack:"",onDefend:"",onItem:"",onFlee:"",onPlayerHit:"",onEnemyHit:"",onWin:"/echo You defeated the training dummy!",onLose:"/echo The training dummy got the better of you...",keyDropChance:30,strikeDropChance:15,stealthDropChance:10,executeDropChance:2,healingPotionDropChance:25,greaterHealingDropChance:5,elixirDropChance:1,revivalCharmDropChance:0},"Dungeon Skirmish":{difficulty:5,playerHP:100,enemyHP:80,playerAttack:18,playerDefense:6,enemyAttack:14,enemyDefense:4,turnOrder:"player_first",fleeChance:50,critChance:12,critMultiplier:2,damage:25,description:"A standard dungeon encounter. Trade blows wisely and watch your health.",mainTitle:"Dungeon Skirmish",enemyName:"Dungeon Creature",onTurnStart:"",onAttack:"",onDefend:"",onItem:"",onFlee:"",onPlayerHit:"",onEnemyHit:"",onWin:"/echo Victory! The creature falls!",onLose:"/echo You were overwhelmed by the creature...",keyDropChance:40,strikeDropChance:20,stealthDropChance:12,executeDropChance:4,healingPotionDropChance:20,greaterHealingDropChance:8,elixirDropChance:2,revivalCharmDropChance:1},"Knight's Duel":{difficulty:6,playerHP:100,enemyHP:100,playerAttack:20,playerDefense:8,enemyAttack:18,enemyDefense:10,turnOrder:"player_first",fleeChance:30,critChance:10,critMultiplier:2,damage:30,description:"An honorable duel against a skilled knight. Defense is key to survival.",mainTitle:"Knight's Duel",enemyName:"Armored Knight",onTurnStart:"",onAttack:"",onDefend:"",onItem:"",onFlee:"",onPlayerHit:"",onEnemyHit:"",onWin:"/echo The knight yields! Honor is satisfied.",onLose:"/echo Defeated in honorable combat...",keyDropChance:50,strikeDropChance:25,stealthDropChance:15,executeDropChance:5,healingPotionDropChance:22,greaterHealingDropChance:12,elixirDropChance:3,revivalCharmDropChance:2},"Boss Battle":{difficulty:8,playerHP:100,enemyHP:150,playerAttack:22,playerDefense:8,enemyAttack:25,enemyDefense:12,turnOrder:"enemy_first",fleeChance:10,critChance:15,critMultiplier:2.5,damage:40,description:"A fearsome boss blocks your path. This will be a battle for survival.",mainTitle:"Boss Battle",enemyName:"Dungeon Boss",onTurnStart:"",onAttack:"",onDefend:"",onItem:"",onFlee:"",onPlayerHit:"",onEnemyHit:"",onWin:"/echo The boss is defeated! Glory is yours!",onLose:"/echo The boss proved too powerful...",keyDropChance:60,strikeDropChance:35,stealthDropChance:20,executeDropChance:8,healingPotionDropChance:30,greaterHealingDropChance:18,elixirDropChance:5,revivalCharmDropChance:3},"Nightmare Encounter":{difficulty:10,playerHP:100,enemyHP:200,playerAttack:25,playerDefense:10,enemyAttack:35,enemyDefense:15,turnOrder:"enemy_first",fleeChance:0,critChance:20,critMultiplier:3,damage:50,description:"A nightmare made flesh. There is no escape. Only victory or death.",mainTitle:"Nightmare Encounter",enemyName:"Nightmare Entity",onTurnStart:"",onAttack:"",onDefend:"",onItem:"",onFlee:"",onPlayerHit:"",onEnemyHit:"",onWin:"/echo Against impossible odds, you have prevailed!",onLose:"/echo The nightmare consumes you...",keyDropChance:70,strikeDropChance:45,stealthDropChance:30,executeDropChance:12,healingPotionDropChance:35,greaterHealingDropChance:25,elixirDropChance:10,revivalCharmDropChance:5},"Skeleton Warrior":{difficulty:4,playerHP:100,enemyHP:60,playerAttack:16,playerDefense:5,enemyAttack:12,enemyDefense:3,turnOrder:"player_first",fleeChance:60,critChance:10,critMultiplier:1.5,damage:18,description:"A rattling skeleton rises from the shadows, rusted blade in hand.",mainTitle:"Skeleton Warrior",enemyName:"Skeleton Warrior",onTurnStart:"",onAttack:"",onDefend:"",onItem:"",onFlee:"",onPlayerHit:"",onEnemyHit:"",onWin:"/echo The skeleton crumbles into a pile of bones!",onLose:"/echo The skeleton adds your bones to its collection...",keyDropChance:35,strikeDropChance:18,stealthDropChance:12,executeDropChance:3,healingPotionDropChance:20,greaterHealingDropChance:6,elixirDropChance:1,revivalCharmDropChance:0},"Goblin Ambush":{difficulty:3,playerHP:100,enemyHP:45,playerAttack:14,playerDefense:4,enemyAttack:10,enemyDefense:2,turnOrder:"enemy_first",fleeChance:70,critChance:18,critMultiplier:1.8,damage:15,description:"A sneaky goblin leaps from the shadows with a rusty dagger!",mainTitle:"Goblin Ambush",enemyName:"Goblin Ambusher",onTurnStart:"",onAttack:"",onDefend:"",onItem:"",onFlee:"",onPlayerHit:"",onEnemyHit:"",onWin:"/echo The goblin squeals and flees into the darkness!",onLose:"/echo The goblin cackles as you fall...",keyDropChance:30,strikeDropChance:15,stealthDropChance:20,executeDropChance:2,healingPotionDropChance:18,greaterHealingDropChance:4,elixirDropChance:1,revivalCharmDropChance:0},"Dragon Whelp":{difficulty:6,playerHP:100,enemyHP:90,playerAttack:18,playerDefense:6,enemyAttack:20,enemyDefense:8,turnOrder:"random",fleeChance:40,critChance:15,critMultiplier:2,damage:28,description:"A young dragon hatchling with scales as hard as steel and breath of flame.",mainTitle:"Dragon Whelp",enemyName:"Dragon Whelp",onTurnStart:"",onAttack:"",onDefend:"",onItem:"",onFlee:"",onPlayerHit:"",onEnemyHit:"",onWin:"/echo The dragon whelp retreats, screeching in defeat!",onLose:"/echo Dragon fire engulfs you...",keyDropChance:45,strikeDropChance:25,stealthDropChance:15,executeDropChance:6,healingPotionDropChance:25,greaterHealingDropChance:12,elixirDropChance:4,revivalCharmDropChance:2},"Vampire Lord":{difficulty:8,playerHP:100,enemyHP:120,playerAttack:20,playerDefense:7,enemyAttack:22,enemyDefense:10,turnOrder:"enemy_first",fleeChance:20,critChance:20,critMultiplier:2.5,damage:35,description:"An ancient vampire with pale skin and crimson eyes emerges from the shadows.",mainTitle:"Vampire Lord",enemyName:"Vampire Lord",onTurnStart:"",onAttack:"",onDefend:"",onItem:"",onFlee:"",onPlayerHit:"",onEnemyHit:"",onWin:"/echo The vampire lord dissolves into mist, defeated!",onLose:"/echo The vampire drains your life essence...",keyDropChance:55,strikeDropChance:30,stealthDropChance:20,executeDropChance:10,healingPotionDropChance:28,greaterHealingDropChance:15,elixirDropChance:6,revivalCharmDropChance:3}},we={"Reaction Test":{difficulty:2,sequenceLengthMin:3,sequenceLengthMax:5,timeWindowBase:1500,timeWindowMin:800,difficultyScaling:.9,allowedKeys:["W","A","S","D","SPACE"],displayStyle:"single",damage:10,comboEnabled:!0,perfectWindowPercent:30,description:"A simple reaction test. Press SPACE when prompted!",mainTitle:"Reaction Test",onStart:"",onPrompt:"",onSuccess:"",onPerfect:"",onMiss:"",onComplete:"/echo Quick reflexes!",onFail:"/echo Too slow...",keyDropChance:20,strikeDropChance:10,stealthDropChance:5,executeDropChance:1,healingPotionDropChance:15,greaterHealingDropChance:3,elixirDropChance:0,revivalCharmDropChance:0},"Quick Dodge":{difficulty:4,sequenceLengthMin:4,sequenceLengthMax:6,timeWindowBase:1200,timeWindowMin:600,difficultyScaling:.85,allowedKeys:["W","A","S","D"],displayStyle:"single",damage:20,comboEnabled:!0,perfectWindowPercent:25,description:"Dodge incoming attacks! Use WASD to evade in the right direction.",mainTitle:"Quick Dodge",onStart:"",onPrompt:"",onSuccess:"",onPerfect:"",onMiss:"",onComplete:"/echo Dodged them all!",onFail:"/echo You took a hit!",keyDropChance:30,strikeDropChance:15,stealthDropChance:10,executeDropChance:2,healingPotionDropChance:18,greaterHealingDropChance:6,elixirDropChance:1,revivalCharmDropChance:0},"Combat Flurry":{difficulty:6,sequenceLengthMin:6,sequenceLengthMax:9,timeWindowBase:1e3,timeWindowMin:500,difficultyScaling:.88,allowedKeys:["W","A","S","D","SPACE"],displayStyle:"single",damage:30,comboEnabled:!0,perfectWindowPercent:22,description:"A flurry of attacks! Keep up with the rapid sequence to land your combo.",mainTitle:"Combat Flurry",onStart:"",onPrompt:"",onSuccess:"",onPerfect:"",onMiss:"",onComplete:"/echo Devastating combo!",onFail:"/echo Your attack was interrupted!",keyDropChance:40,strikeDropChance:22,stealthDropChance:15,executeDropChance:4,healingPotionDropChance:20,greaterHealingDropChance:10,elixirDropChance:2,revivalCharmDropChance:1},"Boss Sequence":{difficulty:8,sequenceLengthMin:8,sequenceLengthMax:12,timeWindowBase:900,timeWindowMin:400,difficultyScaling:.85,allowedKeys:["W","A","S","D","SPACE","E"],displayStyle:"single",damage:45,comboEnabled:!0,perfectWindowPercent:20,description:"The boss unleashes a deadly sequence. Match the pattern perfectly to survive!",mainTitle:"Boss Sequence",onStart:"",onPrompt:"",onSuccess:"",onPerfect:"",onMiss:"",onComplete:"/echo You weathered the storm!",onFail:"/echo The boss overwhelms you!",keyDropChance:55,strikeDropChance:30,stealthDropChance:20,executeDropChance:7,healingPotionDropChance:25,greaterHealingDropChance:15,elixirDropChance:4,revivalCharmDropChance:2},"Deadly Dance":{difficulty:10,sequenceLengthMin:10,sequenceLengthMax:15,timeWindowBase:800,timeWindowMin:350,difficultyScaling:.82,allowedKeys:["W","A","S","D","SPACE","E","Q"],displayStyle:"single",damage:60,comboEnabled:!0,perfectWindowPercent:18,description:"The ultimate test of reflexes. A deadly dance where one misstep means death.",mainTitle:"Deadly Dance",onStart:"",onPrompt:"",onSuccess:"",onPerfect:"",onMiss:"",onComplete:"/echo Flawless execution!",onFail:"/echo The dance claims another victim...",keyDropChance:65,strikeDropChance:40,stealthDropChance:28,executeDropChance:10,healingPotionDropChance:30,greaterHealingDropChance:20,elixirDropChance:8,revivalCharmDropChance:4}},ke={"Lucky Roll":{difficulty:2,diceType:"d6",diceCount:2,threshold:7,thresholdType:"meet",modifier:0,criticalSuccess:12,criticalFail:2,rerollsAllowed:1,rerollCost:"none",damage:10,description:"A simple luck test. Roll 2d6 and try to get 7 or higher!",mainTitle:"Lucky Roll",rollLabel:"Roll for Luck",onStart:"",onRoll:"",onCriticalSuccess:"",onCriticalFail:"",onSuccess:"",onFail:"",onReroll:"",onComplete:"/echo Fortune smiles upon you!",onLose:"/echo Luck was not on your side...",keyDropChance:25,strikeDropChance:12,stealthDropChance:8,executeDropChance:1,healingPotionDropChance:18,greaterHealingDropChance:5,elixirDropChance:1,revivalCharmDropChance:0},"Skill Check":{difficulty:4,diceType:"d20",diceCount:1,threshold:12,thresholdType:"meet",modifier:2,criticalSuccess:20,criticalFail:1,rerollsAllowed:0,rerollCost:"none",damage:20,description:"Roll a d20 skill check. You have a +2 modifier. Need 12 or higher to succeed.",mainTitle:"Skill Check",rollLabel:"Make Skill Check",onStart:"",onRoll:"",onCriticalSuccess:"/echo Natural 20! Critical success!",onCriticalFail:"/echo Natural 1! Critical failure!",onSuccess:"",onFail:"",onReroll:"",onComplete:"/echo You passed the skill check!",onLose:"/echo You failed the skill check...",keyDropChance:35,strikeDropChance:18,stealthDropChance:12,executeDropChance:3,healingPotionDropChance:20,greaterHealingDropChance:8,elixirDropChance:2,revivalCharmDropChance:0},"Saving Throw":{difficulty:6,diceType:"d20",diceCount:1,threshold:15,thresholdType:"meet",modifier:0,criticalSuccess:20,criticalFail:1,rerollsAllowed:1,rerollCost:"strike",damage:30,description:"A dangerous saving throw! Roll d20 and meet DC 15. Spend a Strike to reroll.",mainTitle:"Saving Throw",rollLabel:"Roll Save",onStart:"",onRoll:"",onCriticalSuccess:"/echo Natural 20! You shrug off the effect completely!",onCriticalFail:"/echo Natural 1! You suffer the full effect!",onSuccess:"",onFail:"",onReroll:"",onComplete:"/echo You made your saving throw!",onLose:"/echo You failed your saving throw...",keyDropChance:45,strikeDropChance:25,stealthDropChance:15,executeDropChance:5,healingPotionDropChance:22,greaterHealingDropChance:12,elixirDropChance:3,revivalCharmDropChance:1},"High Stakes":{difficulty:8,diceType:"d10",diceCount:3,threshold:20,thresholdType:"meet",modifier:-2,criticalSuccess:28,criticalFail:5,rerollsAllowed:2,rerollCost:"key",damage:45,description:"Roll 3d10 with a -2 penalty. You need 20 or higher. High risk, high reward!",mainTitle:"High Stakes",rollLabel:"Take the Risk",onStart:"",onRoll:"",onCriticalSuccess:"/echo Maximum luck! The odds were in your favor!",onCriticalFail:"/echo Snake eyes... things went very wrong.",onSuccess:"",onFail:"",onReroll:"",onComplete:"/echo The gamble paid off!",onLose:"/echo You lost the gamble...",keyDropChance:55,strikeDropChance:32,stealthDropChance:20,executeDropChance:8,healingPotionDropChance:28,greaterHealingDropChance:16,elixirDropChance:5,revivalCharmDropChance:2},"Fate's Judgment":{difficulty:10,diceType:"d100",diceCount:1,threshold:75,thresholdType:"beat",modifier:0,criticalSuccess:95,criticalFail:5,rerollsAllowed:0,rerollCost:"none",damage:60,description:"Roll the percentile dice! You need to roll above 75. No rerolls - pure fate.",mainTitle:"Fate's Judgment",rollLabel:"Face Your Fate",onStart:"",onRoll:"",onCriticalSuccess:"/echo Destiny itself bows to you!",onCriticalFail:"/echo Fate has dealt a cruel hand...",onSuccess:"",onFail:"",onReroll:"",onComplete:"/echo Fate has judged you worthy!",onLose:"/echo Fate has judged you wanting...",keyDropChance:70,strikeDropChance:45,stealthDropChance:30,executeDropChance:12,healingPotionDropChance:35,greaterHealingDropChance:22,elixirDropChance:10,revivalCharmDropChance:5}},Ce={"Simple Sneak":{difficulty:2,sectionsToPass:3,detectionThreshold:100,baseDetectionRate:15,advanceSuccessChance:70,hideRecovery:25,distractSuccessChance:60,distractReduction:40,waitRecovery:15,damage:15,description:"Sneak past a single guard. Take your time and stay hidden.",mainTitle:"Simple Sneak",guardName:"Guard",onStart:"",onAdvance:"",onHide:"",onDistract:"",onWait:"",onDetectionIncrease:"",onComplete:"/echo You slipped past unnoticed!",onCaught:"/echo You've been spotted!",keyDropChance:20,strikeDropChance:10,stealthDropChance:15,executeDropChance:2,healingPotionDropChance:15,greaterHealingDropChance:5,elixirDropChance:1,revivalCharmDropChance:0},"Guard Patrol":{difficulty:4,sectionsToPass:4,detectionThreshold:100,baseDetectionRate:20,advanceSuccessChance:55,hideRecovery:20,distractSuccessChance:50,distractReduction:35,waitRecovery:12,damage:25,description:"Navigate through a patrol route. Time your movements carefully.",mainTitle:"Guard Patrol",guardName:"Patrol",onStart:"",onAdvance:"",onHide:"",onDistract:"",onWait:"",onDetectionIncrease:"",onComplete:"/echo The patrol passed without seeing you!",onCaught:"/echo The patrol has spotted you!",keyDropChance:30,strikeDropChance:18,stealthDropChance:22,executeDropChance:4,healingPotionDropChance:18,greaterHealingDropChance:8,elixirDropChance:2,revivalCharmDropChance:0},"Watchful Sentry":{difficulty:6,sectionsToPass:5,detectionThreshold:80,baseDetectionRate:25,advanceSuccessChance:45,hideRecovery:18,distractSuccessChance:45,distractReduction:30,waitRecovery:10,damage:35,description:"A vigilant sentry blocks your path. One wrong move and you're caught.",mainTitle:"Watchful Sentry",guardName:"Sentry",onStart:"",onAdvance:"",onHide:"",onDistract:"",onWait:"",onDetectionIncrease:"",onComplete:"/echo The sentry never knew you were there!",onCaught:"/echo The sentry raises the alarm!",keyDropChance:40,strikeDropChance:25,stealthDropChance:28,executeDropChance:6,healingPotionDropChance:22,greaterHealingDropChance:12,elixirDropChance:4,revivalCharmDropChance:1},"Shadow Run":{difficulty:8,sectionsToPass:6,detectionThreshold:70,baseDetectionRate:30,advanceSuccessChance:40,hideRecovery:15,distractSuccessChance:40,distractReduction:25,waitRecovery:8,damage:50,description:"Multiple guards patrol the area. Use every trick to stay unseen.",mainTitle:"Shadow Run",guardName:"Guards",onStart:"",onAdvance:"",onHide:"",onDistract:"",onWait:"",onDetectionIncrease:"",onComplete:"/echo Like a shadow, you vanish into the night!",onCaught:"/echo Multiple guards converge on your position!",keyDropChance:55,strikeDropChance:32,stealthDropChance:35,executeDropChance:9,healingPotionDropChance:28,greaterHealingDropChance:16,elixirDropChance:6,revivalCharmDropChance:2},"Impossible Infiltration":{difficulty:10,sectionsToPass:8,detectionThreshold:60,baseDetectionRate:35,advanceSuccessChance:35,hideRecovery:12,distractSuccessChance:35,distractReduction:20,waitRecovery:5,damage:70,description:"Elite guards, magical wards, and traps. Only a master infiltrator can succeed.",mainTitle:"Impossible Infiltration",guardName:"Elite Guards",onStart:"",onAdvance:"",onHide:"",onDistract:"",onWait:"",onDetectionIncrease:"",onComplete:"/echo Against impossible odds, you infiltrated successfully!",onCaught:"/echo The elite guards capture you instantly!",keyDropChance:70,strikeDropChance:45,stealthDropChance:50,executeDropChance:15,healingPotionDropChance:35,greaterHealingDropChance:22,elixirDropChance:10,revivalCharmDropChance:5}},Se={"Simple Riddle":{difficulty:2,puzzleType:"sequence",gridSize:3,sequenceLength:4,timeLimit:60,hintsAllowed:3,hintPenalty:10,wrongGuessPenalty:1,wrongGuessesAllowed:5,damage:10,description:"A simple puzzle to warm up your mind.",mainTitle:"Simple Riddle",successMessage:"You solved it!",failMessage:"The puzzle defeats you...",onStart:"",onHint:"",onCorrectMove:"",onWrongMove:"",onComplete:"/echo You solved the simple riddle!",onFail:"/mazedamage amount=10 | /echo The puzzle was too complex...",keyDropChance:15,strikeDropChance:10,stealthDropChance:8,executeDropChance:2,healingPotionDropChance:12,greaterHealingDropChance:5,elixirDropChance:1,revivalCharmDropChance:0},"Memory Trial":{difficulty:4,puzzleType:"memory",gridSize:4,sequenceLength:6,timeLimit:90,hintsAllowed:2,hintPenalty:15,wrongGuessPenalty:1,wrongGuessesAllowed:4,damage:20,description:"Remember the pattern before it fades away.",mainTitle:"Memory Trial",successMessage:"Your memory serves you well!",failMessage:"The pattern slips from your mind...",onStart:"",onHint:"",onCorrectMove:"",onWrongMove:"",onComplete:"/echo Your memory is sharp as a blade!",onFail:"/mazedamage amount=15 | /echo You couldn't remember the sequence...",keyDropChance:25,strikeDropChance:18,stealthDropChance:15,executeDropChance:4,healingPotionDropChance:18,greaterHealingDropChance:10,elixirDropChance:3,revivalCharmDropChance:1},"Pattern Maze":{difficulty:6,puzzleType:"pattern",gridSize:5,sequenceLength:8,timeLimit:120,hintsAllowed:2,hintPenalty:20,wrongGuessPenalty:1,wrongGuessesAllowed:3,damage:35,description:"Find the hidden pattern within the chaos.",mainTitle:"Pattern Maze",successMessage:"The pattern reveals itself!",failMessage:"Chaos consumes your thoughts...",onStart:"",onHint:"",onCorrectMove:"",onWrongMove:"",onComplete:"/echo You see the pattern in all things now!",onFail:"/mazedamage amount=20 | /echo The pattern was beyond your comprehension...",keyDropChance:40,strikeDropChance:25,stealthDropChance:22,executeDropChance:6,healingPotionDropChance:22,greaterHealingDropChance:14,elixirDropChance:5,revivalCharmDropChance:2},"Logic Lock":{difficulty:8,puzzleType:"logic",gridSize:5,sequenceLength:10,timeLimit:150,hintsAllowed:1,hintPenalty:25,wrongGuessPenalty:1,wrongGuessesAllowed:2,damage:50,description:"A devious logic puzzle guards the way forward.",mainTitle:"Logic Lock",successMessage:"Logic prevails!",failMessage:"Your reasoning fails you...",onStart:"",onHint:"",onCorrectMove:"",onWrongMove:"",onComplete:"/echo Your logical mind unlocked the way!",onFail:"/mazedamage amount=25 | /echo The logic was too twisted...",keyDropChance:55,strikeDropChance:35,stealthDropChance:30,executeDropChance:10,healingPotionDropChance:28,greaterHealingDropChance:18,elixirDropChance:7,revivalCharmDropChance:3},"Mind Shatter":{difficulty:10,puzzleType:"sequence",gridSize:6,sequenceLength:12,timeLimit:180,hintsAllowed:0,hintPenalty:0,wrongGuessPenalty:1,wrongGuessesAllowed:1,damage:70,description:"A puzzle so complex it threatens to shatter your very mind.",mainTitle:"Mind Shatter",successMessage:"Impossible! You solved it!",failMessage:"Your mind shatters under the complexity...",onStart:"",onHint:"",onCorrectMove:"",onWrongMove:"",onComplete:"/echo Against all odds, your mind prevailed!",onFail:"/mazedamage amount=35 | /echo The puzzle was beyond mortal comprehension...",keyDropChance:70,strikeDropChance:45,stealthDropChance:40,executeDropChance:15,healingPotionDropChance:35,greaterHealingDropChance:22,elixirDropChance:10,revivalCharmDropChance:5}},Me={"Friendly Chat":{difficulty:2,startingFavor:50,favorThreshold:75,turnsAllowed:6,persuadeBonus:15,intimidateBonus:10,bribeBonus:20,flattery:!0,flatterBonus:12,insult:!1,insultPenalty:20,bribeCost:"key",damage:10,description:"A simple conversation to get what you want.",mainTitle:"Friendly Chat",npcName:"Stranger",successMessage:"They agree to your request!",failMessage:"They refuse to help you.",onStart:"",onPersuade:"",onIntimidate:"",onBribe:"",onFlatter:"",onInsult:"",onComplete:"/echo You convinced them successfully!",onFail:"/echo The negotiation failed...",keyDropChance:15,strikeDropChance:10,stealthDropChance:8,executeDropChance:2,healingPotionDropChance:12,greaterHealingDropChance:5,elixirDropChance:1,revivalCharmDropChance:0},"Merchant Haggle":{difficulty:4,startingFavor:40,favorThreshold:70,turnsAllowed:5,persuadeBonus:12,intimidateBonus:8,bribeBonus:25,flattery:!0,flatterBonus:10,insult:!0,insultPenalty:25,bribeCost:"key",damage:20,description:"Haggle with a shrewd merchant for a better deal.",mainTitle:"Merchant Haggle",npcName:"Merchant",successMessage:"The merchant agrees to your terms!",failMessage:"No deal. The merchant stands firm.",onStart:"",onPersuade:"",onIntimidate:"",onBribe:"",onFlatter:"",onInsult:"",onComplete:"/echo A deal is struck in your favor!",onFail:"/echo The merchant refuses to budge...",keyDropChance:25,strikeDropChance:18,stealthDropChance:15,executeDropChance:4,healingPotionDropChance:18,greaterHealingDropChance:10,elixirDropChance:3,revivalCharmDropChance:1},"Guard Bribery":{difficulty:6,startingFavor:30,favorThreshold:65,turnsAllowed:4,persuadeBonus:8,intimidateBonus:15,bribeBonus:30,flattery:!0,flatterBonus:8,insult:!0,insultPenalty:30,bribeCost:"strike",damage:35,description:"Convince a guard to look the other way.",mainTitle:"Guard Bribery",npcName:"Guard",successMessage:"The guard pockets the bribe and looks away.",failMessage:"The guard calls for reinforcements!",onStart:"",onPersuade:"",onIntimidate:"",onBribe:"",onFlatter:"",onInsult:"",onComplete:"/echo The guard lets you pass!",onFail:"/echo The guard sounds the alarm!",keyDropChance:40,strikeDropChance:25,stealthDropChance:22,executeDropChance:6,healingPotionDropChance:22,greaterHealingDropChance:14,elixirDropChance:5,revivalCharmDropChance:2},"Noble Audience":{difficulty:8,startingFavor:25,favorThreshold:80,turnsAllowed:5,persuadeBonus:10,intimidateBonus:5,bribeBonus:15,flattery:!0,flatterBonus:18,insult:!0,insultPenalty:35,bribeCost:"execute",damage:50,description:"Seek favor from a haughty noble.",mainTitle:"Noble Audience",npcName:"Noble",successMessage:"The noble grants your request with a wave.",failMessage:"The noble dismisses you with contempt.",onStart:"",onPersuade:"",onIntimidate:"",onBribe:"",onFlatter:"",onInsult:"",onComplete:"/echo The noble smiles and grants your wish!",onFail:"/echo You have displeased the noble...",keyDropChance:55,strikeDropChance:35,stealthDropChance:30,executeDropChance:10,healingPotionDropChance:28,greaterHealingDropChance:18,elixirDropChance:7,revivalCharmDropChance:3},"Dark Pact":{difficulty:10,startingFavor:15,favorThreshold:85,turnsAllowed:4,persuadeBonus:8,intimidateBonus:12,bribeBonus:20,flattery:!0,flatterBonus:10,insult:!0,insultPenalty:40,bribeCost:"execute",damage:70,description:"Negotiate with a malevolent entity. Choose your words carefully.",mainTitle:"Dark Pact",npcName:"Entity",successMessage:"The entity agrees to your terms... for now.",failMessage:"The entity laughs as it takes what it wants.",onStart:"",onPersuade:"",onIntimidate:"",onBribe:"",onFlatter:"",onInsult:"",onComplete:"/echo A dark bargain is struck!",onFail:"/echo The entity claims its due...",keyDropChance:70,strikeDropChance:45,stealthDropChance:40,executeDropChance:15,healingPotionDropChance:35,greaterHealingDropChance:22,elixirDropChance:10,revivalCharmDropChance:5}};function Ee(e){if(!e)return"";if(e.startsWith("http://")||e.startsWith("https://"))return e;const t=e.match(/\/scripts\/extensions\/third-party\/[^/]+\/(.+)/);if(t){const e=t[1];return"/scripts/extensions/third-party/".concat(o,"/").concat(e)}return e.startsWith("/")?e:"/scripts/extensions/third-party/".concat(o,"/").concat(e)}const Pe={fantasy_herald:{name:"The Herald",imagePath:"",type:"messenger",description:"A cloaked messenger who appears from the shadows with cryptic warnings about the dungeon ahead.",messages:["Greetings, adventurer...","The maze master watches your every step...","Beware the darkness that lies ahead!","Many have entered. Few have returned."],encounterScript:""},fantasy_guardian:{name:"Dungeon Guardian",imagePath:"",type:"battlebar",description:"A stalwart armored warrior sworn to protect this passage from intruders.",battlebarProfiles:["Dungeon Guardian","Knight's Challenge"],messages:["None shall pass!","Prepare yourself, intruder!","Only the worthy may continue!"],encounterScript:""},fantasy_oracle:{name:"The Oracle",imagePath:"",type:"prizewheel",description:"An ancient mystic with glowing eyes who offers to reveal your fate through a magical spinning wheel.",wheelProfiles:["Blessing Wheel","Mystery Wheel"],messages:["Spin the wheel of fate!","Let destiny reveal itself!","Fortune favors the bold..."],encounterScript:""},fantasy_merchant:{name:"Wandering Merchant",imagePath:"",type:"merchant",description:"A shrewd trader draped in exotic fabrics who deals in magical wares.",merchantItemCount:{min:2,max:4},merchantItemPool:"Adventurer Supplies",messages:["Rare goods for a rare adventurer!","A fair trade benefits us both.","Perhaps something catches your eye?"],encounterScript:""},horror_spirit:{name:"Whispering Spirit",imagePath:"",type:"messenger",description:"A translucent specter that whispers unsettling warnings from beyond the grave.",messages:["You should not be here...","They are watching... always watching...","Turn back while you still can...","Join usssss..."],encounterScript:""},horror_revenant:{name:"The Revenant",imagePath:"",type:"battlebar",description:"An undying horror that claws its way from the shadows to claim another victim.",battlebarProfiles:["Horror Encounter","Nightmare Battle"],messages:["Your soul... will be mine...","Death is only the beginning!","YOU CANNOT ESCAPE!"],encounterScript:""},horror_gambler:{name:"Cursed Gambler",imagePath:"",type:"prizewheel",description:"A ghastly figure bound to an eternal game of chance. Win at your peril.",wheelProfiles:["Cursed Wheel","Dark Bargain"],messages:["Care to play a little game?","The stakes are... everything.","Fortune rarely favors the living here..."],encounterScript:""},horror_graverobber:{name:"Graverobber",imagePath:"",type:"merchant",description:'A hunched figure who deals in items "liberated" from the dead. Don\'t ask where they came from.',merchantItemCount:{min:2,max:4},merchantItemPool:"Dark Market",messages:["Fresh stock... freshly acquired...","The dead have no need for such things.","A trade? The living always want something..."],encounterScript:""},scifi_ai:{name:"AI Assistant",imagePath:"",type:"messenger",description:"A holographic interface that provides technical readouts and mission updates.",messages:["ALERT: Hostile activity detected in adjacent sectors.","Scanning complete. Multiple life forms ahead.","Recommended route calculated. Proceed with caution.","Mission parameters updated."],encounterScript:""},scifi_bot:{name:"Security Bot",imagePath:"",type:"battlebar",description:"An automated defense unit programmed to eliminate all unauthorized personnel.",battlebarProfiles:["Security Drone","System Override"],messages:["HALT. IDENTIFICATION REQUIRED.","INTRUDER DETECTED. ENGAGING COMBAT PROTOCOLS.","RESISTANCE IS INEFFICIENT."],encounterScript:""},scifi_matrix:{name:"Probability Matrix",imagePath:"",type:"prizewheel",description:"A quantum randomization terminal that dispenses rewards based on probability algorithms.",wheelProfiles:["Tech Lottery","Treasure Wheel"],messages:["INITIATING PROBABILITY CASCADE...","QUANTUM OUTCOME GENERATOR READY.","CALCULATING OPTIMAL REWARD DISTRIBUTION..."],encounterScript:""},scifi_terminal:{name:"Supply Terminal",imagePath:"",type:"merchant",description:"An automated supply kiosk that exchanges resources for equipment.",merchantItemCount:{min:2,max:4},merchantItemPool:"Rare Artifacts",messages:["SUPPLY EXCHANGE TERMINAL ONLINE.","TRADE PROTOCOLS ACTIVATED.","RESOURCES DETECTED. INITIATING EXCHANGE."],encounterScript:""},cyber_fixer:{name:"Street Fixer",imagePath:"",type:"messenger",description:"A well-connected operative with chrome implants who deals in underground intel.",messages:["Word on the street is things are about to get hot.","Got a tip for you, choom. For free this time.","Corp goons are crawling all over this sector.","Watch your back. Trust no one."],encounterScript:""},cyber_enforcer:{name:"Corp Enforcer",imagePath:"",type:"battlebar",description:"A heavily augmented corporate security agent with combat-grade cyberware.",battlebarProfiles:["Street Fight","Elite Combat"],messages:["You're in restricted space, meat.","Corporate property. No trespassing.","This won't take long."],encounterScript:""},cyber_casino:{name:"Underground Casino",imagePath:"",type:"prizewheel",description:"An illegal gambling den hidden in the neon underbelly of the city.",wheelProfiles:["Gambler's Wheel","Dark Bargain"],messages:["Step right up, choom. Feeling lucky?","The house always wins... usually.","High stakes, high rewards. You in?"],encounterScript:""},cyber_market:{name:"Black Market",imagePath:"",type:"merchant",description:"A shady dealer offering hot merchandise with no questions asked.",merchantItemCount:{min:2,max:4},merchantItemPool:"Black Market Tech",messages:["Fell off a truck. Very recently.","You didn't get this from me.","Best prices in Night City. Untraceable."],encounterScript:""},western_crier:{name:"Town Crier",imagePath:"",type:"messenger",description:"A weathered old-timer who shares news and gossip from around these parts.",messages:["Howdy, stranger! Word is there's trouble ahead.","Outlaws been seen in these parts lately.","Watch your back out there, partner.","This here's dangerous territory."],encounterScript:""},western_outlaw:{name:"Outlaw",imagePath:"",type:"battlebar",description:"A notorious desperado with a quick draw and a mean streak.",battlebarProfiles:["Showdown","Street Fight"],messages:["This town ain't big enough for the both of us.","Draw, stranger!","Your money or your life!"],encounterScript:""},western_gambler:{name:"Saloon Gambler",imagePath:"",type:"prizewheel",description:"A slick card shark who runs games of chance in the back room.",wheelProfiles:["Gambler's Wheel","Mystery Wheel"],messages:["Care to try your luck, partner?","The wheel never lies.","Fortune favors the bold... sometimes."],encounterScript:""},western_trader:{name:"Traveling Trader",imagePath:"",type:"merchant",description:"A dusty merchant with a wagon full of frontier supplies.",merchantItemCount:{min:2,max:4},merchantItemPool:"Frontier Trading Post",messages:["Got supplies fresh from back East!","Fair prices for fair folks.","Need anything for the trail ahead?"],encounterScript:""},action_intel:{name:"Intel Officer",imagePath:"",type:"messenger",description:"A tactical advisor providing real-time mission intelligence via secure comms.",messages:["Intel update: multiple hostiles in your AO.","HQ reports enemy movement ahead.","Objective markers updated. Stay frosty.","Watch your sectors, operator."],encounterScript:""},action_combatant:{name:"Enemy Combatant",imagePath:"",type:"battlebar",description:"A heavily armed hostile operative blocking your route to the objective.",battlebarProfiles:["Street Fight","Elite Combat"],messages:["Contact! Engaging!","You're not getting past me!","Target acquired!"],encounterScript:""},action_supply:{name:"Supply Drop",imagePath:"",type:"prizewheel",description:"An airdropped supply crate with randomized military-grade equipment.",wheelProfiles:["Treasure Wheel","Mystery Wheel"],messages:["Supply drop inbound. Contents unknown.","Field requisition package received.","Let's see what command sent us..."],encounterScript:""},action_dealer:{name:"Arms Dealer",imagePath:"",type:"merchant",description:"A private military contractor offering tactical equipment trades.",merchantItemCount:{min:2,max:4},merchantItemPool:"Rare Artifacts",messages:["Need to gear up, soldier?","Top-shelf hardware. Fair exchange.","Got what you need to complete the mission."],encounterScript:""},fantasy_knight:{name:"Dark Knight",imagePath:"",type:"turnbased",description:"A corrupted paladin wielding a cursed blade, challenging all who pass.",turnbasedProfiles:["Skeleton Warrior","Goblin Ambush"],messages:["My blade hungers for battle!","You shall fall like all the others!","Honor demands we fight!"],encounterScript:""},fantasy_mage:{name:"Arcane Duelist",imagePath:"",type:"turnbased",description:"A battle mage who tests worthy opponents with magical combat.",turnbasedProfiles:["Dragon Whelp","Skeleton Warrior"],messages:["Your skills shall be tested!","Face the power of the arcane!","Magic and steel shall decide this!"],encounterScript:""},horror_wraith:{name:"Vengeful Wraith",imagePath:"",type:"turnbased",description:"A tortured spirit seeking to drag the living into eternal darkness.",turnbasedProfiles:["Vampire Lord","Skeleton Warrior"],messages:["JOIN USSS IN DEATH...","Your soul will never escape!","The grave awaits you!"],encounterScript:""},horror_butcher:{name:"The Butcher",imagePath:"",type:"turnbased",description:"A massive, blood-soaked figure wielding a cleaver, blocking the only exit.",turnbasedProfiles:["Boss Battle","Vampire Lord"],messages:["Fresh meat...","No one leaves alive!","I'll add you to my collection!"],encounterScript:""},scifi_commander:{name:"Rogue Commander",imagePath:"",type:"turnbased",description:"A cybernetically enhanced military officer who went AWOL.",turnbasedProfiles:["Dragon Whelp","Skeleton Warrior"],messages:["TACTICAL ENGAGEMENT INITIATED.","You are outmatched, organic.","Combat protocols: Maximum force."],encounterScript:""},scifi_mech:{name:"Combat Mech",imagePath:"",type:"turnbased",description:"A bipedal war machine with heavy armor and integrated weapons.",turnbasedProfiles:["Boss Battle","Vampire Lord"],messages:["TARGET LOCKED.","WEAPONS SYSTEMS ONLINE.","RESISTANCE IS FUTILE."],encounterScript:""},cyber_samurai:{name:"Street Samurai",imagePath:"",type:"turnbased",description:"A chrome-plated warrior following an ancient code of combat.",turnbasedProfiles:["Dragon Whelp","Skeleton Warrior"],messages:["My blade cuts faster than your reflexes.","This is your only warning, choom.","Honor demands satisfaction."],encounterScript:""},cyber_boss:{name:"Corp Executive",imagePath:"",type:"turnbased",description:"A heavily augmented corporate overlord with military-grade implants.",turnbasedProfiles:["Boss Battle","Vampire Lord"],messages:["You think you can hurt me?","I own this entire district.","Time to flatline, street trash."],encounterScript:""},western_sheriff:{name:"Corrupt Sheriff",imagePath:"",type:"turnbased",description:"A lawman gone bad, enforcing his own twisted version of justice.",turnbasedProfiles:["Skeleton Warrior","Goblin Ambush"],messages:["The law says you die today.","I AM the law in these parts!","Draw, outlaw!"],encounterScript:""},western_bandit:{name:"Bandit Leader",imagePath:"",type:"turnbased",description:"The notorious head of a ruthless gang of desperados.",turnbasedProfiles:["Boss Battle","Dragon Whelp"],messages:["My gang will avenge me!","You'll never take me alive!","This territory belongs to me!"],encounterScript:""},action_soldier:{name:"Elite Soldier",imagePath:"",type:"turnbased",description:"A highly trained special forces operator guarding a critical position.",turnbasedProfiles:["Skeleton Warrior","Dragon Whelp"],messages:["Engage! Engage!","You picked the wrong fight!","This position will not fall!"],encounterScript:""},action_warlord:{name:"Warlord",imagePath:"",type:"turnbased",description:"A legendary mercenary commander with countless victories.",turnbasedProfiles:["Boss Battle","Vampire Lord"],messages:["I've killed a hundred like you.","No retreat, no surrender!","Your death will be glorious!"],encounterScript:""},fantasy_assassin:{name:"Shadow Assassin",imagePath:"",type:"qte",description:"A deadly assassin who strikes from the shadows with lightning speed.",qteProfiles:["Quick Dodge","Combat Flurry"],messages:["Can you match my speed?","Reflexes determine survival!","Too slow means death!"],encounterScript:""},horror_crawler:{name:"Ceiling Crawler",imagePath:"",type:"qte",description:"A twisted creature that drops from above, attacking with terrifying speed.",qteProfiles:["Reaction Test","Quick Dodge"],messages:["*skittering sounds*","AHHHHHH!","*inhuman screech*"],encounterScript:""},scifi_drone:{name:"Attack Drone",imagePath:"",type:"qte",description:"An agile combat drone that requires quick reflexes to evade.",qteProfiles:["Combat Flurry","Boss Sequence"],messages:["EVASION PROTOCOL ACTIVE.","TRACKING TARGET.","ATTACK RUN INITIATED."],encounterScript:""},cyber_netrunner:{name:"Hostile Netrunner",imagePath:"",type:"qte",description:"A hacker attempting to fry your neural implants remotely.",qteProfiles:["Boss Sequence","Deadly Dance"],messages:["Jacking into your system...","Let's see how fast you really are.","Your ICE is pathetic."],encounterScript:""},western_quickdraw:{name:"Quick Draw Duelist",imagePath:"",type:"qte",description:"A legendary gunslinger known for the fastest draw in the West.",qteProfiles:["Reaction Test","Quick Dodge"],messages:["On the count of three...","Fastest hand wins.","Hope you made your peace."],encounterScript:""},action_sniper:{name:"Enemy Sniper",imagePath:"",type:"qte",description:"A hidden marksman forcing you to react quickly to laser sights.",qteProfiles:["Combat Flurry","Quick Dodge"],messages:["*laser sight on your chest*","SNIPER! GET DOWN!","Contact! Overwatch position!"],encounterScript:""},fantasy_sphinx:{name:"The Sphinx",imagePath:"",type:"dice",description:"An ancient creature that tests travelers with games of chance and skill.",diceProfiles:["Skill Check","Saving Throw"],messages:["Answer my challenge or perish!","Fate shall decide your worth.","Roll the bones of destiny!"],encounterScript:""},horror_demon:{name:"Gambling Demon",imagePath:"",type:"dice",description:"A fiend who wagers souls in games of infernal chance.",diceProfiles:["High Stakes","Fate's Judgment"],messages:["Care to wager your soul?","The dice are loaded with destiny!","Even demons play fair... sometimes."],encounterScript:""},scifi_quantum:{name:"Quantum Entity",imagePath:"",type:"dice",description:"A being existing in multiple probability states simultaneously.",diceProfiles:["Skill Check","High Stakes"],messages:["PROBABILITY COLLAPSE IMMINENT.","YOUR FATE EXISTS IN SUPERPOSITION.","OBSERVE THE OUTCOME."],encounterScript:""},cyber_ripperdoc:{name:"Back-Alley Ripperdoc",imagePath:"",type:"dice",description:"An unlicensed surgeon who might save you... or butcher you.",diceProfiles:["Lucky Roll","Skill Check"],messages:["Steady hands? Let's find out.","Don't worry, I've done this before. Mostly.","Surgery is just controlled dice rolls."],encounterScript:""},western_dealer:{name:"Card Sharp",imagePath:"",type:"dice",description:"A professional gambler who stakes high and never loses... fairly.",diceProfiles:["Lucky Roll","High Stakes"],messages:["Lady luck is fickle today.","All in, stranger?","The cards never lie."],encounterScript:""},action_defuser:{name:"Bomb Disposal",imagePath:"",type:"dice",description:"A tense situation requiring precision and luck to disarm an explosive.",diceProfiles:["Saving Throw","Fate's Judgment"],messages:["Red wire or blue wire...","Steady... steady...","One wrong move and we're all dead."],encounterScript:""},fantasy_patrol:{name:"Castle Guards",imagePath:"",type:"stealth",description:"Vigilant sentries patrolling the castle corridors.",stealthProfiles:["Guard Patrol","Watchful Sentry"],messages:["Did you hear something?","All clear in sector seven.","Stay alert, men!"],encounterScript:""},horror_stalker:{name:"The Stalker",imagePath:"",type:"stealth",description:"A relentless hunter that tracks by sound and smell.",stealthProfiles:["Shadow Run","Impossible Infiltration"],messages:["*sniffing sounds*","I can smell your fear...","You cannot hide from me!"],encounterScript:""},scifi_sensors:{name:"Security Grid",imagePath:"",type:"stealth",description:"An automated sensor network scanning for intruders.",stealthProfiles:["Watchful Sentry","Shadow Run"],messages:["MOTION DETECTED. SCANNING...","THERMAL SIGNATURES ANALYZED.","SECTOR SWEEP IN PROGRESS."],encounterScript:""},cyber_patrol:{name:"Corp Security",imagePath:"",type:"stealth",description:"Corporate security forces with state-of-the-art surveillance.",stealthProfiles:["Guard Patrol","Shadow Run"],messages:["Sweep the perimeter.","Thermal scan clear... wait.","Something tripped the sensors."],encounterScript:""},western_posse:{name:"Sheriff's Posse",imagePath:"",type:"stealth",description:"A group of lawmen searching for fugitives.",stealthProfiles:["Simple Sneak","Guard Patrol"],messages:["Fan out! They're here somewhere!","Check behind those barrels!","We'll smoke 'em out!"],encounterScript:""},action_patrol:{name:"Guard Patrol",imagePath:"",type:"stealth",description:"Military guards with NVGs and motion sensors.",stealthProfiles:["Watchful Sentry","Impossible Infiltration"],messages:["Movement. Sector four.","Checking blind spots.","Stay frosty. We got activity."],encounterScript:""},fantasy_golem:{name:"Puzzle Golem",imagePath:"",type:"puzzle",description:"An ancient construct that only allows passage to those who solve its riddles.",puzzleProfiles:["Simple Riddle","Memory Trial"],messages:["Solve my puzzle or be destroyed.","Your mind shall be tested.","Only the clever may pass."],encounterScript:""},horror_mirror:{name:"Puzzle Box",imagePath:"",type:"puzzle",description:"A sinister device that must be solved to prevent something terrible.",puzzleProfiles:["Pattern Maze","Logic Lock"],messages:["The box... you opened it...","Solve it or suffer eternal torment!","Your mind against the void..."],encounterScript:""},scifi_terminal_puzzle:{name:"Security Terminal",imagePath:"",type:"puzzle",description:"A locked terminal requiring a sequence bypass to access.",puzzleProfiles:["Memory Trial","Pattern Maze"],messages:["ACCESS DENIED. INITIATING SEQUENCE TEST.","AUTHENTICATE VIA PATTERN RECOGNITION.","UNAUTHORIZED ACCESS ATTEMPT LOGGED."],encounterScript:""},cyber_ice:{name:"Black ICE",imagePath:"",type:"puzzle",description:"Lethal intrusion countermeasures requiring precise mental navigation.",puzzleProfiles:["Logic Lock","Mind Shatter"],messages:["ICE DETECTED. BEGINNING BREACH.","Neural firewall engaged.","Crack the code or fry your brain."],encounterScript:""},western_safe:{name:"Bank Vault",imagePath:"",type:"puzzle",description:"A complex combination lock protecting the town's valuables.",puzzleProfiles:["Simple Riddle","Memory Trial"],messages:["Four turns left, three right...","Listen for the click...","One wrong move and the alarm sounds."],encounterScript:""},action_bomb:{name:"Bomb Defusal",imagePath:"",type:"puzzle",description:"A ticking bomb that must be disarmed following a specific sequence.",puzzleProfiles:["Pattern Maze","Mind Shatter"],messages:["60 seconds on the clock!","Follow the sequence exactly!","No pressure... just don't mess up."],encounterScript:""},fantasy_diplomat:{name:"Royal Emissary",imagePath:"",type:"negotiation",description:"A noble diplomat who might grant passage for the right price or persuasion.",negotiationProfiles:["Friendly Chat","Noble Audience"],messages:["Perhaps we can reach an arrangement.","The crown demands respect.","State your business, traveler."],encounterScript:""},horror_pact:{name:"Dark Bargainer",imagePath:"",type:"negotiation",description:"An otherworldly entity offering terrible deals.",negotiationProfiles:["Dark Pact","Guard Bribery"],messages:["I offer you... a deal.","Your soul is of interest to me.","Everything has a price..."],encounterScript:""},scifi_bureaucrat:{name:"Station Administrator",imagePath:"",type:"negotiation",description:"A by-the-book official who controls access to restricted areas.",negotiationProfiles:["Friendly Chat","Merchant Haggle"],messages:["AUTHORIZATION REQUIRED.","Perhaps we can expedite your paperwork.","Regulations must be followed... usually."],encounterScript:""},cyber_fixer_deal:{name:"Connected Fixer",imagePath:"",type:"negotiation",description:"A well-connected middleman who can make things happen... for a price.",negotiationProfiles:["Merchant Haggle","Guard Bribery"],messages:["Everything's negotiable in Night City.","I know people who know people.","What's this worth to you, choom?"],encounterScript:""},western_mayor:{name:"Corrupt Mayor",imagePath:"",type:"negotiation",description:"The town's crooked leader who can be persuaded with the right approach.",negotiationProfiles:["Friendly Chat","Guard Bribery"],messages:["This town runs on my schedule.","Perhaps we can help each other.","Gold speaks louder than words."],encounterScript:""},action_commander_deal:{name:"Field Commander",imagePath:"",type:"negotiation",description:"An enemy officer who might be convinced to stand down.",negotiationProfiles:["Merchant Haggle","Noble Audience"],messages:["You want to avoid bloodshed? Talk.","I have orders... but orders can change.","Make it worth my while."],encounterScript:""}},Ie={spike_trap:{name:"Spike Trap",imagePath:"",message:"Sharp spikes shoot up from ancient pressure plates!",script:'/setvar key=trapdmg {{roll:2d4}} | /mazedamage amount={{getvar::trapdmg}} source="spike trap" | /echo {{user}} took {{getvar::trapdmg}} damage from the spikes!',avoidChance:25,avoidMessage:"You leap back just as the spikes shoot up!",avoidScript:"/echo {{user}} narrowly avoided the spike trap!"},poison_dart:{name:"Poison Dart",imagePath:"",message:"Darts fly from hidden slits in the wall!",script:'/setvar key=trapdmg {{roll:1d6+2}} | /mazedamage amount={{getvar::trapdmg}} source="poison dart" | /echo {{user}} was struck by poisoned darts for {{getvar::trapdmg}} damage!',avoidChance:30,avoidMessage:"You duck just in time as darts whistle overhead!",avoidScript:"/echo {{user}} dodged the poison darts!"},magic_rune:{name:"Magic Rune",imagePath:"",message:"An arcane glyph flares to life beneath your feet!",script:'/setvar key=trapdmg {{roll:2d6}} | /mazedamage amount={{getvar::trapdmg}} source="magic rune" | /echo The rune explodes! {{user}} takes {{getvar::trapdmg}} arcane damage!',avoidChance:20,avoidMessage:"You sense the magic and step aside as the rune flares!",avoidScript:"/echo {{user}} sensed the magical trap and avoided it!"},ghostly_grasp:{name:"Ghostly Grasp",imagePath:"",message:"Spectral hands reach up from the floor!",script:'/setvar key=trapdmg {{roll:1d6+1}} | /mazedamage amount={{getvar::trapdmg}} source="ghostly grasp" | /echo Icy fingers drain {{getvar::trapdmg}} life from {{user}}!',avoidChance:25,avoidMessage:"The spectral hands grasp at empty air as you pull away!",avoidScript:"/echo {{user}} escaped the ghostly grasp!"},blood_pool:{name:"Blood Pool",imagePath:"",message:"The floor gives way to a pool of viscous crimson!",script:'/setvar key=trapdmg {{roll:2d4}} | /mazedamage amount={{getvar::trapdmg}} source="blood pool" | /echo The cursed blood burns {{user}} for {{getvar::trapdmg}} damage!',avoidChance:20,avoidMessage:"You grab the edge and pull yourself back before falling in!",avoidScript:"/echo {{user}} narrowly avoided falling into the blood pool!"},cursed_mirror:{name:"Cursed Mirror",imagePath:"",message:"Your reflection grins and reaches through the glass!",script:'/setvar key=trapdmg {{roll:2d6}} | /mazedamage amount={{getvar::trapdmg}} source="cursed mirror" | /echo Your doppelganger claws {{user}} for {{getvar::trapdmg}} damage!',avoidChance:15,avoidMessage:"You avert your eyes just as your reflection reaches out!",avoidScript:"/echo {{user}} refused to look at the cursed mirror!"},laser_grid:{name:"Laser Grid",imagePath:"",message:"Red laser beams crisscross the corridor!",script:'/setvar key=trapdmg {{roll:2d4+2}} | /mazedamage amount={{getvar::trapdmg}} source="laser grid" | /echo Security lasers burn {{user}} for {{getvar::trapdmg}} damage!',avoidChance:30,avoidMessage:"You contort through the laser grid without triggering it!",avoidScript:"/echo {{user}} gracefully navigated the laser grid!"},gas_leak:{name:"Gas Leak",imagePath:"",message:"A ruptured pipe sprays toxic coolant!",script:'/setvar key=trapdmg {{roll:1d8+1}} | /mazedamage amount={{getvar::trapdmg}} source="gas leak" | /echo Toxic gas burns {{user}} for {{getvar::trapdmg}} damage!',avoidChance:25,avoidMessage:"You hold your breath and rush past the gas leak!",avoidScript:"/echo {{user}} held their breath and avoided the toxic gas!"},gravity_trap:{name:"Gravity Trap",imagePath:"",message:"The gravity plating malfunctions violently!",script:'/setvar key=trapdmg {{roll:2d6}} | /mazedamage amount={{getvar::trapdmg}} source="gravity trap" | /echo {{user}} slams into the ceiling for {{getvar::trapdmg}} damage!',avoidChance:20,avoidMessage:"You grab a handhold as the gravity fluctuates!",avoidScript:"/echo {{user}} braced themselves against the gravity shift!"},electric_floor:{name:"Electric Floor",imagePath:"",message:"The chrome flooring crackles with lethal voltage!",script:'/setvar key=trapdmg {{roll:2d4+3}} | /mazedamage amount={{getvar::trapdmg}} source="electric floor" | /echo Electricity surges through {{user}} for {{getvar::trapdmg}} damage!',avoidChance:25,avoidMessage:"You leap to a non-conductive surface just in time!",avoidScript:"/echo {{user}} jumped clear of the electric floor!"},neural_spike:{name:"Neural Spike",imagePath:"",message:"A hidden ICE program attacks your neural interface!",script:'/setvar key=trapdmg {{roll:2d6}} | /mazedamage amount={{getvar::trapdmg}} source="neural spike" | /echo The ICE fries your synapses for {{getvar::trapdmg}} damage!',avoidChance:20,avoidMessage:"Your firewall blocks the ICE attack!",avoidScript:"/echo Your cyberdeck deflected the neural spike!"},security_turret:{name:"Security Turret",imagePath:"",message:"An automated turret drops from the ceiling!",script:'/setvar key=trapdmg {{roll:3d4}} | /mazedamage amount={{getvar::trapdmg}} source="security turret" | /echo The turret peppers {{user}} for {{getvar::trapdmg}} damage!',avoidChance:30,avoidMessage:"You dive behind cover as the turret opens fire!",avoidScript:"/echo {{user}} took cover before the turret could lock on!"},bear_trap:{name:"Bear Trap",imagePath:"",message:"A rusted bear trap snaps shut on your leg!",script:'/setvar key=trapdmg {{roll:2d4+2}} | /mazedamage amount={{getvar::trapdmg}} source="bear trap" | /echo The iron jaws bite {{user}} for {{getvar::trapdmg}} damage!',avoidChance:25,avoidMessage:"You spot the bear trap and step around it!",avoidScript:"/echo {{user}} carefully avoided the bear trap!"},dynamite:{name:"Dynamite",imagePath:"",message:"A tripwire ignites a bundle of dynamite!",script:'/setvar key=trapdmg {{roll:3d6}} | /mazedamage amount={{getvar::trapdmg}} source="dynamite" | /echo BOOM! {{user}} takes {{getvar::trapdmg}} explosion damage!',avoidChance:20,avoidMessage:"You cut the tripwire before it triggers the dynamite!",avoidScript:"/echo {{user}} disarmed the dynamite trap!"},snake_pit:{name:"Snake Pit",imagePath:"",message:"The floor collapses into a writhing pit of rattlesnakes!",script:'/setvar key=trapdmg {{roll:2d4+1}} | /mazedamage amount={{getvar::trapdmg}} source="snake pit" | /echo The snakes strike {{user}} for {{getvar::trapdmg}} venom damage!',avoidChance:25,avoidMessage:"You jump back as the floor crumbles away!",avoidScript:"/echo {{user}} leapt clear of the snake pit!"},tripwire:{name:"Tripwire",imagePath:"",message:"Your foot catches a nearly invisible wire!",script:'/setvar key=trapdmg {{roll:2d6+2}} | /mazedamage amount={{getvar::trapdmg}} source="tripwire" | /echo The explosive detonates! {{user}} takes {{getvar::trapdmg}} damage!',avoidChance:30,avoidMessage:"You spot the tripwire and step over it!",avoidScript:"/echo {{user}} spotted and avoided the tripwire!"},flashbang:{name:"Flashbang",imagePath:"",message:"A proximity sensor triggers a flashbang grenade!",script:'/setvar key=trapdmg {{roll:1d6+2}} | /mazedamage amount={{getvar::trapdmg}} source="flashbang" | /echo The blast disorients {{user}} for {{getvar::trapdmg}} damage!',avoidChance:25,avoidMessage:"You shield your eyes and ears as the flashbang detonates!",avoidScript:"/echo {{user}} braced for the flashbang!"},claymore:{name:"Claymore",imagePath:"",message:"You step into the kill zone of a claymore mine!",script:'/setvar key=trapdmg {{roll:4d6}} | /mazedamage amount={{getvar::trapdmg}} source="claymore" | /echo Steel balls shred {{user}} for {{getvar::trapdmg}} damage!',avoidChance:15,avoidMessage:"You freeze and slowly back out of the kill zone!",avoidScript:"/echo {{user}} carefully retreated from the claymore!"}},Te={"Common Goods":{description:"Basic supplies and common items",items:[{id:"key",name:"Key",description:"Opens locked doors",icon:"",weight:30},{id:"stealth",name:"Stealth Cloak",description:"Slip past one encounter",icon:"",weight:25},{id:"strike",name:"Strike",description:"Power attack in combat",icon:"",weight:25},{id:"healingPotion",name:"Healing Potion",description:"Restores health",icon:"",weight:20}]},"Adventurer Supplies":{description:"Essential gear for dungeon delvers",items:[{id:"key",name:"Key",description:"Opens locked doors",icon:"",weight:20},{id:"stealth",name:"Stealth Cloak",description:"Slip past one encounter",icon:"",weight:20},{id:"strike",name:"Strike",description:"Power attack in combat",icon:"",weight:20},{id:"execute",name:"Grandstrike",description:"Devastating finishing blow",icon:"",weight:10},{id:"floorKey",name:"Floor Key",description:"Access the next floor",icon:"",weight:10},{id:"healingPotion",name:"Healing Potion",description:"Restores health",icon:"",weight:20}]},"Rare Artifacts":{description:"Magical items of significant power",items:[{id:"execute",name:"Grandstrike",description:"Devastating finishing blow",icon:"",weight:15},{id:"floorKey",name:"Floor Key",description:"Access the next floor",icon:"",weight:15},{id:"portalStone",name:"Portal Stone",description:"Teleport to safety",icon:"",weight:15},{id:"minionBane",name:"Minion Bane",description:"Instantly defeats a minion",icon:"",weight:15},{id:"greaterHealing",name:"Greater Healing",description:"Fully restores health",icon:"",weight:20},{id:"mapFragment",name:"Map Fragment",description:"Reveals the maze",icon:"",weight:20}]},"Dark Market":{description:"Forbidden wares from the underworld",items:[{id:"minionBane",name:"Minion Bane",description:"Instantly defeats a minion",icon:"",weight:20},{id:"voidWalk",name:"Void Walk",description:"Phase through walls",icon:"",weight:15},{id:"timeShard",name:"Time Shard",description:"Manipulate time",icon:"",weight:15},{id:"execute",name:"Grandstrike",description:"Devastating finishing blow",icon:"",weight:20},{id:"elixir",name:"Elixir",description:"Powerful restorative",icon:"",weight:15},{id:"revivalCharm",name:"Revival Charm",description:"Return from defeat",icon:"",weight:15}]},"Frontier Trading Post":{description:"Supplies for the open frontier",items:[{id:"key",name:"Key",description:"Opens locked doors",icon:"",weight:20},{id:"strike",name:"Strike",description:"Power attack in combat",icon:"",weight:25},{id:"stealth",name:"Stealth Cloak",description:"Slip past one encounter",icon:"",weight:15},{id:"healingPotion",name:"Healing Potion",description:"Restores health",icon:"",weight:25},{id:"execute",name:"Grandstrike",description:"Devastating finishing blow",icon:"",weight:15}]},"Black Market Tech":{description:"Cutting-edge contraband tech",items:[{id:"voidWalk",name:"Phase Implant",description:"Phase through walls",icon:"",weight:15},{id:"minionBane",name:"EMP Grenade",description:"Instantly defeats a minion",icon:"",weight:20},{id:"mapFragment",name:"Scanner Chip",description:"Reveals the maze",icon:"",weight:20},{id:"portalStone",name:"Teleport Beacon",description:"Teleport to safety",icon:"",weight:15},{id:"execute",name:"Overcharge Cell",description:"Devastating finishing blow",icon:"",weight:15},{id:"timeShard",name:"Stasis Field",description:"Manipulate time",icon:"",weight:15}]}},Be={"Fantasy Pack":{minions:["fantasy_herald","fantasy_guardian","fantasy_oracle","fantasy_merchant"]},"Horror Pack":{minions:["horror_spirit","horror_revenant","horror_gambler","horror_graverobber"]},"Sci-Fi Pack":{minions:["scifi_ai","scifi_bot","scifi_matrix","scifi_terminal"]},"Cyberpunk Pack":{minions:["cyber_fixer","cyber_enforcer","cyber_casino","cyber_market"]},"Western Pack":{minions:["western_crier","western_outlaw","western_gambler","western_trader"]},"Action Pack":{minions:["action_intel","action_combatant","action_supply","action_dealer"]},"Fantasy Extended":{minions:["fantasy_herald","fantasy_guardian","fantasy_oracle","fantasy_merchant","fantasy_knight","fantasy_mage","fantasy_assassin","fantasy_sphinx","fantasy_patrol","fantasy_golem","fantasy_diplomat"]},"Horror Extended":{minions:["horror_spirit","horror_revenant","horror_gambler","horror_graverobber","horror_wraith","horror_butcher","horror_crawler","horror_demon","horror_stalker","horror_mirror","horror_pact"]},"Sci-Fi Extended":{minions:["scifi_ai","scifi_bot","scifi_matrix","scifi_terminal","scifi_commander","scifi_mech","scifi_drone","scifi_quantum","scifi_sensors","scifi_terminal_puzzle","scifi_bureaucrat"]},"Cyberpunk Extended":{minions:["cyber_fixer","cyber_enforcer","cyber_casino","cyber_market","cyber_samurai","cyber_boss","cyber_netrunner","cyber_ripperdoc","cyber_patrol","cyber_ice","cyber_fixer_deal"]},"Western Extended":{minions:["western_crier","western_outlaw","western_gambler","western_trader","western_sheriff","western_bandit","western_quickdraw","western_dealer","western_posse","western_safe","western_mayor"]},"Action Extended":{minions:["action_intel","action_combatant","action_supply","action_dealer","action_soldier","action_warlord","action_sniper","action_defuser","action_patrol","action_bomb","action_commander_deal"]},"Fantasy Turn-Based":{minions:["fantasy_herald","fantasy_knight","fantasy_mage","fantasy_merchant"]},"Horror Turn-Based":{minions:["horror_spirit","horror_wraith","horror_butcher","horror_graverobber"]},"Sci-Fi Turn-Based":{minions:["scifi_ai","scifi_commander","scifi_mech","scifi_terminal"]},"Cyberpunk Turn-Based":{minions:["cyber_fixer","cyber_samurai","cyber_boss","cyber_market"]},"Western Turn-Based":{minions:["western_crier","western_sheriff","western_bandit","western_trader"]},"Action Turn-Based":{minions:["action_intel","action_soldier","action_warlord","action_dealer"]}},De={"Fantasy Traps":{traps:["spike_trap","poison_dart","magic_rune"]},"Horror Traps":{traps:["ghostly_grasp","blood_pool","cursed_mirror"]},"Sci-Fi Traps":{traps:["laser_grid","gas_leak","gravity_trap"]},"Cyberpunk Traps":{traps:["electric_floor","neural_spike","security_turret"]},"Western Traps":{traps:["bear_trap","dynamite","snake_pit"]},"Action Traps":{traps:["tripwire","flashbang","claymore"]}},Le={"Dungeon Crawl - Easy":{gridSize:6,floors:1,difficulty:"easy",theme:"fantasy",mapStyle:"dungeon",mapVisibility:"showAll",winCommand:"/echo Congratulations! You escaped the dungeon!",loseCommand:"/echo The dungeon claims another victim...",winMessage:"You found the exit and escaped the ancient dungeon!",winImage:"",mainMinion:"fantasy_guardian",mainMinionIntroMessage:"Welcome to my dungeon, adventurer. Find the exit... if you can!",mainMinionRandomChance:15,mainMinionRandomMessages:["Still wandering, I see...","Many have tried. Few have succeeded."],mainMinionExitType:"battlebar",mainMinionExitProfile:"Dungeon Guardian",minionEncounters:[{minionId:"fantasy_herald",percent:2},{minionId:"fantasy_guardian",percent:1},{minionId:"fantasy_oracle",percent:1}],trapEncounters:[{trapId:"spike_trap",percent:1},{trapId:"poison_dart",percent:1}],onBattlebarLoss:"respawn",chestTilePercent:10,chestLockedPercent:20,chestLockedBonusPercent:50,chestMimicPercent:5,chestLootMin:2,chestLootMax:4,chestKeyChance:40,chestStrikeChance:50,chestStealthChance:20,chestExecuteChance:2,lockedChestKeyChance:30,lockedChestStrikeChance:60,lockedChestStealthChance:30,lockedChestExecuteChance:5,startingInventory:{key:2,strike:2,stealth:1,execute:0,healingPotion:2,greaterHealing:0,elixir:0,revivalCharm:0},hpEnabled:!0,maxHP:130,battlebarDamageMultiplier:.7,onDeath:"respawn",respawnHPPercent:75,safeRoomCount:4,safeRoomHealPercent:100,safeRoomUseLLM:!1,restEnabled:!0,restHealPercent:30,restCooldown:2,restInterruptChance:0,restInterruptScript:"",storyConfig:{mainStory:"You descend into a small dungeon. Perfect for adventurers just starting out..."},findEarly:{radius:5,items:["lantern","torch","healingPotion","mapFragment"],itemsPerChest:2},fairness:{enabled:!0,keyPityThreshold:3,healingPityThreshold:4,lowHpThreshold:.4,mercyUnlock:!0,mercyUnlockThreshold:2}},"Dungeon Crawl - Hard":{gridSize:12,floors:2,difficulty:"hard",theme:"fantasy",mapStyle:"dungeon",mapVisibility:"hideUnexplored",winCommand:"/echo Glory! You have conquered the depths!",loseCommand:"/echo The abyss swallows another soul...",winMessage:"Through blood and steel, you found the exit!",winImage:"",mainMinion:"fantasy_guardian",mainMinionIntroMessage:"You dare challenge my domain? Prove your worth!",mainMinionRandomChance:25,mainMinionRandomMessages:["Your bones will join the others...","The deeper you go, the darker it gets."],mainMinionExitType:"battlebar",mainMinionExitProfile:"Knight's Challenge",minionEncounters:[{minionId:"fantasy_herald",percent:4},{minionId:"fantasy_guardian",percent:4},{minionId:"fantasy_oracle",percent:2}],trapEncounters:[{trapId:"spike_trap",percent:3},{trapId:"poison_dart",percent:3},{trapId:"magic_rune",percent:2}],onBattlebarLoss:"respawn",chestTilePercent:6,chestLockedPercent:40,chestLockedBonusPercent:60,chestMimicPercent:20,chestLootMin:1,chestLootMax:2,chestKeyChance:30,chestStrikeChance:40,chestStealthChance:15,chestExecuteChance:3,lockedChestKeyChance:25,lockedChestStrikeChance:55,lockedChestStealthChance:25,lockedChestExecuteChance:8,startingInventory:{key:1,strike:0,stealth:0,execute:0,healingPotion:1,greaterHealing:0,elixir:0,revivalCharm:0},hpEnabled:!0,maxHP:80,battlebarDamageMultiplier:1.3,onDeath:"respawnPenalty",respawnHPPercent:50,safeRoomCount:2,safeRoomHealPercent:75,safeRoomUseLLM:!1,restEnabled:!0,restHealPercent:15,restCooldown:4,restInterruptChance:25,restInterruptScript:"",storyConfig:{mainStory:"The ancient fortress looms before you. Two floors of deadly challenges await..."},findEarly:{radius:3,items:["torch","healingPotion"],itemsPerChest:1}},"Enchanted Forest - Medium":{gridSize:10,floors:1,difficulty:"normal",theme:"fantasy",mapStyle:"forest",mapVisibility:"fogOfWar",winCommand:"/echo You emerge from the mystical woods!",loseCommand:"/echo The forest claims you as its own...",winMessage:"You found your way through the enchanted grove!",winImage:"",mainMinion:"fantasy_oracle",mainMinionIntroMessage:"The spirits of the forest watch you, traveler...",mainMinionRandomChance:20,mainMinionRandomMessages:["The trees whisper your name...","Nature is not always kind."],mainMinionExitType:"prizewheel",mainMinionExitProfile:"Blessing Wheel",minionEncounters:[{minionId:"fantasy_herald",percent:3},{minionId:"fantasy_oracle",percent:2},{minionId:"fantasy_merchant",percent:1}],trapEncounters:[{trapId:"magic_rune",percent:2},{trapId:"poison_dart",percent:2}],onBattlebarLoss:"respawn",chestTilePercent:8,chestLockedPercent:30,chestLockedBonusPercent:50,chestMimicPercent:10,chestLootMin:1,chestLootMax:3,chestKeyChance:35,chestStrikeChance:45,chestStealthChance:20,chestExecuteChance:2,lockedChestKeyChance:25,lockedChestStrikeChance:55,lockedChestStealthChance:25,lockedChestExecuteChance:6,startingInventory:{key:1,strike:1,stealth:0,execute:0,healingPotion:1,greaterHealing:0,elixir:0,revivalCharm:0},hpEnabled:!0,maxHP:100,battlebarDamageMultiplier:1,onDeath:"respawn",respawnHPPercent:50,safeRoomCount:3,safeRoomHealPercent:100,safeRoomUseLLM:!1,restEnabled:!0,restHealPercent:20,restCooldown:3,restInterruptChance:10,restInterruptScript:"",storyConfig:{mainStory:"Ancient trees tower overhead as you enter the enchanted forest..."},findEarly:{radius:4,items:["torch","healingPotion","mapFragment"],itemsPerChest:1}},"Haunted Manor - Easy":{gridSize:7,floors:1,difficulty:"easy",theme:"horror",mapStyle:"apartment",mapVisibility:"showAll",winCommand:"/echo You escape the haunted manor!",loseCommand:"/echo The spirits claim another soul...",winMessage:"You escaped the haunted manor... but the nightmares will follow.",winImage:"",mainMinion:"horror_revenant",mainMinionIntroMessage:"Welcome to my home... you will never leave...",mainMinionRandomChance:20,mainMinionRandomMessages:["I can smell your fear...","The walls are watching..."],mainMinionExitType:"battlebar",mainMinionExitProfile:"Horror Encounter",minionEncounters:[{minionId:"horror_spirit",percent:3},{minionId:"horror_gambler",percent:2}],trapEncounters:[{trapId:"ghostly_grasp",percent:2},{trapId:"blood_pool",percent:1}],onBattlebarLoss:"respawn",chestTilePercent:10,chestLockedPercent:20,chestLockedBonusPercent:50,chestMimicPercent:10,chestLootMin:2,chestLootMax:4,chestKeyChance:40,chestStrikeChance:50,chestStealthChance:25,chestExecuteChance:2,lockedChestKeyChance:30,lockedChestStrikeChance:55,lockedChestStealthChance:30,lockedChestExecuteChance:5,startingInventory:{key:2,strike:2,stealth:1,execute:0,healingPotion:2,greaterHealing:0,elixir:0,revivalCharm:0},hpEnabled:!0,maxHP:130,battlebarDamageMultiplier:.7,onDeath:"respawn",respawnHPPercent:75,safeRoomCount:4,safeRoomHealPercent:100,safeRoomUseLLM:!0,restEnabled:!0,restHealPercent:30,restCooldown:2,restInterruptChance:15,restInterruptScript:"",storyConfig:{mainStory:"The manor door creaks open. Something draws you inside..."},findEarly:{radius:5,items:["lantern","torch","healingPotion","mapFragment"],itemsPerChest:2}},"Haunted Manor - Nightmare":{gridSize:12,floors:3,difficulty:"nightmare",theme:"horror",mapStyle:"highrise",mapVisibility:"hideUnexplored",winCommand:"/echo Against all odds, you survived!",loseCommand:"/echo Your screams echo for eternity...",winMessage:"You escaped... but at what cost?",winImage:"",mainMinion:"horror_revenant",mainMinionIntroMessage:"There is no escape. There never was.",mainMinionRandomChance:30,mainMinionRandomMessages:["YOU CANNOT RUN!","DEATH IS ONLY THE BEGINNING!","JOIN US..."],mainMinionExitType:"battlebar",mainMinionExitProfile:"Nightmare Battle",minionEncounters:[{minionId:"horror_spirit",percent:5},{minionId:"horror_revenant",percent:4},{minionId:"horror_gambler",percent:3}],trapEncounters:[{trapId:"ghostly_grasp",percent:4},{trapId:"blood_pool",percent:3},{trapId:"cursed_mirror",percent:3}],onBattlebarLoss:"respawn",chestTilePercent:5,chestLockedPercent:50,chestLockedBonusPercent:70,chestMimicPercent:25,chestLootMin:1,chestLootMax:2,chestKeyChance:25,chestStrikeChance:35,chestStealthChance:20,chestExecuteChance:5,lockedChestKeyChance:20,lockedChestStrikeChance:50,lockedChestStealthChance:30,lockedChestExecuteChance:10,startingInventory:{key:0,strike:0,stealth:0,execute:0,healingPotion:0,greaterHealing:0,elixir:0,revivalCharm:0},hpEnabled:!0,maxHP:80,battlebarDamageMultiplier:1.4,onDeath:"gameover",respawnHPPercent:25,safeRoomCount:2,safeRoomHealPercent:60,safeRoomUseLLM:!0,restEnabled:!0,restHealPercent:15,restCooldown:4,restInterruptChance:40,restInterruptScript:"",storyConfig:{mainStory:"Three floors of pure terror. No supplies. No mercy. Good luck..."},findEarly:{radius:2,items:["torch"],itemsPerChest:1}},"Space Station - Medium":{gridSize:10,floors:2,difficulty:"normal",theme:"scifi",mapStyle:"spacestation",mapVisibility:"fogOfWar",winCommand:"/echo Mission complete. Extraction successful.",loseCommand:"/echo Hull breach detected. Life signs terminated.",winMessage:"You reached the escape pods and evacuated safely!",winImage:"",mainMinion:"scifi_bot",mainMinionIntroMessage:"UNAUTHORIZED PERSONNEL DETECTED. INITIATING LOCKDOWN.",mainMinionRandomChance:20,mainMinionRandomMessages:["SCANNING... THREAT LEVEL ELEVATED.","SECURITY PROTOCOLS ACTIVE."],mainMinionExitType:"battlebar",mainMinionExitProfile:"Security Drone",minionEncounters:[{minionId:"scifi_ai",percent:3},{minionId:"scifi_bot",percent:2},{minionId:"scifi_matrix",percent:1}],trapEncounters:[{trapId:"laser_grid",percent:3},{trapId:"gas_leak",percent:2}],onBattlebarLoss:"respawn",chestTilePercent:8,chestLockedPercent:30,chestLockedBonusPercent:50,chestMimicPercent:10,chestLootMin:1,chestLootMax:3,chestKeyChance:35,chestStrikeChance:45,chestStealthChance:20,chestExecuteChance:3,lockedChestKeyChance:25,lockedChestStrikeChance:55,lockedChestStealthChance:25,lockedChestExecuteChance:7,startingInventory:{key:1,strike:1,stealth:0,execute:0,healingPotion:1,greaterHealing:0,elixir:0,revivalCharm:0},hpEnabled:!0,maxHP:100,battlebarDamageMultiplier:1,onDeath:"respawn",respawnHPPercent:50,safeRoomCount:3,safeRoomHealPercent:100,safeRoomUseLLM:!1,restEnabled:!0,restHealPercent:20,restCooldown:3,restInterruptChance:15,restInterruptScript:"",storyConfig:{mainStory:"The station alarms blare. Find the escape pods before it's too late..."},findEarly:{radius:4,items:["torch","healingPotion","mapFragment"],itemsPerChest:1}},"Space Station - Hard":{gridSize:14,floors:3,difficulty:"hard",theme:"scifi",mapStyle:"spacestation",mapVisibility:"hideUnexplored",winCommand:"/echo EXTRACTION COMPLETE. WELL DONE, OPERATIVE.",loseCommand:"/echo MISSION FAILED. ASSET TERMINATED.",winMessage:"Against impossible odds, you escaped the derelict station!",winImage:"",mainMinion:"scifi_bot",mainMinionIntroMessage:"CRITICAL ALERT: HOSTILE AI HAS TAKEN CONTROL.",mainMinionRandomChance:25,mainMinionRandomMessages:["RESISTANCE IS FUTILE.","ALL SECTORS COMPROMISED."],mainMinionExitType:"battlebar",mainMinionExitProfile:"System Override",minionEncounters:[{minionId:"scifi_ai",percent:4},{minionId:"scifi_bot",percent:4},{minionId:"scifi_matrix",percent:2}],trapEncounters:[{trapId:"laser_grid",percent:3},{trapId:"gas_leak",percent:3},{trapId:"gravity_trap",percent:2}],onBattlebarLoss:"respawn",chestTilePercent:6,chestLockedPercent:40,chestLockedBonusPercent:60,chestMimicPercent:15,chestLootMin:1,chestLootMax:2,chestKeyChance:30,chestStrikeChance:40,chestStealthChance:15,chestExecuteChance:4,lockedChestKeyChance:25,lockedChestStrikeChance:50,lockedChestStealthChance:25,lockedChestExecuteChance:8,startingInventory:{key:1,strike:0,stealth:0,execute:0,healingPotion:1,greaterHealing:0,elixir:0,revivalCharm:0},hpEnabled:!0,maxHP:80,battlebarDamageMultiplier:1.3,onDeath:"respawnPenalty",respawnHPPercent:40,safeRoomCount:2,safeRoomHealPercent:75,safeRoomUseLLM:!1,restEnabled:!0,restHealPercent:15,restCooldown:4,restInterruptChance:25,restInterruptScript:"",storyConfig:{mainStory:"Three decks. Rogue AI. Failing life support. Move fast or die..."},findEarly:{radius:3,items:["torch","healingPotion"],itemsPerChest:1}},"Neon Streets - Medium":{gridSize:10,floors:1,difficulty:"normal",theme:"cyberpunk",mapStyle:"neotokyo",mapVisibility:"fogOfWar",winCommand:"/echo Run complete. Payout received, choom.",loseCommand:"/echo Flatlined. Your chrome belongs to the corp now.",winMessage:"You made it through the neon jungle!",winImage:"",mainMinion:"cyber_enforcer",mainMinionIntroMessage:"You picked the wrong sector to run through, meat.",mainMinionRandomChance:20,mainMinionRandomMessages:["Corp knows you're here.","No one escapes the grid."],mainMinionExitType:"battlebar",mainMinionExitProfile:"Street Fight",minionEncounters:[{minionId:"cyber_fixer",percent:3},{minionId:"cyber_enforcer",percent:2},{minionId:"cyber_casino",percent:1}],trapEncounters:[{trapId:"electric_floor",percent:3},{trapId:"neural_spike",percent:2}],onBattlebarLoss:"respawn",chestTilePercent:8,chestLockedPercent:30,chestLockedBonusPercent:50,chestMimicPercent:10,chestLootMin:1,chestLootMax:3,chestKeyChance:35,chestStrikeChance:45,chestStealthChance:20,chestExecuteChance:3,lockedChestKeyChance:25,lockedChestStrikeChance:55,lockedChestStealthChance:25,lockedChestExecuteChance:7,startingInventory:{key:1,strike:1,stealth:0,execute:0,healingPotion:1,greaterHealing:0,elixir:0,revivalCharm:0},hpEnabled:!0,maxHP:100,battlebarDamageMultiplier:1,onDeath:"respawn",respawnHPPercent:50,safeRoomCount:2,safeRoomHealPercent:100,safeRoomUseLLM:!1,restEnabled:!0,restHealPercent:20,restCooldown:3,restInterruptChance:20,restInterruptScript:"",storyConfig:{mainStory:"Neon lights flicker overhead as you enter the dangerous megacity streets..."},findEarly:{radius:4,items:["torch","healingPotion","mapFragment"],itemsPerChest:1}},"Neon Streets - Nightmare":{gridSize:14,floors:2,difficulty:"nightmare",theme:"cyberpunk",mapStyle:"city",mapVisibility:"hideUnexplored",winCommand:"/echo Preem run, choom. You're a legend now.",loseCommand:"/echo Game over. Insert credit to continue... just kidding.",winMessage:"You survived the corporate kill squads and made it out!",winImage:"",mainMinion:"cyber_enforcer",mainMinionIntroMessage:"Corporate has authorized lethal force. There's nowhere to run.",mainMinionRandomChance:30,mainMinionRandomMessages:["Your biosigns are being tracked.","Every exit is covered."],mainMinionExitType:"battlebar",mainMinionExitProfile:"Elite Combat",minionEncounters:[{minionId:"cyber_fixer",percent:5},{minionId:"cyber_enforcer",percent:4},{minionId:"cyber_casino",percent:3}],trapEncounters:[{trapId:"electric_floor",percent:4},{trapId:"neural_spike",percent:3},{trapId:"security_turret",percent:3}],onBattlebarLoss:"respawn",chestTilePercent:5,chestLockedPercent:50,chestLockedBonusPercent:70,chestMimicPercent:20,chestLootMin:1,chestLootMax:2,chestKeyChance:25,chestStrikeChance:35,chestStealthChance:20,chestExecuteChance:5,lockedChestKeyChance:20,lockedChestStrikeChance:50,lockedChestStealthChance:30,lockedChestExecuteChance:10,startingInventory:{key:0,strike:0,stealth:0,execute:0,healingPotion:0,greaterHealing:0,elixir:0,revivalCharm:0},hpEnabled:!0,maxHP:80,battlebarDamageMultiplier:1.4,onDeath:"gameover",respawnHPPercent:25,safeRoomCount:2,safeRoomHealPercent:60,safeRoomUseLLM:!1,restEnabled:!0,restHealPercent:15,restCooldown:4,restInterruptChance:35,restInterruptScript:"",storyConfig:{mainStory:"Two sectors of corporate hell. No gear. No backup. Pure nightmare mode..."},findEarly:{radius:2,items:["torch"],itemsPerChest:1}},"Wild Frontier - Easy":{gridSize:8,floors:1,difficulty:"easy",theme:"western",mapStyle:"outpost",mapVisibility:"showAll",winCommand:"/echo You ride off into the sunset, partner.",loseCommand:"/echo This town wasn't big enough for the both of ya.",winMessage:"You cleared the outpost and rode on to new adventures!",winImage:"",mainMinion:"western_outlaw",mainMinionIntroMessage:"Howdy, stranger. This here's my territory.",mainMinionRandomChance:15,mainMinionRandomMessages:["Keep walking, partner.","Outlaws don't take kindly to trespassers."],mainMinionExitType:"battlebar",mainMinionExitProfile:"Showdown",minionEncounters:[{minionId:"western_crier",percent:2},{minionId:"western_gambler",percent:2}],trapEncounters:[{trapId:"bear_trap",percent:2},{trapId:"snake_pit",percent:1}],onBattlebarLoss:"respawn",chestTilePercent:10,chestLockedPercent:20,chestLockedBonusPercent:50,chestMimicPercent:5,chestLootMin:2,chestLootMax:4,chestKeyChance:40,chestStrikeChance:50,chestStealthChance:15,chestExecuteChance:2,lockedChestKeyChance:30,lockedChestStrikeChance:55,lockedChestStealthChance:25,lockedChestExecuteChance:5,startingInventory:{key:2,strike:2,stealth:1,execute:0,healingPotion:2,greaterHealing:0,elixir:0,revivalCharm:0},hpEnabled:!0,maxHP:130,battlebarDamageMultiplier:.7,onDeath:"respawn",respawnHPPercent:75,safeRoomCount:3,safeRoomHealPercent:100,safeRoomUseLLM:!1,restEnabled:!0,restHealPercent:30,restCooldown:2,restInterruptChance:5,restInterruptScript:"",storyConfig:{mainStory:"Dust swirls as you enter the frontier outpost. Adventure awaits..."},findEarly:{radius:5,items:["lantern","torch","healingPotion","mapFragment"],itemsPerChest:2}},"Tactical Ops - Hard":{gridSize:12,floors:2,difficulty:"hard",theme:"action",mapStyle:"arena",mapVisibility:"hideUnexplored",winCommand:"/echo Mission accomplished. Outstanding work, operator.",loseCommand:"/echo KIA. Mission failed.",winMessage:"Objective secured! Extraction complete!",winImage:"",mainMinion:"action_combatant",mainMinionIntroMessage:"Multiple hostiles in the AO. Weapons hot.",mainMinionRandomChance:25,mainMinionRandomMessages:["Contact left!","Stay frosty, operator."],mainMinionExitType:"battlebar",mainMinionExitProfile:"Elite Combat",minionEncounters:[{minionId:"action_intel",percent:4},{minionId:"action_combatant",percent:4},{minionId:"action_supply",percent:2}],trapEncounters:[{trapId:"tripwire",percent:3},{trapId:"flashbang",percent:3},{trapId:"claymore",percent:2}],onBattlebarLoss:"respawn",chestTilePercent:6,chestLockedPercent:40,chestLockedBonusPercent:60,chestMimicPercent:15,chestLootMin:1,chestLootMax:2,chestKeyChance:30,chestStrikeChance:45,chestStealthChance:15,chestExecuteChance:4,lockedChestKeyChance:25,lockedChestStrikeChance:55,lockedChestStealthChance:25,lockedChestExecuteChance:8,startingInventory:{key:1,strike:0,stealth:0,execute:0,healingPotion:1,greaterHealing:0,elixir:0,revivalCharm:0},hpEnabled:!0,maxHP:80,battlebarDamageMultiplier:1.3,onDeath:"respawnPenalty",respawnHPPercent:40,safeRoomCount:2,safeRoomHealPercent:75,safeRoomUseLLM:!1,restEnabled:!0,restHealPercent:15,restCooldown:4,restInterruptChance:30,restInterruptScript:"",storyConfig:{mainStory:"Tactical insertion complete. Two floors of hostiles between you and extraction..."},findEarly:{radius:3,items:["torch","healingPotion"],itemsPerChest:1}},"Comedy Dungeon - Easy":{gridSize:6,floors:1,difficulty:"easy",theme:"comedy",mapStyle:"maze",mapVisibility:"showAll",winCommand:"/echo You win! The crowd goes mild!",loseCommand:"/echo Wah wah wahhh... Game Over, buddy.",winMessage:"Congratulations! You found the extremely obvious exit!",winImage:"",mainMinion:"fantasy_oracle",mainMinionIntroMessage:"Welcome to the World's Okayest Dungeon! Try not to trip.",mainMinionRandomChance:20,mainMinionRandomMessages:["Having fun yet?","This is fine. Everything is fine.","Bruh."],mainMinionExitType:"prizewheel",mainMinionExitProfile:"Gambler's Wheel",minionEncounters:[{minionId:"fantasy_herald",percent:3},{minionId:"fantasy_merchant",percent:2}],trapEncounters:[{trapId:"spike_trap",percent:1},{trapId:"magic_rune",percent:1}],onBattlebarLoss:"respawn",chestTilePercent:10,chestLockedPercent:20,chestLockedBonusPercent:50,chestMimicPercent:5,chestLootMin:2,chestLootMax:4,chestKeyChance:45,chestStrikeChance:55,chestStealthChance:20,chestExecuteChance:3,lockedChestKeyChance:35,lockedChestStrikeChance:60,lockedChestStealthChance:25,lockedChestExecuteChance:5,startingInventory:{key:2,strike:2,stealth:1,execute:0,healingPotion:3,greaterHealing:1,elixir:0,revivalCharm:0},hpEnabled:!0,maxHP:150,battlebarDamageMultiplier:.5,onDeath:"respawn",respawnHPPercent:100,safeRoomCount:5,safeRoomHealPercent:100,safeRoomUseLLM:!1,restEnabled:!0,restHealPercent:50,restCooldown:1,restInterruptChance:0,restInterruptScript:"",storyConfig:{mainStory:"Welcome to a dungeon that doesn't take itself too seriously. Enjoy!"},findEarly:{radius:5,items:["lantern","torch","healingPotion","mapFragment"],itemsPerChest:2}},"Turn-Based Arena - Easy":{gridSize:7,floors:1,difficulty:"easy",theme:"fantasy",mapStyle:"arena",mapVisibility:"showAll",winCommand:"/echo You are victorious! The crowd roars with approval!",loseCommand:"/echo The arena claims another challenger...",winMessage:"You conquered the arena through tactical combat!",winImage:"",mainMinion:"fantasy_knight",mainMinionIntroMessage:"Welcome to the arena, warrior. Prove yourself in battle!",mainMinionRandomChance:25,mainMinionRandomMessages:["Another challenger approaches!","The crowd demands blood!"],mainMinionExitType:"turnbased",mainMinionExitProfile:"Skeleton Warrior",minionEncounters:[{minionId:"fantasy_herald",percent:2},{minionId:"fantasy_knight",percent:4},{minionId:"fantasy_mage",percent:3},{minionId:"fantasy_merchant",percent:1}],trapEncounters:[{trapId:"spike_trap",percent:1}],onBattlebarLoss:"respawn",chestTilePercent:10,chestLockedPercent:20,chestLockedBonusPercent:50,chestMimicPercent:5,chestLootMin:2,chestLootMax:4,chestKeyChance:40,chestStrikeChance:50,chestStealthChance:20,chestExecuteChance:2,lockedChestKeyChance:30,lockedChestStrikeChance:60,lockedChestStealthChance:30,lockedChestExecuteChance:5,startingInventory:{key:2,strike:2,stealth:1,execute:0,healingPotion:3,greaterHealing:1,elixir:0,revivalCharm:0},hpEnabled:!0,maxHP:130,battlebarDamageMultiplier:.7,onDeath:"respawn",respawnHPPercent:75,safeRoomCount:4,safeRoomHealPercent:100,safeRoomUseLLM:!1,restEnabled:!0,restHealPercent:30,restCooldown:2,restInterruptChance:0,restInterruptScript:"",storyConfig:{mainStory:"The arena gates open. Fight your way to glory through turn-based combat!"},findEarly:{radius:5,items:["lantern","torch","healingPotion","mapFragment"],itemsPerChest:2}},"Turn-Based Arena - Hard":{gridSize:12,floors:2,difficulty:"hard",theme:"fantasy",mapStyle:"arena",mapVisibility:"hideUnexplored",winCommand:"/echo Champion! You have proven yourself against all odds!",loseCommand:"/echo Even champions fall eventually...",winMessage:"You fought through two floors of warriors to claim victory!",winImage:"",mainMinion:"fantasy_knight",mainMinionIntroMessage:"The Grand Champion awaits. Can you defeat me?",mainMinionRandomChance:30,mainMinionRandomMessages:["Your skills are impressive, but not enough!","The arena never forgives weakness!"],mainMinionExitType:"turnbased",mainMinionExitProfile:"Boss Battle",minionEncounters:[{minionId:"fantasy_knight",percent:5},{minionId:"fantasy_mage",percent:4},{minionId:"fantasy_assassin",percent:2},{minionId:"fantasy_diplomat",percent:1}],trapEncounters:[{trapId:"spike_trap",percent:2},{trapId:"poison_dart",percent:2}],onBattlebarLoss:"respawn",chestTilePercent:6,chestLockedPercent:40,chestLockedBonusPercent:60,chestMimicPercent:15,chestLootMin:1,chestLootMax:2,chestKeyChance:30,chestStrikeChance:40,chestStealthChance:15,chestExecuteChance:3,lockedChestKeyChance:25,lockedChestStrikeChance:55,lockedChestStealthChance:25,lockedChestExecuteChance:8,startingInventory:{key:1,strike:1,stealth:0,execute:0,healingPotion:2,greaterHealing:0,elixir:0,revivalCharm:0},hpEnabled:!0,maxHP:80,battlebarDamageMultiplier:1.3,onDeath:"respawnPenalty",respawnHPPercent:50,safeRoomCount:2,safeRoomHealPercent:75,safeRoomUseLLM:!1,restEnabled:!0,restHealPercent:15,restCooldown:4,restInterruptChance:25,restInterruptScript:"",storyConfig:{mainStory:"Two floors of increasingly difficult turn-based battles await. Prepare for war!"},findEarly:{radius:3,items:["torch","healingPotion"],itemsPerChest:1}},"Combat Gauntlet - Medium":{gridSize:10,floors:1,difficulty:"normal",theme:"fantasy",mapStyle:"dungeon",mapVisibility:"fogOfWar",winCommand:"/echo You mastered every combat style and emerged victorious!",loseCommand:"/echo The gauntlet proved too challenging...",winMessage:"You faced every type of challenge and conquered them all!",winImage:"",mainMinion:"fantasy_golem",mainMinionIntroMessage:"The Gauntlet tests all forms of combat. Prove your worth!",mainMinionRandomChance:20,mainMinionRandomMessages:["Every step brings a new challenge!","Adapt or perish!"],mainMinionExitType:"puzzle",mainMinionExitProfile:"Logic Lock",minionEncounters:[{minionId:"fantasy_knight",percent:3},{minionId:"fantasy_assassin",percent:2},{minionId:"fantasy_sphinx",percent:2},{minionId:"fantasy_patrol",percent:2},{minionId:"fantasy_golem",percent:2},{minionId:"fantasy_diplomat",percent:1}],trapEncounters:[{trapId:"spike_trap",percent:2},{trapId:"magic_rune",percent:2}],onBattlebarLoss:"respawn",chestTilePercent:8,chestLockedPercent:30,chestLockedBonusPercent:50,chestMimicPercent:10,chestLootMin:1,chestLootMax:3,chestKeyChance:35,chestStrikeChance:45,chestStealthChance:20,chestExecuteChance:3,lockedChestKeyChance:25,lockedChestStrikeChance:55,lockedChestStealthChance:25,lockedChestExecuteChance:7,startingInventory:{key:2,strike:1,stealth:1,execute:0,healingPotion:2,greaterHealing:0,elixir:0,revivalCharm:0},hpEnabled:!0,maxHP:100,battlebarDamageMultiplier:1,onDeath:"respawn",respawnHPPercent:50,safeRoomCount:3,safeRoomHealPercent:100,safeRoomUseLLM:!1,restEnabled:!0,restHealPercent:20,restCooldown:3,restInterruptChance:10,restInterruptScript:"",storyConfig:{mainStory:"The Combat Gauntlet tests every skill: combat, reflexes, stealth, puzzles, and diplomacy!"},findEarly:{radius:4,items:["torch","healingPotion","mapFragment"],itemsPerChest:1}},"Cyberpunk Heist - Hard":{gridSize:12,floors:2,difficulty:"hard",theme:"cyberpunk",mapStyle:"highrise",mapVisibility:"hideUnexplored",winCommand:"/echo Preem job, choom. The data is ours.",loseCommand:"/echo Flatlined. Your body will never be found.",winMessage:"You infiltrated the corp tower and extracted the data!",winImage:"",mainMinion:"cyber_boss",mainMinionIntroMessage:"You think you can steal from me? The entire tower is now hunting you.",mainMinionRandomChance:25,mainMinionRandomMessages:["Initiating building-wide lockdown.","Your biosigns are being tracked."],mainMinionExitType:"turnbased",mainMinionExitProfile:"Boss Battle",minionEncounters:[{minionId:"cyber_samurai",percent:3},{minionId:"cyber_netrunner",percent:3},{minionId:"cyber_patrol",percent:3},{minionId:"cyber_ice",percent:2},{minionId:"cyber_fixer_deal",percent:1}],trapEncounters:[{trapId:"electric_floor",percent:3},{trapId:"neural_spike",percent:3},{trapId:"security_turret",percent:2}],onBattlebarLoss:"respawn",chestTilePercent:6,chestLockedPercent:40,chestLockedBonusPercent:60,chestMimicPercent:15,chestLootMin:1,chestLootMax:2,chestKeyChance:30,chestStrikeChance:40,chestStealthChance:15,chestExecuteChance:4,lockedChestKeyChance:25,lockedChestStrikeChance:50,lockedChestStealthChance:25,lockedChestExecuteChance:8,startingInventory:{key:1,strike:0,stealth:1,execute:0,healingPotion:1,greaterHealing:0,elixir:0,revivalCharm:0},hpEnabled:!0,maxHP:80,battlebarDamageMultiplier:1.3,onDeath:"respawnPenalty",respawnHPPercent:40,safeRoomCount:2,safeRoomHealPercent:75,safeRoomUseLLM:!1,restEnabled:!0,restHealPercent:15,restCooldown:4,restInterruptChance:30,restInterruptScript:"",storyConfig:{mainStory:"Infiltrate the megacorp tower. Fight, hack, sneak, and negotiate your way to the data vault!"},findEarly:{radius:3,items:["torch","healingPotion"],itemsPerChest:1}},"Horror Survival - Nightmare":{gridSize:14,floors:3,difficulty:"nightmare",theme:"horror",mapStyle:"hospital",mapVisibility:"hideUnexplored",winCommand:"/echo You escaped... but the nightmares will never end.",loseCommand:"/echo They found you. You are one of them now.",winMessage:"Against all odds, you escaped the nightmare hospital!",winImage:"",mainMinion:"horror_butcher",mainMinionIntroMessage:"You should not have come here. Now you will never leave.",mainMinionRandomChance:12,mainMinionRandomMessages:["I can hear your heartbeat...","THERE IS NO ESCAPE!","Your fear sustains me..."],mainMinionExitType:"turnbased",mainMinionExitProfile:"Vampire Lord",minionEncounters:[{minionId:"horror_wraith",percent:3},{minionId:"horror_butcher",percent:2},{minionId:"horror_crawler",percent:3},{minionId:"horror_stalker",percent:3},{minionId:"horror_mirror",percent:2},{minionId:"horror_pact",percent:1}],trapEncounters:[{trapId:"ghostly_grasp",percent:3},{trapId:"blood_pool",percent:3},{trapId:"cursed_mirror",percent:2}],onBattlebarLoss:"respawn",chestTilePercent:8,chestLockedPercent:40,chestLockedBonusPercent:60,chestMimicPercent:20,chestLootMin:1,chestLootMax:2,chestKeyChance:30,chestStrikeChance:35,chestStealthChance:25,chestExecuteChance:5,lockedChestKeyChance:25,lockedChestStrikeChance:45,lockedChestStealthChance:30,lockedChestExecuteChance:8,startingInventory:{key:1,strike:0,stealth:1,execute:0,healingPotion:2,greaterHealing:0,elixir:0,revivalCharm:1},hpEnabled:!0,maxHP:100,battlebarDamageMultiplier:1.3,onDeath:"gameover",respawnHPPercent:25,safeRoomCount:3,safeRoomHealPercent:75,safeRoomUseLLM:!0,restEnabled:!0,restHealPercent:15,restCooldown:4,restInterruptChance:35,restInterruptScript:"",storyConfig:{mainStory:"Three floors of pure terror. Every corner hides something worse. Survive if you can..."},findEarly:{radius:4,items:["torch","healingPotion","stealth"],itemsPerChest:1}},"Zone Test - Fantasy":{gridSize:10,floors:1,difficulty:"normal",theme:"fantasy",mapStyle:"dungeon",mapVisibility:"hideUnexplored",winCommand:"/echo You cleared all zones and escaped!",loseCommand:"/echo The zones remain unconquered...",winMessage:"You unlocked every zone and found the exit!",winImage:"",mainMinion:"fantasy_guardian",mainMinionIntroMessage:"This dungeon is divided into zones. Clear rooms to unlock the next!",mainMinionRandomChance:15,mainMinionRandomMessages:["More rooms to clear...","The next zone awaits!"],mainMinionExitType:"messenger",mainMinionExitProfile:"",minionEncounters:[{minionId:"fantasy_herald",percent:5},{minionId:"fantasy_guardian",percent:4},{minionId:"fantasy_knight",percent:3}],trapEncounters:[{trapId:"spike_trap",percent:2}],onBattlebarLoss:"respawn",chestTilePercent:12,chestLockedPercent:25,chestLockedBonusPercent:50,chestMimicPercent:5,chestLootMin:2,chestLootMax:3,chestKeyChance:40,chestStrikeChance:50,chestStealthChance:20,chestExecuteChance:2,lockedChestKeyChance:30,lockedChestStrikeChance:55,lockedChestStealthChance:25,lockedChestExecuteChance:5,startingInventory:{key:2,strike:2,stealth:1,execute:0,healingPotion:2,greaterHealing:0,elixir:0,revivalCharm:0},hpEnabled:!0,maxHP:120,battlebarDamageMultiplier:.8,onDeath:"respawn",respawnHPPercent:75,safeRoomCount:3,safeRoomHealPercent:100,safeRoomUseLLM:!1,restEnabled:!0,restHealPercent:25,restCooldown:2,restInterruptChance:0,restInterruptScript:"",storyConfig:{mainStory:"The dungeon is divided into three zones. Clear rooms in each zone to unlock the next!"},findEarly:{radius:4,items:["torch","healingPotion","mapFragment"],itemsPerChest:2},bspConfig:{zoneCount:3,secretDensity:0,zonesRequireClear:!0,secretHints:!0,floorComplexityScaling:!1}},"Secret Passage Test":{gridSize:8,floors:1,difficulty:"easy",theme:"fantasy",mapStyle:"dungeon",mapVisibility:"hideUnexplored",winCommand:"/echo You found all the secrets!",loseCommand:"/echo Some secrets remain hidden...",winMessage:"You discovered hidden passages and escaped!",winImage:"",mainMinion:"fantasy_oracle",mainMinionIntroMessage:"This dungeon has many secrets. Bump into walls to find hidden passages!",mainMinionRandomChance:15,mainMinionRandomMessages:["There are secrets everywhere...","The walls have ears... and doors!"],mainMinionExitType:"messenger",mainMinionExitProfile:"",minionEncounters:[{minionId:"fantasy_herald",percent:3}],trapEncounters:[],onBattlebarLoss:"respawn",chestTilePercent:15,chestLockedPercent:30,chestLockedBonusPercent:60,chestMimicPercent:0,chestLootMin:2,chestLootMax:4,chestKeyChance:40,chestStrikeChance:50,chestStealthChance:20,chestExecuteChance:2,lockedChestKeyChance:30,lockedChestStrikeChance:55,lockedChestStealthChance:25,lockedChestExecuteChance:5,startingInventory:{key:3,strike:2,stealth:1,execute:0,healingPotion:2,greaterHealing:0,elixir:0,revivalCharm:0},hpEnabled:!0,maxHP:150,battlebarDamageMultiplier:.5,onDeath:"respawn",respawnHPPercent:100,safeRoomCount:3,safeRoomHealPercent:100,safeRoomUseLLM:!1,restEnabled:!0,restHealPercent:50,restCooldown:1,restInterruptChance:0,restInterruptScript:"",storyConfig:{mainStory:"A dungeon full of secrets! Bump into walls repeatedly to discover hidden passages."},findEarly:{radius:5,items:["torch","lantern","mapFragment"],itemsPerChest:2},bspConfig:{zoneCount:1,secretDensity:.08,zonesRequireClear:!1,secretHints:!0,floorComplexityScaling:!1}},"BSP Full Feature Test":{gridSize:12,floors:2,difficulty:"normal",theme:"fantasy",mapStyle:"dungeon",mapVisibility:"hideUnexplored",winCommand:"/echo Complete mastery of zones and secrets!",loseCommand:"/echo The dungeon remains unconquered...",winMessage:"You cleared all zones, found secrets, and conquered both floors!",winImage:"",mainMinion:"fantasy_guardian",mainMinionIntroMessage:"Welcome to the ultimate test: zones, secrets, and multi-floor progression!",mainMinionRandomChance:20,mainMinionRandomMessages:["Have you found all the secrets?","The next zone awaits...","Deeper floors hold greater challenges."],mainMinionExitType:"battlebar",mainMinionExitProfile:"Dungeon Guardian",minionEncounters:[{minionId:"fantasy_herald",percent:3},{minionId:"fantasy_guardian",percent:4},{minionId:"fantasy_knight",percent:3},{minionId:"fantasy_oracle",percent:2}],trapEncounters:[{trapId:"spike_trap",percent:2},{trapId:"poison_dart",percent:1}],onBattlebarLoss:"respawn",chestTilePercent:10,chestLockedPercent:30,chestLockedBonusPercent:50,chestMimicPercent:10,chestLootMin:1,chestLootMax:3,chestKeyChance:35,chestStrikeChance:45,chestStealthChance:20,chestExecuteChance:3,lockedChestKeyChance:25,lockedChestStrikeChance:55,lockedChestStealthChance:25,lockedChestExecuteChance:7,startingInventory:{key:2,strike:1,stealth:1,execute:0,healingPotion:2,greaterHealing:0,elixir:0,revivalCharm:0},hpEnabled:!0,maxHP:100,battlebarDamageMultiplier:1,onDeath:"respawn",respawnHPPercent:50,safeRoomCount:3,safeRoomHealPercent:100,safeRoomUseLLM:!1,restEnabled:!0,restHealPercent:20,restCooldown:3,restInterruptChance:10,restInterruptScript:"",storyConfig:{mainStory:"Two floors with 4 zones each, secret passages, and complexity scaling. The ultimate BSP test!"},findEarly:{radius:4,items:["torch","healingPotion","mapFragment"],itemsPerChest:1},bspConfig:{zoneCount:4,secretDensity:.05,zonesRequireClear:!0,secretHints:!0,floorComplexityScaling:!0}},"Sci-Fi Zone Run":{gridSize:10,floors:2,difficulty:"hard",theme:"scifi",mapStyle:"spacestation",mapVisibility:"hideUnexplored",winCommand:"/echo EXTRACTION COMPLETE. ALL ZONES SECURED.",loseCommand:"/echo CONTAINMENT FAILED. OPERATIVE LOST.",winMessage:"You cleared all security zones and reached extraction!",winImage:"",mainMinion:"scifi_bot",mainMinionIntroMessage:"ALERT: Station divided into security zones. Clear hostiles to unlock progression.",mainMinionRandomChance:25,mainMinionRandomMessages:["SECTOR LOCKDOWN ACTIVE.","ZONE ACCESS DENIED. CLEAR MORE HOSTILES."],mainMinionExitType:"battlebar",mainMinionExitProfile:"System Override",minionEncounters:[{minionId:"scifi_ai",percent:4},{minionId:"scifi_bot",percent:4},{minionId:"scifi_matrix",percent:2}],trapEncounters:[{trapId:"laser_grid",percent:3},{trapId:"gas_leak",percent:2}],onBattlebarLoss:"respawn",chestTilePercent:6,chestLockedPercent:40,chestLockedBonusPercent:60,chestMimicPercent:15,chestLootMin:1,chestLootMax:2,chestKeyChance:30,chestStrikeChance:45,chestStealthChance:20,chestExecuteChance:5,lockedChestKeyChance:25,lockedChestStrikeChance:55,lockedChestStealthChance:25,lockedChestExecuteChance:10,startingInventory:{key:1,strike:1,stealth:0,execute:0,healingPotion:1,greaterHealing:0,elixir:0,revivalCharm:0},hpEnabled:!0,maxHP:80,battlebarDamageMultiplier:1.2,onDeath:"respawn",respawnHPPercent:40,safeRoomCount:2,safeRoomHealPercent:80,safeRoomUseLLM:!1,restEnabled:!0,restHealPercent:15,restCooldown:4,restInterruptChance:20,restInterruptScript:"",storyConfig:{mainStory:"Two decks, three security zones per deck. Clear hostiles to unlock zone progression. Find hidden maintenance shafts!"},findEarly:{radius:3,items:["torch","healingPotion"],itemsPerChest:1},bspConfig:{zoneCount:3,secretDensity:.03,zonesRequireClear:!0,secretHints:!0,floorComplexityScaling:!0}}};let Re={},Ae={segments:[],isOpen:!1,isSpinning:!1,pendingRespin:!1,hasRespun:!1},Oe={isOpen:!1,profile:null,hits:0,misses:0,arrowPosition:0,arrowDirection:1,zoneStart:0,zoneEnd:0,animationId:null,lastFrameTime:0,isVictory:!1,isDefeat:!1},He={isOpen:!1,profile:null,profileName:"",playerHP:0,playerMaxHP:0,enemyHP:0,enemyMaxHP:0,currentTurn:"player",turnCount:0,isDefending:!1,isVictory:!1,isDefeat:!1,isMazeEncounter:!1,combatLog:[]},Ne={isOpen:!1,profile:null,profileName:"",sequence:[],currentIndex:0,currentTimeWindow:0,promptStartTime:0,timeoutId:null,successes:0,perfects:0,misses:0,combo:0,maxCombo:0,isComplete:!1,isSuccess:!1,combatLog:[]},qe={isOpen:!1,profile:null,profileName:"",diceResults:[],total:0,rawTotal:0,threshold:0,modifier:0,rerollsRemaining:0,isCriticalSuccess:!1,isCriticalFail:!1,isSuccess:!1,isComplete:!1,combatLog:[]},Fe={isOpen:!1,profile:null,profileName:"",currentSection:0,sectionsToPass:0,detection:0,detectionThreshold:100,isSuccess:!1,isCaught:!1,isComplete:!1,actionsTaken:0,combatLog:[]},je={isOpen:!1,profile:null,profileName:"",puzzleType:"sequence",gridSize:3,grid:[],sequence:[],playerSequence:[],currentStep:0,timeLimit:0,timeRemaining:0,timerInterval:null,hintsRemaining:0,hintsUsed:0,wrongGuesses:0,wrongGuessesAllowed:3,score:0,isShowingSequence:!1,isSuccess:!1,isFailed:!1,isComplete:!1,combatLog:[]},We={isOpen:!1,profile:null,profileName:"",favor:50,favorThreshold:75,turnsRemaining:0,turnsUsed:0,lastAction:"",lastResult:"",isSuccess:!1,isFailed:!1,isComplete:!1,combatLog:[]},Ye=!1,Ge={isOpen:!1,profile:null,profileName:null,grid:[],size:10,playerX:0,playerY:0,exitX:0,exitY:0,visited:new Set,isVictory:!1,currentMinion:null,isPaused:!1,pendingEncounter:null,exitEncounterDone:!1,currentFloor:0,totalFloors:1,floors:[],inventory:{key:0,stealth:0,strike:0,execute:0,floorKey:0,portalStone:0,minionBane:0,mapFragment:0,timeShard:0,voidWalk:0,healingPotion:0,greaterHealing:0,elixir:0,revivalCharm:0,heartCrystal:0,torch:0,lantern:0,revealScroll:0,sightPotion:0,crystalBall:0},visibility:{baseRadius:1,tempBonus:0,tempMovesLeft:0,permBonus:0,floorRevealed:!1},pendingConfirmation:null,pendingChest:null,voidWalkActive:!1,messageLog:[],hpEnabled:!0,hp:{current:100,max:100,maxBonus:0,reviveCharges:0}};const Ue={wheel:{},battlebar:{},maze:{}},Ke=new WeakSet;async function Ve(e){const{minionName:t,minionDescription:n,baseMessage:a,mainStory:o,currentMilestone:i,minionType:s}=e;if(!a)return"";if(!1===Re.llmEnabled)return console.log("[MazeMaster] LLM generation disabled, using base message"),a;if("function"!=typeof h)return console.log("[MazeMaster] generateQuietPrompt not available, using base message"),a;let r=[];o&&r.push("Story Setting: ".concat(o)),i&&r.push("Current Progress: ".concat(i));const l=n||{messenger:"a mysterious messenger who delivers cryptic hints",battlebar:"a guardian who challenges travelers to combat",prizewheel:"a fortune teller who offers games of chance",merchant:"a wandering trader who barters for rare items"}[s]||"a mysterious figure",c=Q(),d="You are ".concat(t,", ").concat(l,".\nThe player's name is ").concat(c,".\n\n").concat(r.length>0?r.join("\n")+"\n\n":"",'The player has encountered you in a maze. Based on this message template: "').concat(a,'"\n\nWrite a short, atmospheric response (1-2 sentences max, under 100 characters if possible). Stay in character. Be mysterious and engaging. You may address the player by name if appropriate. Do not use quotation marks around your response.');try{console.log("[MazeMaster] Generating LLM message for:",t);const e=await h(d,{quietToLoud:!1,skipWIAN:!0,skipWI:!0,max_length:80});if(e&&e.trim()){let t=e.trim();return t=t.replace(/^["']|["']$/g,""),t=t.replace(/^["""''']|["""''']$/g,""),console.log("[MazeMaster] Generated message:",t),t}}catch(e){console.error("[MazeMaster] LLM generation failed:",e)}return a}async function Xe(e,t){var n,a,o;if(console.log("[MazeMaster] enhanceRoomOnEntry called:",{x:e,y:t}),null===(n=Ge)||void 0===n||!n.isOpen||!Ge.profile)return void console.log("[MazeMaster] Enhancement skipped: maze not open or no profile");if(!Ge.profile.llmEnhanceRooms)return void console.log("[MazeMaster] Enhancement skipped: llmEnhanceRooms disabled in profile",Ge.profile.llmEnhanceRooms);const i=Ge.currentFloor||0,s="".concat(i,":").concat(e,",").concat(t);if(null!==(a=Ge.enhancedRooms)&&void 0!==a&&a[s])return void console.log("[MazeMaster] Room already enhanced:",s);const r=null===(o=Ge.grid[t])||void 0===o?void 0:o[e];if(!r||!r.roomInfo)return void console.log("[MazeMaster] Enhancement skipped: no cell or roomInfo at",{x:e,y:t,hasCell:!!r,hasRoomInfo:!(null==r||!r.roomInfo)});console.log("[MazeMaster] Proceeding with room enhancement for:",s);const l=r.roomInfo.description||"...",c=r.roomInfo.name||"Unknown Room",d=r.roomInfo.type||"standard",m=Ge.profile.theme||"fantasy";qa(!0);try{const e=await async function(e){var t,n,a,o;const{roomName:i,roomType:s,baseDescription:r,theme:l,sessionNotes:c}=e;if("function"!=typeof h)return console.log("[MazeMaster] generateQuietPrompt not available"),r;if(!1===Re.llmEnabled)return r;const d=(null===(n=((null===(t=Ge)||void 0===t?void 0:t.profile)||{}).storyConfig)||void 0===n?void 0:n.mainStory)||"",m=((null===(a=Ge)||void 0===a?void 0:a.currentFloor)||0)+1,p=(null===(o=Ge)||void 0===o?void 0:o.totalFloors)||1,u=Q(),g=c?c.slice(-500).split("\n").slice(-5).join("\n"):"",f="You are the narrator for a ".concat(l," dungeon crawler game.\nPlayer: ").concat(u,"\nFloor: ").concat(m,"/").concat(p,"\n").concat(d?"Story: ".concat(d,"\n"):"","\n").concat(g?"Recent events:\n".concat(g,"\n"):"",'\nThe player enters "').concat(i,'" (a ').concat(s||"standard",' room).\nBase description: "').concat(r,'"\n\nWrite a vivid, atmospheric description (2-3 sentences max). Reference recent events if relevant. Stay in theme. Do not use quotation marks.');try{console.log("[MazeMaster] Generating enhanced room description for:",i);const e=await h(f,{quietToLoud:!1,skipWIAN:!0,skipWI:!0,max_length:150});if(e&&e.trim()){let t=e.trim();return t=t.replace(/^["']|["']$/g,""),t=t.replace(/^["""''']|["""''']$/g,""),console.log("[MazeMaster] Enhanced description:",t),t}}catch(e){console.error("[MazeMaster] Room description LLM failed:",e)}return r}({roomName:c,roomType:d,baseDescription:l,theme:m,sessionNotes:Ge.sessionNotes||""});Ge.enhancedRooms||(Ge.enhancedRooms={}),Ge.enhancedRooms[s]=e,r.roomInfo.enhancedDescription=e,Aa("".concat(c,": ").concat(e),"Explore"),Fa(),console.log("[MazeMaster] Room enhanced and cached:",s)}catch(e){console.error("[MazeMaster] Room enhancement failed:",e)}finally{qa(!1)}}function Je(){var e;if(!Ge.isOpen||!Ge.profile)return null;const t=Ge.profile.storyConfig;if(!t||!t.milestones||0===t.milestones.length)return null;const n=Ge.size*Ge.size,a=((null===(e=Ge.visited)||void 0===e?void 0:e.size)||0)/n*100;let o=null;for(const e of t.milestones)a>=e.percent&&(o=e.storyUpdate);return o}function Qe(){var e;return Ge.isOpen&&Ge.profile&&(null===(e=Ge.profile.storyConfig)||void 0===e?void 0:e.mainStory)||null}function Ze(){const e=SillyTavern.getContext();e.extensionSettings[a]||(e.extensionSettings[a]=JSON.parse(JSON.stringify(ye))),Re=e.extensionSettings[a];const t=Re.factoryDefaultsVersion||0;t<9&&(console.log("[MazeMaster] Factory defaults version changed: ".concat(t," -> ").concat(9)),Re.traps||(Re.traps={}),Re.minions||(Re.minions={}),Re.profiles||(Re.profiles={}),Re.battlebarProfiles||(Re.battlebarProfiles={}),Re.turnbasedProfiles||(Re.turnbasedProfiles={}),Re.qteProfiles||(Re.qteProfiles={}),Re.diceProfiles||(Re.diceProfiles={}),Re.stealthProfiles||(Re.stealthProfiles={}),Re.puzzleProfiles||(Re.puzzleProfiles={}),Re.negotiationProfiles||(Re.negotiationProfiles={}),Re.mazeProfiles||(Re.mazeProfiles={}),Re.minionProfiles||(Re.minionProfiles={}),Re.trapProfiles||(Re.trapProfiles={}),function(){console.log("[MazeMaster] Resetting all factory defaults to version",9);for(const[e,t]of Object.entries(Ie))Re.traps[e]=JSON.parse(JSON.stringify(t));console.log("[MazeMaster] Reset",Object.keys(Ie).length,"factory traps");for(const[e,t]of Object.entries(Pe))Re.minions[e]=JSON.parse(JSON.stringify(t));console.log("[MazeMaster] Reset",Object.keys(Pe).length,"factory minions");for(const[e,t]of Object.entries(ze))Re.profiles[e]=JSON.parse(JSON.stringify(t));console.log("[MazeMaster] Reset",Object.keys(ze).length,"factory wheel profiles");for(const[e,t]of Object.entries(xe))Re.battlebarProfiles[e]=JSON.parse(JSON.stringify(t));console.log("[MazeMaster] Reset",Object.keys(xe).length,"factory battlebar profiles");for(const[e,t]of Object.entries(_e))Re.turnbasedProfiles[e]=JSON.parse(JSON.stringify(t));console.log("[MazeMaster] Reset",Object.keys(_e).length,"factory turn-based profiles");for(const[e,t]of Object.entries(we))Re.qteProfiles[e]=JSON.parse(JSON.stringify(t));console.log("[MazeMaster] Reset",Object.keys(we).length,"factory QTE profiles");for(const[e,t]of Object.entries(ke))Re.diceProfiles[e]=JSON.parse(JSON.stringify(t));console.log("[MazeMaster] Reset",Object.keys(ke).length,"factory Dice profiles");for(const[e,t]of Object.entries(Ce))Re.stealthProfiles[e]=JSON.parse(JSON.stringify(t));console.log("[MazeMaster] Reset",Object.keys(Ce).length,"factory Stealth profiles");for(const[e,t]of Object.entries(Se))Re.puzzleProfiles[e]=JSON.parse(JSON.stringify(t));console.log("[MazeMaster] Reset",Object.keys(Se).length,"factory Puzzle profiles");for(const[e,t]of Object.entries(Me))Re.negotiationProfiles[e]=JSON.parse(JSON.stringify(t));console.log("[MazeMaster] Reset",Object.keys(Me).length,"factory Negotiation profiles");for(const[e,t]of Object.entries(Le))Re.mazeProfiles[e]=JSON.parse(JSON.stringify(t));console.log("[MazeMaster] Reset",Object.keys(Le).length,"factory maze profiles");for(const[e,t]of Object.entries(Be))Re.minionProfiles[e]=JSON.parse(JSON.stringify(t));console.log("[MazeMaster] Reset",Object.keys(Be).length,"factory minion profiles");for(const[e,t]of Object.entries(De))Re.trapProfiles[e]=JSON.parse(JSON.stringify(t));console.log("[MazeMaster] Reset",Object.keys(De).length,"factory trap profiles"),Re.factoryDefaultsVersion=9,console.log("[MazeMaster] Factory defaults reset complete")}(),i());for(const e in ye)void 0===Re[e]&&(Re[e]=JSON.parse(JSON.stringify(ye[e])));Re.profiles||(Re.profiles={}),Re.battlebarProfiles||(Re.battlebarProfiles={}),Re.mazeProfiles||(Re.mazeProfiles={}),Re.minions||(Re.minions={}),Re.traps||(Re.traps={}),Re.savedMazes||(Re.savedMazes={}),Re.minionProfiles||(Re.minionProfiles={}),Re.trapProfiles||(Re.trapProfiles={});let n=!1;for(const[e,t]of Object.entries(ze))Re.profiles[e]||(Re.profiles[e]=JSON.parse(JSON.stringify(t)),n=!0,console.log("[MazeMaster] Added default wheel profile: ".concat(e)));for(const[e,t]of Object.entries(ze)){var o;const a=Re.profiles[e];if((null==a||null===(o=a.segments)||void 0===o?void 0:o.length)>0){const o=a.segments.map((e=>e.trigger));(1===new Set(o).size||o.some((e=>!e||""===e)))&&(Re.profiles[e]=JSON.parse(JSON.stringify(t)),n=!0,console.log("[MazeMaster] Fixed broken wheel profile: ".concat(e)))}}Re.currentProfile||(Re.currentProfile="Blessing Wheel");for(const[e,t]of Object.entries(xe))Re.battlebarProfiles[e]||(Re.battlebarProfiles[e]=JSON.parse(JSON.stringify(t)),n=!0,console.log("[MazeMaster] Added default battlebar profile: ".concat(e)));Re.currentBattlebarProfile||(Re.currentBattlebarProfile="Training Dummy");const s=xe["Training Dummy"];for(const[e,t]of Object.entries(Re.battlebarProfiles))for(const[a,o]of Object.entries(s))void 0===t[a]&&(t[a]=JSON.parse(JSON.stringify(o)),n=!0,console.log('[MazeMaster] Added missing field "'.concat(a,'" to battlebar profile: ').concat(e)));Re.turnbasedProfiles||(Re.turnbasedProfiles={},n=!0);for(const[e,t]of Object.entries(_e))Re.turnbasedProfiles[e]||(Re.turnbasedProfiles[e]=JSON.parse(JSON.stringify(t)),n=!0,console.log("[MazeMaster] Added default turn-based profile: ".concat(e)));Re.currentTurnbasedProfile||(Re.currentTurnbasedProfile="Training Bout");const r=_e["Training Bout"];for(const[e,t]of Object.entries(Re.turnbasedProfiles))for(const[a,o]of Object.entries(r))void 0===t[a]&&(t[a]=JSON.parse(JSON.stringify(o)),n=!0,console.log('[MazeMaster] Added missing field "'.concat(a,'" to turn-based profile: ').concat(e)));Re.qteProfiles||(Re.qteProfiles={},n=!0);for(const[e,t]of Object.entries(we))Re.qteProfiles[e]||(Re.qteProfiles[e]=JSON.parse(JSON.stringify(t)),n=!0,console.log("[MazeMaster] Added default QTE profile: ".concat(e)));Re.currentQteProfile||(Re.currentQteProfile="Reaction Test");const l=we["Reaction Test"];for(const[e,t]of Object.entries(Re.qteProfiles))for(const[a,o]of Object.entries(l))void 0===t[a]&&(t[a]=JSON.parse(JSON.stringify(o)),n=!0,console.log('[MazeMaster] Added missing field "'.concat(a,'" to QTE profile: ').concat(e)));Re.diceProfiles||(Re.diceProfiles={},n=!0);for(const[e,t]of Object.entries(ke))Re.diceProfiles[e]||(Re.diceProfiles[e]=JSON.parse(JSON.stringify(t)),n=!0,console.log("[MazeMaster] Added default Dice profile: ".concat(e)));Re.currentDiceProfile||(Re.currentDiceProfile="Lucky Roll");const c=ke["Lucky Roll"];for(const[e,t]of Object.entries(Re.diceProfiles))for(const[a,o]of Object.entries(c))void 0===t[a]&&(t[a]=JSON.parse(JSON.stringify(o)),n=!0,console.log('[MazeMaster] Added missing field "'.concat(a,'" to Dice profile: ').concat(e)));Re.stealthProfiles||(Re.stealthProfiles={},n=!0);for(const[e,t]of Object.entries(Ce))Re.stealthProfiles[e]||(Re.stealthProfiles[e]=JSON.parse(JSON.stringify(t)),n=!0,console.log("[MazeMaster] Added default Stealth profile: ".concat(e)));Re.currentStealthProfile||(Re.currentStealthProfile="Simple Sneak");const d=Ce["Simple Sneak"];for(const[e,t]of Object.entries(Re.stealthProfiles))for(const[a,o]of Object.entries(d))void 0===t[a]&&(t[a]=JSON.parse(JSON.stringify(o)),n=!0,console.log('[MazeMaster] Added missing field "'.concat(a,'" to Stealth profile: ').concat(e)));Re.puzzleProfiles||(Re.puzzleProfiles={},n=!0);for(const[e,t]of Object.entries(Se))Re.puzzleProfiles[e]||(Re.puzzleProfiles[e]=JSON.parse(JSON.stringify(t)),n=!0,console.log("[MazeMaster] Added default Puzzle profile: ".concat(e)));Re.currentPuzzleProfile||(Re.currentPuzzleProfile="Simple Riddle");const m=Se["Simple Riddle"];for(const[e,t]of Object.entries(Re.puzzleProfiles))for(const[a,o]of Object.entries(m))void 0===t[a]&&(t[a]=JSON.parse(JSON.stringify(o)),n=!0,console.log('[MazeMaster] Added missing field "'.concat(a,'" to Puzzle profile: ').concat(e)));Re.negotiationProfiles||(Re.negotiationProfiles={},n=!0);for(const[e,t]of Object.entries(Me))Re.negotiationProfiles[e]||(Re.negotiationProfiles[e]=JSON.parse(JSON.stringify(t)),n=!0,console.log("[MazeMaster] Added default Negotiation profile: ".concat(e)));Re.currentNegotiationProfile||(Re.currentNegotiationProfile="Friendly Chat");const p=Me["Friendly Chat"];for(const[e,t]of Object.entries(Re.negotiationProfiles))for(const[a,o]of Object.entries(p))void 0===t[a]&&(t[a]=JSON.parse(JSON.stringify(o)),n=!0,console.log('[MazeMaster] Added missing field "'.concat(a,'" to Negotiation profile: ').concat(e)));Re.merchantItemPools||(Re.merchantItemPools={},n=!0);for(const[e,t]of Object.entries(Te))Re.merchantItemPools[e]||(Re.merchantItemPools[e]=JSON.parse(JSON.stringify(t)),n=!0,console.log("[MazeMaster] Added default Merchant Item Pool: ".concat(e)));for(const[e,t]of Object.entries(Pe))Re.minions[e]||(Re.minions[e]=JSON.parse(JSON.stringify(t)),n=!0,console.log("[MazeMaster] Added default minion: ".concat(e)));for(const[e,t]of Object.entries(Ie))Re.traps[e]||(Re.traps[e]=JSON.parse(JSON.stringify(t)),n=!0,console.log("[MazeMaster] Added default trap: ".concat(e)));for(const[e,t]of Object.entries(Be))Re.minionProfiles[e]||(Re.minionProfiles[e]=JSON.parse(JSON.stringify(t)),n=!0,console.log("[MazeMaster] Added default minion profile: ".concat(e)));for(const[e,t]of Object.entries(De))Re.trapProfiles[e]||(Re.trapProfiles[e]=JSON.parse(JSON.stringify(t)),n=!0,console.log("[MazeMaster] Added default trap profile: ".concat(e)));for(const[e,t]of Object.entries(Le))if(Re.mazeProfiles[e]){const a=Re.mazeProfiles[e];for(const[o,i]of Object.entries(t)){const t=Array.isArray(a[o])&&0===a[o].length,s="object"==typeof a[o]&&null!==a[o]&&!Array.isArray(a[o])&&0===Object.keys(a[o]).length,r="gridSize"===o&&(!a[o]||a[o]<5),l=void 0===a[o]||t||s||r,c="startingInventory"===o&&a[o]&&"object"==typeof a[o]&&0===(a[o].key||0)&&0===(a[o].stealth||0)&&0===(a[o].strike||0)&&0===(a[o].execute||0);(l||c)&&i&&(!Array.isArray(i)||i.length>0)&&(a[o]=JSON.parse(JSON.stringify(i)),n=!0,console.log("[MazeMaster] Added missing/empty field '".concat(o,"' to maze profile: ").concat(e)))}}else Re.mazeProfiles[e]=JSON.parse(JSON.stringify(t)),n=!0,console.log("[MazeMaster] Added default maze profile: ".concat(e));Re.currentMazeProfile||(Re.currentMazeProfile="Dungeon Crawl"),n&&i(),console.log("[MazeMaster] Loaded settings:",Re)}function $e(){return Object.keys(Re.profiles||{})}function et(e){return Re.profiles[e]}function tt(){return Object.keys(Re.battlebarProfiles||{})}function nt(e){return Re.battlebarProfiles[e]}function at(e,t){var n,a,o;Re.battlebarProfiles[e]={mainTitle:t.mainTitle||"",description:t.description||"",difficulty:t.difficulty||3,hitsToWin:t.hitsToWin||5,missesToLose:t.missesToLose||3,hitCommand:t.hitCommand||"",missCommand:t.missCommand||"",winCommand:t.winCommand||"",loseCommand:t.loseCommand||"",images:t.images||[],keyDropChance:null!==(n=t.keyDropChance)&&void 0!==n?n:40,strikeDropChance:null!==(a=t.strikeDropChance)&&void 0!==a?a:20,stealthDropChance:null!==(o=t.stealthDropChance)&&void 0!==o?o:10},i(),console.log("[MazeMaster] Battlebar profile saved:",e,Re.battlebarProfiles[e])}function ot(){return Object.keys(Re.turnbasedProfiles||{})}function it(e){var t;return null===(t=Re.turnbasedProfiles)||void 0===t?void 0:t[e]}function st(e,n){Re.turnbasedProfiles||(Re.turnbasedProfiles={}),Re.turnbasedProfiles[e]=t({},n),i()}function rt(){return Object.keys(Re.qteProfiles||{})}function lt(e){var t;return null===(t=Re.qteProfiles)||void 0===t?void 0:t[e]}function ct(e,n){Re.qteProfiles||(Re.qteProfiles={}),Re.qteProfiles[e]=t({},n),i()}function dt(){return Object.keys(Re.diceProfiles||{})}function mt(e){var t;return null===(t=Re.diceProfiles)||void 0===t?void 0:t[e]}function pt(e,n){Re.diceProfiles||(Re.diceProfiles={}),Re.diceProfiles[e]=t({},n),i()}function ut(){return Object.keys(Re.stealthProfiles||{})}function ht(e){var t;return null===(t=Re.stealthProfiles)||void 0===t?void 0:t[e]}function gt(e,n){Re.stealthProfiles||(Re.stealthProfiles={}),Re.stealthProfiles[e]=t({},n),i()}function ft(){return Object.keys(Re.puzzleProfiles||{})}function vt(e){var t;return null===(t=Re.puzzleProfiles)||void 0===t?void 0:t[e]}function bt(e,n){Re.puzzleProfiles||(Re.puzzleProfiles={}),Re.puzzleProfiles[e]=t({},n),i()}function yt(){return Object.keys(Re.negotiationProfiles||{})}function zt(e){var t;return null===(t=Re.negotiationProfiles)||void 0===t?void 0:t[e]}function xt(e,n){Re.negotiationProfiles||(Re.negotiationProfiles={}),Re.negotiationProfiles[e]=t({},n),i()}function _t(){return Object.keys(Re.mazeProfiles||{})}function wt(e){return Re.mazeProfiles[e]}function kt(e,t){var n,a,o,s,r,l,c;Re.mazeProfiles[e]={gridSize:t.gridSize||10,difficulty:t.difficulty||"normal",theme:t.theme||"fantasy",mapStyle:t.mapStyle||"maze",floors:t.floors||1,mapVisibility:t.mapVisibility||"fogOfWar",winCommand:t.winCommand||"",winImage:t.winImage||"",winMessage:t.winMessage||"",mainMinion:t.mainMinion||"",mainMinionIntroMessage:t.mainMinionIntroMessage||"",mainMinionRandomChance:t.mainMinionRandomChance||15,mainMinionRandomMessages:t.mainMinionRandomMessages||[],mainMinionExitType:t.mainMinionExitType||"messenger",mainMinionExitProfile:t.mainMinionExitProfile||"",minionEncounters:t.minionEncounters||[],onBattlebarLoss:t.onBattlebarLoss||"continue",loseCommand:t.loseCommand||"",chestImage:t.chestImage||"",chestTilePercent:t.chestTilePercent||10,chestLockedPercent:t.chestLockedPercent||30,chestLockedBonusPercent:t.chestLockedBonusPercent||50,chestMimicPercent:t.chestMimicPercent||15,chestLootMin:t.chestLootMin||1,chestLootMax:t.chestLootMax||2,chestKeyChance:t.chestKeyChance||30,chestStrikeChance:t.chestStrikeChance||50,chestStealthChance:t.chestStealthChance||0,lockedChestKeyChance:t.lockedChestKeyChance||40,lockedChestStrikeChance:t.lockedChestStrikeChance||60,lockedChestStealthChance:t.lockedChestStealthChance||30,chestExecuteChance:t.chestExecuteChance||0,lockedChestExecuteChance:t.lockedChestExecuteChance||5,startingInventory:t.startingInventory||{key:0,stealth:0,strike:0,execute:0,healingPotion:0,greaterHealing:0,elixir:0,revivalCharm:0},trapEncounters:t.trapEncounters||[],storyConfig:t.storyConfig||{mainStory:"",milestones:[]},hpEnabled:!1!==t.hpEnabled,maxHP:t.maxHP||100,battlebarDamageMultiplier:null!==(n=t.battlebarDamageMultiplier)&&void 0!==n?n:1,battlebarDifficultyMultiplier:null!==(a=t.battlebarDifficultyMultiplier)&&void 0!==a?a:1,onDeath:t.onDeath||"respawn",respawnHPPercent:t.respawnHPPercent||50,safeRoomCount:null!==(o=t.safeRoomCount)&&void 0!==o?o:3,safeRoomHealPercent:null!==(s=t.safeRoomHealPercent)&&void 0!==s?s:100,safeRoomUseLLM:t.safeRoomUseLLM||!1,restEnabled:!1!==t.restEnabled,restHealPercent:null!==(r=t.restHealPercent)&&void 0!==r?r:20,restCooldown:null!==(l=t.restCooldown)&&void 0!==l?l:3,restInterruptChance:null!==(c=t.restInterruptChance)&&void 0!==c?c:0,restInterruptScript:t.restInterruptScript||""},i(),console.log("[MazeMaster] Maze profile saved:",e,Re.mazeProfiles[e])}function Ct(){return Object.keys(Re.minions||{})}function St(e){return Re.minions[e]}function Mt(e,t){Re.minions[e]={name:t.name||"Unknown",imagePath:t.imagePath||"",description:t.description||"",type:t.type||"messenger",battlebarProfiles:t.battlebarProfiles||[],wheelProfiles:t.wheelProfiles||[],messages:t.messages||[],encounterScript:t.encounterScript||"",merchantItemCount:t.merchantItemCount||{min:1,max:3},movement:t.movement||{type:"stationary",patrolRadius:3,chaseRange:5,speed:1}},i(),console.log("[MazeMaster] Minion saved:",e,Re.minions[e])}function Et(){return Object.keys(Re.traps||{})}function Pt(e){var t;return null===(t=Re.traps)||void 0===t?void 0:t[e]}function It(e,t){var n;Re.traps||(Re.traps={}),Re.traps[e]={name:t.name||"Unknown Trap",imagePath:t.imagePath||"",message:t.message||"You triggered a trap!",script:t.script||"",avoidChance:null!==(n=t.avoidChance)&&void 0!==n?n:0,avoidMessage:t.avoidMessage||"",avoidScript:t.avoidScript||""},i(),console.log("[MazeMaster] Trap saved:",e,Re.traps[e])}function Tt(e){const n=et(e);return n&&n.segments&&0!==n.segments.length?(Ae.segments=n.segments.map(((e,n)=>t(t({},e),{},{units:b[e.size]||1,color:v[n%v.length]}))),Ae.isOpen=!1,Ae.isSpinning=!1,Ae.pendingRespin=!1,Ae.hasRespun=!1,{success:!0,count:Ae.segments.length}):{error:'Profile "'.concat(e,'" not found or empty')}}function Bt(){const e=Ae.segments.filter((e=>"halfseg"===e.size)).length,t=Ae.segments.filter((e=>"doubleseg"===e.size)).length;return e!==t?(console.error("[MazeMaster] Wheel balance error: ".concat(e," halfseg(s) but ").concat(t," doubleseg(s). They must be equal.")),{valid:!1,error:"Wheel unbalanced: ".concat(e," halfseg(s)  ").concat(t," doubleseg(s)")}):{valid:!0}}function Dt(){return Ae.segments.reduce(((e,t)=>e+t.units),0)}function Lt(){const e=document.getElementById("mazemaster_wheel_modal");if(e&&e.remove(),!document.getElementById("mazemaster_wheel_styles")){const e=document.createElement("style");e.id="mazemaster_wheel_styles",e.textContent="\n        .mazemaster-wheel-overlay {\n            position: fixed;\n            top: 0;\n            left: 0;\n            right: 0;\n            bottom: 0;\n            background: rgba(0, 0, 0, 0.95);\n            display: flex;\n            align-items: flex-start;\n            justify-content: center;\n            z-index: 10002;\n            overflow-y: auto;\n            padding: 10px 0;\n            -webkit-overflow-scrolling: touch;\n        }\n\n        .mazemaster-wheel-container {\n            position: relative;\n            display: flex;\n            flex-direction: column;\n            align-items: center;\n            gap: 20px;\n            padding: 25px;\n            margin: auto;\n            background: #1a1a2e;\n            border-radius: 15px;\n            border: 2px solid #333;\n            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);\n        }\n\n        .mazemaster-wheel-pointer {\n            position: absolute;\n            top: -20px;\n            left: 50%;\n            transform: translateX(-50%);\n            width: 0;\n            height: 0;\n            border-left: 15px solid transparent;\n            border-right: 15px solid transparent;\n            border-top: 30px solid #fff;\n            z-index: 10;\n            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));\n        }\n\n        #mazemaster_wheel_canvas {\n            border-radius: 50%;\n            box-shadow: 0 0 30px rgba(0,0,0,0.5), inset 0 0 20px rgba(255,255,255,0.1);\n            transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99);\n        }\n\n        .mazemaster-spin-btn {\n            padding: 15px 40px;\n            font-size: 1.2em;\n            font-weight: bold;\n            background: linear-gradient(135deg, #e74c3c, #c0392b);\n            color: white;\n            border: none;\n            border-radius: 30px;\n            cursor: pointer;\n            display: flex;\n            align-items: center;\n            gap: 10px;\n            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);\n            transition: transform 0.2s, box-shadow 0.2s;\n        }\n\n        .mazemaster-spin-btn:hover {\n            transform: scale(1.05);\n            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.6);\n        }\n\n        .mazemaster-spin-btn:disabled {\n            background: #555;\n            cursor: not-allowed;\n            box-shadow: none;\n            transform: none;\n        }\n\n        .mazemaster-spin-btn.respin {\n            background: linear-gradient(135deg, #f39c12, #d68910);\n            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.4);\n        }\n\n        .mazemaster-spin-btn.respin:hover {\n            box-shadow: 0 6px 20px rgba(243, 156, 18, 0.6);\n        }\n    ",document.head.appendChild(e)}const t=document.createElement("div");t.innerHTML='\n        <div id="mazemaster_wheel_modal" style="position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:999999;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.95);">\n            <div class="mazemaster-wheel-container">\n                <div class="mazemaster-wheel-pointer"></div>\n                <canvas id="mazemaster_wheel_canvas" width="400" height="400"></canvas>\n                <button id="mazemaster_spin_btn" class="mazemaster-spin-btn">\n                    <i class="fa-solid fa-play"></i> SPIN\n                </button>\n            </div>\n        </div>\n    ',document.body.appendChild(t.firstElementChild);const n=document.getElementById("mazemaster_wheel_canvas");n&&function(e){const t=e.getContext("2d"),n=e.width/2,a=e.height/2,o=Math.min(n,a)-10;t.clearRect(0,0,e.width,e.height);const i=Dt();let s=-Math.PI/2;for(const e of Ae.segments){const r=e.units/i*2*Math.PI;t.beginPath(),t.moveTo(n,a),t.arc(n,a,o,s,s+r),t.closePath(),t.fillStyle=e.color,t.fill(),t.strokeStyle="#222",t.lineWidth=2,t.stroke();const l=s+r/2,c=.55*o,d=n+Math.cos(l)*c,m=a+Math.sin(l)*c;t.save(),t.translate(d,m),t.rotate(l),t.fillStyle="#fff",t.font="bold 12px Arial",t.textAlign="center",t.textBaseline="middle",t.shadowColor="rgba(0,0,0,0.5)",t.shadowBlur=3;let p=e.text||e.trigger;p.length>12&&(p=p.substring(0,10)+"..."),t.fillText(p,0,0),t.restore(),s+=r}t.beginPath(),t.arc(n,a,20,0,2*Math.PI),t.fillStyle="#333",t.fill(),t.strokeStyle="#555",t.lineWidth=3,t.stroke()}(n);const a=document.getElementById("mazemaster_spin_btn");a&&a.addEventListener("click",Rt),Ae.isOpen=!0}async function Rt(){var e,t;const n=document.getElementById("mazemaster_spin_btn");if(!n||Ae.isSpinning)return;n.disabled=!0,n.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> Spinning...',Ae.isSpinning=!0,Ae.pendingRespin=!1;const a=function(){const e=Dt();let t=Math.random()*e;for(const e of Ae.segments)if(t-=e.units,t<=0)return e;return Ae.segments[Ae.segments.length-1]}(),o=document.getElementById("mazemaster_wheel_canvas");if(!o)return void(Ae.isSpinning=!1);const i=Dt();let s=0;for(const e of Ae.segments){if(e===a)break;s+=e.units/i*360}const r=s+a.units/i*360/2,l=5+Math.floor(3*Math.random()),c=parseFloat((null===(e=o.style.transform)||void 0===e||null===(e=e.match(/rotate\((\d+\.?\d*)deg\)/))||void 0===e?void 0:e[1])||0)+360*l+(360-r);o.style.transition="transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99)",o.style.transform="rotate(".concat(c,"deg)"),await new Promise((e=>setTimeout(e,4200))),Ae.isSpinning=!1;const d=null===(t=Re.profiles[Re.currentProfile])||void 0===t||null===(t=t.segments)||void 0===t?void 0:t.find((e=>e.trigger===a.trigger));d&&d.command&&(console.log('[MazeMaster] Executing command for "'.concat(a.text,'": ').concat(d.command)),await O(d.command)),Ue.wheel[Re.currentProfile]={segmentName:a.text,command:(null==d?void 0:d.command)||"",timestamp:Date.now()},a.respin&&!Ae.hasRespun?(Ae.pendingRespin=!0,Ae.hasRespun=!0,n.disabled=!1,n.className="mazemaster-spin-btn respin",n.innerHTML='<i class="fa-solid fa-rotate"></i> RESPIN'):(!function(){const e=document.getElementById("mazemaster_wheel_modal");if(e&&e.remove(),Ae.isOpen=!1,Ge.isOpen){try{if(Ge.pendingEncounter){const e=Ge.pendingEncounter.type;if("exit_wheel"===e)return Ge.exitEncounterDone=!0,Ge.isPaused=!1,void yo();if("wheel"===e)return void Ua()}}catch(e){console.error("[MazeMaster] Error in closeWheelModal:",e)}Ge.isPaused=!1,Ge.pendingEncounter=null}}(),Ae.segments=[],Ae.isOpen=!1,Ae.isSpinning=!1,Ae.pendingRespin=!1,Ae.hasRespun=!1)}function At(){s.addCommandObject(r.fromProps({name:"wheel",callback:async e=>{let t=e.profile;if(!t){const e=Re.currentProfile;if(e&&et(e))t=e;else{const e=$e();t=e.length>0?e[0]:"Blessing Wheel"}}console.log("[MazeMaster] /wheel command - loading profile:",t);const n=Tt(t);if(n.error)return console.error("[MazeMaster] /wheel error:",n.error),"Error: ".concat(n.error);const a=Bt();return a.valid?(Re.currentProfile=t,Lt(),'Wheel "'.concat(t,'" opened with ').concat(n.count," segments. Click SPIN!")):"Error: ".concat(a.error)},namedArgumentList:[c.fromProps({name:"profile",description:"Name of the wheel profile to use",typeList:[l.STRING],isRequired:!1,defaultValue:"default"})],helpString:'Open a wheel by profile name. Example: /wheel profile="mywheel"'})),s.addCommandObject(r.fromProps({name:"battlebar",callback:async e=>{const t=e.profile||Re.currentBattlebarProfile||"Training Dummy",n=Nn(t);return n.error?"Error: ".concat(n.error):'Battlebar "'.concat(t,'" started! Press SPACE when the arrow is in the green zone.')},namedArgumentList:[c.fromProps({name:"profile",description:"Name of the battlebar profile to use",typeList:[l.STRING],isRequired:!1,defaultValue:"default"})],helpString:'Start a battlebar challenge. Example: /battlebar profile="boss1"'})),s.addCommandObject(r.fromProps({name:"maze",callback:async e=>{const t=e.profile||Re.currentMazeProfile||"default",n=Ba(t);return n.error?"Error: ".concat(n.error):'Maze "'.concat(t,'" started! Use arrow keys to navigate.')},namedArgumentList:[c.fromProps({name:"profile",description:"Name of the maze profile to use",typeList:[l.STRING],isRequired:!1})],helpString:'Start a maze game. Example: /maze profile="dungeon1"'})),s.addCommandObject(r.fromProps({name:"mazeminion",callback:async e=>{if(!Ge.isOpen)return"No maze is currently open.";const t=e.name,n=e.message||"",a=St(t);return Ge.currentMinion=a?{name:a.name,imagePath:a.imagePath,message:n}:{name:t||"Unknown",imagePath:"",message:n},Na(),""},namedArgumentList:[c.fromProps({name:"name",description:"Minion name (from config) or custom name",typeList:[l.STRING],isRequired:!1}),c.fromProps({name:"message",description:"Message to display",typeList:[l.STRING],isRequired:!1})],helpString:'Set the minion display in an active maze. Example: /mazeminion name="Goblin" message="You shall not pass!"'})),s.addCommandObject(r.fromProps({name:"mazestats",callback:async()=>{var e,t,n,a,o,i,s,r;if(!Ge.isOpen)return JSON.stringify({error:"No maze is currently open."});const l={moves:(null===(e=Ge.stats)||void 0===e?void 0:e.moves)||0,encountersTotal:(null===(t=Ge.stats)||void 0===t?void 0:t.encountersTotal)||0,encountersWon:(null===(n=Ge.stats)||void 0===n?void 0:n.encountersWon)||0,chestsOpened:(null===(a=Ge.stats)||void 0===a?void 0:a.chestsOpened)||0,trapsTriggered:(null===(o=Ge.stats)||void 0===o?void 0:o.trapsTriggered)||0,teleportsUsed:(null===(i=Ge.stats)||void 0===i?void 0:i.teleportsUsed)||0,itemsCollected:(null===(s=Ge.stats)||void 0===s?void 0:s.itemsCollected)||{},exploration:ee(),elapsedTime:$(),difficulty:(null===(r=Ge.profile)||void 0===r?void 0:r.difficulty)||"normal"};return JSON.stringify(l)},helpString:"Get current maze session statistics as JSON. Example: /mazestats"})),s.addCommandObject(r.fromProps({name:"mazeexplore",callback:async()=>{if(!Ge.isOpen)return"No maze is currently open.";const e=ee();return String(e)},helpString:"Get current maze exploration percentage (0-100). Example: /mazeexplore"})),s.addCommandObject(r.fromProps({name:"mazeobjective",callback:async e=>{var t;if(!Ge.isOpen)return JSON.stringify({error:"No maze is currently open."});const n=(null===(t=Ge.profile)||void 0===t?void 0:t.objectives)||[],a=Ge.objectiveProgress||{};if(e.id){const t=n.find((t=>t.id===e.id));if(!t)return JSON.stringify({error:'Objective "'.concat(e.id,'" not found.')});const o=a[e.id]||{current:0,completed:!1};return JSON.stringify({id:t.id,type:t.type,target:t.target,description:t.description,current:o.current,required:t.count,completed:o.completed,isRequired:t.required})}{const e=n.map((e=>{const t=a[e.id]||{current:0,completed:!1};return{id:e.id,type:e.type,description:e.description,current:t.current,required:e.count,completed:t.completed,isRequired:e.required}}));return JSON.stringify(e)}},namedArgumentList:[c.fromProps({name:"id",description:"Specific objective ID to get (optional, returns all if omitted)",typeList:[l.STRING],isRequired:!1})],helpString:'Get maze objective progress. Example: /mazeobjective id="collect_keys" or /mazeobjective (for all)'})),s.addCommandObject(r.fromProps({name:"mazedifficulty",callback:async e=>{var t,n;const a=null===(t=e.tier)||void 0===t?void 0:t.toLowerCase(),o=["easy","normal","hard","nightmare"];if(!a){var i;const e=null===(i=Re.mazeProfiles)||void 0===i?void 0:i[Re.currentMazeProfile||"default"];return(null==e?void 0:e.difficulty)||"normal"}if(!o.includes(a))return"Error: Invalid difficulty tier. Valid options: ".concat(o.join(", "));const s=Re.currentMazeProfile||"default";return null!==(n=Re.mazeProfiles)&&void 0!==n&&n[s]?(Re.mazeProfiles[s].difficulty=a,saveSettings(),'Difficulty set to "'.concat(a,'" for profile "').concat(s,'".')):'Error: Profile "'.concat(s,'" not found.')},namedArgumentList:[c.fromProps({name:"tier",description:"Difficulty tier: easy, normal, hard, or nightmare",typeList:[l.STRING],isRequired:!1})],helpString:'Get or set maze difficulty. Example: /mazedifficulty tier="hard" or /mazedifficulty (to get current)'})),s.addCommandObject(r.fromProps({name:"mazepersonastats",callback:async e=>{var t;const n=e.persona||Q(),a=null===(t=Re.mazeStats)||void 0===t||null===(t=t.personas)||void 0===t?void 0:t[n];return a?JSON.stringify({persona:n,totalGames:a.totalGames||0,wins:a.wins||0,losses:a.losses||0,totalMoves:a.totalMoves||0,bestTime:a.bestTime,profileStats:a.profileStats||{}}):JSON.stringify({error:'No stats found for persona "'.concat(n,'".')})},namedArgumentList:[c.fromProps({name:"persona",description:"Name of the persona to get stats for (default: current persona)",typeList:[l.STRING],isRequired:!1})],helpString:'Get maze stats for a specific persona. Example: /mazepersonastats persona="Alice"'})),s.addCommandObject(r.fromProps({name:"mazefloor",callback:async()=>Ge.isOpen?JSON.stringify({current:(Ge.currentFloor||0)+1,total:Ge.totalFloors||1}):JSON.stringify({error:"No maze is currently open."}),helpString:"Get current floor information in an active maze. Example: /mazefloor"})),s.addCommandObject(r.fromProps({name:"mazetheme",callback:async e=>{var t,n;const a=null===(t=e.theme)||void 0===t?void 0:t.toLowerCase(),o=["fantasy","horror","scifi","action"];if(!a){var i;const e=Re.currentMazeProfile||"default",t=null===(i=Re.mazeProfiles)||void 0===i?void 0:i[e];return(null==t?void 0:t.theme)||"fantasy"}if(!o.includes(a))return"Error: Invalid theme. Valid options: ".concat(o.join(", "));const s=Re.currentMazeProfile||"default";return null!==(n=Re.mazeProfiles)&&void 0!==n&&n[s]?(Re.mazeProfiles[s].theme=a,saveSettings(),'Theme set to "'.concat(a,'" for profile "').concat(s,'".')):'Error: Profile "'.concat(s,'" not found.')},namedArgumentList:[c.fromProps({name:"theme",description:"Theme: fantasy, horror, scifi, or action",typeList:[l.STRING],isRequired:!1})],helpString:'Get or set maze theme. Example: /mazetheme theme="horror" or /mazetheme (to get current)'})),s.addCommandObject(r.fromProps({name:"mazemapstyle",callback:async e=>{var t,n;const a=null===(t=e.style)||void 0===t?void 0:t.toLowerCase(),o=["maze","dungeon","city","forest","spaceship"];if(!a){var i;const e=Re.currentMazeProfile||"default",t=null===(i=Re.mazeProfiles)||void 0===i?void 0:i[e];return(null==t?void 0:t.mapStyle)||"maze"}if(!o.includes(a))return"Error: Invalid map style. Valid options: ".concat(o.join(", "));const s=Re.currentMazeProfile||"default";return null!==(n=Re.mazeProfiles)&&void 0!==n&&n[s]?(Re.mazeProfiles[s].mapStyle=a,saveSettings(),'Map style set to "'.concat(a,'" for profile "').concat(s,'".')):'Error: Profile "'.concat(s,'" not found.')},namedArgumentList:[c.fromProps({name:"style",description:"Map style: maze, dungeon, city, forest, or spaceship",typeList:[l.STRING],isRequired:!1})],helpString:'Get or set maze map style. Example: /mazemapstyle style="dungeon" or /mazemapstyle (to get current)'}));const e={1:"key",2:"stealth",3:"strike",4:"execute",5:"floorKey",6:"portalStone",7:"minionBane",8:"mapFragment",9:"timeShard",10:"voidWalk",11:"healingPotion",12:"greaterHealing",13:"elixir",14:"revivalCharm",15:"heartCrystal",16:"torch",17:"lantern",18:"revealScroll",19:"sightPotion",20:"crystalBall",key:"key",stealth:"stealth",strike:"strike",execute:"execute",floorkey:"floorKey",portalstone:"portalStone",minionbane:"minionBane",mapfragment:"mapFragment",timeshard:"timeShard",voidwalk:"voidWalk",healingpotion:"healingPotion",greaterhealing:"greaterHealing",elixir:"elixir",revivalcharm:"revivalCharm",heartcrystal:"heartCrystal",torch:"torch",lantern:"lantern",revealscroll:"revealScroll",sightpotion:"sightPotion",crystalball:"crystalBall",hp:"healingPotion",ghp:"greaterHealing",potion:"healingPotion",light:"torch",scroll:"revealScroll",sight:"sightPotion",ball:"crystalBall"};s.addCommandObject(r.fromProps({name:"mazeitem",callback:async t=>{var n,a;if(!Ge.isOpen)return"Error: No maze is currently open.";const o=null===(n=t.action)||void 0===n?void 0:n.toLowerCase(),i=null===(a=t.item)||void 0===a?void 0:a.toString().toLowerCase(),s=parseInt(t.amount)||1;if(!o||!["add","remove","list"].includes(o))return'Error: action must be "add", "remove", or "list". Example: /mazeitem action="add" item="key" amount=1';if("list"===o){return"Available items:\n".concat(["1=key, 2=stealth, 3=strike, 4=execute","5=floorKey, 6=portalStone, 7=minionBane, 8=mapFragment, 9=timeShard, 10=voidWalk","11=healingPotion, 12=greaterHealing, 13=elixir, 14=revivalCharm, 15=heartCrystal","16=torch, 17=lantern, 18=revealScroll, 19=sightPotion, 20=crystalBall"].join("\n"))}if(!i)return'Error: item is required. Use item number (1-15) or name. Use /mazeitem action="list" to see all items.';const r=e[i];if(!r)return'Error: Unknown item "'.concat(i,'". Use /mazeitem action="list" to see available items.');if("add"===o)return await Va(r,s),"Added ".concat(s,"x ").concat(r," to inventory.");if("remove"===o){const e=Ge.inventory[r]||0,t=Math.min(s,e);return t>0?(await Xa(r,t),"Removed ".concat(t,"x ").concat(r," from inventory.")):"No ".concat(r," in inventory to remove.")}},namedArgumentList:[c.fromProps({name:"action",description:"Action: add, remove, or list",typeList:[l.STRING],isRequired:!0}),c.fromProps({name:"item",description:"Item number (1-15) or name",typeList:[l.STRING],isRequired:!1}),c.fromProps({name:"amount",description:"Amount to add/remove (default: 1)",typeList:[l.NUMBER],isRequired:!1})],helpString:'Manage maze inventory. Examples: /mazeitem action="add" item="key" amount=3, /mazeitem action="remove" item="11", /mazeitem action="list"'})),s.addCommandObject(r.fromProps({name:"mazehp",callback:async e=>{if(!Ge.isOpen)return JSON.stringify({error:"No maze is currently open."});if(!Ge.hpEnabled||!Ge.hp)return JSON.stringify({error:"HP system is not enabled for this maze."});if(void 0!==e.set){const t=parseInt(e.set);if(isNaN(t)||t<0)return"Error: set must be a positive number.";const n=Ge.hp.max+Ge.hp.maxBonus;return Ge.hp.current=Math.min(t,n),U(),"HP set to ".concat(Ge.hp.current,"/").concat(n)}const t=Ge.hp.max+Ge.hp.maxBonus;return JSON.stringify({current:Ge.hp.current,max:t,percent:Math.round(Ge.hp.current/t*100),reviveCharges:Ge.hp.reviveCharges})},namedArgumentList:[c.fromProps({name:"set",description:"Set HP to this value",typeList:[l.NUMBER],isRequired:!1})],helpString:"Get or set player HP. Examples: /mazehp (get status), /mazehp set=50"})),s.addCommandObject(r.fromProps({name:"mazeheal",callback:async e=>{if(!Ge.isOpen)return"Error: No maze is currently open.";if(!Ge.hpEnabled||!Ge.hp)return"Error: HP system is not enabled for this maze.";const t=parseInt(e.amount)||25,n="true"===e.percent||!0===e.percent;return await j(t,n,"command"),"Healed ".concat(t).concat(n?"%":""," HP.")},namedArgumentList:[c.fromProps({name:"amount",description:"Amount to heal (default: 25)",typeList:[l.NUMBER],isRequired:!1}),c.fromProps({name:"percent",description:"If true, amount is percentage of max HP",typeList:[l.STRING],isRequired:!1})],helpString:"Heal the player. Examples: /mazeheal amount=50, /mazeheal amount=25 percent=true"})),s.addCommandObject(r.fromProps({name:"mazedamage",callback:async e=>{if(!Ge.isOpen)return"Error: No maze is currently open.";if(!Ge.hpEnabled||!Ge.hp)return"Error: HP system is not enabled for this maze.";const t=parseInt(e.amount)||10,n=e.source||"command";return await F(t,n),"Dealt ".concat(t," damage (source: ").concat(n,").")},namedArgumentList:[c.fromProps({name:"amount",description:"Amount of damage (default: 10)",typeList:[l.NUMBER],isRequired:!1}),c.fromProps({name:"source",description:"Damage source for hooks (default: command)",typeList:[l.STRING],isRequired:!1})],helpString:'Deal damage to the player. Examples: /mazedamage amount=25, /mazedamage amount=10 source="trap"'})),s.addCommandObject(r.fromProps({name:"turnbased",callback:async e=>{const t=e.profile||Re.currentTurnbasedProfile||"Training Bout",n=Ot(t);return n.error?"Error: ".concat(n.error):'Turn-based combat "'.concat(t,'" started!')},namedArgumentList:[c.fromProps({name:"profile",description:"Name of the turn-based combat profile to use",typeList:[l.STRING],isRequired:!1})],helpString:'Start a turn-based combat encounter. Example: /turnbased profile="Dungeon Skirmish"'})),s.addCommandObject(r.fromProps({name:"qte",callback:async e=>{const t=e.profile||Re.currentQteProfile||"Reaction Test",n=Jt(t);return n.error?"Error: ".concat(n.error):'QTE "'.concat(t,'" started! Press the keys as they appear!')},namedArgumentList:[c.fromProps({name:"profile",description:"Name of the QTE profile to use",typeList:[l.STRING],isRequired:!1})],helpString:'Start a Quick-Time Event challenge. Example: /qte profile="Combat Flurry"'})),s.addCommandObject(r.fromProps({name:"dice",callback:async e=>{const t=e.profile||Re.currentDiceProfile||"Lucky Roll",n=sn(t);return n.error?"Error: ".concat(n.error):'Dice challenge "'.concat(t,'" started! Click to roll!')},namedArgumentList:[c.fromProps({name:"profile",description:"Name of the dice profile to use",typeList:[l.STRING],isRequired:!1})],helpString:'Start a dice roll challenge. Example: /dice profile="Skill Check"'})),s.addCommandObject(r.fromProps({name:"stealth",callback:async e=>{const t=e.profile||Re.currentStealthProfile||"Simple Sneak",n=un(t);return n.error?"Error: ".concat(n.error):'Stealth encounter "'.concat(t,'" started! Sneak past the guards!')},namedArgumentList:[c.fromProps({name:"profile",description:"Name of the stealth profile to use",typeList:[l.STRING],isRequired:!1})],helpString:'Start a stealth encounter. Example: /stealth profile="Guard Patrol"'})),s.addCommandObject(r.fromProps({name:"puzzle",callback:async e=>{const t=e.profile||Re.currentPuzzleProfile||"Simple Riddle",n=yn(t);return n.error?"Error: ".concat(n.error):'Puzzle "'.concat(t,'" started! Solve the sequence!')},namedArgumentList:[c.fromProps({name:"profile",description:"Name of the puzzle profile to use",typeList:[l.STRING],isRequired:!1})],helpString:'Start a puzzle encounter. Example: /puzzle profile="Memory Trial"'})),s.addCommandObject(r.fromProps({name:"negotiate",callback:async e=>{const t=e.profile||Re.currentNegotiationProfile||"Friendly Chat",n=Mn(t);return n.error?"Error: ".concat(n.error):'Negotiation "'.concat(t,'" started! Convince them to help!')},namedArgumentList:[c.fromProps({name:"profile",description:"Name of the negotiation profile to use",typeList:[l.STRING],isRequired:!1})],helpString:'Start a negotiation encounter. Example: /negotiate profile="Merchant Haggle"'})),console.log("[MazeMaster] Slash commands registered")}function Ot(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;console.log("[MazeMaster] startTurnBased called with profile:",e);const n=it(e);if(console.log("[MazeMaster] Retrieved profile:",n),!n)return console.error('[MazeMaster] Turn-based profile "'.concat(e,'" not found')),{error:'Profile "'.concat(e,'" not found')};let a=n.playerHP||100,o=n.playerHP||100,i=!1;return Ge.isOpen&&Ge.hpEnabled&&Ge.hp?(i=!0,a=Ge.hp.current,o=Ge.hp.max+(Ge.hp.maxBonus||0),console.log("[MazeMaster] Using maze HP for combat:",a,"/",o)):console.log("[MazeMaster] Using profile HP for combat:",a,"/",o),console.log("[MazeMaster] Initializing turn-based combat state"),He={isOpen:!0,profile:n,profileName:e,playerHP:a,playerMaxHP:o,enemyHP:n.enemyHP||100,enemyMaxHP:n.enemyHP||100,currentTurn:"enemy_first"===n.turnOrder?"enemy":"player",turnCount:1,isDefending:!1,isVictory:!1,isDefeat:!1,isMazeEncounter:i,combatLog:["Combat begins!"],enemyNameOverride:t},Ge.isOpen&&(Ge.isPaused=!0),function(){var e,t,n,a,o;console.log("[MazeMaster] showTurnBasedModal called");const i=document.getElementById("mazemaster_turnbased_modal");i&&(console.log("[MazeMaster] Removing existing turn-based modal"),i.remove());if(!document.getElementById("mazemaster_tb_styles")){console.log("[MazeMaster] Adding turn-based styles");const e=document.createElement("style");e.id="mazemaster_tb_styles",e.textContent="\n        .mazemaster-tb-container {\n            display: flex;\n            flex-direction: column;\n            align-items: center;\n            gap: 15px;\n            padding: 25px;\n            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);\n            border-radius: 15px;\n            border: 2px solid #4a7c59;\n            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5), 0 0 20px rgba(74, 124, 89, 0.3);\n            width: 500px;\n            max-width: 95vw;\n            max-height: 90vh;\n            overflow-y: auto;\n        }\n\n        .mazemaster-tb-main-title {\n            font-size: 1.8em;\n            font-weight: bold;\n            color: #fff;\n            text-shadow: 0 2px 4px rgba(0,0,0,0.5);\n        }\n\n        .mazemaster-tb-combatants {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            width: 100%;\n            gap: 20px;\n        }\n\n        .mazemaster-tb-combatant {\n            flex: 1;\n            text-align: center;\n            padding: 15px;\n            background: rgba(0,0,0,0.3);\n            border-radius: 10px;\n        }\n\n        .tb-combatant-name {\n            font-size: 1.2em;\n            font-weight: bold;\n            margin-bottom: 10px;\n            color: #fff;\n        }\n\n        .tb-hp-bar-container {\n            width: 100%;\n            height: 20px;\n            background: #333;\n            border-radius: 10px;\n            overflow: hidden;\n            margin-bottom: 5px;\n        }\n\n        .tb-hp-bar {\n            height: 100%;\n            transition: width 0.3s ease;\n            border-radius: 10px;\n        }\n\n        .tb-hp-player {\n            background: linear-gradient(90deg, #2ecc71 0%, #27ae60 100%);\n        }\n\n        .tb-hp-enemy {\n            background: linear-gradient(90deg, #e74c3c 0%, #c0392b 100%);\n        }\n\n        .tb-hp-text {\n            font-size: 0.9em;\n            color: #aaa;\n        }\n\n        .mazemaster-tb-vs {\n            font-size: 1.5em;\n            font-weight: bold;\n            color: #f39c12;\n            text-shadow: 0 2px 4px rgba(0,0,0,0.5);\n        }\n\n        .mazemaster-tb-turn-indicator {\n            font-size: 1.1em;\n            color: #3498db;\n            padding: 8px 20px;\n            background: rgba(52, 152, 219, 0.2);\n            border-radius: 20px;\n            border: 1px solid rgba(52, 152, 219, 0.5);\n        }\n\n        .mazemaster-tb-log {\n            width: 100%;\n            height: 120px;\n            background: rgba(0,0,0,0.4);\n            border-radius: 8px;\n            padding: 10px;\n            overflow-y: auto;\n            font-size: 0.9em;\n            color: #ccc;\n        }\n\n        .tb-log-entry {\n            padding: 3px 0;\n            border-bottom: 1px solid rgba(255,255,255,0.1);\n        }\n\n        .tb-log-entry:last-child {\n            border-bottom: none;\n        }\n\n        .tb-log-damage { color: #e74c3c; }\n        .tb-log-heal { color: #2ecc71; }\n        .tb-log-defend { color: #3498db; }\n        .tb-log-crit { color: #f39c12; font-weight: bold; }\n        .tb-log-flee { color: #9b59b6; }\n\n        .mazemaster-tb-actions {\n            display: flex;\n            gap: 10px;\n            flex-wrap: wrap;\n            justify-content: center;\n        }\n\n        .mazemaster-tb-btn {\n            padding: 12px 20px;\n            border: none;\n            border-radius: 8px;\n            font-size: 1em;\n            font-weight: bold;\n            cursor: pointer;\n            transition: all 0.2s ease;\n            display: flex;\n            align-items: center;\n            gap: 8px;\n        }\n\n        .mazemaster-tb-btn:hover {\n            transform: translateY(-2px);\n            box-shadow: 0 4px 12px rgba(0,0,0,0.3);\n        }\n\n        .mazemaster-tb-btn:disabled {\n            opacity: 0.5;\n            cursor: not-allowed;\n            transform: none;\n        }\n\n        .tb-btn-attack {\n            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);\n            color: white;\n        }\n\n        .tb-btn-defend {\n            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);\n            color: white;\n        }\n\n        .tb-btn-item {\n            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);\n            color: white;\n        }\n\n        .tb-btn-flee {\n            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);\n            color: white;\n        }\n\n        .tb-btn-close {\n            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);\n            color: white;\n            padding: 15px 40px;\n        }\n\n        .mazemaster-tb-result {\n            text-align: center;\n        }\n\n        .tb-result-text {\n            font-size: 1.5em;\n            font-weight: bold;\n            margin-bottom: 15px;\n        }\n\n        .tb-result-victory { color: #2ecc71; }\n        .tb-result-defeat { color: #e74c3c; }\n        .tb-result-fled { color: #9b59b6; }\n\n        .tb-combatant.defending {\n            box-shadow: 0 0 15px rgba(52, 152, 219, 0.6);\n        }\n\n        .tb-hp-bar.flash-damage {\n            animation: tb-flash-damage 0.3s ease;\n        }\n\n        .tb-hp-bar.flash-heal {\n            animation: tb-flash-heal 0.3s ease;\n        }\n\n        @keyframes tb-flash-damage {\n            0%, 100% { filter: brightness(1); }\n            50% { filter: brightness(1.5) saturate(2); }\n        }\n\n        @keyframes tb-flash-heal {\n            0%, 100% { filter: brightness(1); }\n            50% { filter: brightness(1.5) hue-rotate(60deg); }\n        }\n    ",document.head.appendChild(e)}console.log("[MazeMaster] Inserting turn-based modal HTML"),document.body.insertAdjacentHTML("beforeend",'\n        <div id="mazemaster_turnbased_modal" style="position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:999999;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.9);">\n            <div class="mazemaster-tb-container">\n                <div id="tb_main_title" class="mazemaster-tb-main-title">Combat!</div>\n\n                <div class="mazemaster-tb-combatants">\n                    <div class="mazemaster-tb-combatant tb-player">\n                        <div class="tb-combatant-name">You</div>\n                        <div class="tb-hp-bar-container">\n                            <div class="tb-hp-bar tb-hp-player" id="tb_player_hp_bar"></div>\n                        </div>\n                        <div class="tb-hp-text"><span id="tb_player_hp">100</span>/<span id="tb_player_max_hp">100</span> HP</div>\n                    </div>\n                    <div class="mazemaster-tb-vs">VS</div>\n                    <div class="mazemaster-tb-combatant tb-enemy">\n                        <div class="tb-combatant-name" id="tb_enemy_name">Enemy</div>\n                        <div class="tb-hp-bar-container">\n                            <div class="tb-hp-bar tb-hp-enemy" id="tb_enemy_hp_bar"></div>\n                        </div>\n                        <div class="tb-hp-text"><span id="tb_enemy_hp">100</span>/<span id="tb_enemy_max_hp">100</span> HP</div>\n                    </div>\n                </div>\n\n                <div class="mazemaster-tb-turn-indicator">\n                    <span id="tb_turn_text">Your Turn</span> - Turn <span id="tb_turn_count">1</span>\n                </div>\n\n                <div class="mazemaster-tb-log" id="tb_combat_log">\n                    <div class="tb-log-entry">Combat begins!</div>\n                </div>\n\n                <div class="mazemaster-tb-actions" id="tb_action_buttons">\n                    <button id="tb_attack_btn" class="mazemaster-tb-btn tb-btn-attack">\n                        <i class="fa-solid fa-sword"></i> Attack\n                    </button>\n                    <button id="tb_defend_btn" class="mazemaster-tb-btn tb-btn-defend">\n                        <i class="fa-solid fa-shield"></i> Defend\n                    </button>\n                    <button id="tb_item_btn" class="mazemaster-tb-btn tb-btn-item">\n                        <i class="fa-solid fa-flask"></i> Item\n                    </button>\n                    <button id="tb_flee_btn" class="mazemaster-tb-btn tb-btn-flee">\n                        <i class="fa-solid fa-person-running"></i> Flee\n                    </button>\n                </div>\n\n                <div class="mazemaster-tb-result" id="tb_result_panel" style="display: none;">\n                    <div id="tb_result_text" class="tb-result-text"></div>\n                    <button id="tb_close_btn" class="mazemaster-tb-btn tb-btn-close">\n                        <i class="fa-solid fa-check"></i> Close\n                    </button>\n                </div>\n            </div>\n        </div>\n    ');const s=document.getElementById("mazemaster_turnbased_modal");console.log("[MazeMaster] Modal element exists:",!!s);const r=document.getElementById("tb_main_title"),l=document.getElementById("tb_enemy_name");console.log("[MazeMaster] Title element:",r,"Enemy name element:",l);const c=He.enemyNameOverride||He.profile.mainTitle||"Combat!";r&&(r.textContent=c);l&&(l.textContent=He.enemyNameOverride||He.profile.enemyName||"Enemy");console.log("[MazeMaster] Attaching turn-based event handlers"),null===(e=document.getElementById("tb_attack_btn"))||void 0===e||e.addEventListener("click",jt),null===(t=document.getElementById("tb_defend_btn"))||void 0===t||t.addEventListener("click",Wt),null===(n=document.getElementById("tb_item_btn"))||void 0===n||n.addEventListener("click",Yt),null===(a=document.getElementById("tb_flee_btn"))||void 0===a||a.addEventListener("click",Gt),null===(o=document.getElementById("tb_close_btn"))||void 0===o||o.addEventListener("click",Vt),console.log("[MazeMaster] Turn-based modal setup complete")}(),Ht(),"enemy"===He.currentTurn&&setTimeout((()=>Ut()),1e3),console.log("[MazeMaster] Turn-based combat started: ".concat(e)),{success:!0}}function Ht(){const e=He.playerHP/He.playerMaxHP*100,t=He.enemyHP/He.enemyMaxHP*100,n=document.getElementById("tb_player_hp_bar"),a=document.getElementById("tb_enemy_hp_bar");n&&(n.style.width="".concat(e,"%")),a&&(a.style.width="".concat(t,"%"));const o=document.getElementById("tb_player_hp"),i=document.getElementById("tb_player_max_hp"),s=document.getElementById("tb_enemy_hp"),r=document.getElementById("tb_enemy_max_hp");o&&(o.textContent=Math.max(0,He.playerHP)),i&&(i.textContent=He.playerMaxHP),s&&(s.textContent=Math.max(0,He.enemyHP)),r&&(r.textContent=He.enemyMaxHP);const l=document.getElementById("tb_turn_text"),c=document.getElementById("tb_turn_count");l&&(l.textContent="player"===He.currentTurn?"Your Turn":"Enemy Turn"),c&&(c.textContent=He.turnCount);const d=document.getElementById("tb_combat_log");d&&(d.innerHTML=He.combatLog.map((e=>{let t="tb-log-entry";return(e.includes("damage")||e.includes("hit"))&&(t+=" tb-log-damage"),(e.includes("heal")||e.includes("restored"))&&(t+=" tb-log-heal"),(e.includes("defend")||e.includes("block"))&&(t+=" tb-log-defend"),e.includes("CRITICAL")&&(t+=" tb-log-crit"),(e.includes("flee")||e.includes("escape"))&&(t+=" tb-log-flee"),'<div class="'.concat(t,'">').concat(e,"</div>")})).join(""),d.scrollTop=d.scrollHeight);const m=document.querySelector(".tb-player");m&&m.classList.toggle("defending",He.isDefending);document.querySelectorAll(".mazemaster-tb-btn").forEach((e=>{"tb_close_btn"!==e.id&&(e.disabled="player"!==He.currentTurn||He.isVictory||He.isDefeat)}))}function Nt(e){He.combatLog.push(e),He.combatLog.length>50&&He.combatLog.shift(),Ht()}function qt(e,t){const n=e?"tb_player_hp_bar":"tb_enemy_hp_bar",a=document.getElementById(n);a&&(a.classList.remove("flash-damage","flash-heal"),a.offsetWidth,a.classList.add(t?"flash-damage":"flash-heal"))}function Ft(e,t,n,a){let o=Math.max(1,e-t);o=Math.round(o*(.8+.4*Math.random()));let i=!1;return 100*Math.random()<n&&(o=Math.round(o*a),i=!0),{damage:o,isCrit:i}}async function jt(){if("player"!==He.currentTurn)return;const e=He.profile;He.isDefending=!1;const{damage:t,isCrit:n}=Ft(e.playerAttack||15,e.enemyDefense||5,e.critChance||10,e.critMultiplier||2);He.enemyHP=Math.max(0,He.enemyHP-t),qt(!1,!0),Nt(n?"CRITICAL HIT! You deal ".concat(t," damage!"):"You attack for ".concat(t," damage!")),e.onAttack&&await O(e.onAttack),He.enemyHP<=0?await async function(){He.isVictory=!0,He.currentTurn="none";const e=He.profile;Nt("Victory! The enemy is defeated!"),e.onWin&&await O(e.onWin);Ge.isOpen&&Ge.pendingEncounter&&(100*Math.random()<(e.keyDropChance||40)&&(Va("key"),Nt("You found a Key!")),100*Math.random()<(e.strikeDropChance||20)&&(Va("strike"),Nt("You found a Strike!")),100*Math.random()<(e.healingPotionDropChance||20)&&(Va("healingPotion"),Nt("You found a Healing Potion!")));Ue.turnbased=Ue.turnbased||{},Ue.turnbased[He.profileName]={result:"win",turnsPlayed:He.turnCount,timestamp:Date.now()},Kt("victory")}():(He.currentTurn="enemy",Ht(),setTimeout((()=>Ut()),1e3))}async function Wt(){"player"===He.currentTurn&&(He.isDefending=!0,Nt("You take a defensive stance."),He.profile.onDefend&&await O(He.profile.onDefend),He.currentTurn="enemy",Ht(),setTimeout((()=>Ut()),1e3))}async function Yt(){if("player"===He.currentTurn)if(Ge.isOpen&&Ge.inventory&&Ge.inventory.healingPotion>0){const e=Math.round(.25*He.playerMaxHP);He.playerHP=Math.min(He.playerMaxHP,He.playerHP+e),Ge.inventory.healingPotion--,qt(!0,!1),Nt("You use a Healing Potion and restore ".concat(e," HP!")),He.profile.onItem&&await O(He.profile.onItem),He.isDefending=!1,He.currentTurn="enemy",Ht(),setTimeout((()=>Ut()),1e3)}else Nt("No items available!")}async function Gt(){if("player"!==He.currentTurn)return;const e=He.profile.fleeChance||30,t=100*Math.random();t<e?(Nt("You successfully flee from combat!"),He.profile.onFlee&&await O(He.profile.onFlee),He.isVictory=!1,He.isDefeat=!1,Kt("fled")):(Nt("Failed to escape! (".concat(Math.round(t)," vs ").concat(e,")")),He.isDefending=!1,He.currentTurn="enemy",Ht(),setTimeout((()=>Ut()),1e3))}async function Ut(){if("enemy"!==He.currentTurn)return;if(He.isVictory||He.isDefeat)return;const e=He.profile;e.onTurnStart&&await O(e.onTurnStart);let{damage:t,isCrit:n}=Ft(e.enemyAttack||12,e.playerDefense||5,e.critChance||10,e.critMultiplier||2);He.isDefending&&(t=Math.round(.5*t),Nt("Your defense reduces the damage!")),He.playerHP=Math.max(0,He.playerHP-t),qt(!0,!0);const a=He.enemyNameOverride||e.enemyName||"Enemy";Nt(n?"CRITICAL! ".concat(a," deals ").concat(t," damage!"):"".concat(a," attacks for ").concat(t," damage!")),e.onPlayerHit&&await O(e.onPlayerHit),He.playerHP<=0?await async function(){He.isDefeat=!0,He.currentTurn="none";const e=He.profile;Nt("Defeat... You have fallen."),e.onLose&&await O(e.onLose);let t=!1;if(Ge.isOpen&&Ge.hpEnabled&&Ge.hp){var n,a;const o=e.damage||25,i=null!==(n=null===(a=Ge.profile)||void 0===a?void 0:a.battlebarDamageMultiplier)&&void 0!==n?n:1,s=Math.round(o*i);t=!await F(s,"turnbased")}if(Ue.turnbased=Ue.turnbased||{},Ue.turnbased[He.profileName]={result:"lose",turnsPlayed:He.turnCount,timestamp:Date.now()},t)return void Vt();Kt("defeat")}():(He.currentTurn="player",He.turnCount++,He.isDefending=!1,Ht())}function Kt(e){const t=document.getElementById("tb_action_buttons"),n=document.getElementById("tb_result_panel"),a=document.getElementById("tb_result_text");t&&(t.style.display="none"),n&&(n.style.display="block"),a&&("victory"===e?(a.textContent="Victory!",a.className="tb-result-text tb-result-victory"):"defeat"===e?(a.textContent="Defeat...",a.className="tb-result-text tb-result-defeat"):"fled"===e&&(a.textContent="Escaped!",a.className="tb-result-text tb-result-fled")),Ht()}async function Vt(){const e=document.getElementById("mazemaster_turnbased_modal");e&&e.remove();const t=He.isVictory,n=He.isDefeat,a=He.isMazeEncounter;if(a&&Ge.isOpen&&Ge.hpEnabled&&Ge.hp){const e=Ge.hp.current;Ge.hp.current=Math.max(0,He.playerHP),console.log("[MazeMaster] Persisting combat HP to maze:",e,"->",Ge.hp.current),U(),n&&Ge.hp.current<=0&&console.log("[MazeMaster] Player died in turn-based combat")}if(He.isOpen=!1,Ge.isOpen){try{if(Ge.pendingEncounter){const e=Ge.pendingEncounter.type;if(t){if(await ba(Ge.playerX,Ge.playerY),"exit_turnbased"===e)return Ge.exitEncounterDone=!0,Ge.isPaused=!1,void yo()}else if(n&&a&&Ge.hp&&Ge.hp.current<=0)return Ge.pendingEncounter=null,void vo()}}catch(e){console.error("[MazeMaster] Error in closeTurnBasedModal:",e)}Ge.isPaused=!1,Ge.pendingEncounter=null}}const Xt={W:{label:"W",icon:"fa-arrow-up",color:"#3498db"},A:{label:"A",icon:"fa-arrow-left",color:"#e74c3c"},S:{label:"S",icon:"fa-arrow-down",color:"#2ecc71"},D:{label:"D",icon:"fa-arrow-right",color:"#f39c12"},SPACE:{label:"SPACE",icon:"fa-square",color:"#9b59b6"},E:{label:"E",icon:"fa-hand",color:"#1abc9c"},Q:{label:"Q",icon:"fa-shield",color:"#e67e22"}};function Jt(e){console.log("[MazeMaster] startQTE called with profile:",e);const t=lt(e);if(console.log("[MazeMaster] QTE profile retrieved:",t),!t)return console.error('[MazeMaster] QTE profile "'.concat(e,'" not found')),{error:'Profile "'.concat(e,'" not found')};const n=Math.floor(Math.random()*(t.sequenceLengthMax-t.sequenceLengthMin+1)+t.sequenceLengthMin),a=[];for(let e=0;e<n;e++){const e=t.allowedKeys[Math.floor(Math.random()*t.allowedKeys.length)];a.push(e)}return Ne={isOpen:!0,profile:t,profileName:e,sequence:a,currentIndex:0,currentTimeWindow:t.timeWindowBase,promptStartTime:0,timeoutId:null,successes:0,perfects:0,misses:0,combo:0,maxCombo:0,isComplete:!1,isSuccess:!1,combatLog:["Prepare yourself..."]},Ge.isOpen&&(Ge.isPaused=!0),function(){var e;const t=document.getElementById("mazemaster_qte_modal");t&&t.remove();if(!document.getElementById("mazemaster_qte_styles")){const e=document.createElement("style");e.id="mazemaster_qte_styles",e.textContent="\n        .mazemaster-qte-container {\n            display: flex;\n            flex-direction: column;\n            align-items: center;\n            gap: 15px;\n            padding: 25px;\n            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);\n            border-radius: 15px;\n            border: 2px solid #9b59b6;\n            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5), 0 0 20px rgba(155, 89, 182, 0.3);\n            width: 450px;\n            max-width: 95vw;\n            max-height: 90vh;\n            overflow-y: auto;\n        }\n\n        .mazemaster-qte-main-title {\n            font-size: 1.8em;\n            font-weight: bold;\n            color: #fff;\n            text-shadow: 0 2px 4px rgba(0,0,0,0.5);\n        }\n\n        .mazemaster-qte-progress {\n            width: 100%;\n            position: relative;\n        }\n\n        .qte-progress-bar {\n            width: 100%;\n            height: 8px;\n            background: #333;\n            border-radius: 4px;\n            overflow: hidden;\n        }\n\n        .qte-progress-bar::after {\n            content: '';\n            display: block;\n            height: 100%;\n            width: var(--progress, 0%);\n            background: linear-gradient(90deg, #9b59b6, #3498db);\n            transition: width 0.3s ease;\n        }\n\n        .qte-progress-text {\n            position: absolute;\n            right: 0;\n            top: -20px;\n            font-size: 0.9em;\n            color: #aaa;\n        }\n\n        .mazemaster-qte-prompt-area {\n            display: flex;\n            justify-content: center;\n            align-items: center;\n            min-height: 180px;\n            width: 100%;\n        }\n\n        .qte-timer-ring {\n            position: relative;\n            width: 160px;\n            height: 160px;\n        }\n\n        .qte-timer-ring svg {\n            width: 100%;\n            height: 100%;\n            transform: rotate(-90deg);\n        }\n\n        .qte-timer-bg {\n            fill: none;\n            stroke: #333;\n            stroke-width: 8;\n        }\n\n        .qte-timer-fill {\n            fill: none;\n            stroke: #9b59b6;\n            stroke-width: 8;\n            stroke-linecap: round;\n            stroke-dasharray: 283;\n            stroke-dashoffset: 0;\n            transition: stroke-dashoffset 0.1s linear;\n        }\n\n        .qte-timer-fill.warning {\n            stroke: #f39c12;\n        }\n\n        .qte-timer-fill.critical {\n            stroke: #e74c3c;\n        }\n\n        .qte-key-prompt {\n            position: absolute;\n            top: 50%;\n            left: 50%;\n            transform: translate(-50%, -50%);\n            text-align: center;\n            display: flex;\n            flex-direction: column;\n            align-items: center;\n            gap: 5px;\n        }\n\n        .qte-key-prompt i {\n            font-size: 2.5em;\n            color: #fff;\n        }\n\n        .qte-key-prompt span {\n            font-size: 1.2em;\n            font-weight: bold;\n            color: #fff;\n            text-shadow: 0 2px 4px rgba(0,0,0,0.5);\n        }\n\n        .qte-key-prompt.success {\n            animation: qte-success-pulse 0.3s ease;\n        }\n\n        .qte-key-prompt.fail {\n            animation: qte-fail-shake 0.3s ease;\n        }\n\n        .qte-key-prompt.perfect {\n            animation: qte-perfect-glow 0.4s ease;\n        }\n\n        @keyframes qte-success-pulse {\n            0%, 100% { transform: translate(-50%, -50%) scale(1); }\n            50% { transform: translate(-50%, -50%) scale(1.2); }\n        }\n\n        @keyframes qte-fail-shake {\n            0%, 100% { transform: translate(-50%, -50%); }\n            25% { transform: translate(calc(-50% - 10px), -50%); }\n            75% { transform: translate(calc(-50% + 10px), -50%); }\n        }\n\n        @keyframes qte-perfect-glow {\n            0% { filter: brightness(1); }\n            50% { filter: brightness(1.5) drop-shadow(0 0 20px gold); }\n            100% { filter: brightness(1); }\n        }\n\n        .mazemaster-qte-stats {\n            display: flex;\n            gap: 20px;\n            font-size: 1em;\n            font-weight: bold;\n        }\n\n        .qte-stat-combo { color: #f39c12; }\n        .qte-stat-perfects { color: #2ecc71; }\n        .qte-stat-misses { color: #e74c3c; }\n\n        .mazemaster-qte-log {\n            width: 100%;\n            height: 80px;\n            background: rgba(0,0,0,0.4);\n            border-radius: 8px;\n            padding: 10px;\n            overflow-y: auto;\n            font-size: 0.85em;\n            color: #ccc;\n        }\n\n        .qte-log-entry {\n            padding: 2px 0;\n            border-bottom: 1px solid rgba(255,255,255,0.1);\n        }\n\n        .qte-log-entry:last-child { border-bottom: none; }\n        .qte-log-success { color: #2ecc71; }\n        .qte-log-perfect { color: #f1c40f; font-weight: bold; }\n        .qte-log-miss { color: #e74c3c; }\n        .qte-log-combo { color: #3498db; }\n\n        .mazemaster-qte-result {\n            text-align: center;\n            padding: 15px;\n        }\n\n        .qte-result-text {\n            font-size: 1.8em;\n            font-weight: bold;\n            margin-bottom: 10px;\n        }\n\n        .qte-result-text.success { color: #2ecc71; }\n        .qte-result-text.fail { color: #e74c3c; }\n\n        .qte-result-stats {\n            font-size: 0.95em;\n            color: #aaa;\n            margin-bottom: 15px;\n        }\n\n        .mazemaster-qte-btn {\n            padding: 12px 25px;\n            border: none;\n            border-radius: 8px;\n            font-size: 1em;\n            font-weight: bold;\n            cursor: pointer;\n            transition: all 0.2s ease;\n            display: flex;\n            align-items: center;\n            gap: 8px;\n        }\n\n        .mazemaster-qte-btn:hover {\n            transform: translateY(-2px);\n            box-shadow: 0 4px 12px rgba(0,0,0,0.3);\n        }\n\n        .qte-btn-close {\n            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);\n            color: white;\n            padding: 15px 40px;\n            margin: 0 auto;\n        }\n    ",document.head.appendChild(e)}document.body.insertAdjacentHTML("beforeend",'\n        <div id="mazemaster_qte_modal" style="position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:999999;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.9);">\n            <div class="mazemaster-qte-container">\n                <div id="qte_main_title" class="mazemaster-qte-main-title">QTE!</div>\n\n                <div class="mazemaster-qte-progress">\n                    <div class="qte-progress-bar" id="qte_progress_bar"></div>\n                    <div class="qte-progress-text"><span id="qte_current_index">0</span>/<span id="qte_total_count">0</span></div>\n                </div>\n\n                <div class="mazemaster-qte-prompt-area">\n                    <div class="qte-timer-ring" id="qte_timer_ring">\n                        <svg viewBox="0 0 100 100">\n                            <circle class="qte-timer-bg" cx="50" cy="50" r="45"/>\n                            <circle class="qte-timer-fill" id="qte_timer_circle" cx="50" cy="50" r="45"/>\n                        </svg>\n                        <div class="qte-key-prompt" id="qte_key_prompt">\n                            <i class="fa-solid fa-hourglass-start"></i>\n                            <span>GET READY</span>\n                        </div>\n                    </div>\n                </div>\n\n                <div class="mazemaster-qte-stats">\n                    <span class="qte-stat qte-stat-combo">\n                        Combo: <span id="qte_combo">0</span>x\n                    </span>\n                    <span class="qte-stat qte-stat-perfects">\n                        Perfect: <span id="qte_perfects">0</span>\n                    </span>\n                    <span class="qte-stat qte-stat-misses">\n                        Miss: <span id="qte_misses">0</span>\n                    </span>\n                </div>\n\n                <div class="mazemaster-qte-log" id="qte_combat_log">\n                    <div class="qte-log-entry">Prepare yourself...</div>\n                </div>\n\n                <div class="mazemaster-qte-result" id="qte_result_panel" style="display: none;">\n                    <div id="qte_result_text" class="qte-result-text"></div>\n                    <div id="qte_result_stats" class="qte-result-stats"></div>\n                    <button id="qte_close_btn" class="mazemaster-qte-btn qte-btn-close">\n                        <i class="fa-solid fa-check"></i> Close\n                    </button>\n                </div>\n            </div>\n        </div>\n    ');const n=document.getElementById("qte_main_title");n&&(n.textContent=Ne.profile.mainTitle||"QTE!");const a=document.getElementById("qte_total_count");a&&(a.textContent=Ne.sequence.length);null===(e=document.getElementById("qte_close_btn"))||void 0===e||e.addEventListener("click",an),document.addEventListener("keydown",tn),Qt()}(),t.onStart&&O(t.onStart),setTimeout((()=>{Zt("GO!"),$t()}),1e3),console.log("[MazeMaster] QTE started: ".concat(e,", sequence length: ").concat(n)),{success:!0}}function Qt(){const e=document.getElementById("qte_progress_bar"),t=Ne.currentIndex/Ne.sequence.length*100;e&&e.style.setProperty("--progress","".concat(t,"%"));const n=document.getElementById("qte_current_index");n&&(n.textContent=Ne.currentIndex);const a=document.getElementById("qte_combo"),o=document.getElementById("qte_perfects"),i=document.getElementById("qte_misses");a&&(a.textContent=Ne.combo),o&&(o.textContent=Ne.perfects),i&&(i.textContent=Ne.misses);const s=document.getElementById("qte_combat_log");s&&(s.innerHTML=Ne.combatLog.map((e=>{let t="qte-log-entry";return(e.includes("Success")||e.includes("Hit"))&&(t+=" qte-log-success"),e.includes("PERFECT")&&(t+=" qte-log-perfect"),(e.includes("Miss")||e.includes("Too slow"))&&(t+=" qte-log-miss"),e.includes("Combo")&&(t+=" qte-log-combo"),'<div class="'.concat(t,'">').concat(e,"</div>")})).join(""),s.scrollTop=s.scrollHeight)}function Zt(e){Ne.combatLog.push(e),Ne.combatLog.length>30&&Ne.combatLog.shift(),Qt()}function $t(){if(Ne.currentIndex>=Ne.sequence.length)return void async function(){Ne.isComplete=!0;const e=Ne.successes/Ne.sequence.length;Ne.isSuccess=e>=.5,document.removeEventListener("keydown",tn);const t=Ne.profile;if(Ne.isSuccess)Zt("QTE Complete - Success!"),t.onComplete&&await O(t.onComplete),Ge.isOpen&&Ge.pendingEncounter&&(100*Math.random()<(t.keyDropChance||30)&&(Va("key"),Zt("You found a Key!")),100*Math.random()<(t.strikeDropChance||15)&&(Va("strike"),Zt("You found a Strike!")),100*Math.random()<(t.healingPotionDropChance||15)&&(Va("healingPotion"),Zt("You found a Healing Potion!"))),Ue.qte=Ue.qte||{},Ue.qte[Ne.profileName]={result:"success",successRate:e,perfects:Ne.perfects,maxCombo:Ne.maxCombo,timestamp:Date.now()};else{Zt("QTE Failed..."),t.onFail&&await O(t.onFail);let o=!1;if(Ge.isOpen&&Ge.hpEnabled&&Ge.hp){var n,a;const e=t.damage||20,i=null!==(n=null===(a=Ge.profile)||void 0===a?void 0:a.battlebarDamageMultiplier)&&void 0!==n?n:1,s=Math.round(e*i);o=!await F(s,"qte")}if(Ue.qte=Ue.qte||{},Ue.qte[Ne.profileName]={result:"fail",successRate:e,perfects:Ne.perfects,maxCombo:Ne.maxCombo,timestamp:Date.now()},o)return void an()}!function(){const e=document.querySelector(".mazemaster-qte-prompt-area"),t=document.querySelector(".mazemaster-qte-stats"),n=document.querySelector(".mazemaster-qte-log"),a=document.getElementById("qte_result_panel"),o=document.getElementById("qte_result_text"),i=document.getElementById("qte_result_stats");e&&(e.style.display="none");t&&(t.style.display="none");n&&(n.style.display="none");a&&(a.style.display="block");const s=Math.round(Ne.successes/Ne.sequence.length*100);o&&(Ne.isSuccess?(o.textContent=Ne.perfects===Ne.sequence.length?"PERFECT!":"Success!",o.className="qte-result-text success"):(o.textContent="Failed...",o.className="qte-result-text fail"));i&&(i.innerHTML="\n            <div>Hits: ".concat(Ne.successes,"/").concat(Ne.sequence.length," (").concat(s,"%)</div>\n            <div>Perfect: ").concat(Ne.perfects," | Max Combo: ").concat(Ne.maxCombo,"x</div>\n        "))}()}();const e=Ne.sequence[Ne.currentIndex],t=Xt[e]||{label:e,icon:"fa-keyboard",color:"#fff"},n=document.getElementById("qte_key_prompt");n&&(n.innerHTML='\n            <i class="fa-solid '.concat(t.icon,'" style="color: ').concat(t.color,'"></i>\n            <span>').concat(t.label,"</span>\n        "),n.classList.remove("success","fail","perfect"));const a=document.getElementById("qte_timer_circle");a&&(a.style.strokeDashoffset="0",a.classList.remove("warning","critical")),Ne.promptStartTime=performance.now(),Ne.profile.onPrompt&&O(Ne.profile.onPrompt),Ne.timeoutId&&clearTimeout(Ne.timeoutId),Ne.timeoutId=setTimeout((()=>nn()),Ne.currentTimeWindow),en()}function en(){const e=document.getElementById("qte_timer_circle");if(!e||!Ne.isOpen||Ne.isComplete)return;const t=(performance.now()-Ne.promptStartTime)/Ne.currentTimeWindow,n=283*t;e.style.strokeDashoffset=n,t>.75?(e.classList.add("critical"),e.classList.remove("warning")):t>.5&&(e.classList.add("warning"),e.classList.remove("critical")),t<1&&Ne.isOpen&&!Ne.isComplete&&requestAnimationFrame(en)}function tn(e){if(!Ne.isOpen||Ne.isComplete)return;const t=Ne.sequence[Ne.currentIndex];let n=e.key.toUpperCase();" "===e.key&&(n="SPACE"),Ne.profile.allowedKeys.includes(n)&&(e.preventDefault(),n===t?async function(){Ne.timeoutId&&(clearTimeout(Ne.timeoutId),Ne.timeoutId=null);const e=performance.now()-Ne.promptStartTime,t=Ne.currentTimeWindow*(Ne.profile.perfectWindowPercent/100),n=e<=t;Ne.successes++,Ne.combo++,Ne.maxCombo=Math.max(Ne.maxCombo,Ne.combo);const a=document.getElementById("qte_key_prompt");n?(Ne.perfects++,null==a||a.classList.add("perfect"),Zt("PERFECT! (".concat(Math.round(e),"ms)")),Ne.profile.onPerfect&&await O(Ne.profile.onPerfect)):(null==a||a.classList.add("success"),Zt("Success! (".concat(Math.round(e),"ms)")),Ne.profile.onSuccess&&await O(Ne.profile.onSuccess));Ne.combo>1&&Ne.combo%3==0&&Zt("Combo x".concat(Ne.combo,"!"));Ne.currentIndex++,Qt(),Ne.profile.difficultyScaling&&(Ne.currentTimeWindow=Math.max(Ne.profile.timeWindowMin,Ne.currentTimeWindow*Ne.profile.difficultyScaling));setTimeout((()=>$t()),400)}():nn())}async function nn(){Ne.timeoutId&&(clearTimeout(Ne.timeoutId),Ne.timeoutId=null),Ne.misses++,Ne.combo=0;const e=document.getElementById("qte_key_prompt");null==e||e.classList.add("fail");const t=Ne.sequence[Ne.currentIndex];Zt("Miss! Expected: ".concat(t)),Ne.profile.onMiss&&await O(Ne.profile.onMiss),Ne.currentIndex++,Qt(),setTimeout((()=>$t()),400)}async function an(){Ne.timeoutId&&(clearTimeout(Ne.timeoutId),Ne.timeoutId=null),document.removeEventListener("keydown",tn);const e=document.getElementById("mazemaster_qte_modal");e&&e.remove();const t=Ne.isSuccess;if(Ne.isOpen=!1,Ge.isOpen){try{if(Ge.pendingEncounter){const e=Ge.pendingEncounter.type;if(t){var n;if(await ba(Ge.playerX,Ge.playerY),Ge.hp&&!1!==(null===(n=Ge.profile)||void 0===n?void 0:n.hpEnabled)){const e=Ge.profile.skillEncounterHealPercent||25,t=Ge.hp.max+(Ge.hp.maxBonus||0),n=Math.floor(t*(e/100));Ge.hp.current<t&&n>0&&(await j(n,!1,"QTE success"),addMazeLogMessage("Quick reflexes! Recovered ".concat(n," HP."),"heal"))}if("exit_qte"===e)return Ge.exitEncounterDone=!0,Ge.isPaused=!1,void yo()}}}catch(e){console.error("[MazeMaster] Error in closeQTEModal:",e)}Ge.isPaused=!1,Ge.pendingEncounter=null}}const on={d4:{sides:4,icon:"fa-dice-d4",color:"#e74c3c"},d6:{sides:6,icon:"fa-dice-d6",color:"#3498db"},d8:{sides:8,icon:"fa-dice",color:"#2ecc71"},d10:{sides:10,icon:"fa-dice-d10",color:"#f39c12"},d12:{sides:12,icon:"fa-dice-d12",color:"#9b59b6"},d20:{sides:20,icon:"fa-dice-d20",color:"#e67e22"},d100:{sides:100,icon:"fa-percent",color:"#1abc9c"}};function sn(e){console.log("[MazeMaster] startDice called with profile:",e);const t=mt(e);if(console.log("[MazeMaster] Dice profile retrieved:",t),!t)return console.error('[MazeMaster] Dice profile "'.concat(e,'" not found')),{error:'Profile "'.concat(e,'" not found')};on[t.diceType]||on.d6;return qe={isOpen:!0,profile:t,profileName:e,diceResults:[],total:0,rawTotal:0,threshold:t.threshold,modifier:t.modifier||0,rerollsRemaining:t.rerollsAllowed||0,isCriticalSuccess:!1,isCriticalFail:!1,isSuccess:!1,isComplete:!1,combatLog:["Ready to roll..."]},Ge.isOpen&&(Ge.isPaused=!0),function(){var e,t,n;const a=document.getElementById("mazemaster_dice_modal");a&&a.remove();if(!document.getElementById("mazemaster_dice_styles")){const e=document.createElement("style");e.id="mazemaster_dice_styles",e.textContent="\n        .mazemaster-dice-container {\n            display: flex;\n            flex-direction: column;\n            align-items: center;\n            gap: 15px;\n            padding: 25px;\n            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);\n            border-radius: 15px;\n            border: 2px solid #f39c12;\n            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5), 0 0 20px rgba(243, 156, 18, 0.3);\n            width: 420px;\n            max-width: 95vw;\n            max-height: 90vh;\n            overflow-y: auto;\n        }\n\n        .mazemaster-dice-main-title {\n            font-size: 1.8em;\n            font-weight: bold;\n            color: #fff;\n            text-shadow: 0 2px 4px rgba(0,0,0,0.5);\n        }\n\n        .mazemaster-dice-description {\n            font-size: 0.9em;\n            color: #aaa;\n            text-align: center;\n            max-width: 350px;\n        }\n\n        .mazemaster-dice-info {\n            display: flex;\n            gap: 20px;\n            font-size: 0.95em;\n            color: #ddd;\n        }\n\n        .dice-info-item {\n            display: flex;\n            align-items: center;\n            gap: 5px;\n        }\n\n        .dice-info-item i {\n            color: #f39c12;\n        }\n\n        .mazemaster-dice-roll-area {\n            width: 100%;\n            min-height: 120px;\n            background: rgba(0,0,0,0.3);\n            border-radius: 10px;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            cursor: pointer;\n            transition: all 0.3s ease;\n        }\n\n        .mazemaster-dice-roll-area:hover {\n            background: rgba(243, 156, 18, 0.2);\n        }\n\n        .dice-waiting {\n            text-align: center;\n            color: #888;\n        }\n\n        .dice-waiting i {\n            margin-bottom: 10px;\n            animation: dice-pulse 2s ease-in-out infinite;\n        }\n\n        @keyframes dice-pulse {\n            0%, 100% { opacity: 0.5; transform: scale(1); }\n            50% { opacity: 1; transform: scale(1.1); }\n        }\n\n        .dice-rolling {\n            display: flex;\n            gap: 10px;\n            flex-wrap: wrap;\n            justify-content: center;\n        }\n\n        .dice-single {\n            width: 60px;\n            height: 60px;\n            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);\n            border-radius: 10px;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            font-size: 1.5em;\n            font-weight: bold;\n            color: #fff;\n            box-shadow: 0 4px 8px rgba(0,0,0,0.3);\n            animation: dice-roll 0.5s ease-out;\n        }\n\n        .dice-single.critical-success {\n            background: linear-gradient(135deg, #f1c40f 0%, #f39c12 100%);\n            box-shadow: 0 0 20px rgba(241, 196, 15, 0.5);\n        }\n\n        .dice-single.critical-fail {\n            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);\n            box-shadow: 0 0 20px rgba(231, 76, 60, 0.5);\n        }\n\n        @keyframes dice-roll {\n            0% { transform: rotateX(0deg) rotateY(0deg) scale(0.5); opacity: 0; }\n            50% { transform: rotateX(180deg) rotateY(180deg) scale(1.2); }\n            100% { transform: rotateX(360deg) rotateY(360deg) scale(1); opacity: 1; }\n        }\n\n        .mazemaster-dice-result {\n            text-align: center;\n        }\n\n        .dice-result-total {\n            font-size: 3em;\n            font-weight: bold;\n            color: #f39c12;\n            text-shadow: 0 2px 4px rgba(0,0,0,0.5);\n        }\n\n        .dice-result-total.success { color: #2ecc71; }\n        .dice-result-total.fail { color: #e74c3c; }\n        .dice-result-total.critical-success {\n            color: #f1c40f;\n            animation: critical-glow 1s ease-in-out infinite;\n        }\n        .dice-result-total.critical-fail {\n            color: #c0392b;\n            animation: critical-shake 0.5s ease-in-out;\n        }\n\n        @keyframes critical-glow {\n            0%, 100% { text-shadow: 0 0 10px rgba(241, 196, 15, 0.5); }\n            50% { text-shadow: 0 0 30px rgba(241, 196, 15, 1); }\n        }\n\n        @keyframes critical-shake {\n            0%, 100% { transform: translateX(0); }\n            25% { transform: translateX(-5px); }\n            75% { transform: translateX(5px); }\n        }\n\n        .dice-result-breakdown {\n            font-size: 0.9em;\n            color: #888;\n            margin-top: 5px;\n        }\n\n        .mazemaster-dice-log {\n            width: 100%;\n            height: 60px;\n            background: rgba(0,0,0,0.4);\n            border-radius: 8px;\n            padding: 10px;\n            overflow-y: auto;\n            font-size: 0.85em;\n            color: #ccc;\n        }\n\n        .dice-log-entry { padding: 2px 0; }\n        .dice-log-success { color: #2ecc71; }\n        .dice-log-fail { color: #e74c3c; }\n        .dice-log-critical { color: #f1c40f; font-weight: bold; }\n        .dice-log-reroll { color: #3498db; }\n\n        .mazemaster-dice-actions {\n            display: flex;\n            gap: 10px;\n        }\n\n        .mazemaster-dice-btn {\n            padding: 12px 25px;\n            border: none;\n            border-radius: 8px;\n            font-size: 1em;\n            font-weight: bold;\n            cursor: pointer;\n            transition: all 0.2s ease;\n            display: flex;\n            align-items: center;\n            gap: 8px;\n        }\n\n        .mazemaster-dice-btn:hover {\n            transform: translateY(-2px);\n            box-shadow: 0 4px 12px rgba(0,0,0,0.3);\n        }\n\n        .mazemaster-dice-btn:disabled {\n            opacity: 0.5;\n            cursor: not-allowed;\n            transform: none;\n        }\n\n        .dice-btn-roll {\n            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);\n            color: white;\n        }\n\n        .dice-btn-reroll {\n            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);\n            color: white;\n        }\n\n        .dice-btn-close {\n            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);\n            color: white;\n            padding: 15px 40px;\n        }\n\n        .mazemaster-dice-final {\n            text-align: center;\n            padding: 15px;\n        }\n\n        .dice-final-text {\n            font-size: 1.6em;\n            font-weight: bold;\n            margin-bottom: 15px;\n        }\n\n        .dice-final-text.success { color: #2ecc71; }\n        .dice-final-text.fail { color: #e74c3c; }\n    ",document.head.appendChild(e)}document.body.insertAdjacentHTML("beforeend",'\n        <div id="mazemaster_dice_modal" style="position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:999999;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.9);">\n            <div class="mazemaster-dice-container">\n                <div id="dice_main_title" class="mazemaster-dice-main-title">Roll the Dice!</div>\n                <div id="dice_description" class="mazemaster-dice-description"></div>\n\n                <div class="mazemaster-dice-info">\n                    <span class="dice-info-item">\n                        <i class="fa-solid fa-bullseye"></i>\n                        Target: <span id="dice_threshold">0</span>\n                    </span>\n                    <span class="dice-info-item">\n                        <i class="fa-solid fa-plus-minus"></i>\n                        Modifier: <span id="dice_modifier">+0</span>\n                    </span>\n                    <span class="dice-info-item">\n                        <i class="fa-solid fa-rotate"></i>\n                        Rerolls: <span id="dice_rerolls">0</span>\n                    </span>\n                </div>\n\n                <div class="mazemaster-dice-roll-area" id="dice_roll_area">\n                    <div class="dice-waiting">\n                        <i class="fa-solid fa-dice fa-3x"></i>\n                        <div>Click to Roll!</div>\n                    </div>\n                </div>\n\n                <div class="mazemaster-dice-result" id="dice_result_display" style="display: none;">\n                    <div class="dice-result-total">\n                        <span id="dice_result_total">0</span>\n                    </div>\n                    <div class="dice-result-breakdown" id="dice_result_breakdown"></div>\n                </div>\n\n                <div class="mazemaster-dice-log" id="dice_combat_log">\n                    <div class="dice-log-entry">Ready to roll...</div>\n                </div>\n\n                <div class="mazemaster-dice-actions" id="dice_actions">\n                    <button id="dice_roll_btn" class="mazemaster-dice-btn dice-btn-roll">\n                        <i class="fa-solid fa-dice"></i> Roll\n                    </button>\n                </div>\n\n                <div class="mazemaster-dice-final" id="dice_final_panel" style="display: none;">\n                    <div id="dice_final_text" class="dice-final-text"></div>\n                    <button id="dice_close_btn" class="mazemaster-dice-btn dice-btn-close">\n                        <i class="fa-solid fa-check"></i> Close\n                    </button>\n                </div>\n            </div>\n        </div>\n    ');const o=qe.profile;document.getElementById("dice_main_title").textContent=o.mainTitle||"Roll the Dice!",document.getElementById("dice_description").textContent=o.description||"";const i="beat"===o.thresholdType?"> ".concat(o.threshold):" ".concat(o.threshold);document.getElementById("dice_threshold").textContent=i;const s=o.modifier>=0?"+".concat(o.modifier):"".concat(o.modifier);document.getElementById("dice_modifier").textContent=s,document.getElementById("dice_rerolls").textContent=qe.rerollsRemaining,null===(e=document.getElementById("dice_roll_area"))||void 0===e||e.addEventListener("click",cn),null===(t=document.getElementById("dice_roll_btn"))||void 0===t||t.addEventListener("click",cn),null===(n=document.getElementById("dice_close_btn"))||void 0===n||n.addEventListener("click",pn),rn()}(),t.onStart&&O(t.onStart),console.log("[MazeMaster] Dice started: ".concat(e)),{success:!0}}function rn(){document.getElementById("dice_rerolls").textContent=qe.rerollsRemaining;const e=document.getElementById("dice_combat_log");e&&(e.innerHTML=qe.combatLog.map((e=>{let t="dice-log-entry";return(e.includes("Success")||e.includes("passed"))&&(t+=" dice-log-success"),(e.includes("Failed")||e.includes("failed"))&&(t+=" dice-log-fail"),(e.includes("Critical")||e.includes("CRITICAL"))&&(t+=" dice-log-critical"),e.includes("Reroll")&&(t+=" dice-log-reroll"),'<div class="'.concat(t,'">').concat(e,"</div>")})).join(""),e.scrollTop=e.scrollHeight)}function ln(e){qe.combatLog.push(e),qe.combatLog.length>20&&qe.combatLog.shift(),rn()}async function cn(){if(qe.isComplete)return;const e=qe.profile,t=on[e.diceType]||on.d6,n=e.diceCount||1,a=[];for(let e=0;e<n;e++)a.push((o=t.sides,Math.floor(Math.random()*o)+1));var o;qe.diceResults=a,qe.rawTotal=a.reduce(((e,t)=>e+t),0),qe.total=qe.rawTotal+qe.modifier;document.getElementById("dice_roll_area").innerHTML='<div class="dice-rolling">'.concat(a.map((e=>'<div class="dice-single">'.concat(e,"</div>"))).join(""),"</div>");const i="".concat(n).concat(e.diceType),s=0!==qe.modifier?qe.modifier>0?" + ".concat(qe.modifier):" - ".concat(Math.abs(qe.modifier)):"";ln("Rolled ".concat(i,": [").concat(a.join(", "),"]").concat(s," = ").concat(qe.total)),e.onRoll&&await O(e.onRoll),qe.isCriticalSuccess=qe.rawTotal>=e.criticalSuccess,qe.isCriticalFail=qe.rawTotal<=e.criticalFail,"beat"===e.thresholdType?qe.isSuccess=qe.total>qe.threshold:qe.isSuccess=qe.total>=qe.threshold,setTimeout((()=>{!async function(){const e=qe.profile,t=document.getElementById("dice_result_display"),n=document.getElementById("dice_result_total"),a=document.getElementById("dice_result_breakdown"),o=document.getElementById("dice_actions");t.style.display="block",n.textContent=qe.total;let i=qe.isSuccess?"success":"fail";qe.isCriticalSuccess&&(i="critical-success");qe.isCriticalFail&&(i="critical-fail");n.className="dice-result-total "+i;const s=document.querySelectorAll(".dice-single");qe.isCriticalSuccess?s.forEach((e=>e.classList.add("critical-success"))):qe.isCriticalFail&&s.forEach((e=>e.classList.add("critical-fail")));const r="beat"===e.thresholdType?"needed > ".concat(qe.threshold):"needed  ".concat(qe.threshold);a.textContent=r,qe.isCriticalSuccess?(ln("CRITICAL SUCCESS!"),e.onCriticalSuccess&&await O(e.onCriticalSuccess)):qe.isCriticalFail&&(ln("CRITICAL FAILURE!"),e.onCriticalFail&&await O(e.onCriticalFail));qe.isSuccess?(ln("Roll passed!"),e.onSuccess&&await O(e.onSuccess)):(ln("Roll failed..."),e.onFail&&await O(e.onFail));if(qe.rerollsRemaining>0&&!qe.isSuccess){var l,c;const t="none"===e.rerollCost?"":" (costs 1 ".concat(e.rerollCost,")");o.innerHTML='\n            <button id="dice_reroll_btn" class="mazemaster-dice-btn dice-btn-reroll">\n                <i class="fa-solid fa-rotate"></i> Reroll'.concat(t,'\n            </button>\n            <button id="dice_accept_btn" class="mazemaster-dice-btn dice-btn-close">\n                <i class="fa-solid fa-check"></i> Accept\n            </button>\n        '),null===(l=document.getElementById("dice_reroll_btn"))||void 0===l||l.addEventListener("click",dn),null===(c=document.getElementById("dice_accept_btn"))||void 0===c||c.addEventListener("click",mn)}else setTimeout((()=>mn()),1e3)}()}),600)}async function dn(){const e=qe.profile;if("none"!==e.rerollCost){const t=e.rerollCost;if(Ge.isOpen&&Ge.inventory){if((Ge.inventory[t]||0)<=0)return void ln("Not enough ".concat(t,"s to reroll!"));Ge.inventory[t]--,ln("Spent 1 ".concat(t," to reroll"))}}qe.rerollsRemaining--,ln("Rerolling... (".concat(qe.rerollsRemaining," left)")),e.onReroll&&await O(e.onReroll),document.getElementById("dice_result_display").style.display="none",await cn()}async function mn(){qe.isComplete=!0;const e=qe.profile;document.getElementById("dice_actions").style.display="none";const t=document.getElementById("dice_final_panel"),n=document.getElementById("dice_final_text");if(qe.isSuccess)qe.isCriticalSuccess?n.textContent="CRITICAL SUCCESS!":n.textContent="Success!",n.className="dice-final-text success",e.onComplete&&await O(e.onComplete),Ge.isOpen&&Ge.pendingEncounter&&(100*Math.random()<(e.keyDropChance||25)&&(Va("key"),ln("You found a Key!")),100*Math.random()<(e.strikeDropChance||12)&&(Va("strike"),ln("You found a Strike!")),100*Math.random()<(e.healingPotionDropChance||15)&&(Va("healingPotion"),ln("You found a Healing Potion!"))),Ue.dice=Ue.dice||{},Ue.dice[qe.profileName]={result:"success",total:qe.total,rawTotal:qe.rawTotal,isCritical:qe.isCriticalSuccess,timestamp:Date.now()};else{qe.isCriticalFail?n.textContent="CRITICAL FAILURE!":n.textContent="Failed...",n.className="dice-final-text fail",e.onLose&&await O(e.onLose);let t=!1;if(Ge.isOpen&&Ge.hpEnabled&&Ge.hp){var a,o;let n=e.damage||20;qe.isCriticalFail&&(n=Math.round(1.5*n));const i=null!==(a=null===(o=Ge.profile)||void 0===o?void 0:o.battlebarDamageMultiplier)&&void 0!==a?a:1,s=Math.round(n*i);t=!await F(s,"dice")}if(Ue.dice=Ue.dice||{},Ue.dice[qe.profileName]={result:"fail",total:qe.total,rawTotal:qe.rawTotal,isCritical:qe.isCriticalFail,timestamp:Date.now()},t)return void pn()}t.style.display="block"}async function pn(){const e=document.getElementById("mazemaster_dice_modal");e&&e.remove();const t=qe.isSuccess;if(qe.isOpen=!1,Ge.isOpen){try{if(Ge.pendingEncounter){const e=Ge.pendingEncounter.type;if(t&&(await ba(Ge.playerX,Ge.playerY),"exit_dice"===e))return Ge.exitEncounterDone=!0,Ge.isPaused=!1,void yo()}}catch(e){console.error("[MazeMaster] Error in closeDiceModal:",e)}Ge.isPaused=!1,Ge.pendingEncounter=null}}function un(e){console.log("[MazeMaster] startStealth called with profile:",e);const t=ht(e);return console.log("[MazeMaster] Retrieved stealth profile:",t),t?(console.log("[MazeMaster] Initializing stealth state with config:",{sectionsToPass:t.sectionsToPass,detectionThreshold:t.detectionThreshold}),Fe={isOpen:!0,profile:t,profileName:e,currentSection:0,sectionsToPass:t.sectionsToPass,detection:0,detectionThreshold:t.detectionThreshold,isSuccess:!1,isCaught:!1,isComplete:!1,actionsTaken:0,combatLog:["You begin your infiltration..."]},console.log("[MazeMaster] currentStealth initialized:",Fe),Ge.isOpen&&(Ge.isPaused=!0,console.log("[MazeMaster] Maze paused for stealth")),console.log("[MazeMaster] Calling showStealthModal..."),function(){var e,t,n,a,o;console.log("[MazeMaster] showStealthModal called");const i=document.getElementById("mazemaster_stealth_modal");i&&(console.log("[MazeMaster] Removing existing stealth modal"),i.remove());if(!document.getElementById("mazemaster_stealth_styles")){console.log("[MazeMaster] Adding stealth styles to document");const e=document.createElement("style");e.id="mazemaster_stealth_styles",e.textContent="\n        .mazemaster-stealth-container {\n            display: flex;\n            flex-direction: column;\n            align-items: center;\n            gap: 15px;\n            padding: 25px;\n            background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1a 100%);\n            border-radius: 15px;\n            border: 2px solid #1abc9c;\n            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5), 0 0 20px rgba(26, 188, 156, 0.3);\n            width: 450px;\n            max-width: 95vw;\n            max-height: 90vh;\n            overflow-y: auto;\n        }\n\n        .mazemaster-stealth-main-title {\n            font-size: 1.8em;\n            font-weight: bold;\n            color: #fff;\n            text-shadow: 0 2px 4px rgba(0,0,0,0.5);\n        }\n\n        .mazemaster-stealth-description {\n            font-size: 0.9em;\n            color: #aaa;\n            text-align: center;\n            max-width: 380px;\n        }\n\n        .mazemaster-stealth-progress {\n            width: 100%;\n            text-align: center;\n        }\n\n        .stealth-sections {\n            font-size: 1.1em;\n            color: #1abc9c;\n        }\n\n        #stealth_section_display {\n            font-weight: bold;\n        }\n\n        .mazemaster-stealth-detection {\n            width: 100%;\n            display: flex;\n            align-items: center;\n            gap: 10px;\n        }\n\n        .stealth-detection-label {\n            display: flex;\n            align-items: center;\n            gap: 5px;\n            color: #e74c3c;\n            min-width: 90px;\n        }\n\n        .stealth-detection-bar {\n            flex: 1;\n            height: 20px;\n            background: #333;\n            border-radius: 10px;\n            overflow: hidden;\n        }\n\n        .stealth-detection-fill {\n            height: 100%;\n            width: 0%;\n            background: linear-gradient(90deg, #27ae60, #f39c12, #e74c3c);\n            transition: width 0.3s ease;\n        }\n\n        .stealth-detection-text {\n            min-width: 60px;\n            text-align: right;\n            color: #ddd;\n        }\n\n        .mazemaster-stealth-guard {\n            display: flex;\n            flex-direction: column;\n            align-items: center;\n            gap: 10px;\n            padding: 20px;\n            background: rgba(0,0,0,0.3);\n            border-radius: 10px;\n            width: 100%;\n        }\n\n        .mazemaster-stealth-guard i {\n            color: #7f8c8d;\n            transition: all 0.3s ease;\n        }\n\n        .mazemaster-stealth-guard.alert i {\n            color: #f39c12;\n            animation: guard-alert 1s ease infinite;\n        }\n\n        .mazemaster-stealth-guard.detected i {\n            color: #e74c3c;\n            animation: guard-detected 0.5s ease infinite;\n        }\n\n        @keyframes guard-alert {\n            0%, 100% { opacity: 0.7; }\n            50% { opacity: 1; }\n        }\n\n        @keyframes guard-detected {\n            0%, 100% { transform: scale(1); }\n            50% { transform: scale(1.1); }\n        }\n\n        #stealth_guard_name {\n            font-size: 1.1em;\n            font-weight: bold;\n            color: #ddd;\n        }\n\n        #stealth_guard_status {\n            font-size: 0.9em;\n            color: #888;\n        }\n\n        #stealth_guard_status.alert { color: #f39c12; }\n        #stealth_guard_status.detected { color: #e74c3c; font-weight: bold; }\n\n        .mazemaster-stealth-log {\n            width: 100%;\n            height: 80px;\n            background: rgba(0,0,0,0.4);\n            border-radius: 8px;\n            padding: 10px;\n            overflow-y: auto;\n            font-size: 0.85em;\n            color: #ccc;\n        }\n\n        .stealth-log-entry { padding: 2px 0; }\n        .stealth-log-success { color: #1abc9c; }\n        .stealth-log-fail { color: #e74c3c; }\n        .stealth-log-warning { color: #f39c12; }\n        .stealth-log-action { color: #3498db; }\n\n        .mazemaster-stealth-actions {\n            display: grid;\n            grid-template-columns: 1fr 1fr;\n            gap: 10px;\n            width: 100%;\n        }\n\n        .mazemaster-stealth-btn {\n            padding: 12px 20px;\n            border: none;\n            border-radius: 8px;\n            font-size: 1em;\n            font-weight: bold;\n            cursor: pointer;\n            transition: all 0.2s ease;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            gap: 8px;\n        }\n\n        .mazemaster-stealth-btn:hover {\n            transform: translateY(-2px);\n            box-shadow: 0 4px 12px rgba(0,0,0,0.3);\n        }\n\n        .mazemaster-stealth-btn:disabled {\n            opacity: 0.5;\n            cursor: not-allowed;\n            transform: none;\n        }\n\n        .stealth-btn-advance {\n            background: linear-gradient(135deg, #1abc9c 0%, #16a085 100%);\n            color: white;\n        }\n\n        .stealth-btn-hide {\n            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);\n            color: white;\n        }\n\n        .stealth-btn-distract {\n            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);\n            color: white;\n        }\n\n        .stealth-btn-wait {\n            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);\n            color: white;\n        }\n\n        .stealth-btn-close {\n            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);\n            color: white;\n            padding: 15px 40px;\n        }\n\n        .mazemaster-stealth-result {\n            text-align: center;\n            padding: 15px;\n        }\n\n        .stealth-result-text {\n            font-size: 1.6em;\n            font-weight: bold;\n            margin-bottom: 15px;\n        }\n\n        .stealth-result-text.success { color: #1abc9c; }\n        .stealth-result-text.fail { color: #e74c3c; }\n    ",document.head.appendChild(e)}console.log("[MazeMaster] Inserting stealth modal HTML"),document.body.insertAdjacentHTML("beforeend",'\n        <div id="mazemaster_stealth_modal" style="position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:999999;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.9);">\n            <div class="mazemaster-stealth-container">\n                <div id="stealth_main_title" class="mazemaster-stealth-main-title">Stealth</div>\n                <div id="stealth_description" class="mazemaster-stealth-description"></div>\n\n                <div class="mazemaster-stealth-progress">\n                    <div class="stealth-sections">\n                        <span>Progress: </span>\n                        <span id="stealth_section_display"></span>\n                    </div>\n                </div>\n\n                <div class="mazemaster-stealth-detection">\n                    <div class="stealth-detection-label">\n                        <i class="fa-solid fa-eye"></i>\n                        <span>Detection</span>\n                    </div>\n                    <div class="stealth-detection-bar">\n                        <div class="stealth-detection-fill" id="stealth_detection_bar"></div>\n                    </div>\n                    <div class="stealth-detection-text">\n                        <span id="stealth_detection_value">0</span>/<span id="stealth_detection_max">100</span>\n                    </div>\n                </div>\n\n                <div class="mazemaster-stealth-guard" id="stealth_guard_area">\n                    <i class="fa-solid fa-user-shield fa-3x"></i>\n                    <div id="stealth_guard_name">Guard</div>\n                    <div id="stealth_guard_status">Unaware</div>\n                </div>\n\n                <div class="mazemaster-stealth-log" id="stealth_combat_log">\n                    <div class="stealth-log-entry">You begin your infiltration...</div>\n                </div>\n\n                <div class="mazemaster-stealth-actions" id="stealth_actions">\n                    <button id="stealth_advance_btn" class="mazemaster-stealth-btn stealth-btn-advance" title="Move forward - risky but progresses">\n                        <i class="fa-solid fa-forward"></i> Advance\n                    </button>\n                    <button id="stealth_hide_btn" class="mazemaster-stealth-btn stealth-btn-hide" title="Stay hidden - reduces detection">\n                        <i class="fa-solid fa-mask"></i> Hide\n                    </button>\n                    <button id="stealth_distract_btn" class="mazemaster-stealth-btn stealth-btn-distract" title="Create a distraction - may reduce detection significantly">\n                        <i class="fa-solid fa-volume-high"></i> Distract\n                    </button>\n                    <button id="stealth_wait_btn" class="mazemaster-stealth-btn stealth-btn-wait" title="Wait patiently - small detection reduction">\n                        <i class="fa-solid fa-hourglass-half"></i> Wait\n                    </button>\n                </div>\n\n                <div class="mazemaster-stealth-result" id="stealth_result_panel" style="display: none;">\n                    <div id="stealth_result_text" class="stealth-result-text"></div>\n                    <button id="stealth_close_btn" class="mazemaster-stealth-btn stealth-btn-close">\n                        <i class="fa-solid fa-check"></i> Close\n                    </button>\n                </div>\n            </div>\n        </div>\n    ');const s=document.getElementById("mazemaster_stealth_modal");console.log("[MazeMaster] Stealth modal element after insert:",s);const r=Fe.profile;console.log("[MazeMaster] Updating stealth UI with profile:",null==r?void 0:r.name);const l=document.getElementById("stealth_main_title"),c=document.getElementById("stealth_description");console.log("[MazeMaster] Stealth UI elements - title:",l,"desc:",c),l&&(l.textContent=r.mainTitle||"Stealth");c&&(c.textContent=r.description||"");document.getElementById("stealth_guard_name").textContent=r.guardName||"Guard",document.getElementById("stealth_detection_max").textContent=Fe.detectionThreshold,console.log("[MazeMaster] Attaching stealth event handlers"),null===(e=document.getElementById("stealth_advance_btn"))||void 0===e||e.addEventListener("click",(()=>fn("advance"))),null===(t=document.getElementById("stealth_hide_btn"))||void 0===t||t.addEventListener("click",(()=>fn("hide"))),null===(n=document.getElementById("stealth_distract_btn"))||void 0===n||n.addEventListener("click",(()=>fn("distract"))),null===(a=document.getElementById("stealth_wait_btn"))||void 0===a||a.addEventListener("click",(()=>fn("wait"))),null===(o=document.getElementById("stealth_close_btn"))||void 0===o||o.addEventListener("click",bn),console.log("[MazeMaster] Calling updateStealthDisplay"),hn(),console.log("[MazeMaster] showStealthModal complete")}(),t.onStart&&O(t.onStart),console.log("[MazeMaster] Stealth started: ".concat(e)),{success:!0}):(console.error('[MazeMaster] Stealth profile "'.concat(e,'" not found')),{error:'Profile "'.concat(e,'" not found')})}function hn(){const e=document.getElementById("stealth_section_display");if(e){let t="";for(let e=0;e<Fe.sectionsToPass;e++)e<Fe.currentSection?t+=" ":t+=" ";e.textContent=t.trim()}const t=document.getElementById("stealth_detection_bar"),n=document.getElementById("stealth_detection_value"),a=Fe.detection/Fe.detectionThreshold*100;t&&(t.style.width="".concat(Math.min(a,100),"%")),n&&(n.textContent=Math.round(Fe.detection));const o=document.getElementById("stealth_guard_area"),i=document.getElementById("stealth_guard_status");o&&i&&(o.classList.remove("alert","detected"),a>=80?(o.classList.add("detected"),i.textContent="ALERT!",i.className="detected"):a>=50?(o.classList.add("alert"),i.textContent="Suspicious",i.className="alert"):a>=25?(i.textContent="Cautious",i.className=""):(i.textContent="Unaware",i.className=""));const s=document.getElementById("stealth_combat_log");s&&(s.innerHTML=Fe.combatLog.map((e=>{let t="stealth-log-entry";return(e.includes("success")||e.includes("passed")||e.includes("clear"))&&(t+=" stealth-log-success"),(e.includes("spotted")||e.includes("caught")||e.includes("failed"))&&(t+=" stealth-log-fail"),(e.includes("suspicion")||e.includes("alert")||e.includes("detection"))&&(t+=" stealth-log-warning"),e.includes("You ")&&(t+=" stealth-log-action"),'<div class="'.concat(t,'">').concat(e,"</div>")})).join(""),s.scrollTop=s.scrollHeight)}function gn(e){Fe.combatLog.push(e),Fe.combatLog.length>30&&Fe.combatLog.shift(),hn()}async function fn(e){if(Fe.isComplete)return;const t=Fe.profile;Fe.actionsTaken++;let n=!1,a=0;switch(e){case"advance":n=100*Math.random()<t.advanceSuccessChance,n?(Fe.currentSection++,gn("You advance quietly... clear!"),t.onAdvance&&await O(t.onAdvance)):(a=t.baseDetectionRate,gn("You made noise! (+".concat(a," detection)")),t.onDetectionIncrease&&await O(t.onDetectionIncrease));break;case"hide":a=-t.hideRecovery,gn("You hide in the shadows... (-".concat(t.hideRecovery," detection)")),t.onHide&&await O(t.onHide),n=!0;break;case"distract":n=100*Math.random()<t.distractSuccessChance,n?(a=-t.distractReduction,gn("Distraction worked! (-".concat(t.distractReduction," detection)")),t.onDistract&&await O(t.onDistract)):(a=Math.round(.5*t.baseDetectionRate),gn("Distraction failed! (+".concat(a," detection)")),t.onDetectionIncrease&&await O(t.onDetectionIncrease));break;case"wait":a=-t.waitRecovery,gn("You wait patiently... (-".concat(t.waitRecovery," detection)")),t.onWait&&await O(t.onWait),n=!0}Fe.detection=Math.max(0,Fe.detection+a),hn(),Fe.detection>=Fe.detectionThreshold?await async function(){Fe.isComplete=!0,Fe.isCaught=!0,gn("You've been caught!");const e=Fe.profile;e.onCaught&&await O(e.onCaught);let t=!1;if(Ge.isOpen&&Ge.hpEnabled&&Ge.hp){var n,a;const o=e.damage||25,i=null!==(n=null===(a=Ge.profile)||void 0===a?void 0:a.battlebarDamageMultiplier)&&void 0!==n?n:1,s=Math.round(o*i);t=!await F(s,"stealth")}if(Ue.stealth=Ue.stealth||{},Ue.stealth[Fe.profileName]={result:"caught",actionsTaken:Fe.actionsTaken,finalDetection:Fe.detection,timestamp:Date.now()},t)return void bn();vn()}():Fe.currentSection>=Fe.sectionsToPass&&await async function(){Fe.isComplete=!0,Fe.isSuccess=!0,gn("Infiltration successful!");const e=Fe.profile;e.onComplete&&await O(e.onComplete);Ge.isOpen&&Ge.pendingEncounter&&(100*Math.random()<(e.keyDropChance||20)&&(Va("key"),gn("You found a Key!")),100*Math.random()<(e.stealthDropChance||15)&&(Va("stealth"),gn("You found a Stealth item!")),100*Math.random()<(e.healingPotionDropChance||15)&&(Va("healingPotion"),gn("You found a Healing Potion!")));Ue.stealth=Ue.stealth||{},Ue.stealth[Fe.profileName]={result:"success",actionsTaken:Fe.actionsTaken,finalDetection:Fe.detection,timestamp:Date.now()},vn()}()}function vn(){const e=document.getElementById("stealth_actions"),t=document.getElementById("stealth_result_panel"),n=document.getElementById("stealth_result_text");e&&(e.style.display="none"),t&&(t.style.display="block"),n&&(Fe.isSuccess?(n.textContent="Infiltration Successful!",n.className="stealth-result-text success"):(n.textContent="Caught!",n.className="stealth-result-text fail"))}async function bn(){const e=document.getElementById("mazemaster_stealth_modal");e&&e.remove();const t=Fe.isSuccess;if(Fe.isOpen=!1,Ge.isOpen){try{if(Ge.pendingEncounter){const e=Ge.pendingEncounter.type;if(t){var n;if(await ba(Ge.playerX,Ge.playerY),Ge.hp&&!1!==(null===(n=Ge.profile)||void 0===n?void 0:n.hpEnabled)){const e=Ge.profile.skillEncounterHealPercent||25,t=Ge.hp.max+(Ge.hp.maxBonus||0),n=Math.floor(t*(e/100));Ge.hp.current<t&&n>0&&(await j(n,!1,"Stealth success"),addMazeLogMessage("Silent and deadly! Recovered ".concat(n," HP."),"heal"))}if("exit_stealth"===e)return Ge.exitEncounterDone=!0,Ge.isPaused=!1,void yo()}}}catch(e){console.error("[MazeMaster] Error in closeStealthModal:",e)}Ge.isPaused=!1,Ge.pendingEncounter=null}}function yn(e){console.log("[MazeMaster] startPuzzle called with profile:",e);const t=vt(e);if(console.log("[MazeMaster] Retrieved puzzle profile:",t),!t)return console.error('[MazeMaster] Puzzle profile "'.concat(e,'" not found')),{error:'Profile "'.concat(e,'" not found')};const n=t.gridSize||3,a=t.sequenceLength||4,o=[],i=n*n;console.log("[MazeMaster] Generating puzzle with gridSize:",n,"sequenceLength:",a);for(let e=0;e<a;e++)o.push(Math.floor(Math.random()*i));return console.log("[MazeMaster] Generated sequence:",o),je={isOpen:!0,profile:t,profileName:e,puzzleType:t.puzzleType||"sequence",gridSize:n,grid:[],sequence:o,playerSequence:[],currentStep:0,timeLimit:t.timeLimit||0,timeRemaining:t.timeLimit||0,timerInterval:null,hintsRemaining:t.hintsAllowed||0,hintsUsed:0,wrongGuesses:0,wrongGuessesAllowed:t.wrongGuessesAllowed||3,score:100,isShowingSequence:!1,isSuccess:!1,isFailed:!1,isComplete:!1,combatLog:["The puzzle awaits..."]},console.log("[MazeMaster] currentPuzzle initialized:",je),Ge.isOpen&&(Ge.isPaused=!0,console.log("[MazeMaster] Maze paused for puzzle")),console.log("[MazeMaster] Calling showPuzzleModal..."),function(){var e,t,n;console.log("[MazeMaster] showPuzzleModal called");const a=document.getElementById("mazemaster_puzzle_modal");a&&(console.log("[MazeMaster] Removing existing puzzle modal"),a.remove());if(!document.getElementById("mazemaster_puzzle_styles")){console.log("[MazeMaster] Adding puzzle styles to document");const e=document.createElement("style");e.id="mazemaster_puzzle_styles",e.textContent="\n        .mazemaster-puzzle-container {\n            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f0f23 100%);\n            border: 2px solid #3d5a80;\n            border-radius: 15px;\n            padding: 25px;\n            min-width: 450px;\n            max-width: 550px;\n            box-shadow: 0 0 40px rgba(61, 90, 128, 0.4);\n            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\n            color: #e0e0e0;\n        }\n\n        .puzzle-main-title {\n            text-align: center;\n            font-size: 1.8em;\n            font-weight: bold;\n            color: #9b59b6;\n            text-shadow: 0 0 10px rgba(155, 89, 182, 0.5);\n            margin-bottom: 8px;\n        }\n\n        .puzzle-description {\n            text-align: center;\n            font-size: 0.95em;\n            color: #bbb;\n            margin-bottom: 15px;\n            font-style: italic;\n        }\n\n        .puzzle-stats-row {\n            display: flex;\n            justify-content: space-around;\n            margin-bottom: 15px;\n            padding: 10px;\n            background: rgba(0,0,0,0.3);\n            border-radius: 8px;\n        }\n\n        .puzzle-stat {\n            text-align: center;\n        }\n\n        .puzzle-stat-label {\n            color: #888;\n            font-size: 0.85em;\n            display: block;\n        }\n\n        .puzzle-stat span:not(.puzzle-stat-label) {\n            color: #9b59b6;\n            font-weight: bold;\n            font-size: 1.1em;\n        }\n\n        .puzzle-instruction {\n            text-align: center;\n            font-size: 1.1em;\n            color: #f1c40f;\n            margin-bottom: 15px;\n            padding: 10px;\n            background: rgba(241, 196, 15, 0.1);\n            border-radius: 8px;\n            border: 1px solid rgba(241, 196, 15, 0.3);\n        }\n\n        .puzzle-grid-container {\n            display: flex;\n            justify-content: center;\n            margin-bottom: 20px;\n        }\n\n        .puzzle-grid {\n            display: grid;\n            gap: 8px;\n            padding: 15px;\n            background: rgba(0,0,0,0.4);\n            border-radius: 10px;\n            border: 2px solid #3d5a80;\n        }\n\n        .puzzle-cell {\n            width: 60px;\n            height: 60px;\n            background: linear-gradient(135deg, #2c3e50 0%, #1a252f 100%);\n            border: 2px solid #3d5a80;\n            border-radius: 8px;\n            cursor: pointer;\n            transition: all 0.2s ease;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            font-size: 1.5em;\n            font-weight: bold;\n            color: #fff;\n        }\n\n        .puzzle-cell:hover:not(.disabled) {\n            background: linear-gradient(135deg, #3d5a80 0%, #2c3e50 100%);\n            transform: scale(1.05);\n        }\n\n        .puzzle-cell.highlighted {\n            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);\n            border-color: #bb6bd9;\n            box-shadow: 0 0 20px rgba(155, 89, 182, 0.6);\n            animation: puzzle-pulse 0.5s ease;\n        }\n\n        .puzzle-cell.correct {\n            background: linear-gradient(135deg, #27ae60 0%, #1e8449 100%);\n            border-color: #2ecc71;\n            box-shadow: 0 0 15px rgba(46, 204, 113, 0.5);\n        }\n\n        .puzzle-cell.wrong {\n            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);\n            border-color: #e74c3c;\n            animation: puzzle-shake 0.3s ease;\n        }\n\n        .puzzle-cell.hint {\n            background: linear-gradient(135deg, #f39c12 0%, #d68910 100%);\n            border-color: #f1c40f;\n            box-shadow: 0 0 15px rgba(241, 196, 15, 0.5);\n        }\n\n        .puzzle-cell.disabled {\n            opacity: 0.5;\n            cursor: not-allowed;\n        }\n\n        @keyframes puzzle-pulse {\n            0% { transform: scale(1); }\n            50% { transform: scale(1.1); }\n            100% { transform: scale(1); }\n        }\n\n        @keyframes puzzle-shake {\n            0%, 100% { transform: translateX(0); }\n            25% { transform: translateX(-5px); }\n            75% { transform: translateX(5px); }\n        }\n\n        .puzzle-actions {\n            display: flex;\n            justify-content: center;\n            gap: 15px;\n            margin-bottom: 15px;\n        }\n\n        .puzzle-btn {\n            padding: 12px 25px;\n            border: none;\n            border-radius: 8px;\n            cursor: pointer;\n            font-size: 1em;\n            font-weight: bold;\n            transition: all 0.2s ease;\n        }\n\n        .puzzle-hint-btn {\n            background: linear-gradient(135deg, #f39c12 0%, #d68910 100%);\n            color: white;\n        }\n\n        .puzzle-hint-btn:hover:not(:disabled) {\n            transform: scale(1.05);\n            box-shadow: 0 0 15px rgba(243, 156, 18, 0.5);\n        }\n\n        .puzzle-hint-btn:disabled {\n            opacity: 0.5;\n            cursor: not-allowed;\n        }\n\n        .puzzle-reset-btn {\n            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);\n            color: white;\n        }\n\n        .puzzle-reset-btn:hover {\n            transform: scale(1.05);\n            box-shadow: 0 0 15px rgba(52, 152, 219, 0.5);\n        }\n\n        .puzzle-close-btn {\n            background: linear-gradient(135deg, #27ae60 0%, #1e8449 100%);\n            color: white;\n            padding: 15px 40px;\n            font-size: 1.1em;\n        }\n\n        .puzzle-close-btn:hover {\n            transform: scale(1.05);\n            box-shadow: 0 0 15px rgba(39, 174, 96, 0.5);\n        }\n\n        .puzzle-result-panel {\n            text-align: center;\n            padding: 20px;\n        }\n\n        .puzzle-result-text {\n            font-size: 1.6em;\n            font-weight: bold;\n            margin-bottom: 20px;\n        }\n\n        .puzzle-result-text.success { color: #2ecc71; }\n        .puzzle-result-text.fail { color: #e74c3c; }\n\n        .puzzle-combat-log {\n            max-height: 100px;\n            overflow-y: auto;\n            background: rgba(0,0,0,0.3);\n            border-radius: 8px;\n            padding: 10px;\n            font-size: 0.9em;\n        }\n\n        .puzzle-log-entry {\n            padding: 3px 0;\n            border-bottom: 1px solid rgba(255,255,255,0.1);\n        }\n\n        .puzzle-log-entry:last-child { border-bottom: none; }\n        .puzzle-log-success { color: #2ecc71; }\n        .puzzle-log-fail { color: #e74c3c; }\n        .puzzle-log-warning { color: #f39c12; }\n        .puzzle-log-info { color: #3498db; }\n    ",document.head.appendChild(e)}console.log("[MazeMaster] Inserting puzzle modal HTML"),document.body.insertAdjacentHTML("beforeend",'\n        <div id="mazemaster_puzzle_modal" style="position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:999999;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.9);">\n            <div class="mazemaster-puzzle-container">\n                <div id="puzzle_main_title" class="puzzle-main-title">Puzzle</div>\n                <div id="puzzle_description" class="puzzle-description"></div>\n\n                <div class="puzzle-stats-row">\n                    <div class="puzzle-stat">\n                        <span class="puzzle-stat-label">Progress:</span>\n                        <span id="puzzle_progress">0/0</span>\n                    </div>\n                    <div class="puzzle-stat">\n                        <span class="puzzle-stat-label">Time:</span>\n                        <span id="puzzle_timer">--</span>\n                    </div>\n                    <div class="puzzle-stat">\n                        <span class="puzzle-stat-label">Hints:</span>\n                        <span id="puzzle_hints">0</span>\n                    </div>\n                    <div class="puzzle-stat">\n                        <span class="puzzle-stat-label">Mistakes:</span>\n                        <span id="puzzle_mistakes">0/0</span>\n                    </div>\n                </div>\n\n                <div class="puzzle-instruction" id="puzzle_instruction">Watch the sequence...</div>\n\n                <div id="puzzle_grid_container" class="puzzle-grid-container">\n                    \x3c!-- Grid will be generated here --\x3e\n                </div>\n\n                <div id="puzzle_actions" class="puzzle-actions">\n                    <button id="puzzle_hint_btn" class="puzzle-btn puzzle-hint-btn">\n                        <i class="fa-solid fa-lightbulb"></i> Use Hint\n                    </button>\n                    <button id="puzzle_reset_btn" class="puzzle-btn puzzle-reset-btn">\n                        <i class="fa-solid fa-redo"></i> Show Sequence\n                    </button>\n                </div>\n\n                <div id="puzzle_result_panel" class="puzzle-result-panel" style="display:none;">\n                    <div id="puzzle_result_text" class="puzzle-result-text"></div>\n                    <button id="puzzle_close_btn" class="puzzle-btn puzzle-close-btn">\n                        <i class="fa-solid fa-check"></i> Continue\n                    </button>\n                </div>\n\n                <div id="puzzle_combat_log" class="puzzle-combat-log"></div>\n            </div>\n        </div>\n    ');const o=document.getElementById("mazemaster_puzzle_modal");console.log("[MazeMaster] Puzzle modal element after insert:",o);const i=je.profile;console.log("[MazeMaster] Updating puzzle UI with profile:",null==i?void 0:i.name);const s=document.getElementById("puzzle_main_title"),r=document.getElementById("puzzle_description");console.log("[MazeMaster] Puzzle UI elements - title:",s,"desc:",r),s&&(s.textContent=i.mainTitle||"Puzzle");r&&(r.textContent=i.description||"");document.getElementById("puzzle_hints").textContent=je.hintsRemaining,document.getElementById("puzzle_mistakes").textContent="".concat(je.wrongGuesses,"/").concat(je.wrongGuessesAllowed),document.getElementById("puzzle_progress").textContent="".concat(je.currentStep,"/").concat(je.sequence.length),console.log("[MazeMaster] Generating puzzle grid"),function(){const e=document.getElementById("puzzle_grid_container");if(!e)return;const t=je.gridSize,n=document.createElement("div");n.className="puzzle-grid",n.style.gridTemplateColumns="repeat(".concat(t,", 60px)");for(let e=0;e<t*t;e++){const t=document.createElement("div");t.className="puzzle-cell",t.dataset.index=e,t.textContent=e+1,t.addEventListener("click",(()=>xn(e))),n.appendChild(t),je.grid.push(t)}e.innerHTML="",e.appendChild(n)}(),console.log("[MazeMaster] Attaching puzzle event handlers"),null===(e=document.getElementById("puzzle_hint_btn"))||void 0===e||e.addEventListener("click",_n),null===(t=document.getElementById("puzzle_reset_btn"))||void 0===t||t.addEventListener("click",zn),null===(n=document.getElementById("puzzle_close_btn"))||void 0===n||n.addEventListener("click",Sn),je.timeLimit>0?(console.log("[MazeMaster] Starting puzzle timer with limit:",je.timeLimit),function(){const e=document.getElementById("puzzle_timer");je.timerInterval=setInterval((()=>{if(je.timeRemaining--,e){const t=Math.floor(je.timeRemaining/60),n=je.timeRemaining%60;e.textContent="".concat(t,":").concat(n.toString().padStart(2,"0")),je.timeRemaining<=10&&(e.style.color="#e74c3c")}je.timeRemaining<=0&&(clearInterval(je.timerInterval),Cn("Time's up!"),wn())}),1e3)}()):document.getElementById("puzzle_timer").textContent="";console.log("[MazeMaster] Scheduling sequence display in 500ms"),setTimeout((()=>zn()),500),console.log("[MazeMaster] showPuzzleModal complete")}(),t.onStart&&O(t.onStart),console.log("[MazeMaster] Puzzle started: ".concat(e)),{success:!0}}async function zn(){if(je.isComplete)return;je.isShowingSequence=!0;const e=document.getElementById("puzzle_instruction");e&&(e.textContent="Watch carefully..."),je.grid.forEach((e=>e.classList.add("disabled")));for(let e=0;e<je.sequence.length;e++){const t=je.sequence[e],n=je.grid[t];await new Promise((e=>setTimeout(e,600))),n.classList.add("highlighted"),await new Promise((e=>setTimeout(e,400))),n.classList.remove("highlighted")}await new Promise((e=>setTimeout(e,300))),je.isShowingSequence=!1,e&&(e.textContent="Repeat the sequence!"),je.grid.forEach((e=>e.classList.remove("disabled"))),Cn("Sequence shown. Your turn!")}function xn(e){if(je.isComplete||je.isShowingSequence)return;const t=je.grid[e],n=je.sequence[je.currentStep],a=je.profile;e===n?(t.classList.add("correct"),setTimeout((()=>t.classList.remove("correct")),300),je.currentStep++,je.playerSequence.push(e),document.getElementById("puzzle_progress").textContent="".concat(je.currentStep,"/").concat(je.sequence.length),Cn("Step ".concat(je.currentStep," correct!")),a.onCorrectMove&&O(a.onCorrectMove),je.currentStep>=je.sequence.length&&async function(){je.isComplete=!0,je.isSuccess=!0,je.timerInterval&&clearInterval(je.timerInterval);Cn("Puzzle solved!");const e=je.profile;e.onComplete&&await O(e.onComplete);Ge.isOpen&&Ge.pendingEncounter&&(100*Math.random()<(e.keyDropChance||20)&&(Va("key"),Cn("You found a Key!")),100*Math.random()<(e.stealthDropChance||15)&&(Va("stealth"),Cn("You found a Stealth item!")),100*Math.random()<(e.healingPotionDropChance||15)&&(Va("healingPotion"),Cn("You found a Healing Potion!")));Ue.puzzle=Ue.puzzle||{},Ue.puzzle[je.profileName]={result:"success",score:je.score,hintsUsed:je.hintsUsed,wrongGuesses:je.wrongGuesses,timeRemaining:je.timeRemaining,timestamp:Date.now()},kn()}()):(t.classList.add("wrong"),setTimeout((()=>t.classList.remove("wrong")),300),je.wrongGuesses++,je.score-=a.wrongGuessPenalty||10,document.getElementById("puzzle_mistakes").textContent="".concat(je.wrongGuesses,"/").concat(je.wrongGuessesAllowed),Cn("Wrong! Mistakes: ".concat(je.wrongGuesses,"/").concat(je.wrongGuessesAllowed)),a.onWrongMove&&O(a.onWrongMove),je.wrongGuesses>=je.wrongGuessesAllowed&&wn())}function _n(){if(je.isComplete||je.hintsRemaining<=0)return;je.hintsRemaining--,je.hintsUsed++,je.score-=je.profile.hintPenalty||10,document.getElementById("puzzle_hints").textContent=je.hintsRemaining;const e=je.sequence[je.currentStep],t=je.grid[e];if(t.classList.add("hint"),setTimeout((()=>t.classList.remove("hint")),1e3),Cn("Hint used! ".concat(je.hintsRemaining," remaining.")),je.profile.onHint&&O(je.profile.onHint),je.hintsRemaining<=0){const e=document.getElementById("puzzle_hint_btn");e&&(e.disabled=!0)}}async function wn(){je.isComplete=!0,je.isFailed=!0,je.timerInterval&&clearInterval(je.timerInterval),Cn("Puzzle failed!");const e=je.profile;e.onFail&&await O(e.onFail),Ue.puzzle=Ue.puzzle||{},Ue.puzzle[je.profileName]={result:"fail",score:je.score,hintsUsed:je.hintsUsed,wrongGuesses:je.wrongGuesses,timestamp:Date.now()},kn()}function kn(){const e=document.getElementById("puzzle_actions"),t=document.getElementById("puzzle_result_panel"),n=document.getElementById("puzzle_result_text"),a=document.getElementById("puzzle_instruction");e&&(e.style.display="none"),a&&(a.style.display="none"),t&&(t.style.display="block"),je.grid.forEach((e=>e.classList.add("disabled"))),n&&(je.isSuccess?(n.textContent=je.profile.successMessage||"Puzzle Solved!",n.className="puzzle-result-text success"):(n.textContent=je.profile.failMessage||"Puzzle Failed!",n.className="puzzle-result-text fail"))}function Cn(e){je.combatLog.push(e),je.combatLog.length>20&&je.combatLog.shift();const t=document.getElementById("puzzle_combat_log");t&&(t.innerHTML=je.combatLog.map((e=>{let t="puzzle-log-entry";return(e.includes("correct")||e.includes("solved")||e.includes("found"))&&(t+=" puzzle-log-success"),(e.includes("Wrong")||e.includes("failed")||e.includes("Time"))&&(t+=" puzzle-log-fail"),e.includes("Hint")&&(t+=" puzzle-log-warning"),(e.includes("turn")||e.includes("shown"))&&(t+=" puzzle-log-info"),'<div class="'.concat(t,'">').concat(e,"</div>")})).join(""),t.scrollTop=t.scrollHeight)}async function Sn(){je.timerInterval&&clearInterval(je.timerInterval);const e=document.getElementById("mazemaster_puzzle_modal");e&&e.remove();const t=je.isSuccess;if(je.isOpen=!1,Ge.isOpen){try{if(Ge.pendingEncounter){const e=Ge.pendingEncounter.type;if(t){var n;if(await ba(Ge.playerX,Ge.playerY),Ge.hp&&!1!==(null===(n=Ge.profile)||void 0===n?void 0:n.hpEnabled)){const e=Ge.profile.skillEncounterHealPercent||25,t=Ge.hp.max+(Ge.hp.maxBonus||0),n=Math.floor(t*(e/100));Ge.hp.current<t&&n>0&&(await j(n,!1,"Puzzle success"),addMazeLogMessage("Brilliant mind! Recovered ".concat(n," HP."),"heal"))}if("exit_puzzle"===e)return Ge.exitEncounterDone=!0,Ge.isPaused=!1,void yo()}}}catch(e){console.error("[MazeMaster] Error in closePuzzleModal:",e)}Ge.isPaused=!1,Ge.pendingEncounter=null}}function Mn(e){console.log("[MazeMaster] startNegotiation called with profile:",e);const t=zt(e);return console.log("[MazeMaster] Retrieved negotiation profile:",t),t?(console.log("[MazeMaster] Initializing negotiation state with config:",{startingFavor:t.startingFavor,favorThreshold:t.favorThreshold,turnsAllowed:t.turnsAllowed}),We={isOpen:!0,profile:t,profileName:e,favor:t.startingFavor||50,favorThreshold:t.favorThreshold||75,turnsRemaining:t.turnsAllowed||5,turnsUsed:0,lastAction:"",lastResult:"",isSuccess:!1,isFailed:!1,isComplete:!1,combatLog:["The negotiation begins..."]},console.log("[MazeMaster] currentNegotiation initialized:",We),Ge.isOpen&&(Ge.isPaused=!0,console.log("[MazeMaster] Maze paused for negotiation")),console.log("[MazeMaster] Calling showNegotiationModal..."),function(){var e,t,n,a,o,i;console.log("[MazeMaster] showNegotiationModal called");const s=document.getElementById("mazemaster_negotiation_modal");s&&(console.log("[MazeMaster] Removing existing negotiation modal"),s.remove());if(!document.getElementById("mazemaster_negotiation_styles")){console.log("[MazeMaster] Adding negotiation styles to document");const e=document.createElement("style");e.id="mazemaster_negotiation_styles",e.textContent="\n        .mazemaster-negotiate-container {\n            background: linear-gradient(135deg, #2c1810 0%, #1a0f0a 50%, #0f0705 100%);\n            border: 2px solid #8b4513;\n            border-radius: 15px;\n            padding: 25px;\n            min-width: 450px;\n            max-width: 550px;\n            box-shadow: 0 0 40px rgba(139, 69, 19, 0.4);\n            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\n            color: #e0e0e0;\n        }\n\n        .negotiate-main-title {\n            text-align: center;\n            font-size: 1.8em;\n            font-weight: bold;\n            color: #daa520;\n            text-shadow: 0 0 10px rgba(218, 165, 32, 0.5);\n            margin-bottom: 8px;\n        }\n\n        .negotiate-description {\n            text-align: center;\n            font-size: 0.95em;\n            color: #bbb;\n            margin-bottom: 15px;\n            font-style: italic;\n        }\n\n        .negotiate-npc-area {\n            text-align: center;\n            padding: 15px;\n            background: rgba(0,0,0,0.4);\n            border-radius: 10px;\n            margin-bottom: 15px;\n            border: 1px solid #8b4513;\n        }\n\n        .negotiate-npc-name {\n            font-size: 1.3em;\n            font-weight: bold;\n            color: #daa520;\n            margin-bottom: 5px;\n        }\n\n        .negotiate-disposition {\n            font-size: 1em;\n            padding: 5px 15px;\n            border-radius: 15px;\n            display: inline-block;\n        }\n\n        .negotiate-disposition.hostile { background: #e74c3c; color: white; }\n        .negotiate-disposition.unfriendly { background: #e67e22; color: white; }\n        .negotiate-disposition.neutral { background: #7f8c8d; color: white; }\n        .negotiate-disposition.friendly { background: #27ae60; color: white; }\n        .negotiate-disposition.enthusiastic { background: #2ecc71; color: white; }\n\n        .negotiate-stats-row {\n            display: flex;\n            justify-content: space-around;\n            align-items: center;\n            margin-bottom: 15px;\n            padding: 10px;\n            background: rgba(0,0,0,0.3);\n            border-radius: 8px;\n        }\n\n        .negotiate-stat {\n            text-align: center;\n            display: flex;\n            align-items: center;\n            gap: 8px;\n        }\n\n        .negotiate-stat-label {\n            color: #888;\n            font-size: 0.9em;\n        }\n\n        .negotiate-favor-bar-container {\n            width: 150px;\n            height: 20px;\n            background: #333;\n            border-radius: 10px;\n            overflow: hidden;\n            border: 1px solid #555;\n        }\n\n        .negotiate-favor-bar {\n            height: 100%;\n            background: linear-gradient(90deg, #e74c3c 0%, #f39c12 50%, #27ae60 100%);\n            transition: width 0.3s ease;\n            width: 50%;\n        }\n\n        .negotiate-actions {\n            display: grid;\n            grid-template-columns: repeat(2, 1fr);\n            gap: 10px;\n            margin-bottom: 15px;\n        }\n\n        .negotiate-btn {\n            padding: 12px 20px;\n            border: none;\n            border-radius: 8px;\n            cursor: pointer;\n            font-size: 1em;\n            font-weight: bold;\n            transition: all 0.2s ease;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            gap: 8px;\n        }\n\n        .negotiate-persuade-btn {\n            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);\n            color: white;\n        }\n\n        .negotiate-intimidate-btn {\n            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);\n            color: white;\n        }\n\n        .negotiate-flatter-btn {\n            background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%);\n            color: white;\n        }\n\n        .negotiate-bribe-btn {\n            background: linear-gradient(135deg, #f39c12 0%, #d68910 100%);\n            color: white;\n        }\n\n        .negotiate-insult-btn {\n            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);\n            color: white;\n            grid-column: span 2;\n        }\n\n        .negotiate-btn:hover:not(:disabled) {\n            transform: scale(1.03);\n            box-shadow: 0 0 15px rgba(255,255,255,0.2);\n        }\n\n        .negotiate-btn:disabled {\n            opacity: 0.5;\n            cursor: not-allowed;\n        }\n\n        .negotiate-close-btn {\n            background: linear-gradient(135deg, #27ae60 0%, #1e8449 100%);\n            color: white;\n            padding: 15px 40px;\n            font-size: 1.1em;\n            width: 100%;\n        }\n\n        .negotiate-result-panel {\n            text-align: center;\n            padding: 20px;\n        }\n\n        .negotiate-result-text {\n            font-size: 1.6em;\n            font-weight: bold;\n            margin-bottom: 20px;\n        }\n\n        .negotiate-result-text.success { color: #2ecc71; }\n        .negotiate-result-text.fail { color: #e74c3c; }\n\n        .negotiate-combat-log {\n            max-height: 120px;\n            overflow-y: auto;\n            background: rgba(0,0,0,0.3);\n            border-radius: 8px;\n            padding: 10px;\n            font-size: 0.9em;\n        }\n\n        .negotiate-log-entry {\n            padding: 3px 0;\n            border-bottom: 1px solid rgba(255,255,255,0.1);\n        }\n\n        .negotiate-log-entry:last-child { border-bottom: none; }\n        .negotiate-log-success { color: #2ecc71; }\n        .negotiate-log-fail { color: #e74c3c; }\n        .negotiate-log-warning { color: #f39c12; }\n        .negotiate-log-info { color: #3498db; }\n        .negotiate-log-action { color: #daa520; }\n    ",document.head.appendChild(e)}console.log("[MazeMaster] Inserting negotiation modal HTML"),document.body.insertAdjacentHTML("beforeend",'\n        <div id="mazemaster_negotiation_modal" style="position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:999999;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.9);">\n            <div class="mazemaster-negotiate-container">\n                <div id="negotiate_main_title" class="negotiate-main-title">Negotiation</div>\n                <div id="negotiate_description" class="negotiate-description"></div>\n\n                <div class="negotiate-npc-area">\n                    <div class="negotiate-npc-name" id="negotiate_npc_name">NPC</div>\n                    <div class="negotiate-disposition" id="negotiate_disposition">Neutral</div>\n                </div>\n\n                <div class="negotiate-stats-row">\n                    <div class="negotiate-stat">\n                        <span class="negotiate-stat-label">Favor:</span>\n                        <div class="negotiate-favor-bar-container">\n                            <div class="negotiate-favor-bar" id="negotiate_favor_bar"></div>\n                        </div>\n                        <span id="negotiate_favor_value">50</span>/<span id="negotiate_favor_max">75</span>\n                    </div>\n                    <div class="negotiate-stat">\n                        <span class="negotiate-stat-label">Turns:</span>\n                        <span id="negotiate_turns">0/0</span>\n                    </div>\n                </div>\n\n                <div id="negotiate_actions" class="negotiate-actions">\n                    <button id="negotiate_persuade_btn" class="negotiate-btn negotiate-persuade-btn">\n                        <i class="fa-solid fa-comment"></i> Persuade\n                    </button>\n                    <button id="negotiate_intimidate_btn" class="negotiate-btn negotiate-intimidate-btn">\n                        <i class="fa-solid fa-hand-fist"></i> Intimidate\n                    </button>\n                    <button id="negotiate_flatter_btn" class="negotiate-btn negotiate-flatter-btn">\n                        <i class="fa-solid fa-heart"></i> Flatter\n                    </button>\n                    <button id="negotiate_bribe_btn" class="negotiate-btn negotiate-bribe-btn">\n                        <i class="fa-solid fa-coins"></i> Bribe\n                    </button>\n                    <button id="negotiate_insult_btn" class="negotiate-btn negotiate-insult-btn" style="display:none;">\n                        <i class="fa-solid fa-face-angry"></i> Insult\n                    </button>\n                </div>\n\n                <div id="negotiate_result_panel" class="negotiate-result-panel" style="display:none;">\n                    <div id="negotiate_result_text" class="negotiate-result-text"></div>\n                    <button id="negotiate_close_btn" class="negotiate-btn negotiate-close-btn">\n                        <i class="fa-solid fa-check"></i> Continue\n                    </button>\n                </div>\n\n                <div id="negotiate_combat_log" class="negotiate-combat-log"></div>\n            </div>\n        </div>\n    ');const r=document.getElementById("mazemaster_negotiation_modal");console.log("[MazeMaster] Negotiation modal element after insert:",r);const l=We.profile;console.log("[MazeMaster] Updating negotiation UI with profile:",null==l?void 0:l.name);const c=document.getElementById("negotiate_main_title"),d=document.getElementById("negotiate_description");console.log("[MazeMaster] Negotiation UI elements - title:",c,"desc:",d),c&&(c.textContent=l.mainTitle||"Negotiation");d&&(d.textContent=l.description||"");document.getElementById("negotiate_npc_name").textContent=l.npcName||"NPC",document.getElementById("negotiate_favor_max").textContent=We.favorThreshold,document.getElementById("negotiate_turns").textContent="".concat(We.turnsUsed,"/").concat(l.turnsAllowed),l.flattery||(document.getElementById("negotiate_flatter_btn").style.display="none");l.insult&&(document.getElementById("negotiate_insult_btn").style.display="flex");console.log("[MazeMaster] Attaching negotiation event handlers"),null===(e=document.getElementById("negotiate_persuade_btn"))||void 0===e||e.addEventListener("click",(()=>In("persuade"))),null===(t=document.getElementById("negotiate_intimidate_btn"))||void 0===t||t.addEventListener("click",(()=>In("intimidate"))),null===(n=document.getElementById("negotiate_flatter_btn"))||void 0===n||n.addEventListener("click",(()=>In("flatter"))),null===(a=document.getElementById("negotiate_bribe_btn"))||void 0===a||a.addEventListener("click",(()=>In("bribe"))),null===(o=document.getElementById("negotiate_insult_btn"))||void 0===o||o.addEventListener("click",(()=>In("insult"))),null===(i=document.getElementById("negotiate_close_btn"))||void 0===i||i.addEventListener("click",Dn),console.log("[MazeMaster] Calling updateNegotiationDisplay"),En(),console.log("[MazeMaster] showNegotiationModal complete")}(),t.onStart&&O(t.onStart),console.log("[MazeMaster] Negotiation started: ".concat(e)),{success:!0}):(console.error('[MazeMaster] Negotiation profile "'.concat(e,'" not found')),{error:'Profile "'.concat(e,'" not found')})}function En(){const e=document.getElementById("negotiate_favor_bar"),t=document.getElementById("negotiate_favor_value"),n=We.favor/100*100;e&&(e.style.width="".concat(Math.min(n,100),"%")),t&&(t.textContent=Math.round(We.favor));const a=document.getElementById("negotiate_disposition");a&&(a.classList.remove("hostile","unfriendly","neutral","friendly","enthusiastic"),We.favor>=80?(a.textContent="Enthusiastic",a.classList.add("enthusiastic")):We.favor>=60?(a.textContent="Friendly",a.classList.add("friendly")):We.favor>=40?(a.textContent="Neutral",a.classList.add("neutral")):We.favor>=20?(a.textContent="Unfriendly",a.classList.add("unfriendly")):(a.textContent="Hostile",a.classList.add("hostile")));const o=document.getElementById("negotiate_turns");o&&(o.textContent="".concat(We.turnsUsed,"/").concat(We.profile.turnsAllowed));const i=document.getElementById("negotiate_combat_log");i&&(i.innerHTML=We.combatLog.map((e=>{let t="negotiate-log-entry";return(e.includes("success")||e.includes("agrees")||e.includes("impressed"))&&(t+=" negotiate-log-success"),(e.includes("fail")||e.includes("refuses")||e.includes("angry"))&&(t+=" negotiate-log-fail"),(e.includes("suspicious")||e.includes("wary"))&&(t+=" negotiate-log-warning"),e.includes("You ")&&(t+=" negotiate-log-action"),'<div class="'.concat(t,'">').concat(e,"</div>")})).join(""),i.scrollTop=i.scrollHeight)}function Pn(e){We.combatLog.push(e),We.combatLog.length>30&&We.combatLog.shift(),En()}async function In(e){var t;if(We.isComplete)return;const n=We.profile;We.turnsUsed++,We.turnsRemaining--,We.lastAction=e;let a=0,o=!1;const i=100*Math.random();switch(e){case"persuade":o=i<n.persuadeBonus+.3*We.favor,o?(a=10+Math.floor(10*Math.random()),Pn("You make a compelling argument. (+".concat(a," favor)"))):(a=-5,Pn("Your words fall flat. (".concat(a," favor)"))),n.onPersuade&&await O(n.onPersuade);break;case"intimidate":o=i<n.intimidateBonus+.2*(100-We.favor),o?(a=15+Math.floor(10*Math.random()),Pn("They seem... persuaded by your forcefulness. (+".concat(a," favor)"))):(a=-15,Pn("They don't take kindly to threats. (".concat(a," favor)"))),n.onIntimidate&&await O(n.onIntimidate);break;case"flatter":o=i<n.flatterBonus+.4*We.favor,o?(a=8+Math.floor(8*Math.random()),Pn("They're flattered by your words. (+".concat(a," favor)"))):(a=-3,Pn("They see through your flattery. (".concat(a," favor)"))),n.onFlatter&&await O(n.onFlatter);break;case"bribe":const e=n.bribeCost||"key";if(!(!Ge.isOpen||((null===(t=Ge.inventory)||void 0===t?void 0:t[e])||0)>0))return Pn("You don't have anything to offer..."),We.turnsUsed--,We.turnsRemaining++,void En();Ge.isOpen&&Ge.inventory&&Ge.inventory[e]--,o=i<n.bribeBonus,o?(a=20+Math.floor(15*Math.random()),Pn("The bribe is accepted with a knowing smile. (+".concat(a," favor)"))):(a=-10,Pn("They pocket the bribe but remain unmoved. (".concat(a," favor)"))),n.onBribe&&await O(n.onBribe);break;case"insult":o=i<25,o?(a=25+Math.floor(15*Math.random()),Pn("Surprisingly, your insult earns their respect! (+".concat(a," favor)"))):(a=-(n.insultPenalty||20),Pn("They're deeply offended! (".concat(a," favor)"))),n.onInsult&&await O(n.onInsult)}if(We.favor=Math.max(0,Math.min(100,We.favor+a)),We.lastResult=o?"success":"fail",En(),!(We.favor>=We.favorThreshold))return We.turnsRemaining<=0?(Pn("You've run out of time..."),void Tn()):We.favor<=0?(Pn("They refuse to speak with you any further!"),void Tn()):void 0;!async function(){We.isComplete=!0,We.isSuccess=!0,Pn("Negotiation successful!");const e=We.profile;e.onComplete&&await O(e.onComplete);Ge.isOpen&&Ge.pendingEncounter&&(100*Math.random()<(e.keyDropChance||20)&&(Va("key"),Pn("You received a Key!")),100*Math.random()<(e.stealthDropChance||15)&&(Va("stealth"),Pn("You received a Stealth item!")),100*Math.random()<(e.healingPotionDropChance||15)&&(Va("healingPotion"),Pn("You received a Healing Potion!")));Ue.negotiation=Ue.negotiation||{},Ue.negotiation[We.profileName]={result:"success",finalFavor:We.favor,turnsUsed:We.turnsUsed,timestamp:Date.now()},Bn()}()}async function Tn(){We.isComplete=!0,We.isFailed=!0,Pn("Negotiation failed!");const e=We.profile;e.onFail&&await O(e.onFail);let t=!1;if(Ge.isOpen&&Ge.hpEnabled&&Ge.hp){var n,a;const o=e.damage||25,i=null!==(n=null===(a=Ge.profile)||void 0===a?void 0:a.battlebarDamageMultiplier)&&void 0!==n?n:1,s=Math.round(o*i);t=!await F(s,"negotiation")}Ue.negotiation=Ue.negotiation||{},Ue.negotiation[We.profileName]={result:"fail",finalFavor:We.favor,turnsUsed:We.turnsUsed,timestamp:Date.now()},t?Dn():Bn()}function Bn(){const e=document.getElementById("negotiate_actions"),t=document.getElementById("negotiate_result_panel"),n=document.getElementById("negotiate_result_text");e&&(e.style.display="none"),t&&(t.style.display="block"),n&&(We.isSuccess?(n.textContent=We.profile.successMessage||"Negotiation Successful!",n.className="negotiate-result-text success"):(n.textContent=We.profile.failMessage||"Negotiation Failed!",n.className="negotiate-result-text fail"))}async function Dn(){const e=document.getElementById("mazemaster_negotiation_modal");e&&e.remove();const t=We.isSuccess;if(We.isOpen=!1,Ge.isOpen){try{if(Ge.pendingEncounter){const e=Ge.pendingEncounter.type;if(t){var n;if(await ba(Ge.playerX,Ge.playerY),Ge.hp&&!1!==(null===(n=Ge.profile)||void 0===n?void 0:n.hpEnabled)){const e=Ge.profile.skillEncounterHealPercent||25,t=Ge.hp.max+(Ge.hp.maxBonus||0),n=Math.floor(t*(e/100));Ge.hp.current<t&&n>0&&(await j(n,!1,"Negotiation success"),addMazeLogMessage("Smooth talker! Recovered ".concat(n," HP."),"heal"))}if("exit_negotiation"===e)return Ge.exitEncounterDone=!0,Ge.isPaused=!1,void yo()}}}catch(e){console.error("[MazeMaster] Error in closeNegotiationModal:",e)}Ge.isPaused=!1,Ge.pendingEncounter=null}}let Ln={isOpen:!1,minionId:null,minion:null,offeredItems:[],selectedItem:null};function Rn(e,n){const a=function(e){var t;return(null===(t=Re.merchantItemPools)||void 0===t?void 0:t[e])||Te[e]||Te["Common Goods"]}(e);if(!a||!a.items||0===a.items.length)return[{id:"key",name:"Key",description:"Opens locked doors",icon:""}];const o=a.items,i=o.reduce(((e,t)=>e+(t.weight||10)),0),s=[],r=new Set;for(;s.length<n&&s.length<o.length;){let e=Math.random()*i;for(const n of o)if(!r.has(n.id)&&(e-=n.weight||10,e<=0)){s.push(t({},n)),r.add(n.id);break}if(s.length<n&&!r.has(o[s.length%o.length].id)){const e=o.find((e=>!r.has(e.id)));e&&(s.push(t({},e)),r.add(e.id))}}return s}function An(){if(!Ln.selectedItem)return;const e=Ln.selectedItem;Va(e.id),Ge.currentMinion&&(Ge.currentMinion.message="Enjoy your ".concat(e.name,"! A pleasure doing business!"),Na()),Hn(!0)}function On(){Ge.currentMinion&&(Ge.currentMinion.message="Perhaps another time, then...",Na()),Hn(!1)}function Hn(e){const t=document.getElementById("mazemaster_merchant_modal");t&&t.remove(),Ln.isOpen=!1,Ge.pendingConfirmation&&(Ge.pendingConfirmation=null);const n=document.getElementById("maze_encounter_confirm");var a;n?(n.innerHTML='<button id="maze_confirm_ok" class="menu_button maze-confirm-btn">OK</button>',n.style.display="flex",null===(a=document.getElementById("maze_confirm_ok"))||void 0===a||a.addEventListener("click",(()=>{mo(),Ua()}))):Ua()}function Nn(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;const n=nt(e);if(!n)return{error:'Battlebar profile "'.concat(e,'" not found')};const a=null===(o=Ge)||void 0===o||!o.inventory.timeShard||Ge.inventory.timeShard<=0?1:.5;var o;const i=a<1;return Oe={isOpen:!0,profile:n,hits:0,misses:0,arrowPosition:0,arrowDirection:1,zoneStart:0,zoneEnd:0,animationId:null,lastFrameTime:0,isVictory:!1,isDefeat:!1,speedMultiplier:a,enemyNameOverride:t},Vn(),function(){const e=document.getElementById("mazemaster_battlebar_modal");e&&e.remove();if(!document.getElementById("mazemaster_battlebar_styles")){const e=document.createElement("style");e.id="mazemaster_battlebar_styles",e.textContent="\n        .mazemaster-bb-overlay {\n            position: fixed;\n            top: 0;\n            left: 0;\n            right: 0;\n            bottom: 0;\n            background: rgba(0, 0, 0, 0.9);\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            z-index: 10010;\n        }\n\n        .mazemaster-bb-container {\n            display: flex;\n            flex-direction: column;\n            align-items: center;\n            gap: 15px;\n            padding: 25px;\n            background: #1a1a2e;\n            border-radius: 15px;\n            border: 2px solid #333;\n            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);\n            width: 450px;\n            max-width: 95vw;\n            overflow-y: auto;\n        }\n\n        .mazemaster-bb-main-title {\n            font-size: 32px;\n            font-weight: bold;\n            color: #fff;\n            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);\n            text-align: center;\n        }\n\n        .mazemaster-bb-stage-title {\n            font-size: 18px;\n            color: #aaa;\n            text-align: center;\n            min-height: 24px;\n            max-width: 100%;\n            word-wrap: break-word;\n            overflow-wrap: break-word;\n        }\n\n        .mazemaster-bb-image-display {\n            width: min(300px, 80vw);\n            height: min(300px, 40vh);\n            border: 3px solid #444;\n            border-radius: 10px;\n            overflow: hidden;\n            background: #222;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n        }\n\n        .mazemaster-bb-image-display img {\n            max-width: 100%;\n            max-height: 100%;\n            object-fit: contain;\n        }\n\n        .mazemaster-bb-stats {\n            display: flex;\n            gap: 30px;\n            font-size: 1.2em;\n            font-weight: bold;\n        }\n\n        .bb-stat-hits {\n            color: #27ae60;\n        }\n\n        .bb-stat-misses {\n            color: #e74c3c;\n        }\n\n        .mazemaster-bb-bar-container {\n            padding: 10px;\n        }\n\n        .mazemaster-bb-bar {\n            position: relative;\n            width: min(400px, 90vw);\n            height: 50px;\n            background: linear-gradient(to bottom, #c0392b, #a93226);\n            border-radius: 8px;\n            overflow: hidden;\n            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5), inset 0 2px 5px rgba(0, 0, 0, 0.3);\n        }\n\n        .mazemaster-bb-zone {\n            position: absolute;\n            height: 100%;\n            background: linear-gradient(to bottom, #27ae60, #1e8449);\n            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.2);\n        }\n\n        .mazemaster-bb-arrow {\n            position: absolute;\n            width: 6px;\n            height: 100%;\n            background: #fff;\n            box-shadow: 0 0 15px #fff, 0 0 30px rgba(255, 255, 255, 0.5);\n            left: 0;\n            transition: none;\n        }\n\n        .mazemaster-bb-instructions {\n            font-size: 1.1em;\n            color: #aaa;\n        }\n\n        .mazemaster-bb-instructions kbd {\n            background: #444;\n            padding: 5px 15px;\n            border-radius: 5px;\n            font-weight: bold;\n            color: #fff;\n            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);\n        }\n\n        .mazemaster-bb-bar.flash-hit {\n            animation: flashHit 0.3s ease;\n        }\n\n        .mazemaster-bb-bar.flash-miss {\n            animation: flashMiss 0.3s ease;\n        }\n\n        @keyframes flashHit {\n            0%, 100% { box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5); }\n            50% { box-shadow: 0 0 30px rgba(39, 174, 96, 0.8), 0 0 60px rgba(39, 174, 96, 0.5); }\n        }\n\n        @keyframes flashMiss {\n            0%, 100% { box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5); }\n            50% { box-shadow: 0 0 30px rgba(231, 76, 60, 0.8), 0 0 60px rgba(231, 76, 60, 0.5); }\n        }\n\n        .mazemaster-bb-hit-btn {\n            width: min(100%, 90vw);\n            max-width: 400px;\n            padding: 20px 30px;\n            font-size: 24px;\n            font-weight: bold;\n            background: linear-gradient(135deg, #27ae60, #2ecc71);\n            color: white;\n            border: none;\n            border-radius: 12px;\n            cursor: pointer;\n            margin-top: 10px;\n            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);\n            transition: transform 0.1s ease, box-shadow 0.1s ease;\n            touch-action: manipulation;\n            -webkit-tap-highlight-color: transparent;\n        }\n\n        .mazemaster-bb-hit-btn:hover {\n            transform: scale(1.02);\n            box-shadow: 0 8px 25px rgba(39, 174, 96, 0.5);\n        }\n\n        .mazemaster-bb-hit-btn:active {\n            transform: scale(0.98);\n            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);\n        }\n\n        .mazemaster-bb-hit-btn i {\n            margin-right: 10px;\n        }\n\n        .mazemaster-bb-hit-btn.victory {\n            background: linear-gradient(135deg, #f39c12, #e67e22);\n            box-shadow: 0 6px 20px rgba(243, 156, 18, 0.4);\n        }\n\n        .mazemaster-bb-hit-btn.victory:hover {\n            box-shadow: 0 8px 25px rgba(243, 156, 18, 0.5);\n        }\n\n        .mazemaster-bb-hit-btn.defeat {\n            background: linear-gradient(135deg, #c0392b, #e74c3c);\n            box-shadow: 0 6px 20px rgba(192, 57, 43, 0.4);\n        }\n\n        .mazemaster-bb-hit-btn.defeat:hover {\n            box-shadow: 0 8px 25px rgba(192, 57, 43, 0.5);\n        }\n    ",document.head.appendChild(e)}const t=document.createElement("div");t.innerHTML='\n        <div id="mazemaster_battlebar_modal" style="position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:999999;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.9);">\n            <div class="mazemaster-bb-container">\n                <div id="bb_main_title" class="mazemaster-bb-main-title"></div>\n                <div class="mazemaster-bb-image-display">\n                    <img id="mazemaster_bb_img" src="" alt="">\n                </div>\n                <div id="bb_stage_title" class="mazemaster-bb-stage-title"></div>\n                <div class="mazemaster-bb-stats">\n                    <span class="bb-stat bb-stat-hits">\n                        Hits: <span id="bb_current_hits">0</span>/<span id="bb_needed_hits">5</span>\n                    </span>\n                    <span class="bb-stat bb-stat-misses">\n                        Misses: <span id="bb_current_misses">0</span>/<span id="bb_max_misses">3</span>\n                    </span>\n                </div>\n                <div class="mazemaster-bb-bar-container">\n                    <div class="mazemaster-bb-bar">\n                        <div class="mazemaster-bb-zone" id="bb_zone"></div>\n                        <div class="mazemaster-bb-arrow" id="bb_arrow"></div>\n                    </div>\n                </div>\n                <div class="mazemaster-bb-instructions">\n                    Press <kbd>SPACE</kbd> when the arrow is in the green zone!\n                </div>\n                <div class="mazemaster-bb-action-buttons">\n                    <button id="mazemaster_bb_hit_btn" class="mazemaster-bb-hit-btn">\n                        <i class="fa-solid fa-bullseye"></i> HIT!\n                    </button>\n                    <button id="mazemaster_bb_strike_btn" class="mazemaster-bb-strike-btn" style="display: none;">\n                        <i class="fa-solid fa-bolt"></i> STRIKE! (<span id="bb_strike_count">0</span>)\n                    </button>\n                    <button id="mazemaster_bb_execute_btn" class="mazemaster-bb-execute-btn" style="display: none;">\n                        <i class="fa-solid fa-star"></i> GRANDSTRIKE! (<span id="bb_execute_count">0</span>)\n                    </button>\n                </div>\n            </div>\n        </div>\n    ',document.body.appendChild(t.firstElementChild),Jn(),Xn(),Qn(),qn();const n=document.getElementById("mazemaster_bb_hit_btn");n&&(n.addEventListener("click",Fn),n.addEventListener("touchend",(e=>{e.preventDefault(),Fn(e)})));const a=document.getElementById("mazemaster_bb_strike_btn");a&&a.addEventListener("click",Wn);const o=document.getElementById("mazemaster_bb_execute_btn");o&&o.addEventListener("click",Un);jn(),Gn()}(),function(){var e,t;const n=Oe.effectiveDifficulty||x(Oe.profile.difficulty||5,Ge.isOpen&&null!==(e=null===(t=Ge.profile)||void 0===t?void 0:t.battlebarDifficultyMultiplier)&&void 0!==e?e:1),a=100/n.traverseTime*(Oe.speedMultiplier||1);function o(e){if(!Oe.isOpen)return;0===Oe.lastFrameTime&&(Oe.lastFrameTime=e);const t=e-Oe.lastFrameTime;Oe.lastFrameTime=e,Oe.arrowPosition+=a*t*Oe.arrowDirection,Oe.arrowPosition>=100?(Oe.arrowPosition=100,Oe.arrowDirection=-1):Oe.arrowPosition<=0&&(Oe.arrowPosition=0,Oe.arrowDirection=1),function(){const e=document.getElementById("bb_arrow");e&&(e.style.left="".concat(Oe.arrowPosition,"%"))}(),Oe.animationId=requestAnimationFrame(o)}Oe.lastFrameTime=0,Oe.animationId=requestAnimationFrame(o)}(),document.addEventListener("keydown",Zn),i&&async function(){var e;(null===(e=Ge)||void 0===e?void 0:e.inventory.timeShard)>0&&(await Xa("timeShard",1),Ge.currentMinion={name:"Time Shard",imagePath:"",message:"Time slows around you... The battlebar moves at half speed!"},Na())}(),{success:!0}}function qn(){const e=Oe.profile||{},t=document.getElementById("bb_main_title");t&&(t.textContent=Oe.enemyNameOverride||e.mainTitle||"");const n=document.getElementById("bb_stage_title");if(n){const t=(e.images||[])[Oe.hits||0];n.textContent=(null==t?void 0:t.stageMessage)||""}}function Fn(e){if(e.preventDefault(),!Oe.isOpen)return;if(Oe.isVictory||Oe.isDefeat)return void Kn();const t=Oe.arrowPosition>=Oe.zoneStart&&Oe.arrowPosition<=Oe.zoneEnd;console.log("[MazeMaster] Hit check:",{arrowPosition:Oe.arrowPosition,zoneStart:Oe.zoneStart,zoneEnd:Oe.zoneEnd,inZone:t}),t?$n():ea()}function jn(){const e=document.getElementById("mazemaster_bb_strike_btn"),t=document.getElementById("bb_strike_count");e&&Ge.isOpen&&Ge.inventory.strike>0?(e.style.display="",t&&(t.textContent=Ge.inventory.strike)):e&&(e.style.display="none")}function Wn(e){e.preventDefault(),!Ge.isOpen||Ge.inventory.strike<=0||Oe.isOpen&&(Oe.isVictory||Oe.isDefeat||(Xa("strike"),jn(),Oe.hits++,updateBattlebarDisplay(),Oe.hits>=Oe.profile.hitsToWin&&ta()))}function Yn(){return Ge.pendingEncounter&&"exit_battlebar"===Ge.pendingEncounter.type}function Gn(){const e=document.getElementById("mazemaster_bb_execute_btn"),t=document.getElementById("bb_execute_count");e&&Ge.isOpen&&Ge.inventory.execute>0&&!Yn()?(e.style.display="",t&&(t.textContent=Ge.inventory.execute)):e&&(e.style.display="none")}function Un(e){e.preventDefault(),!Ge.isOpen||Ge.inventory.execute<=0||Oe.isOpen&&(Oe.isVictory||Oe.isDefeat||(Yn()?console.log("[MazeMaster] EXECUTE cannot be used against the main minion!"):(Xa("execute"),Gn(),Oe.hits=Oe.profile.hitsToWin,updateBattlebarDisplay(),ta())))}async function Kn(){const e=Oe.isVictory,t=Oe.isDefeat;Oe.animationId&&cancelAnimationFrame(Oe.animationId),document.removeEventListener("keydown",Zn);const n=document.getElementById("mazemaster_battlebar_modal");if(n&&n.remove(),Oe.isOpen=!1,Oe.isVictory=!1,Oe.isDefeat=!1,Ge.isOpen){try{if(Ge.pendingEncounter){const n=Ge.pendingEncounter.type;if(e)return await ba(Ge.playerX,Ge.playerY),"exit_battlebar"===n?(Ge.exitEncounterDone=!0,Ge.isPaused=!1,void yo()):void Ua();if(t){const e=Ge.profile.onBattlebarLoss||"continue";if("exit_battlebar"===n)return"gameover"===e?void vo():void bo();switch(e){case"gameover":return void vo();case"respawn":return void bo();default:return void Ua()}}}}catch(e){console.error("[MazeMaster] Error in closeBattlebarModal:",e)}Ge.isPaused=!1,Ge.pendingEncounter=null}}function Vn(){var e,t;let n=Oe.profile.difficulty||5;n<=5&&_[n]&&(n=_[n]);const a=Ge.isOpen&&null!==(e=null===(t=Ge.profile)||void 0===t?void 0:t.battlebarDifficultyMultiplier)&&void 0!==e?e:1,o=x(n,a),i=100*o.zoneWidth,s=100-i;Oe.zoneStart=Math.random()*s,Oe.zoneEnd=Oe.zoneStart+i,Oe.effectiveDifficulty=o,console.log("[MazeMaster] Zone randomized:",{baseDifficulty:n,mazeMultiplier:a,zoneWidth:i.toFixed(1)+"%",traverseTime:o.traverseTime+"ms",zoneStart:Oe.zoneStart.toFixed(1),zoneEnd:Oe.zoneEnd.toFixed(1)})}function Xn(){const e=document.getElementById("bb_zone");e&&(e.style.left="".concat(Oe.zoneStart,"%"),e.style.width="".concat(Oe.zoneEnd-Oe.zoneStart,"%"))}function Jn(){const e=document.getElementById("bb_current_hits"),t=document.getElementById("bb_needed_hits"),n=document.getElementById("bb_current_misses"),a=document.getElementById("bb_max_misses");e&&(e.textContent=Oe.hits),t&&(t.textContent=Oe.profile.hitsToWin||5),n&&(n.textContent=Oe.misses),a&&(a.textContent=Oe.profile.missesToLose||3)}function Qn(){const e=document.getElementById("mazemaster_bb_img");if(!e)return;const t=Oe.profile.images||[];if(0===t.length)return void(e.style.display="none");const n=t[Math.min(Oe.hits,t.length-1)],a=n.imagePath||n.path||"";a?(e.src=Ee(a),e.style.display="block"):e.style.display="none"}function Zn(e){if("Space"!==e.code||!Oe.isOpen)return;if(e.preventDefault(),Oe.isVictory||Oe.isDefeat)return void Kn();Oe.arrowPosition>=Oe.zoneStart&&Oe.arrowPosition<=Oe.zoneEnd?$n():ea()}async function $n(){Oe.hits++;const e=document.querySelector(".mazemaster-bb-bar");e&&(e.classList.remove("flash-hit","flash-miss"),e.offsetWidth,e.classList.add("flash-hit")),Jn(),Qn(),qn(),Oe.profile.hitCommand&&await O(Oe.profile.hitCommand),Oe.hits>=(Oe.profile.hitsToWin||5)?await ta():(Vn(),Xn())}async function ea(){Oe.misses++;const e=document.querySelector(".mazemaster-bb-bar");e&&(e.classList.remove("flash-hit","flash-miss"),e.offsetWidth,e.classList.add("flash-miss")),Jn(),Oe.profile.missCommand&&await O(Oe.profile.missCommand),Oe.misses>=(Oe.profile.missesToLose||3)&&await async function(){var e;const t=Re.currentBattlebarProfile||"default";if(Ue.battlebar[t]={result:"lose",hits:Oe.hits,misses:Oe.misses,timestamp:Date.now()},null!==(e=Ge)&&void 0!==e&&e.isOpen){var n;Aa("Battlebar defeat: ".concat((null===(n=Oe.profile)||void 0===n?void 0:n.mainTitle)||t),"Combat"),Ge.fairness&&(Ge.fairness.combatLossStreak++,console.log("[MazeMaster] Fairness: Combat loss streak: ".concat(Ge.fairness.combatLossStreak)))}Oe.isDefeat=!0,Oe.animationId&&(cancelAnimationFrame(Oe.animationId),Oe.animationId=null);const a=document.querySelector(".mazemaster-bb-bar-container"),o=document.querySelector(".mazemaster-bb-instructions");a&&(a.style.display="none");o&&(o.style.display="none");if(Ge.isOpen&&Ge.hpEnabled&&Ge.hp){var i,s;const e=Ge.profile,t=(null===(i=Oe.profile)||void 0===i?void 0:i.damage)||25,n=null!==(s=e.battlebarDamageMultiplier)&&void 0!==s?s:1,a=Math.round(t*n);if(await F(a,"battlebar")){const e=document.getElementById("bb_stage_title");e&&(e.textContent="Wounded!");const t=document.getElementById("mazemaster_bb_hit_btn");return t&&(t.innerHTML='<i class="fa-solid fa-arrow-right"></i> Continue',t.classList.add("wounded")),void(Oe.profile.loseCommand&&await O(Oe.profile.loseCommand))}return Oe.profile.loseCommand&&await O(Oe.profile.loseCommand),Oe.isDefeat=!0,void Kn()}const r=document.getElementById("bb_stage_title");r&&(r.textContent="Defeat...");const l=document.getElementById("mazemaster_bb_hit_btn");l&&(l.innerHTML='<i class="fa-solid fa-times"></i> Close',l.classList.add("defeat"));Oe.profile.loseCommand&&await O(Oe.profile.loseCommand)}()}async function ta(){var e;const t=Re.currentBattlebarProfile||"default";var n;(Ue.battlebar[t]={result:"win",hits:Oe.hits,misses:Oe.misses,timestamp:Date.now()},null!==(e=Ge)&&void 0!==e&&e.isOpen)&&(Aa("Battlebar victory: ".concat((null===(n=Oe.profile)||void 0===n?void 0:n.mainTitle)||t),"Combat"),Ge.fairness&&(Ge.fairness.combatLossStreak=0));if(Oe.isVictory=!0,Ge.isOpen&&Ge.pendingEncounter){var a,o,i,s,r,l,c,d,m,p;const e=Oe.profile;var u,h,g,f,v;if(100*Math.random()<(null!==(a=e.keyDropChance)&&void 0!==a?a:40)&&Va("key"),100*Math.random()<(null!==(o=e.strikeDropChance)&&void 0!==o?o:20)&&Va("strike"),100*Math.random()<(null!==(i=e.stealthDropChance)&&void 0!==i?i:10)&&Va("stealth"),100*Math.random()<(null!==(s=e.executeDropChance)&&void 0!==s?s:2)&&Va("execute"),100*Math.random()<(null!==(r=e.floorKeyDropChance)&&void 0!==r?r:5)&&Va("floorKey"),100*Math.random()<(null!==(l=e.portalStoneDropChance)&&void 0!==l?l:3)&&Va("portalStone"),100*Math.random()<(null!==(c=e.minionBaneDropChance)&&void 0!==c?c:4)&&Va("minionBane"),100*Math.random()<(null!==(d=e.mapFragmentDropChance)&&void 0!==d?d:8)&&Va("mapFragment"),100*Math.random()<(null!==(m=e.timeShardDropChance)&&void 0!==m?m:2)&&Va("timeShard"),100*Math.random()<(null!==(p=e.voidWalkDropChance)&&void 0!==p?p:1)&&Va("voidWalk"),Ge.hpEnabled)100*Math.random()<(null!==(u=e.healingPotionDropChance)&&void 0!==u?u:15)&&Va("healingPotion"),100*Math.random()<(null!==(h=e.greaterHealingDropChance)&&void 0!==h?h:5)&&Va("greaterHealing"),100*Math.random()<(null!==(g=e.elixirDropChance)&&void 0!==g?g:1)&&Va("elixir"),100*Math.random()<(null!==(f=e.revivalCharmDropChance)&&void 0!==f?f:.5)&&Va("revivalCharm"),100*Math.random()<(null!==(v=e.heartCrystalDropChance)&&void 0!==v?v:.3)&&Va("heartCrystal")}Oe.animationId&&(cancelAnimationFrame(Oe.animationId),Oe.animationId=null);const b=document.querySelector(".mazemaster-bb-bar-container"),y=document.querySelector(".mazemaster-bb-instructions");b&&(b.style.display="none"),y&&(y.style.display="none");const z=Oe.profile.images||[],x=z.length>0?z[z.length-1]:null;if(x){const e=document.getElementById("mazemaster_bb_img");e&&(e.src="/"+x.path)}const _=document.getElementById("bb_stage_title");if(_){const e=(null==x?void 0:x.stageMessage)||"Victory!";_.textContent=e}const w=document.getElementById("mazemaster_bb_hit_btn");w&&(w.innerHTML='<i class="fa-solid fa-check"></i> Close',w.classList.add("victory")),Oe.profile.winCommand&&await O(Oe.profile.winCommand)}const na={fantasy:{small:["alcove","guardPost","shrine","cell","storeroom"],medium:["treasureVault","library","armory","chapel","barracks"],large:["throneRoom","arena","crypt","greatHall","dungeon"],special:["bossLair","dragonDen","wizardTower"]},scifi:{small:["airlock","terminal","cryoPod","storageUnit","junction"],medium:["lab","serverRoom","medbay","armory","quarters"],large:["hangar","reactor","bridge","hydroponics","cargo"],special:["aiCore","alienNest","escapePod"]},horror:{small:["closet","cell","ritualNook","crawlspace","alcove"],medium:["morgue","cultRoom","tortureChamber","nursery","study"],large:["cathedral","asylumWard","abattoir","ritualHall","crypt"],special:["finalGate","elderShrine","heartOfDarkness"]},western:{small:["storeroom","jailCell","stall","privy","closet"],medium:["saloon","sheriffOffice","bankVault","generalStore","hotel"],large:["townSquare","ranchHouse","goldMine","trainStation","church"],special:["showdownStreet","outlawHideout","ghostTownCenter"]},action:{small:["checkpoint","ammoCache","commsRoom","bunker","vent"],medium:["warRoom","armory","interrogation","motorPool","barracks"],large:["hangar","trainingGround","commandCenter","missileSilo","prison"],special:["bossArena","extractionZone","doomsdayDevice"]},comedy:{small:["broomCloset","vendingCorner","awkwardBathroom","supplyRoom","cubicle"],medium:["breakRoom","conferenceDisaster","printerGraveyard","itDungeon","mailRoom"],large:["cafeteria","ballPit","karaokeHall","escapeRoomInception","openOffice"],special:["finalBossOffice","plotTwistRoom","creditsRoom"]},cyberpunk:{small:["jackPoint","stash","corpoCloset","vendingAlcove","maintenance"],medium:["netrunnerDen","chopShop","blackMarket","ripperdoc","flophouse"],large:["megacorpFloor","club","dataFortress","gangHQ","bazaar"],special:["aiCore","finalUpload","skyGarden"]}},aa={treasureVault:{guaranteedChest:!0,chestQuality:"rare",trapDensity:1.5,minionGuard:!0},bankVault:{guaranteedChest:!0,chestQuality:"rare",trapDensity:2,minionGuard:!0},arena:{waveBattle:!0,waveCount:{min:2,max:4},noRetreat:!0,rewardOnClear:"special"},bossArena:{bossEncounter:!0,lockedUntilCleared:!0,specialLoot:!0},bossLair:{bossEncounter:!0,lockedUntilCleared:!0,specialLoot:!0},trainingGround:{waveBattle:!0,waveCount:{min:1,max:2},noRetreat:!1},library:{revealMapOnEnter:!0,revealRadius:3,scholarNPC:!0},serverRoom:{revealMapOnEnter:!0,revealRadius:4},terminal:{revealMapOnEnter:!0,revealRadius:2},shrine:{noEnemies:!0,healPercent:25},chapel:{noEnemies:!0,healPercent:50,savePoint:!0},medbay:{noEnemies:!0,fullHeal:!0,savePoint:!0},ripperdoc:{noEnemies:!0,fullHeal:!0,merchantNPC:!0},crypt:{undeadOnly:!0,trapDensity:1.5},reactor:{hazardDamage:5,noRest:!0},crawlspace:{stealthBonus:!0,noLargeEnemies:!0},default:{}},oa={dungeon:{minRoomSize:2,maxRoomSize:3,minSplitSize:2,splitVariance:.3,corridorWidth:1,roomPadding:0,extraConnections:.5,branchChance:.4,preferSquareRooms:!1},maze:{minRoomSize:2,maxRoomSize:2,minSplitSize:2,splitVariance:.3,corridorWidth:1,roomPadding:0,extraConnections:.6,addDeadEnds:!0,branchChance:.5,preferSquareRooms:!0},city:{minRoomSize:2,maxRoomSize:3,minSplitSize:2,splitVariance:.25,corridorWidth:1,roomPadding:0,gridAlign:!0,extraConnections:.6,branchChance:.4,preferSquareRooms:!1},forest:{minRoomSize:2,maxRoomSize:3,minSplitSize:2,splitVariance:.35,corridorWidth:1,roomPadding:0,windingCorridors:!0,extraConnections:.5,branchChance:.5,preferSquareRooms:!1},spaceship:{minRoomSize:2,maxRoomSize:3,minSplitSize:2,splitVariance:.2,corridorWidth:1,roomPadding:0,extraConnections:.5,modularRooms:!0,branchChance:.4,preferSquareRooms:!0},arena:{minRoomSize:2,maxRoomSize:3,minSplitSize:2,splitVariance:.3,corridorWidth:1,roomPadding:0,extraConnections:.5,branchChance:.4,preferSquareRooms:!0},hospital:{minRoomSize:2,maxRoomSize:3,minSplitSize:2,splitVariance:.2,corridorWidth:1,roomPadding:0,gridAlign:!0,extraConnections:.5,branchChance:.4,preferSquareRooms:!1}},ia={dungeon:"dungeon",maze:"maze",city:"city",neotokyo:"city",forest:"forest",spaceship:"spaceship",spacestation:"spaceship",arena:"arena",outpost:"dungeon",college:"hospital",apartment:"city",hospital:"hospital",highrise:"city"};function sa(e,t,n,a,o,i){const s={x:e,y:t,width:n,height:a,left:null,right:null,room:null,splitHorizontal:null},r=i.minSplitSize||2,l=n>=r+1,c=a>=r+1;if(o>=(i.maxDepth||8)||!l&&!c)return s.room=ra(s,i),s;const d=n/a;let m;m=!l||!!c&&(!(d>1.5)&&(d<.67||Math.random()<.5)),s.splitHorizontal=m;const p=i.splitVariance||.3,u=Math.max(.25,.5-p),h=Math.min(.75,.5+p),g=u+Math.random()*(h-u);if(m){const l=Math.max(r,Math.min(a-r,Math.floor(a*g)));if(l<1||a-l<1)return s.room=ra(s,i),s;s.left=sa(e,t,n,l,o+1,i),s.right=sa(e,t+l,n,a-l,o+1,i)}else{const l=Math.max(r,Math.min(n-r,Math.floor(n*g)));if(l<1||n-l<1)return s.room=ra(s,i),s;s.left=sa(e,t,l,a,o+1,i),s.right=sa(e+l,t,n-l,a,o+1,i)}return s}function ra(e,t){const n=t.roomPadding||1,a=t.minRoomSize||2,o=t.maxRoomSize||5,i=e.width-2*n,s=e.height-2*n;if(i<a||s<a)return null;let r=Math.min(o,i),l=Math.min(o,s);if(r=Math.max(a,Math.floor(r*(.7+.3*Math.random()))),l=Math.max(a,Math.floor(l*(.7+.3*Math.random()))),t.preferSquareRooms){const e=Math.min(r,l);r=e,l=e}const c=i-r,d=s-l,m=c>0?Math.floor(Math.random()*c):0,p=d>0?Math.floor(Math.random()*d):0,u=e.x+n+m,h=e.y+n+p;return{x:u,y:h,width:r,height:l,centerX:Math.floor(u+r/2),centerY:Math.floor(h+l/2),type:"common",zoneId:null,isCleared:!1,connections:[]}}function la(e){return e?e.room?[e.room]:[...la(e.left),...la(e.right)]:[]}function ca(e,t,n){if(!e)return null;if(e.room)return e.room;const a=ca(e.left,t,n),o=ca(e.right,t,n);if(!a)return o;if(!o)return a;return Math.abs(a.centerX-t)+Math.abs(a.centerY-n)<Math.abs(o.centerX-t)+Math.abs(o.centerY-n)?a:o}function da(e,t,n,a){if(!e||!e.left||!e.right)return;da(e.left,t,n,a),da(e.right,t,n,a);const o=ca(e.left,e.x+e.width/2,e.y+e.height/2),i=ca(e.right,e.x+e.width/2,e.y+e.height/2);o&&i&&(ma(t,n,o.centerX,o.centerY,i.centerX,i.centerY,a),o.connections.push(i),i.connections.push(o))}function ma(e,n,a,o,i,s,r){const l=r.corridorWidth||1,c=Math.random()<.5;if(r.windingCorridors&&Math.random()<.3){const l=Math.floor((a+i)/2)+Math.floor(4*(Math.random()-.5)),c=Math.floor((o+s)/2)+Math.floor(4*(Math.random()-.5));return ma(e,n,a,o,l,c,t(t({},r),{},{windingCorridors:!1})),void ma(e,n,l,c,i,s,t(t({},r),{},{windingCorridors:!1}))}c?(pa(e,n,a,i,o,l),ua(e,n,o,s,i,l)):(ua(e,n,o,s,a,l),pa(e,n,a,i,s,l))}function pa(e,t,n,a,o,i){const s=Math.min(n,a),r=Math.max(n,a);for(let n=s;n<=r;n++)for(let a=0;a<i;a++){const i=o+a;if(n>=0&&n<t&&i>=0&&i<t){const a=e[i][n];a.corridorType="main",n>s&&(a.walls.left=!1),n<r&&(a.walls.right=!1),n>0&&n-1>=s&&(e[i][n-1].walls.right=!1),n<t-1&&n+1<=r&&(e[i][n+1].walls.left=!1)}}}function ua(e,t,n,a,o,i){const s=Math.min(n,a),r=Math.max(n,a);for(let n=s;n<=r;n++)for(let a=0;a<i;a++){const i=o+a;if(i>=0&&i<t&&n>=0&&n<t){const a=e[n][i];a.corridorType="main",n>s&&(a.walls.top=!1),n<r&&(a.walls.bottom=!1),n>0&&n-1>=s&&(e[n-1][i].walls.bottom=!1),n<t-1&&n+1<=r&&(e[n+1][i].walls.top=!1)}}}function ha(e,n,a){let o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};const i=ia[n]||"dungeon",s=t(t({},oa[i]||oa.dungeon),o);s.maxDepth=Math.max(4,Math.floor(1.5*Math.log2(e)));const r=[];for(let t=0;t<e;t++){r[t]=[];for(let n=0;n<e;n++)r[t][n]={walls:{top:!0,right:!0,bottom:!0,left:!0},visited:!1,minion:null,trap:null,roomId:null,zoneId:null,isRoomInterior:!1,secretPassage:null,corridorType:null}}const l=sa(0,0,e,e,0,s),c=la(l).filter((e=>null!==e));return c.forEach(((e,t)=>{e.id=t,function(e,t,n){for(let a=t.y;a<t.y+t.height;a++)for(let o=t.x;o<t.x+t.width;o++)if(a>=0&&a<e.length&&o>=0&&o<e[0].length){const i=e[a][o];i.roomId=n,i.isRoomInterior=!0,o>t.x&&(i.walls.left=!1),o<t.x+t.width-1&&(i.walls.right=!1),a>t.y&&(i.walls.top=!1),a<t.y+t.height-1&&(i.walls.bottom=!1),o>t.x&&o>0&&(e[a][o-1].walls.right=!1),o<t.x+t.width-1&&o<e[0].length-1&&(e[a][o+1].walls.left=!1),a>t.y&&a>0&&(e[a-1][o].walls.bottom=!1),a<t.y+t.height-1&&a<e.length-1&&(e[a+1][o].walls.top=!1)}}(r,e,t)})),da(l,r,e,s),function(e,t){const n=na[t]||na.fantasy,a=e.length>5;let o=!1;e.forEach(((t,i)=>{const s=t.width*t.height;let r;if(r=s<=4?"small":s<=9?"medium":"large",a&&!o&&(i===e.length-1||Math.random()<.1))t.type=n.special[Math.floor(Math.random()*n.special.length)],o=!0;else{const e=n[r];t.type=e[Math.floor(Math.random()*e.length)]}t.mechanics=aa[t.type]||aa.default}))}(c,a),s.extraConnections>0&&function(e,t,n,a){const o=Math.floor(t.length*a.extraConnections);for(let i=0;i<o;i++){const o=t[Math.floor(Math.random()*t.length)],i=t[Math.floor(Math.random()*t.length)];o===i||o.connections.includes(i)||(ma(e,n,o.centerX,o.centerY,i.centerX,i.centerY,a),o.connections.push(i),i.connections.push(o))}!function(e,t){const n=Math.floor(1.5*t);for(let a=0;a<n;a++){const n=2+Math.floor(Math.random()*(t-4)),a=2+Math.floor(Math.random()*(t-4)),o=e[a][n];if(o.isRoomInterior)continue;let i=0;if(o.walls.top||i++,o.walls.right||i++,o.walls.bottom||i++,o.walls.left||i++,i>=1&&i<=2){const i=[];o.walls.top&&a>0&&i.push("top"),o.walls.right&&n<t-1&&i.push("right"),o.walls.bottom&&a<t-1&&i.push("bottom"),o.walls.left&&n>0&&i.push("left");const s=Math.min(i.length,1+Math.floor(2*Math.random()));for(let t=0;t<s;t++){const t=Math.floor(Math.random()*i.length);switch(i.splice(t,1)[0]){case"top":o.walls.top=!1,e[a-1][n].walls.bottom=!1;break;case"right":o.walls.right=!1,e[a][n+1].walls.left=!1;break;case"bottom":o.walls.bottom=!1,e[a+1][n].walls.top=!1;break;case"left":o.walls.left=!1,e[a][n-1].walls.right=!1}}}}}(e,n)}(r,c,e,s),s.addDeadEnds&&function(e,t,n){const a=Math.floor(.5*t.length);for(let o=0;o<a;o++){const a=t[Math.floor(Math.random()*t.length)],o=[{dx:1,dy:0},{dx:-1,dy:0},{dx:0,dy:1},{dx:0,dy:-1}],i=o[Math.floor(Math.random()*o.length)],s=2+Math.floor(3*Math.random());let r=a.centerX+i.dx*(Math.floor(a.width/2)+1),l=a.centerY+i.dy*(Math.floor(a.height/2)+1);for(let t=0;t<s;t++)if(r>=0&&r<n&&l>=0&&l<n){const t=e[l][r];t.corridorType="branch",i.dx>0&&r<n-1?(t.walls.right=!1,e[l][r+1].walls.left=!1):i.dx<0&&r>0?(t.walls.left=!1,e[l][r-1].walls.right=!1):i.dy>0&&l<n-1?(t.walls.bottom=!1,e[l+1][r].walls.top=!1):i.dy<0&&l>0&&(t.walls.top=!1,e[l-1][r].walls.bottom=!1),r+=i.dx,l+=i.dy}}}(r,c,e),_a(r,e,0,0,e-1,e-1),function(e,t,n,a){const o=e[0][0],i=[];o.walls.right||i.push("east");o.walls.bottom||i.push("south");if(i.length>=2)return;const s=t.filter((e=>{const t=Math.abs(e.centerX)+Math.abs(e.centerY);return t>0&&t<n/2})).sort(((e,t)=>Math.abs(e.centerX)+Math.abs(e.centerY)-(Math.abs(t.centerX)+Math.abs(t.centerY))));if(!i.includes("east")&&n>1){const t=s.find((e=>e.centerX>0));if(t){let o=0;const i=Math.min(3,t.centerX);for(;o<i&&o<n-1;)e[0][o].walls.right=!1,e[0][o+1].walls.left=!1,o++;ma(e,n,o,0,t.centerX,t.centerY,a)}else e[0][0].walls.right=!1,n>1&&(e[0][1].walls.left=!1)}if(!i.includes("south")&&n>1){const t=s.find((e=>e.centerY>0&&e.centerX<n/3));if(t){let o=0;const i=Math.min(3,t.centerY);for(;o<i&&o<n-1;)e[o][0].walls.bottom=!1,e[o+1][0].walls.top=!1,o++;ma(e,n,0,o,t.centerX,t.centerY,a)}else e[0][0].walls.bottom=!1,n>1&&(e[1][0].walls.top=!1)}}(r,c,e,s),{grid:r,rooms:c}}function ga(e,t,n){if(t<=1||e.length<=1)return e.forEach((e=>{e.zoneId=0})),[{id:0,name:"Main Area",rooms:e.map(((e,t)=>t)),isUnlocked:!0,unlockCondition:null,gatePositions:[]}];const a=[...e].sort(((e,t)=>e.centerX+e.centerY-(t.centerX+t.centerY))),o=Math.ceil(a.length/t),i=[];for(let e=0;e<t;e++){const s=e*o,r=Math.min(s+o,a.length),l=a.slice(s,r);l.forEach((t=>{t.zoneId=e})),i.push({id:e,name:fa(e,t,n),rooms:l.map((e=>e.id)),isUnlocked:0===e,unlockCondition:0===e?null:{type:"clear",targetZoneId:e-1,requiredClears:Math.max(1,Math.floor(.6*l.length))},gatePositions:[]})}return i}function fa(e,t,n){const a={fantasy:["Entrance Hall","The Depths","Ancient Crypt","Dragon's Domain","Throne of Shadows","Final Sanctum"],scifi:["Docking Bay","Crew Quarters","Engineering","Research Labs","Command Deck","Core Systems"],horror:["Foyer","Patient Ward","Basement","Ritual Chamber","The Abyss","Heart of Darkness"],cyberpunk:["Street Level","Lower Floors","Corporate Zone","Executive Suite","Server Core","Penthouse"],western:["Town Entrance","Main Street","Back Alleys","Mine Tunnels","Hideout","Final Showdown"],action:["Insertion Point","Outer Perimeter","Inner Complex","High Security","Command Center","Extraction Zone"],comedy:["Lobby","Open Office","Break Room Hell","Management Floor","IT Dungeon","CEO's Lair"]},o=a[n]||a.fantasy;return o[Math.min(e,o.length-1)]}function va(e,t,n){n.forEach((t=>{for(let n=t.y;n<t.y+t.height;n++)for(let a=t.x;a<t.x+t.width;a++)n>=0&&n<e.length&&a>=0&&a<e[0].length&&(e[n][a].zoneId=t.zoneId)}));for(let t=0;t<e.length;t++)for(let a=0;a<e[0].length;a++){const o=e[t][a];if(o.corridorType&&null===o.zoneId){let e=null,i=1/0;n.forEach((n=>{const o=Math.abs(n.centerX-a)+Math.abs(n.centerY-t);o<i&&(i=o,e=n)})),e&&(o.zoneId=e.zoneId)}}}async function ba(e,t){var n;if(!Ge||!Ge.floorsData)return;const a=Ge.floorsData[Ge.currentFloor];if(!a||!a.rooms)return;const o=null===(n=Ge.grid[t])||void 0===n?void 0:n[e];if(!o||void 0===o.roomId||null===o.roomId)return;const i=a.rooms.find((e=>e.id===o.roomId));i&&!i.isCleared&&(i.isCleared=!0,console.log("[MazeMaster] Room ".concat(i.id," (").concat(i.type,") cleared")),await H("onRoomClear",{roomId:i.id,roomType:i.type,x:e,y:t}),await async function(){var e;if(!Ge||!Ge.floorsData)return;const t=Ge.floorsData[Ge.currentFloor];if(!t||!t.zones||!t.rooms)return;for(const n of t.zones){if(n.isUnlocked)continue;const a=n.unlockCondition;if(!a)continue;let o=!1;switch(a.type){case"clear":const i=null!==(e=a.targetZoneId)&&void 0!==e?e:n.id-1;o=t.rooms.filter((e=>e.zoneId===i)).filter((e=>e.isCleared)).length>=(a.requiredClears||1);break;case"boss":const s=t.rooms.find((e=>{var t;return e.zoneId===(null!==(t=a.targetZoneId)&&void 0!==t?t:n.id-1)&&("bossLair"===e.type||"boss-arena"===e.type)}));o=!0===(null==s?void 0:s.isCleared);break;case"key":o=!1;break;case"start":o=!0}o&&(n.isUnlocked=!0,console.log("[MazeMaster] Zone ".concat(n.id," (").concat(n.name,") unlocked!")),Oa("Zone Unlocked","".concat(n.name," is now accessible!")),await H("onZoneUnlock",{zoneId:n.id,zoneName:n.name}))}}())}function ya(e,t,n){const a=n.secretDensity||.02,o=Math.max(1,Math.floor(t*t*a));let i=0,s=0;const r=10*o;for(;i<o&&s<r;){var l;s++;const a=Math.floor(Math.random()*t),o=Math.floor(Math.random()*t),r=e[o][a];if(r.secretPassage||r.staircase||r.portal)continue;const c=[];if(r.walls.top&&o>0&&c.push("top"),r.walls.right&&a<t-1&&c.push("right"),r.walls.bottom&&o<t-1&&c.push("bottom"),r.walls.left&&a>0&&c.push("left"),0===c.length)continue;const d=c[Math.floor(Math.random()*c.length)];let m=a,p=o;"top"===d&&p--,"bottom"===d&&p++,"left"===d&&m--,"right"===d&&m++;if(!(null===(l=e[p])||void 0===l?void 0:l[m]))continue;if(0===a&&0===o||0===m&&0===p)continue;if(a===t-1&&o===t-1||m===t-1&&p===t-1)continue;const u=n.secretHints?Math.floor(4*Math.random()):0;r.secretPassage={direction:d,revealed:!1,hintLevel:u,targetCell:{x:m,y:p}},i++}console.log("[MazeMaster] Placed ".concat(i," secret passages"))}function za(e,t){var n;if(!e.secretPassage||e.secretPassage.direction!==t)return{found:!1,attempted:!1};if(e.secretPassage.revealed)return{found:!1,attempted:!1};const a=function(e,t,n,a){const o=e.secretPassage;if(!o||o.direction!==t||o.revealed)return{found:!1};let i=0;switch(n){case"tap":i=.1+.15*o.hintLevel;break;case"item":i=.8+.05*o.hintLevel;break;case"passive":i=o.hintLevel>=3?.5:0}return(null==a?void 0:a.secretSense)>0&&(i+=.2),i=Math.min(i,1),Math.random()<i?{found:!0,revealed:!0}:o.hintLevel>0&&"tap"===n?{found:!1,hint:!0,hintLevel:o.hintLevel}:{found:!1}}(e,t,"tap",null===(n=Ge)||void 0===n?void 0:n.inventory);if(a.found)return{found:!0,attempted:!0};let o="The wall feels solid...";if(a.hint)switch(a.hintLevel){case 1:o="You notice something unusual about this wall...";break;case 2:o="There's a faint crack here. Try again?";break;case 3:o="This section of wall seems hollow!"}return{found:!1,attempted:!0,message:o}}function xa(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"fantasy",a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};console.log("[MazeMaster] Generating BSP grid: size=".concat(e,", style=").concat(t,", theme=").concat(n));const o=ha(e,t,n,a);return console.log("[MazeMaster] Generated ".concat(o.rooms.length," rooms")),o}function _a(e,t,n,a,o,i){const s=new Set(["".concat(n,",").concat(a)]),r=[{x:n,y:a}];for(;r.length>0;){const{x:n,y:a}=r.shift();if(n===o&&a===i)return;!e[a][n].walls.top&&a>0&&!s.has("".concat(n,",").concat(a-1))&&(s.add("".concat(n,",").concat(a-1)),r.push({x:n,y:a-1})),!e[a][n].walls.right&&n<t-1&&!s.has("".concat(n+1,",").concat(a))&&(s.add("".concat(n+1,",").concat(a)),r.push({x:n+1,y:a})),!e[a][n].walls.bottom&&a<t-1&&!s.has("".concat(n,",").concat(a+1))&&(s.add("".concat(n,",").concat(a+1)),r.push({x:n,y:a+1})),!e[a][n].walls.left&&n>0&&!s.has("".concat(n-1,",").concat(a))&&(s.add("".concat(n-1,",").concat(a)),r.push({x:n-1,y:a}))}const l=[],c=2+Math.floor(3*Math.random());for(let e=1;e<=c;e++){const s=e/(c+1),r=n+Math.floor((o-n)*s),d=a+Math.floor((i-a)*s),m=Math.floor((Math.random()-.5)*t*.4),p=Math.floor((Math.random()-.5)*t*.4);l.push({x:Math.max(0,Math.min(t-1,r+m)),y:Math.max(0,Math.min(t-1,d+p))})}let d=n,m=a;const p=[...l,{x:o,y:i}];for(const n of p){if(Math.random()<.5){for(;d!==n.x;){const a=d<n.x?d+1:d-1;if(!(a>=0&&a<t))break;d<n.x?(e[m][d].walls.right=!1,e[m][a].walls.left=!1):(e[m][d].walls.left=!1,e[m][a].walls.right=!1),d=a}for(;m!==n.y;){const a=m<n.y?m+1:m-1;if(!(a>=0&&a<t))break;m<n.y?(e[m][d].walls.bottom=!1,e[a][d].walls.top=!1):(e[m][d].walls.top=!1,e[a][d].walls.bottom=!1),m=a}}else{for(;m!==n.y;){const a=m<n.y?m+1:m-1;if(!(a>=0&&a<t))break;m<n.y?(e[m][d].walls.bottom=!1,e[a][d].walls.top=!1):(e[m][d].walls.top=!1,e[a][d].walls.bottom=!1),m=a}for(;d!==n.x;){const a=d<n.x?d+1:d-1;if(!(a>=0&&a<t))break;d<n.x?(e[m][d].walls.right=!1,e[m][a].walls.left=!1):(e[m][d].walls.left=!1,e[m][a].walls.right=!1),d=a}}}}function wa(e,t,n,a,o,i){if(n===o&&a===i)return!0;const s=new Set(["".concat(n,",").concat(a)]),r=[{x:n,y:a}];for(;r.length>0;){const{x:n,y:a}=r.shift();if(n===o&&a===i)return!0;!e[a][n].walls.top&&a>0&&!s.has("".concat(n,",").concat(a-1))&&(s.add("".concat(n,",").concat(a-1)),r.push({x:n,y:a-1})),!e[a][n].walls.right&&n<t-1&&!s.has("".concat(n+1,",").concat(a))&&(s.add("".concat(n+1,",").concat(a)),r.push({x:n+1,y:a})),!e[a][n].walls.bottom&&a<t-1&&!s.has("".concat(n,",").concat(a+1))&&(s.add("".concat(n,",").concat(a+1)),r.push({x:n,y:a+1})),!e[a][n].walls.left&&n>0&&!s.has("".concat(n-1,",").concat(a))&&(s.add("".concat(n-1,",").concat(a)),r.push({x:n-1,y:a}))}return!1}function ka(e){return!(e.walls.top&&e.walls.right&&e.walls.bottom&&e.walls.left)}function Ca(e,t){let n=0;console.log("[MazeMaster] Running wall consistency check...");for(let a=0;a<t;a++)for(let o=0;o<t;o++){const i=e[a][o];if(o<t-1){const t=e[a][o+1];i.walls.right!==t.walls.left&&(console.log("[MazeMaster] Wall mismatch at (".concat(o,",").concat(a,") right: ").concat(i.walls.right," vs (").concat(o+1,",").concat(a,") left: ").concat(t.walls.left)),i.walls.right&&t.walls.left?(i.walls.right=!0,t.walls.left=!0):(i.walls.right=!1,t.walls.left=!1),n++)}if(a<t-1){const t=e[a+1][o];i.walls.bottom!==t.walls.top&&(console.log("[MazeMaster] Wall mismatch at (".concat(o,",").concat(a,") bottom: ").concat(i.walls.bottom," vs (").concat(o,",").concat(a+1,") top: ").concat(t.walls.top)),i.walls.bottom&&t.walls.top?(i.walls.bottom=!0,t.walls.top=!0):(i.walls.bottom=!1,t.walls.top=!1),n++)}}console.log("[MazeMaster] Wall consistency check complete. Fixed ".concat(n," mismatch(es)"))}function Sa(e){const t=100*Math.random();return t<(e.chestMimicPercent||0)?"mimic":t<(e.chestMimicPercent||0)+(e.chestLockedPercent||0)?"locked":"normal"}function Ma(e,t,n){var a;const o=[];for(let e=0;e<n;e++)for(let t=0;t<n;t++)0===t&&0===e||t===n-1&&e===n-1||o.push({x:t,y:e});Ea(o);const i=function(e,t){const n={minionPlacements:[],trapPlacements:[],chestCount:0},a=N(e),o=a.encounterDensityMult||1,i=a.trapFrequencyMult||1,s=e.chestTilePercent||0,r=e.minionEncounters||[],l=e.trapEncounters||[],c=s+r.reduce(((e,t)=>e+(t.percent||0)*o),0)+l.reduce(((e,t)=>e+(t.percent||0)*i),0);let d=1;c>100&&(d=100/c,console.log("[MazeMaster] Distribution over 100% (".concat(c,"%), scaling down by ").concat(d.toFixed(2)))),n.chestCount=Math.floor(t*(s*d)/100);for(const e of r){const a=(e.percent||0)*o*d,i=Math.round(t*a/100);i>0&&n.minionPlacements.push({minionId:e.minionId,count:i})}for(const e of l){const a=(e.percent||0)*i*d,o=Math.round(t*a/100);o>0&&n.trapPlacements.push({trapId:e.trapId,count:o})}return n}(t,o.length);let s=0;for(let n=0;n<i.chestCount&&s<o.length;n++){const n=o[s++],a=Sa(t);e[n.y][n.x].chest={type:a,opened:!1}}const r=s;for(const t of i.minionPlacements)for(let n=0;n<t.count&&s<o.length;n++){const n=o[s++];e[n.y][n.x].minion={minionId:t.minionId,triggered:!1}}const l=s-r,c=s;for(const t of i.trapPlacements)for(let n=0;n<t.count&&s<o.length;n++){const n=o[s++];e[n.y][n.x].trap={trapId:t.trapId,triggered:!1}}const d=s-c,m=function(e,t,n,a){if(!t.portals||0===t.portals.length)return;const o=[];for(const i of t.portals){let t=i.startX,s=i.startY,r=i.endX,l=i.endY;if(null==t||null==s){const o=a.find((t=>!(e[t.y][t.x].chest||e[t.y][t.x].minion||e[t.y][t.x].trap||e[t.y][t.x].portal||0===t.x&&0===t.y||t.x===n-1&&t.y===n-1)));if(!o)continue;{t=o.x,s=o.y;const e=a.indexOf(o);e>-1&&a.splice(e,1)}}if(null==r||null==l){const o=a.find((a=>!(e[a.y][a.x].chest||e[a.y][a.x].minion||e[a.y][a.x].trap||e[a.y][a.x].portal||a.x===t&&a.y===s||0===a.x&&0===a.y||a.x===n-1&&a.y===n-1)));if(!o)continue;{r=o.x,l=o.y;const e=a.indexOf(o);e>-1&&a.splice(e,1)}}const c=i.id||"portal_".concat(o.length+1),d=i.color||"#9b59b6",m=!1!==i.bidirectional;e[s][t].portal={id:c,target:{x:r,y:l},isStart:!0,color:d,bidirectional:m},e[l][r].portal={id:c,target:{x:t,y:s},isStart:!1,color:d,bidirectional:m},o.push({id:c,startX:t,startY:s,endX:r,endY:l,color:d,bidirectional:m})}return o.length>0&&console.log("[MazeMaster] Placed ".concat(o.length," portal pair(s)")),o}(e,t,n,o.slice(s)),p=null!==(a=t.safeRoomCount)&&void 0!==a?a:3;if(p>0){const t=[];for(let a=0;a<n;a++)for(let o=0;o<n;o++){if(0===o&&0===a||o===n-1&&a===n-1)continue;const i=e[a][o];i.chest||i.minion||i.trap||i.portal||i.staircase||t.push({x:o,y:a})}Ea(t);const a=Math.min(p,t.length);for(let n=0;n<a;n++){const a=t[n];e[a.y][a.x].safeRoom={exhausted:!1}}console.log("[MazeMaster] Placed ".concat(a," safe rooms"))}return console.log("[MazeMaster] Placed ".concat(i.chestCount," chests, ").concat(l," minions, ").concat(d," traps")),function(e,t,n){const a=t.findEarly;if(!a||!a.items||0===a.items.length)return;const o=a.radius||4,i=[...a.items],s=[];for(let t=0;t<n;t++)for(let a=0;a<n;a++){const n=a+t;if(n<=o&&n>0){const o=e[t][a];o.chest&&!o.chest.opened&&s.push({x:a,y:t,dist:n})}}s.sort(((e,t)=>e.dist-t.dist));let r=0;for(const t of s){if(r>=i.length)break;const n=e[t.y][t.x].chest;n.guaranteedItems||(n.guaranteedItems=[]);const o=a.itemsPerChest||1;for(let e=0;e<o&&r<i.length;e++)n.guaranteedItems.push(i[r]),r++}r>0&&console.log("[MazeMaster] Find Early: Assigned ".concat(r," guaranteed items to ").concat(s.length," nearby chests"))}(e,t,n),{placedPortals:m||[]}}function Ea(e){for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}}function Pa(e){return e&&0!==e.length?e[Math.floor(Math.random()*e.length)]:null}function Ia(e){return new Promise((t=>setTimeout(t,e)))}function Ta(e){return D.getRenderer().getCellSize(e)}function Ba(e){var n;const a=function(e){var n;const a=null===(n=Re.mazeProfiles)||void 0===n?void 0:n[e];return a?t(t({},A),a):null}(e);if(!a)return console.error('[MazeMaster] Maze profile "'.concat(e,'" not found')),{error:'Profile "'.concat(e,'" not found')};if(!1!==Re.closeChatOnStart)try{const e=SillyTavern.getContext();e&&"function"==typeof e.clearChat?(e.clearChat(),console.log("[MazeMaster] Closed current chat to prevent context bleed")):"function"==typeof doNewChat&&(doNewChat(),console.log("[MazeMaster] Started new chat to prevent context bleed"))}catch(e){console.warn("[MazeMaster] Could not close chat:",e)}const o=a.gridSize||10,i=a.mapStyle||"maze",s=Math.max(1,Math.min(10,a.floors||1)),r=[];let l,c;const d=a.difficulty||"normal";if(s>1||"hard"===d||"nightmare"===d){const e=[];e.push({x:o-1,y:0}),e.push({x:0,y:o-1}),e.push({x:o-1,y:o-1}),("nightmare"===d||s>=3)&&(e.push({x:Math.floor(o/2),y:o-1}),e.push({x:o-1,y:Math.floor(o/2)}));const t=e[Math.floor(Math.random()*e.length)];l=t.x,c=t.y,console.log("[MazeMaster] Randomized exit position: (".concat(l,", ").concat(c,") for ").concat(d," maze with ").concat(s," floor(s)"))}else l=o-1,c=o-1;const m=[];for(let e=0;e<s;e++){const t=a.bspConfig||{};if(!1!==t.floorComplexityScaling&&s>1){const n=e/Math.max(1,s-1);t.maxDepth=(t.maxDepth||4)+Math.floor(2*n),t.secretDensity=(t.secretDensity||.02)*(1+n)}const n=a.theme||"fantasy",d=xa(o,i,n,t),p=d.grid,u=d.rooms,h=ga(u,t.zoneCount||1,n);va(p,0,u),t.secretDensity>0&&ya(p,o,{secretDensity:t.secretDensity,secretHints:!1!==t.secretHints}),Ca(p,o),Ma(p,a,o),E(p,a,o,l,c),r.push(p),m.push({grid:p,rooms:u,zones:h})}let p=0;if(s>1){!function(e,t,n,a,o){const i=e.length;for(let s=0;s<i-1;s++){const i=e[s],r=e[s+1],l=[];for(let e=0;e<t;e++)for(let n=0;n<t;n++){if(0===n&&0===e||n===a&&e===o)continue;const s=i[e][n],c=r[e][n];s.minion||s.trap||s.chest||c.minion||c.trap||c.chest||ka(s)&&ka(c)&&wa(i,t,0,0,n,e)&&l.push({x:n,y:e})}if(l.length<1){console.warn("[MazeMaster] No valid staircase positions found for floor ".concat(s," -> ").concat(s+1));continue}const c=Math.min(2,Math.max(1,Math.floor(t/5)));for(let e=0;e<c&&l.length>0;e++){const e=Math.floor(Math.random()*l.length),c=l.splice(e,1)[0];i[c.y][c.x].staircase={direction:"up",targetFloor:s+1,targetX:c.x,targetY:c.y,requireKey:n},r[c.y][c.x].staircase={direction:"down",targetFloor:s,targetX:c.x,targetY:c.y,requireKey:!1},_a(r,t,c.x,c.y,a,o),console.log("[MazeMaster] Staircase placed at (".concat(c.x,", ").concat(c.y,") connecting floor ").concat(s," to ").concat(s+1))}}}(r,o,a.requireFloorKey||!1,l,c),a.requireFloorKey&&(p=function(e,t){let n=0;for(let i=0;i<e.length;i++){const s=e[i];let r=!1;for(let e=0;e<t&&!r;e++)for(let n=0;n<t&&!r;n++){var a,o;const t=s[e][n];"up"===(null===(a=t.staircase)||void 0===a?void 0:a.direction)&&null!==(o=t.staircase)&&void 0!==o&&o.requireKey&&(r=!0)}if(!r)continue;const l=[];for(let e=0;e<t;e++)for(let n=0;n<t;n++){const t=s[e][n];t.chest&&!t.chest.guaranteedFloorKey&&l.push({x:n,y:e,cell:t})}if(l.length>0){const e=l[Math.floor(Math.random()*l.length)];e.cell.chest.guaranteedFloorKey=!0,console.log("[MazeMaster] Floor ".concat(i,": Guaranteed floor key in chest at (").concat(e.x,", ").concat(e.y,")"))}else n++,console.log("[MazeMaster] Floor ".concat(i,": No chest found - adding floor key to starting inventory"))}return n}(r,o));const e=r[0];e[c]&&e[c][l]&&(e[c][l].walls={top:!0,right:!0,bottom:!0,left:!0},console.log("[MazeMaster] Blocked exit area on floor 0 at (".concat(l,", ").concat(c,") - must use stairs")))}const u=r[0],h=a.startingInventory||{key:0,stealth:0,strike:0,execute:0},g=N(a).inventoryStartMult||1,f={key:Math.floor((h.key||0)*g),stealth:Math.floor((h.stealth||0)*g),strike:Math.floor((h.strike||0)*g),execute:Math.floor((h.execute||0)*g),floorKey:Math.floor((h.floorKey||0)*g)+p,portalStone:Math.floor((h.portalStone||0)*g),minionBane:Math.floor((h.minionBane||0)*g),mapFragment:Math.floor((h.mapFragment||0)*g),timeShard:Math.floor((h.timeShard||0)*g),voidWalk:Math.floor((h.voidWalk||0)*g)};let v={name:"The Maze",imagePath:"",message:"Find your way to the exit..."};const b=a.mainMinion?St(a.mainMinion):null;return null!==(n=a.storyConfig)&&void 0!==n&&n.mainStory?v={name:(null==b?void 0:b.name)||"Story",role:"Narrator",imagePath:(null==b?void 0:b.imagePath)||"",message:a.storyConfig.mainStory}:b&&(v={name:b.name,role:"Main Minion",imagePath:b.imagePath,message:a.mainMinionIntroMessage||"Welcome to my maze..."}),Ge={isOpen:!0,profile:a,profileName:e,grid:u,size:o,playerX:0,playerY:0,playerDirection:"south",exitX:o-1,exitY:o-1,visited:new Set(["0:0,0"]),isVictory:!1,currentMinion:v,isPaused:!1,pendingEncounter:null,exitEncounterDone:!1,pendingConfirmation:null,pendingChest:null,inventory:{key:f.key||0,stealth:f.stealth||0,strike:f.strike||0,execute:f.execute||0,floorKey:f.floorKey||0,portalStone:f.portalStone||0,minionBane:f.minionBane||0,mapFragment:f.mapFragment||0,timeShard:f.timeShard||0,voidWalk:f.voidWalk||0,healingPotion:0,greaterHealing:0,elixir:0,revivalCharm:0,heartCrystal:0,torch:0,lantern:0,revealScroll:0,sightPotion:0,crystalBall:0,secretSense:0},visibility:{baseRadius:1,tempBonus:0,tempMovesLeft:0,permBonus:0,floorRevealed:!1},shownMilestones:new Set,stats:{startTime:Date.now(),moves:0,encountersTotal:0,encountersWon:0,encountersLost:0,chestsOpened:0,trapsTriggered:0,teleportsUsed:0,itemsCollected:{key:0,strike:0,stealth:0,execute:0}},explorationComplete:!1,moveCount:0,movingMinions:[],portals:[],objectiveProgress:ge(a),allObjectivesComplete:!1,currentFloor:0,totalFloors:s,floors:r,floorsData:m,voidWalkActive:!1,messageLog:[],hpEnabled:!1!==a.hpEnabled,hp:q(a),restCooldown:0,sessionNotes:"",fairness:{chestsWithoutKey:0,combatLossStreak:0,chestsWithoutHealing:0,lockedChestsSkipped:0,lastHealingFoundFloor:0},enhancedRooms:{}},Aa("Adventure begins: ".concat(e)),Aa("Floor 1/".concat(a.floors||1," - ").concat(o,"x").concat(o," ").concat(a.theme||"fantasy"," ").concat(a.mapStyle||"dungeon")),Ge.movingMinions=function(e,n){const a=[];for(let o=0;o<n;o++)for(let i=0;i<n;i++){const n=e[o][i];if(n.minion&&!n.minion.triggered){const e=St(n.minion.minionId),s=(null==e?void 0:e.movement)||{type:"stationary"};"stationary"!==s.type&&a.push({minionId:n.minion.minionId,x:i,y:o,originX:i,originY:o,triggered:!1,movement:t({},s)})}}return console.log("[MazeMaster] Initialized ".concat(a.length," moving minion(s)")),a}(u,o),Da(),J(0,0,o),Ra(),ue(!1),Na(),G(),Fa(),Ka(),te(),U(),be(),oe&&clearInterval(oe),oe=setInterval((()=>{var e,t;null===(e=Ge)||void 0===e||!e.isOpen||null!==(t=Ge)&&void 0!==t&&t.isVictory?(clearInterval(oe),oe=null):te()}),1e3),me(),ce(),document.addEventListener("keydown",ja,{capture:!0}),Xe(0,0),console.log('[MazeMaster] Maze "'.concat(e,'" started (').concat(o,"x").concat(o,", ").concat(s," floor").concat(s>1?"s":"",")")),{success:!0}}function Da(){var e,t,n,a,o,i,s,r;const l=document.getElementById("mazemaster_maze_modal");l&&l.remove();const c=Ta(Ge.size),d=document.createElement("div");d.id="mazemaster_maze_modal",d.style.cssText="position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:999999;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.95);",d.innerHTML='\n        <div class="mazemaster-maze-overlay">\n            <div class="mazemaster-maze-container">\n                \x3c!-- TOP PANEL: Info & Controls --\x3e\n                <div class="mazemaster-maze-top">\n                    \x3c!-- Left Column: Message Box, Stats, Inventory --\x3e\n                    <div class="mazemaster-maze-left-column">\n                        \x3c!-- Hero Section (Message Box) --\x3e\n                        <div class="mazemaster-maze-hero">\n                            <div class="mazemaster-maze-hero-content">\n                                <div class="mazemaster-maze-hero-avatar">\n                                    <img id="maze_minion_img" src="" alt="" style="display: none;">\n                                    <div id="maze_generating_indicator" class="maze-generating-indicator">\n                                        <i class="fa-solid fa-comment-dots"></i>\n                                    </div>\n                                </div>\n                                <div class="maze-hero-text">\n                                    <div id="maze_minion_name" class="maze-minion-name"></div>\n                                    <div id="maze_minion_role" class="maze-minion-role"></div>\n                                    <div id="maze_message_log" class="maze-message-log"></div>\n                                </div>\n                            </div>\n                        </div>\n\n                    \x3c!-- ROW 2: Stats and Inventory --\x3e\n                    <div class="mazemaster-maze-info-stack">\n                        \x3c!-- Stats Bar --\x3e\n                        <div class="mazemaster-maze-stats-bar">\n                            <div class="stats-item stats-persona" title="Current Persona">\n                                <i class="fa-solid fa-user"></i>\n                                <span id="maze_stat_persona">'.concat(Q(),'</span>\n                            </div>\n                            <div class="stats-item" title="Moves">\n                                <i class="fa-solid fa-shoe-prints"></i>\n                                <span id="maze_stat_moves">0</span>\n                            </div>\n                            <div class="stats-item" title="Time Elapsed">\n                                <i class="fa-solid fa-clock"></i>\n                                <span id="maze_stat_time">0:00</span>\n                            </div>\n                            <div class="stats-item" title="Exploration">\n                                <i class="fa-solid fa-map"></i>\n                                <span id="maze_stat_explore">0%</span>\n                            </div>\n                            <div class="stats-item" title="Difficulty">\n                                <i class="fa-solid fa-skull"></i>\n                                <span id="maze_stat_difficulty">').concat(N(Ge.profile).name,'</span>\n                            </div>\n                            <div class="stats-item maze-floor-indicator" title="Current Floor" style="').concat(Ge.totalFloors<=1?"display:none;":"",'">\n                                <i class="fa-solid fa-layer-group"></i>\n                                <span><span id="maze_floor_current">').concat(Ge.currentFloor+1,'</span>/<span id="maze_floor_total">').concat(Ge.totalFloors,'</span></span>\n                            </div>\n                            <div class="stats-item maze-zone-indicator" id="maze_zone_display" title="Current Zone" style="display: none;">\n                                <i class="fa-solid fa-map-pin"></i>\n                                <span id="maze_zone_name">Zone 1</span>\n                                <span id="maze_zone_progress" style="font-size: 0.8em; opacity: 0.7;"></span>\n                            </div>\n                        </div>\n                    </div>\n\n                    \x3c!-- Objectives Section (if any) --\x3e\n                    <div class="maze-objectives-section ').concat(0===((null===(e=Ge.profile)||void 0===e||null===(e=e.objectives)||void 0===e?void 0:e.length)||0)?"hidden":"",'">\n                        <div class="objectives-header">\n                            <i class="fa-solid fa-list-check"></i>\n                            <span>Objectives</span>\n                        </div>\n                        <div id="maze_objectives_list" class="objectives-list">\n                            \x3c!-- Populated by updateObjectivesDisplay() --\x3e\n                        </div>\n                    </div>\n                    </div>\n\n                    \x3c!-- ROOM INFO BOX (right side, full height) --\x3e\n                    <div class="mazemaster-maze-room-info" id="maze_room_info">\n                        <div class="room-info-content">\n                            <div class="room-info-name" id="room_info_name">Unknown Room</div>\n                            <div class="room-info-desc" id="room_info_desc">...</div>\n                            <div class="room-info-section">\n                                <div class="room-info-label"><i class="fa-solid fa-users"></i> Occupants</div>\n                                <div id="room_info_occupants">None</div>\n                            </div>\n                            <div class="room-info-section">\n                                <div class="room-info-label"><i class="fa-solid fa-skull"></i> Defeated</div>\n                                <div id="room_info_defeated">None</div>\n                            </div>\n                            <div class="room-info-section room-info-exits-section">\n                                <div class="room-info-label"><i class="fa-solid fa-compass"></i> Exits</div>\n                                <div id="room_info_exits" class="room-info-exits-list">None</div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n\n                \x3c!-- Power Button (top right corner) --\x3e\n                <button id="maze_power_btn" class="maze-power-btn" title="Exit Maze">\n                    <i class="fa-solid fa-power-off"></i>\n                </button>\n\n                \x3c!-- Inventory Info Button (below power button) --\x3e\n                <div class="maze-inventory-info-wrapper" id="maze_inventory_wrapper">\n                    <button id="maze_inventory_btn" class="maze-info-btn" title="Inventory">\n                        <i class="fa-solid fa-info"></i>\n                    </button>\n                    <div class="maze-inventory-dropdown hidden" id="maze_inventory_menu">\n                        \x3c!-- Dungeon Items --\x3e\n                        <div class="inventory-menu-section">\n                            <div class="inventory-menu-header">Dungeon Items</div>\n                            <div class="inventory-menu-item" data-item="key" title="Unlock locked chests">\n                                <i class="fa-solid fa-key" style="color: #f1c40f;"></i>\n                                <span class="item-name">Skeleton Key</span>\n                                <span class="item-count" id="maze_inv_key">').concat(Ge.inventory.key,'</span>\n                            </div>\n                            <div class="inventory-menu-item" data-item="floorKey" title="Unlock staircases">\n                                <i class="fa-solid fa-stairs" style="color: #9b59b6;"></i>\n                                <span class="item-name">Floor Key</span>\n                                <span class="item-count" id="maze_inv_floorKey">').concat(Ge.inventory.floorKey,'</span>\n                            </div>\n                            <div class="inventory-menu-item" data-item="portalStone" data-usable="true" title="Teleport to any revealed portal">\n                                <i class="fa-solid fa-gem" style="color: #3498db;"></i>\n                                <span class="item-name">Portal Stone</span>\n                                <span class="item-count" id="maze_inv_portalStone">').concat(Ge.inventory.portalStone,'</span>\n                            </div>\n                            <div class="inventory-menu-item" data-item="mapFragment" data-usable="true" title="Reveal 3x3 area around you">\n                                <i class="fa-solid fa-scroll" style="color: #e67e22;"></i>\n                                <span class="item-name">Map Fragment</span>\n                                <span class="item-count" id="maze_inv_mapFragment">').concat(Ge.inventory.mapFragment,'</span>\n                            </div>\n                            <div class="inventory-menu-item" data-item="voidWalk" data-usable="true" title="Phase through one wall">\n                                <i class="fa-solid fa-ghost" style="color: #1abc9c;"></i>\n                                <span class="item-name">Void Walk</span>\n                                <span class="item-count" id="maze_inv_voidWalk">').concat(Ge.inventory.voidWalk,'</span>\n                            </div>\n                        </div>\n                        \x3c!-- Combat Items --\x3e\n                        <div class="inventory-menu-section">\n                            <div class="inventory-menu-header">Combat Items</div>\n                            <div class="inventory-menu-item" data-item="stealth" title="Sneak past enemies">\n                                <i class="fa-solid fa-user-ninja" style="color: #95a5a6;"></i>\n                                <span class="item-name">Shadow Cloak</span>\n                                <span class="item-count" id="maze_inv_stealth">').concat(Ge.inventory.stealth,'</span>\n                            </div>\n                            <div class="inventory-menu-item" data-item="strike" title="Combat boost">\n                                <i class="fa-solid fa-bolt" style="color: #f39c12;"></i>\n                                <span class="item-name">Battle Surge</span>\n                                <span class="item-count" id="maze_inv_pow">').concat(Ge.inventory.strike,'</span>\n                            </div>\n                            <div class="inventory-menu-item execute" data-item="execute" title="Instant victory!">\n                                <i class="fa-solid fa-star" style="color: #e74c3c;"></i>\n                                <span class="item-name">Death Blow</span>\n                                <span class="item-count" id="maze_inv_execute">').concat(Ge.inventory.execute,'</span>\n                            </div>\n                            <div class="inventory-menu-item" data-item="minionBane" title="Auto-defeat next minion">\n                                <i class="fa-solid fa-skull-crossbones" style="color: #8e44ad;"></i>\n                                <span class="item-name">Minion Bane</span>\n                                <span class="item-count" id="maze_inv_minionBane">').concat(Ge.inventory.minionBane,'</span>\n                            </div>\n                            <div class="inventory-menu-item" data-item="timeShard" title="Slow next battlebar by 50%">\n                                <i class="fa-solid fa-hourglass-half" style="color: #2980b9;"></i>\n                                <span class="item-name">Time Shard</span>\n                                <span class="item-count" id="maze_inv_timeShard">').concat(Ge.inventory.timeShard,'</span>\n                            </div>\n                        </div>\n                        \x3c!-- HP Items (v1.3.0) --\x3e\n                        <div class="inventory-menu-section hp-items-section" style="').concat(Ge.hpEnabled?"":"display:none;",'">\n                            <div class="inventory-menu-header">Healing & Restoration</div>\n                            <div class="inventory-menu-item" data-item="healingPotion" data-usable="true" data-hp-item="healingPotion" title="Restore 25% HP">\n                                <i class="fa-solid fa-flask" style="color: #e74c3c;"></i>\n                                <span class="item-name">Minor Elixir</span>\n                                <span class="item-count" id="maze_inv_healingPotion">').concat(Ge.inventory.healingPotion,'</span>\n                            </div>\n                            <div class="inventory-menu-item" data-item="greaterHealing" data-usable="true" data-hp-item="greaterHealing" title="Restore 50% HP">\n                                <i class="fa-solid fa-flask-vial" style="color: #9b59b6;"></i>\n                                <span class="item-name">Healing Draught</span>\n                                <span class="item-count" id="maze_inv_greaterHealing">').concat(Ge.inventory.greaterHealing,'</span>\n                            </div>\n                            <div class="inventory-menu-item" data-item="elixir" data-usable="true" data-hp-item="elixir" title="Full HP restore">\n                                <i class="fa-solid fa-wine-bottle" style="color: #f1c40f;"></i>\n                                <span class="item-name">Grand Elixir</span>\n                                <span class="item-count" id="maze_inv_elixir">').concat(Ge.inventory.elixir,'</span>\n                            </div>\n                            <div class="inventory-menu-item" data-item="revivalCharm" data-usable="true" data-hp-item="revivalCharm" title="Auto-resurrect on death">\n                                <i class="fa-solid fa-feather" style="color: #3498db;"></i>\n                                <span class="item-name">Phoenix Feather</span>\n                                <span class="item-count" id="maze_inv_revivalCharm">').concat(Ge.inventory.revivalCharm,'</span>\n                            </div>\n                            <div class="inventory-menu-item" data-item="heartCrystal" data-usable="true" data-hp-item="heartCrystal" title="+10 Max HP permanent">\n                                <i class="fa-solid fa-gem" style="color: #e91e63;"></i>\n                                <span class="item-name">Heart Crystal</span>\n                                <span class="item-count" id="maze_inv_heartCrystal">').concat(Ge.inventory.heartCrystal,'</span>\n                            </div>\n                        </div>\n                        \x3c!-- Visibility Items (v1.3.2) --\x3e\n                        <div class="inventory-menu-section vis-items-section">\n                            <div class="inventory-menu-header">Vision & Awareness</div>\n                            <div class="inventory-menu-item" data-item="torch" data-usable="true" data-vis-item="torch" title="Temporary +2 visibility (3 moves)">\n                                <i class="fa-solid fa-fire" style="color: #f39c12;"></i>\n                                <span class="item-name">Torch</span>\n                                <span class="item-count" id="maze_inv_torch">').concat(Ge.inventory.torch,'</span>\n                            </div>\n                            <div class="inventory-menu-item" data-item="lantern" title="Passive +1 visibility while held">\n                                <i class="fa-solid fa-lightbulb" style="color: #f1c40f;"></i>\n                                <span class="item-name">Lantern</span>\n                                <span class="item-count" id="maze_inv_lantern">').concat(Ge.inventory.lantern,'</span>\n                            </div>\n                            <div class="inventory-menu-item" data-item="revealScroll" data-usable="true" data-vis-item="revealScroll" title="Reveals entire floor for 1 move">\n                                <i class="fa-solid fa-scroll" style="color: #9b59b6;"></i>\n                                <span class="item-name">Reveal Scroll</span>\n                                <span class="item-count" id="maze_inv_revealScroll">').concat(Ge.inventory.revealScroll,'</span>\n                            </div>\n                            <div class="inventory-menu-item" data-item="sightPotion" data-usable="true" data-vis-item="sightPotion" title="Permanent +1 visibility">\n                                <i class="fa-solid fa-eye" style="color: #3498db;"></i>\n                                <span class="item-name">Sight Potion</span>\n                                <span class="item-count" id="maze_inv_sightPotion">').concat(Ge.inventory.sightPotion,'</span>\n                            </div>\n                            <div class="inventory-menu-item" data-item="crystalBall" data-usable="true" data-vis-item="crystalBall" title="Reveals all minions on floor">\n                                <i class="fa-solid fa-circle" style="color: #8e44ad;"></i>\n                                <span class="item-name">Crystal Ball</span>\n                                <span class="item-count" id="maze_inv_crystalBall">').concat(Ge.inventory.crystalBall,'</span>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n\n                \x3c!-- Session Memory Button (below inventory button) --\x3e\n                <div class="maze-memory-wrapper" id="maze_memory_wrapper">\n                    <button id="maze_memory_btn" class="maze-memory-btn" title="Session Notes">\n                        m\n                    </button>\n                </div>\n\n                \x3c!-- Session Memory Panel --\x3e\n                <div id="maze_memory_panel" class="maze-memory-panel" style="display: none;">\n                    <div class="maze-memory-header">\n                        <h3>Session Notes</h3>\n                        <button id="maze_memory_close" class="maze-memory-close">&times;</button>\n                    </div>\n                    <div class="maze-memory-content">\n                        <textarea id="maze_memory_textarea" class="maze-memory-textarea" placeholder="Write notes about your adventure...&#10;&#10;These notes are saved with this maze session."></textarea>\n                    </div>\n                    <div class="maze-memory-footer">\n                        <button id="maze_memory_save" class="maze-memory-save-btn">Save Notes</button>\n                    </div>\n                </div>\n                <div id="maze_memory_backdrop" class="maze-memory-backdrop" style="display: none;"></div>\n\n                \x3c!-- Encounter Actions (shows when needed) --\x3e\n                <div id="maze_encounter_confirm" class="maze-action-buttons">\n                    \x3c!-- Populated dynamically when encounter happens --\x3e\n                </div>\n\n                \x3c!-- BOTTOM PANEL: Map Area --\x3e\n                <div class="mazemaster-maze-bottom">\n                    <div class="mazemaster-maze-area">\n                        <div id="maze_grid_container" class="mazemaster-maze-grid-wrapper" style="position: relative;">\n                            \x3c!-- Renderer inserts grid/canvas here --\x3e\n                        </div>\n\n                        \x3c!-- HP Overlay (upper-right corner of map) --\x3e\n                        <div class="maze-hp-overlay" id="maze_hp_overlay" style="').concat(Ge.hpEnabled?"":"display:none;",'">\n                            <div class="hp-overlay-bar">\n                                <i class="fa-solid fa-heart"></i>\n                                <div class="hp-overlay-bar-bg">\n                                    <div class="hp-overlay-bar-fill high" id="maze_hp_bar" style="width: 100%;"></div>\n                                </div>\n                                <span class="hp-overlay-text">\n                                    <span id="maze_hp_current">').concat((null===(t=Ge.hp)||void 0===t?void 0:t.current)||100,'</span>/<span id="maze_hp_max">').concat(((null===(n=Ge.hp)||void 0===n?void 0:n.max)||100)+((null===(a=Ge.hp)||void 0===a?void 0:a.maxBonus)||0),'</span>\n                                </span>\n                            </div>\n                        </div>\n\n                        \x3c!-- Inventory Symbols Overlay (upper-left corner of map) --\x3e\n                        <div class="maze-inventory-overlay" id="maze_inventory_overlay">\n                            <div class="inv-overlay-item" data-item="key" title="Skeleton Key">\n                                <i class="fa-solid fa-key" style="color: #f1c40f;"></i>\n                                <span id="maze_ov_key">').concat(Ge.inventory.key,'</span>\n                            </div>\n                            <div class="inv-overlay-item" data-item="stealth" title="Shadow Cloak">\n                                <i class="fa-solid fa-user-ninja" style="color: #95a5a6;"></i>\n                                <span id="maze_ov_stealth">').concat(Ge.inventory.stealth,'</span>\n                            </div>\n                            <div class="inv-overlay-item" data-item="strike" title="Battle Surge">\n                                <i class="fa-solid fa-bolt" style="color: #f39c12;"></i>\n                                <span id="maze_ov_strike">').concat(Ge.inventory.strike,'</span>\n                            </div>\n                            <div class="inv-overlay-item execute" data-item="execute" title="Death Blow">\n                                <i class="fa-solid fa-star" style="color: #e74c3c;"></i>\n                                <span id="maze_ov_execute">').concat(Ge.inventory.execute,'</span>\n                            </div>\n                            <div class="inv-overlay-item" data-item="floorKey" title="Floor Key" style="').concat(Ge.totalFloors>1?"":"display:none;",'">\n                                <i class="fa-solid fa-stairs" style="color: #9b59b6;"></i>\n                                <span id="maze_ov_floorKey">').concat(Ge.inventory.floorKey,'</span>\n                            </div>\n                            <div class="inv-overlay-item" data-item="portalStone" title="Portal Stone">\n                                <i class="fa-solid fa-gem" style="color: #3498db;"></i>\n                                <span id="maze_ov_portalStone">').concat(Ge.inventory.portalStone,'</span>\n                            </div>\n                            <div class="inv-overlay-item" data-item="minionBane" title="Minion Bane">\n                                <i class="fa-solid fa-skull-crossbones" style="color: #8e44ad;"></i>\n                                <span id="maze_ov_minionBane">').concat(Ge.inventory.minionBane,'</span>\n                            </div>\n                            <div class="inv-overlay-item" data-item="mapFragment" title="Map Fragment">\n                                <i class="fa-solid fa-scroll" style="color: #e67e22;"></i>\n                                <span id="maze_ov_mapFragment">').concat(Ge.inventory.mapFragment,'</span>\n                            </div>\n                            <div class="inv-overlay-item" data-item="timeShard" title="Time Shard">\n                                <i class="fa-solid fa-hourglass-half" style="color: #2980b9;"></i>\n                                <span id="maze_ov_timeShard">').concat(Ge.inventory.timeShard,'</span>\n                            </div>\n                            <div class="inv-overlay-item" data-item="voidWalk" title="Void Walk">\n                                <i class="fa-solid fa-ghost" style="color: #1abc9c;"></i>\n                                <span id="maze_ov_voidWalk">').concat(Ge.inventory.voidWalk,'</span>\n                            </div>\n                            \x3c!-- HP Items --\x3e\n                            <div class="inv-overlay-item hp-item" data-item="healingPotion" title="Minor Elixir" style="').concat(Ge.hpEnabled?"":"display:none;",'">\n                                <i class="fa-solid fa-flask" style="color: #e74c3c;"></i>\n                                <span id="maze_ov_healingPotion">').concat(Ge.inventory.healingPotion,'</span>\n                            </div>\n                            <div class="inv-overlay-item hp-item" data-item="greaterHealing" title="Healing Draught" style="').concat(Ge.hpEnabled?"":"display:none;",'">\n                                <i class="fa-solid fa-flask-vial" style="color: #9b59b6;"></i>\n                                <span id="maze_ov_greaterHealing">').concat(Ge.inventory.greaterHealing,'</span>\n                            </div>\n                            <div class="inv-overlay-item hp-item" data-item="elixir" title="Grand Elixir" style="').concat(Ge.hpEnabled?"":"display:none;",'">\n                                <i class="fa-solid fa-wine-bottle" style="color: #f1c40f;"></i>\n                                <span id="maze_ov_elixir">').concat(Ge.inventory.elixir,'</span>\n                            </div>\n                            <div class="inv-overlay-item hp-item" data-item="revivalCharm" title="Phoenix Feather" style="').concat(Ge.hpEnabled?"":"display:none;",'">\n                                <i class="fa-solid fa-feather" style="color: #3498db;"></i>\n                                <span id="maze_ov_revivalCharm">').concat(Ge.inventory.revivalCharm,'</span>\n                            </div>\n                            <div class="inv-overlay-item hp-item" data-item="heartCrystal" title="Heart Crystal" style="').concat(Ge.hpEnabled?"":"display:none;",'">\n                                <i class="fa-solid fa-gem" style="color: #e91e63;"></i>\n                                <span id="maze_ov_heartCrystal">').concat(Ge.inventory.heartCrystal,'</span>\n                            </div>\n                            \x3c!-- Visibility Items --\x3e\n                            <div class="inv-overlay-item vis-item" data-item="torch" data-usable="true" title="Torch: +2 visibility for 3 moves">\n                                <i class="fa-solid fa-fire" style="color: #f39c12;"></i>\n                                <span id="maze_ov_torch">').concat(Ge.inventory.torch,'</span>\n                            </div>\n                            <div class="inv-overlay-item vis-item" data-item="lantern" title="Lantern: Passive +1 visibility">\n                                <i class="fa-solid fa-lightbulb" style="color: #f1c40f;"></i>\n                                <span id="maze_ov_lantern">').concat(Ge.inventory.lantern,'</span>\n                            </div>\n                            <div class="inv-overlay-item vis-item" data-item="revealScroll" data-usable="true" title="Reveal Scroll: Shows entire floor">\n                                <i class="fa-solid fa-scroll" style="color: #9b59b6;"></i>\n                                <span id="maze_ov_revealScroll">').concat(Ge.inventory.revealScroll,'</span>\n                            </div>\n                            <div class="inv-overlay-item vis-item" data-item="sightPotion" data-usable="true" title="Sight Potion: Permanent +1 visibility">\n                                <i class="fa-solid fa-eye" style="color: #3498db;"></i>\n                                <span id="maze_ov_sightPotion">').concat(Ge.inventory.sightPotion,'</span>\n                            </div>\n                            <div class="inv-overlay-item vis-item" data-item="crystalBall" data-usable="true" title="Crystal Ball: Reveals all minions">\n                                <i class="fa-solid fa-crystal-ball" style="color: #8e44ad;"></i>\n                                <span id="maze_ov_crystalBall">').concat(Ge.inventory.crystalBall,'</span>\n                            </div>\n                        </div>\n\n                        \x3c!-- Action Popup Overlay (for encounter buttons) - OUTSIDE grid container so it persists through re-renders --\x3e\n                        <div id="maze_action_popup" class="maze-action-popup" style="display: none;">\n                            <div class="maze-action-popup-content">\n                                <div id="maze_action_popup_buttons" class="maze-action-popup-buttons">\n                                    \x3c!-- Buttons populated dynamically --\x3e\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n\n                \x3c!-- Circular D-Pad (floating) --\x3e\n                <div id="maze_dpad" class="maze-dpad ').concat(!1!==(null===(o=Re.dpadConfig)||void 0===o?void 0:o.floating)?"floating":"",'"\n                     style="').concat(!1===(null===(i=Re.dpadConfig)||void 0===i?void 0:i.enabled)?"display: none;":"").concat(null!==(s=Re.dpadConfig)&&void 0!==s&&null!==(s=s.position)&&void 0!==s&&s.x?"left: ".concat(Re.dpadConfig.position.x,"px; top: ").concat(Re.dpadConfig.position.y,"px;"):"",'">\n                    <div class="dpad-ring">\n                        <button class="dpad-btn dpad-up" data-dir="up" title="Move Up (Arrow Up)">\n                            <i class="fa-solid fa-chevron-up"></i>\n                        </button>\n                        <button class="dpad-btn dpad-right" data-dir="right" title="Move Right (Arrow Right)">\n                            <i class="fa-solid fa-chevron-right"></i>\n                        </button>\n                        <button class="dpad-btn dpad-down" data-dir="down" title="Move Down (Arrow Down)">\n                            <i class="fa-solid fa-chevron-down"></i>\n                        </button>\n                        <button class="dpad-btn dpad-left" data-dir="left" title="Move Left (Arrow Left)">\n                            <i class="fa-solid fa-chevron-left"></i>\n                        </button>\n                        \x3c!-- Floor navigation buttons (shown when on staircase) --\x3e\n                        <button class="dpad-btn dpad-floor-up hidden" data-dir="floor-up" title="Go Up Floor (Shift+Up)">\n                            <i class="fa-solid fa-arrow-up"></i><span>UP</span>\n                        </button>\n                        <button class="dpad-btn dpad-floor-down hidden" data-dir="floor-down" title="Go Down Floor (Shift+Down)">\n                            <i class="fa-solid fa-arrow-down"></i><span>DN</span>\n                        </button>\n                    </div>\n                    <div class="dpad-center"></div>\n                    <div class="dpad-drag-handle" title="Drag to reposition">\n                        <i class="fa-solid fa-grip"></i>\n                    </div>\n                    \x3c!-- Rest button (HP system) - positioned safely away from directional buttons --\x3e\n                    <button id="maze_rest_btn" class="dpad-rest-btn" title="Rest to recover HP" style="display: none;">\n                        <i class="fa-solid fa-bed"></i>\n                        <span class="rest-cooldown-badge" style="display: none;"></span>\n                    </button>\n                </div>\n\n                \x3c!-- Close Button (shown on victory) --\x3e\n                <button id="maze_close_btn" class="menu_button menu_button_primary maze-close-btn" style="display: none;">\n                    <i class="fa-solid fa-check"></i> Close\n                </button>\n            </div>\n        </div>\n\n        <style>\n            .mazemaster-maze-overlay {\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                width: 100%;\n                height: 100%;\n                overflow-y: auto;\n                -webkit-overflow-scrolling: touch;\n            }\n\n            .mazemaster-maze-container {\n                position: relative;\n                display: flex;\n                flex-direction: column;\n                gap: 12px;\n                padding: 15px;\n                width: 90vw;\n                max-width: 1200px;\n                height: 94vh;\n                max-height: 960px;\n                margin: 10px;\n                background: #1a1a2e;\n                border-radius: 15px;\n                border: 2px solid #333;\n                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);\n                overflow: hidden;\n            }\n\n            /* Top Panel - Info & Controls */\n            .mazemaster-maze-top {\n                display: flex;\n                flex-direction: row;\n                gap: 16px;\n                flex-shrink: 0;\n                min-height: 240px;\n                height: 280px;\n            }\n\n            /* Left Column - Message Box, Stats, Inventory stacked */\n            .mazemaster-maze-left-column {\n                display: flex;\n                flex-direction: column;\n                gap: 8px;\n                width: 50.1%;\n                flex-shrink: 0;\n            }\n\n            /* Info Stack - Stats and Inventory */\n            .mazemaster-maze-info-stack {\n                display: flex;\n                flex-direction: column;\n                gap: 8px;\n                width: 100%;\n                position: relative;\n            }\n\n            /* ROOM INFO BOX - right side, full height */\n            .mazemaster-maze-room-info {\n                flex: 1;\n                margin-right: 46px; /* Space for power button */\n                background: rgba(0, 0, 0, 0.3);\n                border-radius: 8px;\n                padding: 10px 12px;\n                border: 1px solid #444;\n                display: flex;\n                flex-direction: column;\n            }\n\n            .room-info-content {\n                flex: 1;\n                display: flex;\n                flex-direction: column;\n                color: #aaa;\n                font-size: 0.9em;\n                gap: 8px;\n                overflow-y: auto;\n            }\n\n            .room-info-name {\n                font-size: 1.1em;\n                font-weight: 600;\n                color: #ecf0f1;\n                margin-bottom: 2px;\n            }\n\n            .room-info-desc {\n                font-style: italic;\n                color: #bdc3c7;\n                font-size: 0.9em;\n                line-height: 1.3;\n                padding-bottom: 8px;\n                border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n            }\n\n            .room-info-section {\n                display: flex;\n                flex-direction: column;\n                gap: 2px;\n            }\n\n            .room-info-label {\n                font-size: 0.75em;\n                color: #7f8c8d;\n                text-transform: uppercase;\n                display: flex;\n                align-items: center;\n                gap: 6px;\n            }\n\n            .room-info-label i {\n                font-size: 0.9em;\n                color: #3498db;\n            }\n\n            .room-info-section > div:last-child {\n                color: #ecf0f1;\n                font-size: 0.95em;\n            }\n\n            .maze-hero-text {\n                display: flex;\n                flex-direction: column;\n                flex: 1;\n                min-width: 0;\n            }\n\n            /* Power Button - Top Right Corner */\n            .maze-power-btn {\n                position: absolute;\n                top: 16px;\n                right: 10px;\n                width: 40px;\n                height: 40px;\n                border-radius: 50%;\n                border: 2px solid #e94560;\n                background: rgba(233, 69, 96, 0.2);\n                color: #e94560;\n                font-size: 18px;\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                transition: all 0.2s ease;\n                z-index: 100;\n            }\n\n            .maze-power-btn:hover {\n                background: #e94560;\n                color: #fff;\n                transform: scale(1.1);\n            }\n\n            /* Inventory Info Button - Below Power Button */\n            .maze-inventory-info-wrapper {\n                position: absolute;\n                top: 70px;\n                right: 10px;\n                z-index: 200;\n            }\n\n            .maze-inventory-info-wrapper.open {\n                z-index: 10100;\n            }\n\n            .maze-info-btn {\n                width: 40px;\n                height: 40px;\n                border-radius: 50%;\n                border: 2px solid #f1c40f;\n                background: rgba(241, 196, 15, 0.2);\n                color: #f1c40f;\n                font-size: 18px;\n                font-weight: bold;\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                transition: all 0.2s ease;\n            }\n\n            .maze-info-btn:hover {\n                background: #f1c40f;\n                color: #1a1a2e;\n                transform: scale(1.1);\n            }\n\n            .maze-inventory-info-wrapper.open .maze-info-btn {\n                background: #f1c40f;\n                color: #1a1a2e;\n            }\n\n            /* Session Memory Button - Below Inventory Button */\n            .maze-memory-wrapper {\n                position: absolute;\n                top: 124px;\n                right: 10px;\n                z-index: 200;\n            }\n\n            .maze-memory-btn {\n                width: 40px;\n                height: 40px;\n                border-radius: 50%;\n                border: 2px solid #5dade2;\n                background: rgba(93, 173, 226, 0.2);\n                color: #5dade2;\n                font-size: 20px;\n                font-weight: bold;\n                font-family: \'Georgia\', serif;\n                font-style: italic;\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                transition: all 0.2s ease;\n            }\n\n            .maze-memory-btn:hover {\n                background: #5dade2;\n                color: #1a1a2e;\n                transform: scale(1.1);\n            }\n\n            .maze-memory-btn.active {\n                background: #5dade2;\n                color: #1a1a2e;\n            }\n\n            /* Session Memory Panel */\n            .maze-memory-panel {\n                position: fixed;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                width: 90%;\n                max-width: 500px;\n                max-height: 80vh;\n                background: rgba(20, 25, 35, 0.98);\n                border: 2px solid #5dade2;\n                border-radius: 12px;\n                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8);\n                z-index: 10200;\n                display: flex;\n                flex-direction: column;\n            }\n\n            .maze-memory-panel.hidden {\n                display: none;\n            }\n\n            .maze-memory-header {\n                display: flex;\n                justify-content: space-between;\n                align-items: center;\n                padding: 12px 16px;\n                border-bottom: 1px solid rgba(93, 173, 226, 0.3);\n                background: rgba(93, 173, 226, 0.1);\n                border-radius: 10px 10px 0 0;\n            }\n\n            .maze-memory-header h3 {\n                margin: 0;\n                color: #5dade2;\n                font-size: 16px;\n                display: flex;\n                align-items: center;\n                gap: 8px;\n            }\n\n            .maze-memory-close {\n                background: none;\n                border: none;\n                color: #888;\n                font-size: 20px;\n                cursor: pointer;\n                padding: 4px 8px;\n                transition: color 0.2s;\n            }\n\n            .maze-memory-close:hover {\n                color: #e74c3c;\n            }\n\n            .maze-memory-content {\n                flex: 1;\n                padding: 16px;\n                overflow-y: auto;\n            }\n\n            .maze-memory-textarea {\n                width: 100%;\n                height: 300px;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid rgba(93, 173, 226, 0.3);\n                border-radius: 8px;\n                color: #e0e0e0;\n                font-family: \'Segoe UI\', Tahoma, sans-serif;\n                font-size: 14px;\n                line-height: 1.5;\n                padding: 12px;\n                resize: vertical;\n            }\n\n            .maze-memory-textarea:focus {\n                outline: none;\n                border-color: #5dade2;\n            }\n\n            .maze-memory-textarea::placeholder {\n                color: #666;\n                font-style: italic;\n            }\n\n            .maze-memory-footer {\n                padding: 12px 16px;\n                border-top: 1px solid rgba(93, 173, 226, 0.2);\n                display: flex;\n                justify-content: flex-end;\n                gap: 10px;\n            }\n\n            .maze-memory-save-btn {\n                background: linear-gradient(135deg, #5dade2 0%, #3498db 100%);\n                border: none;\n                color: white;\n                padding: 8px 20px;\n                border-radius: 6px;\n                cursor: pointer;\n                font-weight: bold;\n                transition: transform 0.2s, box-shadow 0.2s;\n            }\n\n            .maze-memory-save-btn:hover {\n                transform: scale(1.05);\n                box-shadow: 0 4px 12px rgba(93, 173, 226, 0.4);\n            }\n\n            .maze-memory-backdrop {\n                position: fixed;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                background: rgba(0, 0, 0, 0.6);\n                z-index: 10199;\n            }\n\n            .maze-memory-backdrop.hidden {\n                display: none;\n            }\n\n            /* Inventory Dropdown from Info Button */\n            .maze-inventory-dropdown {\n                position: absolute;\n                top: calc(100% + 8px);\n                right: 0;\n                min-width: 220px;\n                max-height: 70vh;\n                overflow-y: auto;\n                background: rgba(20, 25, 35, 0.98);\n                border: 1px solid rgba(241, 196, 15, 0.3);\n                border-radius: 10px;\n                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);\n                backdrop-filter: blur(10px);\n                z-index: 10100;\n            }\n\n            .maze-inventory-dropdown.hidden {\n                display: none;\n            }\n\n            .maze-inventory-dropdown .inventory-menu-section {\n                padding: 8px 0;\n                border-bottom: 1px solid rgba(255, 255, 255, 0.08);\n            }\n\n            .maze-inventory-dropdown .inventory-menu-section:last-child {\n                border-bottom: none;\n            }\n\n            .maze-inventory-dropdown .inventory-menu-header {\n                padding: 4px 12px 6px;\n                font-size: 0.7em;\n                text-transform: uppercase;\n                letter-spacing: 0.5px;\n                color: #f1c40f;\n                font-weight: 600;\n            }\n\n            .maze-inventory-dropdown .inventory-menu-item {\n                display: flex;\n                align-items: center;\n                gap: 10px;\n                padding: 8px 12px;\n                cursor: pointer;\n                transition: background 0.15s ease;\n            }\n\n            .maze-inventory-dropdown .inventory-menu-item:hover {\n                background: rgba(255, 255, 255, 0.08);\n            }\n\n            .maze-inventory-dropdown .inventory-menu-item[data-usable="true"]:hover {\n                background: rgba(46, 204, 113, 0.15);\n            }\n\n            .maze-inventory-dropdown .inventory-menu-item i {\n                font-size: 14px;\n                width: 18px;\n                text-align: center;\n            }\n\n            .maze-inventory-dropdown .inventory-menu-item .item-name {\n                flex: 1;\n                font-size: 0.85em;\n                color: #ecf0f1;\n            }\n\n            .maze-inventory-dropdown .inventory-menu-item .item-count {\n                font-size: 0.85em;\n                font-weight: 600;\n                color: #f1c40f;\n                min-width: 20px;\n                text-align: right;\n            }\n\n            .maze-inventory-dropdown .inventory-menu-item.execute .item-name {\n                color: #e74c3c;\n            }\n\n            .maze-inventory-dropdown .inventory-menu-item.execute .item-count {\n                color: #e74c3c;\n            }\n\n            /* Save Dialog */\n            #maze_save_dialog {\n                position: absolute;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                z-index: 1000;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n            }\n\n            .maze-save-dialog-backdrop {\n                position: absolute;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                background: rgba(0, 0, 0, 0.7);\n            }\n\n            .maze-save-dialog-content {\n                position: relative;\n                background: #1a1a2e;\n                border: 2px solid #4a90d9;\n                border-radius: 12px;\n                padding: 24px 32px;\n                text-align: center;\n                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);\n            }\n\n            .maze-save-dialog-title {\n                color: #fff;\n                font-size: 18px;\n                font-weight: 600;\n                margin-bottom: 20px;\n            }\n\n            .maze-save-dialog-buttons {\n                display: flex;\n                gap: 12px;\n                justify-content: center;\n            }\n\n            .maze-save-btn {\n                padding: 10px 24px;\n                border-radius: 6px;\n                border: none;\n                font-size: 14px;\n                font-weight: 600;\n                cursor: pointer;\n                transition: all 0.2s ease;\n            }\n\n            .maze-save-yes {\n                background: #27ae60;\n                color: #fff;\n            }\n\n            .maze-save-yes:hover {\n                background: #2ecc71;\n            }\n\n            .maze-save-no {\n                background: #e74c3c;\n                color: #fff;\n            }\n\n            .maze-save-no:hover {\n                background: #c0392b;\n            }\n\n            .maze-save-cancel {\n                background: #7f8c8d;\n                color: #fff;\n            }\n\n            .maze-save-cancel:hover {\n                background: #95a5a6;\n            }\n\n            /* Bottom Panel - Map Area */\n            .mazemaster-maze-bottom {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                justify-content: flex-end;\n                flex: 1;\n                min-height: 200px;\n                padding-bottom: 15px;\n                overflow: auto;\n            }\n\n            /* Hero Section - Minion Area (fills remaining height) */\n            .mazemaster-maze-hero {\n                display: flex;\n                flex-direction: column;\n                flex: 1;\n                width: 100%;\n                background: rgba(0, 0, 0, 0.3);\n                border-radius: 8px;\n                padding: 10px 12px;\n                border: 1px solid #444;\n                min-height: 80px;\n            }\n\n            .maze-minion-name {\n                font-weight: bold;\n                font-size: 1.2em;\n                color: #e94560;\n                flex-shrink: 0;\n                margin-bottom: 0;\n            }\n\n            .maze-minion-role {\n                font-size: 0.8em;\n                color: #f1c40f;\n                flex-shrink: 0;\n                margin-bottom: 4px;\n            }\n\n            .mazemaster-maze-hero-content {\n                display: flex;\n                gap: 10px;\n                align-items: flex-start;\n                flex: 1;\n            }\n\n            .mazemaster-maze-hero-avatar {\n                width: 72px;\n                height: 72px;\n                min-width: 72px;\n                flex-shrink: 0;\n                border-radius: 6px;\n                overflow: hidden;\n                background: #16213e;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                position: relative;\n            }\n\n            .mazemaster-maze-hero-avatar img {\n                width: 100%;\n                height: 100%;\n                object-fit: cover;\n                object-position: center top;\n                display: block;\n            }\n\n            /* LLM Generating Indicator - overlays the entire image */\n            .maze-generating-indicator {\n                position: absolute;\n                top: 0;\n                left: 0;\n                right: 0;\n                bottom: 0;\n                background: rgba(52, 152, 219, 0.7);\n                border-radius: 8px;\n                display: none;\n                align-items: center;\n                justify-content: center;\n                z-index: 10;\n            }\n\n            .maze-generating-indicator.active {\n                display: flex;\n            }\n\n            .maze-generating-indicator i {\n                color: #fff;\n                font-size: 32px;\n                animation: maze-pulse 1s ease-in-out infinite;\n                text-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);\n            }\n\n            @keyframes maze-pulse {\n                0%, 100% { transform: scale(1); opacity: 1; }\n                50% { transform: scale(1.2); opacity: 0.7; }\n            }\n\n            .maze-message-log {\n                flex: 1;\n                color: #eee;\n                line-height: 1.4;\n                font-size: 0.9em;\n                overflow-y: auto;\n                max-height: 120px;\n                display: flex;\n                flex-direction: column;\n                gap: 4px;\n                padding-right: 4px;\n            }\n\n            .maze-message-log::-webkit-scrollbar {\n                width: 6px;\n            }\n\n            .maze-message-log::-webkit-scrollbar-track {\n                background: rgba(0, 0, 0, 0.2);\n                border-radius: 3px;\n            }\n\n            .maze-message-log::-webkit-scrollbar-thumb {\n                background: rgba(255, 255, 255, 0.3);\n                border-radius: 3px;\n            }\n\n            .maze-message-log::-webkit-scrollbar-thumb:hover {\n                background: rgba(255, 255, 255, 0.5);\n            }\n\n            .maze-message-entry {\n                padding: 4px 8px;\n                background: rgba(0, 0, 0, 0.2);\n                border-radius: 6px;\n                border-left: 3px solid rgba(52, 152, 219, 0.6);\n            }\n\n            .maze-message-entry:last-child {\n                border-left-color: rgba(46, 204, 113, 0.8);\n            }\n\n            .maze-message-speaker {\n                font-weight: 600;\n                color: #3498db;\n                font-size: 0.85em;\n                margin-bottom: 2px;\n            }\n\n            .maze-message-text {\n                font-style: italic;\n                color: #ecf0f1;\n            }\n\n            /* Stats Bar */\n            .mazemaster-maze-stats-bar {\n                display: flex;\n                justify-content: center;\n                flex-wrap: wrap;\n                gap: 12px;\n                width: 100%;\n                padding: 6px 12px;\n                background: linear-gradient(135deg, rgba(52, 73, 94, 0.4) 0%, rgba(44, 62, 80, 0.4) 100%);\n                border-radius: 8px;\n                border: 1px solid rgba(255, 255, 255, 0.1);\n            }\n\n            .stats-item {\n                display: flex;\n                align-items: center;\n                gap: 6px;\n                font-size: 0.85em;\n                color: #bdc3c7;\n            }\n\n            .stats-item i {\n                color: #3498db;\n                font-size: 0.9em;\n            }\n\n            .stats-item span {\n                font-weight: 500;\n                color: #ecf0f1;\n            }\n\n            /* HP Bar Styles (v1.3.0) */\n            .stats-hp {\n                min-width: 120px;\n            }\n\n            .hp-bar-container {\n                position: relative;\n                width: 80px;\n                height: 16px;\n                background: rgba(0, 0, 0, 0.4);\n                border-radius: 8px;\n                overflow: hidden;\n                border: 1px solid rgba(255, 255, 255, 0.2);\n            }\n\n            .hp-bar-fill {\n                position: absolute;\n                top: 0;\n                left: 0;\n                height: 100%;\n                background: linear-gradient(90deg, #27ae60, #1e8449);\n                transition: width 0.3s ease, background 0.3s ease;\n                border-radius: 8px;\n            }\n\n            .hp-bar-fill.low {\n                background: linear-gradient(90deg, #e74c3c, #c0392b);\n                animation: hp-pulse 1s infinite;\n            }\n\n            .hp-bar-fill.medium {\n                background: linear-gradient(90deg, #f39c12, #d68910);\n            }\n\n            .hp-bar-fill.high {\n                background: linear-gradient(90deg, #27ae60, #1e8449);\n            }\n\n            .hp-bar-text {\n                position: absolute;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                font-size: 0.7em;\n                font-weight: 600;\n                color: #fff;\n                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);\n                white-space: nowrap;\n            }\n\n            @keyframes hp-pulse {\n                0%, 100% { opacity: 1; }\n                50% { opacity: 0.6; }\n            }\n\n            /* Damage/Heal Flash Effects */\n            .maze-hp-flash {\n                position: fixed;\n                inset: 0;\n                pointer-events: none;\n                z-index: 9999;\n                animation: hp-flash 0.3s ease-out forwards;\n            }\n\n            .maze-hp-flash.damage {\n                background: radial-gradient(circle, rgba(231, 76, 60, 0.3) 0%, transparent 70%);\n            }\n\n            .maze-hp-flash.heal {\n                background: radial-gradient(circle, rgba(46, 204, 113, 0.3) 0%, transparent 70%);\n            }\n\n            @keyframes hp-flash {\n                from { opacity: 1; }\n                to { opacity: 0; }\n            }\n\n            /* Low HP Warning Border */\n            .mazemaster-maze-container.low-hp {\n                animation: low-hp-border 2s infinite;\n            }\n\n            @keyframes low-hp-border {\n                0%, 100% { box-shadow: inset 0 0 0 2px transparent; }\n                50% { box-shadow: inset 0 0 0 2px #e74c3c; }\n            }\n\n            /* ============================================= */\n            /* HP OVERLAY (upper-right of map) */\n            /* ============================================= */\n            .maze-hp-overlay {\n                position: absolute;\n                top: 8px;\n                right: 8px;\n                z-index: 100;\n                pointer-events: none;\n            }\n\n            .hp-overlay-bar {\n                display: flex;\n                align-items: center;\n                gap: 6px;\n                padding: 6px 10px;\n                background: rgba(0, 0, 0, 0.6);\n                border-radius: 20px;\n                backdrop-filter: blur(4px);\n                border: 1px solid rgba(255, 255, 255, 0.15);\n            }\n\n            .hp-overlay-bar > i {\n                color: #e74c3c;\n                font-size: 14px;\n            }\n\n            .hp-overlay-bar-bg {\n                position: relative;\n                width: 70px;\n                height: 12px;\n                background: rgba(0, 0, 0, 0.5);\n                border-radius: 6px;\n                overflow: hidden;\n            }\n\n            .hp-overlay-bar-fill {\n                position: absolute;\n                top: 0;\n                left: 0;\n                height: 100%;\n                border-radius: 6px;\n                transition: width 0.3s ease, background 0.3s ease;\n            }\n\n            .hp-overlay-bar-fill.high {\n                background: linear-gradient(90deg, #27ae60, #2ecc71);\n            }\n\n            .hp-overlay-bar-fill.medium {\n                background: linear-gradient(90deg, #f39c12, #f1c40f);\n            }\n\n            .hp-overlay-bar-fill.low {\n                background: linear-gradient(90deg, #c0392b, #e74c3c);\n                animation: hp-pulse 1s infinite;\n            }\n\n            .hp-overlay-text {\n                font-size: 11px;\n                font-weight: 600;\n                color: #fff;\n                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);\n                white-space: nowrap;\n                min-width: 45px;\n                text-align: center;\n            }\n\n            /* ============================================= */\n            /* INVENTORY OVERLAY (upper-left of map) */\n            /* ============================================= */\n            .maze-inventory-overlay {\n                position: absolute;\n                top: 8px;\n                left: 8px;\n                z-index: 100;\n                display: flex;\n                flex-direction: column;\n                gap: 4px;\n                pointer-events: none;\n            }\n\n            .inv-overlay-item {\n                display: flex;\n                align-items: center;\n                gap: 4px;\n                padding: 4px 8px;\n                background: rgba(0, 0, 0, 0.6);\n                border-radius: 12px;\n                backdrop-filter: blur(4px);\n                border: 1px solid rgba(255, 255, 255, 0.1);\n                font-size: 12px;\n            }\n\n            .inv-overlay-item i {\n                font-size: 12px;\n                width: 14px;\n                text-align: center;\n            }\n\n            .inv-overlay-item span {\n                font-weight: 600;\n                color: #fff;\n                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);\n                min-width: 16px;\n                text-align: center;\n            }\n\n            .inv-overlay-item.execute {\n                border-color: rgba(231, 76, 60, 0.4);\n            }\n\n            .inv-overlay-item.execute i {\n                animation: star-glow 2s ease-in-out infinite;\n            }\n\n            @keyframes star-glow {\n                0%, 100% { filter: drop-shadow(0 0 2px #e74c3c); }\n                50% { filter: drop-shadow(0 0 6px #e74c3c); }\n            }\n\n            /* Hide items with 0 count */\n            .inv-overlay-item span:empty,\n            .inv-overlay-item[data-count="0"] {\n                display: none;\n            }\n\n            /* Objectives Section */\n            .maze-objectives-section {\n                width: 550px;\n                max-width: 95vw;\n                padding: 8px 12px;\n                background: linear-gradient(135deg, rgba(52, 73, 94, 0.4) 0%, rgba(44, 62, 80, 0.4) 100%);\n                border-radius: 8px;\n                border: 1px solid rgba(255, 255, 255, 0.1);\n            }\n\n            .maze-objectives-section.hidden {\n                display: none;\n            }\n\n            .maze-objectives-section .objectives-header {\n                display: flex;\n                align-items: center;\n                gap: 6px;\n                font-size: 0.8em;\n                color: #95a5a6;\n                margin-bottom: 6px;\n            }\n\n            .maze-objectives-section .objectives-list {\n                display: flex;\n                flex-direction: column;\n                gap: 4px;\n            }\n\n            .maze-objectives-section .objective-item {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                font-size: 0.85em;\n                padding: 4px 8px;\n                background: rgba(0, 0, 0, 0.2);\n                border-radius: 4px;\n            }\n\n            .maze-objectives-section .objective-item i {\n                font-size: 0.9em;\n            }\n\n            .maze-objectives-section .objective-description {\n                flex: 1;\n            }\n\n            .maze-objectives-section .objective-progress {\n                font-weight: 500;\n                font-size: 0.9em;\n            }\n\n            .maze-objectives-section .objective-required i {\n                color: #e74c3c;\n            }\n\n            .maze-objectives-section .objective-optional i {\n                color: #95a5a6;\n            }\n\n            .maze-objectives-section .objective-complete {\n                opacity: 0.7;\n            }\n\n            .maze-objectives-section .objective-complete i {\n                color: #27ae60 !important;\n            }\n\n            .maze-objectives-section.objectives-flash {\n                animation: objectives-flash-anim 0.5s ease-out;\n            }\n\n            @keyframes objectives-flash-anim {\n                0%, 100% {\n                    border-color: rgba(255, 255, 255, 0.1);\n                }\n                50% {\n                    border-color: #e74c3c;\n                    box-shadow: 0 0 10px rgba(231, 76, 60, 0.5);\n                }\n            }\n\n            /* Player Overlay for Smooth Movement Animation */\n            .maze-player-overlay {\n                position: absolute;\n                top: 2px;\n                left: 2px;\n                pointer-events: none;\n                z-index: 10;\n                transition: transform 0.15s ease-out;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n            }\n\n            .maze-player-marker {\n                width: 60%;\n                height: 60%;\n                background: radial-gradient(circle, #4ecdc4 0%, #2d8f8f 100%);\n                border-radius: 50%;\n                box-shadow: 0 0 10px rgba(78, 205, 196, 0.6), 0 0 20px rgba(78, 205, 196, 0.3);\n                animation: player-pulse 1.5s ease-in-out infinite;\n            }\n\n            @keyframes player-pulse {\n                0%, 100% { transform: scale(1); opacity: 1; }\n                50% { transform: scale(1.1); opacity: 0.9; }\n            }\n\n            .maze-player-overlay.teleporting .maze-player-marker {\n                animation: teleport-flash 0.2s ease-out;\n            }\n\n            @keyframes teleport-flash {\n                0% { opacity: 1; transform: scale(1); }\n                50% { opacity: 0; transform: scale(0.2); }\n                100% { opacity: 1; transform: scale(1); }\n            }\n\n            /* Control Bar */\n            .maze-action-buttons {\n                display: flex;\n                gap: 6px;\n                justify-content: center;\n                flex-wrap: wrap;\n            }\n\n            .mazemaster-maze-inventory {\n                display: flex;\n                flex-wrap: wrap;\n                justify-content: space-evenly;\n                background: rgba(0, 0, 0, 0.3);\n                padding: 8px 12px;\n                border-radius: 6px;\n            }\n\n            .inventory-item {\n                display: flex;\n                align-items: center;\n                gap: 4px;\n                font-size: 0.9em;\n            }\n\n            /* Inventory item icon colors */\n            .inventory-item i.fa-key { color: #f1c40f; }\n            .inventory-item i.fa-user-ninja { color: #9b59b6; }\n            .inventory-item i.fa-bolt { color: #e74c3c; }\n            .inventory-item.execute i { color: #ffd700; text-shadow: 0 0 4px #ffd700; }\n            .inventory-item.floor-key i { color: #3498db; }\n            .inventory-item.portal-stone i { color: #9b59b6; }\n            .inventory-item.minion-bane i { color: #c0392b; }\n            .inventory-item.map-fragment i { color: #27ae60; }\n            .inventory-item.time-shard i { color: #f39c12; }\n            .inventory-item.void-walk i { color: #7f8c8d; }\n\n            /* Inventory expand icon */\n            .inventory-expand-icon {\n                margin-left: auto;\n                padding-left: 8px;\n                color: #888;\n                cursor: pointer;\n                transition: transform 0.2s;\n            }\n            .mazemaster-maze-inventory.expanded .inventory-expand-icon {\n                transform: rotate(180deg);\n            }\n            .mazemaster-maze-inventory {\n                cursor: pointer;\n            }\n\n            /* Inventory Drawer */\n            .maze-inventory-drawer {\n                position: absolute;\n                top: 100%;\n                left: 0;\n                right: 0;\n                background: rgba(26, 26, 46, 0.98);\n                border: 1px solid #444;\n                border-top: none;\n                border-radius: 0 0 8px 8px;\n                padding: 10px 12px;\n                z-index: 200;\n                max-height: 300px;\n                overflow-y: auto;\n                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);\n            }\n            .maze-inventory-drawer.hidden {\n                display: none;\n            }\n            .inventory-drawer-content {\n                display: flex;\n                flex-direction: column;\n                gap: 6px;\n            }\n            .inventory-drawer-item {\n                display: flex;\n                align-items: center;\n                gap: 10px;\n                padding: 6px 8px;\n                background: rgba(255, 255, 255, 0.05);\n                border-radius: 4px;\n            }\n            .inventory-drawer-item.empty {\n                opacity: 0.4;\n            }\n            .inventory-drawer-item i {\n                width: 20px;\n                text-align: center;\n            }\n            .inventory-drawer-item .item-name {\n                flex: 1;\n                font-size: 0.9em;\n            }\n            .inventory-drawer-item .item-count {\n                font-weight: bold;\n                min-width: 24px;\n                text-align: right;\n            }\n            /* Drawer item icon colors - match the bar */\n            .inventory-drawer-item i.fa-key { color: #f1c40f; }\n            .inventory-drawer-item i.fa-user-ninja { color: #9b59b6; }\n            .inventory-drawer-item i.fa-bolt { color: #e74c3c; }\n            .inventory-drawer-item.execute i { color: #ffd700; text-shadow: 0 0 4px #ffd700; }\n            .inventory-drawer-item.floor-key i { color: #3498db; }\n            .inventory-drawer-item.portal-stone i { color: #9b59b6; }\n            .inventory-drawer-item.minion-bane i { color: #c0392b; }\n            .inventory-drawer-item.map-fragment i { color: #27ae60; }\n            .inventory-drawer-item.time-shard i { color: #f39c12; }\n            .inventory-drawer-item.void-walk i { color: #7f8c8d; }\n\n            /* Usable items have click cursor and glow */\n            .inventory-item[data-usable="true"] {\n                cursor: pointer;\n                transition: transform 0.2s, box-shadow 0.2s;\n            }\n            .inventory-item[data-usable="true"]:hover {\n                transform: scale(1.1);\n                text-shadow: 0 0 8px currentColor;\n            }\n            .inventory-item.hidden { display: none; }\n\n            .mazemaster-maze-save-exit {\n                display: flex;\n                gap: 8px;\n                justify-content: center;\n                margin-top: auto;\n                padding-top: 10px;\n            }\n\n            /* Maze Area */\n            .mazemaster-maze-area {\n                position: relative; /* Required for action popup overlay positioning */\n                width: 100%;\n                height: 100%;\n                overflow: hidden;\n                cursor: grab;\n                user-select: none;\n                background: #0a0a1a;\n                border-radius: 8px;\n            }\n\n            .mazemaster-maze-grid-wrapper {\n                position: absolute;\n                top: 0;\n                left: 0;\n                /* Position controlled by JS transforms */\n            }\n\n            /* Circular D-Pad */\n            .maze-dpad {\n                position: absolute;\n                bottom: 60px;\n                right: 20px;\n                width: 140px;\n                height: 140px;\n                z-index: 100;\n            }\n\n            .maze-dpad.floating {\n                position: fixed;\n                z-index: 10001;\n                bottom: 20px;\n                right: 20px;\n            }\n\n            .dpad-ring {\n                position: relative;\n                width: 100%;\n                height: 100%;\n                border-radius: 50%;\n                background: radial-gradient(circle, #2c3e50 0%, #1a1a2e 100%);\n                border: 3px solid var(--theme-primary, #3498db);\n                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);\n            }\n\n            .dpad-btn {\n                position: absolute;\n                width: 40px;\n                height: 40px;\n                border-radius: 50%;\n                background: linear-gradient(to bottom, var(--theme-primary, #3498db), var(--theme-secondary, #2980b9));\n                border: 2px solid var(--theme-accent, #5dade2);\n                color: white;\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                transition: all 0.15s;\n                font-size: 1em;\n            }\n\n            .dpad-btn:hover {\n                filter: brightness(1.2);\n            }\n\n            .dpad-btn:active {\n                filter: brightness(0.9);\n            }\n\n            .dpad-up { top: 5px; left: 50%; transform: translateX(-50%); }\n            .dpad-up:hover { transform: translateX(-50%) scale(1.1); }\n            .dpad-up:active { transform: translateX(-50%) scale(0.95); }\n\n            .dpad-right { right: 5px; top: 50%; transform: translateY(-50%); }\n            .dpad-right:hover { transform: translateY(-50%) scale(1.1); }\n            .dpad-right:active { transform: translateY(-50%) scale(0.95); }\n\n            .dpad-down { bottom: 5px; left: 50%; transform: translateX(-50%); }\n            .dpad-down:hover { transform: translateX(-50%) scale(1.1); }\n            .dpad-down:active { transform: translateX(-50%) scale(0.95); }\n\n            .dpad-left { left: 5px; top: 50%; transform: translateY(-50%); }\n            .dpad-left:hover { transform: translateY(-50%) scale(1.1); }\n            .dpad-left:active { transform: translateY(-50%) scale(0.95); }\n\n            .dpad-center {\n                position: absolute;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                width: 30px;\n                height: 30px;\n                border-radius: 50%;\n                background: #1a1a2e;\n                border: 2px solid #34495e;\n            }\n\n            /* Floor navigation buttons - appear on LEFT side of D-pad when on stairs */\n            .dpad-floor-up, .dpad-floor-down {\n                position: absolute;\n                width: 36px;\n                height: 36px;\n                border-radius: 8px;\n                font-size: 0.65em;\n                background: linear-gradient(to bottom, #27ae60, #1e8449);\n                border: 2px solid #2ecc71;\n                flex-direction: column;\n                gap: 1px;\n                z-index: 10;\n                box-shadow: 0 2px 8px rgba(46, 204, 113, 0.5);\n                left: -50px;\n            }\n\n            .dpad-floor-up {\n                top: 15px;\n            }\n            .dpad-floor-up:hover {\n                transform: scale(1.1);\n                box-shadow: 0 4px 12px rgba(46, 204, 113, 0.7);\n            }\n            .dpad-floor-up:active {\n                transform: scale(0.95);\n            }\n\n            .dpad-floor-down {\n                bottom: 15px;\n                background: linear-gradient(to bottom, #e67e22, #d35400);\n                border-color: #f39c12;\n                box-shadow: 0 2px 8px rgba(243, 156, 18, 0.5);\n            }\n            .dpad-floor-down:hover {\n                transform: scale(1.1);\n                box-shadow: 0 4px 12px rgba(243, 156, 18, 0.7);\n            }\n            .dpad-floor-down:active {\n                transform: scale(0.95);\n            }\n\n            .dpad-floor-up.hidden, .dpad-floor-down.hidden {\n                display: none !important;\n            }\n\n            .dpad-floor-up span, .dpad-floor-down span {\n                font-size: 0.65em;\n                font-weight: bold;\n            }\n\n            .dpad-drag-handle {\n                position: absolute;\n                bottom: -22px;\n                left: 50%;\n                transform: translateX(-50%);\n                padding: 3px 8px;\n                background: rgba(0, 0, 0, 0.5);\n                border-radius: 4px;\n                color: #666;\n                font-size: 0.75em;\n                cursor: grab;\n                display: none;\n            }\n\n            .maze-dpad.floating .dpad-drag-handle {\n                display: block;\n            }\n\n            .maze-dpad:not(.floating) .dpad-drag-handle {\n                display: none;\n            }\n\n            /* Rest button - positioned top-right corner, away from directional buttons */\n            .dpad-rest-btn {\n                position: absolute;\n                top: -15px;\n                right: -15px;\n                width: 36px;\n                height: 36px;\n                border-radius: 50%;\n                background: linear-gradient(135deg, #14b8a6, #0d9488);\n                border: 2px solid #2dd4bf;\n                color: #fff;\n                font-size: 14px;\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                box-shadow: 0 2px 8px rgba(20, 184, 166, 0.4);\n                transition: all 0.2s ease;\n                z-index: 10;\n            }\n\n            .dpad-rest-btn:hover:not(:disabled) {\n                transform: scale(1.1);\n                box-shadow: 0 4px 12px rgba(20, 184, 166, 0.6);\n            }\n\n            .dpad-rest-btn:active:not(:disabled) {\n                transform: scale(0.95);\n            }\n\n            .dpad-rest-btn:disabled {\n                background: linear-gradient(135deg, #6b7280, #4b5563);\n                border-color: #9ca3af;\n                cursor: not-allowed;\n                opacity: 0.7;\n            }\n\n            .dpad-rest-btn .rest-cooldown-badge {\n                position: absolute;\n                bottom: -4px;\n                right: -4px;\n                min-width: 16px;\n                height: 16px;\n                padding: 0 4px;\n                background: #ef4444;\n                border-radius: 8px;\n                font-size: 10px;\n                font-weight: bold;\n                color: #fff;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n            }\n\n            /* Void Walk active indicator */\n            .maze-dpad.void-walk-active .dpad-ring {\n                animation: void-walk-pulse 1s infinite;\n                border-color: #7f8c8d;\n            }\n            .maze-dpad.void-walk-active .dpad-btn {\n                background: linear-gradient(to bottom, #7f8c8d, #5d6d7e);\n                border-color: #95a5a6;\n            }\n            @keyframes void-walk-pulse {\n                0%, 100% { box-shadow: 0 4px 15px rgba(127, 140, 141, 0.5); }\n                50% { box-shadow: 0 4px 25px rgba(127, 140, 141, 0.8); }\n            }\n\n            .mazemaster-maze-grid {\n                display: grid;\n                gap: 0;\n                background: #333;\n                padding: 2px;\n                border-radius: 5px;\n                border: 2px solid #555;\n            }\n\n            .maze-cell {\n                width: ').concat(c,"px;\n                height: ").concat(c,"px;\n                background: #1a1a2e;\n                position: relative;\n                box-sizing: border-box;\n            }\n\n            .maze-cell.hidden {\n                background: #0a0a0a;\n            }\n\n            .maze-cell.completely-hidden {\n                background: transparent;\n                border: none !important;\n                visibility: hidden;\n            }\n\n            .maze-cell.wall-top { border-top: 2px solid #fff; }\n            .maze-cell.wall-right { border-right: 2px solid #fff; }\n            .maze-cell.wall-bottom { border-bottom: 2px solid #fff; }\n            .maze-cell.wall-left { border-left: 2px solid #fff; }\n\n            /* Player marker now handled by .maze-player-overlay for smooth animation */\n            .maze-cell.player {\n                /* Player position cell styling - marker is in overlay */\n            }\n\n            .maze-cell.exit::before {\n                content: '';\n                position: absolute;\n                top: 50%; left: 50%;\n                transform: translate(-50%, -50%);\n                width: 70%; height: 70%;\n                background: #27ae60;\n                border-radius: 3px;\n            }\n\n            .maze-cell.visited:not(.hidden) {\n                background: #1e2a4a;\n            }\n\n            /* Legacy arrow buttons (kept for backwards compatibility) */\n            .maze-arrow-btn {\n                display: none; /* Hide legacy buttons */\n            }\n\n            /* Action buttons */\n            .maze-action-btn {\n                padding: 8px 14px;\n                font-size: 0.85em;\n                border-radius: 5px;\n                display: inline-flex;\n                align-items: center;\n                justify-content: center;\n                gap: 6px;\n            }\n\n            .maze-exit-btn {\n                background: linear-gradient(to bottom, #555, #444) !important;\n            }\n\n            .maze-close-btn {\n                padding: 10px 28px;\n                font-size: 1em;\n            }\n\n            /* =====================================================\n               ACTION POPUP OVERLAY (over map)\n               ===================================================== */\n            .maze-action-popup {\n                position: absolute;\n                top: 0;\n                left: 0;\n                right: 0;\n                bottom: 0;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                background: rgba(0, 0, 0, 0.75);\n                z-index: 100;\n                backdrop-filter: blur(3px);\n                animation: popupFadeIn 0.2s ease-out;\n            }\n\n            @keyframes popupFadeIn {\n                from { opacity: 0; }\n                to { opacity: 1; }\n            }\n\n            .maze-action-popup-content {\n                background: linear-gradient(145deg, #2a2a3a, #1a1a2a);\n                border: 2px solid #4a4a6a;\n                border-radius: 12px;\n                padding: 20px 30px;\n                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5), 0 0 20px rgba(100, 100, 200, 0.2);\n                min-width: 200px;\n                max-width: 90%;\n            }\n\n            .maze-action-popup-buttons {\n                display: flex;\n                flex-direction: column;\n                gap: 10px;\n                align-items: stretch;\n            }\n\n            .maze-action-popup-buttons .menu_button,\n            .maze-action-popup-buttons .maze-confirm-btn {\n                padding: 12px 24px;\n                font-size: 1.1em;\n                font-weight: 600;\n                border-radius: 8px;\n                text-transform: uppercase;\n                letter-spacing: 0.5px;\n                transition: all 0.15s ease;\n                min-width: 150px;\n            }\n\n            .maze-action-popup-buttons .menu_button:hover,\n            .maze-action-popup-buttons .maze-confirm-btn:hover {\n                transform: scale(1.05);\n                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);\n            }\n\n            .maze-action-popup-buttons .maze-accept-btn {\n                background: linear-gradient(145deg, #2ecc71, #27ae60) !important;\n                border-color: #27ae60 !important;\n            }\n\n            .maze-action-popup-buttons .maze-slip-btn {\n                background: linear-gradient(145deg, #9b59b6, #8e44ad) !important;\n                border-color: #8e44ad !important;\n            }\n\n            .maze-cell.victory-glow {\n                animation: victoryPulse 1s infinite;\n            }\n\n            @keyframes victoryPulse {\n                0%, 100% { background: #27ae60; }\n                50% { background: #2ecc71; }\n            }\n\n            /* =====================================================\n               MOBILE / PORTRAIT LAYOUT (v1.2.0)\n               ===================================================== */\n            .layout-mobile .mazemaster-maze-container,\n            #mazemaster_maze_modal.layout-mobile .mazemaster-maze-container {\n                width: 100vw;\n                height: 100vh;\n                max-width: 100vw;\n                max-height: 100vh;\n                padding: 8px;\n                gap: 6px;\n                border-radius: 0;\n                margin: 0;\n            }\n\n            .layout-mobile .mazemaster-maze-top {\n                flex-direction: column;\n                max-height: none;\n                gap: 8px;\n            }\n\n            .layout-mobile .mazemaster-maze-hero {\n                width: 100%;\n                max-width: 100%;\n                min-width: unset;\n            }\n\n            .layout-mobile .mazemaster-maze-info-col {\n                width: 100%;\n            }\n\n            .layout-mobile .mazemaster-maze-buttons-col {\n                flex-direction: row;\n                width: 100%;\n                justify-content: center;\n            }\n\n            .layout-mobile .mazemaster-maze-stats-bar {\n                flex-wrap: wrap;\n                gap: 6px;\n                justify-content: center;\n            }\n\n            .layout-mobile .mazemaster-maze-inventory {\n                flex-wrap: wrap;\n                justify-content: center;\n            }\n\n            .layout-mobile .maze-action-buttons {\n                flex-wrap: wrap;\n                justify-content: center;\n            }\n\n            .layout-mobile .maze-dpad {\n                position: fixed;\n                bottom: 10px;\n                right: 10px;\n                z-index: 10000;\n            }\n\n            /* Make grid scrollable on mobile */\n            .layout-mobile .maze-grid-area {\n                overflow: auto;\n                max-height: 50vh;\n            }\n\n            /* Larger touch targets on mobile */\n            .layout-mobile .dpad-btn {\n                min-width: 50px;\n                min-height: 50px;\n            }\n\n            @media (max-width: 600px) {\n                .mazemaster-maze-hero {\n                    height: auto;\n                    min-height: 80px;\n                }\n\n                .maze-message-log {\n                    font-size: 0.85em;\n                    max-height: 80px;\n                }\n\n                .stats-item {\n                    font-size: 0.75em;\n                    padding: 3px 6px;\n                }\n\n                .inventory-item {\n                    padding: 4px 6px;\n                    font-size: 0.85em;\n                }\n            }\n        </style>\n    "),document.body.appendChild(d);const m=D.getRenderer(),p=document.getElementById("maze_grid_container");if(p){p.innerHTML=m.getGridHTML(Ge.size);const e=m.getPlayerOverlayHTML(c);e&&p.insertAdjacentHTML("beforeend",e),m.init(p,Ge)}R(),d.querySelectorAll(".dpad-btn").forEach((e=>{e.addEventListener("click",(()=>{const t=e.dataset.dir;"up"===t?Wa(0,-1):"down"===t?Wa(0,1):"left"===t?Wa(-1,0):"right"===t?Wa(1,0):"floor-up"===t?de("up"):"floor-down"===t&&de("down")})),e.addEventListener("touchend",(t=>{t.preventDefault(),e.click()}))})),re();const u=document.getElementById("maze_rest_btn");u&&(u.addEventListener("click",(()=>Y())),u.addEventListener("touchend",(e=>{e.preventDefault(),Y()}))),G(),le();const h=document.getElementById("maze_inventory_wrapper"),g=document.getElementById("maze_inventory_btn"),f=document.getElementById("maze_inventory_menu");g&&f&&(g.addEventListener("click",(e=>{e.stopPropagation();!f.classList.contains("hidden")?(f.classList.add("hidden"),null==h||h.classList.remove("open")):(f.classList.remove("hidden"),null==h||h.classList.add("open"))})),document.addEventListener("click",(e=>{null!=h&&h.contains(e.target)||(f.classList.add("hidden"),null==h||h.classList.remove("open"))})));d.querySelectorAll('.inventory-menu-item[data-usable="true"]').forEach((e=>{e.addEventListener("click",(async t=>{t.stopPropagation();const n=e.dataset.item,a=e.dataset.hpItem;a?await K(a):"portalStone"===n?await async function(){if(!Ge||Ge.isPaused)return!1;if(!Ge.inventory.portalStone||Ge.inventory.portalStone<=0)return console.log("[MazeMaster] No Portal Stones available"),!1;const e=[];for(const n of Ge.visited){var t;const[a,o]=n.split(",").map(Number),i=null===(t=Ge.grid[o])||void 0===t?void 0:t[a];null==i||!i.portal||a===Ge.playerX&&o===Ge.playerY||e.push({x:a,y:o,portal:i.portal})}if(0===e.length)return Ge.currentMinion={name:"Portal Stone",imagePath:"",message:"No revealed portals to teleport to. Explore more to find portals first!"},Na(),!1;if(1===e.length){const t=e[0];return await pe(t.x,t.y),!0}const n=e[0];return await pe(n.x,n.y),!0}():"mapFragment"===n?await async function(){if(!Ge||Ge.isPaused)return!1;if(!Ge.inventory.mapFragment||Ge.inventory.mapFragment<=0)return console.log("[MazeMaster] No Map Fragments available"),!1;const{playerX:e,playerY:t,grid:n,size:a}=Ge;let o=0;for(let i=-1;i<=1;i++)for(let s=-1;s<=1;s++){const r=e+s,l=t+i;if(r>=0&&r<a&&l>=0&&l<a){const e="".concat(r,",").concat(l);Ge.visited.has(e)||(Ge.visited.add(e),n[l][r].visited=!0,o++)}}return await Xa("mapFragment",1),Ra(),Ge.currentMinion={name:"Map Fragment",imagePath:"",message:o>0?"The ancient map reveals ".concat(o," hidden area").concat(o>1?"s":"","!"):"The map shows only what you already knew."},Na(),await H("onItemRemove",{item:"mapFragment",count:1,total:Ge.inventory.mapFragment}),!0}():"voidWalk"===n?function(){if(!Ge||Ge.isPaused)return!1;if(!Ge.inventory.voidWalk||Ge.inventory.voidWalk<=0)return console.log("[MazeMaster] No Void Walk available"),!1;if(Ge.voidWalkActive)return console.log("[MazeMaster] Void Walk already active"),!1;Ge.voidWalkActive=!0;const e=document.getElementById("maze_dpad");e&&e.classList.add("void-walk-active"),Ge.currentMinion={name:"Void Walk",imagePath:"",message:"You become ethereal... Your next move can phase through walls!"},Na()}():e.dataset.visItem&&await async function(e){if(Ge.isOpen&&Ge.inventory[e]&&!(Ge.inventory[e]<=0)){switch(Ge.visibility||(Ge.visibility={baseRadius:1,tempBonus:0,tempMovesLeft:0,permBonus:0,floorRevealed:!1}),e){case"torch":await Xa("torch"),Ge.visibility.tempBonus=2,Ge.visibility.tempMovesLeft=3,Oa("Item","Torch lit! +2 visibility for 3 moves.");break;case"revealScroll":await Xa("revealScroll"),Ge.visibility.floorRevealed=!0;const e=Ge.grid.length,t="".concat(Ge.currentFloor,":");for(let n=0;n<e;n++)for(let a=0;a<e;a++)Ge.visited.add("".concat(t).concat(a,",").concat(n));Oa("Item","The scroll reveals the entire floor!");break;case"sightPotion":await Xa("sightPotion"),Ge.visibility.permBonus=(Ge.visibility.permBonus||0)+1,Oa("Item","Your vision sharpens! Permanent +1 visibility.");break;case"crystalBall":await Xa("crystalBall");const n=[],a=Ge.grid.length,o="".concat(Ge.currentFloor,":");for(let e=0;e<a;e++)for(let t=0;t<a;t++){const a=Ge.grid[e][t];a.minion&&!a.minion.triggered&&(Ge.visited.add("".concat(o).concat(t,",").concat(e)),n.push(a.minion.name||"Unknown"))}n.length>0?Oa("Item","Crystal Ball reveals ".concat(n.length," minion(s)!")):Oa("Item","Crystal Ball shows no minions remain on this floor.");break;case"lantern":return void Oa("Info","Lantern provides passive +1 visibility while held.")}renderMaze()}}(e.dataset.visItem),null==f||f.classList.add("hidden"),null==h||h.classList.remove("open")}))})),se(Ge.profile);const v=document.getElementById("maze_close_btn");v&&(v.addEventListener("click",La),v.addEventListener("touchend",(e=>{e.preventDefault(),La()})));null===(r=document.getElementById("maze_power_btn"))||void 0===r||r.addEventListener("click",(()=>{!function(){const e=document.getElementById("maze_save_dialog");e&&e.remove();const t=document.createElement("div");t.id="maze_save_dialog",t.innerHTML='\n        <div class="maze-save-dialog-backdrop"></div>\n        <div class="maze-save-dialog-content">\n            <div class="maze-save-dialog-title">Do you wish to save?</div>\n            <div class="maze-save-dialog-buttons">\n                <button id="maze_save_yes" class="maze-save-btn maze-save-yes">Yes</button>\n                <button id="maze_save_no" class="maze-save-btn maze-save-no">No</button>\n                <button id="maze_save_cancel" class="maze-save-btn maze-save-cancel">Cancel</button>\n            </div>\n        </div>\n    ';const n=document.getElementById("mazemaster_maze_modal");n?n.appendChild(t):document.body.appendChild(t);document.getElementById("maze_save_yes").addEventListener("click",(()=>{t.remove(),Ro(),La(),Ho()})),document.getElementById("maze_save_no").addEventListener("click",(()=>{t.remove(),La()})),document.getElementById("maze_save_cancel").addEventListener("click",(()=>{t.remove()})),t.querySelector(".maze-save-dialog-backdrop").addEventListener("click",(()=>{t.remove()}))}()}));const b=document.getElementById("maze_memory_btn"),y=document.getElementById("maze_memory_panel"),z=document.getElementById("maze_memory_backdrop"),x=document.getElementById("maze_memory_textarea"),_=document.getElementById("maze_memory_save"),w=document.getElementById("maze_memory_close"),k=function(){arguments.length>0&&void 0!==arguments[0]&&arguments[0]&&x&&(Ge.sessionNotes=x.value,Ro(),console.log("[MazeMaster] Session notes saved")),y&&(y.style.display="none"),z&&(z.style.display="none"),null==b||b.classList.remove("active")};null==b||b.addEventListener("click",(()=>{y&&z&&x&&(x.value=Ge.sessionNotes||"",y.style.display="flex",z.style.display="block",null==b||b.classList.add("active"),x.focus())})),null==w||w.addEventListener("click",(()=>k(!0))),null==z||z.addEventListener("click",(()=>k(!0))),null==_||_.addEventListener("click",(()=>{x&&(Ge.sessionNotes=x.value,Ro(),console.log("[MazeMaster] Session notes saved"),_.textContent="Saved!",setTimeout((()=>{_.textContent="Save Notes"}),1500))}))}function La(){Ge.isOpen=!1,document.removeEventListener("keydown",ja,{capture:!0});const e=document.getElementById("mazemaster_maze_modal");e&&e.remove()}function Ra(){D.getRenderer().render(Ge)}function Aa(e){var t;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";if(!Ge||!e)return;const a=(new Date).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!1}),o=n?"[".concat(n,"] "):"",i="".concat(a," - ").concat(o).concat(e);Ge.sessionNotes?Ge.sessionNotes+="\n"+i:Ge.sessionNotes=i;const s=document.getElementById("maze_memory_textarea");s&&"none"!==(null===(t=document.getElementById("maze_memory_panel"))||void 0===t?void 0:t.style.display)&&(s.value=Ge.sessionNotes,s.scrollTop=s.scrollHeight)}function Oa(e,t){t&&(arguments.length>2&&void 0!==arguments[2]&&arguments[2]||Ge.messageLog.push({speaker:e,message:t,timestamp:Date.now()}),Ha())}function Ha(){const e=document.getElementById("maze_message_log");e&&(e.innerHTML=Ge.messageLog.map((e=>'\n        <div class="maze-message-entry">\n            <div class="maze-message-speaker">'.concat(_o(e.speaker),'</div>\n            <div class="maze-message-text">').concat(_o(e.message),"</div>\n        </div>\n    "))).join(""),e.scrollTop=e.scrollHeight)}function Na(){const{currentMinion:e,isVictory:t,profile:n,messageLog:a}=Ge,o=document.getElementById("maze_minion_img"),i=document.getElementById("maze_minion_name"),s=document.getElementById("maze_minion_role");if(t){n.winImage&&o&&(o.src=Ee(n.winImage),o.style.display=""),i&&(i.textContent="Victory!"),s&&(s.textContent="");const e=n.winMessage||"You escaped the maze!",t=a[a.length-1];t&&t.message===e||Oa("Victory!",e)}else if(e&&(e.imagePath&&o?(o.src=Ee(e.imagePath),o.style.display="block"):o&&(o.style.display="none"),i&&(i.textContent=e.name||""),s&&(s.textContent=e.role||""),e.message)){const t=a[a.length-1];t&&t.message===e.message||Oa(e.name||"Unknown",e.message)}Ha()}function qa(e){var t;const n=document.getElementById("maze_generating_indicator");n&&n.classList.toggle("active",e),Ye=e,null!==(t=Ge)&&void 0!==t&&t.isOpen&&Ra()}function Fa(){var e,t,n,a,o;if(!Ge.isOpen)return;const{playerX:i,playerY:s,grid:r}=Ge,l=null===(e=r[s])||void 0===e?void 0:e[i];if(!l)return;const c=document.getElementById("room_info_name"),d=document.getElementById("room_info_desc");c&&(c.textContent=(null===(t=l.roomInfo)||void 0===t?void 0:t.name)||"Unknown Room");const m=Ge.currentFloor||0,p="".concat(m,":").concat(i,",").concat(s);let u=(null===(n=Ge.enhancedRooms)||void 0===n?void 0:n[p])||(null===(a=l.roomInfo)||void 0===a?void 0:a.enhancedDescription)||(null===(o=l.roomInfo)||void 0===o?void 0:o.description)||"...";if(l.secretPassage&&!l.secretPassage.revealed){const e=l.secretPassage.hintLevel||0,t=l.secretPassage.direction,n="top"===t?"north":"bottom"===t?"south":"left"===t?"west":"east";e>=3?u+=' <span style="color: #ffcc00;"><i class="fa-solid fa-eye"></i> A hidden passage is clearly visible to the '.concat(n,"!</span>"):e>=2?u+=' <span style="color: #aaaaaa;"><i class="fa-solid fa-question"></i> The '.concat(n," wall has suspicious cracks...</span>"):e>=1&&(u+=' <span style="color: #666666;"><i class="fa-solid fa-wind"></i> A faint draft from the '.concat(n,"...</span>"))}d&&(d.innerHTML=u);const h=document.getElementById("room_info_exits");if(h){const e=[],t=Ge.size;if(!l.walls.top&&s>0){var g,f;const t=null===(g=r[s-1])||void 0===g?void 0:g[i],n=(null==t||null===(f=t.roomInfo)||void 0===f?void 0:f.name)||"Unknown";e.push("North  ".concat(n))}if(!l.walls.right&&i<t-1){var v,b;const t=null===(v=r[s])||void 0===v?void 0:v[i+1],n=(null==t||null===(b=t.roomInfo)||void 0===b?void 0:b.name)||"Unknown";e.push("East  ".concat(n))}if(!l.walls.bottom&&s<t-1){var y,z;const t=null===(y=r[s+1])||void 0===y?void 0:y[i],n=(null==t||null===(z=t.roomInfo)||void 0===z?void 0:z.name)||"Unknown";e.push("South  ".concat(n))}if(!l.walls.left&&i>0){var x,_;const t=null===(x=r[s])||void 0===x?void 0:x[i-1],n=(null==t||null===(_=t.roomInfo)||void 0===_?void 0:_.name)||"Unknown";e.push("West  ".concat(n))}if(l.staircase){var w,k,C,S;const t=l.staircase.targetFloor,n=l.staircase.targetX,a=l.staircase.targetY,o=(null===(w=Ge.floorsData)||void 0===w||null===(w=w[t])||void 0===w?void 0:w.grid)||(null===(k=Ge.floors)||void 0===k?void 0:k[t]),i=null==o||null===(C=o[a])||void 0===C?void 0:C[n],s=(null==i||null===(S=i.roomInfo)||void 0===S?void 0:S.name)||"Floor ".concat(t+1);"up"===l.staircase.direction?e.push('<i class="fa-solid fa-stairs"></i> Up  '.concat(s)):"down"===l.staircase.direction&&e.push('<i class="fa-solid fa-stairs"></i> Down  '.concat(s))}h.innerHTML=e.length?e.join("<br>"):"None"}const M=document.getElementById("room_info_occupants");if(M){const e=[];if(l.minion&&!l.minion.defeated&&!l.minion.triggered){const t=St(l.minion.minionId);e.push((null==t?void 0:t.name)||"Unknown Entity")}l.chest&&!l.chest.opened&&e.push("locked"===l.chest.type?"Locked Chest":"Chest"),l.trap&&!l.trap.triggered&&e.push("Something feels off..."),M.textContent=e.length?e.join(", "):"None"}const E=document.getElementById("room_info_defeated");if(E){var P,I,T,B;const e=[];if(null!==(P=l.minion)&&void 0!==P&&P.defeated||null!==(I=l.minion)&&void 0!==I&&I.triggered){const t=St(l.minion.minionId);e.push((null==t?void 0:t.name)||"Unknown")}null!==(T=l.chest)&&void 0!==T&&T.opened&&e.push("Opened Chest"),null!==(B=l.trap)&&void 0!==B&&B.triggered&&e.push("Triggered Trap"),E.textContent=e.length?e.join(", "):"None"}}function ja(e){if(!Ge.isOpen||Ge.isVictory)return;if(e.shiftKey&&("ArrowUp"===e.key||"ArrowDown"===e.key)){const t="ArrowUp"===e.key?"up":"down";return e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),void de(t)}let t=0,n=0;if("ArrowUp"===e.key)n=-1;else if("ArrowDown"===e.key)n=1;else if("ArrowLeft"===e.key)t=-1;else{if("ArrowRight"!==e.key)return;t=1}e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),Wa(t,n)}async function Wa(e,t){if(!Ge.isOpen||Ge.isVictory)return;if(Ge.isPaused)return;const{playerX:n,playerY:a,grid:o,size:i}=Ge,s=n+e,r=a+t;if(s<0||s>=i||r<0||r>=i)return;const l=o[a][n];let c=!1;if(1===e&&l.walls.right&&(c=!0),-1===e&&l.walls.left&&(c=!0),1===t&&l.walls.bottom&&(c=!0),-1===t&&l.walls.top&&(c=!0),c)if(Ge.voidWalkActive)await async function(){var e;if(null!==(e=Ge)&&void 0!==e&&e.voidWalkActive){Ge.voidWalkActive=!1,await Xa("voidWalk",1);const e=document.getElementById("maze_dpad");e&&e.classList.remove("void-walk-active")}}(),c=!1;else{const i=1===e?"right":-1===e?"left":1===t?"bottom":"top",s=za(l,i);if(!s.found)return s.attempted?void Oa("Wall",s.message||"The wall seems solid..."):void 0;!function(e,t,n,a){var o;const i=e[n][t];if(!i.secretPassage||i.secretPassage.direction!==a)return!1;i.secretPassage.revealed=!0,i.walls[a]=!1;const s=i.secretPassage.targetCell,r={top:"bottom",bottom:"top",left:"right",right:"left"}[a];null!==(o=e[s.y])&&void 0!==o&&o[s.x]&&(e[s.y][s.x].walls[r]=!1)}(o,n,a,i),Oa("Secret Found!","You discovered a hidden passage!"),await H("onSecretFound",{x:n,y:a,direction:i}),c=!1}else Ge.voidWalkActive&&function(){var e;if(null!==(e=Ge)&&void 0!==e&&e.voidWalkActive){Ge.voidWalkActive=!1;const e=document.getElementById("maze_dpad");e&&e.classList.remove("void-walk-active")}}();const d=o[r][s];if(void 0!==d.zoneId&&null!==d.zoneId){var m,p;const e=null===(m=Ge.floorsData)||void 0===m?void 0:m[Ge.currentFloor],t=null==e||null===(p=e.zones)||void 0===p?void 0:p[d.zoneId];if(t&&!t.isUnlocked)return void Oa("Zone Locked",t.lockedMessage||"".concat(t.name," is sealed. Clear more rooms to unlock."))}const u=1===e?"right":-1===e?"left":1===t?"down":"up",h=1===e?"east":-1===e?"west":1===t?"south":"north";Ge.playerX=s,Ge.playerY=r,Ge.playerDirection=h;if(J(s,r,Ge.grid.length),Ge.moveCount++,Ge.visibility&&(Ge.visibility.tempMovesLeft>0&&(Ge.visibility.tempMovesLeft--,Ge.visibility.tempMovesLeft<=0&&(Ge.visibility.tempBonus=0,Oa("Info","Your torch burns out."))),Ge.visibility.floorRevealed=!1),await Z("moves",1),await H("onMove",{x:s,y:r,direction:u}),Ge.restCooldown&&Ge.restCooldown>0&&(Ge.restCooldown--,G()),te(),ce(),async function(){var e;if(!Ge)return;const t=ee();if(null!==(e=Ge.profile)&&void 0!==e&&e.objectives){for(const e of Ge.profile.objectives)if("explore"===e.type){const n=Ge.objectiveProgress[e.id];n&&!n.completed&&(n.current=t,t>=(e.count||100)&&(n.completed=!0,await H("onObjectiveComplete",{objectiveId:e.id}),e.reward&&e.reward.trim()&&await O(e.reward)))}be(),ve()}!Ge.explorationComplete&&t>=100&&(Ge.explorationComplete=!0,await H("onExploreComplete",{percentage:100}))}(),ue(!0),Ra(),"function"==typeof window.mazeCenterOnPlayer&&window.mazeCenterOnPlayer(!0),s===Ge.exitX&&r===Ge.exitY&&Ge.currentFloor===Ge.totalFloors-1)return void async function(){const e=Ge.profile;if(!function(){var e;if(!Ge||null===(e=Ge.profile)||void 0===e||!e.objectives)return!0;const t=Ge.profile.objectives,n=Ge.objectiveProgress,a=t.filter((e=>e.required));return 0===a.length||a.every((e=>{var t;return null===(t=n[e.id])||void 0===t?void 0:t.completed}))}()){const t=e.mainMinion?St(e.mainMinion):null;Ge.currentMinion={name:(null==t?void 0:t.name)||"Exit",imagePath:(null==t?void 0:t.imagePath)||"",message:"You haven't completed all required objectives yet! Explore the maze to find what you need."},Na();const n=document.querySelector(".maze-objectives-section");return void(n&&(n.classList.add("objectives-flash"),setTimeout((()=>n.classList.remove("objectives-flash")),500)))}if(!e.mainMinion||Ge.exitEncounterDone)return void yo();const t=St(e.mainMinion);if(!t)return void yo();Ge.isPaused=!0,Ge.currentMinion={name:t.name,imagePath:t.imagePath,message:"You've reached the exit... but first, face me!"},Na();const n=e.mainMinionExitType||"messenger",a=e.mainMinionExitProfile;switch(n){case"messenger":await Ia(2e3),Ge.exitEncounterDone=!0,Ge.isPaused=!1,yo();break;case"battlebar":a?(Ge.pendingEncounter={type:"exit_battlebar",profile:a},Nn(a)):(Ge.exitEncounterDone=!0,Ge.isPaused=!1,yo());break;case"prizewheel":a?(Ge.pendingEncounter={type:"exit_wheel",profile:a},Tt(a),Lt()):(Ge.exitEncounterDone=!0,Ge.isPaused=!1,yo());break;case"turnbased":a?(Ge.pendingEncounter={type:"exit_turnbased",profile:a},Ot(a)):(Ge.exitEncounterDone=!0,Ge.isPaused=!1,yo());break;case"qte":a?(Ge.pendingEncounter={type:"exit_qte",profile:a},Jt(a)):(Ge.exitEncounterDone=!0,Ge.isPaused=!1,yo());break;case"dice":a?(Ge.pendingEncounter={type:"exit_dice",profile:a},sn(a)):(Ge.exitEncounterDone=!0,Ge.isPaused=!1,yo());break;case"stealth":a?(Ge.pendingEncounter={type:"exit_stealth",profile:a},un(a)):(Ge.exitEncounterDone=!0,Ge.isPaused=!1,yo());break;case"puzzle":a?(Ge.pendingEncounter={type:"exit_puzzle",profile:a},yn(a)):(Ge.exitEncounterDone=!0,Ge.isPaused=!1,yo());break;case"negotiation":a?(Ge.pendingEncounter={type:"exit_negotiation",profile:a},Mn(a)):(Ge.exitEncounterDone=!0,Ge.isPaused=!1,yo());break;default:yo()}}();const g=o[r][s];if(!g.chest||g.chest.opened)if(!g.minion||g.minion.triggered)if(!g.trap||g.trap.triggered)if(g.safeRoom&&!g.safeRoom.exhausted&&Ge.hpEnabled&&Ge.hp)!async function(e,t){var n;Ge.isPaused=!0,Ge.pendingSafeRoom={x:e,y:t};const a=Ge.profile||{},o=null!==(n=a.safeRoomHealPercent)&&void 0!==n?n:100,i=a.safeRoomUseLLM&&a.enableLLM,s=Ge.hp.max+Ge.hp.maxBonus,r=Ge.hp.current,l=r<s;let c=l?"A sanctuary of peace and healing. Rest here to restore ".concat(o,"% of your health."):"A sanctuary of peace. You are already at full health.";if(Ge.currentMinion={name:"Safe Room",imagePath:"",message:c},Na(),i){var d;const e=(null===(d=a.storyConfig)||void 0===d?void 0:d.mainStory)||"";qa(!0);try{const t=await async function(e){let{baseMessage:t,mainStory:n,needsHealing:a,healPercent:o,currentHP:i,maxHP:s,theme:r}=e;const l="You are narrating a dungeon crawler game. The player has found a safe room (a healing sanctuary).\nTheme: ".concat(r,"\nStory context: ").concat(n||"A dangerous dungeon adventure","\nPlayer HP: ").concat(i,"/").concat(s,"\nNeeds healing: ").concat(a?"Yes":"No (already at full health)","\nHeal amount: ").concat(o,"%\n\nWrite a brief atmospheric description (2-3 sentences) of this safe haven. Make it match the theme. If they need healing, hint at the restorative nature of the room. Keep it immersive but concise.");try{const e=await fetch("/api/openai/generate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:l,max_tokens:150,temperature:.8})});if(e.ok){var c;return(null===(c=(await e.json()).choices)||void 0===c||null===(c=c[0])||void 0===c||null===(c=c.text)||void 0===c?void 0:c.trim())||t}}catch(e){console.error("[MazeMaster] LLM safe room message failed:",e)}return t}({baseMessage:c,mainStory:e,needsHealing:l,healPercent:o,currentHP:r,maxHP:s,theme:a.theme||"fantasy"});Ge.currentMinion.message=t,Na()}catch(e){console.error("[MazeMaster] Safe room message generation failed:",e)}finally{qa(!1)}}!function(e,t){var n,a;let o="";o=e?'\n            <button id="maze_saferoom_heal" class="menu_button maze-confirm-btn" style="background: linear-gradient(135deg, #14b8a6, #2dd4bf);">\n                <i class="fa-solid fa-heart"></i> Heal ('.concat(t,'%)\n            </button>\n            <button id="maze_saferoom_ignore" class="menu_button maze-confirm-btn">Ignore</button>\n        '):'\n            <button id="maze_saferoom_ignore" class="menu_button maze-confirm-btn">Continue</button>\n        ';co(o),null===(n=document.getElementById("maze_saferoom_heal"))||void 0===n||n.addEventListener("click",eo),null===(a=document.getElementById("maze_saferoom_ignore"))||void 0===a||a.addEventListener("click",to)}(l,o)}(s,r);else{if(g.portal){if(await async function(e,t,n){if(!n)return!1;if(!n.bidirectional&&!n.isStart)return!1;const a=n.target;if(!a||null==a.x||null==a.y)return!1;await H("onTeleport",{portalId:n.id,fromX:e,fromY:t,toX:a.x,toY:a.y}),Ge.playerX=a.x,Ge.playerY=a.y,Ge.visited.add("".concat(Ge.currentFloor,":").concat(a.x,",").concat(a.y)),ue(!1),ce(),await Z("teleportsUsed",1);const o=document.querySelector('.maze-cell[data-x="'.concat(e,'"][data-y="').concat(t,'"]')),i=document.querySelector('.maze-cell[data-x="'.concat(a.x,'"][data-y="').concat(a.y,'"]'));return o&&(o.classList.add("portal-flash"),setTimeout((()=>o.classList.remove("portal-flash")),300)),i&&(i.classList.add("portal-flash"),setTimeout((()=>i.classList.remove("portal-flash")),300)),console.log("[MazeMaster] Teleported from (".concat(e,",").concat(t,") to (").concat(a.x,",").concat(a.y,")")),!0}(s,r,g.portal)){Ra(),"function"==typeof window.mazeCenterOnPlayer&&window.mazeCenterOnPlayer(!0);const e=o[Ge.playerY][Ge.playerX];if(e.chest&&!e.chest.opened)return void Ja(e.chest,Ge.playerX,Ge.playerY);if(e.minion&&!e.minion.triggered)return void Ya(e.minion.minionId,Ge.playerX,Ge.playerY);if(e.trap&&!e.trap.triggered)return void Ga(e.trap.trapId,Ge.playerX,Ge.playerY)}}!async function(){const e=Ge.profile;if(!e.mainMinion)return;if(!e.mainMinionRandomChance)return;if(!e.mainMinionRandomMessages||0===e.mainMinionRandomMessages.length)return;if(100*Math.random()>e.mainMinionRandomChance)return;const t=St(e.mainMinion);if(!t)return;const n=Pa(e.mainMinionRandomMessages);if(!n)return;Ge.currentMinion={name:t.name,imagePath:t.imagePath,message:"..."},Na(),qa(!0);let a=n;try{a=await Ve({minionName:t.name,minionDescription:t.description,baseMessage:n,mainStory:Qe(),currentMilestone:Je(),minionType:t.type||"messenger"})}catch(e){console.error("[MazeMaster] Random message LLM generation error:",e)}qa(!1),Ge.currentMinion.message=a,Na()}(),function(){const e=Ge.profile;if(!e.storyConfig||!e.storyConfig.milestones||0===e.storyConfig.milestones.length)return;const t=Ge.size*Ge.size,n=Ge.visited.size,a=Math.floor(n/t*100);for(const t of e.storyConfig.milestones)if(a>=t.percent&&!Ge.shownMilestones.has(t.percent)){var o;Ge.shownMilestones.add(t.percent),Aa("Milestone ".concat(t.percent,"%: ").concat(null===(o=t.storyUpdate)||void 0===o?void 0:o.substring(0,50),"..."),"Story");const n=e.mainMinion?St(e.mainMinion):null;return Ge.currentMinion={name:(null==n?void 0:n.name)||"Story",imagePath:(null==n?void 0:n.imagePath)||"",message:t.storyUpdate},void Na()}}(),Xe(s,r),await async function(){if(!Ge||!Ge.movingMinions||0===Ge.movingMinions.length)return;const{grid:e,size:t,playerX:n,playerY:a,moveCount:o}=Ge,i=N(Ge.profile);for(const r of Ge.movingMinions){var s;if(r.triggered)continue;if(o%(r.movement.speed||1)!==0)continue;const l=he(r,e,t,n,a,i);if(!l)continue;const c=r.x,d=r.y;if((null===(s=e[d][c].minion)||void 0===s?void 0:s.minionId)===r.minionId&&(e[d][c].minion=null),r.x=l.x,r.y=l.y,e[l.y][l.x].minion={minionId:r.minionId,triggered:!1},await H("onEnemyMove",{minionId:r.minionId,fromX:c,fromY:d,toX:l.x,toY:l.y}),l.x===n&&l.y===a)return console.log("[MazeMaster] Moving minion ".concat(r.minionId," caught the player!")),r.triggered=!0,e[l.y][l.x].minion.triggered=!0,void Ya(r.minionId,l.x,l.y)}}(),Ge.movingMinions&&Ge.movingMinions.length>0&&Ra()}else Ga(g.trap.trapId,s,r);else Ya(g.minion.minionId,s,r);else Ja(g.chest,s,r)}async function Ya(e,t,n){var a;const o=St(e);if(!o)return void console.warn('[MazeMaster] Minion "'.concat(e,'" not found'));const i=Ge.grid[n][t];if(null!==(a=i.minion)&&void 0!==a&&a.triggered)return void console.log("[MazeMaster] Minion at ".concat(t,",").concat(n," already triggered, skipping"));i.minion.triggered=!0,console.log("[MazeMaster] Marked minion at ".concat(t,",").concat(n," as triggered"));const s=o.type||"messenger";if(Aa("Encountered ".concat(o.name," (").concat(s,")"),"Encounter"),"messenger"!==s&&Ge.inventory.minionBane>0){if(await async function(){var e;return!(null===(e=Ge)||void 0===e||!e.inventory.minionBane||Ge.inventory.minionBane<=0||(await Xa("minionBane",1),Ge.currentMinion={name:"Minion Bane",imagePath:"",message:"Your Minion Bane flares with power, instantly vanquishing the foe!"},Na(),0))}())return i.minion.defeated=!0,await Z("encountersWon",1),await fe("defeat",e,1),await ba(t,n),Ra(),void setTimeout((()=>{Ge.isPaused=!1,resetMazeHero()}),2e3)}await Z("encountersTotal",1),await fe("defeat",e,1),Ge.isPaused=!0,Ge.currentMinion={name:o.name,imagePath:o.imagePath,message:"..."},Na(),Ra();const r=Pa(o.messages)||"You encountered ".concat(o.name,"!");qa(!0);let l=r;try{l=await Ve({minionName:o.name,minionDescription:o.description,baseMessage:r,mainStory:Qe(),currentMilestone:Je(),minionType:o.type||"messenger"})}catch(e){console.error("[MazeMaster] LLM generation error:",e)}qa(!1),Ge.currentMinion.message=l,Na(),o.encounterScript&&o.encounterScript.trim()&&(console.log("[MazeMaster] Executing encounter script for ".concat(o.name)),await O(o.encounterScript)),function(e,t,n,a){var o,i,s,r,l;console.log("[MazeMaster] showEncounterConfirmation called:",{minionId:e,x:t,y:n,encounterType:a});const c=St(e);console.log("[MazeMaster] Minion data:",c);const d="messenger"!==a&&"merchant"!==a&&Ge.inventory.stealth>0;Ge.pendingConfirmation={type:a,minionId:e,x:t,y:n,canSlipAway:d},console.log("[MazeMaster] Set pendingConfirmation:",Ge.pendingConfirmation);let m="";if("messenger"===a)m='<button id="maze_confirm_ok" class="menu_button maze-confirm-btn">OK</button>';else if("merchant"===a){const e=c.merchantItemCount||{min:2,max:4},t=e.min+Math.floor(Math.random()*(e.max-e.min+1)),n=Rn(c.merchantItemPool||"Common Goods",t);Ge.pendingConfirmation.offeredItems=n,Ge.currentMinion.message="Take a look at my wares! I have ".concat(t," items that might interest you..."),Na(),m='\n            <button id="maze_confirm_browse" class="menu_button maze-confirm-btn maze-accept-btn">Browse Wares</button>\n            <button id="maze_confirm_decline" class="menu_button maze-confirm-btn">No Thanks</button>\n        '}else{m='<button id="maze_confirm_action" class="menu_button maze-confirm-btn">'.concat({battlebar:"Fight!",prizewheel:"Spin!",turnbased:"Battle!",qte:"React!",dice:"Roll!",stealth:"Sneak!",puzzle:"Solve!",negotiation:"Negotiate!"}[a]||"Engage!","</button>"),d&&(m+='<button id="maze_confirm_slip" class="menu_button maze-confirm-btn maze-slip-btn">Slip Away</button>')}co(m),null===(o=document.getElementById("maze_confirm_ok"))||void 0===o||o.addEventListener("click",po),null===(i=document.getElementById("maze_confirm_action"))||void 0===i||i.addEventListener("click",uo),null===(s=document.getElementById("maze_confirm_slip"))||void 0===s||s.addEventListener("click",ho),null===(r=document.getElementById("maze_confirm_browse"))||void 0===r||r.addEventListener("click",go),null===(l=document.getElementById("maze_confirm_decline"))||void 0===l||l.addEventListener("click",fo)}(e,t,n,o.type||"messenger")}async function Ga(e,t,n){var a;const o=Pt(e);if(!o)return void console.warn('[MazeMaster] Trap "'.concat(e,'" not found'));const i=null!==(a=o.avoidChance)&&void 0!==a?a:0;if(i>0){const e=100*Math.random();if(e<i){console.log('[MazeMaster] Trap "'.concat(o.name,'" avoided (rolled ').concat(e.toFixed(1)," vs ").concat(i,"%)")),Ge.grid[n][t].trap.triggered=!0,Ra(),await Z("trapsAvoided",1);return Oa("Trap Avoided",o.avoidMessage||"You skillfully avoided the ".concat(o.name,"!")),void(o.avoidScript&&o.avoidScript.trim()&&(console.log("[MazeMaster] Executing avoid script for ".concat(o.name)),await O(o.avoidScript)))}}Ge.grid[n][t].trap.triggered=!0,Ra(),Aa("Triggered trap: ".concat(o.name),"Trap"),await Z("trapsTriggered",1),Ge.isPaused=!0,Ge.currentMinion={name:o.name,imagePath:o.imagePath,message:"..."},Na(),qa(!0);const s=o.message||"You triggered a trap!";let r=s;try{r=await async function(e){const{trapName:t,baseMessage:n,mainStory:a}=e;if(!n)return"";if(!1===Re.llmEnabled)return n;if("function"!=typeof h)return n;const o=Q(),i="The player ".concat(o,' has triggered a trap called "').concat(t,'" in a maze.\n\n').concat(a?"Story Setting: ".concat(a,"\n\n"):"",'Based on this trap description: "').concat(n,'"\n\nWrite a short, dramatic narration of the trap being triggered (1-2 sentences, under 100 characters). Make it visceral and immediate. You may reference the player by name. Do not use quotation marks.');try{console.log("[MazeMaster] Generating LLM message for trap:",t);const e=await h(i,{quietToLoud:!1,skipWIAN:!0,skipWI:!0,max_length:80});if(e&&e.trim()){let t=e.trim();return t=t.replace(/^["']|["']$/g,""),t=t.replace(/^["""''']|["""''']$/g,""),console.log("[MazeMaster] Generated trap message:",t),t}}catch(e){console.error("[MazeMaster] Trap LLM generation failed:",e)}return n}({trapName:o.name,baseMessage:s,mainStory:Qe()})}catch(e){console.error("[MazeMaster] Trap LLM generation error:",e)}var l;qa(!1),Ge.currentMinion.message=r,Na(),o.script&&o.script.trim()&&(console.log("[MazeMaster] Executing trap script for ".concat(o.name)),await O(o.script)),co('<button id="maze_trap_continue" class="menu_button maze-confirm-btn">Continue</button>'),null===(l=document.getElementById("maze_trap_continue"))||void 0===l||l.addEventListener("click",(()=>{mo(),Ua()}))}function Ua(){Ge.isPaused=!1,Ge.pendingEncounter=null;const e=document.getElementById("maze_encounter_confirm");e&&(e.innerHTML="",e.style.display="none");const t=Ge.profile;if(t.mainMinion){const e=St(t.mainMinion);if(e)return Ge.currentMinion={name:e.name,imagePath:e.imagePath,message:"Continue onward..."},void Na()}Ge.currentMinion={name:"The Maze",imagePath:"",message:"Find your way to the exit..."},Na()}function Ka(){const e=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;const a=document.getElementById(e);if(a&&(a.textContent=t),n){const e=document.getElementById(n);if(e){e.textContent=t;const n=e.closest(".inv-overlay-item");n&&(n.style.display=t>0?"":"none")}}};e("maze_inv_key",Ge.inventory.key,"maze_ov_key"),e("maze_inv_stealth",Ge.inventory.stealth,"maze_ov_stealth"),e("maze_inv_pow",Ge.inventory.strike,"maze_ov_strike"),e("maze_inv_execute",Ge.inventory.execute||0,"maze_ov_execute");const t=["floorKey","portalStone","minionBane","mapFragment","timeShard","voidWalk"];for(const n of t){const t=Ge.inventory[n]||0;e("maze_inv_".concat(n),t,"maze_ov_".concat(n))}const n=["healingPotion","greaterHealing","elixir","revivalCharm","heartCrystal"];for(const t of n){const n=Ge.inventory[t]||0;e("maze_inv_".concat(t),n,"maze_ov_".concat(t))}const a=["torch","lantern","revealScroll","sightPotion","crystalBall"];for(const t of a){const n=Ge.inventory[t]||0;e("maze_inv_".concat(t),n,"maze_ov_".concat(t))}}async function Va(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;var n;void 0!==Ge.inventory[e]&&(Ge.inventory[e]+=t,Ka(),void 0!==(null===(n=Ge.stats)||void 0===n||null===(n=n.itemsCollected)||void 0===n?void 0:n[e])&&(Ge.stats.itemsCollected[e]+=t),await H("onItemAdd",{item:e,count:t,total:Ge.inventory[e]}),await fe("collect",e,t))}async function Xa(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;if(void 0!==Ge.inventory[e]){const n=Ge.inventory[e];Ge.inventory[e]=Math.max(0,n-t),Ka(),await H("onItemRemove",{item:e,count:Math.min(n,t),total:Ge.inventory[e]})}}async function Ja(e,t,n){var a;Ge.isPaused=!0,Ge.pendingChest={chestData:e,x:t,y:n};let o="locked"===e.type,i=!1;o&&0===Ge.inventory.key&&function(e){var t;if(null===(t=Ge)||void 0===t||!t.fairness)return!1;const n=(null==e?void 0:e.fairness)||{};if(!1===n.enabled)return!1;if(!1===n.mercyUnlock)return!1;const a=Ge.fairness,o=n.mercyUnlockThreshold||2;if(0===Ge.inventory.key&&a.lockedChestsSkipped>=o)return console.log("[MazeMaster] Fairness: Mercy unlock triggered (".concat(a.lockedChestsSkipped," locked chests skipped)")),a.lockedChestsSkipped=0,Aa("Lucky break: Found the chest already unlocked!","Fairness"),!0;return!1}(Ge.profile)&&(o=!1,i=!0,e.mercyUnlocked=!0);const s=Ge.inventory.key>0;let r;r=i?"The lock on this chest is broken! Lucky you!":o?s?"A locked chest! Use a key to open it?":"A locked chest! You need a Key to open it.":"You found a chest!",Ge.currentMinion={name:o?"Locked Chest":"Chest",imagePath:"",message:r},Na();const l=(null===(a=Ge.profile)||void 0===a||null===(a=a.storyConfig)||void 0===a?void 0:a.mainStory)||"";qa(!0);try{const e=await async function(e){const{chestType:t,baseMessage:n,mainStory:a,hasKey:o}=e;if(!n)return"";if(!1===Re.llmEnabled)return n;if("function"!=typeof h)return n;const i="locked"===t?o?"a locked treasure chest - the player has a key to open it":"a locked treasure chest - the player lacks the key":"a treasure chest waiting to be opened",s=Q(),r="The player ".concat(s," has discovered ").concat(i," in a maze.\n\n").concat(a?"Story Setting: ".concat(a,"\n\n"):"",'Based on this chest discovery message: "').concat(n,'"\n\nWrite a short, atmospheric description of finding the chest (1-2 sentences, under 100 characters). Make it feel rewarding and mysterious. You may reference the player by name. Do not use quotation marks.');try{console.log("[MazeMaster] Generating LLM message for chest");const e=await h(r,{quietToLoud:!1,skipWIAN:!0,skipWI:!0,max_length:80});if(e&&e.trim()){let t=e.trim();return t=t.replace(/^["']|["']$/g,""),t=t.replace(/^["""''']|["""''']$/g,""),console.log("[MazeMaster] Generated chest message:",t),t}}catch(e){console.error("[MazeMaster] Chest LLM generation failed:",e)}return n}({chestType:o?"locked":"normal",baseMessage:r,mainStory:l,hasKey:s});Ge.currentMinion.message=e,Na()}catch(e){console.error("[MazeMaster] Chest message generation failed:",e)}finally{qa(!1)}!function(e,t){var n,a,o;let i="";i=e?t?'\n                <button id="maze_chest_unlock" class="menu_button maze-confirm-btn">Unlock</button>\n                <button id="maze_chest_ignore" class="menu_button maze-confirm-btn">Ignore</button>\n            ':'\n                <button id="maze_chest_ignore" class="menu_button maze-confirm-btn">Continue</button>\n            ':'\n            <button id="maze_chest_open" class="menu_button maze-confirm-btn">Open</button>\n            <button id="maze_chest_ignore" class="menu_button maze-confirm-btn">Ignore</button>\n        ';co(i),null===(n=document.getElementById("maze_chest_open"))||void 0===n||n.addEventListener("click",Qa),null===(a=document.getElementById("maze_chest_unlock"))||void 0===a||a.addEventListener("click",Za),null===(o=document.getElementById("maze_chest_ignore"))||void 0===o||o.addEventListener("click",$a)}(o,s)}function Qa(){mo();const{chestData:e,x:t,y:n}=Ge.pendingChest||{};e&&(Ge.grid[n][t].chest.opened=!0,Ra(),"mimic"!==e.type?e.mercyUnlocked?no(t,n):async function(e,t){Ge.pendingChest=null;const n=Ge.profile,a=Ge.grid[t][e].chest,o=oo(n,!1);if(a.guaranteedItems&&a.guaranteedItems.length>0)for(const e of a.guaranteedItems)void 0!==o[e]?o[e]++:o[e]=1;a.guaranteedFloorKey&&(o.floorKey=(o.floorKey||0)+1,console.log("[MazeMaster] Chest at (".concat(e,", ").concat(t,") gave guaranteed floor key")));io(o),ro(o,"Chest"),ao(o);const i=Object.entries(o).filter((e=>{let[t,n]=e;return n>0})).map((e=>{let[t,n]=e;return"".concat(t,"x").concat(n)}));Aa("Opened chest: ".concat(i.length>0?i.join(", "):"empty"),"Loot"),await Z("chestsOpened",1),await H("onChestOpen",{type:"normal",loot:JSON.stringify(o),x:e,y:t})}(t,n):lo(t,n))}function Za(){mo();const{chestData:e,x:t,y:n}=Ge.pendingChest||{};e&&(Xa("key"),Ge.grid[n][t].chest.opened=!0,Ra(),"mimic"!==e.type?no(t,n):lo(t,n))}function $a(){var e;mo(),"locked"===(null===(e=Ge)||void 0===e||null===(e=e.pendingChest)||void 0===e||null===(e=e.chestData)||void 0===e?void 0:e.type)&&0===Ge.inventory.key&&Ge.fairness&&(Ge.fairness.lockedChestsSkipped++,console.log("[MazeMaster] Fairness: Locked chest skipped (total: ".concat(Ge.fairness.lockedChestsSkipped,")"))),Ge.pendingChest=null,Ua()}async function eo(){var e,t;mo();const{x:n,y:a}=Ge.pendingSafeRoom||{};if(void 0===n||void 0===a)return;const o=null!==(e=(Ge.profile||{}).safeRoomHealPercent)&&void 0!==e?e:100;await j(o,!0,"safeRoom"),null!==(t=Ge.grid[a])&&void 0!==t&&null!==(t=t[n])&&void 0!==t&&t.safeRoom&&(Ge.grid[a][n].safeRoom.exhausted=!0),Ra(),Oa("Safe Room","You rest and recover ".concat(o,"% of your health.")),Ge.pendingSafeRoom=null,Ua()}function to(){mo(),Oa("Safe Room","You leave the sanctuary undisturbed. You can return later."),Ge.pendingSafeRoom=null,Ua()}async function no(e,t){Ge.pendingChest=null;const n=Ge.profile,a=Ge.grid[t][e].chest,o=oo(n,!0);if(a.guaranteedItems&&a.guaranteedItems.length>0)for(const e of a.guaranteedItems)void 0!==o[e]?o[e]++:o[e]=1;a.guaranteedFloorKey&&(o.floorKey=(o.floorKey||0)+1,console.log("[MazeMaster] Locked chest at (".concat(e,", ").concat(t,") gave guaranteed floor key"))),io(o),ro(o,"Locked Chest"),ao(o);const i=Object.entries(o).filter((e=>{let[t,n]=e;return n>0})).map((e=>{let[t,n]=e;return"".concat(t,"x").concat(n)}));Aa("Opened locked chest: ".concat(i.length>0?i.join(", "):"empty"),"Loot"),await Z("chestsOpened",1),await H("onChestOpen",{type:"locked",loot:JSON.stringify(o),x:e,y:t})}function ao(e){var t;if(null===(t=Ge)||void 0===t||!t.fairness)return;const n=Ge.fairness;e.key>0?n.chestsWithoutKey=0:n.chestsWithoutKey++;e.healingPotion>0||e.greaterHealing>0||e.elixir>0?(n.chestsWithoutHealing=0,n.lastHealingFoundFloor=Ge.currentFloor):n.chestsWithoutHealing++}function oo(e,t){var n;const a={key:0,strike:0,stealth:0,execute:0,floorKey:0,portalStone:0,minionBane:0,mapFragment:0,timeShard:0,voidWalk:0,healingPotion:0,greaterHealing:0,elixir:0,revivalCharm:0,heartCrystal:0,torch:0,lantern:0,revealScroll:0,sightPotion:0,crystalBall:0},o=e.chestLootMin||1,i=e.chestLootMax||2,s=o+Math.floor(Math.random()*(i-o+1)),r=N(e).chestLootMult||1,l=t?{key:(e.lockedChestKeyChance||40)*r,strike:(e.lockedChestStrikeChance||60)*r,stealth:(e.lockedChestStealthChance||30)*r,execute:(e.lockedChestExecuteChance||5)*r}:{key:(e.chestKeyChance||30)*r,strike:(e.chestStrikeChance||50)*r,stealth:(e.chestStealthChance||0)*r,execute:(e.chestExecuteChance||0)*r},c={floorKey:(t?20:10)*r,portalStone:(t?15:8)*r,minionBane:(t?12:5)*r,mapFragment:(t?25:15)*r,timeShard:(t?10:5)*r,voidWalk:(t?8:3)*r},d=!1!==e.hpEnabled?{healingPotion:(t?35:20)*r,greaterHealing:(t?15:8)*r,elixir:(t?5:2)*r,revivalCharm:(t?3:1)*r,heartCrystal:(t?2:.5)*r}:null,m={torch:(t?18:10)*r,lantern:(t?8:4)*r,revealScroll:(t?6:3)*r,sightPotion:(t?4:2)*r,crystalBall:(t?5:2)*r};if(t){const t=1+(e.chestLockedBonusPercent||50)/100;l.key=Math.min(100,l.key*t),l.strike=Math.min(100,l.strike*t),l.stealth=Math.min(100,l.stealth*t),l.execute=Math.min(100,l.execute*t);for(const e of Object.keys(c))c[e]=Math.min(100,c[e]*t);if(d)for(const e of Object.keys(d))d[e]=Math.min(100,d[e]*t);for(const e of Object.keys(m))m[e]=Math.min(100,m[e]*t)}const p=e.fairness||{};if(!1!==p.enabled&&null!==(n=Ge)&&void 0!==n&&n.fairness){const e=Ge.fairness;if(e.chestsWithoutKey>=(p.keyPityThreshold||3)){const t=Math.min(50,15*e.chestsWithoutKey);l.key=Math.min(100,l.key+t),console.log("[MazeMaster] Fairness: Key pity active (+".concat(t,"% key chance)"))}if(d&&Ge.hpEnabled&&Ge.hp){const t=Ge.hp.current/(Ge.hp.max+Ge.hp.maxBonus);if(t<=(p.lowHpThreshold||.4)){const e=Math.round(40*(1-t));d.healingPotion=Math.min(100,d.healingPotion+e),d.greaterHealing=Math.min(100,d.greaterHealing+e/2),console.log("[MazeMaster] Fairness: Low HP pity (+".concat(e,"% healing chance)"))}if(e.chestsWithoutHealing>=(p.healingPityThreshold||4)){const t=Math.min(30,8*e.chestsWithoutHealing);d.healingPotion=Math.min(100,d.healingPotion+t),console.log("[MazeMaster] Fairness: Healing drought pity (+".concat(t,"%)"))}}}for(let e=0;e<s;e++)100*Math.random()<l.key&&a.key++,100*Math.random()<l.strike&&a.strike++,100*Math.random()<l.stealth&&a.stealth++,100*Math.random()<l.execute&&a.execute++,100*Math.random()<c.floorKey&&a.floorKey++,100*Math.random()<c.portalStone&&a.portalStone++,100*Math.random()<c.minionBane&&a.minionBane++,100*Math.random()<c.mapFragment&&a.mapFragment++,100*Math.random()<c.timeShard&&a.timeShard++,100*Math.random()<c.voidWalk&&a.voidWalk++,d&&(100*Math.random()<d.healingPotion&&a.healingPotion++,100*Math.random()<d.greaterHealing&&a.greaterHealing++,100*Math.random()<d.elixir&&a.elixir++,100*Math.random()<d.revivalCharm&&a.revivalCharm++,100*Math.random()<d.heartCrystal&&a.heartCrystal++),100*Math.random()<m.torch&&a.torch++,100*Math.random()<m.lantern&&a.lantern++,100*Math.random()<m.revealScroll&&a.revealScroll++,100*Math.random()<m.sightPotion&&a.sightPotion++,100*Math.random()<m.crystalBall&&a.crystalBall++;return a}function io(e){e.key>0&&Va("key",e.key),e.strike>0&&Va("strike",e.strike),e.stealth>0&&Va("stealth",e.stealth),e.execute>0&&Va("execute",e.execute),e.floorKey>0&&Va("floorKey",e.floorKey),e.portalStone>0&&Va("portalStone",e.portalStone),e.minionBane>0&&Va("minionBane",e.minionBane),e.mapFragment>0&&Va("mapFragment",e.mapFragment),e.timeShard>0&&Va("timeShard",e.timeShard),e.voidWalk>0&&Va("voidWalk",e.voidWalk),e.healingPotion>0&&Va("healingPotion",e.healingPotion),e.greaterHealing>0&&Va("greaterHealing",e.greaterHealing),e.elixir>0&&Va("elixir",e.elixir),e.revivalCharm>0&&Va("revivalCharm",e.revivalCharm),e.heartCrystal>0&&Va("heartCrystal",e.heartCrystal),e.torch>0&&Va("torch",e.torch),e.lantern>0&&Va("lantern",e.lantern),e.revealScroll>0&&Va("revealScroll",e.revealScroll),e.sightPotion>0&&Va("sightPotion",e.sightPotion),e.crystalBall>0&&Va("crystalBall",e.crystalBall)}function so(e,t){Ge.currentMinion={name:t,imagePath:"",message:e},Na()}function ro(e,t){const n=[];e.key>0&&n.push("".concat(e.key," Key").concat(e.key>1?"s":"")),e.strike>0&&n.push("".concat(e.strike," Strike").concat(e.strike>1?"s":"")),e.stealth>0&&n.push("".concat(e.stealth," Stealth").concat(e.stealth>1?"s":"")),e.execute>0&&n.push("".concat(e.execute," GRANDSTRIKE!")),e.floorKey>0&&n.push("".concat(e.floorKey," Floor Key").concat(e.floorKey>1?"s":"")),e.portalStone>0&&n.push("".concat(e.portalStone," Portal Stone").concat(e.portalStone>1?"s":"")),e.minionBane>0&&n.push("".concat(e.minionBane," Minion Bane").concat(e.minionBane>1?"s":"")),e.mapFragment>0&&n.push("".concat(e.mapFragment," Map Fragment").concat(e.mapFragment>1?"s":"")),e.timeShard>0&&n.push("".concat(e.timeShard," Time Shard").concat(e.timeShard>1?"s":"")),e.voidWalk>0&&n.push("".concat(e.voidWalk," Void Walk").concat(e.voidWalk>1?"s":"")),e.healingPotion>0&&n.push("".concat(e.healingPotion," Healing Potion").concat(e.healingPotion>1?"s":"")),e.greaterHealing>0&&n.push("".concat(e.greaterHealing," Greater Healing").concat(e.greaterHealing>1?"s":"")),e.elixir>0&&n.push("".concat(e.elixir," Elixir").concat(e.elixir>1?"s":"")),e.revivalCharm>0&&n.push("".concat(e.revivalCharm," Revival Charm").concat(e.revivalCharm>1?"s":"")),e.heartCrystal>0&&n.push("".concat(e.heartCrystal," Heart Crystal").concat(e.heartCrystal>1?"s":"")),e.torch>0&&n.push("".concat(e.torch," Torch").concat(e.torch>1?"es":"")),e.lantern>0&&n.push("".concat(e.lantern," Lantern").concat(e.lantern>1?"s":"")),e.revealScroll>0&&n.push("".concat(e.revealScroll," Reveal Scroll").concat(e.revealScroll>1?"s":"")),e.sightPotion>0&&n.push("".concat(e.sightPotion," Sight Potion").concat(e.sightPotion>1?"s":"")),e.crystalBall>0&&n.push("".concat(e.crystalBall," Crystal Ball").concat(e.crystalBall>1?"s":""));so(n.length>0?"You found: ".concat(n.join(", "),"!"):"The chest was empty!",t),setTimeout((()=>Ua()),2e3)}function lo(e,t){Ge.pendingChest=null;const n=tt();if(n.length>0){const e=n[Math.floor(Math.random()*n.length)];Ge.pendingEncounter={type:"mimic_battlebar",profile:e},Ge.currentMinion={name:"Mimic!",imagePath:"",message:"The chest was a mimic! Prepare to fight!"},Na(),setTimeout((()=>{Nn(e)}),1e3)}else so("The chest was empty... and creepy.","Mimic"),setTimeout((()=>Ua()),1500)}function co(e){const t=document.getElementById("maze_action_popup"),n=document.getElementById("maze_action_popup_buttons");if(!t||!n)return;n.innerHTML=e,t.style.display="flex";const a=document.getElementById("maze_encounter_confirm");a&&(a.style.display="none",a.innerHTML="")}function mo(){const e=document.getElementById("maze_action_popup"),t=document.getElementById("maze_action_popup_buttons");e&&(e.style.display="none"),t&&(t.innerHTML="");const n=document.getElementById("maze_encounter_confirm");n&&(n.style.display="none",n.innerHTML="")}function po(){mo(),Ge.pendingConfirmation=null,Ua()}function uo(){console.log("[MazeMaster] handleConfirmAction called"),mo();const e=Ge.pendingConfirmation;if(console.log("[MazeMaster] pendingConfirmation:",e),!e)return void console.warn("[MazeMaster] No pending confirmation, returning");const t=St(e.minionId);switch(console.log("[MazeMaster] Minion for encounter:",e.minionId,t),console.log("[MazeMaster] Encounter type:",e.type),Ge.pendingConfirmation=null,e.type){case"battlebar":{const e=Pa(t.battlebarProfiles);console.log("[MazeMaster] Battlebar profiles:",t.battlebarProfiles,"-> selected:",e),e?(Ge.pendingEncounter={type:"battlebar",profile:e,minionName:t.name},Nn(e,t.name)):(console.warn("[MazeMaster] No battlebar profile found, resuming maze"),Ua());break}case"prizewheel":{const e=Pa(t.wheelProfiles);console.log("[MazeMaster] Wheel profiles:",t.wheelProfiles,"-> selected:",e),e?(Ge.pendingEncounter={type:"wheel",profile:e},Tt(e),Lt()):(console.warn("[MazeMaster] No wheel profile found, resuming maze"),Ua());break}case"turnbased":{const e=Pa(t.turnbasedProfiles);console.log("[MazeMaster] Turnbased profiles:",t.turnbasedProfiles,"-> selected:",e),e?(Ge.pendingEncounter={type:"turnbased",profile:e,minionName:t.name},console.log("[MazeMaster] Calling startTurnBased with profile:",e),Ot(e,t.name)):(console.warn("[MazeMaster] No turnbased profile found, resuming maze"),Ua());break}case"qte":{const e=Pa(t.qteProfiles);console.log("[MazeMaster] QTE profiles:",t.qteProfiles,"-> selected:",e),e?(Ge.pendingEncounter={type:"qte",profile:e,minionName:t.name},console.log("[MazeMaster] Calling startQTE with profile:",e),Jt(e,t.name)):(console.warn("[MazeMaster] No QTE profile found, resuming maze"),Ua());break}case"dice":{const e=Pa(t.diceProfiles);console.log("[MazeMaster] Dice profiles:",t.diceProfiles,"-> selected:",e),e?(Ge.pendingEncounter={type:"dice",profile:e,minionName:t.name},console.log("[MazeMaster] Calling startDice with profile:",e),sn(e,t.name)):(console.warn("[MazeMaster] No dice profile found, resuming maze"),Ua());break}case"stealth":{const e=Pa(t.stealthProfiles);console.log("[MazeMaster] Stealth profiles:",t.stealthProfiles,"-> selected:",e),e?(Ge.pendingEncounter={type:"stealth",profile:e,minionName:t.name},console.log("[MazeMaster] Calling startStealth with profile:",e),un(e,t.name)):(console.warn("[MazeMaster] No stealth profile found, resuming maze"),Ua());break}case"puzzle":{const e=Pa(t.puzzleProfiles);console.log("[MazeMaster] Puzzle profiles:",t.puzzleProfiles,"-> selected:",e),e?(Ge.pendingEncounter={type:"puzzle",profile:e,minionName:t.name},console.log("[MazeMaster] Calling startPuzzle with profile:",e),yn(e,t.name)):(console.warn("[MazeMaster] No puzzle profile found, resuming maze"),Ua());break}case"negotiation":{const e=Pa(t.negotiationProfiles);console.log("[MazeMaster] Negotiation profiles:",t.negotiationProfiles,"-> selected:",e),e?(Ge.pendingEncounter={type:"negotiation",profile:e,minionName:t.name},console.log("[MazeMaster] Calling startNegotiation with profile:",e),Mn(e,t.name)):(console.warn("[MazeMaster] No negotiation profile found, resuming maze"),Ua());break}default:console.warn("[MazeMaster] Unknown encounter type: ".concat(e.type)),Ua()}}function ho(){mo(),Ge.inventory.stealth>0&&(Xa("stealth"),Ge.pendingConfirmation=null,Ua())}function go(){const e=Ge.pendingConfirmation;e&&"merchant"===e.type&&(mo(),function(e,t){const n=St(e);if(!n)return;Ln={isOpen:!0,minionId:e,minion:n,offeredItems:t,selectedItem:null};const a=document.getElementById("mazemaster_merchant_modal");if(a&&a.remove(),!document.getElementById("mazemaster_merchant_styles")){const e=document.createElement("style");e.id="mazemaster_merchant_styles",e.textContent="\n        .mazemaster-merchant-container {\n            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f0f1a 100%);\n            border: 2px solid #d4af37;\n            border-radius: 15px;\n            padding: 25px;\n            min-width: 400px;\n            max-width: 600px;\n            box-shadow: 0 0 40px rgba(212, 175, 55, 0.3);\n            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\n            color: #e0e0e0;\n        }\n\n        .merchant-header {\n            text-align: center;\n            margin-bottom: 20px;\n        }\n\n        .merchant-title {\n            font-size: 1.8em;\n            font-weight: bold;\n            color: #d4af37;\n            text-shadow: 0 0 10px rgba(212, 175, 55, 0.5);\n            margin-bottom: 5px;\n        }\n\n        .merchant-subtitle {\n            font-size: 1em;\n            color: #aaa;\n            font-style: italic;\n        }\n\n        .merchant-items-grid {\n            display: grid;\n            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n            gap: 15px;\n            margin-bottom: 20px;\n            max-height: 400px;\n            overflow-y: auto;\n            padding: 10px;\n        }\n\n        .merchant-item-card {\n            background: rgba(0, 0, 0, 0.4);\n            border: 2px solid #444;\n            border-radius: 12px;\n            padding: 15px;\n            text-align: center;\n            cursor: pointer;\n            transition: all 0.3s ease;\n            position: relative;\n        }\n\n        .merchant-item-card:hover {\n            border-color: #d4af37;\n            transform: translateY(-2px);\n            box-shadow: 0 5px 20px rgba(212, 175, 55, 0.3);\n        }\n\n        .merchant-item-card.selected {\n            border-color: #4ade80;\n            background: rgba(74, 222, 128, 0.15);\n            box-shadow: 0 0 25px rgba(74, 222, 128, 0.4);\n        }\n\n        .merchant-item-card.selected::after {\n            content: '';\n            position: absolute;\n            top: 5px;\n            right: 8px;\n            font-size: 1.2em;\n            color: #4ade80;\n        }\n\n        .merchant-item-icon {\n            font-size: 2.5em;\n            margin-bottom: 10px;\n            display: block;\n        }\n\n        .merchant-item-name {\n            font-size: 1.1em;\n            font-weight: bold;\n            color: #d4af37;\n            margin-bottom: 5px;\n        }\n\n        .merchant-item-description {\n            font-size: 0.85em;\n            color: #888;\n            line-height: 1.3;\n        }\n\n        .merchant-footer {\n            display: flex;\n            gap: 15px;\n            justify-content: center;\n        }\n\n        .merchant-btn {\n            padding: 12px 25px;\n            border: none;\n            border-radius: 8px;\n            cursor: pointer;\n            font-size: 1em;\n            font-weight: bold;\n            transition: all 0.2s ease;\n            display: flex;\n            align-items: center;\n            gap: 8px;\n        }\n\n        .merchant-take-btn {\n            background: linear-gradient(135deg, #27ae60 0%, #1e8449 100%);\n            color: white;\n        }\n\n        .merchant-take-btn:disabled {\n            background: #444;\n            cursor: not-allowed;\n            opacity: 0.6;\n        }\n\n        .merchant-take-btn:not(:disabled):hover {\n            transform: scale(1.05);\n            box-shadow: 0 0 15px rgba(39, 174, 96, 0.5);\n        }\n\n        .merchant-decline-btn {\n            background: linear-gradient(135deg, #7f8c8d 0%, #5a6c7d 100%);\n            color: white;\n        }\n\n        .merchant-decline-btn:hover {\n            transform: scale(1.05);\n            box-shadow: 0 0 15px rgba(127, 140, 141, 0.5);\n        }\n    ",document.head.appendChild(e)}document.body.insertAdjacentHTML("beforeend",'\n        <div id="mazemaster_merchant_modal" style="position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:999999;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.9);">\n            <div class="mazemaster-merchant-container">\n                <div class="merchant-header">\n                    <div id="merchant_title" class="merchant-title">Merchant Wares</div>\n                    <div id="merchant_subtitle" class="merchant-subtitle">Choose one item to take</div>\n                </div>\n\n                <div id="merchant_items" class="merchant-items-grid">\n                    \x3c!-- Items will be dynamically inserted here --\x3e\n                </div>\n\n                <div class="merchant-footer">\n                    <button id="merchant_take_btn" class="merchant-btn merchant-take-btn" disabled>\n                        <i class="fa-solid fa-hand"></i> Take Selected Item\n                    </button>\n                    <button id="merchant_decline_btn" class="merchant-btn merchant-decline-btn">\n                        <i class="fa-solid fa-xmark"></i> Leave Without Taking\n                    </button>\n                </div>\n            </div>\n        </div>\n    '),document.getElementById("merchant_title").textContent=n.name||"Merchant Wares";const o=document.getElementById("merchant_items");o.innerHTML=t.map(((e,t)=>'\n        <div class="merchant-item-card" data-item-index="'.concat(t,'" data-item-id="').concat(e.id,'">\n            <span class="merchant-item-icon">').concat(e.icon||"",'</span>\n            <div class="merchant-item-name">').concat(e.name,'</div>\n            <div class="merchant-item-description">').concat(e.description,"</div>\n        </div>\n    "))).join(""),o.querySelectorAll(".merchant-item-card").forEach((e=>{e.addEventListener("click",(()=>{o.querySelectorAll(".merchant-item-card").forEach((e=>e.classList.remove("selected"))),e.classList.add("selected"),Ln.selectedItem=t[parseInt(e.dataset.itemIndex)],document.getElementById("merchant_take_btn").disabled=!1}))})),document.getElementById("merchant_take_btn").addEventListener("click",An),document.getElementById("merchant_decline_btn").addEventListener("click",On)}(e.minionId,e.offeredItems||[]))}function fo(){mo(),Ge.pendingConfirmation=null,Ua()}function vo(){Ge.isVictory=!1,Ge.isPaused=!0,Aa("DEFEAT! Adventure ended.","End"),ie(),ae("lose"),Ue.maze[Ge.profileName]={result:"lose",timestamp:Date.now()},document.getElementById("maze_minion_name").textContent="Defeat!",Oa("Defeat!","You have been defeated...");const e=document.getElementById("maze_minion_img");e&&(e.style.display="none");const t=document.getElementById("maze_close_btn");t&&(t.style.display=""),Ge.profile.loseCommand&&O(Ge.profile.loseCommand),document.removeEventListener("keydown",ja,{capture:!0})}function bo(){Ge.playerX=0,Ge.playerY=0,Ge.isPaused=!1,Ge.pendingEncounter=null,Ra(),ce();const e=Ge.profile;if(e.mainMinion){const t=St(e.mainMinion);if(t)return Ge.currentMinion={name:t.name,imagePath:t.imagePath,message:"Back to the beginning with you!"},void Na()}Ge.currentMinion={name:"The Maze",imagePath:"",message:"Find your way to the exit..."},Na()}async function yo(){Ge.isVictory=!0,Aa("VICTORY! Maze completed.","End"),ie(),ae("win"),Ue.maze[Ge.profileName]={result:"win",timestamp:Date.now()},Na(),Ra();const e=document.getElementById("maze_close_btn");e&&(e.style.display="");const t=document.querySelector(".mazemaster-maze-controls");t&&(t.style.display="none"),document.removeEventListener("keydown",ja,{capture:!0}),Ge.profile.winCommand&&await O(Ge.profile.winCommand),console.log('[MazeMaster] Maze "'.concat(Ge.profileName,'" completed!')),await Ia(2500),La();const n=document.querySelector('.mazemaster-tab[data-tab="game"]');n&&n.click()}function zo(){var e,t,n,a,o,i,s,r,l,c,d,m,p,u,h,g,f,v,b,y,z,x,_,w,k,C,S,M,E,P,I,T,B,D,L,R,A,O,H,N,q,F,j,W,Y,G,U,K,V;const X=$e(),J=Re.currentProfile||"default",Q=tt(),Z=Re.currentBattlebarProfile||"default",$=nt(Z)||{},ee=_t(),te=Re.currentMazeProfile||"default",ne=wt(te)||{},ae=Ct(),oe=Re.activeGameConfig||"maze";return'\n        <div class="mazemaster-panel">\n            <div class="mazemaster-panel-header">\n                <h2><i class="fa-solid fa-gamepad"></i> MazeMaster</h2>\n            </div>\n            <div class="mazemaster-tabs">\n                <button class="mazemaster-tab active" data-tab="game">Game</button>\n                <button class="mazemaster-tab" data-tab="config">Config</button>\n                <button class="mazemaster-tab" data-tab="help">Help</button>\n            </div>\n            <div class="mazemaster-panel-content">\n                \x3c!-- GAME TAB --\x3e\n                <div class="mazemaster-tab-content active" id="mazemaster-tab-game">\n                    <div class="mazemaster-game-launch">\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Maze Profile</label>\n                            <select id="mazemaster_play_profile" class="mazemaster-select">\n                                '.concat(0===ee.length?'<option value="">No profiles</option>':"","\n                                ").concat(ee.map((e=>'<option value="'.concat(_o(e),'" ').concat(e===te?"selected":"",">").concat(_o(e),"</option>"))).join(""),'\n                            </select>\n                        </div>\n                        <button id="mazemaster_play_maze" class="menu_button menu_button_primary mazemaster-play-btn">\n                            <i class="fa-solid fa-play"></i> Play Maze\n                        </button>\n                    </div>\n\n                    \x3c!-- LLM Generation Settings --\x3e\n                    <div class="mazemaster-section">\n                        <label class="mazemaster-label"><i class="fa-solid fa-brain"></i> LLM Message Generation</label>\n                        <div class="mazemaster-form-group">\n                            <label>Generation Preset</label>\n                            <select id="mazemaster_llm_preset" class="mazemaster-select">\n                                <option value="">(Use Current)</option>\n                                \x3c!-- Presets populated dynamically --\x3e\n                            </select>\n                        </div>\n                        <label class="mazemaster-checkbox-label">\n                            <input type="checkbox" id="mazemaster_llm_enabled" ').concat(!1!==Re.llmEnabled?"checked":"",'>\n                            Enable LLM message generation\n                        </label>\n                        <label class="mazemaster-checkbox-label">\n                            <input type="checkbox" id="mazemaster_close_chat" ').concat(!1!==Re.closeChatOnStart?"checked":"",'>\n                            Close current chat before starting (prevents context bleed)\n                        </label>\n                    </div>\n\n                    \x3c!-- D-Pad Settings --\x3e\n                    <div class="mazemaster-section">\n                        <label class="mazemaster-label"><i class="fa-solid fa-gamepad"></i> D-Pad Controls</label>\n                        <label class="mazemaster-checkbox-label">\n                            <input type="checkbox" id="mazemaster_dpad_enabled" ').concat(!1!==(null===(e=Re.dpadConfig)||void 0===e?void 0:e.enabled)?"checked":"",'>\n                            Enable D-Pad controls\n                        </label>\n                        <label class="mazemaster-checkbox-label">\n                            <input type="checkbox" id="mazemaster_dpad_floating" ').concat(!1!==(null===(t=Re.dpadConfig)||void 0===t?void 0:t.floating)?"checked":"",'>\n                            Floating D-Pad (draggable position)\n                        </label>\n                        <button id="mazemaster_dpad_reset" class="menu_button" style="margin-top: 6px;">\n                            <i class="fa-solid fa-rotate-left"></i> Reset D-Pad Position\n                        </button>\n                    </div>\n\n                    \x3c!-- Renderer Settings --\x3e\n                    <div class="mazemaster-section">\n                        <label class="mazemaster-label"><i class="fa-solid fa-cube"></i> Renderer</label>\n                        <select id="mazemaster_renderer_type" class="mazemaster-select">\n                            <option value="css-grid" ').concat("css-grid"===Re.rendererType?"selected":"",'>Classic (CSS Grid)</option>\n                            <option value="isometric" ').concat("isometric"===(Re.rendererType||"isometric")?"selected":"",'>Isometric 2.5D</option>\n                            <option value="canvas" ').concat("canvas"===Re.rendererType?"selected":"",'>Canvas (Experimental)</option>\n                        </select>\n                        <div class="mazemaster-help-small"><small>Isometric gives a 3D-like view. Requires restart of active maze.</small></div>\n                    </div>\n\n                    \x3c!-- Layout Mode --\x3e\n                    <div class="mazemaster-section">\n                        <label class="mazemaster-label"><i class="fa-solid fa-mobile-screen"></i> Layout Mode</label>\n                        <select id="mazemaster_layout_mode" class="mazemaster-select">\n                            <option value="auto" ').concat("auto"===Re.layoutMode?"selected":"",' disabled>Auto-detect (disabled)</option>\n                            <option value="desktop" ').concat("desktop"===(Re.layoutMode||"desktop")?"selected":"",'>Desktop (Horizontal)</option>\n                            <option value="mobile" ').concat("mobile"===Re.layoutMode?"selected":"",' disabled>Mobile (Vertical) (disabled)</option>\n                        </select>\n                        <div class="mazemaster-help-small"><small>Mobile layout stacks UI vertically for portrait screens.</small></div>\n                    </div>\n\n                    \x3c!-- Saved Games in Game Tab --\x3e\n                    <div class="mazemaster-section">\n                        <label class="mazemaster-label"><i class="fa-solid fa-floppy-disk"></i> Saved Games</label>\n                        <div id="mazemaster_game_tab_saves" class="mazemaster-saved-games-list">\n                            \x3c!-- Saved games rendered here --\x3e\n                        </div>\n                    </div>\n                </div>\n\n                \x3c!-- CONFIG TAB --\x3e\n                <div class="mazemaster-tab-content" id="mazemaster-tab-config">\n                    \x3c!-- Game Selector --\x3e\n                    <div class="mazemaster-game-selector">\n                        <button id="mazemaster_show_maze" class="menu_button mazemaster-game-btn ').concat("maze"===oe?"active":"",'">\n                            <i class="fa-solid fa-border-all"></i> Maze\n                        </button>\n                        <button id="mazemaster_show_wheel" class="menu_button mazemaster-game-btn ').concat("wheel"===oe?"active":"",'">\n                            <i class="fa-solid fa-dharmachakra"></i> Wheel\n                        </button>\n                        <button id="mazemaster_show_combat" class="menu_button mazemaster-game-btn ').concat("combat"===oe?"active":"",'">\n                            <i class="fa-solid fa-khanda"></i> Combat\n                        </button>\n                        <button id="mazemaster_show_minions" class="menu_button mazemaster-game-btn ').concat("minions"===oe?"active":"",'">\n                            <i class="fa-solid fa-ghost"></i> Minions\n                        </button>\n                        <button id="mazemaster_show_traps" class="menu_button mazemaster-game-btn ').concat("traps"===oe?"active":"",'">\n                            <i class="fa-solid fa-dungeon"></i> Traps\n                        </button>\n                    </div>\n\n                    \x3c!-- WHEEL CONFIG --\x3e\n                    <div id="mazemaster_wheel_config" class="mazemaster-game-config" style="').concat("wheel"===oe?"":"display: none;",'">\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Wheel Profile</label>\n                            <div class="mazemaster-profile-row">\n                                <select id="mazemaster_profile_select" class="mazemaster-select">\n                                    ').concat(0===X.length?'<option value="">No profiles</option>':"","\n                                    ").concat(X.map((e=>'<option value="'.concat(_o(e),'" ').concat(e===J?"selected":"",">").concat(_o(e),"</option>"))).join(""),'\n                                </select>\n                                <button id="mazemaster_new_profile_btn" class="menu_button menu_button_icon" title="New Profile">\n                                    <i class="fa-solid fa-plus"></i>\n                                </button>\n                                <button id="mazemaster_delete_profile_btn" class="menu_button menu_button_icon" title="Delete Profile">\n                                    <i class="fa-solid fa-trash"></i>\n                                </button>\n                                <button id="mazemaster_rename_profile_btn" class="menu_button menu_button_icon" title="Rename Profile">\n                                    <i class="fa-solid fa-pen"></i>\n                                </button>\n                                <button id="mazemaster_export_btn" class="menu_button menu_button_icon" title="Export Profile">\n                                    <i class="fa-solid fa-download"></i>\n                                </button>\n                                <button id="mazemaster_import_btn" class="menu_button menu_button_icon" title="Import Profile">\n                                    <i class="fa-solid fa-upload"></i>\n                                </button>\n                                <input type="file" id="mazemaster_import_file" accept=".json" style="display: none;">\n                                <button id="mazemaster_preview_wheel_btn" class="menu_button menu_button_icon" title="Preview Wheel">\n                                    <i class="fa-solid fa-eye"></i>\n                                </button>\n                            </div>\n                        </div>\n\n                        <div class="mazemaster-section mazemaster-profile-settings">\n                            <div class="mazemaster-profile-options">\n                                <label class="mazemaster-checkbox-label">\n                                    <input type="checkbox" id="mazemaster_randomize" ').concat(null!==(n=et(J))&&void 0!==n&&n.randomize?"checked":"",'>\n                                    Randomize segment positions\n                                </label>\n                                <div class="mazemaster-difficulty-row">\n                                    <label>Difficulty:</label>\n                                    <select id="mazemaster_difficulty" class="mazemaster-select-small">\n                                        ').concat([1,2,3,4,5].map((e=>{var t;return'<option value="'.concat(e,'" ').concat(((null===(t=et(J))||void 0===t?void 0:t.difficulty)||1)===e?"selected":"",">").concat(e,"</option>")})).join(""),'\n                                    </select>\n                                </div>\n                            </div>\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Segments</label>\n                            <div id="mazemaster_segments_list" class="mazemaster-segments-list">\n                                \x3c!-- Segments rendered here --\x3e\n                            </div>\n                            <button id="mazemaster_add_segment_btn" class="menu_button mazemaster-add-btn">\n                                <i class="fa-solid fa-plus"></i> Add Segment\n                            </button>\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <button id="mazemaster_save_btn" class="menu_button menu_button_primary mazemaster-save-btn">\n                                <i class="fa-solid fa-save"></i> Save Profile\n                            </button>\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <div class="mazemaster-help">\n                                <div class="mazemaster-help-title">Usage:</div>\n                                <code>/wheel profile="profileName"</code>\n                                <div class="mazemaster-help-title">Sizes:</div>\n                                <ul>\n                                    <li><code>fraction</code> - Normal (1x)</li>\n                                    <li><code>halfseg</code> - Half (0.5x)</li>\n                                    <li><code>doubleseg</code> - Double (2x)</li>\n                                </ul>\n                                <small>halfseg count must equal doubleseg count</small>\n                            </div>\n                        </div>\n                    </div>\n\n                    \x3c!-- COMBAT CONFIG (with sub-tabs) --\x3e\n                    <div id="mazemaster_combat_config" class="mazemaster-game-config" style="').concat("combat"===oe?"":"display: none;",'">\n                        \x3c!-- Combat Sub-tabs --\x3e\n                        <div class="mazemaster-combat-subtabs">\n                            <button class="combat-subtab active" data-combat="battlebar">Battlebar</button>\n                            <button class="combat-subtab" data-combat="turnbased">Turn-Based</button>\n                            <button class="combat-subtab" data-combat="qte">QTE</button>\n                            <button class="combat-subtab" data-combat="dice">Dice</button>\n                            <button class="combat-subtab" data-combat="stealth">Stealth</button>\n                            <button class="combat-subtab" data-combat="puzzle">Puzzle</button>\n                            <button class="combat-subtab" data-combat="negotiation">Negotiation</button>\n                        </div>\n\n                        \x3c!-- BATTLEBAR SUB-TAB --\x3e\n                        <div id="combat_battlebar_content" class="combat-content active">\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Battlebar Profile</label>\n                            <div class="mazemaster-profile-row">\n                                <select id="mazemaster_bb_profile_select" class="mazemaster-select">\n                                    ').concat(0===Q.length?'<option value="">No profiles</option>':"","\n                                    ").concat(Q.map((e=>'<option value="'.concat(_o(e),'" ').concat(e===Z?"selected":"",">").concat(_o(e),"</option>"))).join(""),'\n                                </select>\n                                <button id="mazemaster_bb_new_profile_btn" class="menu_button menu_button_icon" title="New Profile">\n                                    <i class="fa-solid fa-plus"></i>\n                                </button>\n                                <button id="mazemaster_bb_delete_profile_btn" class="menu_button menu_button_icon" title="Delete Profile">\n                                    <i class="fa-solid fa-trash"></i>\n                                </button>\n                                <button id="mazemaster_bb_rename_profile_btn" class="menu_button menu_button_icon" title="Rename Profile">\n                                    <i class="fa-solid fa-pen"></i>\n                                </button>\n                                <button id="mazemaster_bb_export_btn" class="menu_button menu_button_icon" title="Export Profile">\n                                    <i class="fa-solid fa-download"></i>\n                                </button>\n                                <button id="mazemaster_bb_import_btn" class="menu_button menu_button_icon" title="Import Profile">\n                                    <i class="fa-solid fa-upload"></i>\n                                </button>\n                                <input type="file" id="mazemaster_bb_import_file" accept=".json" style="display: none;">\n                                <button id="mazemaster_preview_battlebar_btn" class="menu_button menu_button_icon" title="Preview Battlebar">\n                                    <i class="fa-solid fa-eye"></i>\n                                </button>\n                            </div>\n                        </div>\n\n                        <div class="mazemaster-section mazemaster-profile-settings">\n                            <div class="mazemaster-bb-settings">\n                                <div class="mazemaster-bb-row">\n                                    <div class="mazemaster-bb-field" style="flex: 2;">\n                                        <label>Difficulty <span id="mazemaster_bb_diff_val" style="opacity: 0.7;">(').concat($.difficulty||5,')</span></label>\n                                        <input type="range" id="mazemaster_bb_difficulty" min="1" max="10" value="').concat($.difficulty||5,'" style="width: 100%;">\n                                    </div>\n                                    <div class="mazemaster-bb-field">\n                                        <label>Damage</label>\n                                        <input type="number" id="mazemaster_bb_damage" min="0" max="100" value="').concat($.damage||25,'" title="HP damage on loss">\n                                    </div>\n                                    <div class="mazemaster-bb-field">\n                                        <label>Hits to Win</label>\n                                        <input type="number" id="mazemaster_bb_hits" min="1" max="20" value="').concat($.hitsToWin||5,'">\n                                    </div>\n                                    <div class="mazemaster-bb-field">\n                                        <label>Misses to Lose</label>\n                                        <input type="number" id="mazemaster_bb_misses" min="1" max="20" value="').concat($.missesToLose||3,'">\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Main Title</label>\n                            <input type="text" id="mazemaster_bb_main_title" class="mazemaster-input" placeholder="e.g. Boss Battle!" value="').concat(_o($.mainTitle||""),'">\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Commands</label>\n                            <div class="mazemaster-bb-commands">\n                                <div class="mazemaster-bb-command">\n                                    <label>On Hit:</label>\n                                    <textarea id="mazemaster_bb_hit_cmd" placeholder="/echo Hit!">').concat(_o($.hitCommand||""),'</textarea>\n                                </div>\n                                <div class="mazemaster-bb-command">\n                                    <label>On Miss:</label>\n                                    <textarea id="mazemaster_bb_miss_cmd" placeholder="/echo Miss!">').concat(_o($.missCommand||""),'</textarea>\n                                </div>\n                                <div class="mazemaster-bb-command">\n                                    <label>On Win:</label>\n                                    <textarea id="mazemaster_bb_win_cmd" placeholder="/echo Victory!">').concat(_o($.winCommand||""),'</textarea>\n                                </div>\n                                <div class="mazemaster-bb-command">\n                                    <label>On Lose:</label>\n                                    <textarea id="mazemaster_bb_lose_cmd" placeholder="/echo Defeat!">').concat(_o($.loseCommand||""),'</textarea>\n                                </div>\n                            </div>\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Stages (click image to edit message)</label>\n                            <div id="mazemaster_bb_images_list" class="mazemaster-bb-images-list">\n                                \x3c!-- Images rendered here --\x3e\n                            </div>\n                            <button id="mazemaster_bb_add_image_btn" class="menu_button mazemaster-add-btn">\n                                <i class="fa-solid fa-plus"></i> Add Image\n                            </button>\n                            <input type="file" id="mazemaster_bb_image_file" accept="image/*" style="display: none;">\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Item Drops on Win (Maze Only)</label>\n                            <div class="mazemaster-row">\n                                <label>Key %</label>\n                                <input type="number" id="mazemaster_bb_key_drop" class="mazemaster-input-small" min="0" max="100" value="').concat(null!==(a=$.keyDropChance)&&void 0!==a?a:40,'">\n                            </div>\n                            <div class="mazemaster-row">\n                                <label>Strike %</label>\n                                <input type="number" id="mazemaster_bb_pow_drop" class="mazemaster-input-small" min="0" max="100" value="').concat(null!==(o=$.strikeDropChance)&&void 0!==o?o:20,'">\n                            </div>\n                            <div class="mazemaster-row">\n                                <label>Stealth %</label>\n                                <input type="number" id="mazemaster_bb_stealth_drop" class="mazemaster-input-small" min="0" max="100" value="').concat(null!==(i=$.stealthDropChance)&&void 0!==i?i:10,'">\n                            </div>\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <button id="mazemaster_bb_save_btn" class="menu_button menu_button_primary mazemaster-save-btn">\n                                <i class="fa-solid fa-save"></i> Save Profile\n                            </button>\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <div class="mazemaster-help">\n                                <div class="mazemaster-help-title">Usage:</div>\n                                <code>/battlebar profile="profileName"</code>\n                                <div class="mazemaster-help-title">Difficulty:</div>\n                                <ul>\n                                    <li><code>1</code> - Easy (large zone, slow)</li>\n                                    <li><code>5</code> - Medium</li>\n                                    <li><code>10</code> - Hard (small zone, fast)</li>\n                                </ul>\n                            </div>\n                        </div>\n                        </div>\x3c!-- End combat_battlebar_content --\x3e\n\n                        \x3c!-- TURN-BASED SUB-TAB --\x3e\n                        <div id="combat_turnbased_content" class="combat-content">\n                            <div class="mazemaster-section">\n                                <label class="mazemaster-label">Turn-Based Profile</label>\n                                <div class="mazemaster-profile-row">\n                                    <select id="mazemaster_tb_profile_select" class="mazemaster-select">\n                                        ').concat(0===ot().length?'<option value="">No profiles</option>':"","\n                                        ").concat(ot().map((e=>'<option value="'.concat(_o(e),'" ').concat(e===Re.currentTurnbasedProfile?"selected":"",">").concat(_o(e),"</option>"))).join(""),'\n                                    </select>\n                                    <button id="mazemaster_tb_new_profile_btn" class="menu_button menu_button_icon" title="New Profile">\n                                        <i class="fa-solid fa-plus"></i>\n                                    </button>\n                                    <button id="mazemaster_tb_delete_profile_btn" class="menu_button menu_button_icon" title="Delete Profile">\n                                        <i class="fa-solid fa-trash"></i>\n                                    </button>\n                                    <button id="mazemaster_tb_rename_profile_btn" class="menu_button menu_button_icon" title="Rename Profile">\n                                        <i class="fa-solid fa-pen"></i>\n                                    </button>\n                                    <button id="mazemaster_preview_turnbased_btn" class="menu_button menu_button_icon" title="Preview Turn-Based">\n                                        <i class="fa-solid fa-eye"></i>\n                                    </button>\n                                </div>\n                            </div>\n\n                            <div class="mazemaster-section">\n                                <label class="mazemaster-label">Display</label>\n                                <div class="mazemaster-row">\n                                    <label>Title</label>\n                                    <input type="text" id="mazemaster_tb_main_title" class="mazemaster-input" placeholder="Combat!" value="">\n                                </div>\n                                <div class="mazemaster-row">\n                                    <label>Enemy Name</label>\n                                    <input type="text" id="mazemaster_tb_enemy_name" class="mazemaster-input" placeholder="Enemy" value="">\n                                </div>\n                                <div class="mazemaster-row">\n                                    <label>Description</label>\n                                    <textarea id="mazemaster_tb_description" class="mazemaster-input" rows="2" placeholder="A fierce battle awaits..."></textarea>\n                                </div>\n                            </div>\n\n                            <div class="mazemaster-section">\n                                <label class="mazemaster-label">Combat Stats</label>\n                                <div class="mazemaster-combat-grid">\n                                    <div class="mazemaster-combat-col">\n                                        <strong style="color: #2ecc71;">Player</strong>\n                                        <div class="mazemaster-row">\n                                            <label>HP</label>\n                                            <input type="number" id="mazemaster_tb_player_hp" class="mazemaster-input-small" min="1" max="999" value="100">\n                                        </div>\n                                        <div class="mazemaster-row">\n                                            <label>Attack</label>\n                                            <input type="number" id="mazemaster_tb_player_attack" class="mazemaster-input-small" min="1" max="99" value="15">\n                                        </div>\n                                        <div class="mazemaster-row">\n                                            <label>Defense</label>\n                                            <input type="number" id="mazemaster_tb_player_defense" class="mazemaster-input-small" min="0" max="99" value="5">\n                                        </div>\n                                    </div>\n                                    <div class="mazemaster-combat-col">\n                                        <strong style="color: #e74c3c;">Enemy</strong>\n                                        <div class="mazemaster-row">\n                                            <label>HP</label>\n                                            <input type="number" id="mazemaster_tb_enemy_hp" class="mazemaster-input-small" min="1" max="999" value="50">\n                                        </div>\n                                        <div class="mazemaster-row">\n                                            <label>Attack</label>\n                                            <input type="number" id="mazemaster_tb_enemy_attack" class="mazemaster-input-small" min="1" max="99" value="8">\n                                        </div>\n                                        <div class="mazemaster-row">\n                                            <label>Defense</label>\n                                            <input type="number" id="mazemaster_tb_enemy_defense" class="mazemaster-input-small" min="0" max="99" value="2">\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n\n                            <div class="mazemaster-section">\n                                <label class="mazemaster-label">Mechanics</label>\n                                <div class="mazemaster-bb-settings">\n                                    <div class="mazemaster-bb-row">\n                                        <div class="mazemaster-bb-field">\n                                            <label>Turn Order</label>\n                                            <select id="mazemaster_tb_turn_order" class="mazemaster-select">\n                                                <option value="player_first">Player First</option>\n                                                <option value="enemy_first">Enemy First</option>\n                                                <option value="random">Random</option>\n                                            </select>\n                                        </div>\n                                        <div class="mazemaster-bb-field">\n                                            <label>Flee Chance %</label>\n                                            <input type="number" id="mazemaster_tb_flee_chance" class="mazemaster-input-small" min="0" max="100" value="50">\n                                        </div>\n                                        <div class="mazemaster-bb-field">\n                                            <label>Crit Chance %</label>\n                                            <input type="number" id="mazemaster_tb_crit_chance" class="mazemaster-input-small" min="0" max="100" value="15">\n                                        </div>\n                                        <div class="mazemaster-bb-field">\n                                            <label>Crit Multiplier</label>\n                                            <input type="number" id="mazemaster_tb_crit_mult" class="mazemaster-input-small" min="1" max="5" step="0.1" value="1.5">\n                                        </div>\n                                    </div>\n                                    <div class="mazemaster-bb-row">\n                                        <div class="mazemaster-bb-field" style="flex: 2;">\n                                            <label>Difficulty <span id="mazemaster_tb_diff_val" style="opacity: 0.7;">(5)</span></label>\n                                            <input type="range" id="mazemaster_tb_difficulty" min="1" max="10" value="5" style="width: 100%;">\n                                        </div>\n                                        <div class="mazemaster-bb-field">\n                                            <label>Damage on Loss</label>\n                                            <input type="number" id="mazemaster_tb_damage" class="mazemaster-input-small" min="0" max="100" value="15">\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n\n                            <div class="mazemaster-section">\n                                <label class="mazemaster-label">STScript Hooks</label>\n                                <div class="mazemaster-bb-commands">\n                                    <div class="mazemaster-bb-command">\n                                        <label>On Win:</label>\n                                        <textarea id="mazemaster_tb_on_win" placeholder="/echo Victory!"></textarea>\n                                    </div>\n                                    <div class="mazemaster-bb-command">\n                                        <label>On Lose:</label>\n                                        <textarea id="mazemaster_tb_on_lose" placeholder="/echo Defeat..."></textarea>\n                                    </div>\n                                </div>\n                            </div>\n\n                            <div class="mazemaster-section">\n                                <label class="mazemaster-label">Item Drops on Win</label>\n                                <div class="mazemaster-bb-settings">\n                                    <div class="mazemaster-bb-row">\n                                        <div class="mazemaster-bb-field">\n                                            <label>Key %</label>\n                                            <input type="number" id="mazemaster_tb_key_drop" class="mazemaster-input-small" min="0" max="100" value="30">\n                                        </div>\n                                        <div class="mazemaster-bb-field">\n                                            <label>Strike %</label>\n                                            <input type="number" id="mazemaster_tb_strike_drop" class="mazemaster-input-small" min="0" max="100" value="15">\n                                        </div>\n                                        <div class="mazemaster-bb-field">\n                                            <label>Stealth %</label>\n                                            <input type="number" id="mazemaster_tb_stealth_drop" class="mazemaster-input-small" min="0" max="100" value="10">\n                                        </div>\n                                        <div class="mazemaster-bb-field">\n                                            <label>Potion %</label>\n                                            <input type="number" id="mazemaster_tb_potion_drop" class="mazemaster-input-small" min="0" max="100" value="25">\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n\n                            <div class="mazemaster-section">\n                                <button id="mazemaster_tb_save_btn" class="menu_button menu_button_primary mazemaster-save-btn">\n                                    <i class="fa-solid fa-save"></i> Save Profile\n                                </button>\n                            </div>\n                        </div>\x3c!-- End combat_turnbased_content --\x3e\n\n                        \x3c!-- QTE SUB-TAB --\x3e\n                        <div id="combat_qte_content" class="combat-content">\n                            <div class="mazemaster-section">\n                                <label class="mazemaster-label">QTE Profile</label>\n                                <div class="mazemaster-profile-row">\n                                    <select id="mazemaster_qte_profile_select" class="mazemaster-select">\n                                        ').concat(0===rt().length?'<option value="">No profiles</option>':"","\n                                        ").concat(rt().map((e=>'<option value="'.concat(_o(e),'" ').concat(e===Re.currentQteProfile?"selected":"",">").concat(_o(e),"</option>"))).join(""),'\n                                    </select>\n                                    <button id="mazemaster_qte_new_profile_btn" class="menu_button menu_button_icon" title="New Profile">\n                                        <i class="fa-solid fa-plus"></i>\n                                    </button>\n                                    <button id="mazemaster_qte_delete_profile_btn" class="menu_button menu_button_icon" title="Delete Profile">\n                                        <i class="fa-solid fa-trash"></i>\n                                    </button>\n                                    <button id="mazemaster_qte_rename_profile_btn" class="menu_button menu_button_icon" title="Rename Profile">\n                                        <i class="fa-solid fa-pen"></i>\n                                    </button>\n                                    <button id="mazemaster_preview_qte_btn" class="menu_button menu_button_icon" title="Preview QTE">\n                                        <i class="fa-solid fa-eye"></i>\n                                    </button>\n                                </div>\n                            </div>\n\n                            <div class="mazemaster-section">\n                                <label class="mazemaster-label">Display</label>\n                                <div class="mazemaster-row">\n                                    <label>Title</label>\n                                    <input type="text" id="mazemaster_qte_main_title" class="mazemaster-input" placeholder="Reaction Test" value="">\n                                </div>\n                                <div class="mazemaster-row">\n                                    <label>Description</label>\n                                    <textarea id="mazemaster_qte_description" class="mazemaster-input" rows="2" placeholder="Press the keys as they appear!"></textarea>\n                                </div>\n                            </div>\n\n                            <div class="mazemaster-section">\n                                <label class="mazemaster-label">Sequence Settings</label>\n                                <div class="mazemaster-bb-settings">\n                                    <div class="mazemaster-bb-row">\n                                        <div class="mazemaster-bb-field">\n                                            <label>Min Length</label>\n                                            <input type="number" id="mazemaster_qte_seq_min" class="mazemaster-input-small" min="1" max="20" value="3">\n                                        </div>\n                                        <div class="mazemaster-bb-field">\n                                            <label>Max Length</label>\n                                            <input type="number" id="mazemaster_qte_seq_max" class="mazemaster-input-small" min="1" max="20" value="5">\n                                        </div>\n                                        <div class="mazemaster-bb-field">\n                                            <label>Time Window (ms)</label>\n                                            <input type="number" id="mazemaster_qte_time_base" class="mazemaster-input-small" min="500" max="5000" step="100" value="1500">\n                                        </div>\n                                        <div class="mazemaster-bb-field">\n                                            <label>Min Time (ms)</label>\n                                            <input type="number" id="mazemaster_qte_time_min" class="mazemaster-input-small" min="200" max="2000" step="100" value="800">\n                                        </div>\n                                    </div>\n                                    <div class="mazemaster-bb-row">\n                                        <div class="mazemaster-bb-field" style="flex: 2;">\n                                            <label>Difficulty <span id="mazemaster_qte_diff_val" style="opacity: 0.7;">(5)</span></label>\n                                            <input type="range" id="mazemaster_qte_difficulty" min="1" max="10" value="5" style="width: 100%;">\n                                        </div>\n                                        <div class="mazemaster-bb-field">\n                                            <label>Damage on Fail</label>\n                                            <input type="number" id="mazemaster_qte_damage" class="mazemaster-input-small" min="0" max="100" value="10">\n                                        </div>\n                                        <div class="mazemaster-bb-field">\n                                            <label>Perfect Window %</label>\n                                            <input type="number" id="mazemaster_qte_perfect" class="mazemaster-input-small" min="10" max="50" value="30">\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n\n                            <div class="mazemaster-section">\n                                <label class="mazemaster-label">Allowed Keys</label>\n                                <div style="display: flex; gap: 12px; flex-wrap: wrap;">\n                                    <label style="display: flex; align-items: center; gap: 4px;"><input type="checkbox" id="mazemaster_qte_key_w" checked> W</label>\n                                    <label style="display: flex; align-items: center; gap: 4px;"><input type="checkbox" id="mazemaster_qte_key_a" checked> A</label>\n                                    <label style="display: flex; align-items: center; gap: 4px;"><input type="checkbox" id="mazemaster_qte_key_s" checked> S</label>\n                                    <label style="display: flex; align-items: center; gap: 4px;"><input type="checkbox" id="mazemaster_qte_key_d" checked> D</label>\n                                    <label style="display: flex; align-items: center; gap: 4px;"><input type="checkbox" id="mazemaster_qte_key_space" checked> SPACE</label>\n                                </div>\n                            </div>\n\n                            <div class="mazemaster-section">\n                                <label class="mazemaster-label">STScript Hooks</label>\n                                <div class="mazemaster-bb-commands">\n                                    <div class="mazemaster-bb-command">\n                                        <label>On Complete:</label>\n                                        <textarea id="mazemaster_qte_on_complete" placeholder="/echo Quick reflexes!"></textarea>\n                                    </div>\n                                    <div class="mazemaster-bb-command">\n                                        <label>On Fail:</label>\n                                        <textarea id="mazemaster_qte_on_fail" placeholder="/echo Too slow..."></textarea>\n                                    </div>\n                                </div>\n                            </div>\n\n                            <div class="mazemaster-section">\n                                <button id="mazemaster_qte_save_btn" class="menu_button menu_button_primary mazemaster-save-btn">\n                                    <i class="fa-solid fa-save"></i> Save Profile\n                                </button>\n                            </div>\n                        </div>\x3c!-- End combat_qte_content --\x3e\n\n                        \x3c!-- DICE SUB-TAB --\x3e\n                        <div id="combat_dice_content" class="combat-content">\n                            <div class="mazemaster-section">\n                                <label class="mazemaster-label">Dice Profile</label>\n                                <div class="mazemaster-profile-row">\n                                    <select id="mazemaster_dice_profile_select" class="mazemaster-select">\n                                        ').concat(0===dt().length?'<option value="">No profiles</option>':"","\n                                        ").concat(dt().map((e=>'<option value="'.concat(_o(e),'" ').concat(e===Re.currentDiceProfile?"selected":"",">").concat(_o(e),"</option>"))).join(""),'\n                                    </select>\n                                    <button id="mazemaster_dice_new_profile_btn" class="menu_button menu_button_icon" title="New Profile">\n                                        <i class="fa-solid fa-plus"></i>\n                                    </button>\n                                    <button id="mazemaster_dice_delete_profile_btn" class="menu_button menu_button_icon" title="Delete Profile">\n                                        <i class="fa-solid fa-trash"></i>\n                                    </button>\n                                    <button id="mazemaster_dice_rename_profile_btn" class="menu_button menu_button_icon" title="Rename Profile">\n                                        <i class="fa-solid fa-pen"></i>\n                                    </button>\n                                    <button id="mazemaster_preview_dice_btn" class="menu_button menu_button_icon" title="Preview Dice">\n                                        <i class="fa-solid fa-eye"></i>\n                                    </button>\n                                </div>\n                            </div>\n\n                            <div class="mazemaster-section">\n                                <label class="mazemaster-label">Display</label>\n                                <div class="mazemaster-row">\n                                    <label>Title</label>\n                                    <input type="text" id="mazemaster_dice_main_title" class="mazemaster-input" placeholder="Skill Check" value="">\n                                </div>\n                                <div class="mazemaster-row">\n                                    <label>Description</label>\n                                    <textarea id="mazemaster_dice_description" class="mazemaster-input" rows="2" placeholder="Roll to beat the target!"></textarea>\n                                </div>\n                            </div>\n\n                            <div class="mazemaster-section">\n                                <label class="mazemaster-label">Dice Settings</label>\n                                <div class="mazemaster-bb-settings">\n                                    <div class="mazemaster-bb-row">\n                                        <div class="mazemaster-bb-field">\n                                            <label>Dice Count</label>\n                                            <input type="number" id="mazemaster_dice_count" class="mazemaster-input-small" min="1" max="10" value="2">\n                                        </div>\n                                        <div class="mazemaster-bb-field">\n                                            <label>Dice Type</label>\n                                            <select id="mazemaster_dice_type" class="mazemaster-select">\n                                                <option value="4">d4</option>\n                                                <option value="6" selected>d6</option>\n                                                <option value="8">d8</option>\n                                                <option value="10">d10</option>\n                                                <option value="12">d12</option>\n                                                <option value="20">d20</option>\n                                                <option value="100">d100</option>\n                                            </select>\n                                        </div>\n                                        <div class="mazemaster-bb-field">\n                                            <label>Target Number</label>\n                                            <input type="number" id="mazemaster_dice_target" class="mazemaster-input-small" min="1" max="100" value="7">\n                                        </div>\n                                        <div class="mazemaster-bb-field">\n                                            <label>Modifier</label>\n                                            <input type="number" id="mazemaster_dice_modifier" class="mazemaster-input-small" min="-20" max="20" value="0">\n                                        </div>\n                                    </div>\n                                    <div class="mazemaster-bb-row">\n                                        <div class="mazemaster-bb-field" style="flex: 2;">\n                                            <label>Difficulty <span id="mazemaster_dice_diff_val" style="opacity: 0.7;">(5)</span></label>\n                                            <input type="range" id="mazemaster_dice_difficulty" min="1" max="10" value="5" style="width: 100%;">\n                                        </div>\n                                        <div class="mazemaster-bb-field">\n                                            <label>Damage on Fail</label>\n                                            <input type="number" id="mazemaster_dice_damage" class="mazemaster-input-small" min="0" max="100" value="15">\n                                        </div>\n                                        <div class="mazemaster-bb-field">\n                                            <label>Rerolls</label>\n                                            <input type="number" id="mazemaster_dice_rerolls" class="mazemaster-input-small" min="0" max="5" value="1">\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n\n                            <div class="mazemaster-section">\n                                <label class="mazemaster-label">STScript Hooks</label>\n                                <div class="mazemaster-bb-commands">\n                                    <div class="mazemaster-bb-command">\n                                        <label>On Success:</label>\n                                        <textarea id="mazemaster_dice_on_success" placeholder="/echo Success!"></textarea>\n                                    </div>\n                                    <div class="mazemaster-bb-command">\n                                        <label>On Fail:</label>\n                                        <textarea id="mazemaster_dice_on_fail" placeholder="/echo Failed the check..."></textarea>\n                                    </div>\n                                    <div class="mazemaster-bb-command">\n                                        <label>On Critical:</label>\n                                        <textarea id="mazemaster_dice_on_crit" placeholder="/echo Critical success!"></textarea>\n                                    </div>\n                                </div>\n                            </div>\n\n                            <div class="mazemaster-section">\n                                <button id="mazemaster_dice_save_btn" class="menu_button menu_button_primary mazemaster-save-btn">\n                                    <i class="fa-solid fa-save"></i> Save Profile\n                                </button>\n                            </div>\n                        </div>\x3c!-- End combat_dice_content --\x3e\n\n                        \x3c!-- STEALTH SUB-TAB --\x3e\n                        <div id="combat_stealth_content" class="combat-content">\n                            <div class="mazemaster-section">\n                                <label class="mazemaster-label">Stealth Profile</label>\n                                <div class="mazemaster-profile-row">\n                                    <select id="mazemaster_stealth_profile_select" class="mazemaster-select">\n                                        ').concat(0===ut().length?'<option value="">No profiles</option>':"","\n                                        ").concat(ut().map((e=>'<option value="'.concat(_o(e),'" ').concat(e===Re.currentStealthProfile?"selected":"",">").concat(_o(e),"</option>"))).join(""),'\n                                    </select>\n                                    <button id="mazemaster_stealth_new_profile_btn" class="menu_button menu_button_icon" title="New Profile">\n                                        <i class="fa-solid fa-plus"></i>\n                                    </button>\n                                    <button id="mazemaster_stealth_delete_profile_btn" class="menu_button menu_button_icon" title="Delete Profile">\n                                        <i class="fa-solid fa-trash"></i>\n                                    </button>\n                                    <button id="mazemaster_stealth_rename_profile_btn" class="menu_button menu_button_icon" title="Rename Profile">\n                                        <i class="fa-solid fa-pen"></i>\n                                    </button>\n                                    <button id="mazemaster_preview_stealth_btn" class="menu_button menu_button_icon" title="Preview Stealth">\n                                        <i class="fa-solid fa-eye"></i>\n                                    </button>\n                                </div>\n                            </div>\n\n                            <div class="mazemaster-section">\n                                <label class="mazemaster-label">Display</label>\n                                <div class="mazemaster-row">\n                                    <label>Title</label>\n                                    <input type="text" id="mazemaster_stealth_main_title" class="mazemaster-input" placeholder="Sneak Past" value="">\n                                </div>\n                                <div class="mazemaster-row">\n                                    <label>Guard Name</label>\n                                    <input type="text" id="mazemaster_stealth_guard_name" class="mazemaster-input" placeholder="Guard" value="">\n                                </div>\n                                <div class="mazemaster-row">\n                                    <label>Description</label>\n                                    <textarea id="mazemaster_stealth_description" class="mazemaster-input" rows="2" placeholder="Sneak past without being detected!"></textarea>\n                                </div>\n                            </div>\n\n                            <div class="mazemaster-section">\n                                <label class="mazemaster-label">Stealth Settings</label>\n                                <div class="mazemaster-bb-settings">\n                                    <div class="mazemaster-bb-row">\n                                        <div class="mazemaster-bb-field">\n                                            <label>Sections</label>\n                                            <input type="number" id="mazemaster_stealth_sections" class="mazemaster-input-small" min="1" max="10" value="3" title="Areas to pass through">\n                                        </div>\n                                        <div class="mazemaster-bb-field">\n                                            <label>Detection Limit</label>\n                                            <input type="number" id="mazemaster_stealth_detection_limit" class="mazemaster-input-small" min="50" max="200" value="100" title="Max detection before caught">\n                                        </div>\n                                        <div class="mazemaster-bb-field">\n                                            <label>Base Detection</label>\n                                            <input type="number" id="mazemaster_stealth_base_detection" class="mazemaster-input-small" min="5" max="50" value="15" title="Detection gain when advancing">\n                                        </div>\n                                        <div class="mazemaster-bb-field">\n                                            <label>Damage on Fail</label>\n                                            <input type="number" id="mazemaster_stealth_damage" class="mazemaster-input-small" min="0" max="100" value="20">\n                                        </div>\n                                    </div>\n                                    <div class="mazemaster-bb-row">\n                                        <div class="mazemaster-bb-field" style="flex: 2;">\n                                            <label>Difficulty <span id="mazemaster_stealth_diff_val" style="opacity: 0.7;">(5)</span></label>\n                                            <input type="range" id="mazemaster_stealth_difficulty" min="1" max="10" value="5" style="width: 100%;">\n                                        </div>\n                                        <div class="mazemaster-bb-field">\n                                            <label>Hide Reduction</label>\n                                            <input type="number" id="mazemaster_stealth_hide_reduce" class="mazemaster-input-small" min="5" max="30" value="10" title="Detection reduced by Hide">\n                                        </div>\n                                        <div class="mazemaster-bb-field">\n                                            <label>Distract Max</label>\n                                            <input type="number" id="mazemaster_stealth_distract_max" class="mazemaster-input-small" min="10" max="50" value="25" title="Max detection reduced by Distract">\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n\n                            <div class="mazemaster-section">\n                                <label class="mazemaster-label">STScript Hooks</label>\n                                <div class="mazemaster-bb-commands">\n                                    <div class="mazemaster-bb-command">\n                                        <label>On Success:</label>\n                                        <textarea id="mazemaster_stealth_on_success" placeholder="/echo You made it past!"></textarea>\n                                    </div>\n                                    <div class="mazemaster-bb-command">\n                                        <label>On Caught:</label>\n                                        <textarea id="mazemaster_stealth_on_caught" placeholder="/echo You\'ve been spotted!"></textarea>\n                                    </div>\n                                </div>\n                            </div>\n\n                            <div class="mazemaster-section">\n                                <button id="mazemaster_stealth_save_btn" class="menu_button menu_button_primary mazemaster-save-btn">\n                                    <i class="fa-solid fa-save"></i> Save Profile\n                                </button>\n                            </div>\n                        </div>\x3c!-- End combat_stealth_content --\x3e\n\n                        \x3c!-- PUZZLE SUB-TAB --\x3e\n                        <div id="combat_puzzle_content" class="combat-content">\n                            <div class="mazemaster-section">\n                                <label class="mazemaster-label">Puzzle Profile</label>\n                                <div class="mazemaster-profile-row">\n                                    <select id="mazemaster_puzzle_profile_select" class="mazemaster-select">\n                                        ').concat(0===ft().length?'<option value="">No profiles</option>':"","\n                                        ").concat(ft().map((e=>'<option value="'.concat(_o(e),'" ').concat(e===Re.currentPuzzleProfile?"selected":"",">").concat(_o(e),"</option>"))).join(""),'\n                                    </select>\n                                    <button id="mazemaster_puzzle_new_profile_btn" class="menu_button menu_button_icon" title="New Profile">\n                                        <i class="fa-solid fa-plus"></i>\n                                    </button>\n                                    <button id="mazemaster_puzzle_delete_profile_btn" class="menu_button menu_button_icon" title="Delete Profile">\n                                        <i class="fa-solid fa-trash"></i>\n                                    </button>\n                                    <button id="mazemaster_puzzle_rename_profile_btn" class="menu_button menu_button_icon" title="Rename Profile">\n                                        <i class="fa-solid fa-pen"></i>\n                                    </button>\n                                    <button id="mazemaster_preview_puzzle_btn" class="menu_button menu_button_icon" title="Preview Puzzle">\n                                        <i class="fa-solid fa-eye"></i>\n                                    </button>\n                                </div>\n                            </div>\n\n                            <div class="mazemaster-section">\n                                <label class="mazemaster-label">Display</label>\n                                <div class="mazemaster-row">\n                                    <label>Title</label>\n                                    <input type="text" id="mazemaster_puzzle_main_title" class="mazemaster-input" placeholder="Memory Puzzle" value="">\n                                </div>\n                                <div class="mazemaster-row">\n                                    <label>Description</label>\n                                    <textarea id="mazemaster_puzzle_description" class="mazemaster-input" rows="2" placeholder="Watch the sequence and repeat it!"></textarea>\n                                </div>\n                            </div>\n\n                            <div class="mazemaster-section">\n                                <label class="mazemaster-label">Puzzle Settings</label>\n                                <div class="mazemaster-bb-settings">\n                                    <div class="mazemaster-bb-row">\n                                        <div class="mazemaster-bb-field">\n                                            <label>Grid Size</label>\n                                            <select id="mazemaster_puzzle_grid_size" class="mazemaster-select">\n                                                <option value="2">2x2</option>\n                                                <option value="3" selected>3x3</option>\n                                                <option value="4">4x4</option>\n                                                <option value="5">5x5</option>\n                                            </select>\n                                        </div>\n                                        <div class="mazemaster-bb-field">\n                                            <label>Sequence Length</label>\n                                            <input type="number" id="mazemaster_puzzle_seq_length" class="mazemaster-input-small" min="2" max="12" value="4">\n                                        </div>\n                                        <div class="mazemaster-bb-field">\n                                            <label>Max Mistakes</label>\n                                            <input type="number" id="mazemaster_puzzle_max_mistakes" class="mazemaster-input-small" min="1" max="10" value="5">\n                                        </div>\n                                        <div class="mazemaster-bb-field">\n                                            <label>Hints</label>\n                                            <input type="number" id="mazemaster_puzzle_hints" class="mazemaster-input-small" min="0" max="5" value="3">\n                                        </div>\n                                    </div>\n                                    <div class="mazemaster-bb-row">\n                                        <div class="mazemaster-bb-field" style="flex: 2;">\n                                            <label>Difficulty <span id="mazemaster_puzzle_diff_val" style="opacity: 0.7;">(5)</span></label>\n                                            <input type="range" id="mazemaster_puzzle_difficulty" min="1" max="10" value="5" style="width: 100%;">\n                                        </div>\n                                        <div class="mazemaster-bb-field">\n                                            <label>Damage on Fail</label>\n                                            <input type="number" id="mazemaster_puzzle_damage" class="mazemaster-input-small" min="0" max="100" value="15">\n                                        </div>\n                                        <div class="mazemaster-bb-field">\n                                            <label>Time Limit (sec)</label>\n                                            <input type="number" id="mazemaster_puzzle_time_limit" class="mazemaster-input-small" min="0" max="300" value="60" title="0 = no limit">\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n\n                            <div class="mazemaster-section">\n                                <label class="mazemaster-label">STScript Hooks</label>\n                                <div class="mazemaster-bb-commands">\n                                    <div class="mazemaster-bb-command">\n                                        <label>On Solve:</label>\n                                        <textarea id="mazemaster_puzzle_on_solve" placeholder="/echo Puzzle solved!"></textarea>\n                                    </div>\n                                    <div class="mazemaster-bb-command">\n                                        <label>On Fail:</label>\n                                        <textarea id="mazemaster_puzzle_on_fail" placeholder="/echo Too many mistakes..."></textarea>\n                                    </div>\n                                </div>\n                            </div>\n\n                            <div class="mazemaster-section">\n                                <button id="mazemaster_puzzle_save_btn" class="menu_button menu_button_primary mazemaster-save-btn">\n                                    <i class="fa-solid fa-save"></i> Save Profile\n                                </button>\n                            </div>\n                        </div>\x3c!-- End combat_puzzle_content --\x3e\n\n                        \x3c!-- NEGOTIATION SUB-TAB --\x3e\n                        <div id="combat_negotiation_content" class="combat-content">\n                            <div class="mazemaster-section">\n                                <label class="mazemaster-label">Negotiation Profile</label>\n                                <div class="mazemaster-profile-row">\n                                    <select id="mazemaster_negotiation_profile_select" class="mazemaster-select">\n                                        ').concat(0===yt().length?'<option value="">No profiles</option>':"","\n                                        ").concat(yt().map((e=>'<option value="'.concat(_o(e),'" ').concat(e===Re.currentNegotiationProfile?"selected":"",">").concat(_o(e),"</option>"))).join(""),'\n                                    </select>\n                                    <button id="mazemaster_negotiation_new_profile_btn" class="menu_button menu_button_icon" title="New Profile">\n                                        <i class="fa-solid fa-plus"></i>\n                                    </button>\n                                    <button id="mazemaster_negotiation_delete_profile_btn" class="menu_button menu_button_icon" title="Delete Profile">\n                                        <i class="fa-solid fa-trash"></i>\n                                    </button>\n                                    <button id="mazemaster_negotiation_rename_profile_btn" class="menu_button menu_button_icon" title="Rename Profile">\n                                        <i class="fa-solid fa-pen"></i>\n                                    </button>\n                                    <button id="mazemaster_preview_negotiation_btn" class="menu_button menu_button_icon" title="Preview Negotiation">\n                                        <i class="fa-solid fa-eye"></i>\n                                    </button>\n                                </div>\n                            </div>\n\n                            <div class="mazemaster-section">\n                                <label class="mazemaster-label">Display</label>\n                                <div class="mazemaster-row">\n                                    <label>Title</label>\n                                    <input type="text" id="mazemaster_negotiate_main_title" class="mazemaster-input" placeholder="Negotiation" value="">\n                                </div>\n                                <div class="mazemaster-row">\n                                    <label>NPC Name</label>\n                                    <input type="text" id="mazemaster_negotiate_npc_name" class="mazemaster-input" placeholder="Merchant" value="">\n                                </div>\n                                <div class="mazemaster-row">\n                                    <label>Description</label>\n                                    <textarea id="mazemaster_negotiate_description" class="mazemaster-input" rows="2" placeholder="Convince them to help you..."></textarea>\n                                </div>\n                            </div>\n\n                            <div class="mazemaster-section">\n                                <label class="mazemaster-label">Negotiation Settings</label>\n                                <div class="mazemaster-bb-settings">\n                                    <div class="mazemaster-bb-row">\n                                        <div class="mazemaster-bb-field">\n                                            <label>Favor Target</label>\n                                            <input type="number" id="mazemaster_negotiate_favor_target" class="mazemaster-input-small" min="25" max="100" value="75" title="Favor needed to win">\n                                        </div>\n                                        <div class="mazemaster-bb-field">\n                                            <label>Starting Favor</label>\n                                            <input type="number" id="mazemaster_negotiate_starting_favor" class="mazemaster-input-small" min="0" max="75" value="25">\n                                        </div>\n                                        <div class="mazemaster-bb-field">\n                                            <label>Max Turns</label>\n                                            <input type="number" id="mazemaster_negotiate_max_turns" class="mazemaster-input-small" min="3" max="20" value="6">\n                                        </div>\n                                        <div class="mazemaster-bb-field">\n                                            <label>Damage on Fail</label>\n                                            <input type="number" id="mazemaster_negotiate_damage" class="mazemaster-input-small" min="0" max="100" value="10">\n                                        </div>\n                                    </div>\n                                    <div class="mazemaster-bb-row">\n                                        <div class="mazemaster-bb-field" style="flex: 2;">\n                                            <label>Difficulty <span id="mazemaster_negotiate_diff_val" style="opacity: 0.7;">(5)</span></label>\n                                            <input type="range" id="mazemaster_negotiate_difficulty" min="1" max="10" value="5" style="width: 100%;">\n                                        </div>\n                                        <div class="mazemaster-bb-field">\n                                            <label>Persuade Avg</label>\n                                            <input type="number" id="mazemaster_negotiate_persuade" class="mazemaster-input-small" min="5" max="30" value="12" title="Average favor from Persuade">\n                                        </div>\n                                        <div class="mazemaster-bb-field">\n                                            <label>Flatter Avg</label>\n                                            <input type="number" id="mazemaster_negotiate_flatter" class="mazemaster-input-small" min="5" max="25" value="10" title="Average favor from Flatter">\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n\n                            <div class="mazemaster-section">\n                                <label class="mazemaster-label">NPC Personality</label>\n                                <div class="mazemaster-bb-settings">\n                                    <div class="mazemaster-bb-row">\n                                        <div class="mazemaster-bb-field">\n                                            <label>Starting Mood</label>\n                                            <select id="mazemaster_negotiate_mood" class="mazemaster-select">\n                                                <option value="hostile">Hostile (-favor)</option>\n                                                <option value="unfriendly" selected>Unfriendly</option>\n                                                <option value="neutral">Neutral</option>\n                                                <option value="friendly">Friendly (+favor)</option>\n                                            </select>\n                                        </div>\n                                        <div class="mazemaster-bb-field">\n                                            <label>Intimidate Risk</label>\n                                            <select id="mazemaster_negotiate_intimidate" class="mazemaster-select">\n                                                <option value="low">Low (safe)</option>\n                                                <option value="medium" selected>Medium</option>\n                                                <option value="high">High (risky)</option>\n                                            </select>\n                                        </div>\n                                        <div class="mazemaster-bb-field">\n                                            <label>Bribe Cost</label>\n                                            <select id="mazemaster_negotiate_bribe_cost" class="mazemaster-select">\n                                                <option value="key">Key</option>\n                                                <option value="gold" selected>Gold (10)</option>\n                                                <option value="potion">Potion</option>\n                                            </select>\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n\n                            <div class="mazemaster-section">\n                                <label class="mazemaster-label">STScript Hooks</label>\n                                <div class="mazemaster-bb-commands">\n                                    <div class="mazemaster-bb-command">\n                                        <label>On Success:</label>\n                                        <textarea id="mazemaster_negotiate_on_success" placeholder="/echo They agreed to help!"></textarea>\n                                    </div>\n                                    <div class="mazemaster-bb-command">\n                                        <label>On Fail:</label>\n                                        <textarea id="mazemaster_negotiate_on_fail" placeholder="/echo Negotiations broke down..."></textarea>\n                                    </div>\n                                </div>\n                            </div>\n\n                            <div class="mazemaster-section">\n                                <button id="mazemaster_negotiate_save_btn" class="menu_button menu_button_primary mazemaster-save-btn">\n                                    <i class="fa-solid fa-save"></i> Save Profile\n                                </button>\n                            </div>\n                        </div>\x3c!-- End combat_negotiation_content --\x3e\n\n                    </div>\x3c!-- End mazemaster_combat_config --\x3e\n\n                    \x3c!-- MAZE CONFIG --\x3e\n                    <div id="mazemaster_maze_config" class="mazemaster-game-config" style="').concat("maze"===oe?"":"display: none;",'">\n                        \x3c!-- Profile Selection --\x3e\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Maze Profile</label>\n                            <div class="mazemaster-profile-row">\n                                <select id="mazemaster_maze_profile_select" class="mazemaster-select">\n                                    ').concat(0===ee.length?'<option value="">No profiles</option>':"","\n                                    ").concat(ee.map((e=>'<option value="'.concat(_o(e),'" ').concat(e===te?"selected":"",">").concat(_o(e),"</option>"))).join(""),'\n                                </select>\n                                <button id="mazemaster_maze_new_profile_btn" class="menu_button menu_button_icon" title="New Profile">\n                                    <i class="fa-solid fa-plus"></i>\n                                </button>\n                                <button id="mazemaster_maze_delete_profile_btn" class="menu_button menu_button_icon" title="Delete Profile">\n                                    <i class="fa-solid fa-trash"></i>\n                                </button>\n                                <button id="mazemaster_maze_rename_profile_btn" class="menu_button menu_button_icon" title="Rename Profile">\n                                    <i class="fa-solid fa-pen"></i>\n                                </button>\n                            </div>\n                        </div>\n\n                        \x3c!-- Grid Size and Difficulty --\x3e\n                        <div class="mazemaster-inline-row">\n                            <div class="mazemaster-section mazemaster-flex-1">\n                                <label class="mazemaster-label">Grid Size</label>\n                                <select id="mazemaster_maze_size" class="mazemaster-select">\n                                    <option value="5" ').concat(5===(ne.gridSize||10)?"selected":"",'>5x5</option>\n                                    <option value="6" ').concat(6===(ne.gridSize||10)?"selected":"",'>6x6</option>\n                                    <option value="7" ').concat(7===(ne.gridSize||10)?"selected":"",'>7x7</option>\n                                    <option value="8" ').concat(8===(ne.gridSize||10)?"selected":"",'>8x8</option>\n                                    <option value="9" ').concat(9===(ne.gridSize||10)?"selected":"",'>9x9</option>\n                                    <option value="10" ').concat(10===(ne.gridSize||10)?"selected":"",'>10x10</option>\n                                    <option value="11" ').concat(11===(ne.gridSize||10)?"selected":"",'>11x11</option>\n                                    <option value="12" ').concat(12===(ne.gridSize||10)?"selected":"",'>12x12</option>\n                                    <option value="13" ').concat(13===(ne.gridSize||10)?"selected":"",'>13x13</option>\n                                    <option value="14" ').concat(14===(ne.gridSize||10)?"selected":"",'>14x14</option>\n                                    <option value="15" ').concat(15===(ne.gridSize||10)?"selected":"",'>15x15</option>\n                                    <option value="16" ').concat(16===(ne.gridSize||10)?"selected":"",'>16x16</option>\n                                    <option value="17" ').concat(17===(ne.gridSize||10)?"selected":"",'>17x17</option>\n                                    <option value="18" ').concat(18===(ne.gridSize||10)?"selected":"",'>18x18</option>\n                                    <option value="19" ').concat(19===(ne.gridSize||10)?"selected":"",'>19x19</option>\n                                    <option value="20" ').concat(20===(ne.gridSize||10)?"selected":"",'>20x20</option>\n                                </select>\n                            </div>\n                            <div class="mazemaster-section mazemaster-flex-1">\n                                <label class="mazemaster-label">Difficulty</label>\n                                <select id="mazemaster_maze_difficulty" class="mazemaster-select">\n                                    <option value="easy" ').concat("easy"===(ne.difficulty||"normal")?"selected":"",'>Easy</option>\n                                    <option value="normal" ').concat("normal"===(ne.difficulty||"normal")?"selected":"",'>Normal</option>\n                                    <option value="hard" ').concat("hard"===(ne.difficulty||"normal")?"selected":"",'>Hard</option>\n                                    <option value="nightmare" ').concat("nightmare"===(ne.difficulty||"normal")?"selected":"",'>Nightmare</option>\n                                </select>\n                            </div>\n                        </div>\n                        <div class="mazemaster-help-small"><small>Difficulty affects encounter density, trap frequency, loot, and starting inventory</small></div>\n\n                        <div class="mazemaster-flex-row">\n                            <div class="mazemaster-section mazemaster-flex-1">\n                                <label class="mazemaster-label">Theme</label>\n                                <select id="mazemaster_maze_theme" class="mazemaster-select">\n                                    <option value="fantasy" ').concat("fantasy"===(ne.theme||"fantasy")?"selected":"",'>Fantasy</option>\n                                    <option value="horror" ').concat("horror"===(ne.theme||"fantasy")?"selected":"",'>Horror</option>\n                                    <option value="scifi" ').concat("scifi"===(ne.theme||"fantasy")?"selected":"",'>Sci-Fi</option>\n                                    <option value="action" ').concat("action"===(ne.theme||"fantasy")?"selected":"",'>Action</option>\n                                    <option value="cyberpunk" ').concat("cyberpunk"===(ne.theme||"fantasy")?"selected":"",'>Cyberpunk</option>\n                                    <option value="noir" ').concat("noir"===(ne.theme||"fantasy")?"selected":"",'>Noir</option>\n                                    <option value="postapoc" ').concat("postapoc"===(ne.theme||"fantasy")?"selected":"",'>Post-Apocalyptic</option>\n                                    <option value="comedy" ').concat("comedy"===(ne.theme||"fantasy")?"selected":"",'>Comedy</option>\n                                    <option value="western" ').concat("western"===(ne.theme||"fantasy")?"selected":"",'>Western</option>\n                                </select>\n                            </div>\n                            <div class="mazemaster-section mazemaster-flex-1">\n                                <label class="mazemaster-label">Map Style</label>\n                                <select id="mazemaster_maze_mapstyle" class="mazemaster-select">\n                                    <option value="maze" ').concat("maze"===(ne.mapStyle||"maze")?"selected":"",'>Classic Maze</option>\n                                    <option value="dungeon" ').concat("dungeon"===(ne.mapStyle||"maze")?"selected":"",'>Dungeon</option>\n                                    <option value="city" ').concat("city"===(ne.mapStyle||"maze")?"selected":"",'>City Streets</option>\n                                    <option value="forest" ').concat("forest"===(ne.mapStyle||"maze")?"selected":"",'>Forest</option>\n                                    <option value="outpost" ').concat("outpost"===(ne.mapStyle||"maze")?"selected":"",'>Outpost</option>\n                                    <option value="spacestation" ').concat("spacestation"===(ne.mapStyle||"maze")?"selected":"",'>Space Station</option>\n                                    <option value="college" ').concat("college"===(ne.mapStyle||"maze")?"selected":"",'>College Campus</option>\n                                    <option value="apartment" ').concat("apartment"===(ne.mapStyle||"maze")?"selected":"",'>Apartment Complex</option>\n                                    <option value="neotokyo" ').concat("neotokyo"===(ne.mapStyle||"maze")?"selected":"",'>Neo Tokyo</option>\n                                    <option value="arena" ').concat("arena"===(ne.mapStyle||"maze")?"selected":"",'>Battle Arena</option>\n                                    <option value="hospital" ').concat("hospital"===(ne.mapStyle||"maze")?"selected":"",'>Hospital</option>\n                                    <option value="highrise" ').concat("highrise"===(ne.mapStyle||"maze")?"selected":"",'>Abandoned Highrise</option>\n                                </select>\n                            </div>\n                            <div class="mazemaster-section mazemaster-flex-1">\n                                <label class="mazemaster-label">Floors</label>\n                                <select id="mazemaster_maze_floors" class="mazemaster-select">\n                                    <option value="1" ').concat(1===(ne.floors||1)?"selected":"",'>1 Floor</option>\n                                    <option value="2" ').concat(2===(ne.floors||1)?"selected":"",'>2 Floors</option>\n                                    <option value="3" ').concat(3===(ne.floors||1)?"selected":"",'>3 Floors</option>\n                                    <option value="4" ').concat(4===(ne.floors||1)?"selected":"",'>4 Floors</option>\n                                    <option value="5" ').concat(5===(ne.floors||1)?"selected":"",'>5 Floors</option>\n                                </select>\n                            </div>\n                        </div>\n                        <div class="mazemaster-help-small"><small>Theme affects flavor text and item names. Map style changes the generation algorithm. Floors adds vertical navigation with staircases.</small></div>\n\n                        <div class="mazemaster-row" style="margin-top: 8px;">\n                            <label style="font-size: 0.85em; color: var(--SmartThemeBodyColor); margin-bottom: 4px; display: block;">Map Visibility</label>\n                            <div class="mazemaster-radio-group" style="display: flex; gap: 12px; flex-wrap: wrap;">\n                                <label class="mazemaster-radio-label" style="display: flex; align-items: center; gap: 4px; cursor: pointer;">\n                                    <input type="radio" name="mazemaster_map_visibility" value="showAll" ').concat("showAll"===ne.mapVisibility||!ne.mapVisibility&&!1===ne.fogOfWar?"checked":"",'>\n                                    <span>Show Full</span>\n                                </label>\n                                <label class="mazemaster-radio-label" style="display: flex; align-items: center; gap: 4px; cursor: pointer;">\n                                    <input type="radio" name="mazemaster_map_visibility" value="fogOfWar" ').concat("fogOfWar"===ne.mapVisibility||!ne.mapVisibility&&!1!==ne.fogOfWar?"checked":"",'>\n                                    <span>Fog of War</span>\n                                </label>\n                                <label class="mazemaster-radio-label" style="display: flex; align-items: center; gap: 4px; cursor: pointer;">\n                                    <input type="radio" name="mazemaster_map_visibility" value="hideUnexplored" ').concat("hideUnexplored"===ne.mapVisibility?"checked":"",'>\n                                    <span>Hide Unexplored</span>\n                                </label>\n                            </div>\n                        </div>\n\n                        \x3c!-- v1.4.0 BSP Configuration --\x3e\n                        <div class="mazemaster-collapsible ').concat((null===(s=ne.bspConfig)||void 0===s?void 0:s.zoneCount)>1||(null===(r=ne.bspConfig)||void 0===r?void 0:r.secretDensity)>0?"expanded":"",'">\n                            <button class="mazemaster-collapsible-header" data-target="bsp_config_section">\n                                <i class="fa-solid fa-chevron-right mazemaster-collapse-icon"></i>\n                                <span>Zone & Secret Settings</span>\n                                <span class="mazemaster-collapse-hint">(BSP dungeon generation)</span>\n                            </button>\n                            <div id="bsp_config_section" class="mazemaster-collapsible-content" style="display: ').concat((null===(l=ne.bspConfig)||void 0===l?void 0:l.zoneCount)>1||(null===(c=ne.bspConfig)||void 0===c?void 0:c.secretDensity)>0?"block":"none",';">\n                                <div class="mazemaster-flex-row" style="gap: 10px;">\n                                    <div class="mazemaster-section mazemaster-flex-1">\n                                        <label class="mazemaster-label">Zone Count</label>\n                                        <select id="mazemaster_bsp_zone_count" class="mazemaster-select">\n                                            <option value="1" ').concat(1===((null===(d=ne.bspConfig)||void 0===d?void 0:d.zoneCount)||1)?"selected":"",'>1 (No zones)</option>\n                                            <option value="2" ').concat(2===((null===(m=ne.bspConfig)||void 0===m?void 0:m.zoneCount)||1)?"selected":"",'>2 Zones</option>\n                                            <option value="3" ').concat(3===((null===(p=ne.bspConfig)||void 0===p?void 0:p.zoneCount)||1)?"selected":"",'>3 Zones</option>\n                                            <option value="4" ').concat(4===((null===(u=ne.bspConfig)||void 0===u?void 0:u.zoneCount)||1)?"selected":"",'>4 Zones</option>\n                                            <option value="5" ').concat(5===((null===(h=ne.bspConfig)||void 0===h?void 0:h.zoneCount)||1)?"selected":"",'>5 Zones</option>\n                                        </select>\n                                    </div>\n                                    <div class="mazemaster-section mazemaster-flex-1">\n                                        <label class="mazemaster-label">Secret Passages</label>\n                                        <select id="mazemaster_bsp_secret_density" class="mazemaster-select">\n                                            <option value="0" ').concat(0===((null===(g=ne.bspConfig)||void 0===g?void 0:g.secretDensity)||0)?"selected":"",'>None</option>\n                                            <option value="0.02" ').concat(.02==((null===(f=ne.bspConfig)||void 0===f?void 0:f.secretDensity)||0)?"selected":"",'>Low (2%)</option>\n                                            <option value="0.05" ').concat(.05==((null===(v=ne.bspConfig)||void 0===v?void 0:v.secretDensity)||0)?"selected":"",'>Medium (5%)</option>\n                                            <option value="0.08" ').concat(.08==((null===(b=ne.bspConfig)||void 0===b?void 0:b.secretDensity)||0)?"selected":"",'>High (8%)</option>\n                                        </select>\n                                    </div>\n                                </div>\n                                <div class="mazemaster-flex-row" style="gap: 10px; margin-top: 8px;">\n                                    <div class="mazemaster-section mazemaster-flex-1">\n                                        <label class="mazemaster-checkbox-label">\n                                            <input type="checkbox" id="mazemaster_bsp_zones_require_clear" ').concat(!1!==(null===(y=ne.bspConfig)||void 0===y?void 0:y.zonesRequireClear)?"checked":"",'>\n                                            <span>Zones require room clearing</span>\n                                        </label>\n                                    </div>\n                                    <div class="mazemaster-section mazemaster-flex-1">\n                                        <label class="mazemaster-checkbox-label">\n                                            <input type="checkbox" id="mazemaster_bsp_secret_hints" ').concat(!1!==(null===(z=ne.bspConfig)||void 0===z?void 0:z.secretHints)?"checked":"",'>\n                                            <span>Show secret hints</span>\n                                        </label>\n                                    </div>\n                                </div>\n                                <div class="mazemaster-flex-row" style="gap: 10px; margin-top: 8px;">\n                                    <div class="mazemaster-section mazemaster-flex-1">\n                                        <label class="mazemaster-checkbox-label">\n                                            <input type="checkbox" id="mazemaster_bsp_floor_scaling" ').concat(!1!==(null===(x=ne.bspConfig)||void 0===x?void 0:x.floorComplexityScaling)?"checked":"",'>\n                                            <span>Scale complexity per floor</span>\n                                        </label>\n                                    </div>\n                                </div>\n                                <div class="mazemaster-help-small" style="margin-top: 6px;"><small>Zones create Metroidvania-style progression. Clear rooms to unlock the next zone. Secrets are hidden passages found by bumping walls.</small></div>\n                            </div>\n                        </div>\n\n                        \x3c!-- COLLAPSIBLE: Teleport Portals --\x3e\n                        <div class="mazemaster-collapsible ').concat(ne.portals&&ne.portals.length>0?"expanded":"",'">\n                            <button class="mazemaster-collapsible-header" data-target="portals_section">\n                                <i class="fa-solid fa-chevron-right mazemaster-collapse-icon"></i>\n                                <span>Teleport Portals</span>\n                                <span class="mazemaster-collapse-hint">(').concat((ne.portals||[]).length,' portal pairs)</span>\n                            </button>\n                            <div id="portals_section" class="mazemaster-collapsible-content" style="display: ').concat(ne.portals&&ne.portals.length>0?"block":"none",';">\n                                <div class="mazemaster-section">\n                                    <div class="mazemaster-help-small"><small>Add portals that teleport the player between two points. Leave coordinates blank for random placement.</small></div>\n                                    <div id="mazemaster_portals_list" class="mazemaster-portals-list">\n                                        ').concat((ne.portals||[]).map(((e,t)=>{var n,a,o,i;return'\n                                            <div class="mazemaster-portal-item" data-portal-index="'.concat(t,'">\n                                                <div class="portal-header">\n                                                    <span class="portal-color" style="background: ').concat(e.color||"#9b59b6",'"></span>\n                                                    <span class="portal-name">').concat(_o(e.id||"Portal "+(t+1)),'</span>\n                                                    <button class="menu_button remove-portal-btn" data-index="').concat(t,'" title="Remove Portal">\n                                                        <i class="fa-solid fa-trash"></i>\n                                                    </button>\n                                                </div>\n                                                <div class="portal-details">\n                                                    <div class="portal-row">\n                                                        <label>ID:</label>\n                                                        <input type="text" class="portal-id mazemaster-input" value="').concat(_o(e.id||""),'" placeholder="portal1">\n                                                    </div>\n                                                    <div class="portal-row">\n                                                        <label>Color:</label>\n                                                        <input type="color" class="portal-color-input" value="').concat(e.color||"#9b59b6",'">\n                                                    </div>\n                                                    <div class="portal-row">\n                                                        <label>Bidirectional:</label>\n                                                        <input type="checkbox" class="portal-bidirectional" ').concat(!1!==e.bidirectional?"checked":"",'>\n                                                    </div>\n                                                    <div class="portal-row coords-row">\n                                                        <span>Start: X</span>\n                                                        <input type="number" class="portal-start-x mazemaster-input" value="').concat(null!==(n=e.startX)&&void 0!==n?n:"",'" placeholder="auto" min="0">\n                                                        <span>Y</span>\n                                                        <input type="number" class="portal-start-y mazemaster-input" value="').concat(null!==(a=e.startY)&&void 0!==a?a:"",'" placeholder="auto" min="0">\n                                                    </div>\n                                                    <div class="portal-row coords-row">\n                                                        <span>End: X</span>\n                                                        <input type="number" class="portal-end-x mazemaster-input" value="').concat(null!==(o=e.endX)&&void 0!==o?o:"",'" placeholder="auto" min="0">\n                                                        <span>Y</span>\n                                                        <input type="number" class="portal-end-y mazemaster-input" value="').concat(null!==(i=e.endY)&&void 0!==i?i:"",'" placeholder="auto" min="0">\n                                                    </div>\n                                                </div>\n                                            </div>\n                                        ')})).join(""),'\n                                    </div>\n                                    <button id="mazemaster_add_portal_btn" class="menu_button">\n                                        <i class="fa-solid fa-plus"></i> Add Portal Pair\n                                    </button>\n                                </div>\n                            </div>\n                        </div>\n\n                        \x3c!-- COLLAPSIBLE: Objectives --\x3e\n                        <div class="mazemaster-collapsible ').concat(ne.objectives&&ne.objectives.length>0?"expanded":"",'">\n                            <button class="mazemaster-collapsible-header" data-target="objectives_section">\n                                <i class="fa-solid fa-chevron-right mazemaster-collapse-icon"></i>\n                                <span>Objectives</span>\n                                <span class="mazemaster-collapse-hint">(').concat((ne.objectives||[]).length,' objectives)</span>\n                            </button>\n                            <div id="objectives_section" class="mazemaster-collapsible-content" style="display: ').concat(ne.objectives&&ne.objectives.length>0?"block":"none",';">\n                                <div class="mazemaster-section">\n                                    <div class="mazemaster-help-small"><small>Define objectives the player must complete. Required objectives must be done before exiting.</small></div>\n                                    <div id="mazemaster_objectives_list" class="mazemaster-objectives-list">\n                                        ').concat((ne.objectives||[]).map(((e,t)=>'\n                                            <div class="mazemaster-objective-item" data-objective-index="'.concat(t,'">\n                                                <div class="objective-config-header">\n                                                    <span class="objective-name">').concat(_o(e.description||e.id||"Objective "+(t+1)),'</span>\n                                                    <button class="menu_button remove-objective-btn" data-index="').concat(t,'" title="Remove Objective">\n                                                        <i class="fa-solid fa-trash"></i>\n                                                    </button>\n                                                </div>\n                                                <div class="objective-config-details">\n                                                    <div class="objective-config-row">\n                                                        <label>ID:</label>\n                                                        <input type="text" class="objective-id mazemaster-input" value="').concat(_o(e.id||""),'" placeholder="obj1">\n                                                    </div>\n                                                    <div class="objective-config-row">\n                                                        <label>Type:</label>\n                                                        <select class="objective-type mazemaster-select">\n                                                            <option value="collect" ').concat("collect"===e.type?"selected":"",'>Collect Item</option>\n                                                            <option value="defeat" ').concat("defeat"===e.type?"selected":"",'>Defeat Minion</option>\n                                                            <option value="explore" ').concat("explore"===e.type?"selected":"",'>Explore %</option>\n                                                        </select>\n                                                    </div>\n                                                    <div class="objective-config-row objective-target-row" style="display: ').concat("explore"!==e.type?"flex":"none",';">\n                                                        <label>Target:</label>\n                                                        <input type="text" class="objective-target mazemaster-input" value="').concat(_o(e.target||""),'" placeholder="').concat("collect"===e.type?"key, strike, stealth...":"minion ID",'">\n                                                    </div>\n                                                    <div class="objective-config-row">\n                                                        <label>Count:</label>\n                                                        <input type="number" class="objective-count mazemaster-input" value="').concat(e.count||1,'" min="1" placeholder="').concat("explore"===e.type?"% to explore":"amount",'">\n                                                    </div>\n                                                    <div class="objective-config-row">\n                                                        <label>Description:</label>\n                                                        <input type="text" class="objective-description mazemaster-input" value="').concat(_o(e.description||""),'" placeholder="Find 3 Keys">\n                                                    </div>\n                                                    <div class="objective-config-row">\n                                                        <label>Required:</label>\n                                                        <input type="checkbox" class="objective-required" ').concat(e.required?"checked":"",'>\n                                                    </div>\n                                                    <div class="objective-config-row">\n                                                        <label>Reward Script:</label>\n                                                        <input type="text" class="objective-reward mazemaster-input" value="').concat(_o(e.reward||""),'" placeholder="/echo Objective complete!">\n                                                    </div>\n                                                </div>\n                                            </div>\n                                        '))).join(""),'\n                                    </div>\n                                    <button id="mazemaster_add_objective_btn" class="menu_button">\n                                        <i class="fa-solid fa-plus"></i> Add Objective\n                                    </button>\n                                </div>\n                            </div>\n                        </div>\n\n                        \x3c!-- COLLAPSIBLE: Main Minion --\x3e\n                        <div class="mazemaster-collapsible ').concat(ne.mainMinion?"expanded":"",'">\n                            <button class="mazemaster-collapsible-header" data-target="main_minion_section">\n                                <i class="fa-solid fa-chevron-right mazemaster-collapse-icon"></i>\n                                <span>Main Minion</span>\n                                <span class="mazemaster-collapse-hint">(narrator/boss)</span>\n                            </button>\n                            <div id="main_minion_section" class="mazemaster-collapsible-content" style="display: ').concat(ne.mainMinion?"block":"none",';">\n                                <div class="mazemaster-section">\n                                    <select id="mazemaster_maze_main_minion" class="mazemaster-select">\n                                        <option value="">None</option>\n                                        ').concat(ae.map((e=>{const t=St(e);return'<option value="'.concat(_o(e),'" ').concat(ne.mainMinion===e?"selected":"",">").concat(_o((null==t?void 0:t.name)||e),"</option>")})).join(""),'\n                                    </select>\n                                    <div class="mazemaster-help-small"><small>The main minion narrates the maze and guards the exit</small></div>\n                                </div>\n\n                                <div id="mazemaster_main_minion_settings" class="mazemaster-subsection" style="display: ').concat(ne.mainMinion?"block":"none",';">\n                                    <div class="mazemaster-section">\n                                        <label class="mazemaster-label">Intro Message</label>\n                                        <input type="text" id="mazemaster_maze_intro_message" class="mazemaster-input" placeholder="Welcome to my maze..." value="').concat(_o(ne.mainMinionIntroMessage||""),'">\n                                    </div>\n\n                                    <div class="mazemaster-inline-row">\n                                        <div class="mazemaster-section mazemaster-flex-1">\n                                            <label class="mazemaster-label">Random Msg %</label>\n                                            <input type="number" id="mazemaster_maze_random_chance" class="mazemaster-input" min="0" max="100" value="').concat(ne.mainMinionRandomChance||15,'">\n                                        </div>\n                                    </div>\n\n                                    <div class="mazemaster-section">\n                                        <label class="mazemaster-label">Random Messages (one per line)</label>\n                                        <textarea id="mazemaster_maze_random_messages" class="mazemaster-textarea" rows="2" placeholder="You\'re still here?&#10;Getting lost yet?">').concat(_o((ne.mainMinionRandomMessages||[]).join("\n")),'</textarea>\n                                    </div>\n\n                                    <div class="mazemaster-section">\n                                        <label class="mazemaster-label">Exit Encounter</label>\n                                        <div class="mazemaster-help-small"><small>What happens when the player reaches the exit</small></div>\n                                        <select id="mazemaster_maze_exit_type" class="mazemaster-select">\n                                            <option value="messenger" ').concat("messenger"===(ne.mainMinionExitType||"messenger")?"selected":"",'>Message Only (no challenge)</option>\n                                            <option value="battlebar" ').concat("battlebar"===ne.mainMinionExitType?"selected":"",'>Battlebar Fight</option>\n                                            <option value="prizewheel" ').concat("prizewheel"===ne.mainMinionExitType?"selected":"",'>Prize Wheel</option>\n                                            <option value="turnbased" ').concat("turnbased"===ne.mainMinionExitType?"selected":"",'>Turn-Based Combat</option>\n                                            <option value="qte" ').concat("qte"===ne.mainMinionExitType?"selected":"",'>QTE Combat</option>\n                                            <option value="dice" ').concat("dice"===ne.mainMinionExitType?"selected":"",'>Dice Combat</option>\n                                            <option value="stealth" ').concat("stealth"===ne.mainMinionExitType?"selected":"",'>Stealth</option>\n                                            <option value="puzzle" ').concat("puzzle"===ne.mainMinionExitType?"selected":"",'>Puzzle</option>\n                                            <option value="negotiation" ').concat("negotiation"===ne.mainMinionExitType?"selected":"",'>Negotiation</option>\n                                        </select>\n                                    </div>\n\n                                    <div id="mazemaster_exit_profile_section" class="mazemaster-section" style="display: ').concat(ne.mainMinionExitType&&"messenger"!==ne.mainMinionExitType?"block":"none",';">\n                                        <label class="mazemaster-label">Exit Game Profile</label>\n                                        <div class="mazemaster-help-small"><small>Which Battlebar/Wheel profile to use for the exit boss</small></div>\n                                        <select id="mazemaster_maze_exit_profile" class="mazemaster-select">\n                                            <option value="">Select...</option>\n                                        </select>\n                                    </div>\n\n                                    <div class="mazemaster-section">\n                                        <button id="mazemaster_maze_story_btn" class="menu_button">\n                                            <i class="fa-solid fa-book"></i> Story Milestones\n                                        </button>\n                                        <div class="mazemaster-help-small"><small>Configure story text shown as player progresses</small></div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n\n                        \x3c!-- COLLAPSIBLE: Encounters --\x3e\n                        <div class="mazemaster-collapsible expanded">\n                            <button class="mazemaster-collapsible-header" data-target="encounters_section">\n                                <i class="fa-solid fa-chevron-right mazemaster-collapse-icon"></i>\n                                <span>Encounters</span>\n                                <span class="mazemaster-collapse-hint">(minions & traps)</span>\n                            </button>\n                            <div id="encounters_section" class="mazemaster-collapsible-content" style="display: block;">\n                                <div class="mazemaster-section">\n                                    <label class="mazemaster-label">Minion Encounters</label>\n                                    <div id="mazemaster_maze_encounters_list" class="mazemaster-encounters-list">\n                                        \x3c!-- Encounter rows rendered here --\x3e\n                                    </div>\n                                    <button id="mazemaster_add_encounter_btn" class="menu_button mazemaster-add-btn">\n                                        <i class="fa-solid fa-plus"></i> Add Minion\n                                    </button>\n                                </div>\n\n                                <div class="mazemaster-section">\n                                    <label class="mazemaster-label">Trap Tiles</label>\n                                    <div id="mazemaster_maze_traps_list" class="mazemaster-encounters-list">\n                                        \x3c!-- Trap encounter rows rendered here --\x3e\n                                    </div>\n                                    <button id="mazemaster_add_trap_encounter_btn" class="menu_button mazemaster-add-btn">\n                                        <i class="fa-solid fa-plus"></i> Add Trap\n                                    </button>\n                                </div>\n\n                                <div class="mazemaster-section">\n                                    <button id="mazemaster_intelligent_distribute" class="menu_button mazemaster-distribute-btn">\n                                        <i class="fa-solid fa-wand-magic-sparkles"></i> Intelligent Distribute\n                                    </button>\n                                    <div class="mazemaster-help-small">\n                                        <small>Auto-sets tile percentages based on minion types</small>\n                                    </div>\n                                </div>\n\n                                <div class="mazemaster-section">\n                                    <label class="mazemaster-label">On Battlebar Loss</label>\n                                    <select id="mazemaster_maze_loss_action" class="mazemaster-select">\n                                        <option value="continue" ').concat("continue"===(ne.onBattlebarLoss||"continue")?"selected":"",'>Continue (skip encounter)</option>\n                                        <option value="respawn" ').concat("respawn"===ne.onBattlebarLoss?"selected":"",'>Respawn at Start</option>\n                                        <option value="gameover" ').concat("gameover"===ne.onBattlebarLoss?"selected":"",'>Game Over</option>\n                                    </select>\n                                </div>\n                            </div>\n                        </div>\n\n                        \x3c!-- COLLAPSIBLE: Chests & Loot --\x3e\n                        <div class="mazemaster-collapsible">\n                            <button class="mazemaster-collapsible-header" data-target="chests_section">\n                                <i class="fa-solid fa-chevron-right mazemaster-collapse-icon"></i>\n                                <span>Chests & Loot</span>\n                            </button>\n                            <div id="chests_section" class="mazemaster-collapsible-content" style="display: none;">\n                                <div class="mazemaster-section">\n                                    <label class="mazemaster-label">Chest Image</label>\n                                    <div class="mazemaster-row" style="gap: 10px; align-items: center;">\n                                        <div class="mazemaster-chest-preview" style="width: 50px; height: 50px; border-radius: 5px; overflow: hidden; background: rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center;">\n                                            ').concat(ne.chestImage?'<img id="mazemaster_chest_preview_img" src="'.concat(Ee(ne.chestImage),'" style="width: 100%; height: 100%; object-fit: cover;">'):'<i id="mazemaster_chest_preview_icon" class="fa-solid fa-box" style="color: #888;"></i>','\n                                        </div>\n                                        <button id="mazemaster_chest_image_btn" class="menu_button menu_button_icon" title="Upload Chest Image">\n                                            <i class="fa-solid fa-upload"></i>\n                                        </button>\n                                        <input type="file" id="mazemaster_chest_image_file" accept="image/*" style="display: none;">\n                                        <small style="color: #888;">Custom chest appearance</small>\n                                    </div>\n                                </div>\n\n                                <div class="mazemaster-section">\n                                    <label class="mazemaster-label">Chest Distribution</label>\n                                    <div class="mazemaster-grid-2col">\n                                        <div class="mazemaster-row">\n                                            <label>Chest Tiles %</label>\n                                            <input type="number" id="mazemaster_maze_chest_percent" class="mazemaster-input-small" min="0" max="50" value="').concat(ne.chestTilePercent||10,'">\n                                        </div>\n                                        <div class="mazemaster-row">\n                                            <label>Locked %</label>\n                                            <input type="number" id="mazemaster_maze_locked_percent" class="mazemaster-input-small" min="0" max="100" value="').concat(ne.chestLockedPercent||30,'">\n                                        </div>\n                                        <div class="mazemaster-row">\n                                            <label>Locked Bonus %</label>\n                                            <input type="number" id="mazemaster_maze_locked_bonus" class="mazemaster-input-small" min="0" max="200" value="').concat(ne.chestLockedBonusPercent||50,'">\n                                        </div>\n                                        <div class="mazemaster-row">\n                                            <label>Mimic %</label>\n                                            <input type="number" id="mazemaster_maze_mimic_percent" class="mazemaster-input-small" min="0" max="100" value="').concat(ne.chestMimicPercent||15,'">\n                                        </div>\n                                    </div>\n                                </div>\n\n                                <div class="mazemaster-section">\n                                    <label class="mazemaster-label">Loot per Chest</label>\n                                    <div class="mazemaster-row">\n                                        <input type="number" id="mazemaster_maze_loot_min" class="mazemaster-input-small" min="1" max="10" value="').concat(ne.chestLootMin||1,'" style="width:50px">\n                                        <span>to</span>\n                                        <input type="number" id="mazemaster_maze_loot_max" class="mazemaster-input-small" min="1" max="10" value="').concat(ne.chestLootMax||2,'" style="width:50px">\n                                        <span>items</span>\n                                    </div>\n                                </div>\n\n                                <div class="mazemaster-section">\n                                    <label class="mazemaster-label">Regular Chest Loot %</label>\n                                    <div class="mazemaster-grid-4col">\n                                        <div class="mazemaster-row"><label>Key</label><input type="number" id="mazemaster_maze_chest_key" class="mazemaster-input-small" min="0" max="100" value="').concat(ne.chestKeyChance||30,'"></div>\n                                        <div class="mazemaster-row"><label>Strike</label><input type="number" id="mazemaster_maze_chest_pow" class="mazemaster-input-small" min="0" max="100" value="').concat(ne.chestStrikeChance||50,'"></div>\n                                        <div class="mazemaster-row"><label>Stealth</label><input type="number" id="mazemaster_maze_chest_stealth" class="mazemaster-input-small" min="0" max="100" value="').concat(ne.chestStealthChance||0,'"></div>\n                                        <div class="mazemaster-row"><label>Execute</label><input type="number" id="mazemaster_maze_chest_execute" class="mazemaster-input-small" min="0" max="100" value="').concat(ne.chestExecuteChance||0,'"></div>\n                                    </div>\n                                </div>\n\n                                <div class="mazemaster-section">\n                                    <label class="mazemaster-label">Locked Chest Loot %</label>\n                                    <div class="mazemaster-grid-4col">\n                                        <div class="mazemaster-row"><label>Key</label><input type="number" id="mazemaster_maze_locked_key" class="mazemaster-input-small" min="0" max="100" value="').concat(ne.lockedChestKeyChance||40,'"></div>\n                                        <div class="mazemaster-row"><label>Strike</label><input type="number" id="mazemaster_maze_locked_pow" class="mazemaster-input-small" min="0" max="100" value="').concat(ne.lockedChestStrikeChance||60,'"></div>\n                                        <div class="mazemaster-row"><label>Stealth</label><input type="number" id="mazemaster_maze_locked_stealth" class="mazemaster-input-small" min="0" max="100" value="').concat(ne.lockedChestStealthChance||30,'"></div>\n                                        <div class="mazemaster-row"><label>Execute</label><input type="number" id="mazemaster_maze_locked_execute" class="mazemaster-input-small" min="0" max="100" value="').concat(ne.lockedChestExecuteChance||5,'"></div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n\n                        \x3c!-- COLLAPSIBLE: Victory & Loss --\x3e\n                        <div class="mazemaster-collapsible">\n                            <button class="mazemaster-collapsible-header" data-target="victory_section">\n                                <i class="fa-solid fa-chevron-right mazemaster-collapse-icon"></i>\n                                <span>Victory & Loss</span>\n                            </button>\n                            <div id="victory_section" class="mazemaster-collapsible-content" style="display: none;">\n                                <div class="mazemaster-section">\n                                    <label class="mazemaster-label">Victory Message</label>\n                                    <input type="text" id="mazemaster_maze_win_message" class="mazemaster-input" placeholder="You escaped the maze!" value="').concat(_o(ne.winMessage||""),'">\n                                </div>\n\n                                <div class="mazemaster-section">\n                                    <label class="mazemaster-label">Victory Image</label>\n                                    <div class="mazemaster-maze-win-image-row">\n                                        <div class="mazemaster-maze-win-image-preview">\n                                            ').concat(ne.winImage?'<img id="maze_win_image_preview" src="'.concat(_o(ne.winImage),'" alt="Victory">'):'<div id="maze_win_image_preview" class="no-image">No image</div>','\n                                        </div>\n                                        <button id="mazemaster_maze_win_image_btn" class="menu_button">\n                                            <i class="fa-solid fa-upload"></i> Upload\n                                        </button>\n                                    </div>\n                                    <input type="file" id="mazemaster_maze_win_image_file" accept="image/*" style="display: none;">\n                                </div>\n\n                                <div class="mazemaster-section">\n                                    <label class="mazemaster-label">Win Command</label>\n                                    <textarea id="mazemaster_maze_win_cmd" class="mazemaster-textarea" rows="2" placeholder="/echo Victory!">').concat(_o(ne.winCommand||""),'</textarea>\n                                </div>\n\n                                <div class="mazemaster-section">\n                                    <label class="mazemaster-label">Lose Command</label>\n                                    <textarea id="mazemaster_maze_lose_cmd" class="mazemaster-textarea" rows="2" placeholder="/echo Defeated...">').concat(_o(ne.loseCommand||""),'</textarea>\n                                </div>\n                            </div>\n                        </div>\n\n                        \x3c!-- COLLAPSIBLE: Starting Inventory --\x3e\n                        <div class="mazemaster-collapsible">\n                            <button class="mazemaster-collapsible-header" data-target="starting_inv_section">\n                                <i class="fa-solid fa-chevron-right mazemaster-collapse-icon"></i>\n                                <span>Starting Inventory</span>\n                            </button>\n                            <div id="starting_inv_section" class="mazemaster-collapsible-content" style="display: none;">\n                                <div class="mazemaster-section">\n                                    <label style="font-size: 0.8em; color: var(--SmartThemeEmColor);">Combat Items</label>\n                                    <div class="mazemaster-grid-4col">\n                                        <div class="mazemaster-row"><label><i class="fa-solid fa-key"></i> Keys</label><input type="number" id="mazemaster_start_key" class="mazemaster-input-small" min="0" max="99" value="').concat((null===(_=ne.startingInventory)||void 0===_?void 0:_.key)||0,'"></div>\n                                        <div class="mazemaster-row"><label><i class="fa-solid fa-bolt"></i> Strike</label><input type="number" id="mazemaster_start_pow" class="mazemaster-input-small" min="0" max="99" value="').concat((null===(w=ne.startingInventory)||void 0===w?void 0:w.strike)||0,'"></div>\n                                        <div class="mazemaster-row"><label><i class="fa-solid fa-user-ninja"></i> Stealth</label><input type="number" id="mazemaster_start_stealth" class="mazemaster-input-small" min="0" max="99" value="').concat((null===(k=ne.startingInventory)||void 0===k?void 0:k.stealth)||0,'"></div>\n                                        <div class="mazemaster-row"><label><i class="fa-solid fa-star"></i> Execute</label><input type="number" id="mazemaster_start_execute" class="mazemaster-input-small" min="0" max="99" value="').concat((null===(C=ne.startingInventory)||void 0===C?void 0:C.execute)||0,'"></div>\n                                    </div>\n                                    <label style="font-size: 0.8em; color: var(--SmartThemeEmColor); margin-top: 8px;">HP Items</label>\n                                    <div class="mazemaster-grid-4col">\n                                        <div class="mazemaster-row"><label><i class="fa-solid fa-flask" style="color:#e74c3c;"></i> Potion</label><input type="number" id="mazemaster_start_healingPotion" class="mazemaster-input-small" min="0" max="99" value="').concat((null===(S=ne.startingInventory)||void 0===S?void 0:S.healingPotion)||0,'"></div>\n                                        <div class="mazemaster-row"><label><i class="fa-solid fa-flask" style="color:#9b59b6;"></i> Greater</label><input type="number" id="mazemaster_start_greaterHealing" class="mazemaster-input-small" min="0" max="99" value="').concat((null===(M=ne.startingInventory)||void 0===M?void 0:M.greaterHealing)||0,'"></div>\n                                        <div class="mazemaster-row"><label><i class="fa-solid fa-vial" style="color:#f1c40f;"></i> Elixir</label><input type="number" id="mazemaster_start_elixir" class="mazemaster-input-small" min="0" max="99" value="').concat((null===(E=ne.startingInventory)||void 0===E?void 0:E.elixir)||0,'"></div>\n                                        <div class="mazemaster-row"><label><i class="fa-solid fa-heart" style="color:#e91e63;"></i> Revival</label><input type="number" id="mazemaster_start_revivalCharm" class="mazemaster-input-small" min="0" max="99" value="').concat((null===(P=ne.startingInventory)||void 0===P?void 0:P.revivalCharm)||0,'"></div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n\n                        \x3c!-- COLLAPSIBLE: Find Early Items --\x3e\n                        <div class="mazemaster-collapsible">\n                            <button class="mazemaster-collapsible-header" data-target="find_early_section">\n                                <i class="fa-solid fa-chevron-right mazemaster-collapse-icon"></i>\n                                <span>Find Early Items</span>\n                            </button>\n                            <div id="find_early_section" class="mazemaster-collapsible-content" style="display: none;">\n                                <div class="mazemaster-help-small"><small>Guarantee items in chests near the starting position. Great for ensuring vision or healing items are available early.</small></div>\n                                <div class="mazemaster-section">\n                                    <div class="mazemaster-grid-3col" style="margin-bottom: 8px;">\n                                        <div class="mazemaster-row"><label>Search Radius</label><input type="number" id="mazemaster_findearly_radius" class="mazemaster-input-small" min="1" max="10" value="').concat((null===(I=ne.findEarly)||void 0===I?void 0:I.radius)||4,'" title="Manhattan distance from start to search for chests"></div>\n                                        <div class="mazemaster-row"><label>Items/Chest</label><input type="number" id="mazemaster_findearly_perchest" class="mazemaster-input-small" min="1" max="5" value="').concat((null===(T=ne.findEarly)||void 0===T?void 0:T.itemsPerChest)||1,'" title="Max guaranteed items per chest"></div>\n                                        <div></div>\n                                    </div>\n                                    <label class="mazemaster-label">Items to Place Near Start</label>\n                                    <div class="mazemaster-grid-5col" style="gap: 4px;">\n                                        <label class="mazemaster-checkbox-label"><input type="checkbox" id="mazemaster_findearly_torch" ').concat(null!==(B=ne.findEarly)&&void 0!==B&&null!==(B=B.items)&&void 0!==B&&B.includes("torch")?"checked":"",'><i class="fa-solid fa-fire" style="color:#f39c12;"></i> Torch</label>\n                                        <label class="mazemaster-checkbox-label"><input type="checkbox" id="mazemaster_findearly_lantern" ').concat(null!==(D=ne.findEarly)&&void 0!==D&&null!==(D=D.items)&&void 0!==D&&D.includes("lantern")?"checked":"",'><i class="fa-solid fa-lightbulb" style="color:#f1c40f;"></i> Lantern</label>\n                                        <label class="mazemaster-checkbox-label"><input type="checkbox" id="mazemaster_findearly_mapFragment" ').concat(null!==(L=ne.findEarly)&&void 0!==L&&null!==(L=L.items)&&void 0!==L&&L.includes("mapFragment")?"checked":"",'><i class="fa-solid fa-map" style="color:#3498db;"></i> Map</label>\n                                        <label class="mazemaster-checkbox-label"><input type="checkbox" id="mazemaster_findearly_healingPotion" ').concat(null!==(R=ne.findEarly)&&void 0!==R&&null!==(R=R.items)&&void 0!==R&&R.includes("healingPotion")?"checked":"",'><i class="fa-solid fa-flask" style="color:#e74c3c;"></i> Potion</label>\n                                        <label class="mazemaster-checkbox-label"><input type="checkbox" id="mazemaster_findearly_greaterHealing" ').concat(null!==(A=ne.findEarly)&&void 0!==A&&null!==(A=A.items)&&void 0!==A&&A.includes("greaterHealing")?"checked":"",'><i class="fa-solid fa-flask" style="color:#9b59b6;"></i> Greater</label>\n                                        <label class="mazemaster-checkbox-label"><input type="checkbox" id="mazemaster_findearly_revealScroll" ').concat(null!==(O=ne.findEarly)&&void 0!==O&&null!==(O=O.items)&&void 0!==O&&O.includes("revealScroll")?"checked":"",'><i class="fa-solid fa-scroll" style="color:#9b59b6;"></i> Reveal</label>\n                                        <label class="mazemaster-checkbox-label"><input type="checkbox" id="mazemaster_findearly_sightPotion" ').concat(null!==(H=ne.findEarly)&&void 0!==H&&null!==(H=H.items)&&void 0!==H&&H.includes("sightPotion")?"checked":"",'><i class="fa-solid fa-eye" style="color:#1abc9c;"></i> Sight</label>\n                                        <label class="mazemaster-checkbox-label"><input type="checkbox" id="mazemaster_findearly_key" ').concat(null!==(N=ne.findEarly)&&void 0!==N&&null!==(N=N.items)&&void 0!==N&&N.includes("key")?"checked":"",'><i class="fa-solid fa-key" style="color:#f1c40f;"></i> Key</label>\n                                        <label class="mazemaster-checkbox-label"><input type="checkbox" id="mazemaster_findearly_strike" ').concat(null!==(q=ne.findEarly)&&void 0!==q&&null!==(q=q.items)&&void 0!==q&&q.includes("strike")?"checked":"",'><i class="fa-solid fa-bolt" style="color:#e67e22;"></i> Strike</label>\n                                        <label class="mazemaster-checkbox-label"><input type="checkbox" id="mazemaster_findearly_stealth" ').concat(null!==(F=ne.findEarly)&&void 0!==F&&null!==(F=F.items)&&void 0!==F&&F.includes("stealth")?"checked":"",'><i class="fa-solid fa-user-ninja" style="color:#2ecc71;"></i> Stealth</label>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n\n                        \x3c!-- COLLAPSIBLE: HP System Settings --\x3e\n                        <div class="mazemaster-collapsible">\n                            <button class="mazemaster-collapsible-header" data-target="hp_settings_section">\n                                <i class="fa-solid fa-chevron-right mazemaster-collapse-icon"></i>\n                                <span>HP System Settings</span>\n                            </button>\n                            <div id="hp_settings_section" class="mazemaster-collapsible-content" style="display: none;">\n                                <div class="mazemaster-section">\n                                    <div class="mazemaster-row" style="margin-bottom: 8px;">\n                                        <label style="display: flex; align-items: center; gap: 8px;">\n                                            <input type="checkbox" id="mazemaster_hp_enabled" ').concat(!1!==ne.hpEnabled?"checked":"",'>\n                                            <span>Enable HP System</span>\n                                        </label>\n                                    </div>\n                                    <div class="mazemaster-grid-4col">\n                                        <div class="mazemaster-row"><label>Max HP</label><input type="number" id="mazemaster_hp_max" class="mazemaster-input-small" min="1" max="999" value="').concat(ne.maxHP||100,'"></div>\n                                        <div class="mazemaster-row"><label>Dmg Mult</label><input type="number" id="mazemaster_hp_battlebar_mult" class="mazemaster-input-small" min="0" max="10" step="0.1" value="').concat(null!==(j=ne.battlebarDamageMultiplier)&&void 0!==j?j:1,'" title="Multiplier for battlebar damage"></div>\n                                        <div class="mazemaster-row"><label>Diff Mult</label><input type="number" id="mazemaster_hp_battlebar_diff" class="mazemaster-input-small" min="0.1" max="3" step="0.1" value="').concat(null!==(W=ne.battlebarDifficultyMultiplier)&&void 0!==W?W:1,'" title="Multiplier for battlebar difficulty (speed/zone size)"></div>\n                                        <div class="mazemaster-row"><label>Respawn HP%</label><input type="number" id="mazemaster_hp_respawn" class="mazemaster-input-small" min="1" max="100" value="').concat(ne.respawnHPPercent||50,'"></div>\n                                    </div>\n                                    <div class="mazemaster-row" style="margin-top: 8px;">\n                                        <label>On Death</label>\n                                        <select id="mazemaster_hp_ondeath" class="mazemaster-select" style="width: auto;">\n                                            <option value="respawn" ').concat("respawn"===(ne.onDeath||"respawn")?"selected":"",'>Respawn at Start (100% HP)</option>\n                                            <option value="respawnPenalty" ').concat("respawnPenalty"===(ne.onDeath||"respawn")?"selected":"",'>Respawn at Start (Penalty HP%)</option>\n                                            <option value="gameover" ').concat("gameover"===(ne.onDeath||"respawn")?"selected":"",'>Game Over</option>\n                                        </select>\n                                    </div>\n\n                                    <label style="font-size: 0.8em; color: var(--SmartThemeEmColor); margin-top: 12px;">Safe Rooms</label>\n                                    <div class="mazemaster-grid-3col">\n                                        <div class="mazemaster-row"><label>Count/Floor</label><input type="number" id="mazemaster_saferoom_count" class="mazemaster-input-small" min="0" max="20" value="').concat(null!==(Y=ne.safeRoomCount)&&void 0!==Y?Y:3,'"></div>\n                                        <div class="mazemaster-row"><label>Heal %</label><input type="number" id="mazemaster_saferoom_heal" class="mazemaster-input-small" min="1" max="100" value="').concat(null!==(G=ne.safeRoomHealPercent)&&void 0!==G?G:100,'"></div>\n                                        <div class="mazemaster-row">\n                                            <label style="display: flex; align-items: center; gap: 4px;">\n                                                <input type="checkbox" id="mazemaster_saferoom_llm" ').concat(ne.safeRoomUseLLM?"checked":"",'>\n                                                <span>LLM Messages</span>\n                                            </label>\n                                        </div>\n                                    </div>\n\n                                    <label style="font-size: 0.8em; color: var(--SmartThemeEmColor); margin-top: 12px;">LLM Enhancement</label>\n                                    <div class="mazemaster-row" style="margin-bottom: 4px;">\n                                        <label style="display: flex; align-items: center; gap: 8px;">\n                                            <input type="checkbox" id="mazemaster_llm_enhance_rooms" ').concat(!1!==ne.llmEnhanceRooms?"checked":"",'>\n                                            <span>Enhance Room Descriptions</span>\n                                        </label>\n                                        <small style="color: var(--SmartThemeEmColor); margin-left: 24px;">LLM generates unique descriptions on first entry</small>\n                                    </div>\n\n                                    <label style="font-size: 0.8em; color: var(--SmartThemeEmColor); margin-top: 12px;">Rest Mechanic</label>\n                                    <div class="mazemaster-row" style="margin-bottom: 4px;">\n                                        <label style="display: flex; align-items: center; gap: 8px;">\n                                            <input type="checkbox" id="mazemaster_rest_enabled" ').concat(!1!==ne.restEnabled?"checked":"",'>\n                                            <span>Enable Rest Button</span>\n                                        </label>\n                                    </div>\n                                    <div class="mazemaster-grid-3col">\n                                        <div class="mazemaster-row"><label>Heal %</label><input type="number" id="mazemaster_rest_heal" class="mazemaster-input-small" min="1" max="100" value="').concat(null!==(U=ne.restHealPercent)&&void 0!==U?U:20,'"></div>\n                                        <div class="mazemaster-row"><label>Cooldown (turns)</label><input type="number" id="mazemaster_rest_cooldown" class="mazemaster-input-small" min="0" max="99" value="').concat(null!==(K=ne.restCooldown)&&void 0!==K?K:3,'"></div>\n                                        <div class="mazemaster-row"><label>Interrupt %</label><input type="number" id="mazemaster_rest_interrupt" class="mazemaster-input-small" min="0" max="100" value="').concat(null!==(V=ne.restInterruptChance)&&void 0!==V?V:0,'"></div>\n                                    </div>\n                                    <div class="mazemaster-row" style="margin-top: 4px;">\n                                        <label>Interrupt Script <small>(empty = random encounter)</small></label>\n                                        <input type="text" id="mazemaster_rest_interrupt_script" class="mazemaster-input" value="').concat(_o(ne.restInterruptScript||""),'" placeholder="/echo You were ambushed!">\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n\n                        \x3c!-- COLLAPSIBLE: STScript Hooks --\x3e\n                        <div class="mazemaster-collapsible">\n                            <button class="mazemaster-collapsible-header" data-target="hooks_section">\n                                <i class="fa-solid fa-chevron-right mazemaster-collapse-icon"></i>\n                                <span>STScript Hooks</span>\n                                <span class="mazemaster-collapse-hint">(advanced)</span>\n                            </button>\n                            <div id="hooks_section" class="mazemaster-collapsible-content" style="display: none;">\n                                <div class="mazemaster-help-small"><small>Run STScript commands when events occur. Use {{variable}} placeholders for event data.</small></div>\n\n                                <div class="mazemaster-hooks-group">\n                                    <label class="mazemaster-hooks-label">Movement</label>\n                                    <div class="mazemaster-hooks-items">\n                                        <div class="hook-item">\n                                            <label>On Move</label>\n                                            <input type="text" id="mazemaster_hook_onMove" class="mazemaster-input" value="').concat(_o(ne.onMove||""),'" placeholder="{{x}}, {{y}}, {{direction}}">\n                                        </div>\n                                        <div class="hook-item">\n                                            <label>On Milestone</label>\n                                            <input type="text" id="mazemaster_hook_onMilestone" class="mazemaster-input" value="').concat(_o(ne.onMilestone||""),'" placeholder="{{percentage}}">\n                                        </div>\n                                        <div class="hook-item">\n                                            <label>On Explore Complete</label>\n                                            <input type="text" id="mazemaster_hook_onExploreComplete" class="mazemaster-input" value="').concat(_o(ne.onExploreComplete||""),'" placeholder="Fires at 100%">\n                                        </div>\n                                    </div>\n                                </div>\n\n                                <div class="mazemaster-hooks-group">\n                                    <label class="mazemaster-hooks-label">Items</label>\n                                    <div class="mazemaster-hooks-items">\n                                        <div class="hook-item">\n                                            <label>On Item Add</label>\n                                            <input type="text" id="mazemaster_hook_onItemAdd" class="mazemaster-input" value="').concat(_o(ne.onItemAdd||""),'" placeholder="{{item}}, {{count}}, {{total}}">\n                                        </div>\n                                        <div class="hook-item">\n                                            <label>On Item Remove</label>\n                                            <input type="text" id="mazemaster_hook_onItemRemove" class="mazemaster-input" value="').concat(_o(ne.onItemRemove||""),'" placeholder="{{item}}, {{count}}, {{remaining}}">\n                                        </div>\n                                        <div class="hook-item">\n                                            <label>On Chest Open</label>\n                                            <input type="text" id="mazemaster_hook_onChestOpen" class="mazemaster-input" value="').concat(_o(ne.onChestOpen||""),'" placeholder="{{type}}, {{loot}}">\n                                        </div>\n                                        <div class="hook-item">\n                                            <label>On Trade</label>\n                                            <input type="text" id="mazemaster_hook_onTrade" class="mazemaster-input" value="').concat(_o(ne.onTrade||""),'" placeholder="{{given}}, {{received}}">\n                                        </div>\n                                    </div>\n                                </div>\n\n                                <div class="mazemaster-hooks-group">\n                                    <label class="mazemaster-hooks-label">Special Tiles</label>\n                                    <div class="mazemaster-hooks-items">\n                                        <div class="hook-item">\n                                            <label>On Enemy Move</label>\n                                            <input type="text" id="mazemaster_hook_onEnemyMove" class="mazemaster-input" value="').concat(_o(ne.onEnemyMove||""),'" placeholder="{{minionId}}, {{fromX}}, {{fromY}}, {{toX}}, {{toY}}">\n                                        </div>\n                                        <div class="hook-item">\n                                            <label>On Teleport</label>\n                                            <input type="text" id="mazemaster_hook_onTeleport" class="mazemaster-input" value="').concat(_o(ne.onTeleport||""),'" placeholder="{{portalId}}, {{fromX}}, {{fromY}}, {{toX}}, {{toY}}">\n                                        </div>\n                                    </div>\n                                </div>\n\n                                <div class="mazemaster-hooks-group">\n                                    <label class="mazemaster-hooks-label">Objectives</label>\n                                    <div class="mazemaster-hooks-items">\n                                        <div class="hook-item">\n                                            <label>On Progress</label>\n                                            <input type="text" id="mazemaster_hook_onObjectiveProgress" class="mazemaster-input" value="').concat(_o(ne.onObjectiveProgress||""),'" placeholder="{{objectiveId}}, {{current}}, {{target}}">\n                                        </div>\n                                        <div class="hook-item">\n                                            <label>On Complete</label>\n                                            <input type="text" id="mazemaster_hook_onObjectiveComplete" class="mazemaster-input" value="').concat(_o(ne.onObjectiveComplete||""),'" placeholder="{{objectiveId}}">\n                                        </div>\n                                        <div class="hook-item">\n                                            <label>On All Complete</label>\n                                            <input type="text" id="mazemaster_hook_onAllObjectivesComplete" class="mazemaster-input" value="').concat(_o(ne.onAllObjectivesComplete||""),'" placeholder="All required done">\n                                        </div>\n                                    </div>\n                                </div>\n\n                                <div class="mazemaster-hooks-group">\n                                    <label class="mazemaster-hooks-label">Stats</label>\n                                    <div class="mazemaster-hooks-items">\n                                        <div class="hook-item">\n                                            <label>On Stat Update</label>\n                                            <input type="text" id="mazemaster_hook_onStatUpdate" class="mazemaster-input" value="').concat(_o(ne.onStatUpdate||""),'" placeholder="{{statName}}, {{value}}">\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n\n                        \x3c!-- Save Button --\x3e\n                        <div class="mazemaster-section">\n                            <button id="mazemaster_maze_save_btn" class="menu_button menu_button_primary mazemaster-save-btn">\n                                <i class="fa-solid fa-save"></i> Save Profile\n                            </button>\n                        </div>\n\n                        \x3c!-- Saved Games --\x3e\n                        <div class="mazemaster-collapsible">\n                            <button class="mazemaster-collapsible-header" data-target="saved_games_section">\n                                <i class="fa-solid fa-chevron-right mazemaster-collapse-icon"></i>\n                                <span>Saved Games</span>\n                            </button>\n                            <div id="saved_games_section" class="mazemaster-collapsible-content" style="display: none;">\n                                <div id="mazemaster_saved_games_list" class="mazemaster-saved-games-list">\n                                    \x3c!-- Saved games rendered here --\x3e\n                                </div>\n                            </div>\n                        </div>\n\n                        \x3c!-- Usage Help --\x3e\n                        <div class="mazemaster-section">\n                            <div class="mazemaster-help">\n                                <div class="mazemaster-help-title">Usage:</div>\n                                <code>/maze profile="profileName"</code>\n                            </div>\n                        </div>\n                    </div>\n\n                    \x3c!-- MINIONS CONFIG --\x3e\n                    <div id="mazemaster_minions_config" class="mazemaster-game-config" style="').concat("minions"===oe?"":"display: none;",'">\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Minion Profile</label>\n                            <div class="mazemaster-profile-row">\n                                <select id="mazemaster_minion_profile_select" class="mazemaster-select">\n                                    <option value="">-- Show All Minions --</option>\n                                    ').concat(Object.keys(Re.minionProfiles||{}).map((e=>'<option value="'.concat(_o(e),'">').concat(_o(e),"</option>"))).join(""),'\n                                </select>\n                                <button id="mazemaster_minion_profile_save_btn" class="menu_button menu_button_icon" title="Save Current as Profile">\n                                    <i class="fa-solid fa-floppy-disk"></i>\n                                </button>\n                                <button id="mazemaster_minion_profile_load_btn" class="menu_button menu_button_icon" title="Load Profile">\n                                    <i class="fa-solid fa-folder-open"></i>\n                                </button>\n                                <button id="mazemaster_minion_profile_delete_btn" class="menu_button menu_button_icon" title="Delete Profile">\n                                    <i class="fa-solid fa-trash"></i>\n                                </button>\n                            </div>\n                            <div class="mazemaster-help-small"><small>Save/load sets of minions as profiles</small></div>\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Minions</label>\n                            <div id="mazemaster_minions_list" class="mazemaster-minions-list">\n                                \x3c!-- Minions rendered here --\x3e\n                            </div>\n                            <button id="mazemaster_add_minion_btn" class="menu_button mazemaster-add-btn">\n                                <i class="fa-solid fa-plus"></i> Add Minion\n                            </button>\n                            <input type="file" id="mazemaster_minion_image_file" accept="image/*" style="display: none;">\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <div class="mazemaster-help">\n                                <div class="mazemaster-help-title">Usage:</div>\n                                <code>/mazeminion name="MinionName" message="Hello!"</code>\n                                <p><small>Sets the minion display in an active maze game.</small></p>\n                            </div>\n                        </div>\n                    </div>\n\n                    \x3c!-- TRAPS CONFIG --\x3e\n                    <div id="mazemaster_traps_config" class="mazemaster-game-config" style="').concat("traps"===oe?"":"display: none;",'">\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Trap Profile</label>\n                            <div class="mazemaster-profile-row">\n                                <select id="mazemaster_trap_profile_select" class="mazemaster-select">\n                                    <option value="">(Current Traps)</option>\n                                    ').concat(Object.keys(Re.trapProfiles||{}).map((e=>'<option value="'.concat(_o(e),'">').concat(_o(e),"</option>"))).join(""),'\n                                </select>\n                                <button id="mazemaster_trap_profile_save_btn" class="menu_button menu_button_icon" title="Save Current as Profile">\n                                    <i class="fa-solid fa-floppy-disk"></i>\n                                </button>\n                                <button id="mazemaster_trap_profile_load_btn" class="menu_button menu_button_icon" title="Load Profile">\n                                    <i class="fa-solid fa-folder-open"></i>\n                                </button>\n                                <button id="mazemaster_trap_profile_delete_btn" class="menu_button menu_button_icon" title="Delete Profile">\n                                    <i class="fa-solid fa-trash"></i>\n                                </button>\n                            </div>\n                            <div class="mazemaster-help-small"><small>Save/load sets of traps as profiles</small></div>\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Traps</label>\n                            <div id="mazemaster_traps_list" class="mazemaster-traps-list">\n                                \x3c!-- Traps rendered here --\x3e\n                            </div>\n                            <button id="mazemaster_add_trap_btn" class="menu_button mazemaster-add-btn">\n                                <i class="fa-solid fa-plus"></i> Add Trap\n                            </button>\n                            <input type="file" id="mazemaster_trap_image_file" accept="image/*" style="display: none;">\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <div class="mazemaster-help">\n                                <div class="mazemaster-help-title">Traps:</div>\n                                <p><small>Traps can be placed on maze tiles. When a player steps on a trap, it shows the image/message and runs the script.</small></p>\n                                <p><small>Add traps to maze profiles in the Maze tab under "Trap Tiles".</small></p>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n\n                \x3c!-- HELP TAB --\x3e\n                <div class="mazemaster-tab-content" id="mazemaster-tab-help">\n                    <div class="mazemaster-help-reference">\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label"><i class="fa-solid fa-terminal"></i> Slash Commands Reference</label>\n\n                            <div class="mazemaster-help-category">\n                                <div class="mazemaster-help-title">Wheel Commands</div>\n                                <div class="mazemaster-command-list">\n                                    <div class="mazemaster-command">\n                                        <code>/wheel [profile="name"]</code>\n                                        <span>Open the wheel using specified or current profile</span>\n                                    </div>\n                                    <div class="mazemaster-command">\n                                        <code>/spin [profile]</code>\n                                        <span>Spin the wheel using the specified or current profile</span>\n                                    </div>\n                                    <div class="mazemaster-command">\n                                        <code>/spinresult</code>\n                                        <span>Returns the last wheel spin result</span>\n                                    </div>\n                                </div>\n                            </div>\n\n                            <div class="mazemaster-help-category">\n                                <div class="mazemaster-help-title">Battlebar Commands</div>\n                                <div class="mazemaster-command-list">\n                                    <div class="mazemaster-command">\n                                        <code>/battlebar [profile="name"]</code>\n                                        <span>Start a battlebar challenge (difficulty 1-10)</span>\n                                    </div>\n                                    <div class="mazemaster-command">\n                                        <code>/battlebarresult</code>\n                                        <span>Returns the last battlebar result (win/lose)</span>\n                                    </div>\n                                </div>\n                            </div>\n\n                            <div class="mazemaster-help-category">\n                                <div class="mazemaster-help-title">Maze Commands</div>\n                                <div class="mazemaster-command-list">\n                                    <div class="mazemaster-command">\n                                        <code>/maze [profile="name"]</code>\n                                        <span>Start a maze using the specified or current profile</span>\n                                    </div>\n                                    <div class="mazemaster-command">\n                                        <code>/mazeclose</code>\n                                        <span>Close the current maze</span>\n                                    </div>\n                                    <div class="mazemaster-command">\n                                        <code>/mazepos</code>\n                                        <span>Returns current position as JSON (x, y, floor)</span>\n                                    </div>\n                                    <div class="mazemaster-command">\n                                        <code>/mazestats</code>\n                                        <span>Returns maze statistics (moves, encounters, chests, etc.)</span>\n                                    </div>\n                                    <div class="mazemaster-command">\n                                        <code>/mazeexplore</code>\n                                        <span>Returns exploration percentage (0-100)</span>\n                                    </div>\n                                    <div class="mazemaster-command">\n                                        <code>/mazeobjective [id="name"]</code>\n                                        <span>Get objective progress (all or specific by ID)</span>\n                                    </div>\n                                    <div class="mazemaster-command">\n                                        <code>/mazemove &lt;direction&gt;</code>\n                                        <span>Move the player (up/down/left/right)</span>\n                                    </div>\n                                    <div class="mazemaster-command">\n                                        <code>/mazeminion [name="x"] [message="x"]</code>\n                                        <span>Set minion display in active maze</span>\n                                    </div>\n                                    <div class="mazemaster-command">\n                                        <code>/mazefloor</code>\n                                        <span>Returns current/total floor info as JSON</span>\n                                    </div>\n                                </div>\n                            </div>\n\n                            <div class="mazemaster-help-category">\n                                <div class="mazemaster-help-title">Maze Settings Commands</div>\n                                <div class="mazemaster-command-list">\n                                    <div class="mazemaster-command">\n                                        <code>/mazedifficulty [tier="x"]</code>\n                                        <span>Get/set difficulty (easy/normal/hard/nightmare)</span>\n                                    </div>\n                                    <div class="mazemaster-command">\n                                        <code>/mazetheme [theme="x"]</code>\n                                        <span>Get/set theme (fantasy/horror/scifi/action)</span>\n                                    </div>\n                                    <div class="mazemaster-command">\n                                        <code>/mazemapstyle [style="x"]</code>\n                                        <span>Get/set map style (maze/dungeon/city/forest/spaceship)</span>\n                                    </div>\n                                    <div class="mazemaster-command">\n                                        <code>/mazepersonastats [persona="x"]</code>\n                                        <span>Get maze stats for a persona (current if omitted)</span>\n                                    </div>\n                                </div>\n                            </div>\n\n                            <div class="mazemaster-help-category">\n                                <div class="mazemaster-help-title">HP System Commands</div>\n                                <div class="mazemaster-command-list">\n                                    <div class="mazemaster-command">\n                                        <code>/mazehp [set=N]</code>\n                                        <span>Get HP status as JSON, or set HP to value</span>\n                                    </div>\n                                    <div class="mazemaster-command">\n                                        <code>/mazeheal [amount=N] [percent=true]</code>\n                                        <span>Heal player (absolute or % of max)</span>\n                                    </div>\n                                    <div class="mazemaster-command">\n                                        <code>/mazedamage [amount=N] [source="x"]</code>\n                                        <span>Deal damage with optional source for hooks</span>\n                                    </div>\n                                </div>\n                            </div>\n\n                            <div class="mazemaster-help-category">\n                                <div class="mazemaster-help-title">Inventory Commands</div>\n                                <div class="mazemaster-command-list">\n                                    <div class="mazemaster-command">\n                                        <code>/mazeitem action="add" item="x" [amount=N]</code>\n                                        <span>Add item(s) to inventory by name or number</span>\n                                    </div>\n                                    <div class="mazemaster-command">\n                                        <code>/mazeitem action="remove" item="x" [amount=N]</code>\n                                        <span>Remove item(s) from inventory</span>\n                                    </div>\n                                    <div class="mazemaster-command">\n                                        <code>/mazeitem action="list"</code>\n                                        <span>List all available items with IDs</span>\n                                    </div>\n                                </div>\n                            </div>\n\n                            <div class="mazemaster-help-category">\n                                <div class="mazemaster-help-title">Item Reference</div>\n                                <div class="mazemaster-command-list">\n                                    <div class="mazemaster-item-ref"><span class="item-num">1-4</span> <strong>Core:</strong> key, stealth, strike, execute</div>\n                                    <div class="mazemaster-item-ref"><span class="item-num">5-10</span> <strong>Special:</strong> floorKey, portalStone, minionBane, mapFragment, timeShard, voidWalk</div>\n                                    <div class="mazemaster-item-ref"><span class="item-num">11-15</span> <strong>HP:</strong> healingPotion (25%), greaterHealing (50%), elixir (100%), revivalCharm, heartCrystal (+10 max)</div>\n                                    <div class="mazemaster-item-ref"><span class="item-num">16-20</span> <strong>Vision:</strong> torch (+2 for 3 moves), lantern (+1 passive), revealScroll (full floor), sightPotion (+1 perm), crystalBall (show minions)</div>\n                                </div>\n                            </div>\n\n                            <div class="mazemaster-help-category">\n                                <div class="mazemaster-help-title">Combat Mode Commands</div>\n                                <div class="mazemaster-command-list">\n                                    <div class="mazemaster-command">\n                                        <code>/turnbased [profile="name"]</code>\n                                        <span>Start turn-based combat encounter</span>\n                                    </div>\n                                    <div class="mazemaster-command">\n                                        <code>/qte [profile="name"]</code>\n                                        <span>Start Quick-Time Event challenge</span>\n                                    </div>\n                                    <div class="mazemaster-command">\n                                        <code>/dice [profile="name"]</code>\n                                        <span>Start dice roll challenge</span>\n                                    </div>\n                                    <div class="mazemaster-command">\n                                        <code>/stealth [profile="name"]</code>\n                                        <span>Start stealth encounter</span>\n                                    </div>\n                                    <div class="mazemaster-command">\n                                        <code>/puzzle [profile="name"]</code>\n                                        <span>Start puzzle/sequence challenge</span>\n                                    </div>\n                                    <div class="mazemaster-command">\n                                        <code>/negotiate [profile="name"]</code>\n                                        <span>Start negotiation encounter</span>\n                                    </div>\n                                </div>\n                            </div>\n\n                            <div class="mazemaster-help-category">\n                                <div class="mazemaster-help-title">Encounter Commands</div>\n                                <div class="mazemaster-command-list">\n                                    <div class="mazemaster-command">\n                                        <code>/encounter [profile]</code>\n                                        <span>Trigger a random minion encounter from pool</span>\n                                    </div>\n                                    <div class="mazemaster-command">\n                                        <code>/encounterresult</code>\n                                        <span>Returns the last encounter result</span>\n                                    </div>\n                                </div>\n                            </div>\n\n                            <div class="mazemaster-help-category">\n                                <div class="mazemaster-help-title">Utility Commands</div>\n                                <div class="mazemaster-command-list">\n                                    <div class="mazemaster-command">\n                                        <code>/mmexport &lt;type&gt; [name]</code>\n                                        <span>Export profile (wheel/maze/battlebar/minion/turnbased/qte/dice/stealth/puzzle/negotiate)</span>\n                                    </div>\n                                    <div class="mazemaster-command">\n                                        <code>/mmimport &lt;type&gt; &lt;json&gt;</code>\n                                        <span>Import profile from JSON</span>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label"><i class="fa-solid fa-book"></i> STScript Hooks</label>\n                            <div class="mazemaster-help">\n                                <p><small>Maze profiles support STScript hooks that fire on events:</small></p>\n                                <ul class="mazemaster-hooks-list">\n                                    <li><code>onEnter</code> - When entering the maze</li>\n                                    <li><code>onExit</code> - When completing the maze</li>\n                                    <li><code>onMove</code> - Each time player moves</li>\n                                    <li><code>onFloorChange</code> - When changing floors</li>\n                                    <li><code>onEncounter</code> - When encountering a minion</li>\n                                    <li><code>onChest</code> - When opening a chest</li>\n                                    <li><code>onTrap</code> - When triggering a trap</li>\n                                    <li><code>onDamage</code> - When taking damage (HP system)</li>\n                                    <li><code>onHeal</code> - When healing (HP system)</li>\n                                    <li><code>onPlayerDeath</code> - When HP reaches 0</li>\n                                </ul>\n                                <p><small>Configure hooks in maze profile settings.</small></p>\n                            </div>\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label"><i class="fa-solid fa-circle-info"></i> Version Info</label>\n                            <div class="mazemaster-help">\n                                <p><strong>MazeMaster v1.3.0</strong></p>\n                                <p><small>HP System, Combat Modes (Turn-based, QTE, Dice, Stealth, Puzzle, Negotiation), Multi-floor Dungeons, Isometric Renderer, Fog of War</small></p>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n\n        <style>\n            .mazemaster-panel {\n                display: flex;\n                flex-direction: column;\n                height: 100%;\n            }\n\n            .mazemaster-panel-header {\n                padding: 10px 15px;\n                border-bottom: 1px solid var(--SmartThemeBorderColor, #555);\n            }\n\n            .mazemaster-panel-header h2 {\n                margin: 0;\n                font-size: 1.2em;\n                display: flex;\n                align-items: center;\n                gap: 10px;\n            }\n\n            .mazemaster-tabs {\n                display: flex;\n                border-bottom: 1px solid var(--SmartThemeBorderColor, #555);\n                padding: 0 10px;\n            }\n\n            .mazemaster-tab {\n                padding: 8px 16px;\n                background: transparent;\n                border: none;\n                border-bottom: 2px solid transparent;\n                cursor: pointer;\n                color: var(--SmartThemeBodyColor);\n                font-size: 0.9em;\n            }\n\n            .mazemaster-tab:hover {\n                background: rgba(255, 255, 255, 0.05);\n            }\n\n            .mazemaster-tab.active {\n                border-bottom-color: var(--SmartThemeQuoteColor, #4a7c59);\n                color: var(--SmartThemeQuoteColor, #4a7c59);\n            }\n\n            .mazemaster-panel-content {\n                flex: 1;\n                overflow-y: auto;\n                padding: 15px;\n            }\n\n            .mazemaster-tab-content {\n                display: none;\n            }\n\n            .mazemaster-tab-content.active {\n                display: block;\n            }\n\n            /* Combat sub-tabs */\n            .mazemaster-combat-subtabs {\n                display: flex;\n                gap: 4px;\n                margin-bottom: 12px;\n                flex-wrap: wrap;\n                padding-bottom: 10px;\n                border-bottom: 1px solid var(--SmartThemeBorderColor, #444);\n            }\n\n            .combat-subtab {\n                padding: 6px 12px;\n                background: var(--SmartThemeBlurTintColor, rgba(0,0,0,0.3));\n                border: 1px solid var(--SmartThemeBorderColor, #555);\n                border-radius: 4px;\n                cursor: pointer;\n                font-size: 0.85em;\n                color: var(--SmartThemeBodyColor);\n                transition: all 0.15s ease;\n            }\n\n            .combat-subtab:hover {\n                background: rgba(255, 255, 255, 0.1);\n            }\n\n            .combat-subtab.active {\n                background: var(--SmartThemeQuoteColor, #4a7c59);\n                color: var(--SmartThemeBodyColor);\n                border-color: var(--SmartThemeQuoteColor, #4a7c59);\n            }\n\n            .combat-content {\n                display: none;\n            }\n\n            .combat-content.active {\n                display: block;\n            }\n\n            .mazemaster-section {\n                margin-bottom: 15px;\n            }\n\n            .mazemaster-label {\n                display: block;\n                font-weight: bold;\n                margin-bottom: 5px;\n                font-size: 0.9em;\n            }\n\n            .mazemaster-profile-row {\n                display: flex;\n                gap: 5px;\n            }\n\n            .mazemaster-profile-row select {\n                flex: 1;\n            }\n\n            .mazemaster-select {\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 6px 8px;\n                color: var(--SmartThemeBodyColor);\n            }\n\n            .mazemaster-segments-list {\n                display: flex;\n                flex-direction: column;\n                gap: 8px;\n                margin-bottom: 10px;\n                max-height: 300px;\n                overflow-y: auto;\n            }\n\n            .mazemaster-segment-item {\n                background: rgba(0, 0, 0, 0.2);\n                border-radius: 5px;\n                padding: 10px;\n            }\n\n            .mazemaster-segment-row {\n                display: flex;\n                gap: 8px;\n                margin-bottom: 8px;\n                align-items: center;\n            }\n\n            .mazemaster-segment-row:last-child {\n                margin-bottom: 0;\n            }\n\n            .mazemaster-segment-field {\n                flex: 1;\n                display: flex;\n                flex-direction: column;\n                gap: 2px;\n            }\n\n            .mazemaster-segment-field label {\n                font-size: 0.7em;\n                opacity: 0.7;\n            }\n\n            .mazemaster-segment-field input:not([type="checkbox"]),\n            .mazemaster-segment-field select,\n            .mazemaster-segment-field textarea {\n                width: 100%;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 5px 8px;\n                color: var(--SmartThemeBodyColor);\n                font-size: 0.85em;\n            }\n\n            .mazemaster-segment-field textarea {\n                min-height: 40px;\n                resize: vertical;\n                font-family: monospace;\n            }\n\n            .mazemaster-segment-field.small {\n                flex: 0 0 80px;\n            }\n\n            .mazemaster-segment-field.tiny {\n                flex: 0 0 100px;\n                overflow: visible;\n            }\n\n            .mazemaster-segment-checkbox {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                font-size: 0.85em;\n                cursor: pointer;\n                white-space: nowrap;\n                padding: 5px;\n                margin: 0;\n            }\n\n            .mazemaster-segment-checkbox input[type="checkbox"] {\n                width: 18px;\n                height: 18px;\n                min-width: 18px;\n                min-height: 18px;\n                cursor: pointer;\n                pointer-events: auto;\n                margin: 0;\n                flex-shrink: 0;\n            }\n\n            .mazemaster-profile-settings {\n                background: rgba(0, 0, 0, 0.15);\n                padding: 10px;\n                border-radius: 5px;\n            }\n\n            .mazemaster-profile-options {\n                display: flex;\n                flex-direction: column;\n                gap: 10px;\n            }\n\n            .mazemaster-checkbox-label {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                cursor: pointer;\n                font-size: 0.9em;\n            }\n\n            .mazemaster-checkbox-label input[type="checkbox"] {\n                width: 16px;\n                height: 16px;\n                cursor: pointer;\n            }\n\n            .mazemaster-difficulty-row {\n                display: flex;\n                align-items: center;\n                gap: 10px;\n                font-size: 0.9em;\n            }\n\n            .mazemaster-select-small {\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 4px 8px;\n                color: var(--SmartThemeBodyColor);\n                width: 60px;\n            }\n\n            .mazemaster-segment-delete {\n                padding: 5px 8px;\n            }\n\n            .mazemaster-add-btn,\n            .mazemaster-save-btn {\n                width: 100%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 5px;\n            }\n\n            .mazemaster-distribute-btn {\n                width: 100%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 8px;\n                background: linear-gradient(135deg, #9b59b6, #8e44ad) !important;\n                color: #fff !important;\n            }\n\n            .mazemaster-distribute-btn:hover {\n                background: linear-gradient(135deg, #8e44ad, #7d3c98) !important;\n            }\n\n            .mazemaster-help-small {\n                margin-top: 5px;\n                color: #888;\n                text-align: center;\n            }\n\n            /* Help Tab Styles */\n            .mazemaster-help-reference {\n                padding: 5px;\n            }\n\n            .mazemaster-help-category {\n                margin-bottom: 16px;\n                padding: 10px;\n                background: rgba(0, 0, 0, 0.2);\n                border-radius: 6px;\n            }\n\n            .mazemaster-help-category .mazemaster-help-title {\n                font-weight: 600;\n                margin-bottom: 8px;\n                color: var(--SmartThemeQuoteColor, #4a7c59);\n                border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n                padding-bottom: 5px;\n            }\n\n            .mazemaster-command-list {\n                display: flex;\n                flex-direction: column;\n                gap: 6px;\n            }\n\n            .mazemaster-command {\n                display: flex;\n                flex-wrap: wrap;\n                gap: 8px;\n                align-items: baseline;\n                padding: 4px 0;\n            }\n\n            .mazemaster-command code {\n                background: rgba(0, 0, 0, 0.3);\n                padding: 3px 8px;\n                border-radius: 4px;\n                font-family: \'Consolas\', \'Monaco\', monospace;\n                font-size: 0.85em;\n                color: #e8c170;\n                white-space: nowrap;\n            }\n\n            .mazemaster-command span {\n                color: #aaa;\n                font-size: 0.85em;\n            }\n\n            .mazemaster-item-ref {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                padding: 3px 0;\n                font-size: 0.85em;\n            }\n\n            .mazemaster-item-ref .item-num {\n                display: inline-flex;\n                align-items: center;\n                justify-content: center;\n                width: 20px;\n                height: 20px;\n                background: var(--SmartThemeQuoteColor, #4a7c59);\n                border-radius: 4px;\n                font-weight: bold;\n                font-size: 0.8em;\n            }\n\n            .mazemaster-item-ref code {\n                background: rgba(0, 0, 0, 0.3);\n                padding: 2px 6px;\n                border-radius: 3px;\n                font-family: \'Consolas\', \'Monaco\', monospace;\n                color: #e8c170;\n            }\n\n            .mazemaster-hooks-list {\n                margin: 8px 0;\n                padding-left: 20px;\n            }\n\n            .mazemaster-hooks-list li {\n                margin: 4px 0;\n                font-size: 0.85em;\n            }\n\n            .mazemaster-hooks-list code {\n                background: rgba(0, 0, 0, 0.3);\n                padding: 2px 6px;\n                border-radius: 3px;\n                font-family: \'Consolas\', \'Monaco\', monospace;\n                color: #e8c170;\n            }\n\n            .menu_button_primary {\n                background: var(--SmartThemeQuoteColor, #4a7c59) !important;\n            }\n\n            .mazemaster-help {\n                background: rgba(0, 0, 0, 0.2);\n                padding: 10px;\n                border-radius: 5px;\n                font-size: 0.85em;\n            }\n\n            .mazemaster-help-title {\n                font-weight: bold;\n                margin-bottom: 5px;\n                margin-top: 10px;\n            }\n\n            .mazemaster-help-title:first-child {\n                margin-top: 0;\n            }\n\n            .mazemaster-help code {\n                background: rgba(0, 0, 0, 0.3);\n                padding: 2px 6px;\n                border-radius: 3px;\n                font-family: monospace;\n                font-size: 0.9em;\n            }\n\n            .mazemaster-help ul {\n                margin: 5px 0;\n                padding-left: 20px;\n            }\n\n            .mazemaster-help li {\n                margin: 3px 0;\n            }\n\n            .mazemaster-help small {\n                opacity: 0.7;\n                display: block;\n                margin-top: 5px;\n            }\n\n            .mazemaster-empty-state {\n                text-align: center;\n                padding: 15px;\n                opacity: 0.6;\n            }\n\n            /* Game Selector */\n            .mazemaster-game-selector {\n                display: flex;\n                gap: 10px;\n                margin-bottom: 15px;\n            }\n\n            .mazemaster-game-btn {\n                flex: 1;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 8px;\n                padding: 10px;\n                border-radius: 5px;\n                transition: all 0.2s;\n            }\n\n            .mazemaster-game-btn.active {\n                background: var(--SmartThemeQuoteColor, #4a7c59) !important;\n                color: white;\n            }\n\n            .mazemaster-game-config {\n                animation: fadeIn 0.2s ease;\n            }\n\n            @keyframes fadeIn {\n                from { opacity: 0; }\n                to { opacity: 1; }\n            }\n\n            /* Battlebar Styles */\n            .mazemaster-bb-settings {\n                display: flex;\n                flex-direction: column;\n                gap: 10px;\n            }\n\n            .mazemaster-bb-row {\n                display: flex;\n                gap: 10px;\n            }\n\n            .mazemaster-bb-field {\n                flex: 1;\n                display: flex;\n                flex-direction: column;\n                gap: 4px;\n            }\n\n            .mazemaster-bb-field label {\n                font-size: 0.8em;\n                opacity: 0.8;\n            }\n\n            .mazemaster-bb-field input,\n            .mazemaster-bb-field select {\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 6px 8px;\n                color: var(--SmartThemeBodyColor);\n            }\n\n            .mazemaster-bb-commands {\n                display: flex;\n                flex-direction: column;\n                gap: 10px;\n            }\n\n            .mazemaster-bb-command {\n                display: flex;\n                flex-direction: column;\n                gap: 4px;\n            }\n\n            .mazemaster-bb-command label {\n                font-size: 0.85em;\n                font-weight: bold;\n            }\n\n            .mazemaster-bb-command textarea {\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 8px;\n                color: var(--SmartThemeBodyColor);\n                font-family: monospace;\n                font-size: 0.85em;\n                min-height: 40px;\n                resize: vertical;\n            }\n\n            .mazemaster-bb-images-list {\n                display: flex;\n                flex-wrap: wrap;\n                gap: 10px;\n                margin-bottom: 10px;\n            }\n\n            .mazemaster-input {\n                width: 100%;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 8px 10px;\n                color: var(--SmartThemeBodyColor, #fff);\n                font-size: 1em;\n            }\n\n            .mazemaster-input::placeholder {\n                color: var(--SmartThemeBodyColor, #888);\n                opacity: 0.6;\n            }\n\n            .mazemaster-bb-image-item {\n                position: relative;\n                width: 120px;\n                display: flex;\n                flex-direction: column;\n                border-radius: 5px;\n                overflow: hidden;\n                border: 2px solid var(--SmartThemeBorderColor, #444);\n                cursor: pointer;\n                background: rgba(0, 0, 0, 0.2);\n            }\n\n            .mazemaster-bb-image-item:hover {\n                border-color: var(--SmartThemeQuoteColor, #888);\n            }\n\n            .mazemaster-bb-image-item img {\n                width: 100%;\n                height: 80px;\n                object-fit: cover;\n            }\n\n            .mazemaster-bb-image-item .bb-image-index {\n                position: absolute;\n                top: 2px;\n                left: 2px;\n                background: rgba(0, 0, 0, 0.7);\n                color: white;\n                font-size: 0.7em;\n                padding: 2px 5px;\n                border-radius: 3px;\n            }\n\n            .mazemaster-bb-image-item .bb-image-message {\n                padding: 4px 6px;\n                font-size: 0.7em;\n                color: var(--SmartThemeBodyColor, #aaa);\n                text-align: center;\n                overflow: hidden;\n                text-overflow: ellipsis;\n                white-space: nowrap;\n                max-height: 20px;\n            }\n\n            .mazemaster-bb-image-item .bb-image-delete {\n                position: absolute;\n                top: 2px;\n                right: 2px;\n                background: rgba(231, 76, 60, 0.9);\n                color: white;\n                border: none;\n                width: 20px;\n                height: 20px;\n                border-radius: 50%;\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-size: 0.7em;\n            }\n\n            .mazemaster-bb-image-item .bb-image-delete:hover {\n                background: #c0392b;\n            }\n\n            /* Game Tab Styles */\n            .mazemaster-game-launch {\n                display: flex;\n                flex-direction: column;\n                gap: 15px;\n                padding: 10px 0;\n            }\n\n            .mazemaster-play-btn {\n                width: 100%;\n                padding: 15px 20px;\n                font-size: 1.2em;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 10px;\n            }\n\n            /* Maze Config Styles */\n            .mazemaster-textarea {\n                width: 100%;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 8px 10px;\n                color: var(--SmartThemeBodyColor, #fff);\n                font-family: monospace;\n                font-size: 0.9em;\n                min-height: 60px;\n                resize: vertical;\n            }\n\n            .mazemaster-maze-win-image-row {\n                display: flex;\n                gap: 10px;\n                align-items: flex-start;\n            }\n\n            .mazemaster-maze-win-image-preview {\n                width: 80px;\n                height: 80px;\n                border-radius: 5px;\n                border: 2px solid var(--SmartThemeBorderColor, #444);\n                overflow: hidden;\n                background: rgba(0, 0, 0, 0.2);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n            }\n\n            .mazemaster-maze-win-image-preview img {\n                width: 100%;\n                height: 100%;\n                object-fit: cover;\n            }\n\n            .mazemaster-maze-win-image-preview .no-image {\n                font-size: 0.7em;\n                opacity: 0.5;\n                text-align: center;\n            }\n\n            /* Maze Subsection Styles */\n            .mazemaster-subsection {\n                background: rgba(0, 0, 0, 0.15);\n                border-left: 3px solid var(--SmartThemeQuoteColor, #666);\n                padding: 10px;\n                margin: 10px 0;\n                border-radius: 0 5px 5px 0;\n            }\n\n            /* Encounters List Styles */\n            .mazemaster-encounters-list {\n                display: flex;\n                flex-direction: column;\n                gap: 8px;\n                margin-bottom: 10px;\n            }\n\n            .mazemaster-encounter-row {\n                display: flex;\n                gap: 8px;\n                align-items: center;\n            }\n\n            .mazemaster-encounter-row select {\n                flex: 1;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 6px 8px;\n                color: var(--SmartThemeBodyColor);\n            }\n\n            .mazemaster-encounter-row input[type="number"] {\n                width: 60px;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 6px 8px;\n                color: var(--SmartThemeBodyColor);\n                text-align: center;\n            }\n\n            .mazemaster-encounter-row .encounter-remove-btn {\n                padding: 5px 8px;\n            }\n\n            /* Maze Cell Minion Indicators */\n            .maze-cell.has-minion:not(.hidden)::before {\n                content: \'?\';\n                position: absolute;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                font-size: 0.7em;\n                color: #f39c12;\n                font-weight: bold;\n                z-index: 1;\n            }\n\n            .maze-cell.minion-triggered:not(.hidden)::before {\n                content: \'\\2713\';\n                color: #27ae60;\n            }\n\n            /* Moving Minion Indicators */\n            .maze-cell.minion-moving:not(.hidden):not(.minion-triggered)::before {\n                animation: minion-move-pulse 0.8s ease-in-out infinite;\n            }\n\n            .maze-cell.minion-chase:not(.hidden):not(.minion-triggered)::before {\n                content: \'\\f06d\';\n                font-family: \'Font Awesome 6 Free\';\n                font-weight: 900;\n                color: #e74c3c;\n            }\n\n            .maze-cell.minion-patrol:not(.hidden):not(.minion-triggered)::before {\n                content: \'\\f554\';\n                font-family: \'Font Awesome 6 Free\';\n                font-weight: 900;\n                color: #9b59b6;\n            }\n\n            @keyframes minion-move-pulse {\n                0%, 100% {\n                    transform: translate(-50%, -50%) scale(1);\n                    opacity: 1;\n                }\n                50% {\n                    transform: translate(-50%, -50%) scale(1.15);\n                    opacity: 0.8;\n                }\n            }\n\n            /* Maze Cell Chest Indicators */\n            .maze-cell.has-chest:not(.hidden)::before {\n                content: \'\\f187\';\n                font-family: \'Font Awesome 6 Free\';\n                font-weight: 900;\n                position: absolute;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                font-size: 0.6em;\n                color: #f39c12;\n                z-index: 1;\n            }\n\n            .maze-cell.chest-locked:not(.hidden)::before {\n                color: #95a5a6;\n            }\n\n            .maze-cell.chest-opened:not(.hidden)::before {\n                color: #666;\n                opacity: 0.5;\n            }\n\n            /* Hide default icon when custom chest image is used */\n            .maze-cell.has-custom-chest::before {\n                display: none !important;\n            }\n\n            /* Maze Cell Trap Indicators */\n            .maze-cell.has-trap:not(.hidden)::before {\n                content: \'\\f6e2\';\n                font-family: \'Font Awesome 6 Free\';\n                font-weight: 900;\n                position: absolute;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                font-size: 0.6em;\n                color: #e74c3c;\n                z-index: 1;\n            }\n\n            .maze-cell.trap-triggered:not(.hidden)::before {\n                color: #666;\n                opacity: 0.5;\n            }\n\n            /* Safe Room Indicators */\n            .maze-cell.safe-room:not(.hidden) {\n                background: radial-gradient(circle, rgba(45, 212, 191, 0.4), transparent 70%);\n            }\n\n            .maze-cell.safe-room:not(.hidden)::before {\n                content: \'\\f004\';\n                font-family: \'Font Awesome 6 Free\';\n                font-weight: 900;\n                position: absolute;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                font-size: 0.6em;\n                color: #2dd4bf;\n                z-index: 1;\n                animation: saferoom-pulse 2s ease-in-out infinite;\n                text-shadow: 0 0 8px rgba(45, 212, 191, 0.8);\n            }\n\n            @keyframes saferoom-pulse {\n                0%, 100% { opacity: 0.7; transform: translate(-50%, -50%) scale(1); }\n                50% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }\n            }\n\n            /* Portal Indicators */\n            .maze-cell.has-portal:not(.hidden)::before {\n                content: \'\\f111\';\n                font-family: \'Font Awesome 6 Free\';\n                font-weight: 900;\n                position: absolute;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                font-size: 0.7em;\n                color: var(--portal-color, #9b59b6);\n                z-index: 1;\n                animation: portal-pulse 1.2s ease-in-out infinite;\n                text-shadow: 0 0 8px var(--portal-color, #9b59b6);\n            }\n\n            .maze-cell.portal-exit-only:not(.hidden)::before {\n                opacity: 0.5;\n                animation: none;\n            }\n\n            .maze-cell.portal-flash {\n                animation: teleport-flash 0.3s ease-out;\n            }\n\n            @keyframes portal-pulse {\n                0%, 100% {\n                    opacity: 0.7;\n                    transform: translate(-50%, -50%) scale(1);\n                }\n                50% {\n                    opacity: 1;\n                    transform: translate(-50%, -50%) scale(1.2);\n                }\n            }\n\n            @keyframes teleport-flash {\n                0% {\n                    background: rgba(155, 89, 182, 0.8);\n                    box-shadow: 0 0 20px rgba(155, 89, 182, 0.8);\n                }\n                100% {\n                    background: rgba(0, 0, 0, 0.4);\n                    box-shadow: none;\n                }\n            }\n\n            /* Staircase Indicators (v1.2.0) */\n            .maze-cell.has-staircase:not(.hidden)::before {\n                content: \'\\f54b\';\n                font-family: \'Font Awesome 6 Free\';\n                font-weight: 900;\n                position: absolute;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                font-size: 0.8em;\n                color: #3498db;\n                z-index: 1;\n                text-shadow: 0 0 4px rgba(52, 152, 219, 0.6);\n            }\n\n            .maze-cell.staircase-up:not(.hidden)::before {\n                content: \'\\f148\';\n                color: #27ae60;\n                text-shadow: 0 0 4px rgba(39, 174, 96, 0.6);\n            }\n\n            .maze-cell.staircase-down:not(.hidden)::before {\n                content: \'\\f149\';\n                color: #e67e22;\n                text-shadow: 0 0 4px rgba(230, 126, 34, 0.6);\n            }\n\n            .maze-cell.staircase-locked:not(.hidden)::after {\n                content: \'\\f023\';\n                font-family: \'Font Awesome 6 Free\';\n                font-weight: 900;\n                position: absolute;\n                top: 2px;\n                right: 2px;\n                font-size: 0.45em;\n                color: #e74c3c;\n                z-index: 2;\n            }\n\n            /* Inventory Display */\n            .mazemaster-maze-inventory {\n                display: flex;\n                justify-content: center;\n                gap: 12px;\n                padding: 6px 12px;\n                background: rgba(0, 0, 0, 0.4);\n                border-radius: 6px;\n                margin-bottom: 8px;\n            }\n\n            .inventory-item {\n                display: flex;\n                align-items: center;\n                gap: 4px;\n                font-size: 0.85em;\n                color: #fff;\n            }\n\n            .inventory-item i { font-size: 0.9em; }\n            .inventory-item i.fa-key { color: #f1c40f; }\n            .inventory-item i.fa-user-ninja { color: #9b59b6; }\n            .inventory-item i.fa-bolt { color: #e74c3c; }\n            .inventory-item.execute i.fa-star { color: #ffd700; text-shadow: 0 0 5px #ffd700; }\n            .inventory-item.execute { font-weight: bold; }\n\n            /* Encounter Confirmation Buttons */\n            .maze-confirm-buttons {\n                margin-top: 8px;\n                display: flex;\n                gap: 8px;\n                justify-content: center;\n            }\n\n            .maze-confirm-btn {\n                padding: 8px 16px;\n                font-size: 0.9em;\n                font-weight: bold;\n                border-radius: 6px;\n                background: linear-gradient(to bottom, #3498db, #2980b9);\n                color: #fff;\n                border: 2px solid #5dade2;\n                box-shadow: 0 2px 8px rgba(52, 152, 219, 0.4);\n                transition: all 0.2s;\n            }\n\n            .maze-confirm-btn:hover {\n                background: linear-gradient(to bottom, #5dade2, #3498db);\n                transform: scale(1.05);\n                box-shadow: 0 4px 12px rgba(52, 152, 219, 0.6);\n            }\n\n            .maze-slip-btn {\n                background: linear-gradient(to bottom, #9b59b6, #8e44ad);\n                border-color: #bb8fce;\n                box-shadow: 0 2px 8px rgba(155, 89, 182, 0.4);\n            }\n\n            .maze-slip-btn:hover {\n                background: linear-gradient(to bottom, #bb8fce, #9b59b6);\n                box-shadow: 0 4px 12px rgba(155, 89, 182, 0.6);\n            }\n\n            .maze-accept-btn {\n                background: linear-gradient(to bottom, #27ae60, #1e8449);\n                border-color: #58d68d;\n                box-shadow: 0 2px 8px rgba(39, 174, 96, 0.4);\n            }\n\n            .maze-accept-btn:hover {\n                background: linear-gradient(to bottom, #58d68d, #27ae60);\n                box-shadow: 0 4px 12px rgba(39, 174, 96, 0.6);\n            }\n\n            /* Battlebar Action Buttons */\n            .mazemaster-bb-action-buttons {\n                display: flex;\n                gap: 10px;\n                justify-content: center;\n                flex-wrap: wrap;\n                width: 100%;\n                max-width: 400px;\n            }\n\n            .mazemaster-bb-strike-btn,\n            .mazemaster-bb-execute-btn {\n                flex: 1;\n                min-width: 120px;\n                max-width: 180px;\n                padding: 12px 15px;\n                font-size: 1em;\n                border-radius: 10px;\n                cursor: pointer;\n                font-weight: bold;\n                border: none;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 8px;\n                transition: transform 0.1s, box-shadow 0.1s;\n            }\n\n            .mazemaster-bb-strike-btn {\n                background: linear-gradient(to bottom, #e74c3c, #c0392b);\n                color: #fff;\n                box-shadow: 0 4px 10px rgba(231, 76, 60, 0.3);\n            }\n\n            .mazemaster-bb-strike-btn:hover {\n                background: linear-gradient(to bottom, #c0392b, #a93226);\n                transform: scale(1.02);\n            }\n\n            .mazemaster-bb-execute-btn {\n                background: linear-gradient(135deg, #ffd700, #ffaa00);\n                color: #000;\n                text-shadow: 0 1px 0 rgba(255,255,255,0.5);\n                box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);\n            }\n\n            .mazemaster-bb-execute-btn:hover {\n                background: linear-gradient(135deg, #ffea00, #ffc400);\n                box-shadow: 0 4px 20px rgba(255, 215, 0, 0.6);\n                transform: scale(1.02);\n            }\n\n            /* Encounter Percent Label */\n            .encounter-percent-label {\n                font-size: 0.9em;\n                color: #888;\n            }\n\n            .encounter-percent-input {\n                width: 50px;\n            }\n\n            /* Small input for config rows */\n            .mazemaster-input-small {\n                width: 60px;\n                padding: 4px 8px;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                color: var(--SmartThemeBodyColor);\n            }\n\n            /* Grid layout for config rows */\n            .mazemaster-row {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                margin-bottom: 6px;\n            }\n\n            .mazemaster-row label {\n                min-width: 90px;\n                font-size: 0.85em;\n                color: var(--SmartThemeBodyColor);\n                opacity: 0.9;\n            }\n\n            /* Two-column grid for percentage fields */\n            .mazemaster-grid-2col {\n                display: grid;\n                grid-template-columns: 1fr 1fr;\n                gap: 8px 16px;\n            }\n\n            .mazemaster-grid-2col .mazemaster-row {\n                margin-bottom: 0;\n            }\n\n            .mazemaster-grid-2col .mazemaster-row label {\n                min-width: 80px;\n            }\n\n            /* Three-column grid for loot percentages */\n            .mazemaster-grid-3col {\n                display: grid;\n                grid-template-columns: repeat(3, 1fr);\n                gap: 8px;\n            }\n\n            .mazemaster-grid-3col .mazemaster-row {\n                flex-direction: column;\n                align-items: flex-start;\n                gap: 4px;\n                margin-bottom: 0;\n            }\n\n            .mazemaster-grid-3col .mazemaster-row label {\n                min-width: auto;\n                font-size: 0.8em;\n                opacity: 0.8;\n            }\n\n            .mazemaster-grid-3col .mazemaster-input-small {\n                width: 100%;\n            }\n\n            /* 4-column grid */\n            .mazemaster-grid-4col {\n                display: grid;\n                grid-template-columns: repeat(4, 1fr);\n                gap: 8px;\n            }\n\n            .mazemaster-grid-4col .mazemaster-row {\n                flex-direction: column;\n                align-items: flex-start;\n                gap: 2px;\n                margin-bottom: 0;\n            }\n\n            .mazemaster-grid-4col .mazemaster-row label {\n                min-width: auto;\n                font-size: 0.75em;\n                opacity: 0.8;\n            }\n\n            .mazemaster-grid-4col .mazemaster-input-small {\n                width: 100%;\n            }\n\n            /* 5-column grid (for Find Early checkboxes) */\n            .mazemaster-grid-5col {\n                display: grid;\n                grid-template-columns: repeat(5, 1fr);\n                gap: 6px;\n            }\n\n            .mazemaster-checkbox-label {\n                display: flex;\n                align-items: center;\n                gap: 4px;\n                font-size: 0.8em;\n                padding: 4px 6px;\n                background: rgba(0, 0, 0, 0.15);\n                border-radius: 4px;\n                cursor: pointer;\n                transition: background 0.2s;\n            }\n\n            .mazemaster-checkbox-label:hover {\n                background: rgba(0, 0, 0, 0.25);\n            }\n\n            .mazemaster-checkbox-label input[type="checkbox"] {\n                margin: 0;\n            }\n\n            /* Collapsible Sections */\n            .mazemaster-collapsible {\n                margin-bottom: 8px;\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 6px;\n                overflow: hidden;\n            }\n\n            .mazemaster-collapsible-header {\n                width: 100%;\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                padding: 10px 12px;\n                background: rgba(0, 0, 0, 0.2);\n                border: none;\n                cursor: pointer;\n                text-align: left;\n                font-size: 0.95em;\n                font-weight: 500;\n                color: inherit;\n                transition: background 0.2s;\n            }\n\n            .mazemaster-collapsible-header:hover {\n                background: rgba(0, 0, 0, 0.3);\n            }\n\n            .mazemaster-collapse-icon {\n                font-size: 0.8em;\n                transition: transform 0.2s;\n            }\n\n            .mazemaster-collapsible.expanded .mazemaster-collapse-icon {\n                transform: rotate(90deg);\n            }\n\n            .mazemaster-collapse-hint {\n                font-size: 0.8em;\n                opacity: 0.6;\n                margin-left: auto;\n            }\n\n            .mazemaster-collapsible-content {\n                padding: 12px;\n                border-top: 1px solid var(--SmartThemeBorderColor, #444);\n                background: rgba(0, 0, 0, 0.1);\n            }\n\n            .mazemaster-collapsible-content .mazemaster-section:last-child {\n                margin-bottom: 0;\n            }\n\n            /* Portal Config List */\n            .mazemaster-portals-list {\n                display: flex;\n                flex-direction: column;\n                gap: 8px;\n                margin-bottom: 10px;\n            }\n\n            .mazemaster-portal-item {\n                background: rgba(0, 0, 0, 0.2);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 6px;\n                overflow: hidden;\n            }\n\n            .mazemaster-portal-item .portal-header {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                padding: 8px 10px;\n                background: rgba(0, 0, 0, 0.2);\n                border-bottom: 1px solid var(--SmartThemeBorderColor, #444);\n            }\n\n            .mazemaster-portal-item .portal-color {\n                width: 16px;\n                height: 16px;\n                border-radius: 50%;\n                flex-shrink: 0;\n            }\n\n            .mazemaster-portal-item .portal-name {\n                flex: 1;\n                font-weight: 500;\n            }\n\n            .mazemaster-portal-item .portal-details {\n                padding: 10px;\n                display: flex;\n                flex-direction: column;\n                gap: 6px;\n            }\n\n            .mazemaster-portal-item .portal-row {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n            }\n\n            .mazemaster-portal-item .portal-row label {\n                width: 90px;\n                font-size: 0.85em;\n                color: var(--SmartThemeBodyColor, #ccc);\n            }\n\n            .mazemaster-portal-item .portal-row input[type="text"],\n            .mazemaster-portal-item .portal-row input[type="number"] {\n                flex: 1;\n                max-width: 80px;\n            }\n\n            .mazemaster-portal-item .coords-row {\n                gap: 4px;\n            }\n\n            .mazemaster-portal-item .coords-row span {\n                font-size: 0.8em;\n                color: var(--SmartThemeBodyColor, #999);\n            }\n\n            .mazemaster-portal-item .coords-row input {\n                width: 50px !important;\n                max-width: 50px !important;\n            }\n\n            .mazemaster-portal-item .portal-color-input {\n                width: 32px;\n                height: 24px;\n                padding: 0;\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                cursor: pointer;\n            }\n\n            .mazemaster-portal-item .remove-portal-btn {\n                padding: 4px 8px;\n                font-size: 0.8em;\n            }\n\n            /* Objectives Config List */\n            .mazemaster-objectives-list {\n                display: flex;\n                flex-direction: column;\n                gap: 8px;\n                margin-bottom: 10px;\n            }\n\n            .mazemaster-objective-item {\n                background: rgba(0, 0, 0, 0.2);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 6px;\n                overflow: hidden;\n            }\n\n            .mazemaster-objective-item .objective-config-header {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                padding: 8px 10px;\n                background: rgba(0, 0, 0, 0.2);\n                border-bottom: 1px solid var(--SmartThemeBorderColor, #444);\n            }\n\n            .mazemaster-objective-item .objective-name {\n                flex: 1;\n                font-weight: 500;\n            }\n\n            .mazemaster-objective-item .objective-config-details {\n                padding: 10px;\n                display: flex;\n                flex-direction: column;\n                gap: 6px;\n            }\n\n            .mazemaster-objective-item .objective-config-row {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n            }\n\n            .mazemaster-objective-item .objective-config-row label {\n                width: 100px;\n                font-size: 0.85em;\n                color: var(--SmartThemeBodyColor, #ccc);\n            }\n\n            .mazemaster-objective-item .objective-config-row input[type="text"],\n            .mazemaster-objective-item .objective-config-row input[type="number"],\n            .mazemaster-objective-item .objective-config-row select {\n                flex: 1;\n            }\n\n            .mazemaster-objective-item .remove-objective-btn {\n                padding: 4px 8px;\n                font-size: 0.8em;\n            }\n\n            /* STScript Hooks Config */\n            .mazemaster-hooks-group {\n                margin-top: 12px;\n            }\n\n            .mazemaster-hooks-group:first-of-type {\n                margin-top: 8px;\n            }\n\n            .mazemaster-hooks-label {\n                display: block;\n                font-size: 0.85em;\n                font-weight: 500;\n                color: #3498db;\n                margin-bottom: 6px;\n                padding-bottom: 4px;\n                border-bottom: 1px solid rgba(52, 152, 219, 0.3);\n            }\n\n            .mazemaster-hooks-items {\n                display: flex;\n                flex-direction: column;\n                gap: 6px;\n            }\n\n            .mazemaster-hooks-items .hook-item {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n            }\n\n            .mazemaster-hooks-items .hook-item > label {\n                width: 120px;\n                flex-shrink: 0;\n                font-size: 0.85em;\n                color: var(--SmartThemeBodyColor, #ccc);\n            }\n\n            .mazemaster-hooks-items .hook-item input {\n                flex: 1;\n            }\n\n            /* Inline row */\n            .mazemaster-inline-row {\n                display: flex;\n                gap: 12px;\n            }\n\n            .mazemaster-flex-1 {\n                flex: 1;\n            }\n\n            /* Saved Games */\n            .mazemaster-saved-games-list {\n                display: flex;\n                flex-direction: column;\n                gap: 8px;\n            }\n\n            .mazemaster-saved-game {\n                display: flex;\n                justify-content: space-between;\n                align-items: center;\n                padding: 8px 12px;\n                background: rgba(0, 0, 0, 0.2);\n                border-radius: 4px;\n            }\n\n            .mazemaster-saved-game-info {\n                display: flex;\n                flex-direction: column;\n                gap: 2px;\n            }\n\n            .mazemaster-saved-game-name {\n                font-weight: 500;\n            }\n\n            .mazemaster-saved-game-details {\n                font-size: 0.8em;\n                opacity: 0.7;\n            }\n\n            .mazemaster-saved-game-actions {\n                display: flex;\n                gap: 6px;\n            }\n\n            .mazemaster-no-saves {\n                text-align: center;\n                opacity: 0.6;\n                padding: 12px;\n                font-style: italic;\n            }\n\n            /* Side-by-side sections */\n            .mazemaster-section-row {\n                display: grid;\n                grid-template-columns: 1fr 1fr;\n                gap: 16px;\n            }\n\n            .mazemaster-section-row .mazemaster-section {\n                margin-bottom: 0;\n            }\n\n            /* Minions Config Styles */\n            .mazemaster-minions-list {\n                display: flex;\n                flex-direction: column;\n                gap: 10px;\n                margin-bottom: 10px;\n            }\n\n            .mazemaster-minion-card {\n                display: flex;\n                gap: 10px;\n                align-items: center;\n                padding: 10px;\n                background: rgba(0, 0, 0, 0.2);\n                border-radius: 5px;\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n            }\n\n            .mazemaster-minion-card .minion-image {\n                width: 50px;\n                height: 50px;\n                border-radius: 5px;\n                overflow: hidden;\n                background: rgba(0, 0, 0, 0.3);\n                flex-shrink: 0;\n                position: relative;\n                cursor: pointer;\n            }\n\n            .mazemaster-minion-card .minion-image img {\n                width: 100%;\n                height: 100%;\n                object-fit: cover;\n            }\n\n            .mazemaster-minion-card .minion-image:hover {\n                outline: 2px solid var(--SmartThemeQuoteColor, #e74c3c);\n                outline-offset: 2px;\n            }\n\n            .mazemaster-minion-card .minion-image::after {\n                content: \'\\f030\';\n                font-family: \'Font Awesome 6 Free\';\n                font-weight: 900;\n                position: absolute;\n                bottom: 2px;\n                right: 2px;\n                font-size: 10px;\n                color: white;\n                background: rgba(0, 0, 0, 0.6);\n                padding: 2px 4px;\n                border-radius: 3px;\n                opacity: 0;\n                transition: opacity 0.2s;\n            }\n\n            .mazemaster-minion-card .minion-image:hover::after {\n                opacity: 1;\n            }\n\n            .mazemaster-minion-card .minion-info {\n                flex: 1;\n            }\n\n            .mazemaster-minion-card .minion-row {\n                display: flex;\n                gap: 8px;\n                margin-bottom: 8px;\n            }\n\n            .mazemaster-minion-card .minion-name-input {\n                flex: 1;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 6px 8px;\n                color: var(--SmartThemeBodyColor);\n            }\n\n            .mazemaster-minion-card .minion-type-select {\n                width: 110px;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 6px 8px;\n                color: var(--SmartThemeBodyColor);\n            }\n\n            .mazemaster-minion-card .minion-profiles {\n                margin-top: 8px;\n            }\n\n            .mazemaster-minion-card .minion-profiles label {\n                display: block;\n                font-size: 0.85em;\n                color: var(--SmartThemeQuoteColor);\n                margin-bottom: 4px;\n            }\n\n            .mazemaster-minion-card .minion-profiles select {\n                width: 100%;\n                min-height: 60px;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 4px;\n                color: var(--SmartThemeBodyColor);\n            }\n\n            .mazemaster-minion-card .minion-profiles textarea {\n                width: 100%;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 6px 8px;\n                color: var(--SmartThemeBodyColor);\n                resize: vertical;\n            }\n\n            .mazemaster-minion-card .merchant-range-row {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n            }\n\n            .mazemaster-minion-card .merchant-range-row span {\n                color: var(--SmartThemeBodyColor);\n                opacity: 0.8;\n            }\n\n            .mazemaster-minion-card .minion-encounter-script {\n                margin-top: 10px;\n                padding-top: 10px;\n                border-top: 1px solid var(--SmartThemeBorderColor, #333);\n            }\n\n            .mazemaster-minion-card .minion-encounter-script label {\n                display: block;\n                font-size: 0.85em;\n                color: var(--SmartThemeQuoteColor);\n                margin-bottom: 4px;\n            }\n\n            .mazemaster-minion-card .minion-encounter-script textarea {\n                width: 100%;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 6px 8px;\n                color: var(--SmartThemeBodyColor);\n                resize: vertical;\n                font-family: monospace;\n            }\n\n            .mazemaster-minion-card .minion-delete-btn {\n                padding: 5px 8px;\n                flex-shrink: 0;\n                align-self: flex-start;\n            }\n\n            /* Minion Movement Settings */\n            .mazemaster-minion-card .minion-movement-settings {\n                margin-top: 8px;\n                padding-top: 8px;\n                border-top: 1px solid var(--SmartThemeBorderColor, #444);\n            }\n\n            .mazemaster-minion-card .minion-movement-settings > label {\n                display: block;\n                font-size: 0.85em;\n                color: var(--SmartThemeBodyColor, #999);\n                margin-bottom: 4px;\n            }\n\n            .mazemaster-minion-card .movement-row {\n                display: flex;\n                gap: 8px;\n                margin-bottom: 6px;\n            }\n\n            .mazemaster-minion-card .minion-movement-type {\n                flex: 1;\n            }\n\n            .mazemaster-minion-card .movement-params {\n                display: flex;\n                gap: 12px;\n                flex-wrap: wrap;\n            }\n\n            .mazemaster-minion-card .movement-param {\n                display: flex;\n                align-items: center;\n                gap: 4px;\n                font-size: 0.85em;\n            }\n\n            .mazemaster-minion-card .movement-param span {\n                color: var(--SmartThemeBodyColor, #999);\n            }\n\n            .mazemaster-minion-card .movement-param input {\n                width: 50px;\n            }\n\n            /* TRAP CARD STYLES */\n            .mazemaster-traps-list {\n                display: flex;\n                flex-direction: column;\n                gap: 10px;\n                margin-bottom: 10px;\n                max-height: 400px;\n                overflow-y: auto;\n            }\n\n            .mazemaster-trap-card {\n                display: flex;\n                gap: 10px;\n                background: rgba(0, 0, 0, 0.2);\n                border-radius: 8px;\n                padding: 10px;\n                align-items: flex-start;\n            }\n\n            .mazemaster-trap-card .trap-image {\n                width: 80px;\n                height: 80px;\n                flex-shrink: 0;\n                border-radius: 6px;\n                overflow: hidden;\n                background: rgba(0, 0, 0, 0.3);\n                position: relative;\n                cursor: pointer;\n            }\n\n            .mazemaster-trap-card .trap-image img {\n                width: 100%;\n                height: 100%;\n                object-fit: cover;\n            }\n\n            .mazemaster-trap-card .trap-image:hover {\n                outline: 2px solid var(--SmartThemeQuoteColor, #e74c3c);\n                outline-offset: 2px;\n            }\n\n            .mazemaster-trap-card .trap-image::after {\n                content: \'\\f030\';\n                font-family: \'Font Awesome 6 Free\';\n                font-weight: 900;\n                position: absolute;\n                bottom: 4px;\n                right: 4px;\n                font-size: 12px;\n                color: white;\n                background: rgba(0, 0, 0, 0.6);\n                padding: 3px 5px;\n                border-radius: 3px;\n                opacity: 0;\n                transition: opacity 0.2s;\n            }\n\n            .mazemaster-trap-card .trap-image:hover::after {\n                opacity: 1;\n            }\n\n            .mazemaster-trap-card .trap-no-image {\n                width: 100%;\n                height: 100%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                color: var(--SmartThemeBodyColor);\n                opacity: 0.5;\n                font-size: 24px;\n            }\n\n            .mazemaster-trap-card .trap-info {\n                flex: 1;\n                display: flex;\n                flex-direction: column;\n                gap: 8px;\n            }\n\n            .mazemaster-trap-card .trap-row {\n                display: flex;\n                gap: 8px;\n            }\n\n            .mazemaster-trap-card .trap-name-input {\n                flex: 1;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 6px 8px;\n                color: var(--SmartThemeBodyColor);\n            }\n\n            .mazemaster-trap-card .trap-message-row,\n            .mazemaster-trap-card .trap-script-row {\n                display: flex;\n                flex-direction: column;\n                gap: 4px;\n            }\n\n            .mazemaster-trap-card .trap-message-row label,\n            .mazemaster-trap-card .trap-script-row label {\n                font-size: 0.75em;\n                opacity: 0.7;\n            }\n\n            .mazemaster-trap-card .trap-message-input,\n            .mazemaster-trap-card .trap-script-input {\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 6px 8px;\n                color: var(--SmartThemeBodyColor);\n                resize: vertical;\n                font-family: inherit;\n            }\n\n            .mazemaster-trap-card .trap-delete-btn {\n                padding: 5px 8px;\n                flex-shrink: 0;\n                align-self: flex-start;\n            }\n\n            /* Story Milestones Modal */\n            .mazemaster-story-modal {\n                position: fixed;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                background: rgba(0, 0, 0, 0.7);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                z-index: 10000;\n            }\n\n            .mazemaster-story-modal-content {\n                background: var(--SmartThemeBlurTintColor, #1a1a1a);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 10px;\n                padding: 20px;\n                width: 90%;\n                max-width: 600px;\n                max-height: 80vh;\n                overflow-y: auto;\n            }\n\n            .mazemaster-story-modal-content h3 {\n                margin: 0 0 15px 0;\n                display: flex;\n                align-items: center;\n                gap: 10px;\n            }\n\n            .mazemaster-story-textarea {\n                width: 100%;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 8px;\n                color: var(--SmartThemeBodyColor);\n                resize: vertical;\n                font-family: inherit;\n            }\n\n            .mazemaster-milestones-list {\n                display: flex;\n                flex-direction: column;\n                gap: 10px;\n                margin-bottom: 10px;\n                max-height: 200px;\n                overflow-y: auto;\n            }\n\n            .mazemaster-milestone-row {\n                display: flex;\n                gap: 10px;\n                align-items: flex-start;\n                background: rgba(0, 0, 0, 0.2);\n                padding: 10px;\n                border-radius: 6px;\n            }\n\n            .milestone-percent {\n                display: flex;\n                align-items: center;\n                gap: 4px;\n                flex-shrink: 0;\n            }\n\n            .milestone-percent-input {\n                width: 50px;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 6px;\n                color: var(--SmartThemeBodyColor);\n                text-align: center;\n            }\n\n            .milestone-text-input {\n                flex: 1;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 6px;\n                color: var(--SmartThemeBodyColor);\n                resize: vertical;\n                font-family: inherit;\n            }\n\n            .mazemaster-story-modal-buttons {\n                display: flex;\n                gap: 10px;\n                justify-content: flex-end;\n                margin-top: 15px;\n            }\n        </style>\n    ')}function xo(){var e;const t=document.getElementById("mazemaster_segments_list");if(!t)return;const n=et(null===(e=document.getElementById("mazemaster_profile_select"))||void 0===e?void 0:e.value),a=(null==n?void 0:n.segments)||[];0!==a.length?(t.innerHTML=a.map(((e,t)=>'\n        <div class="mazemaster-segment-item" data-index="'.concat(t,'">\n            <div class="mazemaster-segment-row">\n                <div class="mazemaster-segment-field small">\n                    <label>Trigger</label>\n                    <input type="text" class="seg-trigger" value="').concat(_o(e.trigger||""),'" placeholder="com1">\n                </div>\n                <div class="mazemaster-segment-field">\n                    <label>Display Text</label>\n                    <input type="text" class="seg-text" value="').concat(_o(e.text||""),'" placeholder="Prize name">\n                </div>\n                <div class="mazemaster-segment-field small">\n                    <label>Size</label>\n                    <select class="seg-size">\n                        ').concat(y.map((t=>'<option value="'.concat(t,'" ').concat(e.size===t?"selected":"",">").concat(t,"</option>"))).join(""),'\n                    </select>\n                </div>\n                <button class="menu_button menu_button_icon mazemaster-segment-delete" title="Delete">\n                    <i class="fa-solid fa-trash"></i>\n                </button>\n            </div>\n            <div class="mazemaster-segment-row">\n                <div class="mazemaster-segment-field">\n                    <label>STScript Command</label>\n                    <textarea class="seg-command" placeholder="/echo You won!">').concat(_o(e.command||""),'</textarea>\n                </div>\n                <div class="mazemaster-segment-field tiny">\n                    <label>&nbsp;</label>\n                    <label class="mazemaster-segment-checkbox">\n                        <input type="checkbox" class="seg-respin" ').concat(e.respin?"checked":"",">\n                        Respin\n                    </label>\n                </div>\n            </div>\n        </div>\n    "))).join(""),t.querySelectorAll(".mazemaster-segment-delete").forEach((e=>{e.addEventListener("click",(e=>{e.target.closest(".mazemaster-segment-item").remove()}))}))):t.innerHTML='<div class="mazemaster-empty-state">No segments. Click "Add Segment" to create one.</div>'}function _o(e){const t=document.createElement("div");return t.textContent=e||"",t.innerHTML}function wo(){var e;const t=document.getElementById("mazemaster_bb_images_list");if(!t)return;const n=null===(e=document.getElementById("mazemaster_bb_profile_select"))||void 0===e?void 0:e.value;if(!n)return void(t.innerHTML='<div class="mazemaster-empty-state">Select or create a profile first.</div>');const a=(nt(n)||{}).images||[];0!==a.length?(t.innerHTML=a.map(((e,t)=>'\n        <div class="mazemaster-bb-image-item" data-index="'.concat(t,'" title="Click to edit stage message">\n            <img src="/').concat(e.path,'" alt="').concat(_o(e.stageMessage||""),'">\n            <span class="bb-image-index">').concat(t,'</span>\n            <div class="bb-image-message">').concat(_o(e.stageMessage||"(no message)"),'</div>\n            <button class="bb-image-delete" title="Delete">\n                <i class="fa-solid fa-times"></i>\n            </button>\n        </div>\n    '))).join(""),t.querySelectorAll(".mazemaster-bb-image-item").forEach((e=>{e.addEventListener("click",(async t=>{var a;if(t.target.closest(".bb-image-delete"))return;const o=parseInt(e.dataset.index),i=nt(n)||{},s=i.images||[],r=(null===(a=s[o])||void 0===a?void 0:a.stageMessage)||"",l=await p("Stage ".concat(o," Message:"),u.INPUT,r);null!=l&&(s[o].stageMessage=l,at(n,i),wo())}))})),t.querySelectorAll(".bb-image-delete").forEach((e=>{e.addEventListener("click",(async e=>{e.stopPropagation();const t=e.target.closest(".mazemaster-bb-image-item"),a=parseInt(t.dataset.index);if(!await p("Delete stage ".concat(a,"?"),u.CONFIRM))return;const o=nt(n)||{};o.images=(o.images||[]).filter(((e,t)=>t!==a)),at(n,o),wo()}))}))):t.innerHTML='<div class="mazemaster-empty-state">No stages. Add images to create stages.</div>'}function ko(){var e,t,n,a,o,s,r,l,c,d;const m=null===(e=document.getElementById("mazemaster_maze_profile_select"))||void 0===e?void 0:e.value,p=wt(m)||{},u=document.getElementById("mazemaster_maze_size");u&&(u.value=p.gridSize||10);const h=document.getElementById("mazemaster_maze_floors");h&&(h.value=p.floors||1);const g=document.getElementById("mazemaster_maze_difficulty");g&&(g.value=p.difficulty||"normal");const f=document.getElementById("mazemaster_maze_theme");f&&(f.value=p.theme||"fantasy");const v=document.getElementById("mazemaster_maze_mapstyle");v&&(v.value=p.mapStyle||"maze");const b=document.getElementById("mazemaster_maze_win_cmd");b&&(b.value=p.winCommand||"");const y=document.getElementById("mazemaster_maze_lose_cmd");y&&(y.value=p.loseCommand||"");const z=document.getElementById("mazemaster_maze_win_message");z&&(z.value=p.winMessage||"");const x=document.getElementById("mazemaster_maze_main_minion");if(x){const e=Ct();x.innerHTML='<option value="">None</option>'+e.map((e=>{const t=St(e);return'<option value="'.concat(_o(e),'" ').concat(p.mainMinion===e?"selected":"",">").concat(_o((null==t?void 0:t.name)||e),"</option>")})).join("")}const _=document.getElementById("mazemaster_main_minion_settings");_&&(_.style.display=p.mainMinion?"block":"none");const w=document.getElementById("mazemaster_maze_intro_message");w&&(w.value=p.mainMinionIntroMessage||"");const k=document.getElementById("mazemaster_maze_random_chance");k&&(k.value=p.mainMinionRandomChance||15);const C=document.getElementById("mazemaster_maze_random_messages");C&&(C.value=(p.mainMinionRandomMessages||[]).join("\n"));const S=document.getElementById("mazemaster_maze_exit_type");S&&(S.value=p.mainMinionExitType||"messenger"),Co(p.mainMinionExitType||"messenger",p.mainMinionExitProfile);const M=document.getElementById("mazemaster_maze_loss_action");M&&(M.value=p.onBattlebarLoss||"continue");const E=document.querySelector(".mazemaster-maze-win-image-preview");E&&(p.winImage?E.innerHTML='<img id="maze_win_image_preview" src="'.concat(p.winImage,'" alt="Victory">'):E.innerHTML='<div id="maze_win_image_preview" class="no-image">No image</div>');const P=document.getElementById("mazemaster_maze_chest_percent");P&&(P.value=p.chestTilePercent||10);const I=document.getElementById("mazemaster_maze_locked_percent");I&&(I.value=p.chestLockedPercent||30);const T=document.getElementById("mazemaster_maze_locked_bonus");T&&(T.value=p.chestLockedBonusPercent||50);const B=document.getElementById("mazemaster_maze_mimic_percent");B&&(B.value=p.chestMimicPercent||15);const D=document.getElementById("mazemaster_maze_loot_min");D&&(D.value=p.chestLootMin||1);const L=document.getElementById("mazemaster_maze_loot_max");L&&(L.value=p.chestLootMax||2);const R=document.getElementById("mazemaster_maze_chest_key");R&&(R.value=p.chestKeyChance||30);const A=document.getElementById("mazemaster_maze_chest_pow");A&&(A.value=p.chestStrikeChance||50);const O=document.getElementById("mazemaster_maze_chest_stealth");O&&(O.value=p.chestStealthChance||0);const H=document.getElementById("mazemaster_maze_chest_execute");H&&(H.value=p.chestExecuteChance||0);const N=document.getElementById("mazemaster_maze_locked_key");N&&(N.value=p.lockedChestKeyChance||40);const q=document.getElementById("mazemaster_maze_locked_pow");q&&(q.value=p.lockedChestStrikeChance||60);const F=document.getElementById("mazemaster_maze_locked_stealth");F&&(F.value=p.lockedChestStealthChance||30);const j=document.getElementById("mazemaster_maze_locked_execute");j&&(j.value=p.lockedChestExecuteChance||5);let W=p.startingInventory||{};!(W.key||W.stealth||W.strike||W.execute)&&null!==(t=Le[m])&&void 0!==t&&t.startingInventory&&(W=Le[m].startingInventory,p.startingInventory=JSON.parse(JSON.stringify(W)),i());const Y=document.getElementById("mazemaster_start_key");Y&&(Y.value=W.key||0);const G=document.getElementById("mazemaster_start_stealth");G&&(G.value=W.stealth||0);const U=document.getElementById("mazemaster_start_pow");U&&(U.value=W.strike||0);const K=document.getElementById("mazemaster_start_execute");K&&(K.value=W.execute||0);const V=document.getElementById("mazemaster_hp_enabled");V&&(V.checked=!1!==p.hpEnabled);const X=document.getElementById("mazemaster_hp_max");X&&(X.value=p.maxHP||100);const J=document.getElementById("mazemaster_hp_battlebar_mult");J&&(J.value=null!==(n=p.battlebarDamageMultiplier)&&void 0!==n?n:1);const Q=document.getElementById("mazemaster_hp_battlebar_diff");Q&&(Q.value=null!==(a=p.battlebarDifficultyMultiplier)&&void 0!==a?a:1);const Z=document.getElementById("mazemaster_hp_respawn");Z&&(Z.value=p.respawnHPPercent||50);const $=document.getElementById("mazemaster_hp_ondeath");$&&($.value=p.onDeath||"respawn");const ee=document.getElementById("mazemaster_safe_room_count");ee&&(ee.value=null!==(o=p.safeRoomCount)&&void 0!==o?o:3);const te=document.getElementById("mazemaster_safe_room_heal");te&&(te.value=null!==(s=p.safeRoomHealPercent)&&void 0!==s?s:100);const ne=document.getElementById("mazemaster_safe_room_llm");ne&&(ne.checked=p.safeRoomUseLLM||!1);const ae=document.getElementById("mazemaster_llm_enhance_rooms");ae&&(ae.checked=!1!==p.llmEnhanceRooms);const oe=document.getElementById("mazemaster_rest_enabled");oe&&(oe.checked=!1!==p.restEnabled);const ie=document.getElementById("mazemaster_rest_heal");ie&&(ie.value=p.restHealPercent||20);const se=document.getElementById("mazemaster_rest_cooldown");se&&(se.value=null!==(r=p.restCooldown)&&void 0!==r?r:3);const re=document.getElementById("mazemaster_rest_interrupt");re&&(re.value=null!==(l=p.restInterruptChance)&&void 0!==l?l:15);const le=p.mapVisibility||"fogOfWar",ce=document.querySelector('input[name="mazemaster_map_visibility"][value="'.concat(le,'"]'));ce&&(ce.checked=!0);let de=p.minionEncounters||[],me=p.trapEncounters||[];0===de.length&&null!==(c=Le[m])&&void 0!==c&&c.minionEncounters&&(de=Le[m].minionEncounters,p.minionEncounters=JSON.parse(JSON.stringify(de)),i()),0===me.length&&null!==(d=Le[m])&&void 0!==d&&d.trapEncounters&&(me=Le[m].trapEncounters,p.trapEncounters=JSON.parse(JSON.stringify(me)),i()),function(e){const t=document.getElementById("mazemaster_maze_encounters_list");if(!t)return;const n=Ct();if(0===e.length)return void(t.innerHTML='<div class="mazemaster-empty-state" style="font-size: 0.85em;">No encounters. Minions will be randomly placed in the maze.</div>');t.innerHTML=e.map(((e,t)=>{St(e.minionId);return'\n            <div class="mazemaster-encounter-row" data-index="'.concat(t,'">\n                <select class="encounter-minion-select">\n                    ').concat(n.map((t=>{const n=St(t);return'<option value="'.concat(_o(t),'" ').concat(e.minionId===t?"selected":"",">").concat(_o((null==n?void 0:n.name)||t),"</option>")})).join(""),'\n                </select>\n                <input type="number" class="encounter-percent-input" min="1" max="100" value="').concat(e.percent||5,'" placeholder="%">\n                <span class="encounter-percent-label">%</span>\n                <button class="menu_button menu_button_icon encounter-remove-btn" title="Remove">\n                    <i class="fa-solid fa-trash"></i>\n                </button>\n            </div>\n        ')})).join(""),t.querySelectorAll(".mazemaster-encounter-row").forEach((e=>{var t,n,a;parseInt(e.dataset.index);null===(t=e.querySelector(".encounter-minion-select"))||void 0===t||t.addEventListener("change",(()=>{})),null===(n=e.querySelector(".encounter-percent-input"))||void 0===n||n.addEventListener("change",(()=>{})),null===(a=e.querySelector(".encounter-remove-btn"))||void 0===a||a.addEventListener("click",(()=>{e.remove()}))}))}(de),function(e){const t=document.getElementById("mazemaster_maze_traps_list");if(!t)return;const n=Et();if(0===e.length)return void(t.innerHTML='<div class="mazemaster-empty-state" style="font-size: 0.85em;">No traps. Add traps to place trap tiles in the maze.</div>');t.innerHTML=e.map(((e,t)=>{Pt(e.trapId);return'\n            <div class="mazemaster-encounter-row mazemaster-trap-encounter-row" data-index="'.concat(t,'">\n                <select class="trap-encounter-select">\n                    ').concat(n.map((t=>{const n=Pt(t);return'<option value="'.concat(_o(t),'" ').concat(e.trapId===t?"selected":"",">").concat(_o((null==n?void 0:n.name)||t),"</option>")})).join(""),'\n                </select>\n                <input type="number" class="trap-encounter-percent-input" min="1" max="100" value="').concat(e.percent||5,'" placeholder="%">\n                <span class="encounter-percent-label">%</span>\n                <button class="menu_button menu_button_icon trap-encounter-remove-btn" title="Remove">\n                    <i class="fa-solid fa-trash"></i>\n                </button>\n            </div>\n        ')})).join(""),t.querySelectorAll(".mazemaster-trap-encounter-row").forEach((e=>{var t;null===(t=e.querySelector(".trap-encounter-remove-btn"))||void 0===t||t.addEventListener("click",(()=>{e.remove()}))}))}(me);const pe=p.findEarly||{},ue=document.getElementById("mazemaster_findearly_radius");ue&&(ue.value=pe.radius||4);const he=document.getElementById("mazemaster_findearly_perchest");he&&(he.value=pe.itemsPerChest||1);const ge=pe.items||[],fe=["torch","lantern","mapFragment","healingPotion","greaterHealing","revealScroll","sightPotion","key","strike","stealth"];for(const e of fe){const t=document.getElementById("mazemaster_findearly_".concat(e));t&&(t.checked=ge.includes(e))}}function Co(e,t){const n=document.getElementById("mazemaster_exit_profile_section"),a=document.getElementById("mazemaster_maze_exit_profile");if(!n||!a)return;if("messenger"===e)return void(n.style.display="none");n.style.display="block";let o=[];switch(e){case"battlebar":o=tt(),0===o.length&&(o=Object.keys(xe));break;case"prizewheel":o=$e(),0===o.length&&(o=Object.keys(ze));break;case"turnbased":o=ot(),0===o.length&&(o=Object.keys(_e));break;case"qte":o=rt(),0===o.length&&(o=Object.keys(we));break;case"dice":o=dt(),0===o.length&&(o=Object.keys(ke));break;case"stealth":o=ut(),0===o.length&&(o=Object.keys(Ce));break;case"puzzle":o=ft(),0===o.length&&(o=Object.keys(Se));break;case"negotiation":o=yt(),0===o.length&&(o=Object.keys(Me))}a.innerHTML='<option value="">Select...</option>'+o.map((e=>'<option value="'.concat(_o(e),'" ').concat(e===t?"selected":"",">").concat(_o(e),"</option>"))).join("")}function So(){var e,t,n,a,o,i,s,r,l,c,d,m,p,u,h,g,f,v,b,y,z,x,_,w,k,C,S,M,E,P,I,T,B,D,L,R,A,O,H,N,q,F,j,W,Y,G,U,K,V,X,J,Q,Z,$,ee,te,ne,ae,oe,ie,se,re,le,ce,de,me,pe,ue,he,ge,fe,ve,be,ye,ze,xe,_e;const we=wt(null===(e=document.getElementById("mazemaster_maze_profile_select"))||void 0===e?void 0:e.value)||{},ke=document.querySelectorAll("#mazemaster_maze_encounters_list .mazemaster-encounter-row"),Ce=[];ke.forEach((e=>{var t,n;const a=null===(t=e.querySelector(".encounter-minion-select"))||void 0===t?void 0:t.value,o=parseInt(null===(n=e.querySelector(".encounter-percent-input"))||void 0===n?void 0:n.value)||5;a&&Ce.push({minionId:a,percent:o})}));const Se=document.querySelectorAll("#mazemaster_maze_traps_list .mazemaster-trap-encounter-row"),Me=[];Se.forEach((e=>{var t,n;const a=null===(t=e.querySelector(".trap-encounter-select"))||void 0===t?void 0:t.value,o=parseInt(null===(n=e.querySelector(".trap-encounter-percent-input"))||void 0===n?void 0:n.value)||5;a&&Me.push({trapId:a,percent:o})}));const Ee=((null===(t=document.getElementById("mazemaster_maze_random_messages"))||void 0===t?void 0:t.value)||"").split("\n").filter((e=>e.trim()));return{gridSize:parseInt(null===(n=document.getElementById("mazemaster_maze_size"))||void 0===n?void 0:n.value)||10,difficulty:(null===(a=document.getElementById("mazemaster_maze_difficulty"))||void 0===a?void 0:a.value)||"normal",theme:(null===(o=document.getElementById("mazemaster_maze_theme"))||void 0===o?void 0:o.value)||"fantasy",mapStyle:(null===(i=document.getElementById("mazemaster_maze_mapstyle"))||void 0===i?void 0:i.value)||"maze",floors:parseInt(null===(s=document.getElementById("mazemaster_maze_floors"))||void 0===s?void 0:s.value)||1,mapVisibility:(null===(r=document.querySelector('input[name="mazemaster_map_visibility"]:checked'))||void 0===r?void 0:r.value)||"fogOfWar",winCommand:(null===(l=document.getElementById("mazemaster_maze_win_cmd"))||void 0===l?void 0:l.value)||"",loseCommand:(null===(c=document.getElementById("mazemaster_maze_lose_cmd"))||void 0===c?void 0:c.value)||"",winMessage:(null===(d=document.getElementById("mazemaster_maze_win_message"))||void 0===d?void 0:d.value)||"",winImage:we.winImage||"",chestImage:we.chestImage||"",mainMinion:(null===(m=document.getElementById("mazemaster_maze_main_minion"))||void 0===m?void 0:m.value)||"",mainMinionIntroMessage:(null===(p=document.getElementById("mazemaster_maze_intro_message"))||void 0===p?void 0:p.value)||"",mainMinionRandomChance:parseInt(null===(u=document.getElementById("mazemaster_maze_random_chance"))||void 0===u?void 0:u.value)||15,mainMinionRandomMessages:Ee,mainMinionExitType:(null===(h=document.getElementById("mazemaster_maze_exit_type"))||void 0===h?void 0:h.value)||"messenger",mainMinionExitProfile:(null===(g=document.getElementById("mazemaster_maze_exit_profile"))||void 0===g?void 0:g.value)||"",minionEncounters:Ce,trapEncounters:Me,onBattlebarLoss:(null===(f=document.getElementById("mazemaster_maze_loss_action"))||void 0===f?void 0:f.value)||"continue",chestTilePercent:parseInt(null===(v=document.getElementById("mazemaster_maze_chest_percent"))||void 0===v?void 0:v.value)||10,chestLockedPercent:parseInt(null===(b=document.getElementById("mazemaster_maze_locked_percent"))||void 0===b?void 0:b.value)||30,chestLockedBonusPercent:parseInt(null===(y=document.getElementById("mazemaster_maze_locked_bonus"))||void 0===y?void 0:y.value)||50,chestMimicPercent:parseInt(null===(z=document.getElementById("mazemaster_maze_mimic_percent"))||void 0===z?void 0:z.value)||15,chestLootMin:parseInt(null===(x=document.getElementById("mazemaster_maze_loot_min"))||void 0===x?void 0:x.value)||1,chestLootMax:parseInt(null===(_=document.getElementById("mazemaster_maze_loot_max"))||void 0===_?void 0:_.value)||2,chestKeyChance:parseInt(null===(w=document.getElementById("mazemaster_maze_chest_key"))||void 0===w?void 0:w.value)||30,chestStrikeChance:parseInt(null===(k=document.getElementById("mazemaster_maze_chest_pow"))||void 0===k?void 0:k.value)||50,chestStealthChance:parseInt(null===(C=document.getElementById("mazemaster_maze_chest_stealth"))||void 0===C?void 0:C.value)||0,chestExecuteChance:parseInt(null===(S=document.getElementById("mazemaster_maze_chest_execute"))||void 0===S?void 0:S.value)||0,lockedChestKeyChance:parseInt(null===(M=document.getElementById("mazemaster_maze_locked_key"))||void 0===M?void 0:M.value)||40,lockedChestStrikeChance:parseInt(null===(E=document.getElementById("mazemaster_maze_locked_pow"))||void 0===E?void 0:E.value)||60,lockedChestStealthChance:parseInt(null===(P=document.getElementById("mazemaster_maze_locked_stealth"))||void 0===P?void 0:P.value)||30,lockedChestExecuteChance:parseInt(null===(I=document.getElementById("mazemaster_maze_locked_execute"))||void 0===I?void 0:I.value)||5,startingInventory:{key:parseInt(null===(T=document.getElementById("mazemaster_start_key"))||void 0===T?void 0:T.value)||0,strike:parseInt(null===(B=document.getElementById("mazemaster_start_pow"))||void 0===B?void 0:B.value)||0,stealth:parseInt(null===(D=document.getElementById("mazemaster_start_stealth"))||void 0===D?void 0:D.value)||0,execute:parseInt(null===(L=document.getElementById("mazemaster_start_execute"))||void 0===L?void 0:L.value)||0,healingPotion:parseInt(null===(R=document.getElementById("mazemaster_start_healingPotion"))||void 0===R?void 0:R.value)||0,greaterHealing:parseInt(null===(A=document.getElementById("mazemaster_start_greaterHealing"))||void 0===A?void 0:A.value)||0,elixir:parseInt(null===(O=document.getElementById("mazemaster_start_elixir"))||void 0===O?void 0:O.value)||0,revivalCharm:parseInt(null===(H=document.getElementById("mazemaster_start_revivalCharm"))||void 0===H?void 0:H.value)||0},hpEnabled:!1!==(null===(N=document.getElementById("mazemaster_hp_enabled"))||void 0===N?void 0:N.checked),maxHP:parseInt(null===(q=document.getElementById("mazemaster_hp_max"))||void 0===q?void 0:q.value)||100,battlebarDamageMultiplier:parseFloat(null===(F=document.getElementById("mazemaster_hp_battlebar_mult"))||void 0===F?void 0:F.value)||1,battlebarDifficultyMultiplier:parseFloat(null===(j=document.getElementById("mazemaster_hp_battlebar_diff"))||void 0===j?void 0:j.value)||1,respawnHPPercent:parseInt(null===(W=document.getElementById("mazemaster_hp_respawn"))||void 0===W?void 0:W.value)||50,onDeath:(null===(Y=document.getElementById("mazemaster_hp_ondeath"))||void 0===Y?void 0:Y.value)||"respawn",safeRoomCount:null!==(G=parseInt(null===(U=document.getElementById("mazemaster_saferoom_count"))||void 0===U?void 0:U.value))&&void 0!==G?G:3,safeRoomHealPercent:null!==(K=parseInt(null===(V=document.getElementById("mazemaster_saferoom_heal"))||void 0===V?void 0:V.value))&&void 0!==K?K:100,safeRoomUseLLM:(null===(X=document.getElementById("mazemaster_saferoom_llm"))||void 0===X?void 0:X.checked)||!1,llmEnhanceRooms:!1!==(null===(J=document.getElementById("mazemaster_llm_enhance_rooms"))||void 0===J?void 0:J.checked),restEnabled:!1!==(null===(Q=document.getElementById("mazemaster_rest_enabled"))||void 0===Q?void 0:Q.checked),restHealPercent:null!==(Z=parseInt(null===($=document.getElementById("mazemaster_rest_heal"))||void 0===$?void 0:$.value))&&void 0!==Z?Z:20,restCooldown:null!==(ee=parseInt(null===(te=document.getElementById("mazemaster_rest_cooldown"))||void 0===te?void 0:te.value))&&void 0!==ee?ee:3,restInterruptChance:null!==(ne=parseInt(null===(ae=document.getElementById("mazemaster_rest_interrupt"))||void 0===ae?void 0:ae.value))&&void 0!==ne?ne:0,restInterruptScript:(null===(oe=document.getElementById("mazemaster_rest_interrupt_script"))||void 0===oe?void 0:oe.value)||"",portals:Eo(),bspConfig:{zoneCount:parseInt(null===(ie=document.getElementById("mazemaster_bsp_zone_count"))||void 0===ie?void 0:ie.value)||1,secretDensity:parseFloat(null===(se=document.getElementById("mazemaster_bsp_secret_density"))||void 0===se?void 0:se.value)||0,zonesRequireClear:!1!==(null===(re=document.getElementById("mazemaster_bsp_zones_require_clear"))||void 0===re?void 0:re.checked),secretHints:!1!==(null===(le=document.getElementById("mazemaster_bsp_secret_hints"))||void 0===le?void 0:le.checked),floorComplexityScaling:!1!==(null===(ce=document.getElementById("mazemaster_bsp_floor_scaling"))||void 0===ce?void 0:ce.checked)},objectives:Po(),onMove:(null===(de=document.getElementById("mazemaster_hook_onMove"))||void 0===de?void 0:de.value)||"",onMilestone:(null===(me=document.getElementById("mazemaster_hook_onMilestone"))||void 0===me?void 0:me.value)||"",onExploreComplete:(null===(pe=document.getElementById("mazemaster_hook_onExploreComplete"))||void 0===pe?void 0:pe.value)||"",onItemAdd:(null===(ue=document.getElementById("mazemaster_hook_onItemAdd"))||void 0===ue?void 0:ue.value)||"",onItemRemove:(null===(he=document.getElementById("mazemaster_hook_onItemRemove"))||void 0===he?void 0:he.value)||"",onChestOpen:(null===(ge=document.getElementById("mazemaster_hook_onChestOpen"))||void 0===ge?void 0:ge.value)||"",onTrade:(null===(fe=document.getElementById("mazemaster_hook_onTrade"))||void 0===fe?void 0:fe.value)||"",onEnemyMove:(null===(ve=document.getElementById("mazemaster_hook_onEnemyMove"))||void 0===ve?void 0:ve.value)||"",onTeleport:(null===(be=document.getElementById("mazemaster_hook_onTeleport"))||void 0===be?void 0:be.value)||"",onObjectiveProgress:(null===(ye=document.getElementById("mazemaster_hook_onObjectiveProgress"))||void 0===ye?void 0:ye.value)||"",onObjectiveComplete:(null===(ze=document.getElementById("mazemaster_hook_onObjectiveComplete"))||void 0===ze?void 0:ze.value)||"",onAllObjectivesComplete:(null===(xe=document.getElementById("mazemaster_hook_onAllObjectivesComplete"))||void 0===xe?void 0:xe.value)||"",onStatUpdate:(null===(_e=document.getElementById("mazemaster_hook_onStatUpdate"))||void 0===_e?void 0:_e.value)||"",storyConfig:we.storyConfig||{mainStory:"",milestones:[]},findEarly:Mo()}}function Mo(){var e,t;const n=parseInt(null===(e=document.getElementById("mazemaster_findearly_radius"))||void 0===e?void 0:e.value)||4,a=parseInt(null===(t=document.getElementById("mazemaster_findearly_perchest"))||void 0===t?void 0:t.value)||1,o=[],i=["torch","lantern","mapFragment","healingPotion","greaterHealing","revealScroll","sightPotion","key","strike","stealth"];for(const e of i){const t=document.getElementById("mazemaster_findearly_".concat(e));null!=t&&t.checked&&o.push(e)}return 0===o.length?null:{radius:n,items:o,itemsPerChest:a}}function Eo(){const e=[];return document.querySelectorAll("#mazemaster_portals_list .mazemaster-portal-item").forEach((t=>{var n,a,o,i,s,r,l,c;const d=(null===(n=t.querySelector(".portal-id"))||void 0===n||null===(n=n.value)||void 0===n?void 0:n.trim())||"",m=(null===(a=t.querySelector(".portal-color-input"))||void 0===a?void 0:a.value)||"#9b59b6",p=null===(o=null===(i=t.querySelector(".portal-bidirectional"))||void 0===i?void 0:i.checked)||void 0===o||o,u=null===(s=t.querySelector(".portal-start-x"))||void 0===s?void 0:s.value,h=null===(r=t.querySelector(".portal-start-y"))||void 0===r?void 0:r.value,g=null===(l=t.querySelector(".portal-end-x"))||void 0===l?void 0:l.value,f=null===(c=t.querySelector(".portal-end-y"))||void 0===c?void 0:c.value;e.push({id:d||"portal_".concat(e.length+1),color:m,bidirectional:p,startX:""!==u?parseInt(u):null,startY:""!==h?parseInt(h):null,endX:""!==g?parseInt(g):null,endY:""!==f?parseInt(f):null})})),e}function Po(){const e=[];return document.querySelectorAll("#mazemaster_objectives_list .mazemaster-objective-item").forEach(((t,n)=>{var a,o,i,s,r,l,c,d;const m=(null===(a=t.querySelector(".objective-id"))||void 0===a||null===(a=a.value)||void 0===a?void 0:a.trim())||"obj_".concat(n+1),p=(null===(o=t.querySelector(".objective-type"))||void 0===o?void 0:o.value)||"collect",u=(null===(i=t.querySelector(".objective-target"))||void 0===i||null===(i=i.value)||void 0===i?void 0:i.trim())||"",h=parseInt(null===(s=t.querySelector(".objective-count"))||void 0===s?void 0:s.value)||1,g=(null===(r=t.querySelector(".objective-description"))||void 0===r||null===(r=r.value)||void 0===r?void 0:r.trim())||"",f=null===(l=null===(c=t.querySelector(".objective-required"))||void 0===c?void 0:c.checked)||void 0===l||l,v=(null===(d=t.querySelector(".objective-reward"))||void 0===d||null===(d=d.value)||void 0===d?void 0:d.trim())||"";e.push({id:m,type:p,target:"explore"===p?null:u,count:h,description:g||"".concat("collect"===p?"Collect":"defeat"===p?"Defeat":"Explore"," ").concat(h).concat("explore"===p?"%":" "+u),required:f,reward:v})})),e}async function Io(e,t){let n;try{n=await async function(e){return new Promise(((t,n)=>{const a=new Image,o=URL.createObjectURL(e);a.onload=()=>{URL.revokeObjectURL(o);const i=Math.min(a.width,a.height),s=(a.width-i)/2,r=(a.height-i)/2,l=document.createElement("canvas");l.width=i,l.height=i,l.getContext("2d").drawImage(a,s,r,i,i,0,0,i,i),l.toBlob((e=>{e?t(e):n(new Error("Failed to create cropped image"))}),e.type||"image/png")},a.onerror=()=>{URL.revokeObjectURL(o),n(new Error("Failed to load image"))},a.src=o}))}(e)}catch(t){console.warn("[MazeMaster] Could not crop image, using original:",t),n=e}return new Promise(((a,o)=>{const i=new FileReader;i.onload=async n=>{try{const i=n.target.result.split(",")[1],s=e.name.split(".").pop().toLowerCase(),r=Date.now(),l="".concat(t,"_").concat(r),c=await fetch("/api/images/upload",{method:"POST",headers:m(),body:JSON.stringify({image:i,ch_name:"MazeMaster",filename:l,format:s})});if(c.ok)a("user/images/MazeMaster/".concat(l,".").concat(s));else{const e=await c.json().catch((()=>({})));o(new Error(e.error||"Upload failed"))}}catch(e){o(e)}},i.onerror=()=>o(new Error("Failed to read file")),i.readAsDataURL(n)}))}function To(){var e;const t=document.getElementById("mazemaster_minions_list");if(!t)return;const n=document.getElementById("mazemaster_minion_profile_select"),a=(null==n?void 0:n.value)||"";let o=Ct();if(a&&null!==(e=Re.minionProfiles)&&void 0!==e&&e[a]){const e=Re.minionProfiles[a];if(Array.isArray(e.minions))o=o.filter((t=>e.minions.includes(t)));else if("object"==typeof e&&!e.minions){const t=Object.keys(e);o=o.filter((e=>t.includes(e)))}}if(0===o.length){const e=a?'No minions in profile "'.concat(a,'". Select a different profile or add minions.'):"No minions. Add minions for use in the maze game.";return void(t.innerHTML='<div class="mazemaster-empty-state">'.concat(e,"</div>"))}const s=tt(),r=$e(),l=ot(),c=rt(),d=dt(),m=ut(),h=ft(),g=yt();t.innerHTML=o.map((e=>{const t=St(e);if(!t)return console.warn('[MazeMaster] Minion "'.concat(e,'" not found, skipping')),"";const n=t.type||"messenger",a=t.battlebarProfiles||[],o=t.wheelProfiles||[],i=t.turnbasedProfiles||[],p=t.qteProfiles||[],u=t.diceProfiles||[],f=t.stealthProfiles||[],v=t.puzzleProfiles||[],b=t.negotiationProfiles||[],y=t.messages||[],z=t.encounterScript||"",x=t.merchantItemCount||{min:1,max:3},_=t.merchantItemPool||"Common Goods",w=Object.keys(Re.merchantItemPools||Te),k=t.movement||{type:"stationary",patrolRadius:3,chaseRange:5,speed:1};return'\n            <div class="mazemaster-minion-card" data-id="'.concat(_o(e),'">\n                <div class="minion-image">\n                    ').concat(t.imagePath?'<img src="'.concat(_o(Ee(t.imagePath)),'" alt="').concat(_o(t.name),'">'):"",'\n                </div>\n                <div class="minion-info">\n                    <div class="minion-row">\n                        <input type="text" class="minion-name-input" value="').concat(_o(t.name),'" placeholder="Minion name">\n                        <select class="minion-type-select">\n                            <option value="messenger" ').concat("messenger"===n?"selected":"",'>Messenger</option>\n                            <option value="battlebar" ').concat("battlebar"===n?"selected":"",'>Battlebar</option>\n                            <option value="prizewheel" ').concat("prizewheel"===n?"selected":"",'>PrizeWheel</option>\n                            <option value="merchant" ').concat("merchant"===n?"selected":"",'>Merchant</option>\n                            <option value="turnbased" ').concat("turnbased"===n?"selected":"",'>Turn-Based Combat</option>\n                            <option value="qte" ').concat("qte"===n?"selected":"",'>QTE Combat</option>\n                            <option value="dice" ').concat("dice"===n?"selected":"",'>Dice Combat</option>\n                            <option value="stealth" ').concat("stealth"===n?"selected":"",'>Stealth</option>\n                            <option value="puzzle" ').concat("puzzle"===n?"selected":"",'>Puzzle</option>\n                            <option value="negotiation" ').concat("negotiation"===n?"selected":"",'>Negotiation</option>\n                        </select>\n                    </div>\n                    <div class="minion-profiles battlebar-profiles" style="display: ').concat("battlebar"===n?"block":"none",';">\n                        <label>Battlebar Profiles:</label>\n                        <select multiple class="minion-battlebar-select">\n                            ').concat(s.map((e=>'<option value="'.concat(_o(e),'" ').concat(a.includes(e)?"selected":"",">").concat(_o(e),"</option>"))).join(""),'\n                        </select>\n                    </div>\n                    <div class="minion-profiles wheel-profiles" style="display: ').concat("prizewheel"===n?"block":"none",';">\n                        <label>Wheel Profiles:</label>\n                        <select multiple class="minion-wheel-select">\n                            ').concat(r.map((e=>'<option value="'.concat(_o(e),'" ').concat(o.includes(e)?"selected":"",">").concat(_o(e),"</option>"))).join(""),'\n                        </select>\n                    </div>\n                    <div class="minion-profiles messenger-messages" style="display: ').concat("messenger"===n?"block":"none",';">\n                        <label>Messages (one per line):</label>\n                        <textarea class="minion-messages-input" rows="2" placeholder="Hello traveler!&#10;Beware the maze...">').concat(_o(y.join("\n")),'</textarea>\n                    </div>\n                    <div class="minion-profiles merchant-settings" style="display: ').concat("merchant"===n?"block":"none",';">\n                        <label>Item Pool:</label>\n                        <select class="merchant-pool-select">\n                            ').concat(w.map((e=>'<option value="'.concat(_o(e),'" ').concat(_===e?"selected":"",">").concat(_o(e),"</option>"))).join(""),'\n                        </select>\n                        <label>Items Offered (random range):</label>\n                        <div class="merchant-range-row">\n                            <input type="number" class="merchant-min-input mazemaster-input-small" min="1" max="10" value="').concat(x.min,'">\n                            <span>to</span>\n                            <input type="number" class="merchant-max-input mazemaster-input-small" min="1" max="10" value="').concat(x.max,'">\n                            <span>items</span>\n                        </div>\n                    </div>\n                    <div class="minion-profiles turnbased-profiles" style="display: ').concat("turnbased"===n?"block":"none",';">\n                        <label>Turn-Based Profiles:</label>\n                        <select multiple class="minion-turnbased-select">\n                            ').concat(l.map((e=>'<option value="'.concat(_o(e),'" ').concat(i.includes(e)?"selected":"",">").concat(_o(e),"</option>"))).join(""),'\n                        </select>\n                    </div>\n                    <div class="minion-profiles qte-profiles" style="display: ').concat("qte"===n?"block":"none",';">\n                        <label>QTE Profiles:</label>\n                        <select multiple class="minion-qte-select">\n                            ').concat(c.map((e=>'<option value="'.concat(_o(e),'" ').concat(p.includes(e)?"selected":"",">").concat(_o(e),"</option>"))).join(""),'\n                        </select>\n                    </div>\n                    <div class="minion-profiles dice-profiles" style="display: ').concat("dice"===n?"block":"none",';">\n                        <label>Dice Profiles:</label>\n                        <select multiple class="minion-dice-select">\n                            ').concat(d.map((e=>'<option value="'.concat(_o(e),'" ').concat(u.includes(e)?"selected":"",">").concat(_o(e),"</option>"))).join(""),'\n                        </select>\n                    </div>\n                    <div class="minion-profiles stealth-profiles" style="display: ').concat("stealth"===n?"block":"none",';">\n                        <label>Stealth Profiles:</label>\n                        <select multiple class="minion-stealth-select">\n                            ').concat(m.map((e=>'<option value="'.concat(_o(e),'" ').concat(f.includes(e)?"selected":"",">").concat(_o(e),"</option>"))).join(""),'\n                        </select>\n                    </div>\n                    <div class="minion-profiles puzzle-profiles" style="display: ').concat("puzzle"===n?"block":"none",';">\n                        <label>Puzzle Profiles:</label>\n                        <select multiple class="minion-puzzle-select">\n                            ').concat(h.map((e=>'<option value="'.concat(_o(e),'" ').concat(v.includes(e)?"selected":"",">").concat(_o(e),"</option>"))).join(""),'\n                        </select>\n                    </div>\n                    <div class="minion-profiles negotiation-profiles" style="display: ').concat("negotiation"===n?"block":"none",';">\n                        <label>Negotiation Profiles:</label>\n                        <select multiple class="minion-negotiation-select">\n                            ').concat(g.map((e=>'<option value="'.concat(_o(e),'" ').concat(b.includes(e)?"selected":"",">").concat(_o(e),"</option>"))).join(""),'\n                        </select>\n                    </div>\n                    <div class="minion-encounter-script">\n                        <label>Encounter Script (STScript):</label>\n                        <textarea class="minion-script-input" rows="2" placeholder="/echo Custom action on encounter...">').concat(_o(z),'</textarea>\n                    </div>\n                    <div class="minion-movement-settings">\n                        <label>Maze Movement:</label>\n                        <div class="movement-row">\n                            <select class="minion-movement-type">\n                                <option value="stationary" ').concat("stationary"===k.type?"selected":"",'>Stationary</option>\n                                <option value="patrol" ').concat("patrol"===k.type?"selected":"",'>Patrol</option>\n                                <option value="chase" ').concat("chase"===k.type?"selected":"",'>Chase Player</option>\n                            </select>\n                        </div>\n                        <div class="movement-params" style="display: ').concat("stationary"!==k.type?"flex":"none",';">\n                            <div class="movement-param patrol-param" style="display: ').concat("patrol"===k.type?"flex":"none",';">\n                                <span>Radius:</span>\n                                <input type="number" class="minion-patrol-radius mazemaster-input-small" min="1" max="10" value="').concat(k.patrolRadius||3,'">\n                            </div>\n                            <div class="movement-param chase-param" style="display: ').concat("chase"===k.type?"flex":"none",';">\n                                <span>Range:</span>\n                                <input type="number" class="minion-chase-range mazemaster-input-small" min="1" max="20" value="').concat(k.chaseRange||5,'">\n                            </div>\n                            <div class="movement-param">\n                                <span>Speed:</span>\n                                <input type="number" class="minion-movement-speed mazemaster-input-small" min="1" max="5" value="').concat(k.speed||1,'" title="Moves every N player moves">\n                            </div>\n                        </div>\n                    </div>\n                </div>\n                <button class="menu_button menu_button_icon minion-delete-btn" title="Delete Minion">\n                    <i class="fa-solid fa-trash"></i>\n                </button>\n            </div>\n        ')})).join(""),t.querySelectorAll(".mazemaster-minion-card").forEach((e=>{const t=e.dataset.id,n=e.querySelector(".minion-name-input");n&&n.addEventListener("change",(()=>{const e=St(t);e&&(e.name=n.value.trim()||"Unknown",Mt(t,e))}));const a=e.querySelector(".minion-type-select");a&&a.addEventListener("change",(()=>{const n=St(t);if(n){n.type=a.value,Mt(t,n);const o={battlebar:e.querySelector(".battlebar-profiles"),prizewheel:e.querySelector(".wheel-profiles"),messenger:e.querySelector(".messenger-messages"),merchant:e.querySelector(".merchant-settings"),turnbased:e.querySelector(".turnbased-profiles"),qte:e.querySelector(".qte-profiles"),dice:e.querySelector(".dice-profiles"),stealth:e.querySelector(".stealth-profiles"),puzzle:e.querySelector(".puzzle-profiles"),negotiation:e.querySelector(".negotiation-profiles")};for(const[e,t]of Object.entries(o))t&&(t.style.display=n.type===e?"block":"none")}}));const o=e.querySelector(".minion-battlebar-select");o&&o.addEventListener("change",(()=>{const e=St(t);e&&(e.battlebarProfiles=Array.from(o.selectedOptions).map((e=>e.value)),Mt(t,e))}));const s=e.querySelector(".minion-wheel-select");s&&s.addEventListener("change",(()=>{const e=St(t);e&&(e.wheelProfiles=Array.from(s.selectedOptions).map((e=>e.value)),Mt(t,e))}));const r=e.querySelector(".minion-turnbased-select");r&&r.addEventListener("change",(()=>{const e=St(t);e&&(e.turnbasedProfiles=Array.from(r.selectedOptions).map((e=>e.value)),Mt(t,e))}));const l=e.querySelector(".minion-qte-select");l&&l.addEventListener("change",(()=>{const e=St(t);e&&(e.qteProfiles=Array.from(l.selectedOptions).map((e=>e.value)),Mt(t,e))}));const c=e.querySelector(".minion-dice-select");c&&c.addEventListener("change",(()=>{const e=St(t);e&&(e.diceProfiles=Array.from(c.selectedOptions).map((e=>e.value)),Mt(t,e))}));const d=e.querySelector(".minion-stealth-select");d&&d.addEventListener("change",(()=>{const e=St(t);e&&(e.stealthProfiles=Array.from(d.selectedOptions).map((e=>e.value)),Mt(t,e))}));const m=e.querySelector(".minion-puzzle-select");m&&m.addEventListener("change",(()=>{const e=St(t);e&&(e.puzzleProfiles=Array.from(m.selectedOptions).map((e=>e.value)),Mt(t,e))}));const h=e.querySelector(".minion-negotiation-select");h&&h.addEventListener("change",(()=>{const e=St(t);e&&(e.negotiationProfiles=Array.from(h.selectedOptions).map((e=>e.value)),Mt(t,e))}));const g=e.querySelector(".minion-messages-input");g&&g.addEventListener("change",(()=>{const e=St(t);e&&(e.messages=g.value.split("\n").filter((e=>e.trim())),Mt(t,e))}));const f=e.querySelector(".merchant-pool-select"),v=e.querySelector(".merchant-min-input"),b=e.querySelector(".merchant-max-input");f&&f.addEventListener("change",(()=>{const e=St(t);e&&(e.merchantItemPool=f.value,Mt(t,e))})),v&&v.addEventListener("change",(()=>{const e=St(t);e&&(e.merchantItemCount=e.merchantItemCount||{min:1,max:3},e.merchantItemCount.min=parseInt(v.value)||1,Mt(t,e))})),b&&b.addEventListener("change",(()=>{const e=St(t);e&&(e.merchantItemCount=e.merchantItemCount||{min:1,max:3},e.merchantItemCount.max=parseInt(b.value)||3,Mt(t,e))}));const y=e.querySelector(".minion-script-input");y&&y.addEventListener("change",(()=>{const e=St(t);e&&(e.encounterScript=y.value,Mt(t,e))}));const z=e.querySelector(".minion-movement-type"),x=e.querySelector(".movement-params"),_=e.querySelector(".patrol-param"),w=e.querySelector(".chase-param"),k=e.querySelector(".minion-patrol-radius"),C=e.querySelector(".minion-chase-range"),S=e.querySelector(".minion-movement-speed");z&&z.addEventListener("change",(()=>{const e=St(t);e&&(e.movement=e.movement||{type:"stationary",patrolRadius:3,chaseRange:5,speed:1},e.movement.type=z.value,Mt(t,e),x&&(x.style.display="stationary"!==z.value?"flex":"none"),_&&(_.style.display="patrol"===z.value?"flex":"none"),w&&(w.style.display="chase"===z.value?"flex":"none"))})),k&&k.addEventListener("change",(()=>{const e=St(t);e&&(e.movement=e.movement||{type:"patrol",patrolRadius:3,chaseRange:5,speed:1},e.movement.patrolRadius=parseInt(k.value)||3,Mt(t,e))})),C&&C.addEventListener("change",(()=>{const e=St(t);e&&(e.movement=e.movement||{type:"chase",patrolRadius:3,chaseRange:5,speed:1},e.movement.chaseRange=parseInt(C.value)||5,Mt(t,e))})),S&&S.addEventListener("change",(()=>{const e=St(t);e&&(e.movement=e.movement||{type:"stationary",patrolRadius:3,chaseRange:5,speed:1},e.movement.speed=parseInt(S.value)||1,Mt(t,e))}));const M=e.querySelector(".minion-image");M&&(M.style.cursor="pointer",M.title="Click to change image",M.addEventListener("click",(()=>{const e=document.createElement("input");e.type="file",e.accept="image/*",e.style.display="none",document.body.appendChild(e),e.addEventListener("change",(async n=>{var a;const o=null===(a=n.target.files)||void 0===a?void 0:a[0];if(o){try{const e=await Io(o,t),n=St(t);n&&(n.imagePath=e,Mt(t,n),To())}catch(e){console.error("[MazeMaster] Image upload failed:",e),alert("Image upload failed: ".concat(e.message))}document.body.removeChild(e)}else document.body.removeChild(e)})),e.click()})));const E=e.querySelector(".minion-delete-btn");E&&E.addEventListener("click",(async()=>{const e=St(t);var n;await p('Delete minion "'.concat((null==e?void 0:e.name)||t,'"?'),u.CONFIRM)&&(n=t,delete Re.minions[n],i(),To())}))}))}function Bo(){const e=document.getElementById("mazemaster_traps_list");if(!e)return;const t=Et();0!==t.length?(e.innerHTML=t.map((e=>{var t;const n=Pt(e),a=null!==(t=n.avoidChance)&&void 0!==t?t:0;return'\n            <div class="mazemaster-trap-card" data-id="'.concat(_o(e),'">\n                <div class="trap-image">\n                    ').concat(n.imagePath?'<img src="'.concat(_o(Ee(n.imagePath)),'" alt="').concat(_o(n.name),'">'):'<div class="trap-no-image"><i class="fa-solid fa-dungeon"></i></div>','\n                </div>\n                <div class="trap-info">\n                    <div class="trap-row">\n                        <input type="text" class="trap-name-input mazemaster-input" value="').concat(_o(n.name),'" placeholder="Trap name">\n                    </div>\n                    <div class="trap-message-row">\n                        <label>Message:</label>\n                        <textarea class="trap-message-input" rows="2" placeholder="You triggered a trap!">').concat(_o(n.message||""),'</textarea>\n                    </div>\n                    <div class="trap-script-row">\n                        <label>Script (STScript):</label>\n                        <textarea class="trap-script-input" rows="2" placeholder="/echo Trap triggered! | /mazedamage 25">').concat(_o(n.script||""),'</textarea>\n                    </div>\n                    <div class="trap-avoid-row" style="display: flex; gap: 8px; align-items: center; margin-top: 4px;">\n                        <label style="white-space: nowrap;">Avoid %:</label>\n                        <input type="number" class="trap-avoid-input mazemaster-input" value="').concat(a,'" min="0" max="100" style="width: 60px;">\n                        <input type="text" class="trap-avoid-message-input mazemaster-input" value="').concat(_o(n.avoidMessage||""),'" placeholder="Message when avoided" style="flex: 1;">\n                    </div>\n                    <div class="trap-avoid-script-row" style="margin-top: 4px;">\n                        <label>Avoid Script (STScript):</label>\n                        <textarea class="trap-avoid-script-input" rows="1" placeholder="/echo {{user}} dodged the trap!">').concat(_o(n.avoidScript||""),'</textarea>\n                    </div>\n                </div>\n                <button class="menu_button menu_button_icon trap-delete-btn" title="Delete Trap">\n                    <i class="fa-solid fa-trash"></i>\n                </button>\n            </div>\n        ')})).join(""),e.querySelectorAll(".mazemaster-trap-card").forEach((e=>{const t=e.dataset.id,n=e.querySelector(".trap-name-input");n&&n.addEventListener("change",(()=>{const e=Pt(t);e&&(e.name=n.value.trim()||"Unknown Trap",It(t,e))}));const a=e.querySelector(".trap-message-input");a&&a.addEventListener("change",(()=>{const e=Pt(t);e&&(e.message=a.value,It(t,e))}));const o=e.querySelector(".trap-script-input");o&&o.addEventListener("change",(()=>{const e=Pt(t);e&&(e.script=o.value,It(t,e))}));const s=e.querySelector(".trap-avoid-input");s&&s.addEventListener("change",(()=>{const e=Pt(t);e&&(e.avoidChance=Math.max(0,Math.min(100,parseInt(s.value)||0)),It(t,e))}));const r=e.querySelector(".trap-avoid-message-input");r&&r.addEventListener("change",(()=>{const e=Pt(t);e&&(e.avoidMessage=r.value,It(t,e))}));const l=e.querySelector(".trap-avoid-script-input");l&&l.addEventListener("change",(()=>{const e=Pt(t);e&&(e.avoidScript=l.value,It(t,e))}));const c=e.querySelector(".trap-image");c&&(c.style.cursor="pointer",c.title="Click to change image",c.addEventListener("click",(()=>{const e=document.createElement("input");e.type="file",e.accept="image/*",e.style.display="none",document.body.appendChild(e),e.addEventListener("change",(async n=>{var a;const o=null===(a=n.target.files)||void 0===a?void 0:a[0];if(o){try{const e=await Io(o,t),n=Pt(t);n&&(n.imagePath=e,It(t,n),Bo())}catch(e){console.error("[MazeMaster] Image upload failed:",e),alert("Image upload failed: ".concat(e.message))}document.body.removeChild(e)}else document.body.removeChild(e)})),e.click()})));const d=e.querySelector(".trap-delete-btn");d&&d.addEventListener("click",(async()=>{const e=Pt(t);var n;await p('Delete trap "'.concat((null==e?void 0:e.name)||t,'"?'),u.CONFIRM)&&(n=t,delete Re.traps[n],i(),Bo())}))}))):e.innerHTML='<div class="mazemaster-empty-state">No traps. Add traps for use in maze profiles.</div>'}function Do(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;console.log("[MazeMaster] initUI called (attempt "+(e+1)+")");if(document.getElementById("mazemaster-button"))return console.log("[MazeMaster] Drawer already exists, skipping insertion"),No(),xo(),To(),Bo(),ko(),void("battlebar"===Re.activeGameConfig&&wo());const t=document.getElementById("extensions-settings-button");if(!t)return e<10?(console.log("[MazeMaster] extensions-settings-button not found, retrying in 500ms..."),void setTimeout((()=>Do(e+1)),500)):void console.error("[MazeMaster] extensions-settings-button NOT FOUND after 10 retries!");let n;try{n=zo(),console.log("[MazeMaster] getPanelHtml succeeded")}catch(e){console.error("[MazeMaster] getPanelHtml FAILED:",e),n="<div>Error loading panel</div>"}const a=document.createElement("div");a.id="mazemaster-button",a.className="drawer",a.innerHTML='\n        <div class="drawer-toggle drawer-header">\n            <div class="drawer-icon fa-solid fa-dharmachakra fa-fw closedIcon" title="MazeMaster"></div>\n        </div>\n        <div id="mazemaster_drawer" class="drawer-content closedDrawer">\n            '.concat(n,"\n        </div>\n    "),t.after(a),console.log("[MazeMaster] Drawer inserted after extensions button");const o=a.querySelector(".drawer-toggle");if(o&&window.jQuery){const e=window.jQuery;e(o).on("click",(async function(){const t=e(this).find(".drawer-icon"),n=e(this).parent().find(".drawer-content");n.hasClass("openDrawer")||(e(".openDrawer:not(.pinnedOpen)").removeClass("openDrawer").addClass("closedDrawer"),e(".openIcon:not(.drawerPinnedOpen)").removeClass("openIcon").addClass("closedIcon")),t.toggleClass("openIcon closedIcon"),n.toggleClass("openDrawer closedDrawer")}))}No(),xo(),To(),Bo(),ko(),"battlebar"===Re.activeGameConfig&&wo()}function Lo(){var e;const t=document.getElementById("mazemaster_maze_chest_percent");t&&(t.value="15");const n=document.getElementById("mazemaster_maze_encounters_list"),a=(null==n?void 0:n.querySelectorAll(".mazemaster-encounter-row"))||[],o={messenger:10,prizewheel:6,battlebar:4,merchant:1};let i=0;const s=[];a.forEach((e=>{const t=e.getAttribute("data-minion-id");if(!t)return;const n=St(t),a=(null==n?void 0:n.type)||"battlebar",r=o[a]||4;i+=r,s.push({row:e,type:a,weight:r})}));i>0&&s.forEach((e=>{let{row:t,weight:n}=e;const a=Math.round(n/i*60),o=t.querySelector(".encounter-percent-input");o&&(o.value=a)}));const r=document.getElementById("mazemaster_maze_traps_list"),l=(null==r?void 0:r.querySelectorAll(".mazemaster-encounter-row"))||[];if(l.length>0){const e=Math.floor(5/l.length);l.forEach((t=>{const n=t.querySelector(".encounter-percent-input");n&&(n.value=e||1)}))}const c=null===(e=document.getElementById("mazemaster_maze_profile_select"))||void 0===e?void 0:e.value;if(c){kt(c,So()),loadMazeProfileSettings()}console.log("[MazeMaster] Intelligent Distribute applied: Chests 15%, Traps 5%, Minions distributed")}function Ro(){if(!Ge.isOpen||!Ge.profileName)return console.warn("[MazeMaster] No active maze to save"),!1;const e={profileName:Ge.profileName,size:Ge.size,playerX:Ge.playerX,playerY:Ge.playerY,exitX:Ge.exitX,exitY:Ge.exitY,visited:Array.from(Ge.visited),inventory:t({},Ge.inventory),exitEncounterDone:Ge.exitEncounterDone,shownMilestones:Array.from(Ge.shownMilestones||[]),currentFloor:Ge.currentFloor||0,totalFloors:Ge.totalFloors||1,floors:(Ge.floors||[Ge.grid]).map((e=>e.map((e=>e.map((e=>({walls:e.walls,visited:e.visited,minion:e.minion,trap:e.trap,chest:e.chest,staircase:e.staircase,roomInfo:e.roomInfo,safeRoom:e.safeRoom}))))))),grid:Ge.grid.map((e=>e.map((e=>({walls:e.walls,visited:e.visited,minion:e.minion,trap:e.trap,chest:e.chest,staircase:e.staircase,roomInfo:e.roomInfo,safeRoom:e.safeRoom}))))),messageLog:Ge.messageLog||[],hpEnabled:Ge.hpEnabled,hp:Ge.hp?t({},Ge.hp):null,restCooldown:Ge.restCooldown||0,sessionNotes:Ge.sessionNotes||"",fairness:Ge.fairness||{},enhancedRooms:Ge.enhancedRooms||{},timestamp:Date.now()};return Re.savedMazes[Ge.profileName]=e,i(),console.log('[MazeMaster] Maze progress saved for "'.concat(Ge.profileName,'"')),!0}function Ao(e){var n,a,o,i,s,r;const l=null===(n=Re.savedMazes)||void 0===n?void 0:n[e];if(!l)return console.warn('[MazeMaster] No saved game for "'.concat(e,'"')),!1;const c=wt(e);if(!c)return console.error('[MazeMaster] Profile "'.concat(e,'" no longer exists')),!1;const d=l.totalFloors||1,m=l.currentFloor||0;let p;p=l.floors&&l.floors.length>0?l.floors.map((e=>e.map((e=>e.map((e=>({walls:e.walls,visited:e.visited,minion:e.minion,trap:e.trap,chest:e.chest,staircase:e.staircase,roomInfo:e.roomInfo,safeRoom:e.safeRoom}))))))):[l.grid.map((e=>e.map((e=>({walls:e.walls,visited:e.visited,minion:e.minion,trap:e.trap,chest:e.chest,staircase:e.staircase,roomInfo:e.roomInfo,safeRoom:e.safeRoom})))))];const u=p[m];let h={name:"The Maze",imagePath:"",message:"Find your way to the exit..."};const g=c.mainMinion?St(c.mainMinion):null;if(g&&(h={name:g.name,imagePath:g.imagePath,message:"Continuing your journey..."}),Ge={isOpen:!0,profile:c,profileName:e,grid:u,size:l.size,playerX:l.playerX,playerY:l.playerY,exitX:l.exitX,exitY:l.exitY,visited:new Set(l.visited),isVictory:!1,currentMinion:h,isPaused:!1,pendingEncounter:null,exitEncounterDone:l.exitEncounterDone,pendingConfirmation:null,pendingChest:null,inventory:t({key:0,stealth:0,strike:0,execute:0,floorKey:0,portalStone:0,minionBane:0,mapFragment:0,timeShard:0,voidWalk:0,healingPotion:0,greaterHealing:0,elixir:0,revivalCharm:0,heartCrystal:0},l.inventory),shownMilestones:new Set(l.shownMilestones||[]),currentFloor:m,totalFloors:d,floors:p,voidWalkActive:!1,messageLog:l.messageLog||[],hpEnabled:null!==(a=l.hpEnabled)&&void 0!==a?a:!1!==c.hpEnabled,hp:l.hp?{current:null!==(o=l.hp.current)&&void 0!==o?o:q(c).current,max:null!==(i=l.hp.max)&&void 0!==i?i:q(c).max,maxBonus:null!==(s=l.hp.maxBonus)&&void 0!==s?s:0,reviveCharges:null!==(r=l.hp.reviveCharges)&&void 0!==r?r:0}:q(c),restCooldown:l.restCooldown||0,sessionNotes:l.sessionNotes||"",fairness:l.fairness||{chestsWithoutKey:0,combatLossStreak:0,chestsWithoutHealing:0,lockedChestsSkipped:0,lastHealingFoundFloor:0},enhancedRooms:l.enhancedRooms||{}},Ge.hp){const e=Ge.hp.max+(Ge.hp.maxBonus||0);Ge.hp.current>e&&(console.log("[MazeMaster] Clamping HP from ".concat(Ge.hp.current," to ").concat(e)),Ge.hp.current=e)}return Da(),Ra(),ue(!1),Ha(),Na(),Ka(),U(),G(),me(),ce(),document.addEventListener("keydown",ja,{capture:!0}),console.log('[MazeMaster] Loaded saved maze "'.concat(e,'" (floor ').concat(m+1,"/").concat(d,")")),!0}function Oo(e){var t;return!(null===(t=Re.savedMazes)||void 0===t||!t[e])&&(delete Re.savedMazes[e],i(),console.log('[MazeMaster] Deleted saved maze "'.concat(e,'"')),!0)}function Ho(){const e=["mazemaster_saved_games_list","mazemaster_game_tab_saves"],t=Object.keys(Re.savedMazes||{});for(const n of e){const e=document.getElementById(n);e&&(0!==t.length?(e.innerHTML=t.map((e=>{const t=Re.savedMazes[e],n=new Date(t.timestamp),a=t.visited?Math.round(t.visited.length/(t.size*t.size)*100):0;return'\n                <div class="mazemaster-saved-game" data-profile="'.concat(_o(e),'">\n                    <div class="mazemaster-saved-game-info">\n                        <div class="mazemaster-saved-game-name">').concat(_o(e),'</div>\n                        <div class="mazemaster-saved-game-details">').concat(a,"% explored - ").concat(n.toLocaleDateString(),'</div>\n                    </div>\n                    <div class="mazemaster-saved-game-actions">\n                        <button class="menu_button menu_button_icon saved-game-load" title="Resume">\n                            <i class="fa-solid fa-play"></i>\n                        </button>\n                        <button class="menu_button menu_button_icon saved-game-delete" title="Delete">\n                            <i class="fa-solid fa-trash"></i>\n                        </button>\n                    </div>\n                </div>\n            ')})).join(""),e.querySelectorAll(".mazemaster-saved-game").forEach((e=>{var t,n;const a=e.dataset.profile;null===(t=e.querySelector(".saved-game-load"))||void 0===t||t.addEventListener("click",(()=>{Ao(a)})),null===(n=e.querySelector(".saved-game-delete"))||void 0===n||n.addEventListener("click",(async()=>{await p('Delete saved game "'.concat(a,'"?'),u.CONFIRM)&&(Oo(a),Ho())}))}))):e.innerHTML='<div class="mazemaster-no-saves">No saved games</div>')}}function No(){const e=document.getElementById("mazemaster_profile_select");e&&e.addEventListener("change",(e=>{Re.currentProfile=e.target.value,i(),function(){var e;const t=et(null===(e=document.getElementById("mazemaster_profile_select"))||void 0===e?void 0:e.value),n=document.getElementById("mazemaster_randomize");n&&(n.checked=(null==t?void 0:t.randomize)||!1);const a=document.getElementById("mazemaster_difficulty");a&&(a.value=(null==t?void 0:t.difficulty)||1)}(),xo()}));const n=document.getElementById("mazemaster_new_profile_btn");n&&n.addEventListener("click",(async e=>{e.preventDefault(),e.stopPropagation();const t=await p("Enter new wheel profile name:",u.INPUT,"");if(t&&t.trim()){const e=t.trim();Re.profiles[e]?await p('Profile "'.concat(e,'" already exists.'),u.TEXT):(Re.profiles[e]={segments:[],randomize:!1,difficulty:1},Re.currentProfile=e,i(),qo())}}));const a=document.getElementById("mazemaster_delete_profile_btn");a&&a.addEventListener("click",(async()=>{var e;const t=null===(e=document.getElementById("mazemaster_profile_select"))||void 0===e?void 0:e.value;if(t){await p('Delete wheel profile "'.concat(t,'"?'),u.CONFIRM)&&(!function(e){if(delete Re.profiles[e],Re.currentProfile===e){const e=$e();Re.currentProfile=e[0]||"default"}i()}(t),qo())}}));const o=document.getElementById("mazemaster_rename_profile_btn");o&&o.addEventListener("click",(async()=>{var e;const t=null===(e=document.getElementById("mazemaster_profile_select"))||void 0===e?void 0:e.value;if(!t)return void alert("No profile selected to rename");const n=await p("Enter new profile name:",u.INPUT,t);if(n&&n.trim()&&n.trim()!==t){const e=n.trim();if(Re.profiles[e])return void alert("A profile with that name already exists");Re.profiles[e]=Re.profiles[t],delete Re.profiles[t],Re.currentProfile=e,i(),qo()}}));const s=document.getElementById("mazemaster_export_btn");s&&s.addEventListener("click",(()=>{var e;const t=null===(e=document.getElementById("mazemaster_profile_select"))||void 0===e?void 0:e.value;t?function(e){const t=et(e);if(!t)return void alert('Profile "'.concat(e,'" not found'));const n={name:e,profile:t,exportedAt:(new Date).toISOString(),version:"1.0"},a=JSON.stringify(n,null,2),o=new Blob([a],{type:"application/json"}),i=URL.createObjectURL(o),s=document.createElement("a");s.href=i,s.download="mazemaster-".concat(e,".json"),document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(i),console.log('[MazeMaster] Exported profile "'.concat(e,'"'))}(t):alert("No profile selected to export")}));const r=document.getElementById("mazemaster_import_btn"),l=document.getElementById("mazemaster_import_file");r&&l&&(r.addEventListener("click",(()=>{l.click()})),l.addEventListener("change",(async e=>{var t;const n=null===(t=e.target.files)||void 0===t?void 0:t[0];if(n){try{const e=await function(e){return new Promise(((t,n)=>{const a=new FileReader;a.onload=e=>{try{const a=JSON.parse(e.target.result);if(!a.profile||!a.name)return void n(new Error("Invalid profile format: missing name or profile data"));let o=a.name;if(Re.profiles[o]){const e=prompt('Profile "'.concat(o,'" already exists. Enter a new name:'),"".concat(o,"_imported"));if(!e||!e.trim())return void n(new Error("Import cancelled"));o=e.trim()}const s=a.profile;s.segments&&Array.isArray(s.segments)||(s.segments=[]),"boolean"!=typeof s.randomize&&(s.randomize=!1),("number"!=typeof s.difficulty||s.difficulty<1||s.difficulty>5)&&(s.difficulty=1),Re.profiles[o]=s,Re.currentProfile=o,i(),console.log('[MazeMaster] Imported profile "'.concat(o,'":'),s),t(o)}catch(e){n(new Error("Failed to parse JSON: ".concat(e.message)))}},a.onerror=()=>n(new Error("Failed to read file")),a.readAsText(e)}))}(n);alert('Profile "'.concat(e,'" imported successfully!')),qo()}catch(e){alert("Import failed: ".concat(e.message))}l.value=""}})));const c=document.getElementById("mazemaster_add_segment_btn");c&&c.addEventListener("click",(()=>{const e=document.getElementById("mazemaster_segments_list");if(!e)return;const t=e.querySelector(".mazemaster-empty-state");t&&t.remove();const n=e.querySelectorAll(".mazemaster-segment-item").length,a=document.createElement("div");a.className="mazemaster-segment-item",a.dataset.index=n,a.innerHTML='\n                <div class="mazemaster-segment-row">\n                    <div class="mazemaster-segment-field small">\n                        <label>Trigger</label>\n                        <input type="text" class="seg-trigger" value="com'.concat(n+1,'" placeholder="com1">\n                    </div>\n                    <div class="mazemaster-segment-field">\n                        <label>Display Text</label>\n                        <input type="text" class="seg-text" value="" placeholder="Prize name">\n                    </div>\n                    <div class="mazemaster-segment-field small">\n                        <label>Size</label>\n                        <select class="seg-size">\n                            ').concat(y.map((e=>'<option value="'.concat(e,'" ').concat("fraction"===e?"selected":"",">").concat(e,"</option>"))).join(""),'\n                        </select>\n                    </div>\n                    <button class="menu_button menu_button_icon mazemaster-segment-delete" title="Delete">\n                        <i class="fa-solid fa-trash"></i>\n                    </button>\n                </div>\n                <div class="mazemaster-segment-row">\n                    <div class="mazemaster-segment-field">\n                        <label>STScript Command</label>\n                        <textarea class="seg-command" placeholder="/echo You won!"></textarea>\n                    </div>\n                    <div class="mazemaster-segment-field tiny">\n                        <label>&nbsp;</label>\n                        <label class="mazemaster-segment-checkbox">\n                            <input type="checkbox" class="seg-respin">\n                            Respin\n                        </label>\n                    </div>\n                </div>\n            '),a.querySelector(".mazemaster-segment-delete").addEventListener("click",(()=>{a.remove()})),e.appendChild(a)}));const h=document.getElementById("mazemaster_save_btn");h&&h.addEventListener("click",(()=>{var e,t,n;const a=null===(e=document.getElementById("mazemaster_profile_select"))||void 0===e?void 0:e.value;if(!a)return void alert("Please create a profile first");const o=function(){const e=document.querySelectorAll(".mazemaster-segment-item"),t=[];return e.forEach((e=>{const n=e.querySelector(".seg-trigger").value.trim(),a=e.querySelector(".seg-text").value.trim(),o=e.querySelector(".seg-command").value.trim(),i=e.querySelector(".seg-size").value,s=e.querySelector(".seg-respin").checked;(n||a)&&t.push({trigger:n,text:a,command:o,size:i,respin:s})})),t}(),s=(null===(t=document.getElementById("mazemaster_randomize"))||void 0===t?void 0:t.checked)||!1,r=parseInt(null===(n=document.getElementById("mazemaster_difficulty"))||void 0===n?void 0:n.value)||1;if(0===o.length)return void alert("Error: Wheel must have at least one segment");const l=o.filter((e=>"halfseg"===e.size)).length,c=o.filter((e=>"doubleseg"===e.size)).length;l===c?(!function(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;Re.profiles[e]={segments:t,randomize:n,difficulty:a},i(),console.log("[MazeMaster] Profile saved:",e,Re.profiles[e])}(a,o,s,r),console.log('[MazeMaster] Saved profile "'.concat(a,'":'),{segments:o,randomize:s,difficulty:r}),alert('Profile "'.concat(a,'" saved!'))):alert("Error: Wheel unbalanced!\n\n".concat(l," halfseg(s)  ").concat(c," doubleseg(s)\n\nFor every halfseg, you need a doubleseg to balance the wheel."))}));const f=document.getElementById("mazemaster_preview_wheel_btn");f&&f.addEventListener("click",(()=>{var e;const t=null===(e=document.getElementById("mazemaster_profile_select"))||void 0===e?void 0:e.value;if(!t)return void alert("Please select or create a wheel profile first");const n=Tt(t);if(n.error)return void alert("Error: ".concat(n.error));const a=Bt();a.valid?Lt():alert("Error: ".concat(a.error))}));const v=document.getElementById("mazemaster_preview_battlebar_btn");v&&v.addEventListener("click",(()=>{var e;const t=null===(e=document.getElementById("mazemaster_bb_profile_select"))||void 0===e?void 0:e.value;if(!t)return void alert("Please select or create a battlebar profile first");const n=Nn(t);n.error&&alert("Error: ".concat(n.error))}));const b=document.getElementById("mazemaster_show_wheel"),z=document.getElementById("mazemaster_show_combat"),x=document.getElementById("mazemaster_show_maze"),w=document.getElementById("mazemaster_show_minions"),k=document.getElementById("mazemaster_show_traps"),C=document.getElementById("mazemaster_wheel_config"),S=document.getElementById("mazemaster_combat_config"),M=document.getElementById("mazemaster_maze_config"),E=document.getElementById("mazemaster_minions_config"),P=document.getElementById("mazemaster_traps_config");function I(e){"battlebar"===e&&(e="combat"),Re.activeGameConfig=e,i(),null==b||b.classList.toggle("active","wheel"===e),null==z||z.classList.toggle("active","combat"===e),null==x||x.classList.toggle("active","maze"===e),null==w||w.classList.toggle("active","minions"===e),null==k||k.classList.toggle("active","traps"===e),C&&(C.style.display="wheel"===e?"block":"none"),S&&(S.style.display="combat"===e?"block":"none"),M&&(M.style.display="maze"===e?"block":"none"),E&&(E.style.display="minions"===e?"block":"none"),P&&(P.style.display="traps"===e?"block":"none"),"combat"===e&&wo(),"minions"===e&&To(),"traps"===e&&Bo()}b&&b.addEventListener("click",(()=>I("wheel"))),z&&z.addEventListener("click",(()=>I("combat"))),x&&x.addEventListener("click",(()=>I("maze"))),w&&w.addEventListener("click",(()=>I("minions"))),k&&k.addEventListener("click",(()=>I("traps"))),document.querySelectorAll(".combat-subtab").forEach((e=>{e.addEventListener("click",(()=>{var t;document.querySelectorAll(".combat-subtab").forEach((e=>e.classList.remove("active"))),document.querySelectorAll(".combat-content").forEach((e=>e.classList.remove("active"))),e.classList.add("active");const n=e.dataset.combat;null===(t=document.getElementById("combat_".concat(n,"_content")))||void 0===t||t.classList.add("active"),"battlebar"===n&&wo()}))}));const T=document.querySelectorAll(".mazemaster-tab"),B=document.querySelectorAll(".mazemaster-tab-content");T.forEach((e=>{e.addEventListener("click",(()=>{const t=e.dataset.tab;T.forEach((t=>t.classList.toggle("active",t===e))),B.forEach((e=>{const n=e.id==="mazemaster-tab-".concat(t);e.classList.toggle("active",n)}))}))}));const L=document.getElementById("mazemaster_play_maze");L&&L.addEventListener("click",(async()=>{const e=document.getElementById("mazemaster_play_profile"),t=(null==e?void 0:e.value)||Re.currentMazeProfile||"default";try{await d("/closechat")}catch(e){console.log("[MazeMaster] No active chat to close")}Ba(t)})),function(){const e=document.getElementById("mazemaster_llm_preset");if(e){e.innerHTML='<option value="">(Use Current)</option>';try{if("function"==typeof g){const t=g();if(t&&"function"==typeof t.getAllPresets){const n=t.getAllPresets();n.forEach((t=>{const n=document.createElement("option");n.value=t,n.textContent=t,t===Re.llmPreset&&(n.selected=!0),e.appendChild(n)})),console.log("[MazeMaster] Populated LLM preset dropdown with ".concat(n.length," presets"))}}}catch(e){console.warn("[MazeMaster] Could not populate LLM presets:",e)}}}();const A=document.getElementById("mazemaster_llm_preset");A&&A.addEventListener("change",(e=>{Re.llmPreset=e.target.value,i()}));const O=document.getElementById("mazemaster_llm_enabled");O&&O.addEventListener("change",(e=>{Re.llmEnabled=e.target.checked,i()}));const H=document.getElementById("mazemaster_close_chat");H&&H.addEventListener("change",(e=>{Re.closeChatOnStart=e.target.checked,i()}));const N=document.getElementById("mazemaster_dpad_enabled");N&&N.addEventListener("change",(e=>{Re.dpadConfig||(Re.dpadConfig={enabled:!0,floating:!0,position:{x:null,y:null}}),Re.dpadConfig.enabled=e.target.checked;const t=document.getElementById("maze_dpad");t&&(t.style.display=e.target.checked?"":"none"),i()}));const q=document.getElementById("mazemaster_dpad_floating");q&&q.addEventListener("change",(e=>{Re.dpadConfig||(Re.dpadConfig={enabled:!0,floating:!0,position:{x:null,y:null}}),Re.dpadConfig.floating=e.target.checked;const t=document.getElementById("maze_dpad");t&&(t.classList.toggle("floating",e.target.checked),e.target.checked&&re()),i()}));const F=document.getElementById("mazemaster_dpad_reset");F&&F.addEventListener("click",(()=>{Re.dpadConfig||(Re.dpadConfig={enabled:!0,floating:!0,position:{x:null,y:null}}),Re.dpadConfig.position={x:null,y:null},i();const e=document.getElementById("maze_dpad");e&&(e.style.left="",e.style.top="",e.style.right="20px",e.style.bottom="20px")}));const j=document.getElementById("mazemaster_renderer_type");j&&j.addEventListener("change",(e=>{Re.rendererType=e.target.value,D.getRenderer(e.target.value),i()}));const W=document.getElementById("mazemaster_layout_mode");W&&W.addEventListener("change",(e=>{Re.layoutMode=e.target.value,i(),R()}));const Y=document.getElementById("mazemaster_bb_profile_select");Y&&Y.addEventListener("change",(e=>{Re.currentBattlebarProfile=e.target.value,i(),function(){var e;const t=nt(null===(e=document.getElementById("mazemaster_bb_profile_select"))||void 0===e?void 0:e.value)||{},n=document.getElementById("mazemaster_bb_difficulty"),a=document.getElementById("mazemaster_bb_diff_val");if(n){let e=t.difficulty||5;e<=5&&_[e]&&(e=_[e]),n.value=e,a&&(a.textContent="(".concat(e,")"))}const o=document.getElementById("mazemaster_bb_damage");o&&(o.value=t.damage||25);const i=document.getElementById("mazemaster_bb_hits");i&&(i.value=t.hitsToWin||5);const s=document.getElementById("mazemaster_bb_misses");s&&(s.value=t.missesToLose||3);const r=document.getElementById("mazemaster_bb_hit_cmd");r&&(r.value=t.hitCommand||"");const l=document.getElementById("mazemaster_bb_miss_cmd");l&&(l.value=t.missCommand||"");const c=document.getElementById("mazemaster_bb_win_cmd");c&&(c.value=t.winCommand||"");const d=document.getElementById("mazemaster_bb_lose_cmd");d&&(d.value=t.loseCommand||"");const m=document.getElementById("mazemaster_bb_main_title");m&&(m.value=t.mainTitle||"")}(),wo()}));const G=document.getElementById("mazemaster_bb_new_profile_btn");G&&G.addEventListener("click",(async e=>{e.preventDefault(),e.stopPropagation();const t=await p("Enter new battlebar profile name:",u.INPUT,"");if(t&&t.trim()){const e=t.trim();Re.battlebarProfiles[e]?await p('Battlebar profile "'.concat(e,'" already exists.'),u.TEXT):(at(e,{}),Re.currentBattlebarProfile=e,i(),qo(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_combat"))||void 0===e||e.click()}),100))}}));const U=document.getElementById("mazemaster_bb_delete_profile_btn");U&&U.addEventListener("click",(async()=>{var e;const t=null===(e=document.getElementById("mazemaster_bb_profile_select"))||void 0===e?void 0:e.value;if(t){await p('Delete battlebar profile "'.concat(t,'"?'),u.CONFIRM)&&(!function(e){if(delete Re.battlebarProfiles[e],Re.currentBattlebarProfile===e){const e=tt();Re.currentBattlebarProfile=e[0]||"default"}i()}(t),qo(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_combat"))||void 0===e||e.click()}),100))}}));const K=document.getElementById("mazemaster_bb_rename_profile_btn");K&&K.addEventListener("click",(async()=>{var e;const t=null===(e=document.getElementById("mazemaster_bb_profile_select"))||void 0===e?void 0:e.value;if(!t)return void alert("No profile selected to rename");const n=await p("Enter new profile name:",u.INPUT,t);if(n&&n.trim()&&n.trim()!==t){const e=n.trim();if(Re.battlebarProfiles[e])return void alert("A profile with that name already exists");Re.battlebarProfiles[e]=Re.battlebarProfiles[t],delete Re.battlebarProfiles[t],Re.currentBattlebarProfile=e,i(),qo(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_combat"))||void 0===e||e.click()}),100)}}));const V=document.getElementById("mazemaster_bb_export_btn");V&&V.addEventListener("click",(()=>{var e;const t=null===(e=document.getElementById("mazemaster_bb_profile_select"))||void 0===e?void 0:e.value;t?function(e){const t=nt(e);if(!t)return void alert('Battlebar profile "'.concat(e,'" not found'));const n={name:e,type:"battlebar",profile:t,exportedAt:(new Date).toISOString(),version:"1.0"},a=JSON.stringify(n,null,2),o=new Blob([a],{type:"application/json"}),i=URL.createObjectURL(o),s=document.createElement("a");s.href=i,s.download="mazemaster-battlebar-".concat(e,".json"),document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(i),console.log('[MazeMaster] Exported battlebar profile "'.concat(e,'"'))}(t):alert("No profile selected to export")}));const X=document.getElementById("mazemaster_bb_import_btn"),J=document.getElementById("mazemaster_bb_import_file");X&&J&&(X.addEventListener("click",(()=>{J.click()})),J.addEventListener("change",(async e=>{var t;const n=null===(t=e.target.files)||void 0===t?void 0:t[0];if(n){try{var a;const e=await function(e){return new Promise(((t,n)=>{const a=new FileReader;a.onload=e=>{try{const a=JSON.parse(e.target.result);if(!a.profile||!a.name)return void n(new Error("Invalid profile format: missing name or profile data"));let o=a.name;if(Re.battlebarProfiles[o]){const e=prompt('Battlebar profile "'.concat(o,'" already exists. Enter a new name:'),"".concat(o,"_imported"));if(!e||!e.trim())return void n(new Error("Import cancelled"));o=e.trim()}at(o,a.profile),Re.currentBattlebarProfile=o,i(),console.log('[MazeMaster] Imported battlebar profile "'.concat(o,'":'),a.profile),t(o)}catch(e){n(new Error("Failed to parse JSON: ".concat(e.message)))}},a.onerror=()=>n(new Error("Failed to read file")),a.readAsText(e)}))}(n);alert('Battlebar profile "'.concat(e,'" imported successfully!')),qo(),null===(a=document.getElementById("mazemaster_show_combat"))||void 0===a||a.click()}catch(e){alert("Import failed: ".concat(e.message))}J.value=""}})));const Q=document.getElementById("mazemaster_bb_save_btn");Q&&Q.addEventListener("click",(()=>{var e;const t=null===(e=document.getElementById("mazemaster_bb_profile_select"))||void 0===e?void 0:e.value;if(!t)return void alert("Please create a battlebar profile first");const n=function(){var e,t,n,a,o,i,s,r,l,c,d,m,p,u,h,g;const f=nt(null===(e=document.getElementById("mazemaster_bb_profile_select"))||void 0===e?void 0:e.value)||{};return{difficulty:parseInt(null===(t=document.getElementById("mazemaster_bb_difficulty"))||void 0===t?void 0:t.value)||5,damage:parseInt(null===(n=document.getElementById("mazemaster_bb_damage"))||void 0===n?void 0:n.value)||25,hitsToWin:parseInt(null===(a=document.getElementById("mazemaster_bb_hits"))||void 0===a?void 0:a.value)||5,missesToLose:parseInt(null===(o=document.getElementById("mazemaster_bb_misses"))||void 0===o?void 0:o.value)||3,mainTitle:(null===(i=document.getElementById("mazemaster_bb_main_title"))||void 0===i?void 0:i.value)||"",hitCommand:(null===(s=document.getElementById("mazemaster_bb_hit_cmd"))||void 0===s?void 0:s.value)||"",missCommand:(null===(r=document.getElementById("mazemaster_bb_miss_cmd"))||void 0===r?void 0:r.value)||"",winCommand:(null===(l=document.getElementById("mazemaster_bb_win_cmd"))||void 0===l?void 0:l.value)||"",loseCommand:(null===(c=document.getElementById("mazemaster_bb_lose_cmd"))||void 0===c?void 0:c.value)||"",images:f.images||[],keyDropChance:null!==(d=parseInt(null===(m=document.getElementById("mazemaster_bb_key_drop"))||void 0===m?void 0:m.value))&&void 0!==d?d:40,strikeDropChance:null!==(p=parseInt(null===(u=document.getElementById("mazemaster_bb_pow_drop"))||void 0===u?void 0:u.value))&&void 0!==p?p:20,stealthDropChance:null!==(h=parseInt(null===(g=document.getElementById("mazemaster_bb_stealth_drop"))||void 0===g?void 0:g.value))&&void 0!==h?h:10}}(),a=[];(!n.hitsToWin||n.hitsToWin<1)&&a.push("Hits to Win must be at least 1"),(!n.missesToLose||n.missesToLose<1)&&a.push("Misses to Lose must be at least 1"),(!n.difficulty||n.difficulty<1||n.difficulty>10)&&a.push("Difficulty must be between 1 and 10"),a.length>0?alert("Validation Error:\n\n"+a.join("\n")):(at(t,n),alert('Battlebar profile "'.concat(t,'" saved!')))}));const Z=document.getElementById("mazemaster_bb_difficulty"),$=document.getElementById("mazemaster_bb_diff_val");Z&&$&&Z.addEventListener("input",(e=>{$.textContent="(".concat(e.target.value,")")}));const ee=document.getElementById("mazemaster_bb_add_image_btn"),te=document.getElementById("mazemaster_bb_image_file");ee&&te&&(ee.addEventListener("click",(()=>{te.click()})),te.addEventListener("change",(async e=>{var t,n;const a=null===(t=e.target.files)||void 0===t?void 0:t[0];if(!a)return;const o=null===(n=document.getElementById("mazemaster_bb_profile_select"))||void 0===n?void 0:n.value;if(!o)return alert("Please create a profile first"),void(te.value="");try{const e=await async function(e,t){return new Promise(((n,a)=>{const o=new FileReader;o.onload=async o=>{try{const i=o.target.result.split(",")[1],s=e.name.split(".").pop().toLowerCase(),r=Date.now(),l="battlebar_".concat(t,"_").concat(r),c=await fetch("/api/images/upload",{method:"POST",headers:m(),body:JSON.stringify({image:i,ch_name:"MazeMaster",filename:l,format:s})});if(c.ok)n("user/images/MazeMaster/".concat(l,".").concat(s));else{const e=await c.json().catch((()=>({})));a(new Error(e.error||"Upload failed"))}}catch(e){a(e)}},o.onerror=()=>a(new Error("Failed to read file")),o.readAsDataURL(e)}))}(a,o),t=nt(o)||{},n=t.images||[];n.push({path:e,name:a.name}),t.images=n,at(o,t),wo()}catch(e){alert("Image upload failed: ".concat(e.message))}te.value=""})));const ne=document.getElementById("mazemaster_tb_profile_select");ne&&ne.addEventListener("change",(e=>{Re.currentTurnbasedProfile=e.target.value,i(),de(e.target.value)}));const ae=document.getElementById("mazemaster_tb_new_profile_btn");ae&&ae.addEventListener("click",(async e=>{e.preventDefault(),e.stopPropagation();const n=await p("Enter new Turn-Based profile name:",u.INPUT,"");if(n&&n.trim()){const e=n.trim();if(Re.turnbasedProfiles[e])await p('Turn-Based profile "'.concat(e,'" already exists.'),u.TEXT);else{st(e,t(t({},it("Training Bout")||{}),{},{mainTitle:e})),Re.currentTurnbasedProfile=e,i(),qo(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_combat"))||void 0===e||e.click(),setTimeout((()=>{var e;null===(e=document.querySelector('[data-combat="turnbased"]'))||void 0===e||e.click()}),50)}),100)}}}));const oe=document.getElementById("mazemaster_tb_delete_profile_btn");oe&&oe.addEventListener("click",(async()=>{var e;const t=null===(e=document.getElementById("mazemaster_tb_profile_select"))||void 0===e?void 0:e.value;if(t){await p('Delete Turn-Based profile "'.concat(t,'"?'),u.CONFIRM)&&(!function(e){var t;if(null===(t=Re.turnbasedProfiles)||void 0===t||delete t[e],Re.currentTurnbasedProfile===e){const e=ot();Re.currentTurnbasedProfile=e[0]||""}i()}(t),qo(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_combat"))||void 0===e||e.click(),setTimeout((()=>{var e;null===(e=document.querySelector('[data-combat="turnbased"]'))||void 0===e||e.click()}),50)}),100))}}));const ie=document.getElementById("mazemaster_tb_rename_profile_btn");ie&&ie.addEventListener("click",(async()=>{var e;const t=null===(e=document.getElementById("mazemaster_tb_profile_select"))||void 0===e?void 0:e.value;if(!t)return void alert("No profile selected to rename");const n=await p("Enter new profile name:",u.INPUT,t);if(n&&n.trim()&&n.trim()!==t){const e=n.trim();if(Re.turnbasedProfiles[e])return void await p('Profile "'.concat(e,'" already exists.'),u.TEXT);Re.turnbasedProfiles[e]=Re.turnbasedProfiles[t],delete Re.turnbasedProfiles[t],Re.currentTurnbasedProfile=e,i(),qo(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_combat"))||void 0===e||e.click(),setTimeout((()=>{var e;null===(e=document.querySelector('[data-combat="turnbased"]'))||void 0===e||e.click()}),50)}),100)}}));const se=document.getElementById("mazemaster_tb_difficulty"),le=document.getElementById("mazemaster_tb_diff_val");se&&le&&se.addEventListener("input",(e=>{le.textContent="(".concat(e.target.value,")")}));const ce=document.getElementById("mazemaster_tb_save_btn");function de(e){const t=it(e)||{},n=(e,t)=>{const n=document.getElementById(e);n&&(n.value=null!=t?t:"")};n("mazemaster_tb_main_title",t.mainTitle),n("mazemaster_tb_enemy_name",t.enemyName),n("mazemaster_tb_description",t.description),n("mazemaster_tb_player_hp",t.playerHP||100),n("mazemaster_tb_player_attack",t.playerAttack||15),n("mazemaster_tb_player_defense",t.playerDefense||5),n("mazemaster_tb_enemy_hp",t.enemyHP||50),n("mazemaster_tb_enemy_attack",t.enemyAttack||8),n("mazemaster_tb_enemy_defense",t.enemyDefense||2),n("mazemaster_tb_turn_order",t.turnOrder||"player_first"),n("mazemaster_tb_flee_chance",t.fleeChance||50),n("mazemaster_tb_crit_chance",t.critChance||15),n("mazemaster_tb_crit_mult",t.critMultiplier||1.5),n("mazemaster_tb_difficulty",t.difficulty||5),n("mazemaster_tb_damage",t.damage||15),n("mazemaster_tb_on_win",t.onWin),n("mazemaster_tb_on_lose",t.onLose),n("mazemaster_tb_key_drop",t.keyDropChance||30),n("mazemaster_tb_strike_drop",t.strikeDropChance||15),n("mazemaster_tb_stealth_drop",t.stealthDropChance||10),n("mazemaster_tb_potion_drop",t.healingPotionDropChance||25);const a=document.getElementById("mazemaster_tb_diff_val");a&&(a.textContent="(".concat(t.difficulty||5,")"))}ce&&ce.addEventListener("click",(()=>{var e,t,n,a,o,i,s,r,l,c,d,m,p,u,h,g,f,v,b,y,z,x;const _=null===(e=document.getElementById("mazemaster_tb_profile_select"))||void 0===e?void 0:e.value;if(!_)return void alert("Please create a Turn-Based profile first");st(_,{mainTitle:(null===(t=document.getElementById("mazemaster_tb_main_title"))||void 0===t?void 0:t.value)||"",enemyName:(null===(n=document.getElementById("mazemaster_tb_enemy_name"))||void 0===n?void 0:n.value)||"Enemy",description:(null===(a=document.getElementById("mazemaster_tb_description"))||void 0===a?void 0:a.value)||"",playerHP:parseInt(null===(o=document.getElementById("mazemaster_tb_player_hp"))||void 0===o?void 0:o.value)||100,playerAttack:parseInt(null===(i=document.getElementById("mazemaster_tb_player_attack"))||void 0===i?void 0:i.value)||15,playerDefense:parseInt(null===(s=document.getElementById("mazemaster_tb_player_defense"))||void 0===s?void 0:s.value)||5,enemyHP:parseInt(null===(r=document.getElementById("mazemaster_tb_enemy_hp"))||void 0===r?void 0:r.value)||50,enemyAttack:parseInt(null===(l=document.getElementById("mazemaster_tb_enemy_attack"))||void 0===l?void 0:l.value)||8,enemyDefense:parseInt(null===(c=document.getElementById("mazemaster_tb_enemy_defense"))||void 0===c?void 0:c.value)||2,turnOrder:(null===(d=document.getElementById("mazemaster_tb_turn_order"))||void 0===d?void 0:d.value)||"player_first",fleeChance:parseInt(null===(m=document.getElementById("mazemaster_tb_flee_chance"))||void 0===m?void 0:m.value)||50,critChance:parseInt(null===(p=document.getElementById("mazemaster_tb_crit_chance"))||void 0===p?void 0:p.value)||15,critMultiplier:parseFloat(null===(u=document.getElementById("mazemaster_tb_crit_mult"))||void 0===u?void 0:u.value)||1.5,difficulty:parseInt(null===(h=document.getElementById("mazemaster_tb_difficulty"))||void 0===h?void 0:h.value)||5,damage:parseInt(null===(g=document.getElementById("mazemaster_tb_damage"))||void 0===g?void 0:g.value)||15,onWin:(null===(f=document.getElementById("mazemaster_tb_on_win"))||void 0===f?void 0:f.value)||"",onLose:(null===(v=document.getElementById("mazemaster_tb_on_lose"))||void 0===v?void 0:v.value)||"",keyDropChance:parseInt(null===(b=document.getElementById("mazemaster_tb_key_drop"))||void 0===b?void 0:b.value)||30,strikeDropChance:parseInt(null===(y=document.getElementById("mazemaster_tb_strike_drop"))||void 0===y?void 0:y.value)||15,stealthDropChance:parseInt(null===(z=document.getElementById("mazemaster_tb_stealth_drop"))||void 0===z?void 0:z.value)||10,healingPotionDropChance:parseInt(null===(x=document.getElementById("mazemaster_tb_potion_drop"))||void 0===x?void 0:x.value)||25}),alert('Turn-Based profile "'.concat(_,'" saved!'))})),Re.currentTurnbasedProfile&&de(Re.currentTurnbasedProfile);const me=document.getElementById("mazemaster_qte_profile_select");me&&me.addEventListener("change",(e=>{Re.currentQteProfile=e.target.value,i(),ye(e.target.value)}));const pe=document.getElementById("mazemaster_qte_new_profile_btn");pe&&pe.addEventListener("click",(async e=>{e.preventDefault(),e.stopPropagation();const n=await p("Enter new QTE profile name:",u.INPUT,"");if(n&&n.trim()){const e=n.trim();if(Re.qteProfiles[e])await p('QTE profile "'.concat(e,'" already exists.'),u.TEXT);else{ct(e,t(t({},lt("Reaction Test")||{}),{},{mainTitle:e})),Re.currentQteProfile=e,i(),qo(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_combat"))||void 0===e||e.click(),setTimeout((()=>{var e;null===(e=document.querySelector('[data-combat="qte"]'))||void 0===e||e.click()}),50)}),100)}}}));const ue=document.getElementById("mazemaster_qte_delete_profile_btn");ue&&ue.addEventListener("click",(async()=>{var e;const t=null===(e=document.getElementById("mazemaster_qte_profile_select"))||void 0===e?void 0:e.value;if(t){await p('Delete QTE profile "'.concat(t,'"?'),u.CONFIRM)&&(!function(e){var t;if(null===(t=Re.qteProfiles)||void 0===t||delete t[e],Re.currentQteProfile===e){const e=rt();Re.currentQteProfile=e[0]||""}i()}(t),qo(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_combat"))||void 0===e||e.click(),setTimeout((()=>{var e;null===(e=document.querySelector('[data-combat="qte"]'))||void 0===e||e.click()}),50)}),100))}}));const he=document.getElementById("mazemaster_qte_rename_profile_btn");he&&he.addEventListener("click",(async()=>{var e;const t=null===(e=document.getElementById("mazemaster_qte_profile_select"))||void 0===e?void 0:e.value;if(!t)return void alert("No profile selected to rename");const n=await p("Enter new profile name:",u.INPUT,t);if(n&&n.trim()&&n.trim()!==t){const e=n.trim();if(Re.qteProfiles[e])return void alert("A profile with that name already exists");Re.qteProfiles[e]=Re.qteProfiles[t],Re.qteProfiles[e].mainTitle=e,delete Re.qteProfiles[t],Re.currentQteProfile=e,i(),qo(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_combat"))||void 0===e||e.click(),setTimeout((()=>{var e;null===(e=document.querySelector('[data-combat="qte"]'))||void 0===e||e.click()}),50)}),100)}}));const ge=document.getElementById("mazemaster_preview_qte_btn");ge&&ge.addEventListener("click",(()=>{var e;const t=null===(e=document.getElementById("mazemaster_qte_profile_select"))||void 0===e?void 0:e.value;if(!t)return void alert("Please select a QTE profile first");const n=Jt(t);n.error&&alert("Error: ".concat(n.error))}));const fe=document.getElementById("mazemaster_qte_difficulty"),ve=document.getElementById("mazemaster_qte_diff_val");fe&&ve&&fe.addEventListener("input",(e=>{ve.textContent="(".concat(e.target.value,")")}));const be=document.getElementById("mazemaster_qte_save_btn");function ye(e){const t=lt(e)||{},n=(e,t)=>{const n=document.getElementById(e);n&&(n.value=null!=t?t:"")},a=(e,t)=>{const n=document.getElementById(e);n&&(n.checked=t)};n("mazemaster_qte_main_title",t.mainTitle),n("mazemaster_qte_description",t.description),n("mazemaster_qte_seq_min",t.sequenceLengthMin||3),n("mazemaster_qte_seq_max",t.sequenceLengthMax||5),n("mazemaster_qte_time_base",t.timeWindowBase||1500),n("mazemaster_qte_time_min",t.timeWindowMin||800),n("mazemaster_qte_difficulty",t.difficulty||5),n("mazemaster_qte_damage",t.damage||10),n("mazemaster_qte_perfect",t.perfectWindowPercent||30),n("mazemaster_qte_on_complete",t.onComplete),n("mazemaster_qte_on_fail",t.onFail);const o=t.allowedKeys||["W","A","S","D","SPACE"];a("mazemaster_qte_key_w",o.includes("W")),a("mazemaster_qte_key_a",o.includes("A")),a("mazemaster_qte_key_s",o.includes("S")),a("mazemaster_qte_key_d",o.includes("D")),a("mazemaster_qte_key_space",o.includes("SPACE"));const i=document.getElementById("mazemaster_qte_diff_val");i&&(i.textContent="(".concat(t.difficulty||5,")"))}be&&be.addEventListener("click",(()=>{var e,t,n,a,o,i,s,r,l,c,d,m,p,u,h,g,f;const v=null===(e=document.getElementById("mazemaster_qte_profile_select"))||void 0===e?void 0:e.value;if(!v)return void alert("Please create a QTE profile first");const b=[];null!==(t=document.getElementById("mazemaster_qte_key_w"))&&void 0!==t&&t.checked&&b.push("W"),null!==(n=document.getElementById("mazemaster_qte_key_a"))&&void 0!==n&&n.checked&&b.push("A"),null!==(a=document.getElementById("mazemaster_qte_key_s"))&&void 0!==a&&a.checked&&b.push("S"),null!==(o=document.getElementById("mazemaster_qte_key_d"))&&void 0!==o&&o.checked&&b.push("D"),null!==(i=document.getElementById("mazemaster_qte_key_space"))&&void 0!==i&&i.checked&&b.push("SPACE");ct(v,{mainTitle:(null===(s=document.getElementById("mazemaster_qte_main_title"))||void 0===s?void 0:s.value)||"",description:(null===(r=document.getElementById("mazemaster_qte_description"))||void 0===r?void 0:r.value)||"",sequenceLengthMin:parseInt(null===(l=document.getElementById("mazemaster_qte_seq_min"))||void 0===l?void 0:l.value)||3,sequenceLengthMax:parseInt(null===(c=document.getElementById("mazemaster_qte_seq_max"))||void 0===c?void 0:c.value)||5,timeWindowBase:parseInt(null===(d=document.getElementById("mazemaster_qte_time_base"))||void 0===d?void 0:d.value)||1500,timeWindowMin:parseInt(null===(m=document.getElementById("mazemaster_qte_time_min"))||void 0===m?void 0:m.value)||800,difficulty:parseInt(null===(p=document.getElementById("mazemaster_qte_difficulty"))||void 0===p?void 0:p.value)||5,damage:parseInt(null===(u=document.getElementById("mazemaster_qte_damage"))||void 0===u?void 0:u.value)||10,perfectWindowPercent:parseInt(null===(h=document.getElementById("mazemaster_qte_perfect"))||void 0===h?void 0:h.value)||30,allowedKeys:b,onComplete:(null===(g=document.getElementById("mazemaster_qte_on_complete"))||void 0===g?void 0:g.value)||"",onFail:(null===(f=document.getElementById("mazemaster_qte_on_fail"))||void 0===f?void 0:f.value)||""}),alert('QTE profile "'.concat(v,'" saved!'))})),Re.currentQteProfile&&ye(Re.currentQteProfile);const ze=document.getElementById("mazemaster_dice_profile_select");ze&&ze.addEventListener("change",(e=>{Re.currentDiceProfile=e.target.value,i(),Ee(e.target.value)}));const xe=document.getElementById("mazemaster_dice_new_profile_btn");xe&&xe.addEventListener("click",(async e=>{e.preventDefault(),e.stopPropagation();const n=await p("Enter new Dice profile name:",u.INPUT,"");if(n&&n.trim()){const e=n.trim();if(Re.diceProfiles[e])await p('Dice profile "'.concat(e,'" already exists.'),u.TEXT);else{pt(e,t(t({},mt("Lucky Roll")||{}),{},{mainTitle:e})),Re.currentDiceProfile=e,i(),qo(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_combat"))||void 0===e||e.click(),setTimeout((()=>{var e;null===(e=document.querySelector('[data-combat="dice"]'))||void 0===e||e.click()}),50)}),100)}}}));const _e=document.getElementById("mazemaster_dice_delete_profile_btn");_e&&_e.addEventListener("click",(async()=>{var e;const t=null===(e=document.getElementById("mazemaster_dice_profile_select"))||void 0===e?void 0:e.value;if(t){await p('Delete Dice profile "'.concat(t,'"?'),u.CONFIRM)&&(!function(e){var t;if(null===(t=Re.diceProfiles)||void 0===t||delete t[e],Re.currentDiceProfile===e){const e=dt();Re.currentDiceProfile=e[0]||""}i()}(t),qo(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_combat"))||void 0===e||e.click(),setTimeout((()=>{var e;null===(e=document.querySelector('[data-combat="dice"]'))||void 0===e||e.click()}),50)}),100))}}));const we=document.getElementById("mazemaster_dice_rename_profile_btn");we&&we.addEventListener("click",(async()=>{var e;const t=null===(e=document.getElementById("mazemaster_dice_profile_select"))||void 0===e?void 0:e.value;if(!t)return void alert("No profile selected to rename");const n=await p("Enter new profile name:",u.INPUT,t);if(n&&n.trim()&&n.trim()!==t){const e=n.trim();if(Re.diceProfiles[e])return void alert("A profile with that name already exists");Re.diceProfiles[e]=Re.diceProfiles[t],Re.diceProfiles[e].mainTitle=e,delete Re.diceProfiles[t],Re.currentDiceProfile=e,i(),qo(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_combat"))||void 0===e||e.click(),setTimeout((()=>{var e;null===(e=document.querySelector('[data-combat="dice"]'))||void 0===e||e.click()}),50)}),100)}}));const ke=document.getElementById("mazemaster_preview_dice_btn");ke&&ke.addEventListener("click",(()=>{var e;const t=null===(e=document.getElementById("mazemaster_dice_profile_select"))||void 0===e?void 0:e.value;if(!t)return void alert("Please select a Dice profile first");const n=sn(t);n.error&&alert("Error: ".concat(n.error))}));const Ce=document.getElementById("mazemaster_dice_difficulty"),Se=document.getElementById("mazemaster_dice_diff_val");Ce&&Se&&Ce.addEventListener("input",(e=>{Se.textContent="(".concat(e.target.value,")")}));const Me=document.getElementById("mazemaster_dice_save_btn");function Ee(e){const t=mt(e)||{},n=(e,t)=>{const n=document.getElementById(e);n&&(n.value=null!=t?t:"")};n("mazemaster_dice_main_title",t.mainTitle),n("mazemaster_dice_description",t.description),n("mazemaster_dice_count",t.diceCount||2),n("mazemaster_dice_type",t.diceType||6),n("mazemaster_dice_target",t.targetNumber||7),n("mazemaster_dice_modifier",t.modifier||0),n("mazemaster_dice_difficulty",t.difficulty||5),n("mazemaster_dice_damage",t.damage||15),n("mazemaster_dice_rerolls",t.rerolls||1),n("mazemaster_dice_on_success",t.onSuccess),n("mazemaster_dice_on_fail",t.onFail),n("mazemaster_dice_on_crit",t.onCritical);const a=document.getElementById("mazemaster_dice_diff_val");a&&(a.textContent="(".concat(t.difficulty||5,")"))}Me&&Me.addEventListener("click",(()=>{var e,t,n,a,o,i,s,r,l,c,d,m,p;const u=null===(e=document.getElementById("mazemaster_dice_profile_select"))||void 0===e?void 0:e.value;if(!u)return void alert("Please create a Dice profile first");pt(u,{mainTitle:(null===(t=document.getElementById("mazemaster_dice_main_title"))||void 0===t?void 0:t.value)||"",description:(null===(n=document.getElementById("mazemaster_dice_description"))||void 0===n?void 0:n.value)||"",diceCount:parseInt(null===(a=document.getElementById("mazemaster_dice_count"))||void 0===a?void 0:a.value)||2,diceType:parseInt(null===(o=document.getElementById("mazemaster_dice_type"))||void 0===o?void 0:o.value)||6,targetNumber:parseInt(null===(i=document.getElementById("mazemaster_dice_target"))||void 0===i?void 0:i.value)||7,modifier:parseInt(null===(s=document.getElementById("mazemaster_dice_modifier"))||void 0===s?void 0:s.value)||0,difficulty:parseInt(null===(r=document.getElementById("mazemaster_dice_difficulty"))||void 0===r?void 0:r.value)||5,damage:parseInt(null===(l=document.getElementById("mazemaster_dice_damage"))||void 0===l?void 0:l.value)||15,rerolls:parseInt(null===(c=document.getElementById("mazemaster_dice_rerolls"))||void 0===c?void 0:c.value)||1,onSuccess:(null===(d=document.getElementById("mazemaster_dice_on_success"))||void 0===d?void 0:d.value)||"",onFail:(null===(m=document.getElementById("mazemaster_dice_on_fail"))||void 0===m?void 0:m.value)||"",onCritical:(null===(p=document.getElementById("mazemaster_dice_on_crit"))||void 0===p?void 0:p.value)||""}),alert('Dice profile "'.concat(u,'" saved!'))})),Re.currentDiceProfile&&Ee(Re.currentDiceProfile);const Pe=document.getElementById("mazemaster_stealth_profile_select");Pe&&Pe.addEventListener("change",(e=>{Re.currentStealthProfile=e.target.value,i(),He(e.target.value)}));const Ie=document.getElementById("mazemaster_stealth_new_profile_btn");Ie&&Ie.addEventListener("click",(async e=>{e.preventDefault(),e.stopPropagation();const n=await p("Enter new Stealth profile name:",u.INPUT,"");if(n&&n.trim()){const e=n.trim();if(Re.stealthProfiles[e])await p('Stealth profile "'.concat(e,'" already exists.'),u.TEXT);else{gt(e,t(t({},ht("Simple Sneak")||{}),{},{mainTitle:e})),Re.currentStealthProfile=e,i(),qo(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_combat"))||void 0===e||e.click(),setTimeout((()=>{var e;null===(e=document.querySelector('[data-combat="stealth"]'))||void 0===e||e.click()}),50)}),100)}}}));const Te=document.getElementById("mazemaster_stealth_delete_profile_btn");Te&&Te.addEventListener("click",(async()=>{var e;const t=null===(e=document.getElementById("mazemaster_stealth_profile_select"))||void 0===e?void 0:e.value;if(t){await p('Delete Stealth profile "'.concat(t,'"?'),u.CONFIRM)&&(!function(e){var t;if(null===(t=Re.stealthProfiles)||void 0===t||delete t[e],Re.currentStealthProfile===e){const e=ut();Re.currentStealthProfile=e[0]||""}i()}(t),qo(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_combat"))||void 0===e||e.click(),setTimeout((()=>{var e;null===(e=document.querySelector('[data-combat="stealth"]'))||void 0===e||e.click()}),50)}),100))}}));const Be=document.getElementById("mazemaster_stealth_rename_profile_btn");Be&&Be.addEventListener("click",(async()=>{var e;const t=null===(e=document.getElementById("mazemaster_stealth_profile_select"))||void 0===e?void 0:e.value;if(!t)return void alert("No profile selected to rename");const n=await p("Enter new profile name:",u.INPUT,t);if(n&&n.trim()&&n.trim()!==t){const e=n.trim();if(Re.stealthProfiles[e])return void alert("A profile with that name already exists");Re.stealthProfiles[e]=Re.stealthProfiles[t],Re.stealthProfiles[e].mainTitle=e,delete Re.stealthProfiles[t],Re.currentStealthProfile=e,i(),qo(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_combat"))||void 0===e||e.click(),setTimeout((()=>{var e;null===(e=document.querySelector('[data-combat="stealth"]'))||void 0===e||e.click()}),50)}),100)}}));const De=document.getElementById("mazemaster_preview_stealth_btn");De&&De.addEventListener("click",(()=>{var e;const t=null===(e=document.getElementById("mazemaster_stealth_profile_select"))||void 0===e?void 0:e.value;if(!t)return void alert("Please select a Stealth profile first");const n=un(t);n.error&&alert("Error: ".concat(n.error))}));const Le=document.getElementById("mazemaster_stealth_difficulty"),Ae=document.getElementById("mazemaster_stealth_diff_val");Le&&Ae&&Le.addEventListener("input",(e=>{Ae.textContent="(".concat(e.target.value,")")}));const Oe=document.getElementById("mazemaster_stealth_save_btn");function He(e){const t=ht(e)||{},n=(e,t)=>{const n=document.getElementById(e);n&&(n.value=null!=t?t:"")};n("mazemaster_stealth_main_title",t.mainTitle),n("mazemaster_stealth_guard_name",t.guardName||"Guard"),n("mazemaster_stealth_description",t.description),n("mazemaster_stealth_sections",t.sections||3),n("mazemaster_stealth_detection_limit",t.detectionLimit||100),n("mazemaster_stealth_base_detection",t.baseDetection||15),n("mazemaster_stealth_damage",t.damage||20),n("mazemaster_stealth_difficulty",t.difficulty||5),n("mazemaster_stealth_hide_reduce",t.hideReduction||10),n("mazemaster_stealth_distract_max",t.distractMax||25),n("mazemaster_stealth_on_success",t.onSuccess),n("mazemaster_stealth_on_caught",t.onCaught);const a=document.getElementById("mazemaster_stealth_diff_val");a&&(a.textContent="(".concat(t.difficulty||5,")"))}Oe&&Oe.addEventListener("click",(()=>{var e,t,n,a,o,i,s,r,l,c,d,m,p;const u=null===(e=document.getElementById("mazemaster_stealth_profile_select"))||void 0===e?void 0:e.value;if(!u)return void alert("Please create a Stealth profile first");gt(u,{mainTitle:(null===(t=document.getElementById("mazemaster_stealth_main_title"))||void 0===t?void 0:t.value)||"",guardName:(null===(n=document.getElementById("mazemaster_stealth_guard_name"))||void 0===n?void 0:n.value)||"Guard",description:(null===(a=document.getElementById("mazemaster_stealth_description"))||void 0===a?void 0:a.value)||"",sections:parseInt(null===(o=document.getElementById("mazemaster_stealth_sections"))||void 0===o?void 0:o.value)||3,detectionLimit:parseInt(null===(i=document.getElementById("mazemaster_stealth_detection_limit"))||void 0===i?void 0:i.value)||100,baseDetection:parseInt(null===(s=document.getElementById("mazemaster_stealth_base_detection"))||void 0===s?void 0:s.value)||15,damage:parseInt(null===(r=document.getElementById("mazemaster_stealth_damage"))||void 0===r?void 0:r.value)||20,difficulty:parseInt(null===(l=document.getElementById("mazemaster_stealth_difficulty"))||void 0===l?void 0:l.value)||5,hideReduction:parseInt(null===(c=document.getElementById("mazemaster_stealth_hide_reduce"))||void 0===c?void 0:c.value)||10,distractMax:parseInt(null===(d=document.getElementById("mazemaster_stealth_distract_max"))||void 0===d?void 0:d.value)||25,onSuccess:(null===(m=document.getElementById("mazemaster_stealth_on_success"))||void 0===m?void 0:m.value)||"",onCaught:(null===(p=document.getElementById("mazemaster_stealth_on_caught"))||void 0===p?void 0:p.value)||""}),alert('Stealth profile "'.concat(u,'" saved!'))})),Re.currentStealthProfile&&He(Re.currentStealthProfile);const Ne=document.getElementById("mazemaster_puzzle_profile_select");Ne&&Ne.addEventListener("change",(e=>{Re.currentPuzzleProfile=e.target.value,i(),Ke(e.target.value)}));const qe=document.getElementById("mazemaster_puzzle_new_profile_btn");qe&&qe.addEventListener("click",(async e=>{e.preventDefault(),e.stopPropagation();const n=await p("Enter new Puzzle profile name:",u.INPUT,"");if(n&&n.trim()){const e=n.trim();if(Re.puzzleProfiles[e])await p('Puzzle profile "'.concat(e,'" already exists.'),u.TEXT);else{bt(e,t(t({},vt("Simple Riddle")||{}),{},{mainTitle:e})),Re.currentPuzzleProfile=e,i(),qo(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_combat"))||void 0===e||e.click(),setTimeout((()=>{var e;null===(e=document.querySelector('[data-combat="puzzle"]'))||void 0===e||e.click()}),50)}),100)}}}));const Fe=document.getElementById("mazemaster_puzzle_delete_profile_btn");Fe&&Fe.addEventListener("click",(async()=>{var e;const t=null===(e=document.getElementById("mazemaster_puzzle_profile_select"))||void 0===e?void 0:e.value;if(t){await p('Delete Puzzle profile "'.concat(t,'"?'),u.CONFIRM)&&(!function(e){var t;if(null===(t=Re.puzzleProfiles)||void 0===t||delete t[e],Re.currentPuzzleProfile===e){const e=ft();Re.currentPuzzleProfile=e[0]||""}i()}(t),qo(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_combat"))||void 0===e||e.click(),setTimeout((()=>{var e;null===(e=document.querySelector('[data-combat="puzzle"]'))||void 0===e||e.click()}),50)}),100))}}));const je=document.getElementById("mazemaster_puzzle_rename_profile_btn");je&&je.addEventListener("click",(async()=>{var e;const t=null===(e=document.getElementById("mazemaster_puzzle_profile_select"))||void 0===e?void 0:e.value;if(!t)return void alert("No profile selected to rename");const n=await p("Enter new profile name:",u.INPUT,t);if(n&&n.trim()&&n.trim()!==t){const e=n.trim();if(Re.puzzleProfiles[e])return void alert("A profile with that name already exists");Re.puzzleProfiles[e]=Re.puzzleProfiles[t],Re.puzzleProfiles[e].mainTitle=e,delete Re.puzzleProfiles[t],Re.currentPuzzleProfile=e,i(),qo(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_combat"))||void 0===e||e.click(),setTimeout((()=>{var e;null===(e=document.querySelector('[data-combat="puzzle"]'))||void 0===e||e.click()}),50)}),100)}}));const We=document.getElementById("mazemaster_preview_puzzle_btn");We&&We.addEventListener("click",(()=>{var e;const t=null===(e=document.getElementById("mazemaster_puzzle_profile_select"))||void 0===e?void 0:e.value;if(!t)return void alert("Please select a Puzzle profile first");const n=yn(t);n.error&&alert("Error: ".concat(n.error))}));const Ye=document.getElementById("mazemaster_puzzle_difficulty"),Ge=document.getElementById("mazemaster_puzzle_diff_val");Ye&&Ge&&Ye.addEventListener("input",(e=>{Ge.textContent="(".concat(e.target.value,")")}));const Ue=document.getElementById("mazemaster_puzzle_save_btn");function Ke(e){const t=vt(e)||{},n=(e,t)=>{const n=document.getElementById(e);n&&(n.value=null!=t?t:"")};n("mazemaster_puzzle_main_title",t.mainTitle),n("mazemaster_puzzle_description",t.description),n("mazemaster_puzzle_grid_size",t.gridSize||3),n("mazemaster_puzzle_seq_length",t.sequenceLength||4),n("mazemaster_puzzle_max_mistakes",t.maxMistakes||5),n("mazemaster_puzzle_hints",t.hints||3),n("mazemaster_puzzle_difficulty",t.difficulty||5),n("mazemaster_puzzle_damage",t.damage||15),n("mazemaster_puzzle_time_limit",t.timeLimit||60),n("mazemaster_puzzle_on_solve",t.onSolve),n("mazemaster_puzzle_on_fail",t.onFail);const a=document.getElementById("mazemaster_puzzle_diff_val");a&&(a.textContent="(".concat(t.difficulty||5,")"))}Ue&&Ue.addEventListener("click",(()=>{var e,t,n,a,o,i,s,r,l,c,d,m;const p=null===(e=document.getElementById("mazemaster_puzzle_profile_select"))||void 0===e?void 0:e.value;if(!p)return void alert("Please create a Puzzle profile first");bt(p,{mainTitle:(null===(t=document.getElementById("mazemaster_puzzle_main_title"))||void 0===t?void 0:t.value)||"",description:(null===(n=document.getElementById("mazemaster_puzzle_description"))||void 0===n?void 0:n.value)||"",gridSize:parseInt(null===(a=document.getElementById("mazemaster_puzzle_grid_size"))||void 0===a?void 0:a.value)||3,sequenceLength:parseInt(null===(o=document.getElementById("mazemaster_puzzle_seq_length"))||void 0===o?void 0:o.value)||4,maxMistakes:parseInt(null===(i=document.getElementById("mazemaster_puzzle_max_mistakes"))||void 0===i?void 0:i.value)||5,hints:parseInt(null===(s=document.getElementById("mazemaster_puzzle_hints"))||void 0===s?void 0:s.value)||3,difficulty:parseInt(null===(r=document.getElementById("mazemaster_puzzle_difficulty"))||void 0===r?void 0:r.value)||5,damage:parseInt(null===(l=document.getElementById("mazemaster_puzzle_damage"))||void 0===l?void 0:l.value)||15,timeLimit:parseInt(null===(c=document.getElementById("mazemaster_puzzle_time_limit"))||void 0===c?void 0:c.value)||60,onSolve:(null===(d=document.getElementById("mazemaster_puzzle_on_solve"))||void 0===d?void 0:d.value)||"",onFail:(null===(m=document.getElementById("mazemaster_puzzle_on_fail"))||void 0===m?void 0:m.value)||""}),alert('Puzzle profile "'.concat(p,'" saved!'))})),Re.currentPuzzleProfile&&Ke(Re.currentPuzzleProfile);const Ve=document.getElementById("mazemaster_negotiation_profile_select");Ve&&Ve.addEventListener("change",(e=>{Re.currentNegotiationProfile=e.target.value,i(),Rt(e.target.value)}));const Xe=document.getElementById("mazemaster_negotiation_new_profile_btn");Xe&&Xe.addEventListener("click",(async e=>{e.preventDefault(),e.stopPropagation();const n=await p("Enter new Negotiation profile name:",u.INPUT,"");if(n&&n.trim()){const e=n.trim();if(Re.negotiationProfiles[e])await p('Negotiation profile "'.concat(e,'" already exists.'),u.TEXT);else{xt(e,t(t({},zt("Friendly Chat")||{}),{},{mainTitle:e})),Re.currentNegotiationProfile=e,i(),qo(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_combat"))||void 0===e||e.click(),setTimeout((()=>{var e;null===(e=document.querySelector('[data-combat="negotiation"]'))||void 0===e||e.click()}),50)}),100)}}}));const Je=document.getElementById("mazemaster_negotiation_delete_profile_btn");Je&&Je.addEventListener("click",(async()=>{var e;const t=null===(e=document.getElementById("mazemaster_negotiation_profile_select"))||void 0===e?void 0:e.value;if(t){await p('Delete Negotiation profile "'.concat(t,'"?'),u.CONFIRM)&&(!function(e){var t;if(null===(t=Re.negotiationProfiles)||void 0===t||delete t[e],Re.currentNegotiationProfile===e){const e=yt();Re.currentNegotiationProfile=e[0]||""}i()}(t),qo(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_combat"))||void 0===e||e.click(),setTimeout((()=>{var e;null===(e=document.querySelector('[data-combat="negotiation"]'))||void 0===e||e.click()}),50)}),100))}}));const Qe=document.getElementById("mazemaster_negotiation_rename_profile_btn");Qe&&Qe.addEventListener("click",(async()=>{var e;const t=null===(e=document.getElementById("mazemaster_negotiation_profile_select"))||void 0===e?void 0:e.value;if(!t)return void alert("No profile selected to rename");const n=await p("Enter new profile name:",u.INPUT,t);if(n&&n.trim()&&n.trim()!==t){const e=n.trim();if(Re.negotiationProfiles[e])return void alert("A profile with that name already exists");Re.negotiationProfiles[e]=Re.negotiationProfiles[t],Re.negotiationProfiles[e].mainTitle=e,delete Re.negotiationProfiles[t],Re.currentNegotiationProfile=e,i(),qo(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_combat"))||void 0===e||e.click(),setTimeout((()=>{var e;null===(e=document.querySelector('[data-combat="negotiation"]'))||void 0===e||e.click()}),50)}),100)}}));const Ze=document.getElementById("mazemaster_preview_negotiation_btn");Ze&&Ze.addEventListener("click",(()=>{var e;const t=null===(e=document.getElementById("mazemaster_negotiation_profile_select"))||void 0===e?void 0:e.value;if(!t)return void alert("Please select a Negotiation profile first");const n=Mn(t);n.error&&alert("Error: ".concat(n.error))}));const Ct=document.getElementById("mazemaster_negotiate_difficulty"),St=document.getElementById("mazemaster_negotiate_diff_val");Ct&&St&&Ct.addEventListener("input",(e=>{St.textContent="(".concat(e.target.value,")")}));const Dt=document.getElementById("mazemaster_negotiate_save_btn");function Rt(e){const t=zt(e)||{},n=(e,t)=>{const n=document.getElementById(e);n&&(n.value=null!=t?t:"")};n("mazemaster_negotiate_main_title",t.mainTitle),n("mazemaster_negotiate_npc_name",t.npcName||"NPC"),n("mazemaster_negotiate_description",t.description),n("mazemaster_negotiate_favor_target",t.favorTarget||75),n("mazemaster_negotiate_starting_favor",t.startingFavor||25),n("mazemaster_negotiate_max_turns",t.maxTurns||6),n("mazemaster_negotiate_damage",t.damage||10),n("mazemaster_negotiate_difficulty",t.difficulty||5),n("mazemaster_negotiate_persuade",t.persuadeAvg||12),n("mazemaster_negotiate_flatter",t.flatterAvg||10),n("mazemaster_negotiate_mood",t.startingMood||"unfriendly"),n("mazemaster_negotiate_intimidate",t.intimidateRisk||"medium"),n("mazemaster_negotiate_bribe_cost",t.bribeCost||"gold"),n("mazemaster_negotiate_on_success",t.onSuccess),n("mazemaster_negotiate_on_fail",t.onFail);const a=document.getElementById("mazemaster_negotiate_diff_val");a&&(a.textContent="(".concat(t.difficulty||5,")"))}Dt&&Dt.addEventListener("click",(()=>{var e,t,n,a,o,i,s,r,l,c,d,m,p,u,h,g;const f=null===(e=document.getElementById("mazemaster_negotiation_profile_select"))||void 0===e?void 0:e.value;if(!f)return void alert("Please create a Negotiation profile first");xt(f,{mainTitle:(null===(t=document.getElementById("mazemaster_negotiate_main_title"))||void 0===t?void 0:t.value)||"",npcName:(null===(n=document.getElementById("mazemaster_negotiate_npc_name"))||void 0===n?void 0:n.value)||"NPC",description:(null===(a=document.getElementById("mazemaster_negotiate_description"))||void 0===a?void 0:a.value)||"",favorTarget:parseInt(null===(o=document.getElementById("mazemaster_negotiate_favor_target"))||void 0===o?void 0:o.value)||75,startingFavor:parseInt(null===(i=document.getElementById("mazemaster_negotiate_starting_favor"))||void 0===i?void 0:i.value)||25,maxTurns:parseInt(null===(s=document.getElementById("mazemaster_negotiate_max_turns"))||void 0===s?void 0:s.value)||6,damage:parseInt(null===(r=document.getElementById("mazemaster_negotiate_damage"))||void 0===r?void 0:r.value)||10,difficulty:parseInt(null===(l=document.getElementById("mazemaster_negotiate_difficulty"))||void 0===l?void 0:l.value)||5,persuadeAvg:parseInt(null===(c=document.getElementById("mazemaster_negotiate_persuade"))||void 0===c?void 0:c.value)||12,flatterAvg:parseInt(null===(d=document.getElementById("mazemaster_negotiate_flatter"))||void 0===d?void 0:d.value)||10,startingMood:(null===(m=document.getElementById("mazemaster_negotiate_mood"))||void 0===m?void 0:m.value)||"unfriendly",intimidateRisk:(null===(p=document.getElementById("mazemaster_negotiate_intimidate"))||void 0===p?void 0:p.value)||"medium",bribeCost:(null===(u=document.getElementById("mazemaster_negotiate_bribe_cost"))||void 0===u?void 0:u.value)||"gold",onSuccess:(null===(h=document.getElementById("mazemaster_negotiate_on_success"))||void 0===h?void 0:h.value)||"",onFail:(null===(g=document.getElementById("mazemaster_negotiate_on_fail"))||void 0===g?void 0:g.value)||""}),alert('Negotiation profile "'.concat(f,'" saved!'))})),Re.currentNegotiationProfile&&Rt(Re.currentNegotiationProfile);const At=document.getElementById("mazemaster_maze_profile_select");At&&At.addEventListener("change",(e=>{Re.currentMazeProfile=e.target.value,i(),ko()}));const Ot=document.getElementById("mazemaster_maze_new_profile_btn");Ot&&Ot.addEventListener("click",(async e=>{e.preventDefault(),e.stopPropagation();const t=await p("Enter new maze profile name:",u.INPUT,"");if(t&&t.trim()){const e=t.trim();Re.mazeProfiles[e]?await p('Maze profile "'.concat(e,'" already exists.'),u.TEXT):(kt(e,{gridSize:10}),Re.currentMazeProfile=e,i(),qo(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_maze"))||void 0===e||e.click()}),100))}}));const Ht=document.getElementById("mazemaster_maze_delete_profile_btn");Ht&&Ht.addEventListener("click",(async()=>{var e;const t=null===(e=document.getElementById("mazemaster_maze_profile_select"))||void 0===e?void 0:e.value;if(t){await p('Delete maze profile "'.concat(t,'"?'),u.CONFIRM)&&(!function(e){if(delete Re.mazeProfiles[e],Re.currentMazeProfile===e){const e=_t();Re.currentMazeProfile=e[0]||"default"}i()}(t),qo(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_maze"))||void 0===e||e.click()}),100))}}));const Nt=document.getElementById("mazemaster_maze_rename_profile_btn");Nt&&Nt.addEventListener("click",(async()=>{var e;const t=null===(e=document.getElementById("mazemaster_maze_profile_select"))||void 0===e?void 0:e.value;if(!t)return void alert("No profile selected to rename");const n=await p("Enter new profile name:",u.INPUT,t);if(n&&n.trim()&&n.trim()!==t){const e=n.trim();if(Re.mazeProfiles[e])return void alert("A profile with that name already exists");Re.mazeProfiles[e]=Re.mazeProfiles[t],delete Re.mazeProfiles[t],Re.currentMazeProfile=e,i(),qo(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_maze"))||void 0===e||e.click()}),100)}}));const qt=document.getElementById("mazemaster_maze_save_btn");qt&&qt.addEventListener("click",(()=>{var e;const t=null===(e=document.getElementById("mazemaster_maze_profile_select"))||void 0===e?void 0:e.value;if(!t)return void alert("Please create a maze profile first");const n=So(),a=[];if((!n.gridSize||n.gridSize<5||n.gridSize>20)&&a.push("Grid Size must be between 5 and 20"),n.minionEncounters&&n.minionEncounters.length>0){const e=n.minionEncounters.reduce(((e,t)=>e+(t.percent||0)),0);e>100&&a.push("Encounter percentages total ".concat(e,"% (max 100%)"))}a.length>0?alert("Validation Error:\n\n"+a.join("\n")):(kt(t,n),alert('Maze profile "'.concat(t,'" saved!')))}));const Ft=document.getElementById("mazemaster_maze_story_btn");Ft&&Ft.addEventListener("click",(()=>{!async function(){var e,t,n,a;const o=null===(e=document.getElementById("mazemaster_maze_profile_select"))||void 0===e?void 0:e.value;if(!o)return void alert("Please create a maze profile first");const i=wt(o)||{},s=i.storyConfig||{mainStory:"",milestones:[]},r='\n        <div id="mazemaster_story_modal" class="mazemaster-story-modal">\n            <div class="mazemaster-story-modal-content">\n                <h3><i class="fa-solid fa-book"></i> Story Milestones</h3>\n\n                <div class="mazemaster-section">\n                    <label class="mazemaster-label">Main Story</label>\n                    <textarea id="story_main_text" class="mazemaster-story-textarea" rows="4"\n                        placeholder="The maze stretches before you, filled with danger and mystery...">'.concat(_o(s.mainStory||""),'</textarea>\n                </div>\n\n                <div class="mazemaster-section">\n                    <label class="mazemaster-label">Milestones</label>\n                    <div id="story_milestones_list" class="mazemaster-milestones-list">\n                        \x3c!-- Milestones rendered here --\x3e\n                    </div>\n                    <button id="story_add_milestone_btn" class="menu_button mazemaster-add-btn">\n                        <i class="fa-solid fa-plus"></i> Add Milestone\n                    </button>\n                </div>\n\n                <div class="mazemaster-story-modal-buttons">\n                    <button id="story_save_btn" class="menu_button menu_button_primary">\n                        <i class="fa-solid fa-save"></i> Save\n                    </button>\n                    <button id="story_cancel_btn" class="menu_button">\n                        Cancel\n                    </button>\n                </div>\n            </div>\n        </div>\n    '),l=document.createElement("div");l.innerHTML=r,document.body.appendChild(l.firstElementChild);const c=document.getElementById("mazemaster_story_modal"),d=document.getElementById("story_milestones_list");function m(){0!==s.milestones.length?(d.innerHTML=s.milestones.map(((e,t)=>'\n            <div class="mazemaster-milestone-row" data-index="'.concat(t,'">\n                <div class="milestone-percent">\n                    <input type="number" class="milestone-percent-input" min="1" max="99" value="').concat(e.percent||25,'" placeholder="%">\n                    <span>%</span>\n                </div>\n                <textarea class="milestone-text-input" rows="2" placeholder="Story update at this point...">').concat(_o(e.storyUpdate||""),'</textarea>\n                <button class="menu_button menu_button_icon milestone-remove-btn" title="Remove">\n                    <i class="fa-solid fa-trash"></i>\n                </button>\n            </div>\n        '))).join(""),d.querySelectorAll(".milestone-remove-btn").forEach((e=>{e.addEventListener("click",(e=>{const t=e.target.closest(".mazemaster-milestone-row"),n=parseInt(t.dataset.index);s.milestones.splice(n,1),m()}))}))):d.innerHTML='<div class="mazemaster-empty-state">No milestones. Add milestones to show story updates at specific progress points.</div>'}m(),null===(t=document.getElementById("story_add_milestone_btn"))||void 0===t||t.addEventListener("click",(()=>{s.milestones.push({percent:50,storyUpdate:""}),m()})),null===(n=document.getElementById("story_save_btn"))||void 0===n||n.addEventListener("click",(()=>{var e;s.mainStory=(null===(e=document.getElementById("story_main_text"))||void 0===e?void 0:e.value)||"";const t=d.querySelectorAll(".mazemaster-milestone-row");s.milestones=[],t.forEach((e=>{var t,n;const a=parseInt(null===(t=e.querySelector(".milestone-percent-input"))||void 0===t?void 0:t.value)||25,o=(null===(n=e.querySelector(".milestone-text-input"))||void 0===n?void 0:n.value)||"";o.trim()&&s.milestones.push({percent:a,storyUpdate:o})})),s.milestones.sort(((e,t)=>e.percent-t.percent)),i.storyConfig=s,kt(o,i),c.remove(),alert("Story milestones saved!")})),null===(a=document.getElementById("story_cancel_btn"))||void 0===a||a.addEventListener("click",(()=>{c.remove()})),c.addEventListener("click",(e=>{e.target===c&&c.remove()}))}()})),document.querySelectorAll(".mazemaster-collapsible-header").forEach((e=>{e.addEventListener("click",(()=>{const t=e.getAttribute("data-target"),n=document.getElementById(t),a=e.closest(".mazemaster-collapsible");if(n){const e="none"!==n.style.display;n.style.display=e?"none":"block",null==a||a.classList.toggle("expanded",!e)}}))})),Ho();const jt=document.getElementById("mazemaster_intelligent_distribute");jt&&jt.addEventListener("click",Lo);const Wt=document.getElementById("mazemaster_maze_win_image_btn"),Yt=document.getElementById("mazemaster_maze_win_image_file");Wt&&Yt&&(Wt.addEventListener("click",(()=>{Yt.click()})),Yt.addEventListener("change",(async e=>{var t,n;const a=null===(t=e.target.files)||void 0===t?void 0:t[0];if(!a)return;const o=null===(n=document.getElementById("mazemaster_maze_profile_select"))||void 0===n?void 0:n.value;if(!o)return alert("Please create a profile first"),void(Yt.value="");try{const e=await Io(a,"maze_win_".concat(o)),t=wt(o)||{};t.winImage=e,kt(o,t);const n=document.querySelector(".mazemaster-maze-win-image-preview");n&&(n.innerHTML='<img id="maze_win_image_preview" src="'.concat(e,'" alt="Victory">'))}catch(e){alert("Image upload failed: ".concat(e.message))}Yt.value=""})));const Gt=document.getElementById("mazemaster_chest_image_btn"),Ut=document.getElementById("mazemaster_chest_image_file");Gt&&Ut&&(Gt.addEventListener("click",(()=>{Ut.click()})),Ut.addEventListener("change",(async e=>{var t,n;const a=null===(t=e.target.files)||void 0===t?void 0:t[0];if(!a)return;const o=null===(n=document.getElementById("mazemaster_maze_profile_select"))||void 0===n?void 0:n.value;if(!o)return alert("Please create a profile first"),void(Ut.value="");try{const e=await Io(a,"chest_".concat(o)),t=wt(o);if(t){t.chestImage=e,kt(o,t);const n=document.querySelector(".mazemaster-chest-preview");n&&(n.innerHTML='<img id="mazemaster_chest_preview_img" src="'.concat(e,'" style="width: 100%; height: 100%; object-fit: cover;">'))}}catch(e){alert("Image upload failed: ".concat(e.message))}Ut.value=""})));const Kt=document.getElementById("mazemaster_maze_main_minion");Kt&&Kt.addEventListener("change",(e=>{const t=document.getElementById("mazemaster_main_minion_settings");t&&(t.style.display=e.target.value?"":"none")}));const Vt=document.getElementById("mazemaster_maze_exit_type");Vt&&Vt.addEventListener("change",(()=>{Co(Vt.value,"")}));const Xt=document.getElementById("mazemaster_add_portal_btn");function Qt(){var e;const t=document.getElementById("mazemaster_portals_list"),n=null===(e=document.querySelector('[data-target="portals_section"]'))||void 0===e||null===(e=e.closest(".mazemaster-collapsible"))||void 0===e?void 0:e.querySelector(".mazemaster-collapse-hint");t&&n&&(n.textContent="(".concat(t.children.length," portal pairs)"))}Xt&&Xt.addEventListener("click",(()=>{const e=document.getElementById("mazemaster_portals_list");if(!e)return;const t=e.children.length,n=document.createElement("div");n.className="mazemaster-portal-item",n.dataset.portalIndex=t,n.innerHTML='\n                <div class="portal-header">\n                    <span class="portal-color" style="background: #9b59b6"></span>\n                    <span class="portal-name">Portal '.concat(t+1,'</span>\n                    <button class="menu_button remove-portal-btn" title="Remove Portal">\n                        <i class="fa-solid fa-trash"></i>\n                    </button>\n                </div>\n                <div class="portal-details">\n                    <div class="portal-row">\n                        <label>ID:</label>\n                        <input type="text" class="portal-id mazemaster-input" value="" placeholder="portal').concat(t+1,'">\n                    </div>\n                    <div class="portal-row">\n                        <label>Color:</label>\n                        <input type="color" class="portal-color-input" value="#9b59b6">\n                    </div>\n                    <div class="portal-row">\n                        <label>Bidirectional:</label>\n                        <input type="checkbox" class="portal-bidirectional" checked>\n                    </div>\n                    <div class="portal-row coords-row">\n                        <span>Start: X</span>\n                        <input type="number" class="portal-start-x mazemaster-input" value="" placeholder="auto" min="0">\n                        <span>Y</span>\n                        <input type="number" class="portal-start-y mazemaster-input" value="" placeholder="auto" min="0">\n                    </div>\n                    <div class="portal-row coords-row">\n                        <span>End: X</span>\n                        <input type="number" class="portal-end-x mazemaster-input" value="" placeholder="auto" min="0">\n                        <span>Y</span>\n                        <input type="number" class="portal-end-y mazemaster-input" value="" placeholder="auto" min="0">\n                    </div>\n                </div>\n            '),n.querySelector(".remove-portal-btn").addEventListener("click",(()=>{n.remove(),Qt()})),n.querySelector(".portal-color-input").addEventListener("input",(e=>{n.querySelector(".portal-color").style.background=e.target.value})),n.querySelector(".portal-id").addEventListener("input",(e=>{n.querySelector(".portal-name").textContent=e.target.value||"Portal ".concat(t+1)})),e.appendChild(n),Qt()})),document.querySelectorAll("#mazemaster_portals_list .remove-portal-btn").forEach((e=>{e.addEventListener("click",(()=>{e.closest(".mazemaster-portal-item").remove(),Qt()}))})),document.querySelectorAll("#mazemaster_portals_list .portal-color-input").forEach((e=>{e.addEventListener("input",(e=>{e.target.closest(".mazemaster-portal-item").querySelector(".portal-color").style.background=e.target.value}))}));const Zt=document.getElementById("mazemaster_add_objective_btn");function $t(){var e;const t=document.getElementById("mazemaster_objectives_list"),n=null===(e=document.querySelector('[data-target="objectives_section"]'))||void 0===e||null===(e=e.closest(".mazemaster-collapsible"))||void 0===e?void 0:e.querySelector(".mazemaster-collapse-hint");t&&n&&(n.textContent="(".concat(t.children.length," objectives)"))}Zt&&Zt.addEventListener("click",(()=>{const e=document.getElementById("mazemaster_objectives_list");if(!e)return;const t=e.children.length,n=document.createElement("div");n.className="mazemaster-objective-item",n.dataset.objectiveIndex=t,n.innerHTML='\n                <div class="objective-config-header">\n                    <span class="objective-name">Objective '.concat(t+1,'</span>\n                    <button class="menu_button remove-objective-btn" title="Remove Objective">\n                        <i class="fa-solid fa-trash"></i>\n                    </button>\n                </div>\n                <div class="objective-config-details">\n                    <div class="objective-config-row">\n                        <label>ID:</label>\n                        <input type="text" class="objective-id mazemaster-input" value="" placeholder="obj').concat(t+1,'">\n                    </div>\n                    <div class="objective-config-row">\n                        <label>Type:</label>\n                        <select class="objective-type mazemaster-select">\n                            <option value="collect">Collect Item</option>\n                            <option value="defeat">Defeat Minion</option>\n                            <option value="explore">Explore %</option>\n                        </select>\n                    </div>\n                    <div class="objective-config-row objective-target-row">\n                        <label>Target:</label>\n                        <input type="text" class="objective-target mazemaster-input" value="" placeholder="key, strike, stealth...">\n                    </div>\n                    <div class="objective-config-row">\n                        <label>Count:</label>\n                        <input type="number" class="objective-count mazemaster-input" value="1" min="1">\n                    </div>\n                    <div class="objective-config-row">\n                        <label>Description:</label>\n                        <input type="text" class="objective-description mazemaster-input" value="" placeholder="Find 3 Keys">\n                    </div>\n                    <div class="objective-config-row">\n                        <label>Required:</label>\n                        <input type="checkbox" class="objective-required" checked>\n                    </div>\n                    <div class="objective-config-row">\n                        <label>Reward Script:</label>\n                        <input type="text" class="objective-reward mazemaster-input" value="" placeholder="/echo Objective complete!">\n                    </div>\n                </div>\n            '),n.querySelector(".remove-objective-btn").addEventListener("click",(()=>{n.remove(),$t()}));const a=n.querySelector(".objective-type"),o=n.querySelector(".objective-target-row");a.addEventListener("change",(()=>{o.style.display="explore"===a.value?"none":"flex"})),n.querySelector(".objective-description").addEventListener("input",(e=>{n.querySelector(".objective-name").textContent=e.target.value||"Objective ".concat(t+1)})),e.appendChild(n),$t()})),document.querySelectorAll("#mazemaster_objectives_list .remove-objective-btn").forEach((e=>{e.addEventListener("click",(()=>{e.closest(".mazemaster-objective-item").remove(),$t()}))})),document.querySelectorAll("#mazemaster_objectives_list .objective-type").forEach((e=>{const t=e.closest(".mazemaster-objective-item").querySelector(".objective-target-row");e.addEventListener("change",(()=>{t.style.display="explore"===e.value?"none":"flex"}))}));const en=document.getElementById("mazemaster_add_encounter_btn");en&&en.addEventListener("click",(()=>{const e=document.getElementById("mazemaster_maze_encounters_list");if(!e)return;const t=Object.keys(Re.minions||{}).map((e=>{const t=Re.minions[e];return'<option value="'.concat(e,'">').concat(t.name||e,"</option>")})).join(""),n=document.createElement("div");n.className="mazemaster-encounter-row",n.innerHTML='\n                <select class="encounter-minion-select">\n                    <option value="">Select Minion</option>\n                    '.concat(t,'\n                </select>\n                <input type="number" class="encounter-percent-input" min="1" max="100" value="5" placeholder="%">\n                <span class="encounter-percent-label">%</span>\n                <button class="encounter-remove-btn menu_button"><i class="fa-solid fa-trash"></i></button>\n            '),n.querySelector(".encounter-remove-btn").addEventListener("click",(()=>{n.remove()})),e.appendChild(n)}));const tn=document.getElementById("mazemaster_add_trap_encounter_btn");tn&&tn.addEventListener("click",(()=>{const e=document.getElementById("mazemaster_maze_traps_list");if(!e)return;const t=Et().map((e=>{const t=Pt(e);return'<option value="'.concat(_o(e),'">').concat(_o((null==t?void 0:t.name)||e),"</option>")})).join("");if(!t)return void alert("No traps available. Create traps in the Traps tab first.");const n=document.createElement("div");n.className="mazemaster-encounter-row mazemaster-trap-encounter-row",n.innerHTML='\n                <select class="trap-encounter-select">\n                    <option value="">Select Trap</option>\n                    '.concat(t,'\n                </select>\n                <input type="number" class="trap-encounter-percent-input" min="1" max="100" value="5" placeholder="%">\n                <span class="encounter-percent-label">%</span>\n                <button class="trap-encounter-remove-btn menu_button"><i class="fa-solid fa-trash"></i></button>\n            '),n.querySelector(".trap-encounter-remove-btn").addEventListener("click",(()=>{n.remove()})),e.appendChild(n)}));const nn=document.getElementById("mazemaster_add_minion_btn"),an=document.getElementById("mazemaster_minion_image_file");nn&&an&&(nn.addEventListener("click",(()=>{an.click()})),an.addEventListener("change",(async e=>{var t;const n=null===(t=e.target.files)||void 0===t?void 0:t[0];if(n){try{const e="minion_".concat(Date.now()),t=await Io(n,e),a=await p("Enter minion name:",u.INPUT,"New Minion");a&&a.trim()&&(Mt(e,{name:a.trim(),imagePath:t}),To())}catch(e){alert("Image upload failed: ".concat(e.message))}an.value=""}})));const on=document.getElementById("mazemaster_minion_profile_select");on&&on.addEventListener("change",(()=>{To()}));const rn=document.getElementById("mazemaster_minion_profile_save_btn");rn&&rn.addEventListener("click",(async()=>{const e=await p("Enter profile name:",u.INPUT,"My Minions");if(e&&e.trim()){const t=e.trim();Re.minionProfiles[t]=JSON.parse(JSON.stringify(Re.minions||{})),i(),alert('Minion profile "'.concat(t,'" saved!')),qo(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_minions"))||void 0===e||e.click()}),100)}}));const ln=document.getElementById("mazemaster_minion_profile_load_btn");ln&&ln.addEventListener("click",(async()=>{const e=document.getElementById("mazemaster_minion_profile_select"),t=null==e?void 0:e.value;if(!t)return void alert("Select a profile to load");await p('Load minion profile "'.concat(t,'"? This will replace your current minions.'),u.CONFIRM)&&(Re.minions=JSON.parse(JSON.stringify(Re.minionProfiles[t]||{})),i(),To(),alert('Minion profile "'.concat(t,'" loaded!')))}));const cn=document.getElementById("mazemaster_minion_profile_delete_btn");cn&&cn.addEventListener("click",(async()=>{const e=document.getElementById("mazemaster_minion_profile_select"),t=null==e?void 0:e.value;if(!t)return void alert("Select a profile to delete");await p('Delete minion profile "'.concat(t,'"?'),u.CONFIRM)&&(delete Re.minionProfiles[t],i(),qo(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_minions"))||void 0===e||e.click()}),100))}));const dn=document.getElementById("mazemaster_add_trap_btn"),mn=document.getElementById("mazemaster_trap_image_file");dn&&mn&&(dn.addEventListener("click",(()=>{mn.click()})),mn.addEventListener("change",(async e=>{var t;const n=null===(t=e.target.files)||void 0===t?void 0:t[0];if(n){try{const e="trap_".concat(Date.now()),t=await Io(n,e),a=await p("Enter trap name:",u.INPUT,"New Trap");a&&a.trim()&&(It(e,{name:a.trim(),imagePath:t,message:"You triggered a trap!",script:""}),Bo())}catch(e){alert("Image upload failed: ".concat(e.message))}mn.value=""}})));const pn=document.getElementById("mazemaster_trap_profile_save_btn");pn&&pn.addEventListener("click",(async()=>{const e=await p("Enter profile name:",u.INPUT,"My Traps");if(e&&e.trim()){const t=e.trim();Re.trapProfiles[t]=JSON.parse(JSON.stringify(Re.traps||{})),i(),alert('Trap profile "'.concat(t,'" saved!')),qo(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_traps"))||void 0===e||e.click()}),100)}}));const hn=document.getElementById("mazemaster_trap_profile_load_btn");hn&&hn.addEventListener("click",(async()=>{const e=document.getElementById("mazemaster_trap_profile_select"),t=null==e?void 0:e.value;if(!t)return void alert("Select a profile to load");await p('Load trap profile "'.concat(t,'"? This will replace your current traps.'),u.CONFIRM)&&(Re.traps=JSON.parse(JSON.stringify(Re.trapProfiles[t]||{})),i(),Bo(),alert('Trap profile "'.concat(t,'" loaded!')))}));const gn=document.getElementById("mazemaster_trap_profile_delete_btn");gn&&gn.addEventListener("click",(async()=>{const e=document.getElementById("mazemaster_trap_profile_select"),t=null==e?void 0:e.value;if(!t)return void alert("Select a profile to delete");await p('Delete trap profile "'.concat(t,'"?'),u.CONFIRM)&&(delete Re.trapProfiles[t],i(),qo(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_traps"))||void 0===e||e.click()}),100))}))}function qo(){const e=document.getElementById("mazemaster_drawer");e&&(e.innerHTML=zo(),No(),xo(),wo(),To(),Bo(),ko())}async function Fo(e){if(Ke.has(e))return;if(e.classList.contains("streaming")||e.classList.contains("is-typing")||e.querySelector(".mes_text.streaming"))return;const t=e.querySelector(".mes_text .stle--content")||e.querySelector(".mes_text");if(!t)return;const n=t.textContent||"",a=/\{\{wheel:([^}]+)\}\}/gi,o=/\{\{battlebar:([^}]+)\}\}/gi,i=/\{\{maze:([^}]+)\}\}/gi,s=[],r=[],l=[];let c;for(;null!==(c=a.exec(n));)s.push({full:c[0],profile:c[1].trim()});for(;null!==(c=o.exec(n));)r.push({full:c[0],profile:c[1].trim()});for(;null!==(c=i.exec(n));)l.push({full:c[0],profile:c[1].trim()});if(0===s.length&&0===r.length&&0===l.length)return;Ke.add(e);const d=SillyTavern.getContext(),m=e.getAttribute("mesid");for(const t of s){console.log("[MazeMaster] Processing wheel macro: ".concat(t.full));if(!Tt(t.profile).error){Bt().valid&&Lt()}const n="[ Wheel: ".concat(t.profile,"]");if(d.chat&&null!==m){const a=parseInt(m);if(d.chat[a]){const o=d.chat[a].mes,i=o.replace(t.full,"").replace(/\s+/g," ").trim(),s=o.replace(t.full,n);d.chat[a].mes=i;const r=e.querySelector(".mes_text");r&&(r.innerHTML=s)}}}for(const t of r){console.log("[MazeMaster] Processing battlebar macro: ".concat(t.full)),Nn(t.profile);const n="[ Battlebar: ".concat(t.profile,"]");if(d.chat&&null!==m){const a=parseInt(m);if(d.chat[a]){const o=d.chat[a].mes,i=o.replace(t.full,"").replace(/\s+/g," ").trim(),s=o.replace(t.full,n);d.chat[a].mes=i;const r=e.querySelector(".mes_text");r&&(r.innerHTML=s)}}}for(const t of l){console.log("[MazeMaster] Processing maze macro: ".concat(t.full)),Ba(t.profile);const n="[ Maze: ".concat(t.profile,"]");if(d.chat&&null!==m){const a=parseInt(m);if(d.chat[a]){const o=d.chat[a].mes,i=o.replace(t.full,"").replace(/\s+/g," ").trim(),s=o.replace(t.full,n);d.chat[a].mes=i;const r=e.querySelector(".mes_text");r&&(r.innerHTML=s)}}}}function jo(){const e=SillyTavern.getContext();if(!e||!e.eventSource||!e.eventTypes)return console.warn("[MazeMaster] Context not ready for macro hooks, retrying..."),void setTimeout(jo,500);e.eventTypes.USER_MESSAGE_RENDERED&&e.eventSource.on(e.eventTypes.USER_MESSAGE_RENDERED,(e=>{setTimeout((()=>{const t=document.querySelector('#chat .mes[mesid="'.concat(e,'"]'));t&&Fo(t)}),500)})),e.eventTypes.CHARACTER_MESSAGE_RENDERED&&e.eventSource.on(e.eventTypes.CHARACTER_MESSAGE_RENDERED,(e=>{const t=function(){let n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;const a=document.querySelector('#chat .mes[mesid="'.concat(e,'"]'));if(!a)return;(a.classList.contains("streaming")||a.classList.contains("is-typing"))&&n<5?setTimeout((()=>t(n+1)),1e3):Fo(a)};setTimeout((()=>t()),500)})),console.log("[MazeMaster] Macro hooks registered")}Ze(),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",(()=>{Do(),At(),jo()})):(Do(),At(),jo()),console.log("[".concat(a,"] Extension loaded (folder: ").concat(o,")"))})();