(()=>{function e(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function n(n){for(var a=1;a<arguments.length;a++){var o=null!=arguments[a]?arguments[a]:{};a%2?e(Object(o),!0).forEach((function(e){t(n,e,o[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(o)):e(Object(o)).forEach((function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(o,e))}))}return n}function t(e,n,t){return(n=function(e){var n=function(e,n){if("object"!=typeof e||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var a=t.call(e,n||"default");if("object"!=typeof a)return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===n?String:Number)(e)}(e,"string");return"symbol"==typeof n?n:n+""}(n))in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}const a="MazeMaster",{saveSettingsDebounced:o,SlashCommandParser:i,SlashCommand:s,ARGUMENT_TYPE:r,SlashCommandNamedArgument:l,executeSlashCommandsWithOptions:m,getRequestHeaders:c,callGenericPopup:d,POPUP_TYPE:p,generateQuietPrompt:u,getPresetManager:g,mainApi:b}=SillyTavern.getContext(),f=["#e74c3c","#3498db","#2ecc71","#f39c12","#9b59b6","#1abc9c","#e67e22","#34495e","#e91e63","#00bcd4","#8bc34a","#ff5722"],v={fraction:1,halfseg:.5,doubleseg:2},h=["fraction","halfseg","doubleseg"],z={1:{zoneWidth:.4,traverseTime:3500},2:{zoneWidth:.32,traverseTime:3e3},3:{zoneWidth:.26,traverseTime:2500},4:{zoneWidth:.2,traverseTime:2e3},5:{zoneWidth:.15,traverseTime:1600}},y={profiles:{},battlebarProfiles:{},mazeProfiles:{},minions:{},minionProfiles:{},trapProfiles:{},currentProfile:"default",currentBattlebarProfile:"default",currentMazeProfile:"default",currentMinionProfile:"default",currentTrapProfile:"default",activeGameConfig:"wheel"},_={"Reward Wheel":{segments:[{trigger:"",text:"Small Prize",command:"/echo You won a small prize!",size:"fraction",respin:!1},{trigger:"",text:"Medium Prize",command:"/echo You won a medium prize!",size:"fraction",respin:!1},{trigger:"",text:"Big Prize!",command:"/echo Amazing! You won the big prize!",size:"halfseg",respin:!1},{trigger:"",text:"Try Again",command:"/echo Better luck next time...",size:"fraction",respin:!1},{trigger:"",text:"JACKPOT!",command:"/echo JACKPOT! Incredible luck!",size:"halfseg",respin:!1},{trigger:"",text:"Bonus Spin",command:"/echo You get another spin!",size:"fraction",respin:!0}],randomize:!0,difficulty:1},"Challenge Wheel":{segments:[{trigger:"",text:"Easy Task",command:"/echo Easy task assigned!",size:"doubleseg",respin:!1},{trigger:"",text:"Medium Task",command:"/echo Medium task assigned!",size:"fraction",respin:!1},{trigger:"",text:"Hard Task",command:"/echo Hard task - good luck!",size:"halfseg",respin:!1},{trigger:"",text:"Free Pass",command:"/echo Lucky! You get a free pass!",size:"halfseg",respin:!1},{trigger:"",text:"Double or Nothing",command:"/echo Spin again - double stakes!",size:"fraction",respin:!0}],randomize:!1,difficulty:2}},x={"Easy Fight":{difficulty:2,hitsToWin:3,missesToLose:5,hitCommand:"/echo Hit! Keep going!",missCommand:"/echo Missed! Watch the timing!",winCommand:"/echo Victory! You defeated the enemy!",loseCommand:"/echo Defeated... Try again!",mainTitle:"Battle!",images:[{imagePath:"",stageMessage:"The enemy appears!"},{imagePath:"",stageMessage:"You land a blow!"},{imagePath:"",stageMessage:"Almost there!"},{imagePath:"",stageMessage:"Victory!"}]},"Boss Battle":{difficulty:4,hitsToWin:5,missesToLose:3,hitCommand:"/echo Critical hit!",missCommand:"/echo The boss counters!",winCommand:"/echo The boss has been defeated!",loseCommand:"/echo The boss was too powerful...",mainTitle:"BOSS FIGHT!",images:[{imagePath:"",stageMessage:"The boss towers before you!"},{imagePath:"",stageMessage:"You find an opening!"},{imagePath:"",stageMessage:"The boss staggers!"},{imagePath:"",stageMessage:"Keep attacking!"},{imagePath:"",stageMessage:"One more hit!"},{imagePath:"",stageMessage:"VICTORY!"}]}},w={herald:{name:"Herald",imagePath:"",type:"messenger",messages:["Greetings, traveler!","The maze master watches...","Beware what lies ahead!"],encounterScript:""},guardian:{name:"Guardian",imagePath:"",type:"battlebar",battlebarProfiles:["Easy Fight"],messages:["You shall not pass!","Prepare to fight!","Only the worthy may continue!"],encounterScript:""},fortune_teller:{name:"Fortune Teller",imagePath:"",type:"prizewheel",wheelProfiles:["Reward Wheel"],messages:["Spin the wheel of fate!","Let destiny decide!","What fortune awaits you?"],encounterScript:""},trader:{name:"Wandering Trader",imagePath:"",type:"merchant",merchantItemCount:{min:2,max:4},messages:["Care to make a trade?","I have something special...","A fair exchange benefits us both!"],encounterScript:""}},E={spike_trap:{name:"Spike Trap",imagePath:"",message:"Sharp spikes shoot up from the floor!",script:"/echo You triggered a spike trap!"},poison_gas:{name:"Poison Gas",imagePath:"",message:"A cloud of noxious gas fills the corridor!",script:"/echo Poison gas surrounds you!"}},M={"Dungeon Crawl":{herald:{name:"Herald",imagePath:"",type:"messenger",messages:["Greetings, traveler!","The maze master watches...","Beware what lies ahead!"],encounterScript:""},guardian:{name:"Guardian",imagePath:"",type:"battlebar",battlebarProfiles:["Easy Fight"],messages:["You shall not pass!","Prepare to fight!","Only the worthy may continue!"],encounterScript:""},fortune_teller:{name:"Fortune Teller",imagePath:"",type:"prizewheel",wheelProfiles:["Reward Wheel"],messages:["Spin the wheel of fate!","Let destiny decide!","What fortune awaits you?"],encounterScript:""},trader:{name:"Wandering Trader",imagePath:"",type:"merchant",merchantItemCount:{min:2,max:4},messages:["Care to make a trade?","I have something special...","A fair exchange benefits us both!"],encounterScript:""}}},I={"Dungeon Crawl":{spike_trap:{name:"Spike Trap",imagePath:"",message:"Sharp spikes shoot up from the floor!",script:"/echo You triggered a spike trap!"},poison_gas:{name:"Poison Gas",imagePath:"",message:"A cloud of noxious gas fills the corridor!",script:"/echo Poison gas surrounds you!"}}},k={"Dungeon Crawl":{gridSize:10,winCommand:"/echo Congratulations! You escaped the dungeon!",loseCommand:"/echo The dungeon claims another victim...",winMessage:"You found the exit and escaped!",winImage:"",mainMinion:"guardian",mainMinionIntroMessage:"Welcome to my dungeon, adventurer. Find the exit... if you can!",mainMinionRandomChance:20,mainMinionRandomMessages:["Still wandering, I see...","The exit grows ever closer... or does it?","Many have tried. Few have succeeded.","Your persistence is... admirable."],mainMinionExitType:"battlebar",mainMinionExitProfile:"Boss Battle",minionEncounters:[{minionId:"herald",percent:15},{minionId:"guardian",percent:10},{minionId:"fortune_teller",percent:8},{minionId:"trader",percent:3}],trapEncounters:[{trapId:"spike_trap",percent:4},{trapId:"poison_gas",percent:3}],onBattlebarLoss:"respawn",chestTilePercent:15,chestLockedPercent:30,chestLockedBonusPercent:50,chestMimicPercent:15,chestLootMin:1,chestLootMax:3,chestKeyChance:35,chestPowChance:45,chestStealthChance:15,chestGrandpowChance:2,lockedChestKeyChance:25,lockedChestPowChance:55,lockedChestStealthChance:25,lockedChestGrandpowChance:8,startingInventory:{key:1,pow:0,stealth:1,grandpow:0},storyConfig:{mainStory:"You descend into the ancient dungeon. Shadows dance on the walls as torchlight flickers...",milestones:[{percent:25,storyUpdate:"You venture deeper. The air grows colder and the walls damper."},{percent:50,storyUpdate:"Halfway through! Strange sounds echo from the darkness ahead."},{percent:75,storyUpdate:"You sense the exit is near. But so is something else..."}]}}};let C={},S={segments:[],isOpen:!1,isSpinning:!1,pendingRespin:!1,hasRespun:!1},P={isOpen:!1,profile:null,hits:0,misses:0,arrowPosition:0,arrowDirection:1,zoneStart:0,zoneEnd:0,animationId:null,lastFrameTime:0,isVictory:!1,isDefeat:!1},B={isOpen:!1,profile:null,profileName:null,grid:[],size:10,playerX:0,playerY:0,exitX:0,exitY:0,visited:new Set,isVictory:!1,currentMinion:null,isPaused:!1,pendingEncounter:null,exitEncounterDone:!1,inventory:{key:0,stealth:0,pow:0,grandpow:0},pendingConfirmation:null,pendingChest:null};const T={wheel:{},battlebar:{},maze:{}},L=new WeakSet;function O(){return Object.keys(C.profiles||{})}function D(e){return C.profiles[e]}function N(){return Object.keys(C.battlebarProfiles||{})}function A(e){return C.battlebarProfiles[e]}function j(e,n){var t,a,i;C.battlebarProfiles[e]={difficulty:n.difficulty||3,hitsToWin:n.hitsToWin||5,missesToLose:n.missesToLose||3,hitCommand:n.hitCommand||"",missCommand:n.missCommand||"",winCommand:n.winCommand||"",loseCommand:n.loseCommand||"",images:n.images||[],keyDropChance:null!==(t=n.keyDropChance)&&void 0!==t?t:40,powDropChance:null!==(a=n.powDropChance)&&void 0!==a?a:20,stealthDropChance:null!==(i=n.stealthDropChance)&&void 0!==i?i:10},o(),console.log("[MazeMaster] Battlebar profile saved:",e,C.battlebarProfiles[e])}function R(){return Object.keys(C.mazeProfiles||{})}function q(e){return C.mazeProfiles[e]}function H(e,n){C.mazeProfiles[e]={gridSize:n.gridSize||10,winCommand:n.winCommand||"",winImage:n.winImage||"",winMessage:n.winMessage||"",mainMinion:n.mainMinion||"",mainMinionIntroMessage:n.mainMinionIntroMessage||"",mainMinionRandomChance:n.mainMinionRandomChance||15,mainMinionRandomMessages:n.mainMinionRandomMessages||[],mainMinionExitType:n.mainMinionExitType||"messenger",mainMinionExitProfile:n.mainMinionExitProfile||"",minionEncounters:n.minionEncounters||[],onBattlebarLoss:n.onBattlebarLoss||"continue",loseCommand:n.loseCommand||"",chestTilePercent:n.chestTilePercent||10,chestLockedPercent:n.chestLockedPercent||30,chestLockedBonusPercent:n.chestLockedBonusPercent||50,chestMimicPercent:n.chestMimicPercent||15,chestLootMin:n.chestLootMin||1,chestLootMax:n.chestLootMax||2,chestKeyChance:n.chestKeyChance||30,chestPowChance:n.chestPowChance||50,chestStealthChance:n.chestStealthChance||0,lockedChestKeyChance:n.lockedChestKeyChance||40,lockedChestPowChance:n.lockedChestPowChance||60,lockedChestStealthChance:n.lockedChestStealthChance||30,chestGrandpowChance:n.chestGrandpowChance||0,lockedChestGrandpowChance:n.lockedChestGrandpowChance||5,startingInventory:n.startingInventory||{key:0,stealth:0,pow:0,grandpow:0},trapEncounters:n.trapEncounters||[],storyConfig:n.storyConfig||{mainStory:"",milestones:[]}},o(),console.log("[MazeMaster] Maze profile saved:",e,C.mazeProfiles[e])}function W(){return Object.keys(C.minions||{})}function G(e){return C.minions[e]}function F(e,n){C.minions[e]={name:n.name||"Unknown",imagePath:n.imagePath||"",type:n.type||"messenger",battlebarProfiles:n.battlebarProfiles||[],wheelProfiles:n.wheelProfiles||[],messages:n.messages||[],encounterScript:n.encounterScript||"",merchantItemCount:n.merchantItemCount||{min:1,max:3}},o(),console.log("[MazeMaster] Minion saved:",e,C.minions[e])}function Y(){return Object.keys(C.traps||{})}function U(e){var n;return null===(n=C.traps)||void 0===n?void 0:n[e]}function J(e,n){C.traps||(C.traps={}),C.traps[e]={name:n.name||"Unknown Trap",imagePath:n.imagePath||"",message:n.message||"You triggered a trap!",script:n.script||""},o(),console.log("[MazeMaster] Trap saved:",e,C.traps[e])}function V(e){const t=D(e);return t&&t.segments&&0!==t.segments.length?(S.segments=t.segments.map(((e,t)=>n(n({},e),{},{units:v[e.size]||1,color:f[t%f.length]}))),S.isOpen=!1,S.isSpinning=!1,S.pendingRespin=!1,S.hasRespun=!1,{success:!0,count:S.segments.length}):{error:'Profile "'.concat(e,'" not found or empty')}}function K(){const e=S.segments.filter((e=>"halfseg"===e.size)).length,n=S.segments.filter((e=>"doubleseg"===e.size)).length;return e!==n?(console.error("[MazeMaster] Wheel balance error: ".concat(e," halfseg(s) but ").concat(n," doubleseg(s). They must be equal.")),{valid:!1,error:"Wheel unbalanced: ".concat(e," halfseg(s) â‰  ").concat(n," doubleseg(s)")}):{valid:!0}}function X(){return S.segments.reduce(((e,n)=>e+n.units),0)}function Q(){const e=document.getElementById("mazemaster_wheel_modal");if(e&&e.remove(),!document.getElementById("mazemaster_wheel_styles")){const e=document.createElement("style");e.id="mazemaster_wheel_styles",e.textContent="\n        .mazemaster-wheel-overlay {\n            position: fixed;\n            top: 0;\n            left: 0;\n            right: 0;\n            bottom: 0;\n            background: rgba(0, 0, 0, 0.85);\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            z-index: 10002;\n        }\n\n        .mazemaster-wheel-container {\n            position: relative;\n            display: flex;\n            flex-direction: column;\n            align-items: center;\n            gap: 20px;\n        }\n\n        .mazemaster-wheel-pointer {\n            position: absolute;\n            top: -20px;\n            left: 50%;\n            transform: translateX(-50%);\n            width: 0;\n            height: 0;\n            border-left: 15px solid transparent;\n            border-right: 15px solid transparent;\n            border-top: 30px solid #fff;\n            z-index: 10;\n            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));\n        }\n\n        #mazemaster_wheel_canvas {\n            border-radius: 50%;\n            box-shadow: 0 0 30px rgba(0,0,0,0.5), inset 0 0 20px rgba(255,255,255,0.1);\n            transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99);\n        }\n\n        .mazemaster-spin-btn {\n            padding: 15px 40px;\n            font-size: 1.2em;\n            font-weight: bold;\n            background: linear-gradient(135deg, #e74c3c, #c0392b);\n            color: white;\n            border: none;\n            border-radius: 30px;\n            cursor: pointer;\n            display: flex;\n            align-items: center;\n            gap: 10px;\n            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);\n            transition: transform 0.2s, box-shadow 0.2s;\n        }\n\n        .mazemaster-spin-btn:hover {\n            transform: scale(1.05);\n            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.6);\n        }\n\n        .mazemaster-spin-btn:disabled {\n            background: #555;\n            cursor: not-allowed;\n            box-shadow: none;\n            transform: none;\n        }\n\n        .mazemaster-spin-btn.respin {\n            background: linear-gradient(135deg, #f39c12, #d68910);\n            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.4);\n        }\n\n        .mazemaster-spin-btn.respin:hover {\n            box-shadow: 0 6px 20px rgba(243, 156, 18, 0.6);\n        }\n    ",document.head.appendChild(e)}const n=document.createElement("div");n.innerHTML='\n        <div id="mazemaster_wheel_modal" class="mazemaster-wheel-overlay">\n            <div class="mazemaster-wheel-container">\n                <div class="mazemaster-wheel-pointer"></div>\n                <canvas id="mazemaster_wheel_canvas" width="400" height="400"></canvas>\n                <button id="mazemaster_spin_btn" class="mazemaster-spin-btn">\n                    <i class="fa-solid fa-play"></i> SPIN\n                </button>\n            </div>\n        </div>\n    ',document.body.appendChild(n.firstElementChild);const t=document.getElementById("mazemaster_wheel_canvas");t&&function(e){const n=e.getContext("2d"),t=e.width/2,a=e.height/2,o=Math.min(t,a)-10;n.clearRect(0,0,e.width,e.height);const i=X();let s=-Math.PI/2;for(const e of S.segments){const r=e.units/i*2*Math.PI;n.beginPath(),n.moveTo(t,a),n.arc(t,a,o,s,s+r),n.closePath(),n.fillStyle=e.color,n.fill(),n.strokeStyle="#222",n.lineWidth=2,n.stroke();const l=s+r/2,m=.55*o,c=t+Math.cos(l)*m,d=a+Math.sin(l)*m;n.save(),n.translate(c,d),n.rotate(l),n.fillStyle="#fff",n.font="bold 12px Arial",n.textAlign="center",n.textBaseline="middle",n.shadowColor="rgba(0,0,0,0.5)",n.shadowBlur=3;let p=e.text||e.trigger;p.length>12&&(p=p.substring(0,10)+"..."),n.fillText(p,0,0),n.restore(),s+=r}n.beginPath(),n.arc(t,a,20,0,2*Math.PI),n.fillStyle="#333",n.fill(),n.strokeStyle="#555",n.lineWidth=3,n.stroke()}(t);const a=document.getElementById("mazemaster_spin_btn");a&&a.addEventListener("click",Z),S.isOpen=!0}async function Z(){var e,n;const t=document.getElementById("mazemaster_spin_btn");if(!t||S.isSpinning)return;t.disabled=!0,t.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> Spinning...',S.isSpinning=!0,S.pendingRespin=!1;const a=function(){const e=X();let n=Math.random()*e;for(const e of S.segments)if(n-=e.units,n<=0)return e;return S.segments[S.segments.length-1]}(),o=document.getElementById("mazemaster_wheel_canvas");if(!o)return void(S.isSpinning=!1);const i=X();let s=0;for(const e of S.segments){if(e===a)break;s+=e.units/i*360}const r=s+a.units/i*360/2,l=5+Math.floor(3*Math.random()),c=parseFloat((null===(e=o.style.transform)||void 0===e||null===(e=e.match(/rotate\((\d+\.?\d*)deg\)/))||void 0===e?void 0:e[1])||0)+360*l+(360-r);o.style.transition="transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99)",o.style.transform="rotate(".concat(c,"deg)"),await new Promise((e=>setTimeout(e,4200))),S.isSpinning=!1;const d=null===(n=C.profiles[C.currentProfile])||void 0===n||null===(n=n.segments)||void 0===n?void 0:n.find((e=>e.trigger===a.trigger));if(d&&d.command){console.log('[MazeMaster] Executing command for "'.concat(a.text,'": ').concat(d.command));try{await m(d.command)}catch(e){console.error("[MazeMaster] Error executing command:",e)}}T.wheel[C.currentProfile]={segmentName:a.text,command:(null==d?void 0:d.command)||"",timestamp:Date.now()},a.respin&&!S.hasRespun?(S.pendingRespin=!0,S.hasRespun=!0,t.disabled=!1,t.className="mazemaster-spin-btn respin",t.innerHTML='<i class="fa-solid fa-rotate"></i> RESPIN'):(!function(){const e=document.getElementById("mazemaster_wheel_modal");if(e&&e.remove(),S.isOpen=!1,B.isOpen&&B.pendingEncounter){const e=B.pendingEncounter.type;"exit_wheel"===e?(B.exitEncounterDone=!0,B.isPaused=!1,Ke()):"wheel"===e&&Pe()}}(),S.segments=[],S.isOpen=!1,S.isSpinning=!1,S.pendingRespin=!1,S.hasRespun=!1)}function $(){i.addCommandObject(s.fromProps({name:"wheel",callback:async e=>{const n=e.profile||"default",t=V(n);if(t.error)return"Error: ".concat(t.error);const a=K();return a.valid?(C.currentProfile=n,Q(),'Wheel "'.concat(n,'" opened with ').concat(t.count," segments. Click SPIN!")):"Error: ".concat(a.error)},namedArgumentList:[l.fromProps({name:"profile",description:"Name of the wheel profile to use",typeList:[r.STRING],isRequired:!1,defaultValue:"default"})],helpString:'Open a wheel by profile name. Example: /wheel profile="mywheel"'})),i.addCommandObject(s.fromProps({name:"battlebar",callback:async e=>{const n=e.profile||"default",t=ee(n);return t.error?"Error: ".concat(t.error):'Battlebar "'.concat(n,'" started! Press SPACE when the arrow is in the green zone.')},namedArgumentList:[l.fromProps({name:"profile",description:"Name of the battlebar profile to use",typeList:[r.STRING],isRequired:!1,defaultValue:"default"})],helpString:'Start a battlebar challenge. Example: /battlebar profile="boss1"'})),i.addCommandObject(s.fromProps({name:"maze",callback:async e=>{const n=e.profile||C.currentMazeProfile||"default",t=we(n);return t.error?"Error: ".concat(t.error):'Maze "'.concat(n,'" started! Use arrow keys to navigate.')},namedArgumentList:[l.fromProps({name:"profile",description:"Name of the maze profile to use",typeList:[r.STRING],isRequired:!1})],helpString:'Start a maze game. Example: /maze profile="dungeon1"'})),i.addCommandObject(s.fromProps({name:"mazeminion",callback:async e=>{if(!B.isOpen)return"No maze is currently open.";const n=e.name,t=e.message||"",a=G(n);return B.currentMinion=a?{name:a.name,imagePath:a.imagePath,message:t}:{name:n||"Unknown",imagePath:"",message:t},ke(),""},namedArgumentList:[l.fromProps({name:"name",description:"Minion name (from config) or custom name",typeList:[r.STRING],isRequired:!1}),l.fromProps({name:"message",description:"Message to display",typeList:[r.STRING],isRequired:!1})],helpString:'Set the minion display in an active maze. Example: /mazeminion name="Goblin" message="You shall not pass!"'})),console.log("[MazeMaster] Slash commands registered")}function ee(e){const n=A(e);return n?(P={isOpen:!0,profile:n,hits:0,misses:0,arrowPosition:0,arrowDirection:1,zoneStart:0,zoneEnd:0,animationId:null,lastFrameTime:0,isVictory:!1,isDefeat:!1},me(),function(){const e=document.getElementById("mazemaster_battlebar_modal");e&&e.remove();if(!document.getElementById("mazemaster_battlebar_styles")){const e=document.createElement("style");e.id="mazemaster_battlebar_styles",e.textContent="\n        .mazemaster-bb-overlay {\n            position: fixed;\n            top: 0;\n            left: 0;\n            right: 0;\n            bottom: 0;\n            background: rgba(0, 0, 0, 0.9);\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            z-index: 10010;\n        }\n\n        .mazemaster-bb-container {\n            display: flex;\n            flex-direction: column;\n            align-items: center;\n            gap: 15px;\n            padding: 25px;\n            background: #1a1a2e;\n            border-radius: 15px;\n            border: 2px solid #333;\n            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);\n            max-width: 95vw;\n            max-height: 95vh;\n            overflow-y: auto;\n        }\n\n        .mazemaster-bb-main-title {\n            font-size: 32px;\n            font-weight: bold;\n            color: #fff;\n            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);\n            text-align: center;\n        }\n\n        .mazemaster-bb-stage-title {\n            font-size: 20px;\n            color: #aaa;\n            text-align: center;\n            min-height: 24px;\n        }\n\n        .mazemaster-bb-image-display {\n            width: min(300px, 80vw);\n            height: min(300px, 40vh);\n            border: 3px solid #444;\n            border-radius: 10px;\n            overflow: hidden;\n            background: #222;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n        }\n\n        .mazemaster-bb-image-display img {\n            max-width: 100%;\n            max-height: 100%;\n            object-fit: contain;\n        }\n\n        .mazemaster-bb-stats {\n            display: flex;\n            gap: 30px;\n            font-size: 1.2em;\n            font-weight: bold;\n        }\n\n        .bb-stat-hits {\n            color: #27ae60;\n        }\n\n        .bb-stat-misses {\n            color: #e74c3c;\n        }\n\n        .mazemaster-bb-bar-container {\n            padding: 10px;\n        }\n\n        .mazemaster-bb-bar {\n            position: relative;\n            width: min(400px, 90vw);\n            height: 50px;\n            background: linear-gradient(to bottom, #c0392b, #a93226);\n            border-radius: 8px;\n            overflow: hidden;\n            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5), inset 0 2px 5px rgba(0, 0, 0, 0.3);\n        }\n\n        .mazemaster-bb-zone {\n            position: absolute;\n            height: 100%;\n            background: linear-gradient(to bottom, #27ae60, #1e8449);\n            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.2);\n        }\n\n        .mazemaster-bb-arrow {\n            position: absolute;\n            width: 6px;\n            height: 100%;\n            background: #fff;\n            box-shadow: 0 0 15px #fff, 0 0 30px rgba(255, 255, 255, 0.5);\n            left: 0;\n            transition: none;\n        }\n\n        .mazemaster-bb-instructions {\n            font-size: 1.1em;\n            color: #aaa;\n        }\n\n        .mazemaster-bb-instructions kbd {\n            background: #444;\n            padding: 5px 15px;\n            border-radius: 5px;\n            font-weight: bold;\n            color: #fff;\n            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);\n        }\n\n        .mazemaster-bb-bar.flash-hit {\n            animation: flashHit 0.3s ease;\n        }\n\n        .mazemaster-bb-bar.flash-miss {\n            animation: flashMiss 0.3s ease;\n        }\n\n        @keyframes flashHit {\n            0%, 100% { box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5); }\n            50% { box-shadow: 0 0 30px rgba(39, 174, 96, 0.8), 0 0 60px rgba(39, 174, 96, 0.5); }\n        }\n\n        @keyframes flashMiss {\n            0%, 100% { box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5); }\n            50% { box-shadow: 0 0 30px rgba(231, 76, 60, 0.8), 0 0 60px rgba(231, 76, 60, 0.5); }\n        }\n\n        .mazemaster-bb-hit-btn {\n            width: min(100%, 90vw);\n            max-width: 400px;\n            padding: 20px 30px;\n            font-size: 24px;\n            font-weight: bold;\n            background: linear-gradient(135deg, #27ae60, #2ecc71);\n            color: white;\n            border: none;\n            border-radius: 12px;\n            cursor: pointer;\n            margin-top: 10px;\n            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);\n            transition: transform 0.1s ease, box-shadow 0.1s ease;\n            touch-action: manipulation;\n            -webkit-tap-highlight-color: transparent;\n        }\n\n        .mazemaster-bb-hit-btn:hover {\n            transform: scale(1.02);\n            box-shadow: 0 8px 25px rgba(39, 174, 96, 0.5);\n        }\n\n        .mazemaster-bb-hit-btn:active {\n            transform: scale(0.98);\n            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);\n        }\n\n        .mazemaster-bb-hit-btn i {\n            margin-right: 10px;\n        }\n\n        .mazemaster-bb-hit-btn.victory {\n            background: linear-gradient(135deg, #f39c12, #e67e22);\n            box-shadow: 0 6px 20px rgba(243, 156, 18, 0.4);\n        }\n\n        .mazemaster-bb-hit-btn.victory:hover {\n            box-shadow: 0 8px 25px rgba(243, 156, 18, 0.5);\n        }\n\n        .mazemaster-bb-hit-btn.defeat {\n            background: linear-gradient(135deg, #c0392b, #e74c3c);\n            box-shadow: 0 6px 20px rgba(192, 57, 43, 0.4);\n        }\n\n        .mazemaster-bb-hit-btn.defeat:hover {\n            box-shadow: 0 8px 25px rgba(192, 57, 43, 0.5);\n        }\n    ",document.head.appendChild(e)}const n=document.createElement("div");n.innerHTML='\n        <div id="mazemaster_battlebar_modal" class="mazemaster-bb-overlay">\n            <div class="mazemaster-bb-container">\n                <div id="bb_main_title" class="mazemaster-bb-main-title"></div>\n                <div id="bb_stage_title" class="mazemaster-bb-stage-title"></div>\n                <div class="mazemaster-bb-image-display">\n                    <img id="mazemaster_bb_img" src="" alt="">\n                </div>\n                <div class="mazemaster-bb-stats">\n                    <span class="bb-stat bb-stat-hits">\n                        Hits: <span id="bb_current_hits">0</span>/<span id="bb_needed_hits">5</span>\n                    </span>\n                    <span class="bb-stat bb-stat-misses">\n                        Misses: <span id="bb_current_misses">0</span>/<span id="bb_max_misses">3</span>\n                    </span>\n                </div>\n                <div class="mazemaster-bb-bar-container">\n                    <div class="mazemaster-bb-bar">\n                        <div class="mazemaster-bb-zone" id="bb_zone"></div>\n                        <div class="mazemaster-bb-arrow" id="bb_arrow"></div>\n                    </div>\n                </div>\n                <div class="mazemaster-bb-instructions">\n                    Press <kbd>SPACE</kbd> when the arrow is in the green zone!\n                </div>\n                <div class="mazemaster-bb-action-buttons">\n                    <button id="mazemaster_bb_hit_btn" class="mazemaster-bb-hit-btn">\n                        <i class="fa-solid fa-bullseye"></i> HIT!\n                    </button>\n                    <button id="mazemaster_bb_pow_btn" class="mazemaster-bb-pow-btn" style="display: none;">\n                        <i class="fa-solid fa-bolt"></i> POW! (<span id="bb_pow_count">0</span>)\n                    </button>\n                    <button id="mazemaster_bb_grandpow_btn" class="mazemaster-bb-grandpow-btn" style="display: none;">\n                        <i class="fa-solid fa-star"></i> GRANDPOW! (<span id="bb_grandpow_count">0</span>)\n                    </button>\n                </div>\n            </div>\n        </div>\n    ',document.body.appendChild(n.firstElementChild),de(),ce(),pe(),ne();const t=document.getElementById("mazemaster_bb_hit_btn");t&&t.addEventListener("click",te);const a=document.getElementById("mazemaster_bb_pow_btn");a&&a.addEventListener("click",oe);const o=document.getElementById("mazemaster_bb_grandpow_btn");o&&o.addEventListener("click",re);ae(),se()}(),function(){const e=100/z[P.profile.difficulty||3].traverseTime;function n(t){if(!P.isOpen)return;0===P.lastFrameTime&&(P.lastFrameTime=t);const a=t-P.lastFrameTime;P.lastFrameTime=t,P.arrowPosition+=e*a*P.arrowDirection,P.arrowPosition>=100?(P.arrowPosition=100,P.arrowDirection=-1):P.arrowPosition<=0&&(P.arrowPosition=0,P.arrowDirection=1),function(){const e=document.getElementById("bb_arrow");e&&(e.style.left="".concat(P.arrowPosition,"%"))}(),P.animationId=requestAnimationFrame(n)}P.lastFrameTime=0,P.animationId=requestAnimationFrame(n)}(),document.addEventListener("keydown",ue),{success:!0}):{error:'Battlebar profile "'.concat(e,'" not found')}}function ne(){const e=P.profile||{},n=document.getElementById("bb_main_title");n&&(n.textContent=e.mainTitle||"");const t=document.getElementById("bb_stage_title");if(t){const n=(e.images||[])[P.hits||0];t.textContent=(null==n?void 0:n.stageMessage)||""}}function te(e){if(e.preventDefault(),!P.isOpen)return;if(P.isVictory||P.isDefeat)return void le();const n=P.arrowPosition>=P.zoneStart&&P.arrowPosition<=P.zoneEnd;console.log("[MazeMaster] Hit check:",{arrowPosition:P.arrowPosition,zoneStart:P.zoneStart,zoneEnd:P.zoneEnd,inZone:n}),n?ge():be()}function ae(){const e=document.getElementById("mazemaster_bb_pow_btn"),n=document.getElementById("bb_pow_count");e&&B.isOpen&&B.inventory.pow>0?(e.style.display="",n&&(n.textContent=B.inventory.pow)):e&&(e.style.display="none")}function oe(e){e.preventDefault(),!B.isOpen||B.inventory.pow<=0||P.isOpen&&(P.isVictory||P.isDefeat||(Le("pow"),ae(),P.hits++,updateBattlebarDisplay(),P.hits>=P.profile.hitsToWin&&fe()))}function ie(){return B.pendingEncounter&&"exit_battlebar"===B.pendingEncounter.type}function se(){const e=document.getElementById("mazemaster_bb_grandpow_btn"),n=document.getElementById("bb_grandpow_count");e&&B.isOpen&&B.inventory.grandpow>0&&!ie()?(e.style.display="",n&&(n.textContent=B.inventory.grandpow)):e&&(e.style.display="none")}function re(e){e.preventDefault(),!B.isOpen||B.inventory.grandpow<=0||P.isOpen&&(P.isVictory||P.isDefeat||(ie()?console.log("[MazeMaster] GRANDPOW cannot be used against the main minion!"):(Le("grandpow"),se(),P.hits=P.profile.hitsToWin,updateBattlebarDisplay(),fe())))}function le(){const e=P.isVictory,n=P.isDefeat;P.animationId&&cancelAnimationFrame(P.animationId),document.removeEventListener("keydown",ue);const t=document.getElementById("mazemaster_battlebar_modal");if(t&&t.remove(),P.isOpen=!1,P.isVictory=!1,P.isDefeat=!1,B.isOpen&&B.pendingEncounter){const t=B.pendingEncounter.type;if(e)"exit_battlebar"===t?(B.exitEncounterDone=!0,B.isPaused=!1,Ke()):Pe();else if(n){const e=B.profile.onBattlebarLoss||"continue";if("exit_battlebar"===t)"gameover"===e?Je():Ve();else switch(e){case"gameover":Je();break;case"respawn":Ve();break;default:Pe()}}}}function me(){const e=P.profile.difficulty||3,n=z[e];if(!n)return void console.error("[MazeMaster] Invalid difficulty level:",e);const t=100*n.zoneWidth,a=100-t;P.zoneStart=Math.random()*a,P.zoneEnd=P.zoneStart+t,console.log("[MazeMaster] Zone randomized:",{difficulty:e,zoneWidth:t,zoneStart:P.zoneStart,zoneEnd:P.zoneEnd})}function ce(){const e=document.getElementById("bb_zone");e&&(e.style.left="".concat(P.zoneStart,"%"),e.style.width="".concat(P.zoneEnd-P.zoneStart,"%"))}function de(){const e=document.getElementById("bb_current_hits"),n=document.getElementById("bb_needed_hits"),t=document.getElementById("bb_current_misses"),a=document.getElementById("bb_max_misses");e&&(e.textContent=P.hits),n&&(n.textContent=P.profile.hitsToWin||5),t&&(t.textContent=P.misses),a&&(a.textContent=P.profile.missesToLose||3)}function pe(){const e=document.getElementById("mazemaster_bb_img");if(!e)return;const n=P.profile.images||[];if(0===n.length)return void(e.style.display="none");const t=Math.min(P.hits,n.length-1);e.src="/"+n[t].path,e.style.display="block"}function ue(e){if("Space"!==e.code||!P.isOpen)return;if(e.preventDefault(),P.isVictory||P.isDefeat)return void le();P.arrowPosition>=P.zoneStart&&P.arrowPosition<=P.zoneEnd?ge():be()}async function ge(){P.hits++;const e=document.querySelector(".mazemaster-bb-bar");if(e&&(e.classList.remove("flash-hit","flash-miss"),e.offsetWidth,e.classList.add("flash-hit")),de(),pe(),ne(),P.profile.hitCommand)try{await m(P.profile.hitCommand)}catch(e){console.error("[MazeMaster] Hit command error:",e)}P.hits>=(P.profile.hitsToWin||5)?await fe():(me(),ce())}async function be(){P.misses++;const e=document.querySelector(".mazemaster-bb-bar");if(e&&(e.classList.remove("flash-hit","flash-miss"),e.offsetWidth,e.classList.add("flash-miss")),de(),P.profile.missCommand)try{await m(P.profile.missCommand)}catch(e){console.error("[MazeMaster] Miss command error:",e)}P.misses>=(P.profile.missesToLose||3)&&await async function(){const e=C.currentBattlebarProfile||"default";T.battlebar[e]={result:"lose",hits:P.hits,misses:P.misses,timestamp:Date.now()},P.isDefeat=!0,P.animationId&&(cancelAnimationFrame(P.animationId),P.animationId=null);const n=document.querySelector(".mazemaster-bb-bar-container"),t=document.querySelector(".mazemaster-bb-instructions");n&&(n.style.display="none");t&&(t.style.display="none");const a=document.getElementById("bb_stage_title");a&&(a.textContent="Defeat...");const o=document.getElementById("mazemaster_bb_hit_btn");o&&(o.innerHTML='<i class="fa-solid fa-times"></i> Close',o.classList.add("defeat"));if(P.profile.loseCommand)try{await m(P.profile.loseCommand)}catch(e){console.error("[MazeMaster] Lose command error:",e)}}()}async function fe(){const e=C.currentBattlebarProfile||"default";if(T.battlebar[e]={result:"win",hits:P.hits,misses:P.misses,timestamp:Date.now()},P.isVictory=!0,B.isOpen&&B.pendingEncounter){var n,t,a;const e=P.profile;100*Math.random()<(null!==(n=e.keyDropChance)&&void 0!==n?n:40)&&Te("key"),100*Math.random()<(null!==(t=e.powDropChance)&&void 0!==t?t:20)&&Te("pow"),100*Math.random()<(null!==(a=e.stealthDropChance)&&void 0!==a?a:10)&&Te("stealth")}P.animationId&&(cancelAnimationFrame(P.animationId),P.animationId=null);const o=document.querySelector(".mazemaster-bb-bar-container"),i=document.querySelector(".mazemaster-bb-instructions");o&&(o.style.display="none"),i&&(i.style.display="none");const s=P.profile.images||[],r=s.length>0?s[s.length-1]:null;if(r){const e=document.getElementById("mazemaster_bb_img");e&&(e.src="/"+r.path)}const l=document.getElementById("bb_stage_title");if(l){const e=(null==r?void 0:r.stageMessage)||"Victory!";l.textContent=e}const c=document.getElementById("mazemaster_bb_hit_btn");if(c&&(c.innerHTML='<i class="fa-solid fa-check"></i> Close',c.classList.add("victory")),P.profile.winCommand)try{await m(P.profile.winCommand)}catch(e){console.error("[MazeMaster] Win command error:",e)}}function ve(e){const n=[];for(let t=0;t<e;t++){n[t]=[];for(let a=0;a<e;a++)n[t][a]={walls:{top:!0,right:!0,bottom:!0,left:!0},visited:!1,minion:null,trap:null}}const t=[];let a={x:0,y:0};function o(t,a){const o=[];return a>0&&!n[a-1][t].visited&&o.push({x:t,y:a-1,dir:"top"}),t<e-1&&!n[a][t+1].visited&&o.push({x:t+1,y:a,dir:"right"}),a<e-1&&!n[a+1][t].visited&&o.push({x:t,y:a+1,dir:"bottom"}),t>0&&!n[a][t-1].visited&&o.push({x:t-1,y:a,dir:"left"}),o}for(n[0][0].visited=!0;;){const e=o(a.x,a.y);if(e.length>0){const o=e[Math.floor(Math.random()*e.length)];t.push(a),"top"===o.dir?(n[a.y][a.x].walls.top=!1,n[o.y][o.x].walls.bottom=!1):"right"===o.dir?(n[a.y][a.x].walls.right=!1,n[o.y][o.x].walls.left=!1):"bottom"===o.dir?(n[a.y][a.x].walls.bottom=!1,n[o.y][o.x].walls.top=!1):"left"===o.dir&&(n[a.y][a.x].walls.left=!1,n[o.y][o.x].walls.right=!1),a={x:o.x,y:o.y},n[a.y][a.x].visited=!0}else{if(!(t.length>0))break;a=t.pop()}}!function(e,n){const t=Math.floor(n*n*.08);for(let a=0;a<t;a++){he(e,1+Math.floor(Math.random()*(n-2)),1+Math.floor(Math.random()*(n-2)),["top","right","bottom","left"][Math.floor(4*Math.random())],n)}}(n,e);for(let t=0;t<e;t++)for(let a=0;a<e;a++)n[t][a].visited=!1;return n}function he(e,n,t,a,o){const i=e[t][n];"top"===a&&t>0?(i.walls.top=!1,e[t-1][n].walls.bottom=!1):"right"===a&&n<o-1?(i.walls.right=!1,e[t][n+1].walls.left=!1):"bottom"===a&&t<o-1?(i.walls.bottom=!1,e[t+1][n].walls.top=!1):"left"===a&&n>0&&(i.walls.left=!1,e[t][n-1].walls.right=!1)}function ze(e){const n=100*Math.random();return n<(e.chestMimicPercent||0)?"mimic":n<(e.chestMimicPercent||0)+(e.chestLockedPercent||0)?"locked":"normal"}function ye(e,n,t){const a=[];for(let e=0;e<t;e++)for(let n=0;n<t;n++)0===n&&0===e||n===t-1&&e===t-1||a.push({x:n,y:e});!function(e){for(let n=e.length-1;n>0;n--){const t=Math.floor(Math.random()*(n+1));[e[n],e[t]]=[e[t],e[n]]}}(a);const o=function(e,n){const t={minionPlacements:[],trapPlacements:[],chestCount:0},a=e.chestTilePercent||0,o=e.minionEncounters||[],i=e.trapEncounters||[],s=a+o.reduce(((e,n)=>e+(n.percent||0)),0)+i.reduce(((e,n)=>e+(n.percent||0)),0);let r=1;s>100&&(r=100/s,console.log("[MazeMaster] Distribution over 100% (".concat(s,"%), scaling down by ").concat(r.toFixed(2)))),t.chestCount=Math.floor(n*(a*r)/100);for(const e of o){const a=(e.percent||0)*r,o=Math.floor(n*a/100);o>0&&t.minionPlacements.push({minionId:e.minionId,count:o})}for(const e of i){const a=(e.percent||0)*r,o=Math.floor(n*a/100);o>0&&t.trapPlacements.push({trapId:e.trapId,count:o})}return t}(n,a.length);let i=0;for(let t=0;t<o.chestCount&&i<a.length;t++){const t=a[i++],o=ze(n);e[t.y][t.x].chest={type:o,opened:!1}}const s=i;for(const n of o.minionPlacements)for(let t=0;t<n.count&&i<a.length;t++){const t=a[i++];e[t.y][t.x].minion={minionId:n.minionId,triggered:!1}}const r=i-s,l=i;for(const n of o.trapPlacements)for(let t=0;t<n.count&&i<a.length;t++){const t=a[i++];e[t.y][t.x].trap={trapId:n.trapId,triggered:!1}}const m=i-l;console.log("[MazeMaster] Placed ".concat(o.chestCount," chests, ").concat(r," minions, ").concat(m," traps"))}function _e(e){return e&&0!==e.length?e[Math.floor(Math.random()*e.length)]:null}function xe(e){return e<=5?60:e<=7?48:e<=10?38:e<=12?32:e<=15?26:20}function we(e){var n;const t=q(e);if(!t)return console.error('[MazeMaster] Maze profile "'.concat(e,'" not found')),{error:'Profile "'.concat(e,'" not found')};const a=t.gridSize||10,o=ve(a);ye(o,t,a);const i=t.startingInventory||{key:0,stealth:0,pow:0,grandpow:0};let s={name:"The Maze",imagePath:"",message:"Find your way to the exit..."};const r=t.mainMinion?G(t.mainMinion):null;return null!==(n=t.storyConfig)&&void 0!==n&&n.mainStory?s={name:(null==r?void 0:r.name)||"Story",imagePath:(null==r?void 0:r.imagePath)||"",message:t.storyConfig.mainStory}:r&&(s={name:r.name,imagePath:r.imagePath,message:t.mainMinionIntroMessage||"Welcome to my maze..."}),B={isOpen:!0,profile:t,profileName:e,grid:o,size:a,playerX:0,playerY:0,exitX:a-1,exitY:a-1,visited:new Set(["0,0"]),isVictory:!1,currentMinion:s,isPaused:!1,pendingEncounter:null,exitEncounterDone:!1,pendingConfirmation:null,pendingChest:null,inventory:{key:i.key||0,stealth:i.stealth||0,pow:i.pow||0,grandpow:i.grandpow||0},shownMilestones:new Set},Ee(),Ie(),ke(),document.addEventListener("keydown",Ce),console.log('[MazeMaster] Maze "'.concat(e,'" started (').concat(a,"x").concat(a,")")),{success:!0}}function Ee(){const e=document.getElementById("mazemaster_maze_modal");e&&e.remove();const t=xe(B.size),a=document.createElement("div");a.id="mazemaster_maze_modal",a.innerHTML='\n        <div class="mazemaster-maze-overlay">\n            <div class="mazemaster-maze-container">\n                \x3c!-- Hero Section --\x3e\n                <div class="mazemaster-maze-hero">\n                    <div class="mazemaster-maze-hero-avatar">\n                        <img id="maze_minion_img" src="" alt="" style="display: none;">\n                    </div>\n                    <div class="mazemaster-maze-hero-message">\n                        <div id="maze_minion_name" class="maze-minion-name"></div>\n                        <div id="maze_minion_message" class="maze-minion-message"></div>\n                        <div id="maze_encounter_confirm" class="maze-encounter-confirm" style="display: none;"></div>\n                    </div>\n                </div>\n\n                \x3c!-- Inventory Display --\x3e\n                <div class="mazemaster-maze-inventory">\n                    <div class="inventory-item" title="Keys">\n                        <i class="fa-solid fa-key"></i>\n                        <span id="maze_inv_key">0</span>\n                    </div>\n                    <div class="inventory-item" title="Stealth">\n                        <i class="fa-solid fa-user-ninja"></i>\n                        <span id="maze_inv_stealth">0</span>\n                    </div>\n                    <div class="inventory-item" title="POW">\n                        <i class="fa-solid fa-bolt"></i>\n                        <span id="maze_inv_pow">0</span>\n                    </div>\n                    <div class="inventory-item grandpow" title="GRANDPOW - Instant Win!">\n                        <i class="fa-solid fa-star"></i>\n                        <span id="maze_inv_grandpow">0</span>\n                    </div>\n                </div>\n\n                \x3c!-- Maze Grid --\x3e\n                <div id="maze_grid" class="mazemaster-maze-grid" style="grid-template-columns: repeat('.concat(B.size,", ").concat(t,'px);">\n                    \x3c!-- Grid cells rendered dynamically --\x3e\n                </div>\n\n                \x3c!-- Mobile Controls --\x3e\n                <div class="mazemaster-maze-controls">\n                    <button class="maze-arrow-btn menu_button" data-dir="up">\n                        <i class="fa-solid fa-arrow-up"></i>\n                    </button>\n                    <div class="maze-arrow-row">\n                        <button class="maze-arrow-btn menu_button" data-dir="left">\n                            <i class="fa-solid fa-arrow-left"></i>\n                        </button>\n                        <button class="maze-arrow-btn menu_button" data-dir="down">\n                            <i class="fa-solid fa-arrow-down"></i>\n                        </button>\n                        <button class="maze-arrow-btn menu_button" data-dir="right">\n                            <i class="fa-solid fa-arrow-right"></i>\n                        </button>\n                    </div>\n                </div>\n\n                \x3c!-- Action Buttons --\x3e\n                <div class="mazemaster-maze-action-bar">\n                    <button id="maze_save_exit_btn" class="menu_button maze-action-btn">\n                        <i class="fa-solid fa-floppy-disk"></i> Save & Exit\n                    </button>\n                    <button id="maze_exit_btn" class="menu_button maze-action-btn maze-exit-btn">\n                        <i class="fa-solid fa-door-open"></i> Exit\n                    </button>\n                </div>\n\n                \x3c!-- Close Button (shown on victory) --\x3e\n                <button id="maze_close_btn" class="menu_button menu_button_primary maze-close-btn" style="display: none;">\n                    <i class="fa-solid fa-check"></i> Close\n                </button>\n            </div>\n        </div>\n\n        <style>\n            .mazemaster-maze-overlay {\n                position: fixed;\n                top: 0; left: 0; right: 0; bottom: 0;\n                background: rgba(0, 0, 0, 0.95);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                z-index: 10002;\n            }\n\n            .mazemaster-maze-container {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                gap: 15px;\n                padding: 20px;\n                max-width: 95vw;\n                max-height: 95vh;\n                background: #1a1a2e;\n                border-radius: 15px;\n                border: 2px solid #333;\n                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);\n            }\n\n            .mazemaster-maze-hero {\n                display: flex;\n                width: 100%;\n                max-width: 500px;\n                background: rgba(0, 0, 0, 0.3);\n                border-radius: 10px;\n                padding: 12px;\n                gap: 12px;\n                border: 1px solid #444;\n            }\n\n            .mazemaster-maze-hero-avatar {\n                width: 80px;\n                height: 80px;\n                min-width: 80px;\n                border-radius: 8px;\n                overflow: hidden;\n                background: #16213e;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n            }\n\n            .mazemaster-maze-hero-avatar img {\n                width: 100%;\n                height: 100%;\n                object-fit: cover;\n            }\n\n            .mazemaster-maze-hero-message {\n                flex: 1;\n                display: flex;\n                flex-direction: column;\n                justify-content: center;\n            }\n\n            .maze-minion-name {\n                font-weight: bold;\n                font-size: 1.2em;\n                color: #e94560;\n                margin-bottom: 8px;\n            }\n\n            .maze-minion-message {\n                color: #eee;\n                font-style: italic;\n                line-height: 1.4;\n            }\n\n            .mazemaster-maze-grid {\n                display: grid;\n                gap: 0;\n                background: #333;\n                padding: 2px;\n                border-radius: 5px;\n                border: 2px solid #555;\n            }\n\n            .maze-cell {\n                width: ').concat(t,"px;\n                height: ").concat(t,"px;\n                background: #1a1a2e;\n                position: relative;\n                box-sizing: border-box;\n            }\n\n            .maze-cell.hidden {\n                background: #0a0a0a;\n            }\n\n            .maze-cell.wall-top { border-top: 2px solid #fff; }\n            .maze-cell.wall-right { border-right: 2px solid #fff; }\n            .maze-cell.wall-bottom { border-bottom: 2px solid #fff; }\n            .maze-cell.wall-left { border-left: 2px solid #fff; }\n\n            .maze-cell.player::after {\n                content: '';\n                position: absolute;\n                top: 50%; left: 50%;\n                transform: translate(-50%, -50%);\n                width: 60%; height: 60%;\n                background: #3498db;\n                border-radius: 50%;\n                box-shadow: 0 0 10px #3498db;\n            }\n\n            .maze-cell.exit::before {\n                content: '';\n                position: absolute;\n                top: 50%; left: 50%;\n                transform: translate(-50%, -50%);\n                width: 70%; height: 70%;\n                background: #27ae60;\n                border-radius: 3px;\n            }\n\n            .maze-cell.visited:not(.hidden) {\n                background: #1e2a4a;\n            }\n\n            .mazemaster-maze-controls {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                gap: 5px;\n            }\n\n            .maze-arrow-row {\n                display: flex;\n                gap: 5px;\n            }\n\n            .maze-arrow-btn {\n                width: 50px;\n                height: 50px;\n                font-size: 1.5em;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n            }\n\n            .mazemaster-maze-action-bar {\n                display: flex;\n                gap: 8px;\n                margin-top: 10px;\n                width: 100%;\n                max-width: min(400px, 90vw);\n                justify-content: center;\n                flex-wrap: wrap;\n            }\n\n            .maze-action-btn {\n                flex: 1 1 auto;\n                min-width: 100px;\n                max-width: 180px;\n                padding: 10px 16px;\n                font-size: 0.9em;\n                border-radius: 8px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 6px;\n                transition: transform 0.1s, box-shadow 0.1s;\n                white-space: nowrap;\n            }\n\n            .maze-action-btn i {\n                font-size: 0.9em;\n            }\n\n            .maze-action-btn:hover {\n                transform: scale(1.02);\n            }\n\n            .maze-exit-btn {\n                background: linear-gradient(to bottom, #555, #444) !important;\n                box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);\n            }\n\n            .maze-exit-btn:hover {\n                background: linear-gradient(to bottom, #666, #555) !important;\n            }\n\n            .maze-close-btn {\n                padding: 12px 30px;\n                font-size: 1em;\n                max-width: min(300px, 80vw);\n            }\n\n            .maze-cell.victory-glow {\n                animation: victoryPulse 1s infinite;\n            }\n\n            @keyframes victoryPulse {\n                0%, 100% { background: #27ae60; }\n                50% { background: #2ecc71; }\n            }\n        </style>\n    "),document.body.appendChild(a),a.querySelectorAll(".maze-arrow-btn").forEach((e=>{e.addEventListener("click",(()=>{const n=e.dataset.dir;"up"===n?Se(0,-1):"down"===n?Se(0,1):"left"===n?Se(-1,0):"right"===n&&Se(1,0)}))}));const i=document.getElementById("maze_close_btn");i&&i.addEventListener("click",Me);const s=document.getElementById("maze_save_exit_btn");s&&s.addEventListener("click",(async()=>{!function(){if(!B.isOpen||!B.profileName)return console.warn("[MazeMaster] No active maze to save"),!1;const e={profileName:B.profileName,size:B.size,playerX:B.playerX,playerY:B.playerY,exitX:B.exitX,exitY:B.exitY,visited:Array.from(B.visited),inventory:n({},B.inventory),exitEncounterDone:B.exitEncounterDone,shownMilestones:Array.from(B.shownMilestones||[]),grid:B.grid.map((e=>e.map((e=>({walls:e.walls,visited:e.visited,minion:e.minion,trap:e.trap,chest:e.chest}))))),timestamp:Date.now()};C.savedMazes[B.profileName]=e,o(),console.log('[MazeMaster] Maze progress saved for "'.concat(B.profileName,'"'))}(),Me(),cn()}));const r=document.getElementById("maze_exit_btn");r&&r.addEventListener("click",(async()=>{await d("Exit without saving? Progress will be lost.",p.CONFIRM)&&Me()}))}function Me(){B.isOpen=!1,document.removeEventListener("keydown",Ce);const e=document.getElementById("mazemaster_maze_modal");e&&e.remove()}function Ie(){const{grid:e,size:n,playerX:t,playerY:a,visited:o,exitX:i,exitY:s,isVictory:r}=B,l=document.getElementById("maze_grid");if(!l)return;const m=xe(n);l.style.gridTemplateColumns="repeat(".concat(n,", ").concat(m,"px)"),l.innerHTML="";for(let c=0;c<n;c++)for(let d=0;d<n;d++){const n=e[c][d],p=document.createElement("div");p.className="maze-cell",p.style.width="".concat(m,"px"),p.style.height="".concat(m,"px");const u="".concat(d,",").concat(c),g=o.has(u),b=d===t&&c===a,f=d===i&&c===s;g?(p.classList.add("visited"),n.walls.top&&p.classList.add("wall-top"),n.walls.right&&p.classList.add("wall-right"),n.walls.bottom&&p.classList.add("wall-bottom"),n.walls.left&&p.classList.add("wall-left")):p.classList.add("hidden"),b&&p.classList.add("player"),f&&g&&(p.classList.add("exit"),r&&p.classList.add("victory-glow")),n.minion&&g&&(p.classList.add("has-minion"),n.minion.triggered&&p.classList.add("minion-triggered")),n.chest&&g&&(p.classList.add("has-chest"),"locked"===n.chest.type&&p.classList.add("chest-locked"),n.chest.opened&&p.classList.add("chest-opened")),n.trap&&g&&(p.classList.add("has-trap"),n.trap.triggered&&p.classList.add("trap-triggered")),l.appendChild(p)}}function ke(){const{currentMinion:e,isVictory:n,profile:t}=B,a=document.getElementById("maze_minion_img"),o=document.getElementById("maze_minion_name"),i=document.getElementById("maze_minion_message");n?(t.winImage&&a&&(a.src=t.winImage,a.style.display=""),o&&(o.textContent="Victory!"),i&&(i.textContent=t.winMessage||"You escaped the maze!")):e&&(e.imagePath&&a?(a.src=e.imagePath,a.style.display=""):a&&(a.style.display="none"),o&&(o.textContent=e.name||""),i&&(i.textContent=e.message||""))}function Ce(e){if(!B.isOpen||B.isVictory)return;let n=0,t=0;if("ArrowUp"===e.key)t=-1;else if("ArrowDown"===e.key)t=1;else if("ArrowLeft"===e.key)n=-1;else{if("ArrowRight"!==e.key)return;n=1}e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),Se(n,t)}function Se(e,n){if(!B.isOpen||B.isVictory)return;if(B.isPaused)return;const{playerX:t,playerY:a,grid:o,size:i}=B,s=t+e,r=a+n;if(s<0||s>=i||r<0||r>=i)return;const l=o[a][t];if(1===e&&l.walls.right)return;if(-1===e&&l.walls.left)return;if(1===n&&l.walls.bottom)return;if(-1===n&&l.walls.top)return;if(B.playerX=s,B.playerY=r,B.visited.add("".concat(s,",").concat(r)),Ie(),s===B.exitX&&r===B.exitY)return void async function(){const e=B.profile;if(!e.mainMinion||B.exitEncounterDone)return void Ke();const n=G(e.mainMinion);if(!n)return void Ke();B.isPaused=!0,B.currentMinion={name:n.name,imagePath:n.imagePath,message:"You've reached the exit... but first, face me!"},ke();const t=e.mainMinionExitType||"messenger",a=e.mainMinionExitProfile;switch(t){case"messenger":await(o=2e3,new Promise((e=>setTimeout(e,o)))),B.exitEncounterDone=!0,B.isPaused=!1,Ke();break;case"battlebar":a?(B.pendingEncounter={type:"exit_battlebar",profile:a},ee(a)):(B.exitEncounterDone=!0,B.isPaused=!1,Ke());break;case"prizewheel":a?(B.pendingEncounter={type:"exit_wheel",profile:a},V(a),Q()):(B.exitEncounterDone=!0,B.isPaused=!1,Ke());break;default:Ke()}var o}();const m=o[r][s];!m.chest||m.chest.opened?!m.minion||m.minion.triggered?!m.trap||m.trap.triggered?(function(){const e=B.profile;if(!e.mainMinion)return;if(!e.mainMinionRandomChance)return;if(!e.mainMinionRandomMessages||0===e.mainMinionRandomMessages.length)return;if(100*Math.random()>e.mainMinionRandomChance)return;const n=G(e.mainMinion);if(!n)return;const t=_e(e.mainMinionRandomMessages);if(!t)return;B.currentMinion={name:n.name,imagePath:n.imagePath,message:t},ke()}(),function(){const e=B.profile;if(!e.storyConfig||!e.storyConfig.milestones||0===e.storyConfig.milestones.length)return;const n=B.size*B.size,t=B.visited.size,a=Math.floor(t/n*100);for(const n of e.storyConfig.milestones)if(a>=n.percent&&!B.shownMilestones.has(n.percent)){B.shownMilestones.add(n.percent);const t=e.mainMinion?G(e.mainMinion):null;return B.currentMinion={name:(null==t?void 0:t.name)||"Story",imagePath:(null==t?void 0:t.imagePath)||"",message:n.storyUpdate},void ke()}}()):async function(e,n,t){const a=U(e);if(!a)return void console.warn('[MazeMaster] Trap "'.concat(e,'" not found'));if(B.grid[t][n].trap.triggered=!0,Ie(),B.isPaused=!0,B.currentMinion={name:a.name,imagePath:a.imagePath,message:a.message||"You triggered a trap!"},ke(),a.script&&a.script.trim())try{const{executeSlashCommandsWithOptions:e}=SillyTavern.getContext();e&&(console.log("[MazeMaster] Executing trap script for ".concat(a.name)),await e(a.script))}catch(e){console.error("[MazeMaster] Error executing trap script:",e)}!function(){var e;const n=document.getElementById("maze_encounter_confirm");if(!n)return;n.innerHTML='\n        <button id="maze_trap_continue" class="menu_button maze-confirm-btn">Continue</button>\n    ',n.style.display="flex",null===(e=document.getElementById("maze_trap_continue"))||void 0===e||e.addEventListener("click",(()=>{n.style.display="none",n.innerHTML="",Pe()}))}()}(m.trap.trapId,s,r):async function(e,n,t){const a=G(e);if(!a)return void console.warn('[MazeMaster] Minion "'.concat(e,'" not found'));B.grid[t][n].minion.triggered=!0,Ie(),B.isPaused=!0;const o=_e(a.messages)||"You encountered ".concat(a.name,"!");if(B.currentMinion={name:a.name,imagePath:a.imagePath,message:o},ke(),a.encounterScript&&a.encounterScript.trim())try{const{executeSlashCommandsWithOptions:e}=SillyTavern.getContext();e&&(console.log("[MazeMaster] Executing encounter script for ".concat(a.name)),await e(a.encounterScript))}catch(e){console.error("[MazeMaster] Error executing encounter script:",e)}const i=a.type||"messenger";!function(e,n,t,a){var o,i,s,r,l;const m=G(e),c="messenger"!==a&&"merchant"!==a&&B.inventory.stealth>0;B.pendingConfirmation={type:a,minionId:e,x:n,y:t,canSlipAway:c};const d=document.getElementById("maze_minion_message");if(!d)return;let p="";if("messenger"===a)p='<button id="maze_confirm_ok" class="menu_button maze-confirm-btn">OK</button>';else if("merchant"===a){const e=m.merchantItemCount||{min:1,max:3},n=e.min+Math.floor(Math.random()*(e.max-e.min+1));B.pendingConfirmation.merchantItemCount=n;const t="I'll give you a GRANDPOW for ".concat(n," of your items...");B.currentMinion.message=t,ke(),p='\n            <button id="maze_confirm_accept" class="menu_button maze-confirm-btn maze-accept-btn">Accept Trade</button>\n            <button id="maze_confirm_decline" class="menu_button maze-confirm-btn">Decline</button>\n        '}else{p='<button id="maze_confirm_action" class="menu_button maze-confirm-btn">'.concat("battlebar"===a?"Fight!":"Spin!","</button>"),c&&(p+='<button id="maze_confirm_slip" class="menu_button maze-confirm-btn maze-slip-btn">Slip Away</button>')}const u=d.innerHTML;d.innerHTML=u+'<div class="maze-confirm-buttons">'.concat(p,"</div>"),null===(o=document.getElementById("maze_confirm_ok"))||void 0===o||o.addEventListener("click",We),null===(i=document.getElementById("maze_confirm_action"))||void 0===i||i.addEventListener("click",Ge),null===(s=document.getElementById("maze_confirm_slip"))||void 0===s||s.addEventListener("click",Fe),null===(r=document.getElementById("maze_confirm_accept"))||void 0===r||r.addEventListener("click",Ye),null===(l=document.getElementById("maze_confirm_decline"))||void 0===l||l.addEventListener("click",Ue)}(e,n,t,i)}(m.minion.minionId,s,r):function(e,n,t){B.isPaused=!0,B.pendingChest={chestData:e,x:n,y:t};const a="locked"===e.type,o=B.inventory.key>0;B.currentMinion={name:a?"Locked Chest":"Chest",imagePath:"",message:a?o?"A locked chest! Use a key to open it?":"A locked chest! You need a Key to open it.":"You found a chest!"},ke(),function(e,n){var t,a,o;const i=document.getElementById("maze_encounter_confirm");if(!i)return;let s="";s=e?n?'\n                <button id="maze_chest_unlock" class="menu_button maze-confirm-btn">Unlock</button>\n                <button id="maze_chest_ignore" class="menu_button maze-confirm-btn">Ignore</button>\n            ':'\n                <button id="maze_chest_ignore" class="menu_button maze-confirm-btn">Continue</button>\n            ':'\n            <button id="maze_chest_open" class="menu_button maze-confirm-btn">Open</button>\n            <button id="maze_chest_ignore" class="menu_button maze-confirm-btn">Ignore</button>\n        ';i.innerHTML=s,i.style.display="flex",null===(t=document.getElementById("maze_chest_open"))||void 0===t||t.addEventListener("click",Oe),null===(a=document.getElementById("maze_chest_unlock"))||void 0===a||a.addEventListener("click",De),null===(o=document.getElementById("maze_chest_ignore"))||void 0===o||o.addEventListener("click",Ne)}(a,o)}(m.chest,s,r)}function Pe(){B.isPaused=!1,B.pendingEncounter=null;const e=B.profile;if(e.mainMinion){const n=G(e.mainMinion);if(n)return B.currentMinion={name:n.name,imagePath:n.imagePath,message:"Continue onward..."},void ke()}B.currentMinion={name:"The Maze",imagePath:"",message:"Find your way to the exit..."},ke()}function Be(){const e=document.getElementById("maze_inv_key"),n=document.getElementById("maze_inv_stealth"),t=document.getElementById("maze_inv_pow"),a=document.getElementById("maze_inv_grandpow");e&&(e.textContent=B.inventory.key),n&&(n.textContent=B.inventory.stealth),t&&(t.textContent=B.inventory.pow),a&&(a.textContent=B.inventory.grandpow||0)}function Te(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;void 0!==B.inventory[e]&&(B.inventory[e]+=n,Be())}function Le(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;void 0!==B.inventory[e]&&(B.inventory[e]=Math.max(0,B.inventory[e]-n),Be())}function Oe(){const e=document.getElementById("maze_encounter_confirm");e&&(e.style.display="none",e.innerHTML="");const{chestData:n,x:t,y:a}=B.pendingChest||{};n&&(B.grid[a][t].chest.opened=!0,Ie(),"mimic"!==n.type?function(){B.pendingChest=null;const e=Ae(B.profile,!1);je(e),qe(e,"Chest")}():He(t,a))}function De(){const e=document.getElementById("maze_encounter_confirm");e&&(e.style.display="none",e.innerHTML="");const{chestData:n,x:t,y:a}=B.pendingChest||{};n&&(Le("key"),B.grid[a][t].chest.opened=!0,Ie(),"mimic"!==n.type?function(){B.pendingChest=null;const e=Ae(B.profile,!0);je(e),qe(e,"Locked Chest")}():He(t,a))}function Ne(){const e=document.getElementById("maze_encounter_confirm");e&&(e.style.display="none",e.innerHTML=""),B.pendingChest=null,Pe()}function Ae(e,n){const t={key:0,pow:0,stealth:0,grandpow:0},a=e.chestLootMin||1,o=e.chestLootMax||2,i=a+Math.floor(Math.random()*(o-a+1)),s=n?{key:e.lockedChestKeyChance||40,pow:e.lockedChestPowChance||60,stealth:e.lockedChestStealthChance||30,grandpow:e.lockedChestGrandpowChance||5}:{key:e.chestKeyChance||30,pow:e.chestPowChance||50,stealth:e.chestStealthChance||0,grandpow:e.chestGrandpowChance||0};if(n){const n=1+(e.chestLockedBonusPercent||50)/100;s.key=Math.min(100,s.key*n),s.pow=Math.min(100,s.pow*n),s.stealth=Math.min(100,s.stealth*n),s.grandpow=Math.min(100,s.grandpow*n)}for(let e=0;e<i;e++)100*Math.random()<s.key&&t.key++,100*Math.random()<s.pow&&t.pow++,100*Math.random()<s.stealth&&t.stealth++,100*Math.random()<s.grandpow&&t.grandpow++;return t}function je(e){e.key>0&&Te("key",e.key),e.pow>0&&Te("pow",e.pow),e.stealth>0&&Te("stealth",e.stealth),e.grandpow>0&&Te("grandpow",e.grandpow)}function Re(e,n){B.currentMinion={name:n,imagePath:"",message:e},ke()}function qe(e,n){const t=[];e.key>0&&t.push("".concat(e.key," Key").concat(e.key>1?"s":"")),e.pow>0&&t.push("".concat(e.pow," POW").concat(e.pow>1?"s":"")),e.stealth>0&&t.push("".concat(e.stealth," Stealth").concat(e.stealth>1?"s":""));Re(t.length>0?"You found: ".concat(t.join(", "),"!"):"The chest was empty!",n),setTimeout((()=>Pe()),2e3)}function He(e,n){B.pendingChest=null;const t=N();if(t.length>0){const e=t[Math.floor(Math.random()*t.length)];B.pendingEncounter={type:"mimic_battlebar",profile:e},B.currentMinion={name:"Mimic!",imagePath:"",message:"The chest was a mimic! Prepare to fight!"},ke(),setTimeout((()=>{ee(e)}),1e3)}else Re("The chest was empty... and creepy.","Mimic"),setTimeout((()=>Pe()),1500)}function We(){B.pendingConfirmation=null,Pe()}function Ge(){const e=B.pendingConfirmation;if(!e)return;const n=G(e.minionId);if(B.pendingConfirmation=null,"battlebar"===e.type){const e=_e(n.battlebarProfiles);e?(B.pendingEncounter={type:"battlebar",profile:e},ee(e)):Pe()}else if("prizewheel"===e.type){const e=_e(n.wheelProfiles);e?(B.pendingEncounter={type:"wheel",profile:e},V(e),Q()):Pe()}}function Fe(){B.inventory.stealth>0&&(Le("stealth"),B.pendingConfirmation=null,Pe())}function Ye(){const e=B.pendingConfirmation;if(!e||"merchant"!==e.type)return;const n=e.merchantItemCount||1,t=(B.inventory.key||0)+(B.inventory.stealth||0)+(B.inventory.pow||0);if(t<n){B.currentMinion.message="You don't have enough items! You need ".concat(n," but only have ").concat(t,"."),ke();const e=document.getElementById("maze_minion_message");if(e){var a;const n=e.innerHTML.split('<div class="maze-confirm-buttons">')[0];e.innerHTML=n+'<div class="maze-confirm-buttons">\n                <button id="maze_confirm_decline" class="menu_button maze-confirm-btn">OK</button>\n            </div>',null===(a=document.getElementById("maze_confirm_decline"))||void 0===a||a.addEventListener("click",Ue)}return}let o=n;const i=["key","stealth","pow"];for(;o>0;){const e=i.filter((e=>B.inventory[e]>0));if(0===e.length)break;Le(e[Math.floor(Math.random()*e.length)]),o--}Te("grandpow"),B.currentMinion.message="Pleasure doing business with you! Here's your GRANDPOW!",ke();const s=document.getElementById("maze_minion_message");if(s){var r;const e=s.innerHTML.split('<div class="maze-confirm-buttons">')[0];s.innerHTML=e+'<div class="maze-confirm-buttons">\n            <button id="maze_confirm_ok" class="menu_button maze-confirm-btn">OK</button>\n        </div>',null===(r=document.getElementById("maze_confirm_ok"))||void 0===r||r.addEventListener("click",We)}}function Ue(){B.pendingConfirmation=null,Pe()}function Je(){B.isVictory=!1,B.isPaused=!0,T.maze[B.profileName]={result:"lose",timestamp:Date.now()},document.getElementById("maze_minion_name").textContent="Defeat!",document.getElementById("maze_minion_message").textContent="You have been defeated...";const e=document.getElementById("maze_minion_img");e&&(e.style.display="none");const n=document.getElementById("maze_close_btn");n&&(n.style.display=""),B.profile.loseCommand&&m(B.profile.loseCommand),document.removeEventListener("keydown",Ce)}function Ve(){B.playerX=0,B.playerY=0,B.isPaused=!1,B.pendingEncounter=null,Ie();const e=B.profile;if(e.mainMinion){const n=G(e.mainMinion);if(n)return B.currentMinion={name:n.name,imagePath:n.imagePath,message:"Back to the beginning with you!"},void ke()}B.currentMinion={name:"The Maze",imagePath:"",message:"Find your way to the exit..."},ke()}async function Ke(){B.isVictory=!0,T.maze[B.profileName]={result:"win",timestamp:Date.now()},ke(),Ie();const e=document.getElementById("maze_close_btn");e&&(e.style.display="");const n=document.querySelector(".mazemaster-maze-controls");if(n&&(n.style.display="none"),document.removeEventListener("keydown",Ce),B.profile.winCommand)try{await m(B.profile.winCommand)}catch(e){console.error("[MazeMaster] Win command error:",e)}console.log('[MazeMaster] Maze "'.concat(B.profileName,'" completed!'))}function Xe(){var e,n,t,a,o,i,s,r;const l=O(),m=C.currentProfile||"default",c=N(),d=C.currentBattlebarProfile||"default",p=A(d)||{},u=R(),g=C.currentMazeProfile||"default",b=q(g)||{},f=W(),v=C.activeGameConfig||"wheel";return'\n        <div class="mazemaster-panel">\n            <div class="mazemaster-panel-header">\n                <h2><i class="fa-solid fa-gamepad"></i> MazeMaster</h2>\n            </div>\n            <div class="mazemaster-tabs">\n                <button class="mazemaster-tab" data-tab="game">Game</button>\n                <button class="mazemaster-tab active" data-tab="config">Config</button>\n            </div>\n            <div class="mazemaster-panel-content">\n                \x3c!-- GAME TAB --\x3e\n                <div class="mazemaster-tab-content" id="mazemaster-tab-game">\n                    <div class="mazemaster-game-launch">\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Maze Profile</label>\n                            <select id="mazemaster_play_profile" class="mazemaster-select">\n                                '.concat(0===u.length?'<option value="">No profiles</option>':"","\n                                ").concat(u.map((e=>'<option value="'.concat(Ze(e),'" ').concat(e===g?"selected":"",">").concat(Ze(e),"</option>"))).join(""),'\n                            </select>\n                        </div>\n                        <button id="mazemaster_play_maze" class="menu_button menu_button_primary mazemaster-play-btn">\n                            <i class="fa-solid fa-play"></i> Play Maze\n                        </button>\n                    </div>\n\n                    \x3c!-- LLM Generation Settings --\x3e\n                    <div class="mazemaster-section">\n                        <label class="mazemaster-label"><i class="fa-solid fa-brain"></i> LLM Message Generation</label>\n                        <div class="mazemaster-form-group">\n                            <label>Generation Preset</label>\n                            <select id="mazemaster_llm_preset" class="mazemaster-select">\n                                <option value="">(Use Current)</option>\n                                \x3c!-- Presets populated dynamically --\x3e\n                            </select>\n                        </div>\n                        <label class="mazemaster-checkbox-label">\n                            <input type="checkbox" id="mazemaster_llm_enabled" ').concat(!1!==C.llmEnabled?"checked":"",'>\n                            Enable LLM message generation\n                        </label>\n                    </div>\n\n                    \x3c!-- Saved Games in Game Tab --\x3e\n                    <div class="mazemaster-section">\n                        <label class="mazemaster-label"><i class="fa-solid fa-floppy-disk"></i> Saved Games</label>\n                        <div id="mazemaster_game_tab_saves" class="mazemaster-saved-games-list">\n                            \x3c!-- Saved games rendered here --\x3e\n                        </div>\n                    </div>\n                </div>\n\n                \x3c!-- CONFIG TAB --\x3e\n                <div class="mazemaster-tab-content active" id="mazemaster-tab-config">\n                    \x3c!-- Game Selector --\x3e\n                    <div class="mazemaster-game-selector">\n                        <button id="mazemaster_show_wheel" class="menu_button mazemaster-game-btn ').concat("wheel"===v?"active":"",'">\n                            <i class="fa-solid fa-dharmachakra"></i> Wheel\n                        </button>\n                        <button id="mazemaster_show_battlebar" class="menu_button mazemaster-game-btn ').concat("battlebar"===v?"active":"",'">\n                            <i class="fa-solid fa-bars-progress"></i> Battlebar\n                        </button>\n                        <button id="mazemaster_show_maze" class="menu_button mazemaster-game-btn ').concat("maze"===v?"active":"",'">\n                            <i class="fa-solid fa-border-all"></i> Maze\n                        </button>\n                        <button id="mazemaster_show_minions" class="menu_button mazemaster-game-btn ').concat("minions"===v?"active":"",'">\n                            <i class="fa-solid fa-ghost"></i> Minions\n                        </button>\n                        <button id="mazemaster_show_traps" class="menu_button mazemaster-game-btn ').concat("traps"===v?"active":"",'">\n                            <i class="fa-solid fa-dungeon"></i> Traps\n                        </button>\n                    </div>\n\n                    \x3c!-- WHEEL CONFIG --\x3e\n                    <div id="mazemaster_wheel_config" class="mazemaster-game-config" style="').concat("wheel"===v?"":"display: none;",'">\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Wheel Profile</label>\n                            <div class="mazemaster-profile-row">\n                                <select id="mazemaster_profile_select" class="mazemaster-select">\n                                    ').concat(0===l.length?'<option value="">No profiles</option>':"","\n                                    ").concat(l.map((e=>'<option value="'.concat(Ze(e),'" ').concat(e===m?"selected":"",">").concat(Ze(e),"</option>"))).join(""),'\n                                </select>\n                                <button id="mazemaster_new_profile_btn" class="menu_button menu_button_icon" title="New Profile">\n                                    <i class="fa-solid fa-plus"></i>\n                                </button>\n                                <button id="mazemaster_delete_profile_btn" class="menu_button menu_button_icon" title="Delete Profile">\n                                    <i class="fa-solid fa-trash"></i>\n                                </button>\n                                <button id="mazemaster_export_btn" class="menu_button menu_button_icon" title="Export Profile">\n                                    <i class="fa-solid fa-download"></i>\n                                </button>\n                                <button id="mazemaster_import_btn" class="menu_button menu_button_icon" title="Import Profile">\n                                    <i class="fa-solid fa-upload"></i>\n                                </button>\n                                <input type="file" id="mazemaster_import_file" accept=".json" style="display: none;">\n                            </div>\n                        </div>\n\n                        <div class="mazemaster-section mazemaster-profile-settings">\n                            <div class="mazemaster-profile-options">\n                                <label class="mazemaster-checkbox-label">\n                                    <input type="checkbox" id="mazemaster_randomize" ').concat(null!==(e=D(m))&&void 0!==e&&e.randomize?"checked":"",'>\n                                    Randomize segment positions\n                                </label>\n                                <div class="mazemaster-difficulty-row">\n                                    <label>Difficulty:</label>\n                                    <select id="mazemaster_difficulty" class="mazemaster-select-small">\n                                        ').concat([1,2,3,4,5].map((e=>{var n;return'<option value="'.concat(e,'" ').concat(((null===(n=D(m))||void 0===n?void 0:n.difficulty)||1)===e?"selected":"",">").concat(e,"</option>")})).join(""),'\n                                    </select>\n                                </div>\n                            </div>\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Segments</label>\n                            <div id="mazemaster_segments_list" class="mazemaster-segments-list">\n                                \x3c!-- Segments rendered here --\x3e\n                            </div>\n                            <button id="mazemaster_add_segment_btn" class="menu_button mazemaster-add-btn">\n                                <i class="fa-solid fa-plus"></i> Add Segment\n                            </button>\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <button id="mazemaster_save_btn" class="menu_button menu_button_primary mazemaster-save-btn">\n                                <i class="fa-solid fa-save"></i> Save Profile\n                            </button>\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <div class="mazemaster-help">\n                                <div class="mazemaster-help-title">Usage:</div>\n                                <code>/wheel profile="profileName"</code>\n                                <div class="mazemaster-help-title">Sizes:</div>\n                                <ul>\n                                    <li><code>fraction</code> - Normal (1x)</li>\n                                    <li><code>halfseg</code> - Half (0.5x)</li>\n                                    <li><code>doubleseg</code> - Double (2x)</li>\n                                </ul>\n                                <small>halfseg count must equal doubleseg count</small>\n                            </div>\n                        </div>\n                    </div>\n\n                    \x3c!-- BATTLEBAR CONFIG --\x3e\n                    <div id="mazemaster_battlebar_config" class="mazemaster-game-config" style="').concat("battlebar"===v?"":"display: none;",'">\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Battlebar Profile</label>\n                            <div class="mazemaster-profile-row">\n                                <select id="mazemaster_bb_profile_select" class="mazemaster-select">\n                                    ').concat(0===c.length?'<option value="">No profiles</option>':"","\n                                    ").concat(c.map((e=>'<option value="'.concat(Ze(e),'" ').concat(e===d?"selected":"",">").concat(Ze(e),"</option>"))).join(""),'\n                                </select>\n                                <button id="mazemaster_bb_new_profile_btn" class="menu_button menu_button_icon" title="New Profile">\n                                    <i class="fa-solid fa-plus"></i>\n                                </button>\n                                <button id="mazemaster_bb_delete_profile_btn" class="menu_button menu_button_icon" title="Delete Profile">\n                                    <i class="fa-solid fa-trash"></i>\n                                </button>\n                                <button id="mazemaster_bb_export_btn" class="menu_button menu_button_icon" title="Export Profile">\n                                    <i class="fa-solid fa-download"></i>\n                                </button>\n                                <button id="mazemaster_bb_import_btn" class="menu_button menu_button_icon" title="Import Profile">\n                                    <i class="fa-solid fa-upload"></i>\n                                </button>\n                                <input type="file" id="mazemaster_bb_import_file" accept=".json" style="display: none;">\n                            </div>\n                        </div>\n\n                        <div class="mazemaster-section mazemaster-profile-settings">\n                            <div class="mazemaster-bb-settings">\n                                <div class="mazemaster-bb-row">\n                                    <div class="mazemaster-bb-field">\n                                        <label>Difficulty</label>\n                                        <select id="mazemaster_bb_difficulty" class="mazemaster-select">\n                                            ').concat([1,2,3,4,5].map((e=>'<option value="'.concat(e,'" ').concat((p.difficulty||3)===e?"selected":"",">").concat(e,"</option>"))).join(""),'\n                                        </select>\n                                    </div>\n                                    <div class="mazemaster-bb-field">\n                                        <label>Hits to Win</label>\n                                        <input type="number" id="mazemaster_bb_hits" min="1" max="20" value="').concat(p.hitsToWin||5,'">\n                                    </div>\n                                    <div class="mazemaster-bb-field">\n                                        <label>Misses to Lose</label>\n                                        <input type="number" id="mazemaster_bb_misses" min="1" max="20" value="').concat(p.missesToLose||3,'">\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Main Title</label>\n                            <input type="text" id="mazemaster_bb_main_title" class="mazemaster-input" placeholder="e.g. Boss Battle!" value="').concat(Ze(p.mainTitle||""),'">\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Commands</label>\n                            <div class="mazemaster-bb-commands">\n                                <div class="mazemaster-bb-command">\n                                    <label>On Hit:</label>\n                                    <textarea id="mazemaster_bb_hit_cmd" placeholder="/echo Hit!">').concat(Ze(p.hitCommand||""),'</textarea>\n                                </div>\n                                <div class="mazemaster-bb-command">\n                                    <label>On Miss:</label>\n                                    <textarea id="mazemaster_bb_miss_cmd" placeholder="/echo Miss!">').concat(Ze(p.missCommand||""),'</textarea>\n                                </div>\n                                <div class="mazemaster-bb-command">\n                                    <label>On Win:</label>\n                                    <textarea id="mazemaster_bb_win_cmd" placeholder="/echo Victory!">').concat(Ze(p.winCommand||""),'</textarea>\n                                </div>\n                                <div class="mazemaster-bb-command">\n                                    <label>On Lose:</label>\n                                    <textarea id="mazemaster_bb_lose_cmd" placeholder="/echo Defeat!">').concat(Ze(p.loseCommand||""),'</textarea>\n                                </div>\n                            </div>\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Stages (click image to edit message)</label>\n                            <div id="mazemaster_bb_images_list" class="mazemaster-bb-images-list">\n                                \x3c!-- Images rendered here --\x3e\n                            </div>\n                            <button id="mazemaster_bb_add_image_btn" class="menu_button mazemaster-add-btn">\n                                <i class="fa-solid fa-plus"></i> Add Image\n                            </button>\n                            <input type="file" id="mazemaster_bb_image_file" accept="image/*" style="display: none;">\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Item Drops on Win (Maze Only)</label>\n                            <div class="mazemaster-row">\n                                <label>Key %</label>\n                                <input type="number" id="mazemaster_bb_key_drop" class="mazemaster-input-small" min="0" max="100" value="').concat(null!==(n=p.keyDropChance)&&void 0!==n?n:40,'">\n                            </div>\n                            <div class="mazemaster-row">\n                                <label>POW %</label>\n                                <input type="number" id="mazemaster_bb_pow_drop" class="mazemaster-input-small" min="0" max="100" value="').concat(null!==(t=p.powDropChance)&&void 0!==t?t:20,'">\n                            </div>\n                            <div class="mazemaster-row">\n                                <label>Stealth %</label>\n                                <input type="number" id="mazemaster_bb_stealth_drop" class="mazemaster-input-small" min="0" max="100" value="').concat(null!==(a=p.stealthDropChance)&&void 0!==a?a:10,'">\n                            </div>\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <button id="mazemaster_bb_save_btn" class="menu_button menu_button_primary mazemaster-save-btn">\n                                <i class="fa-solid fa-save"></i> Save Profile\n                            </button>\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <div class="mazemaster-help">\n                                <div class="mazemaster-help-title">Usage:</div>\n                                <code>/battlebar profile="profileName"</code>\n                                <div class="mazemaster-help-title">Difficulty:</div>\n                                <ul>\n                                    <li><code>1</code> - Easy (large zone, slow)</li>\n                                    <li><code>3</code> - Medium</li>\n                                    <li><code>5</code> - Hard (small zone, fast)</li>\n                                </ul>\n                            </div>\n                        </div>\n                    </div>\n\n                    \x3c!-- MAZE CONFIG --\x3e\n                    <div id="mazemaster_maze_config" class="mazemaster-game-config" style="').concat("maze"===v?"":"display: none;",'">\n                        \x3c!-- Profile Selection --\x3e\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Maze Profile</label>\n                            <div class="mazemaster-profile-row">\n                                <select id="mazemaster_maze_profile_select" class="mazemaster-select">\n                                    ').concat(0===u.length?'<option value="">No profiles</option>':"","\n                                    ").concat(u.map((e=>'<option value="'.concat(Ze(e),'" ').concat(e===g?"selected":"",">").concat(Ze(e),"</option>"))).join(""),'\n                                </select>\n                                <button id="mazemaster_maze_new_profile_btn" class="menu_button menu_button_icon" title="New Profile">\n                                    <i class="fa-solid fa-plus"></i>\n                                </button>\n                                <button id="mazemaster_maze_delete_profile_btn" class="menu_button menu_button_icon" title="Delete Profile">\n                                    <i class="fa-solid fa-trash"></i>\n                                </button>\n                            </div>\n                        </div>\n\n                        \x3c!-- Grid Size --\x3e\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Grid Size</label>\n                            <select id="mazemaster_maze_size" class="mazemaster-select">\n                                <option value="7" ').concat(7===(b.gridSize||10)?"selected":"",'>7x7 (Easy)</option>\n                                <option value="10" ').concat(10===(b.gridSize||10)?"selected":"",'>10x10 (Medium)</option>\n                                <option value="15" ').concat(15===(b.gridSize||10)?"selected":"",'>15x15 (Hard)</option>\n                                <option value="20" ').concat(20===(b.gridSize||10)?"selected":"",'>20x20 (Expert)</option>\n                            </select>\n                        </div>\n\n                        \x3c!-- COLLAPSIBLE: Main Minion --\x3e\n                        <div class="mazemaster-collapsible ').concat(b.mainMinion?"expanded":"",'">\n                            <button class="mazemaster-collapsible-header" data-target="main_minion_section">\n                                <i class="fa-solid fa-chevron-right mazemaster-collapse-icon"></i>\n                                <span>Main Minion</span>\n                                <span class="mazemaster-collapse-hint">(narrator/boss)</span>\n                            </button>\n                            <div id="main_minion_section" class="mazemaster-collapsible-content" style="display: ').concat(b.mainMinion?"block":"none",';">\n                                <div class="mazemaster-section">\n                                    <select id="mazemaster_maze_main_minion" class="mazemaster-select">\n                                        <option value="">None</option>\n                                        ').concat(f.map((e=>{const n=G(e);return'<option value="'.concat(Ze(e),'" ').concat(b.mainMinion===e?"selected":"",">").concat(Ze((null==n?void 0:n.name)||e),"</option>")})).join(""),'\n                                    </select>\n                                    <div class="mazemaster-help-small"><small>The main minion narrates the maze and guards the exit</small></div>\n                                </div>\n\n                                <div id="mazemaster_main_minion_settings" class="mazemaster-subsection" style="display: ').concat(b.mainMinion?"block":"none",';">\n                                    <div class="mazemaster-section">\n                                        <label class="mazemaster-label">Intro Message</label>\n                                        <input type="text" id="mazemaster_maze_intro_message" class="mazemaster-input" placeholder="Welcome to my maze..." value="').concat(Ze(b.mainMinionIntroMessage||""),'">\n                                    </div>\n\n                                    <div class="mazemaster-inline-row">\n                                        <div class="mazemaster-section mazemaster-flex-1">\n                                            <label class="mazemaster-label">Random Msg %</label>\n                                            <input type="number" id="mazemaster_maze_random_chance" class="mazemaster-input" min="0" max="100" value="').concat(b.mainMinionRandomChance||15,'">\n                                        </div>\n                                    </div>\n\n                                    <div class="mazemaster-section">\n                                        <label class="mazemaster-label">Random Messages (one per line)</label>\n                                        <textarea id="mazemaster_maze_random_messages" class="mazemaster-textarea" rows="2" placeholder="You\'re still here?&#10;Getting lost yet?">').concat(Ze((b.mainMinionRandomMessages||[]).join("\n")),'</textarea>\n                                    </div>\n\n                                    <div class="mazemaster-section">\n                                        <label class="mazemaster-label">Exit Encounter</label>\n                                        <div class="mazemaster-help-small"><small>What happens when the player reaches the exit</small></div>\n                                        <select id="mazemaster_maze_exit_type" class="mazemaster-select">\n                                            <option value="messenger" ').concat("messenger"===(b.mainMinionExitType||"messenger")?"selected":"",'>Message Only (no challenge)</option>\n                                            <option value="battlebar" ').concat("battlebar"===b.mainMinionExitType?"selected":"",'>Battlebar Fight</option>\n                                            <option value="prizewheel" ').concat("prizewheel"===b.mainMinionExitType?"selected":"",'>Prize Wheel</option>\n                                        </select>\n                                    </div>\n\n                                    <div id="mazemaster_exit_profile_section" class="mazemaster-section" style="display: ').concat(b.mainMinionExitType&&"messenger"!==b.mainMinionExitType?"block":"none",';">\n                                        <label class="mazemaster-label">Exit Game Profile</label>\n                                        <div class="mazemaster-help-small"><small>Which Battlebar/Wheel profile to use for the exit boss</small></div>\n                                        <select id="mazemaster_maze_exit_profile" class="mazemaster-select">\n                                            <option value="">Select...</option>\n                                        </select>\n                                    </div>\n\n                                    <div class="mazemaster-section">\n                                        <button id="mazemaster_maze_story_btn" class="menu_button">\n                                            <i class="fa-solid fa-book"></i> Story Milestones\n                                        </button>\n                                        <div class="mazemaster-help-small"><small>Configure story text shown as player progresses</small></div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n\n                        \x3c!-- COLLAPSIBLE: Encounters --\x3e\n                        <div class="mazemaster-collapsible expanded">\n                            <button class="mazemaster-collapsible-header" data-target="encounters_section">\n                                <i class="fa-solid fa-chevron-right mazemaster-collapse-icon"></i>\n                                <span>Encounters</span>\n                                <span class="mazemaster-collapse-hint">(minions & traps)</span>\n                            </button>\n                            <div id="encounters_section" class="mazemaster-collapsible-content" style="display: block;">\n                                <div class="mazemaster-section">\n                                    <label class="mazemaster-label">Minion Encounters</label>\n                                    <div id="mazemaster_maze_encounters_list" class="mazemaster-encounters-list">\n                                        \x3c!-- Encounter rows rendered here --\x3e\n                                    </div>\n                                    <button id="mazemaster_add_encounter_btn" class="menu_button mazemaster-add-btn">\n                                        <i class="fa-solid fa-plus"></i> Add Minion\n                                    </button>\n                                </div>\n\n                                <div class="mazemaster-section">\n                                    <label class="mazemaster-label">Trap Tiles</label>\n                                    <div id="mazemaster_maze_traps_list" class="mazemaster-encounters-list">\n                                        \x3c!-- Trap encounter rows rendered here --\x3e\n                                    </div>\n                                    <button id="mazemaster_add_trap_encounter_btn" class="menu_button mazemaster-add-btn">\n                                        <i class="fa-solid fa-plus"></i> Add Trap\n                                    </button>\n                                </div>\n\n                                <div class="mazemaster-section">\n                                    <button id="mazemaster_intelligent_distribute" class="menu_button mazemaster-distribute-btn">\n                                        <i class="fa-solid fa-wand-magic-sparkles"></i> Intelligent Distribute\n                                    </button>\n                                    <div class="mazemaster-help-small">\n                                        <small>Auto-sets tile percentages based on minion types</small>\n                                    </div>\n                                </div>\n\n                                <div class="mazemaster-section">\n                                    <label class="mazemaster-label">On Battlebar Loss</label>\n                                    <select id="mazemaster_maze_loss_action" class="mazemaster-select">\n                                        <option value="continue" ').concat("continue"===(b.onBattlebarLoss||"continue")?"selected":"",'>Continue (skip encounter)</option>\n                                        <option value="respawn" ').concat("respawn"===b.onBattlebarLoss?"selected":"",'>Respawn at Start</option>\n                                        <option value="gameover" ').concat("gameover"===b.onBattlebarLoss?"selected":"",'>Game Over</option>\n                                    </select>\n                                </div>\n                            </div>\n                        </div>\n\n                        \x3c!-- COLLAPSIBLE: Chests & Loot --\x3e\n                        <div class="mazemaster-collapsible">\n                            <button class="mazemaster-collapsible-header" data-target="chests_section">\n                                <i class="fa-solid fa-chevron-right mazemaster-collapse-icon"></i>\n                                <span>Chests & Loot</span>\n                            </button>\n                            <div id="chests_section" class="mazemaster-collapsible-content" style="display: none;">\n                                <div class="mazemaster-section">\n                                    <label class="mazemaster-label">Chest Distribution</label>\n                                    <div class="mazemaster-grid-2col">\n                                        <div class="mazemaster-row">\n                                            <label>Chest Tiles %</label>\n                                            <input type="number" id="mazemaster_maze_chest_percent" class="mazemaster-input-small" min="0" max="50" value="').concat(b.chestTilePercent||10,'">\n                                        </div>\n                                        <div class="mazemaster-row">\n                                            <label>Locked %</label>\n                                            <input type="number" id="mazemaster_maze_locked_percent" class="mazemaster-input-small" min="0" max="100" value="').concat(b.chestLockedPercent||30,'">\n                                        </div>\n                                        <div class="mazemaster-row">\n                                            <label>Locked Bonus %</label>\n                                            <input type="number" id="mazemaster_maze_locked_bonus" class="mazemaster-input-small" min="0" max="200" value="').concat(b.chestLockedBonusPercent||50,'">\n                                        </div>\n                                        <div class="mazemaster-row">\n                                            <label>Mimic %</label>\n                                            <input type="number" id="mazemaster_maze_mimic_percent" class="mazemaster-input-small" min="0" max="100" value="').concat(b.chestMimicPercent||15,'">\n                                        </div>\n                                    </div>\n                                </div>\n\n                                <div class="mazemaster-section">\n                                    <label class="mazemaster-label">Loot per Chest</label>\n                                    <div class="mazemaster-row">\n                                        <input type="number" id="mazemaster_maze_loot_min" class="mazemaster-input-small" min="1" max="10" value="').concat(b.chestLootMin||1,'" style="width:50px">\n                                        <span>to</span>\n                                        <input type="number" id="mazemaster_maze_loot_max" class="mazemaster-input-small" min="1" max="10" value="').concat(b.chestLootMax||2,'" style="width:50px">\n                                        <span>items</span>\n                                    </div>\n                                </div>\n\n                                <div class="mazemaster-section">\n                                    <label class="mazemaster-label">Regular Chest Loot %</label>\n                                    <div class="mazemaster-grid-4col">\n                                        <div class="mazemaster-row"><label>Key</label><input type="number" id="mazemaster_maze_chest_key" class="mazemaster-input-small" min="0" max="100" value="').concat(b.chestKeyChance||30,'"></div>\n                                        <div class="mazemaster-row"><label>POW</label><input type="number" id="mazemaster_maze_chest_pow" class="mazemaster-input-small" min="0" max="100" value="').concat(b.chestPowChance||50,'"></div>\n                                        <div class="mazemaster-row"><label>Stealth</label><input type="number" id="mazemaster_maze_chest_stealth" class="mazemaster-input-small" min="0" max="100" value="').concat(b.chestStealthChance||0,'"></div>\n                                        <div class="mazemaster-row"><label>G-POW</label><input type="number" id="mazemaster_maze_chest_grandpow" class="mazemaster-input-small" min="0" max="100" value="').concat(b.chestGrandpowChance||0,'"></div>\n                                    </div>\n                                </div>\n\n                                <div class="mazemaster-section">\n                                    <label class="mazemaster-label">Locked Chest Loot %</label>\n                                    <div class="mazemaster-grid-4col">\n                                        <div class="mazemaster-row"><label>Key</label><input type="number" id="mazemaster_maze_locked_key" class="mazemaster-input-small" min="0" max="100" value="').concat(b.lockedChestKeyChance||40,'"></div>\n                                        <div class="mazemaster-row"><label>POW</label><input type="number" id="mazemaster_maze_locked_pow" class="mazemaster-input-small" min="0" max="100" value="').concat(b.lockedChestPowChance||60,'"></div>\n                                        <div class="mazemaster-row"><label>Stealth</label><input type="number" id="mazemaster_maze_locked_stealth" class="mazemaster-input-small" min="0" max="100" value="').concat(b.lockedChestStealthChance||30,'"></div>\n                                        <div class="mazemaster-row"><label>G-POW</label><input type="number" id="mazemaster_maze_locked_grandpow" class="mazemaster-input-small" min="0" max="100" value="').concat(b.lockedChestGrandpowChance||5,'"></div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n\n                        \x3c!-- COLLAPSIBLE: Victory & Loss --\x3e\n                        <div class="mazemaster-collapsible">\n                            <button class="mazemaster-collapsible-header" data-target="victory_section">\n                                <i class="fa-solid fa-chevron-right mazemaster-collapse-icon"></i>\n                                <span>Victory & Loss</span>\n                            </button>\n                            <div id="victory_section" class="mazemaster-collapsible-content" style="display: none;">\n                                <div class="mazemaster-section">\n                                    <label class="mazemaster-label">Victory Message</label>\n                                    <input type="text" id="mazemaster_maze_win_message" class="mazemaster-input" placeholder="You escaped the maze!" value="').concat(Ze(b.winMessage||""),'">\n                                </div>\n\n                                <div class="mazemaster-section">\n                                    <label class="mazemaster-label">Victory Image</label>\n                                    <div class="mazemaster-maze-win-image-row">\n                                        <div class="mazemaster-maze-win-image-preview">\n                                            ').concat(b.winImage?'<img id="maze_win_image_preview" src="'.concat(Ze(b.winImage),'" alt="Victory">'):'<div id="maze_win_image_preview" class="no-image">No image</div>','\n                                        </div>\n                                        <button id="mazemaster_maze_win_image_btn" class="menu_button">\n                                            <i class="fa-solid fa-upload"></i> Upload\n                                        </button>\n                                    </div>\n                                    <input type="file" id="mazemaster_maze_win_image_file" accept="image/*" style="display: none;">\n                                </div>\n\n                                <div class="mazemaster-section">\n                                    <label class="mazemaster-label">Win Command</label>\n                                    <textarea id="mazemaster_maze_win_cmd" class="mazemaster-textarea" rows="2" placeholder="/echo Victory!">').concat(Ze(b.winCommand||""),'</textarea>\n                                </div>\n\n                                <div class="mazemaster-section">\n                                    <label class="mazemaster-label">Lose Command</label>\n                                    <textarea id="mazemaster_maze_lose_cmd" class="mazemaster-textarea" rows="2" placeholder="/echo Defeated...">').concat(Ze(b.loseCommand||""),'</textarea>\n                                </div>\n                            </div>\n                        </div>\n\n                        \x3c!-- COLLAPSIBLE: Starting Inventory --\x3e\n                        <div class="mazemaster-collapsible">\n                            <button class="mazemaster-collapsible-header" data-target="starting_inv_section">\n                                <i class="fa-solid fa-chevron-right mazemaster-collapse-icon"></i>\n                                <span>Starting Inventory</span>\n                            </button>\n                            <div id="starting_inv_section" class="mazemaster-collapsible-content" style="display: none;">\n                                <div class="mazemaster-section">\n                                    <div class="mazemaster-grid-4col">\n                                        <div class="mazemaster-row"><label><i class="fa-solid fa-key"></i> Keys</label><input type="number" id="mazemaster_start_key" class="mazemaster-input-small" min="0" max="99" value="').concat((null===(o=b.startingInventory)||void 0===o?void 0:o.key)||0,'"></div>\n                                        <div class="mazemaster-row"><label><i class="fa-solid fa-bolt"></i> POW</label><input type="number" id="mazemaster_start_pow" class="mazemaster-input-small" min="0" max="99" value="').concat((null===(i=b.startingInventory)||void 0===i?void 0:i.pow)||0,'"></div>\n                                        <div class="mazemaster-row"><label><i class="fa-solid fa-user-ninja"></i> Stealth</label><input type="number" id="mazemaster_start_stealth" class="mazemaster-input-small" min="0" max="99" value="').concat((null===(s=b.startingInventory)||void 0===s?void 0:s.stealth)||0,'"></div>\n                                        <div class="mazemaster-row"><label><i class="fa-solid fa-star"></i> G-POW</label><input type="number" id="mazemaster_start_grandpow" class="mazemaster-input-small" min="0" max="99" value="').concat((null===(r=b.startingInventory)||void 0===r?void 0:r.grandpow)||0,'"></div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n\n                        \x3c!-- Save Button --\x3e\n                        <div class="mazemaster-section">\n                            <button id="mazemaster_maze_save_btn" class="menu_button menu_button_primary mazemaster-save-btn">\n                                <i class="fa-solid fa-save"></i> Save Profile\n                            </button>\n                        </div>\n\n                        \x3c!-- Saved Games --\x3e\n                        <div class="mazemaster-collapsible">\n                            <button class="mazemaster-collapsible-header" data-target="saved_games_section">\n                                <i class="fa-solid fa-chevron-right mazemaster-collapse-icon"></i>\n                                <span>Saved Games</span>\n                            </button>\n                            <div id="saved_games_section" class="mazemaster-collapsible-content" style="display: none;">\n                                <div id="mazemaster_saved_games_list" class="mazemaster-saved-games-list">\n                                    \x3c!-- Saved games rendered here --\x3e\n                                </div>\n                            </div>\n                        </div>\n\n                        \x3c!-- Usage Help --\x3e\n                        <div class="mazemaster-section">\n                            <div class="mazemaster-help">\n                                <div class="mazemaster-help-title">Usage:</div>\n                                <code>/maze profile="profileName"</code>\n                            </div>\n                        </div>\n                    </div>\n\n                    \x3c!-- MINIONS CONFIG --\x3e\n                    <div id="mazemaster_minions_config" class="mazemaster-game-config" style="').concat("minions"===v?"":"display: none;",'">\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Minion Profile</label>\n                            <div class="mazemaster-profile-row">\n                                <select id="mazemaster_minion_profile_select" class="mazemaster-select">\n                                    <option value="">(Current Minions)</option>\n                                    ').concat(Object.keys(C.minionProfiles||{}).map((e=>'<option value="'.concat(Ze(e),'">').concat(Ze(e),"</option>"))).join(""),'\n                                </select>\n                                <button id="mazemaster_minion_profile_save_btn" class="menu_button menu_button_icon" title="Save Current as Profile">\n                                    <i class="fa-solid fa-floppy-disk"></i>\n                                </button>\n                                <button id="mazemaster_minion_profile_load_btn" class="menu_button menu_button_icon" title="Load Profile">\n                                    <i class="fa-solid fa-folder-open"></i>\n                                </button>\n                                <button id="mazemaster_minion_profile_delete_btn" class="menu_button menu_button_icon" title="Delete Profile">\n                                    <i class="fa-solid fa-trash"></i>\n                                </button>\n                            </div>\n                            <div class="mazemaster-help-small"><small>Save/load sets of minions as profiles</small></div>\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Minions</label>\n                            <div id="mazemaster_minions_list" class="mazemaster-minions-list">\n                                \x3c!-- Minions rendered here --\x3e\n                            </div>\n                            <button id="mazemaster_add_minion_btn" class="menu_button mazemaster-add-btn">\n                                <i class="fa-solid fa-plus"></i> Add Minion\n                            </button>\n                            <input type="file" id="mazemaster_minion_image_file" accept="image/*" style="display: none;">\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <div class="mazemaster-help">\n                                <div class="mazemaster-help-title">Usage:</div>\n                                <code>/mazeminion name="MinionName" message="Hello!"</code>\n                                <p><small>Sets the minion display in an active maze game.</small></p>\n                            </div>\n                        </div>\n                    </div>\n\n                    \x3c!-- TRAPS CONFIG --\x3e\n                    <div id="mazemaster_traps_config" class="mazemaster-game-config" style="').concat("traps"===v?"":"display: none;",'">\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Trap Profile</label>\n                            <div class="mazemaster-profile-row">\n                                <select id="mazemaster_trap_profile_select" class="mazemaster-select">\n                                    <option value="">(Current Traps)</option>\n                                    ').concat(Object.keys(C.trapProfiles||{}).map((e=>'<option value="'.concat(Ze(e),'">').concat(Ze(e),"</option>"))).join(""),'\n                                </select>\n                                <button id="mazemaster_trap_profile_save_btn" class="menu_button menu_button_icon" title="Save Current as Profile">\n                                    <i class="fa-solid fa-floppy-disk"></i>\n                                </button>\n                                <button id="mazemaster_trap_profile_load_btn" class="menu_button menu_button_icon" title="Load Profile">\n                                    <i class="fa-solid fa-folder-open"></i>\n                                </button>\n                                <button id="mazemaster_trap_profile_delete_btn" class="menu_button menu_button_icon" title="Delete Profile">\n                                    <i class="fa-solid fa-trash"></i>\n                                </button>\n                            </div>\n                            <div class="mazemaster-help-small"><small>Save/load sets of traps as profiles</small></div>\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Traps</label>\n                            <div id="mazemaster_traps_list" class="mazemaster-traps-list">\n                                \x3c!-- Traps rendered here --\x3e\n                            </div>\n                            <button id="mazemaster_add_trap_btn" class="menu_button mazemaster-add-btn">\n                                <i class="fa-solid fa-plus"></i> Add Trap\n                            </button>\n                            <input type="file" id="mazemaster_trap_image_file" accept="image/*" style="display: none;">\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <div class="mazemaster-help">\n                                <div class="mazemaster-help-title">Traps:</div>\n                                <p><small>Traps can be placed on maze tiles. When a player steps on a trap, it shows the image/message and runs the script.</small></p>\n                                <p><small>Add traps to maze profiles in the Maze tab under "Trap Tiles".</small></p>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n\n        <style>\n            .mazemaster-panel {\n                display: flex;\n                flex-direction: column;\n                height: 100%;\n            }\n\n            .mazemaster-panel-header {\n                padding: 10px 15px;\n                border-bottom: 1px solid var(--SmartThemeBorderColor, #555);\n            }\n\n            .mazemaster-panel-header h2 {\n                margin: 0;\n                font-size: 1.2em;\n                display: flex;\n                align-items: center;\n                gap: 10px;\n            }\n\n            .mazemaster-tabs {\n                display: flex;\n                border-bottom: 1px solid var(--SmartThemeBorderColor, #555);\n                padding: 0 10px;\n            }\n\n            .mazemaster-tab {\n                padding: 8px 16px;\n                background: transparent;\n                border: none;\n                border-bottom: 2px solid transparent;\n                cursor: pointer;\n                color: var(--SmartThemeBodyColor);\n                font-size: 0.9em;\n            }\n\n            .mazemaster-tab:hover {\n                background: rgba(255, 255, 255, 0.05);\n            }\n\n            .mazemaster-tab.active {\n                border-bottom-color: var(--SmartThemeQuoteColor, #4a7c59);\n                color: var(--SmartThemeQuoteColor, #4a7c59);\n            }\n\n            .mazemaster-panel-content {\n                flex: 1;\n                overflow-y: auto;\n                padding: 15px;\n            }\n\n            .mazemaster-tab-content {\n                display: none;\n            }\n\n            .mazemaster-tab-content.active {\n                display: block;\n            }\n\n            .mazemaster-section {\n                margin-bottom: 15px;\n            }\n\n            .mazemaster-label {\n                display: block;\n                font-weight: bold;\n                margin-bottom: 5px;\n                font-size: 0.9em;\n            }\n\n            .mazemaster-profile-row {\n                display: flex;\n                gap: 5px;\n            }\n\n            .mazemaster-profile-row select {\n                flex: 1;\n            }\n\n            .mazemaster-select {\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 6px 8px;\n                color: var(--SmartThemeBodyColor);\n            }\n\n            .mazemaster-segments-list {\n                display: flex;\n                flex-direction: column;\n                gap: 8px;\n                margin-bottom: 10px;\n                max-height: 300px;\n                overflow-y: auto;\n            }\n\n            .mazemaster-segment-item {\n                background: rgba(0, 0, 0, 0.2);\n                border-radius: 5px;\n                padding: 10px;\n            }\n\n            .mazemaster-segment-row {\n                display: flex;\n                gap: 8px;\n                margin-bottom: 8px;\n                align-items: center;\n            }\n\n            .mazemaster-segment-row:last-child {\n                margin-bottom: 0;\n            }\n\n            .mazemaster-segment-field {\n                flex: 1;\n                display: flex;\n                flex-direction: column;\n                gap: 2px;\n            }\n\n            .mazemaster-segment-field label {\n                font-size: 0.7em;\n                opacity: 0.7;\n            }\n\n            .mazemaster-segment-field input:not([type="checkbox"]),\n            .mazemaster-segment-field select,\n            .mazemaster-segment-field textarea {\n                width: 100%;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 5px 8px;\n                color: var(--SmartThemeBodyColor);\n                font-size: 0.85em;\n            }\n\n            .mazemaster-segment-field textarea {\n                min-height: 40px;\n                resize: vertical;\n                font-family: monospace;\n            }\n\n            .mazemaster-segment-field.small {\n                flex: 0 0 80px;\n            }\n\n            .mazemaster-segment-field.tiny {\n                flex: 0 0 100px;\n                overflow: visible;\n            }\n\n            .mazemaster-segment-checkbox {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                font-size: 0.85em;\n                cursor: pointer;\n                white-space: nowrap;\n                padding: 5px;\n                margin: 0;\n            }\n\n            .mazemaster-segment-checkbox input[type="checkbox"] {\n                width: 18px;\n                height: 18px;\n                min-width: 18px;\n                min-height: 18px;\n                cursor: pointer;\n                pointer-events: auto;\n                margin: 0;\n                flex-shrink: 0;\n            }\n\n            .mazemaster-profile-settings {\n                background: rgba(0, 0, 0, 0.15);\n                padding: 10px;\n                border-radius: 5px;\n            }\n\n            .mazemaster-profile-options {\n                display: flex;\n                flex-direction: column;\n                gap: 10px;\n            }\n\n            .mazemaster-checkbox-label {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                cursor: pointer;\n                font-size: 0.9em;\n            }\n\n            .mazemaster-checkbox-label input[type="checkbox"] {\n                width: 16px;\n                height: 16px;\n                cursor: pointer;\n            }\n\n            .mazemaster-difficulty-row {\n                display: flex;\n                align-items: center;\n                gap: 10px;\n                font-size: 0.9em;\n            }\n\n            .mazemaster-select-small {\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 4px 8px;\n                color: var(--SmartThemeBodyColor);\n                width: 60px;\n            }\n\n            .mazemaster-segment-delete {\n                padding: 5px 8px;\n            }\n\n            .mazemaster-add-btn,\n            .mazemaster-save-btn {\n                width: 100%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 5px;\n            }\n\n            .mazemaster-distribute-btn {\n                width: 100%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 8px;\n                background: linear-gradient(135deg, #9b59b6, #8e44ad) !important;\n                color: #fff !important;\n            }\n\n            .mazemaster-distribute-btn:hover {\n                background: linear-gradient(135deg, #8e44ad, #7d3c98) !important;\n            }\n\n            .mazemaster-help-small {\n                margin-top: 5px;\n                color: #888;\n                text-align: center;\n            }\n\n            .menu_button_primary {\n                background: var(--SmartThemeQuoteColor, #4a7c59) !important;\n            }\n\n            .mazemaster-help {\n                background: rgba(0, 0, 0, 0.2);\n                padding: 10px;\n                border-radius: 5px;\n                font-size: 0.85em;\n            }\n\n            .mazemaster-help-title {\n                font-weight: bold;\n                margin-bottom: 5px;\n                margin-top: 10px;\n            }\n\n            .mazemaster-help-title:first-child {\n                margin-top: 0;\n            }\n\n            .mazemaster-help code {\n                background: rgba(0, 0, 0, 0.3);\n                padding: 2px 6px;\n                border-radius: 3px;\n                font-family: monospace;\n                font-size: 0.9em;\n            }\n\n            .mazemaster-help ul {\n                margin: 5px 0;\n                padding-left: 20px;\n            }\n\n            .mazemaster-help li {\n                margin: 3px 0;\n            }\n\n            .mazemaster-help small {\n                opacity: 0.7;\n                display: block;\n                margin-top: 5px;\n            }\n\n            .mazemaster-empty-state {\n                text-align: center;\n                padding: 15px;\n                opacity: 0.6;\n            }\n\n            /* Game Selector */\n            .mazemaster-game-selector {\n                display: flex;\n                gap: 10px;\n                margin-bottom: 15px;\n            }\n\n            .mazemaster-game-btn {\n                flex: 1;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 8px;\n                padding: 10px;\n                border-radius: 5px;\n                transition: all 0.2s;\n            }\n\n            .mazemaster-game-btn.active {\n                background: var(--SmartThemeQuoteColor, #4a7c59) !important;\n                color: white;\n            }\n\n            .mazemaster-game-config {\n                animation: fadeIn 0.2s ease;\n            }\n\n            @keyframes fadeIn {\n                from { opacity: 0; }\n                to { opacity: 1; }\n            }\n\n            /* Battlebar Styles */\n            .mazemaster-bb-settings {\n                display: flex;\n                flex-direction: column;\n                gap: 10px;\n            }\n\n            .mazemaster-bb-row {\n                display: flex;\n                gap: 10px;\n            }\n\n            .mazemaster-bb-field {\n                flex: 1;\n                display: flex;\n                flex-direction: column;\n                gap: 4px;\n            }\n\n            .mazemaster-bb-field label {\n                font-size: 0.8em;\n                opacity: 0.8;\n            }\n\n            .mazemaster-bb-field input,\n            .mazemaster-bb-field select {\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 6px 8px;\n                color: var(--SmartThemeBodyColor);\n            }\n\n            .mazemaster-bb-commands {\n                display: flex;\n                flex-direction: column;\n                gap: 10px;\n            }\n\n            .mazemaster-bb-command {\n                display: flex;\n                flex-direction: column;\n                gap: 4px;\n            }\n\n            .mazemaster-bb-command label {\n                font-size: 0.85em;\n                font-weight: bold;\n            }\n\n            .mazemaster-bb-command textarea {\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 8px;\n                color: var(--SmartThemeBodyColor);\n                font-family: monospace;\n                font-size: 0.85em;\n                min-height: 40px;\n                resize: vertical;\n            }\n\n            .mazemaster-bb-images-list {\n                display: flex;\n                flex-wrap: wrap;\n                gap: 10px;\n                margin-bottom: 10px;\n            }\n\n            .mazemaster-input {\n                width: 100%;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 8px 10px;\n                color: var(--SmartThemeBodyColor, #fff);\n                font-size: 1em;\n            }\n\n            .mazemaster-input::placeholder {\n                color: var(--SmartThemeBodyColor, #888);\n                opacity: 0.6;\n            }\n\n            .mazemaster-bb-image-item {\n                position: relative;\n                width: 120px;\n                display: flex;\n                flex-direction: column;\n                border-radius: 5px;\n                overflow: hidden;\n                border: 2px solid var(--SmartThemeBorderColor, #444);\n                cursor: pointer;\n                background: rgba(0, 0, 0, 0.2);\n            }\n\n            .mazemaster-bb-image-item:hover {\n                border-color: var(--SmartThemeQuoteColor, #888);\n            }\n\n            .mazemaster-bb-image-item img {\n                width: 100%;\n                height: 80px;\n                object-fit: cover;\n            }\n\n            .mazemaster-bb-image-item .bb-image-index {\n                position: absolute;\n                top: 2px;\n                left: 2px;\n                background: rgba(0, 0, 0, 0.7);\n                color: white;\n                font-size: 0.7em;\n                padding: 2px 5px;\n                border-radius: 3px;\n            }\n\n            .mazemaster-bb-image-item .bb-image-message {\n                padding: 4px 6px;\n                font-size: 0.7em;\n                color: var(--SmartThemeBodyColor, #aaa);\n                text-align: center;\n                overflow: hidden;\n                text-overflow: ellipsis;\n                white-space: nowrap;\n                max-height: 20px;\n            }\n\n            .mazemaster-bb-image-item .bb-image-delete {\n                position: absolute;\n                top: 2px;\n                right: 2px;\n                background: rgba(231, 76, 60, 0.9);\n                color: white;\n                border: none;\n                width: 20px;\n                height: 20px;\n                border-radius: 50%;\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-size: 0.7em;\n            }\n\n            .mazemaster-bb-image-item .bb-image-delete:hover {\n                background: #c0392b;\n            }\n\n            /* Game Tab Styles */\n            .mazemaster-game-launch {\n                display: flex;\n                flex-direction: column;\n                gap: 15px;\n                padding: 10px 0;\n            }\n\n            .mazemaster-play-btn {\n                width: 100%;\n                padding: 15px 20px;\n                font-size: 1.2em;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 10px;\n            }\n\n            /* Maze Config Styles */\n            .mazemaster-textarea {\n                width: 100%;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 8px 10px;\n                color: var(--SmartThemeBodyColor, #fff);\n                font-family: monospace;\n                font-size: 0.9em;\n                min-height: 60px;\n                resize: vertical;\n            }\n\n            .mazemaster-maze-win-image-row {\n                display: flex;\n                gap: 10px;\n                align-items: flex-start;\n            }\n\n            .mazemaster-maze-win-image-preview {\n                width: 80px;\n                height: 80px;\n                border-radius: 5px;\n                border: 2px solid var(--SmartThemeBorderColor, #444);\n                overflow: hidden;\n                background: rgba(0, 0, 0, 0.2);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n            }\n\n            .mazemaster-maze-win-image-preview img {\n                width: 100%;\n                height: 100%;\n                object-fit: cover;\n            }\n\n            .mazemaster-maze-win-image-preview .no-image {\n                font-size: 0.7em;\n                opacity: 0.5;\n                text-align: center;\n            }\n\n            /* Maze Subsection Styles */\n            .mazemaster-subsection {\n                background: rgba(0, 0, 0, 0.15);\n                border-left: 3px solid var(--SmartThemeQuoteColor, #666);\n                padding: 10px;\n                margin: 10px 0;\n                border-radius: 0 5px 5px 0;\n            }\n\n            /* Encounters List Styles */\n            .mazemaster-encounters-list {\n                display: flex;\n                flex-direction: column;\n                gap: 8px;\n                margin-bottom: 10px;\n            }\n\n            .mazemaster-encounter-row {\n                display: flex;\n                gap: 8px;\n                align-items: center;\n            }\n\n            .mazemaster-encounter-row select {\n                flex: 1;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 6px 8px;\n                color: var(--SmartThemeBodyColor);\n            }\n\n            .mazemaster-encounter-row input[type="number"] {\n                width: 60px;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 6px 8px;\n                color: var(--SmartThemeBodyColor);\n                text-align: center;\n            }\n\n            .mazemaster-encounter-row .encounter-remove-btn {\n                padding: 5px 8px;\n            }\n\n            /* Maze Cell Minion Indicators */\n            .maze-cell.has-minion:not(.hidden)::before {\n                content: \'?\';\n                position: absolute;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                font-size: 0.7em;\n                color: #f39c12;\n                font-weight: bold;\n                z-index: 1;\n            }\n\n            .maze-cell.minion-triggered:not(.hidden)::before {\n                content: \'\\2713\';\n                color: #27ae60;\n            }\n\n            /* Maze Cell Chest Indicators */\n            .maze-cell.has-chest:not(.hidden)::before {\n                content: \'\\f187\';\n                font-family: \'Font Awesome 6 Free\';\n                font-weight: 900;\n                position: absolute;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                font-size: 0.6em;\n                color: #f39c12;\n                z-index: 1;\n            }\n\n            .maze-cell.chest-locked:not(.hidden)::before {\n                color: #95a5a6;\n            }\n\n            .maze-cell.chest-opened:not(.hidden)::before {\n                color: #666;\n                opacity: 0.5;\n            }\n\n            /* Maze Cell Trap Indicators */\n            .maze-cell.has-trap:not(.hidden)::before {\n                content: \'\\f6e2\';\n                font-family: \'Font Awesome 6 Free\';\n                font-weight: 900;\n                position: absolute;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                font-size: 0.6em;\n                color: #e74c3c;\n                z-index: 1;\n            }\n\n            .maze-cell.trap-triggered:not(.hidden)::before {\n                color: #666;\n                opacity: 0.5;\n            }\n\n            /* Inventory Display */\n            .mazemaster-maze-inventory {\n                display: flex;\n                justify-content: center;\n                gap: 20px;\n                padding: 10px 15px;\n                background: rgba(0, 0, 0, 0.4);\n                border-radius: 8px;\n                margin-bottom: 10px;\n            }\n\n            .inventory-item {\n                display: flex;\n                align-items: center;\n                gap: 5px;\n                font-size: 1.1em;\n                color: #fff;\n            }\n\n            .inventory-item i.fa-key { color: #f1c40f; }\n            .inventory-item i.fa-user-ninja { color: #9b59b6; }\n            .inventory-item i.fa-bolt { color: #e74c3c; }\n            .inventory-item.grandpow i.fa-star { color: #ffd700; text-shadow: 0 0 8px #ffd700; }\n            .inventory-item.grandpow { font-weight: bold; }\n\n            /* Encounter Confirmation Buttons */\n            .maze-confirm-buttons {\n                margin-top: 10px;\n                display: flex;\n                gap: 10px;\n                justify-content: center;\n            }\n\n            .maze-confirm-btn {\n                padding: 8px 16px;\n                font-size: 1em;\n            }\n\n            .maze-slip-btn {\n                background: linear-gradient(to bottom, #9b59b6, #8e44ad);\n            }\n\n            .maze-slip-btn:hover {\n                background: linear-gradient(to bottom, #8e44ad, #7d3c98);\n            }\n\n            .maze-accept-btn {\n                background: linear-gradient(to bottom, #27ae60, #1e8449);\n            }\n\n            .maze-accept-btn:hover {\n                background: linear-gradient(to bottom, #1e8449, #196f3d);\n            }\n\n            /* Chest Encounter Confirmation */\n            .maze-encounter-confirm {\n                display: flex;\n                gap: 10px;\n                justify-content: center;\n                margin-top: 15px;\n                padding: 10px;\n            }\n\n            /* Battlebar Action Buttons */\n            .mazemaster-bb-action-buttons {\n                display: flex;\n                gap: 10px;\n                justify-content: center;\n                flex-wrap: wrap;\n                width: 100%;\n                max-width: 400px;\n            }\n\n            .mazemaster-bb-pow-btn,\n            .mazemaster-bb-grandpow-btn {\n                flex: 1;\n                min-width: 120px;\n                max-width: 180px;\n                padding: 12px 15px;\n                font-size: 1em;\n                border-radius: 10px;\n                cursor: pointer;\n                font-weight: bold;\n                border: none;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 8px;\n                transition: transform 0.1s, box-shadow 0.1s;\n            }\n\n            .mazemaster-bb-pow-btn {\n                background: linear-gradient(to bottom, #e74c3c, #c0392b);\n                color: #fff;\n                box-shadow: 0 4px 10px rgba(231, 76, 60, 0.3);\n            }\n\n            .mazemaster-bb-pow-btn:hover {\n                background: linear-gradient(to bottom, #c0392b, #a93226);\n                transform: scale(1.02);\n            }\n\n            .mazemaster-bb-grandpow-btn {\n                background: linear-gradient(135deg, #ffd700, #ffaa00);\n                color: #000;\n                text-shadow: 0 1px 0 rgba(255,255,255,0.5);\n                box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);\n            }\n\n            .mazemaster-bb-grandpow-btn:hover {\n                background: linear-gradient(135deg, #ffea00, #ffc400);\n                box-shadow: 0 4px 20px rgba(255, 215, 0, 0.6);\n                transform: scale(1.02);\n            }\n\n            /* Encounter Percent Label */\n            .encounter-percent-label {\n                font-size: 0.9em;\n                color: #888;\n            }\n\n            .encounter-percent-input {\n                width: 50px;\n            }\n\n            /* Small input for config rows */\n            .mazemaster-input-small {\n                width: 60px;\n                padding: 4px 8px;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                color: var(--SmartThemeBodyColor);\n            }\n\n            /* Grid layout for config rows */\n            .mazemaster-row {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                margin-bottom: 6px;\n            }\n\n            .mazemaster-row label {\n                min-width: 90px;\n                font-size: 0.85em;\n                color: var(--SmartThemeBodyColor);\n                opacity: 0.9;\n            }\n\n            /* Two-column grid for percentage fields */\n            .mazemaster-grid-2col {\n                display: grid;\n                grid-template-columns: 1fr 1fr;\n                gap: 8px 16px;\n            }\n\n            .mazemaster-grid-2col .mazemaster-row {\n                margin-bottom: 0;\n            }\n\n            .mazemaster-grid-2col .mazemaster-row label {\n                min-width: 80px;\n            }\n\n            /* Three-column grid for loot percentages */\n            .mazemaster-grid-3col {\n                display: grid;\n                grid-template-columns: repeat(3, 1fr);\n                gap: 8px;\n            }\n\n            .mazemaster-grid-3col .mazemaster-row {\n                flex-direction: column;\n                align-items: flex-start;\n                gap: 4px;\n                margin-bottom: 0;\n            }\n\n            .mazemaster-grid-3col .mazemaster-row label {\n                min-width: auto;\n                font-size: 0.8em;\n                opacity: 0.8;\n            }\n\n            .mazemaster-grid-3col .mazemaster-input-small {\n                width: 100%;\n            }\n\n            /* 4-column grid */\n            .mazemaster-grid-4col {\n                display: grid;\n                grid-template-columns: repeat(4, 1fr);\n                gap: 8px;\n            }\n\n            .mazemaster-grid-4col .mazemaster-row {\n                flex-direction: column;\n                align-items: flex-start;\n                gap: 2px;\n                margin-bottom: 0;\n            }\n\n            .mazemaster-grid-4col .mazemaster-row label {\n                min-width: auto;\n                font-size: 0.75em;\n                opacity: 0.8;\n            }\n\n            .mazemaster-grid-4col .mazemaster-input-small {\n                width: 100%;\n            }\n\n            /* Collapsible Sections */\n            .mazemaster-collapsible {\n                margin-bottom: 8px;\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 6px;\n                overflow: hidden;\n            }\n\n            .mazemaster-collapsible-header {\n                width: 100%;\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                padding: 10px 12px;\n                background: rgba(0, 0, 0, 0.2);\n                border: none;\n                cursor: pointer;\n                text-align: left;\n                font-size: 0.95em;\n                font-weight: 500;\n                color: inherit;\n                transition: background 0.2s;\n            }\n\n            .mazemaster-collapsible-header:hover {\n                background: rgba(0, 0, 0, 0.3);\n            }\n\n            .mazemaster-collapse-icon {\n                font-size: 0.8em;\n                transition: transform 0.2s;\n            }\n\n            .mazemaster-collapsible.expanded .mazemaster-collapse-icon {\n                transform: rotate(90deg);\n            }\n\n            .mazemaster-collapse-hint {\n                font-size: 0.8em;\n                opacity: 0.6;\n                margin-left: auto;\n            }\n\n            .mazemaster-collapsible-content {\n                padding: 12px;\n                border-top: 1px solid var(--SmartThemeBorderColor, #444);\n                background: rgba(0, 0, 0, 0.1);\n            }\n\n            .mazemaster-collapsible-content .mazemaster-section:last-child {\n                margin-bottom: 0;\n            }\n\n            /* Inline row */\n            .mazemaster-inline-row {\n                display: flex;\n                gap: 12px;\n            }\n\n            .mazemaster-flex-1 {\n                flex: 1;\n            }\n\n            /* Saved Games */\n            .mazemaster-saved-games-list {\n                display: flex;\n                flex-direction: column;\n                gap: 8px;\n            }\n\n            .mazemaster-saved-game {\n                display: flex;\n                justify-content: space-between;\n                align-items: center;\n                padding: 8px 12px;\n                background: rgba(0, 0, 0, 0.2);\n                border-radius: 4px;\n            }\n\n            .mazemaster-saved-game-info {\n                display: flex;\n                flex-direction: column;\n                gap: 2px;\n            }\n\n            .mazemaster-saved-game-name {\n                font-weight: 500;\n            }\n\n            .mazemaster-saved-game-details {\n                font-size: 0.8em;\n                opacity: 0.7;\n            }\n\n            .mazemaster-saved-game-actions {\n                display: flex;\n                gap: 6px;\n            }\n\n            .mazemaster-no-saves {\n                text-align: center;\n                opacity: 0.6;\n                padding: 12px;\n                font-style: italic;\n            }\n\n            /* Side-by-side sections */\n            .mazemaster-section-row {\n                display: grid;\n                grid-template-columns: 1fr 1fr;\n                gap: 16px;\n            }\n\n            .mazemaster-section-row .mazemaster-section {\n                margin-bottom: 0;\n            }\n\n            /* Minions Config Styles */\n            .mazemaster-minions-list {\n                display: flex;\n                flex-direction: column;\n                gap: 10px;\n                margin-bottom: 10px;\n            }\n\n            .mazemaster-minion-card {\n                display: flex;\n                gap: 10px;\n                align-items: center;\n                padding: 10px;\n                background: rgba(0, 0, 0, 0.2);\n                border-radius: 5px;\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n            }\n\n            .mazemaster-minion-card .minion-image {\n                width: 50px;\n                height: 50px;\n                border-radius: 5px;\n                overflow: hidden;\n                background: rgba(0, 0, 0, 0.3);\n                flex-shrink: 0;\n            }\n\n            .mazemaster-minion-card .minion-image img {\n                width: 100%;\n                height: 100%;\n                object-fit: cover;\n            }\n\n            .mazemaster-minion-card .minion-info {\n                flex: 1;\n            }\n\n            .mazemaster-minion-card .minion-row {\n                display: flex;\n                gap: 8px;\n                margin-bottom: 8px;\n            }\n\n            .mazemaster-minion-card .minion-name-input {\n                flex: 1;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 6px 8px;\n                color: var(--SmartThemeBodyColor);\n            }\n\n            .mazemaster-minion-card .minion-type-select {\n                width: 110px;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 6px 8px;\n                color: var(--SmartThemeBodyColor);\n            }\n\n            .mazemaster-minion-card .minion-profiles {\n                margin-top: 8px;\n            }\n\n            .mazemaster-minion-card .minion-profiles label {\n                display: block;\n                font-size: 0.85em;\n                color: var(--SmartThemeQuoteColor);\n                margin-bottom: 4px;\n            }\n\n            .mazemaster-minion-card .minion-profiles select {\n                width: 100%;\n                min-height: 60px;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 4px;\n                color: var(--SmartThemeBodyColor);\n            }\n\n            .mazemaster-minion-card .minion-profiles textarea {\n                width: 100%;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 6px 8px;\n                color: var(--SmartThemeBodyColor);\n                resize: vertical;\n            }\n\n            .mazemaster-minion-card .merchant-range-row {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n            }\n\n            .mazemaster-minion-card .merchant-range-row span {\n                color: var(--SmartThemeBodyColor);\n                opacity: 0.8;\n            }\n\n            .mazemaster-minion-card .minion-encounter-script {\n                margin-top: 10px;\n                padding-top: 10px;\n                border-top: 1px solid var(--SmartThemeBorderColor, #333);\n            }\n\n            .mazemaster-minion-card .minion-encounter-script label {\n                display: block;\n                font-size: 0.85em;\n                color: var(--SmartThemeQuoteColor);\n                margin-bottom: 4px;\n            }\n\n            .mazemaster-minion-card .minion-encounter-script textarea {\n                width: 100%;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 6px 8px;\n                color: var(--SmartThemeBodyColor);\n                resize: vertical;\n                font-family: monospace;\n            }\n\n            .mazemaster-minion-card .minion-delete-btn {\n                padding: 5px 8px;\n                flex-shrink: 0;\n                align-self: flex-start;\n            }\n\n            /* TRAP CARD STYLES */\n            .mazemaster-traps-list {\n                display: flex;\n                flex-direction: column;\n                gap: 10px;\n                margin-bottom: 10px;\n                max-height: 400px;\n                overflow-y: auto;\n            }\n\n            .mazemaster-trap-card {\n                display: flex;\n                gap: 10px;\n                background: rgba(0, 0, 0, 0.2);\n                border-radius: 8px;\n                padding: 10px;\n                align-items: flex-start;\n            }\n\n            .mazemaster-trap-card .trap-image {\n                width: 80px;\n                height: 80px;\n                flex-shrink: 0;\n                border-radius: 6px;\n                overflow: hidden;\n                background: rgba(0, 0, 0, 0.3);\n            }\n\n            .mazemaster-trap-card .trap-image img {\n                width: 100%;\n                height: 100%;\n                object-fit: cover;\n            }\n\n            .mazemaster-trap-card .trap-no-image {\n                width: 100%;\n                height: 100%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                color: var(--SmartThemeBodyColor);\n                opacity: 0.5;\n                font-size: 24px;\n            }\n\n            .mazemaster-trap-card .trap-info {\n                flex: 1;\n                display: flex;\n                flex-direction: column;\n                gap: 8px;\n            }\n\n            .mazemaster-trap-card .trap-row {\n                display: flex;\n                gap: 8px;\n            }\n\n            .mazemaster-trap-card .trap-name-input {\n                flex: 1;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 6px 8px;\n                color: var(--SmartThemeBodyColor);\n            }\n\n            .mazemaster-trap-card .trap-message-row,\n            .mazemaster-trap-card .trap-script-row {\n                display: flex;\n                flex-direction: column;\n                gap: 4px;\n            }\n\n            .mazemaster-trap-card .trap-message-row label,\n            .mazemaster-trap-card .trap-script-row label {\n                font-size: 0.75em;\n                opacity: 0.7;\n            }\n\n            .mazemaster-trap-card .trap-message-input,\n            .mazemaster-trap-card .trap-script-input {\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 6px 8px;\n                color: var(--SmartThemeBodyColor);\n                resize: vertical;\n                font-family: inherit;\n            }\n\n            .mazemaster-trap-card .trap-delete-btn {\n                padding: 5px 8px;\n                flex-shrink: 0;\n                align-self: flex-start;\n            }\n\n            /* Story Milestones Modal */\n            .mazemaster-story-modal {\n                position: fixed;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                background: rgba(0, 0, 0, 0.7);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                z-index: 10000;\n            }\n\n            .mazemaster-story-modal-content {\n                background: var(--SmartThemeBlurTintColor, #1a1a1a);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 10px;\n                padding: 20px;\n                width: 90%;\n                max-width: 600px;\n                max-height: 80vh;\n                overflow-y: auto;\n            }\n\n            .mazemaster-story-modal-content h3 {\n                margin: 0 0 15px 0;\n                display: flex;\n                align-items: center;\n                gap: 10px;\n            }\n\n            .mazemaster-story-textarea {\n                width: 100%;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 8px;\n                color: var(--SmartThemeBodyColor);\n                resize: vertical;\n                font-family: inherit;\n            }\n\n            .mazemaster-milestones-list {\n                display: flex;\n                flex-direction: column;\n                gap: 10px;\n                margin-bottom: 10px;\n                max-height: 200px;\n                overflow-y: auto;\n            }\n\n            .mazemaster-milestone-row {\n                display: flex;\n                gap: 10px;\n                align-items: flex-start;\n                background: rgba(0, 0, 0, 0.2);\n                padding: 10px;\n                border-radius: 6px;\n            }\n\n            .milestone-percent {\n                display: flex;\n                align-items: center;\n                gap: 4px;\n                flex-shrink: 0;\n            }\n\n            .milestone-percent-input {\n                width: 50px;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 6px;\n                color: var(--SmartThemeBodyColor);\n                text-align: center;\n            }\n\n            .milestone-text-input {\n                flex: 1;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 6px;\n                color: var(--SmartThemeBodyColor);\n                resize: vertical;\n                font-family: inherit;\n            }\n\n            .mazemaster-story-modal-buttons {\n                display: flex;\n                gap: 10px;\n                justify-content: flex-end;\n                margin-top: 15px;\n            }\n        </style>\n    ')}function Qe(){var e;const n=document.getElementById("mazemaster_segments_list");if(!n)return;const t=D(null===(e=document.getElementById("mazemaster_profile_select"))||void 0===e?void 0:e.value),a=(null==t?void 0:t.segments)||[];0!==a.length?(n.innerHTML=a.map(((e,n)=>'\n        <div class="mazemaster-segment-item" data-index="'.concat(n,'">\n            <div class="mazemaster-segment-row">\n                <div class="mazemaster-segment-field small">\n                    <label>Trigger</label>\n                    <input type="text" class="seg-trigger" value="').concat(Ze(e.trigger||""),'" placeholder="com1">\n                </div>\n                <div class="mazemaster-segment-field">\n                    <label>Display Text</label>\n                    <input type="text" class="seg-text" value="').concat(Ze(e.text||""),'" placeholder="Prize name">\n                </div>\n                <div class="mazemaster-segment-field small">\n                    <label>Size</label>\n                    <select class="seg-size">\n                        ').concat(h.map((n=>'<option value="'.concat(n,'" ').concat(e.size===n?"selected":"",">").concat(n,"</option>"))).join(""),'\n                    </select>\n                </div>\n                <button class="menu_button menu_button_icon mazemaster-segment-delete" title="Delete">\n                    <i class="fa-solid fa-trash"></i>\n                </button>\n            </div>\n            <div class="mazemaster-segment-row">\n                <div class="mazemaster-segment-field">\n                    <label>STScript Command</label>\n                    <textarea class="seg-command" placeholder="/echo You won!">').concat(Ze(e.command||""),'</textarea>\n                </div>\n                <div class="mazemaster-segment-field tiny">\n                    <label>&nbsp;</label>\n                    <label class="mazemaster-segment-checkbox">\n                        <input type="checkbox" class="seg-respin" ').concat(e.respin?"checked":"",">\n                        Respin\n                    </label>\n                </div>\n            </div>\n        </div>\n    "))).join(""),n.querySelectorAll(".mazemaster-segment-delete").forEach((e=>{e.addEventListener("click",(e=>{e.target.closest(".mazemaster-segment-item").remove()}))}))):n.innerHTML='<div class="mazemaster-empty-state">No segments. Click "Add Segment" to create one.</div>'}function Ze(e){const n=document.createElement("div");return n.textContent=e||"",n.innerHTML}function $e(){var e;const n=document.getElementById("mazemaster_bb_images_list");if(!n)return;const t=null===(e=document.getElementById("mazemaster_bb_profile_select"))||void 0===e?void 0:e.value;if(!t)return void(n.innerHTML='<div class="mazemaster-empty-state">Select or create a profile first.</div>');const a=(A(t)||{}).images||[];0!==a.length?(n.innerHTML=a.map(((e,n)=>'\n        <div class="mazemaster-bb-image-item" data-index="'.concat(n,'" title="Click to edit stage message">\n            <img src="/').concat(e.path,'" alt="').concat(Ze(e.stageMessage||""),'">\n            <span class="bb-image-index">').concat(n,'</span>\n            <div class="bb-image-message">').concat(Ze(e.stageMessage||"(no message)"),'</div>\n            <button class="bb-image-delete" title="Delete">\n                <i class="fa-solid fa-times"></i>\n            </button>\n        </div>\n    '))).join(""),n.querySelectorAll(".mazemaster-bb-image-item").forEach((e=>{e.addEventListener("click",(async n=>{var a;if(n.target.closest(".bb-image-delete"))return;const o=parseInt(e.dataset.index),i=A(t)||{},s=i.images||[],r=(null===(a=s[o])||void 0===a?void 0:a.stageMessage)||"",l=await d("Stage ".concat(o," Message:"),p.INPUT,r);null!=l&&(s[o].stageMessage=l,j(t,i),$e())}))})),n.querySelectorAll(".bb-image-delete").forEach((e=>{e.addEventListener("click",(async e=>{e.stopPropagation();const n=e.target.closest(".mazemaster-bb-image-item"),a=parseInt(n.dataset.index);if(!await d("Delete stage ".concat(a,"?"),p.CONFIRM))return;const o=A(t)||{};o.images=(o.images||[]).filter(((e,n)=>n!==a)),j(t,o),$e()}))}))):n.innerHTML='<div class="mazemaster-empty-state">No stages. Add images to create stages.</div>'}function en(){var e;const n=q(null===(e=document.getElementById("mazemaster_maze_profile_select"))||void 0===e?void 0:e.value)||{},t=document.getElementById("mazemaster_maze_size");t&&(t.value=n.gridSize||10);const a=document.getElementById("mazemaster_maze_win_cmd");a&&(a.value=n.winCommand||"");const o=document.getElementById("mazemaster_maze_lose_cmd");o&&(o.value=n.loseCommand||"");const i=document.getElementById("mazemaster_maze_win_message");i&&(i.value=n.winMessage||"");const s=document.getElementById("mazemaster_maze_main_minion");if(s){const e=W();s.innerHTML='<option value="">None</option>'+e.map((e=>{const t=G(e);return'<option value="'.concat(Ze(e),'" ').concat(n.mainMinion===e?"selected":"",">").concat(Ze((null==t?void 0:t.name)||e),"</option>")})).join("")}const r=document.getElementById("mazemaster_main_minion_settings");r&&(r.style.display=n.mainMinion?"block":"none");const l=document.getElementById("mazemaster_maze_intro_message");l&&(l.value=n.mainMinionIntroMessage||"");const m=document.getElementById("mazemaster_maze_random_chance");m&&(m.value=n.mainMinionRandomChance||15);const c=document.getElementById("mazemaster_maze_random_messages");c&&(c.value=(n.mainMinionRandomMessages||[]).join("\n"));const d=document.getElementById("mazemaster_maze_exit_type");d&&(d.value=n.mainMinionExitType||"messenger"),nn(n.mainMinionExitType||"messenger",n.mainMinionExitProfile);const p=document.getElementById("mazemaster_maze_loss_action");p&&(p.value=n.onBattlebarLoss||"continue");const u=document.querySelector(".mazemaster-maze-win-image-preview");u&&(n.winImage?u.innerHTML='<img id="maze_win_image_preview" src="'.concat(n.winImage,'" alt="Victory">'):u.innerHTML='<div id="maze_win_image_preview" class="no-image">No image</div>');const g=document.getElementById("mazemaster_maze_chest_percent");g&&(g.value=n.chestTilePercent||10);const b=document.getElementById("mazemaster_maze_locked_percent");b&&(b.value=n.chestLockedPercent||30);const f=document.getElementById("mazemaster_maze_locked_bonus");f&&(f.value=n.chestLockedBonusPercent||50);const v=document.getElementById("mazemaster_maze_mimic_percent");v&&(v.value=n.chestMimicPercent||15);const h=document.getElementById("mazemaster_maze_loot_min");h&&(h.value=n.chestLootMin||1);const z=document.getElementById("mazemaster_maze_loot_max");z&&(z.value=n.chestLootMax||2);const y=document.getElementById("mazemaster_maze_chest_key");y&&(y.value=n.chestKeyChance||30);const _=document.getElementById("mazemaster_maze_chest_pow");_&&(_.value=n.chestPowChance||50);const x=document.getElementById("mazemaster_maze_chest_stealth");x&&(x.value=n.chestStealthChance||0);const w=document.getElementById("mazemaster_maze_chest_grandpow");w&&(w.value=n.chestGrandpowChance||0);const E=document.getElementById("mazemaster_maze_locked_key");E&&(E.value=n.lockedChestKeyChance||40);const M=document.getElementById("mazemaster_maze_locked_pow");M&&(M.value=n.lockedChestPowChance||60);const I=document.getElementById("mazemaster_maze_locked_stealth");I&&(I.value=n.lockedChestStealthChance||30);const k=document.getElementById("mazemaster_maze_locked_grandpow");k&&(k.value=n.lockedChestGrandpowChance||5);const C=n.startingInventory||{},S=document.getElementById("mazemaster_maze_start_key");S&&(S.value=C.key||0);const P=document.getElementById("mazemaster_maze_start_stealth");P&&(P.value=C.stealth||0);const B=document.getElementById("mazemaster_maze_start_pow");B&&(B.value=C.pow||0);const T=document.getElementById("mazemaster_maze_start_grandpow");T&&(T.value=C.grandpow||0),function(e){const n=document.getElementById("mazemaster_maze_encounters_list");if(!n)return;const t=W();if(0===e.length)return void(n.innerHTML='<div class="mazemaster-empty-state" style="font-size: 0.85em;">No encounters. Minions will be randomly placed in the maze.</div>');n.innerHTML=e.map(((e,n)=>{G(e.minionId);return'\n            <div class="mazemaster-encounter-row" data-index="'.concat(n,'">\n                <select class="encounter-minion-select">\n                    ').concat(t.map((n=>{const t=G(n);return'<option value="'.concat(Ze(n),'" ').concat(e.minionId===n?"selected":"",">").concat(Ze((null==t?void 0:t.name)||n),"</option>")})).join(""),'\n                </select>\n                <input type="number" class="encounter-percent-input" min="1" max="100" value="').concat(e.percent||5,'" placeholder="%">\n                <span class="encounter-percent-label">%</span>\n                <button class="menu_button menu_button_icon encounter-remove-btn" title="Remove">\n                    <i class="fa-solid fa-trash"></i>\n                </button>\n            </div>\n        ')})).join(""),n.querySelectorAll(".mazemaster-encounter-row").forEach((e=>{var n,t,a;parseInt(e.dataset.index);null===(n=e.querySelector(".encounter-minion-select"))||void 0===n||n.addEventListener("change",(()=>{})),null===(t=e.querySelector(".encounter-percent-input"))||void 0===t||t.addEventListener("change",(()=>{})),null===(a=e.querySelector(".encounter-remove-btn"))||void 0===a||a.addEventListener("click",(()=>{e.remove()}))}))}(n.minionEncounters||[]),function(e){const n=document.getElementById("mazemaster_maze_traps_list");if(!n)return;const t=Y();if(0===e.length)return void(n.innerHTML='<div class="mazemaster-empty-state" style="font-size: 0.85em;">No traps. Add traps to place trap tiles in the maze.</div>');n.innerHTML=e.map(((e,n)=>{U(e.trapId);return'\n            <div class="mazemaster-encounter-row mazemaster-trap-encounter-row" data-index="'.concat(n,'">\n                <select class="trap-encounter-select">\n                    ').concat(t.map((n=>{const t=U(n);return'<option value="'.concat(Ze(n),'" ').concat(e.trapId===n?"selected":"",">").concat(Ze((null==t?void 0:t.name)||n),"</option>")})).join(""),'\n                </select>\n                <input type="number" class="trap-encounter-percent-input" min="1" max="100" value="').concat(e.percent||5,'" placeholder="%">\n                <span class="encounter-percent-label">%</span>\n                <button class="menu_button menu_button_icon trap-encounter-remove-btn" title="Remove">\n                    <i class="fa-solid fa-trash"></i>\n                </button>\n            </div>\n        ')})).join(""),n.querySelectorAll(".mazemaster-trap-encounter-row").forEach((e=>{var n;null===(n=e.querySelector(".trap-encounter-remove-btn"))||void 0===n||n.addEventListener("click",(()=>{e.remove()}))}))}(n.trapEncounters||[])}function nn(e,n){const t=document.getElementById("mazemaster_exit_profile_section"),a=document.getElementById("mazemaster_maze_exit_profile");if(!t||!a)return;if("messenger"===e)return void(t.style.display="none");t.style.display="block";let o=[];"battlebar"===e?o=N():"prizewheel"===e&&(o=O()),a.innerHTML='<option value="">Select...</option>'+o.map((e=>'<option value="'.concat(Ze(e),'" ').concat(e===n?"selected":"",">").concat(Ze(e),"</option>"))).join("")}async function tn(e,n){return new Promise(((t,a)=>{const o=new FileReader;o.onload=async o=>{try{const i=o.target.result.split(",")[1],s=e.name.split(".").pop().toLowerCase(),r=Date.now(),l="".concat(n,"_").concat(r),m=await fetch("/api/images/upload",{method:"POST",headers:c(),body:JSON.stringify({image:i,ch_name:"MazeMaster",filename:l,format:s})});if(m.ok)t("user/images/MazeMaster/".concat(l,".").concat(s));else{const e=await m.json().catch((()=>({})));a(new Error(e.error||"Upload failed"))}}catch(e){a(e)}},o.onerror=()=>a(new Error("Failed to read file")),o.readAsDataURL(e)}))}function an(){const e=document.getElementById("mazemaster_minions_list");if(!e)return;const n=W();if(0===n.length)return void(e.innerHTML='<div class="mazemaster-empty-state">No minions. Add minions for use in the maze game.</div>');const t=N(),a=O();e.innerHTML=n.map((e=>{const n=G(e),o=n.type||"messenger",i=n.battlebarProfiles||[],s=n.wheelProfiles||[],r=n.messages||[],l=n.encounterScript||"",m=n.merchantItemCount||{min:1,max:3};return'\n            <div class="mazemaster-minion-card" data-id="'.concat(Ze(e),'">\n                <div class="minion-image">\n                    ').concat(n.imagePath?'<img src="'.concat(Ze(n.imagePath),'" alt="').concat(Ze(n.name),'">'):"",'\n                </div>\n                <div class="minion-info">\n                    <div class="minion-row">\n                        <input type="text" class="minion-name-input" value="').concat(Ze(n.name),'" placeholder="Minion name">\n                        <select class="minion-type-select">\n                            <option value="messenger" ').concat("messenger"===o?"selected":"",'>Messenger</option>\n                            <option value="battlebar" ').concat("battlebar"===o?"selected":"",'>Battlebar</option>\n                            <option value="prizewheel" ').concat("prizewheel"===o?"selected":"",'>PrizeWheel</option>\n                            <option value="merchant" ').concat("merchant"===o?"selected":"",'>Merchant</option>\n                        </select>\n                    </div>\n                    <div class="minion-profiles battlebar-profiles" style="display: ').concat("battlebar"===o?"block":"none",';">\n                        <label>Battlebar Profiles:</label>\n                        <select multiple class="minion-battlebar-select">\n                            ').concat(t.map((e=>'<option value="'.concat(Ze(e),'" ').concat(i.includes(e)?"selected":"",">").concat(Ze(e),"</option>"))).join(""),'\n                        </select>\n                    </div>\n                    <div class="minion-profiles wheel-profiles" style="display: ').concat("prizewheel"===o?"block":"none",';">\n                        <label>Wheel Profiles:</label>\n                        <select multiple class="minion-wheel-select">\n                            ').concat(a.map((e=>'<option value="'.concat(Ze(e),'" ').concat(s.includes(e)?"selected":"",">").concat(Ze(e),"</option>"))).join(""),'\n                        </select>\n                    </div>\n                    <div class="minion-profiles messenger-messages" style="display: ').concat("messenger"===o?"block":"none",';">\n                        <label>Messages (one per line):</label>\n                        <textarea class="minion-messages-input" rows="2" placeholder="Hello traveler!&#10;Beware the maze...">').concat(Ze(r.join("\n")),'</textarea>\n                    </div>\n                    <div class="minion-profiles merchant-settings" style="display: ').concat("merchant"===o?"block":"none",';">\n                        <label>Trade Items Required:</label>\n                        <div class="merchant-range-row">\n                            <input type="number" class="merchant-min-input mazemaster-input-small" min="1" max="10" value="').concat(m.min,'">\n                            <span>to</span>\n                            <input type="number" class="merchant-max-input mazemaster-input-small" min="1" max="10" value="').concat(m.max,'">\n                            <span>items for 1 Grandpow</span>\n                        </div>\n                    </div>\n                    <div class="minion-encounter-script">\n                        <label>Encounter Script (STScript):</label>\n                        <textarea class="minion-script-input" rows="2" placeholder="/echo Custom action on encounter...">').concat(Ze(l),'</textarea>\n                    </div>\n                </div>\n                <button class="menu_button menu_button_icon minion-delete-btn" title="Delete Minion">\n                    <i class="fa-solid fa-trash"></i>\n                </button>\n            </div>\n        ')})).join(""),e.querySelectorAll(".mazemaster-minion-card").forEach((e=>{const n=e.dataset.id,t=e.querySelector(".minion-name-input");t&&t.addEventListener("change",(()=>{const e=G(n);e&&(e.name=t.value.trim()||"Unknown",F(n,e))}));const a=e.querySelector(".minion-type-select");a&&a.addEventListener("change",(()=>{const t=G(n);if(t){t.type=a.value,F(n,t);const o=e.querySelector(".battlebar-profiles"),i=e.querySelector(".wheel-profiles"),s=e.querySelector(".messenger-messages"),r=e.querySelector(".merchant-settings");o&&(o.style.display="battlebar"===t.type?"block":"none"),i&&(i.style.display="prizewheel"===t.type?"block":"none"),s&&(s.style.display="messenger"===t.type?"block":"none"),r&&(r.style.display="merchant"===t.type?"block":"none")}}));const i=e.querySelector(".minion-battlebar-select");i&&i.addEventListener("change",(()=>{const e=G(n);e&&(e.battlebarProfiles=Array.from(i.selectedOptions).map((e=>e.value)),F(n,e))}));const s=e.querySelector(".minion-wheel-select");s&&s.addEventListener("change",(()=>{const e=G(n);e&&(e.wheelProfiles=Array.from(s.selectedOptions).map((e=>e.value)),F(n,e))}));const r=e.querySelector(".minion-messages-input");r&&r.addEventListener("change",(()=>{const e=G(n);e&&(e.messages=r.value.split("\n").filter((e=>e.trim())),F(n,e))}));const l=e.querySelector(".merchant-min-input"),m=e.querySelector(".merchant-max-input");l&&l.addEventListener("change",(()=>{const e=G(n);e&&(e.merchantItemCount=e.merchantItemCount||{min:1,max:3},e.merchantItemCount.min=parseInt(l.value)||1,F(n,e))})),m&&m.addEventListener("change",(()=>{const e=G(n);e&&(e.merchantItemCount=e.merchantItemCount||{min:1,max:3},e.merchantItemCount.max=parseInt(m.value)||3,F(n,e))}));const c=e.querySelector(".minion-script-input");c&&c.addEventListener("change",(()=>{const e=G(n);e&&(e.encounterScript=c.value,F(n,e))}));const u=e.querySelector(".minion-delete-btn");u&&u.addEventListener("click",(async()=>{const e=G(n);var t;await d('Delete minion "'.concat((null==e?void 0:e.name)||n,'"?'),p.CONFIRM)&&(t=n,delete C.minions[t],o(),an())}))}))}function on(){const e=document.getElementById("mazemaster_traps_list");if(!e)return;const n=Y();0!==n.length?(e.innerHTML=n.map((e=>{const n=U(e);return'\n            <div class="mazemaster-trap-card" data-id="'.concat(Ze(e),'">\n                <div class="trap-image">\n                    ').concat(n.imagePath?'<img src="'.concat(Ze(n.imagePath),'" alt="').concat(Ze(n.name),'">'):'<div class="trap-no-image"><i class="fa-solid fa-dungeon"></i></div>','\n                </div>\n                <div class="trap-info">\n                    <div class="trap-row">\n                        <input type="text" class="trap-name-input mazemaster-input" value="').concat(Ze(n.name),'" placeholder="Trap name">\n                    </div>\n                    <div class="trap-message-row">\n                        <label>Message:</label>\n                        <textarea class="trap-message-input" rows="2" placeholder="You triggered a trap!">').concat(Ze(n.message||""),'</textarea>\n                    </div>\n                    <div class="trap-script-row">\n                        <label>Script (STScript):</label>\n                        <textarea class="trap-script-input" rows="2" placeholder="/echo Trap triggered!">').concat(Ze(n.script||""),'</textarea>\n                    </div>\n                </div>\n                <button class="menu_button menu_button_icon trap-delete-btn" title="Delete Trap">\n                    <i class="fa-solid fa-trash"></i>\n                </button>\n            </div>\n        ')})).join(""),e.querySelectorAll(".mazemaster-trap-card").forEach((e=>{const n=e.dataset.id,t=e.querySelector(".trap-name-input");t&&t.addEventListener("change",(()=>{const e=U(n);e&&(e.name=t.value.trim()||"Unknown Trap",J(n,e))}));const a=e.querySelector(".trap-message-input");a&&a.addEventListener("change",(()=>{const e=U(n);e&&(e.message=a.value,J(n,e))}));const i=e.querySelector(".trap-script-input");i&&i.addEventListener("change",(()=>{const e=U(n);e&&(e.script=i.value,J(n,e))}));const s=e.querySelector(".trap-delete-btn");s&&s.addEventListener("click",(async()=>{const e=U(n);var t;await d('Delete trap "'.concat((null==e?void 0:e.name)||n,'"?'),p.CONFIRM)&&(t=n,delete C.traps[t],o(),on())}))}))):e.innerHTML='<div class="mazemaster-empty-state">No traps. Add traps for use in maze profiles.</div>'}function sn(){let e;console.log("[MazeMaster] initUI called");try{e=Xe(),console.log("[MazeMaster] getPanelHtml succeeded")}catch(n){console.error("[MazeMaster] getPanelHtml FAILED:",n),e="<div>Error loading panel</div>"}const n=document.createElement("div");n.id="mazemaster-button",n.className="drawer",n.innerHTML='\n        <div class="drawer-toggle drawer-header">\n            <div class="drawer-icon fa-solid fa-dharmachakra fa-fw closedIcon" title="MazeMaster"></div>\n        </div>\n        <div id="mazemaster_drawer" class="drawer-content closedDrawer">\n            '.concat(e,"\n        </div>\n    ");const t=document.getElementById("extensions-settings-button");console.log("[MazeMaster] extensions-settings-button:",t),t?(t.after(n),console.log("[MazeMaster] Drawer inserted after extensions button")):console.error("[MazeMaster] extensions-settings-button NOT FOUND!");const a=n.querySelector(".drawer-toggle");if(a&&window.jQuery){const e=window.jQuery;e(a).on("click",(async function(){const n=e(this).find(".drawer-icon"),t=e(this).parent().find(".drawer-content");t.hasClass("openDrawer")||(e(".openDrawer:not(.pinnedOpen)").removeClass("openDrawer").addClass("closedDrawer"),e(".openIcon:not(.drawerPinnedOpen)").removeClass("openIcon").addClass("closedIcon")),n.toggleClass("openIcon closedIcon"),t.toggleClass("openDrawer closedDrawer")}))}dn(),Qe(),"battlebar"===C.activeGameConfig&&$e()}function rn(){const e=document.getElementById("mazemaster_maze_chest_percent");e&&(e.value="15");const n=document.getElementById("mazemaster_maze_encounters_list"),t=(null==n?void 0:n.querySelectorAll(".mazemaster-encounter-row"))||[],a={messenger:10,prizewheel:6,battlebar:4,merchant:1};let o=0;const i=[];t.forEach((e=>{const n=e.getAttribute("data-minion-id");if(!n)return;const t=G(n),s=(null==t?void 0:t.type)||"battlebar",r=a[s]||4;o+=r,i.push({row:e,type:s,weight:r})}));o>0&&i.forEach((e=>{let{row:n,weight:t}=e;const a=Math.round(t/o*60),i=n.querySelector(".encounter-percent-input");i&&(i.value=a)}));const s=document.getElementById("mazemaster_maze_traps_list"),r=(null==s?void 0:s.querySelectorAll(".mazemaster-encounter-row"))||[];if(r.length>0){const e=Math.floor(5/r.length);r.forEach((n=>{const t=n.querySelector(".encounter-percent-input");t&&(t.value=e||1)}))}console.log("[MazeMaster] Intelligent Distribute applied: Chests 15%, Traps 5%, Minions distributed")}function ln(e){var t;const a=null===(t=C.savedMazes)||void 0===t?void 0:t[e];if(!a)return console.warn('[MazeMaster] No saved game for "'.concat(e,'"')),!1;const o=q(e);if(!o)return console.error('[MazeMaster] Profile "'.concat(e,'" no longer exists')),!1;const i=a.grid.map((e=>e.map((e=>({walls:e.walls,visited:e.visited,minion:e.minion,trap:e.trap,chest:e.chest})))));let s={name:"The Maze",imagePath:"",message:"Find your way to the exit..."};const r=o.mainMinion?G(o.mainMinion):null;return r&&(s={name:r.name,imagePath:r.imagePath,message:"Continuing your journey..."}),B={isOpen:!0,profile:o,profileName:e,grid:i,size:a.size,playerX:a.playerX,playerY:a.playerY,exitX:a.exitX,exitY:a.exitY,visited:new Set(a.visited),isVictory:!1,currentMinion:s,isPaused:!1,pendingEncounter:null,exitEncounterDone:a.exitEncounterDone,pendingConfirmation:null,pendingChest:null,inventory:n({},a.inventory),shownMilestones:new Set(a.shownMilestones||[])},Ee(),Ie(),ke(),Be(),document.addEventListener("keydown",Ce),console.log('[MazeMaster] Loaded saved maze "'.concat(e,'"')),!0}function mn(e){var n;return!(null===(n=C.savedMazes)||void 0===n||!n[e])&&(delete C.savedMazes[e],o(),console.log('[MazeMaster] Deleted saved maze "'.concat(e,'"')),!0)}function cn(){const e=["mazemaster_saved_games_list","mazemaster_game_tab_saves"],n=Object.keys(C.savedMazes||{});for(const t of e){const e=document.getElementById(t);e&&(0!==n.length?(e.innerHTML=n.map((e=>{const n=C.savedMazes[e],t=new Date(n.timestamp),a=n.visited?Math.round(n.visited.length/(n.size*n.size)*100):0;return'\n                <div class="mazemaster-saved-game" data-profile="'.concat(Ze(e),'">\n                    <div class="mazemaster-saved-game-info">\n                        <div class="mazemaster-saved-game-name">').concat(Ze(e),'</div>\n                        <div class="mazemaster-saved-game-details">').concat(a,"% explored - ").concat(t.toLocaleDateString(),'</div>\n                    </div>\n                    <div class="mazemaster-saved-game-actions">\n                        <button class="menu_button menu_button_icon saved-game-load" title="Resume">\n                            <i class="fa-solid fa-play"></i>\n                        </button>\n                        <button class="menu_button menu_button_icon saved-game-delete" title="Delete">\n                            <i class="fa-solid fa-trash"></i>\n                        </button>\n                    </div>\n                </div>\n            ')})).join(""),e.querySelectorAll(".mazemaster-saved-game").forEach((e=>{var n,t;const a=e.dataset.profile;null===(n=e.querySelector(".saved-game-load"))||void 0===n||n.addEventListener("click",(()=>{ln(a)})),null===(t=e.querySelector(".saved-game-delete"))||void 0===t||t.addEventListener("click",(async()=>{await d('Delete saved game "'.concat(a,'"?'),p.CONFIRM)&&(mn(a),cn())}))}))):e.innerHTML='<div class="mazemaster-no-saves">No saved games</div>')}}function dn(){const e=document.getElementById("mazemaster_profile_select");e&&e.addEventListener("change",(e=>{C.currentProfile=e.target.value,o(),function(){var e;const n=D(null===(e=document.getElementById("mazemaster_profile_select"))||void 0===e?void 0:e.value),t=document.getElementById("mazemaster_randomize");t&&(t.checked=(null==n?void 0:n.randomize)||!1);const a=document.getElementById("mazemaster_difficulty");a&&(a.value=(null==n?void 0:n.difficulty)||1)}(),Qe()}));const n=document.getElementById("mazemaster_new_profile_btn");n&&n.addEventListener("click",(async e=>{e.preventDefault(),e.stopPropagation();const n=await d("Enter new wheel profile name:",p.INPUT,"");if(n&&n.trim()){const e=n.trim();C.profiles[e]?await d('Profile "'.concat(e,'" already exists.'),p.TEXT):(C.profiles[e]={segments:[],randomize:!1,difficulty:1},C.currentProfile=e,o(),pn())}}));const t=document.getElementById("mazemaster_delete_profile_btn");t&&t.addEventListener("click",(async()=>{var e;const n=null===(e=document.getElementById("mazemaster_profile_select"))||void 0===e?void 0:e.value;if(n){await d('Delete wheel profile "'.concat(n,'"?'),p.CONFIRM)&&(!function(e){if(delete C.profiles[e],C.currentProfile===e){const e=O();C.currentProfile=e[0]||"default"}o()}(n),pn())}}));const a=document.getElementById("mazemaster_export_btn");a&&a.addEventListener("click",(()=>{var e;const n=null===(e=document.getElementById("mazemaster_profile_select"))||void 0===e?void 0:e.value;n?function(e){const n=D(e);if(!n)return void alert('Profile "'.concat(e,'" not found'));const t={name:e,profile:n,exportedAt:(new Date).toISOString(),version:"1.0"},a=JSON.stringify(t,null,2),o=new Blob([a],{type:"application/json"}),i=URL.createObjectURL(o),s=document.createElement("a");s.href=i,s.download="mazemaster-".concat(e,".json"),document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(i),console.log('[MazeMaster] Exported profile "'.concat(e,'"'))}(n):alert("No profile selected to export")}));const i=document.getElementById("mazemaster_import_btn"),s=document.getElementById("mazemaster_import_file");i&&s&&(i.addEventListener("click",(()=>{s.click()})),s.addEventListener("change",(async e=>{var n;const t=null===(n=e.target.files)||void 0===n?void 0:n[0];if(t){try{const e=await function(e){return new Promise(((n,t)=>{const a=new FileReader;a.onload=e=>{try{const a=JSON.parse(e.target.result);if(!a.profile||!a.name)return void t(new Error("Invalid profile format: missing name or profile data"));let i=a.name;if(C.profiles[i]){const e=prompt('Profile "'.concat(i,'" already exists. Enter a new name:'),"".concat(i,"_imported"));if(!e||!e.trim())return void t(new Error("Import cancelled"));i=e.trim()}const s=a.profile;s.segments&&Array.isArray(s.segments)||(s.segments=[]),"boolean"!=typeof s.randomize&&(s.randomize=!1),("number"!=typeof s.difficulty||s.difficulty<1||s.difficulty>5)&&(s.difficulty=1),C.profiles[i]=s,C.currentProfile=i,o(),console.log('[MazeMaster] Imported profile "'.concat(i,'":'),s),n(i)}catch(e){t(new Error("Failed to parse JSON: ".concat(e.message)))}},a.onerror=()=>t(new Error("Failed to read file")),a.readAsText(e)}))}(t);alert('Profile "'.concat(e,'" imported successfully!')),pn()}catch(e){alert("Import failed: ".concat(e.message))}s.value=""}})));const r=document.getElementById("mazemaster_add_segment_btn");r&&r.addEventListener("click",(()=>{const e=document.getElementById("mazemaster_segments_list");if(!e)return;const n=e.querySelector(".mazemaster-empty-state");n&&n.remove();const t=e.querySelectorAll(".mazemaster-segment-item").length,a=document.createElement("div");a.className="mazemaster-segment-item",a.dataset.index=t,a.innerHTML='\n                <div class="mazemaster-segment-row">\n                    <div class="mazemaster-segment-field small">\n                        <label>Trigger</label>\n                        <input type="text" class="seg-trigger" value="com'.concat(t+1,'" placeholder="com1">\n                    </div>\n                    <div class="mazemaster-segment-field">\n                        <label>Display Text</label>\n                        <input type="text" class="seg-text" value="" placeholder="Prize name">\n                    </div>\n                    <div class="mazemaster-segment-field small">\n                        <label>Size</label>\n                        <select class="seg-size">\n                            ').concat(h.map((e=>'<option value="'.concat(e,'" ').concat("fraction"===e?"selected":"",">").concat(e,"</option>"))).join(""),'\n                        </select>\n                    </div>\n                    <button class="menu_button menu_button_icon mazemaster-segment-delete" title="Delete">\n                        <i class="fa-solid fa-trash"></i>\n                    </button>\n                </div>\n                <div class="mazemaster-segment-row">\n                    <div class="mazemaster-segment-field">\n                        <label>STScript Command</label>\n                        <textarea class="seg-command" placeholder="/echo You won!"></textarea>\n                    </div>\n                    <div class="mazemaster-segment-field tiny">\n                        <label>&nbsp;</label>\n                        <label class="mazemaster-segment-checkbox">\n                            <input type="checkbox" class="seg-respin">\n                            Respin\n                        </label>\n                    </div>\n                </div>\n            '),a.querySelector(".mazemaster-segment-delete").addEventListener("click",(()=>{a.remove()})),e.appendChild(a)}));const l=document.getElementById("mazemaster_save_btn");l&&l.addEventListener("click",(()=>{var e,n,t;const a=null===(e=document.getElementById("mazemaster_profile_select"))||void 0===e?void 0:e.value;if(!a)return void alert("Please create a profile first");const i=function(){const e=document.querySelectorAll(".mazemaster-segment-item"),n=[];return e.forEach((e=>{const t=e.querySelector(".seg-trigger").value.trim(),a=e.querySelector(".seg-text").value.trim(),o=e.querySelector(".seg-command").value.trim(),i=e.querySelector(".seg-size").value,s=e.querySelector(".seg-respin").checked;(t||a)&&n.push({trigger:t,text:a,command:o,size:i,respin:s})})),n}(),s=(null===(n=document.getElementById("mazemaster_randomize"))||void 0===n?void 0:n.checked)||!1,r=parseInt(null===(t=document.getElementById("mazemaster_difficulty"))||void 0===t?void 0:t.value)||1;!function(e,n){let t=arguments.length>2&&void 0!==arguments[2]&&arguments[2],a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;C.profiles[e]={segments:n,randomize:t,difficulty:a},o(),console.log("[MazeMaster] Profile saved:",e,C.profiles[e])}(a,i,s,r),console.log('[MazeMaster] Saved profile "'.concat(a,'":'),{segments:i,randomize:s,difficulty:r}),alert('Profile "'.concat(a,'" saved!'))}));const m=document.getElementById("mazemaster_show_wheel"),u=document.getElementById("mazemaster_show_battlebar"),b=document.getElementById("mazemaster_show_maze"),f=document.getElementById("mazemaster_show_minions"),v=document.getElementById("mazemaster_show_traps"),z=document.getElementById("mazemaster_wheel_config"),y=document.getElementById("mazemaster_battlebar_config"),_=document.getElementById("mazemaster_maze_config"),x=document.getElementById("mazemaster_minions_config"),w=document.getElementById("mazemaster_traps_config");function E(e){C.activeGameConfig=e,o(),null==m||m.classList.toggle("active","wheel"===e),null==u||u.classList.toggle("active","battlebar"===e),null==b||b.classList.toggle("active","maze"===e),null==f||f.classList.toggle("active","minions"===e),null==v||v.classList.toggle("active","traps"===e),z&&(z.style.display="wheel"===e?"block":"none"),y&&(y.style.display="battlebar"===e?"block":"none"),_&&(_.style.display="maze"===e?"block":"none"),x&&(x.style.display="minions"===e?"block":"none"),w&&(w.style.display="traps"===e?"block":"none"),"battlebar"===e&&$e(),"minions"===e&&an(),"traps"===e&&on()}m&&m.addEventListener("click",(()=>E("wheel"))),u&&u.addEventListener("click",(()=>E("battlebar"))),b&&b.addEventListener("click",(()=>E("maze"))),f&&f.addEventListener("click",(()=>E("minions"))),v&&v.addEventListener("click",(()=>E("traps")));const M=document.querySelectorAll(".mazemaster-tab"),I=document.querySelectorAll(".mazemaster-tab-content");M.forEach((e=>{e.addEventListener("click",(()=>{const n=e.dataset.tab;M.forEach((n=>n.classList.toggle("active",n===e))),I.forEach((e=>{const t=e.id==="mazemaster-tab-".concat(n);e.classList.toggle("active",t)}))}))}));const k=document.getElementById("mazemaster_play_maze");k&&k.addEventListener("click",(()=>{const e=document.getElementById("mazemaster_play_profile");we((null==e?void 0:e.value)||C.currentMazeProfile||"default")})),function(){const e=document.getElementById("mazemaster_llm_preset");if(e){e.innerHTML='<option value="">(Use Current)</option>';try{if("function"==typeof g){const n=g();if(n&&"function"==typeof n.getAllPresets){const t=n.getAllPresets();t.forEach((n=>{const t=document.createElement("option");t.value=n,t.textContent=n,n===C.llmPreset&&(t.selected=!0),e.appendChild(t)})),console.log("[MazeMaster] Populated LLM preset dropdown with ".concat(t.length," presets"))}}}catch(e){console.warn("[MazeMaster] Could not populate LLM presets:",e)}}}();const S=document.getElementById("mazemaster_llm_preset");S&&S.addEventListener("change",(e=>{C.llmPreset=e.target.value,o()}));const P=document.getElementById("mazemaster_llm_enabled");P&&P.addEventListener("change",(e=>{C.llmEnabled=e.target.checked,o()}));const B=document.getElementById("mazemaster_bb_profile_select");B&&B.addEventListener("change",(e=>{C.currentBattlebarProfile=e.target.value,o(),function(){var e;const n=A(null===(e=document.getElementById("mazemaster_bb_profile_select"))||void 0===e?void 0:e.value)||{},t=document.getElementById("mazemaster_bb_difficulty");t&&(t.value=n.difficulty||3);const a=document.getElementById("mazemaster_bb_hits");a&&(a.value=n.hitsToWin||5);const o=document.getElementById("mazemaster_bb_misses");o&&(o.value=n.missesToLose||3);const i=document.getElementById("mazemaster_bb_hit_cmd");i&&(i.value=n.hitCommand||"");const s=document.getElementById("mazemaster_bb_miss_cmd");s&&(s.value=n.missCommand||"");const r=document.getElementById("mazemaster_bb_win_cmd");r&&(r.value=n.winCommand||"");const l=document.getElementById("mazemaster_bb_lose_cmd");l&&(l.value=n.loseCommand||"");const m=document.getElementById("mazemaster_bb_main_title");m&&(m.value=n.mainTitle||"")}(),$e()}));const T=document.getElementById("mazemaster_bb_new_profile_btn");T&&T.addEventListener("click",(async e=>{e.preventDefault(),e.stopPropagation();const n=await d("Enter new battlebar profile name:",p.INPUT,"");if(n&&n.trim()){const e=n.trim();C.battlebarProfiles[e]?await d('Battlebar profile "'.concat(e,'" already exists.'),p.TEXT):(j(e,{}),C.currentBattlebarProfile=e,o(),pn(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_battlebar"))||void 0===e||e.click()}),100))}}));const L=document.getElementById("mazemaster_bb_delete_profile_btn");L&&L.addEventListener("click",(async()=>{var e;const n=null===(e=document.getElementById("mazemaster_bb_profile_select"))||void 0===e?void 0:e.value;if(n){await d('Delete battlebar profile "'.concat(n,'"?'),p.CONFIRM)&&(!function(e){if(delete C.battlebarProfiles[e],C.currentBattlebarProfile===e){const e=N();C.currentBattlebarProfile=e[0]||"default"}o()}(n),pn(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_battlebar"))||void 0===e||e.click()}),100))}}));const W=document.getElementById("mazemaster_bb_export_btn");W&&W.addEventListener("click",(()=>{var e;const n=null===(e=document.getElementById("mazemaster_bb_profile_select"))||void 0===e?void 0:e.value;n?function(e){const n=A(e);if(!n)return void alert('Battlebar profile "'.concat(e,'" not found'));const t={name:e,type:"battlebar",profile:n,exportedAt:(new Date).toISOString(),version:"1.0"},a=JSON.stringify(t,null,2),o=new Blob([a],{type:"application/json"}),i=URL.createObjectURL(o),s=document.createElement("a");s.href=i,s.download="mazemaster-battlebar-".concat(e,".json"),document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(i),console.log('[MazeMaster] Exported battlebar profile "'.concat(e,'"'))}(n):alert("No profile selected to export")}));const G=document.getElementById("mazemaster_bb_import_btn"),V=document.getElementById("mazemaster_bb_import_file");G&&V&&(G.addEventListener("click",(()=>{V.click()})),V.addEventListener("change",(async e=>{var n;const t=null===(n=e.target.files)||void 0===n?void 0:n[0];if(t){try{var a;const e=await function(e){return new Promise(((n,t)=>{const a=new FileReader;a.onload=e=>{try{const a=JSON.parse(e.target.result);if(!a.profile||!a.name)return void t(new Error("Invalid profile format: missing name or profile data"));let i=a.name;if(C.battlebarProfiles[i]){const e=prompt('Battlebar profile "'.concat(i,'" already exists. Enter a new name:'),"".concat(i,"_imported"));if(!e||!e.trim())return void t(new Error("Import cancelled"));i=e.trim()}j(i,a.profile),C.currentBattlebarProfile=i,o(),console.log('[MazeMaster] Imported battlebar profile "'.concat(i,'":'),a.profile),n(i)}catch(e){t(new Error("Failed to parse JSON: ".concat(e.message)))}},a.onerror=()=>t(new Error("Failed to read file")),a.readAsText(e)}))}(t);alert('Battlebar profile "'.concat(e,'" imported successfully!')),pn(),null===(a=document.getElementById("mazemaster_show_battlebar"))||void 0===a||a.click()}catch(e){alert("Import failed: ".concat(e.message))}V.value=""}})));const K=document.getElementById("mazemaster_bb_save_btn");K&&K.addEventListener("click",(()=>{var e;const n=null===(e=document.getElementById("mazemaster_bb_profile_select"))||void 0===e?void 0:e.value;if(!n)return void alert("Please create a battlebar profile first");j(n,function(){var e,n,t,a,o,i,s,r,l,m,c,d,p,u,g;const b=A(null===(e=document.getElementById("mazemaster_bb_profile_select"))||void 0===e?void 0:e.value)||{};return{difficulty:parseInt(null===(n=document.getElementById("mazemaster_bb_difficulty"))||void 0===n?void 0:n.value)||3,hitsToWin:parseInt(null===(t=document.getElementById("mazemaster_bb_hits"))||void 0===t?void 0:t.value)||5,missesToLose:parseInt(null===(a=document.getElementById("mazemaster_bb_misses"))||void 0===a?void 0:a.value)||3,mainTitle:(null===(o=document.getElementById("mazemaster_bb_main_title"))||void 0===o?void 0:o.value)||"",hitCommand:(null===(i=document.getElementById("mazemaster_bb_hit_cmd"))||void 0===i?void 0:i.value)||"",missCommand:(null===(s=document.getElementById("mazemaster_bb_miss_cmd"))||void 0===s?void 0:s.value)||"",winCommand:(null===(r=document.getElementById("mazemaster_bb_win_cmd"))||void 0===r?void 0:r.value)||"",loseCommand:(null===(l=document.getElementById("mazemaster_bb_lose_cmd"))||void 0===l?void 0:l.value)||"",images:b.images||[],keyDropChance:null!==(m=parseInt(null===(c=document.getElementById("mazemaster_bb_key_drop"))||void 0===c?void 0:c.value))&&void 0!==m?m:40,powDropChance:null!==(d=parseInt(null===(p=document.getElementById("mazemaster_bb_pow_drop"))||void 0===p?void 0:p.value))&&void 0!==d?d:20,stealthDropChance:null!==(u=parseInt(null===(g=document.getElementById("mazemaster_bb_stealth_drop"))||void 0===g?void 0:g.value))&&void 0!==u?u:10}}()),alert('Battlebar profile "'.concat(n,'" saved!'))}));const X=document.getElementById("mazemaster_bb_add_image_btn"),Q=document.getElementById("mazemaster_bb_image_file");X&&Q&&(X.addEventListener("click",(()=>{Q.click()})),Q.addEventListener("change",(async e=>{var n,t;const a=null===(n=e.target.files)||void 0===n?void 0:n[0];if(!a)return;const o=null===(t=document.getElementById("mazemaster_bb_profile_select"))||void 0===t?void 0:t.value;if(!o)return alert("Please create a profile first"),void(Q.value="");try{const e=await async function(e,n){return new Promise(((t,a)=>{const o=new FileReader;o.onload=async o=>{try{const i=o.target.result.split(",")[1],s=e.name.split(".").pop().toLowerCase(),r=Date.now(),l="battlebar_".concat(n,"_").concat(r),m=await fetch("/api/images/upload",{method:"POST",headers:c(),body:JSON.stringify({image:i,ch_name:"MazeMaster",filename:l,format:s})});if(m.ok)t("user/images/MazeMaster/".concat(l,".").concat(s));else{const e=await m.json().catch((()=>({})));a(new Error(e.error||"Upload failed"))}}catch(e){a(e)}},o.onerror=()=>a(new Error("Failed to read file")),o.readAsDataURL(e)}))}(a,o),n=A(o)||{},t=n.images||[];t.push({path:e,name:a.name}),n.images=t,j(o,n),$e()}catch(e){alert("Image upload failed: ".concat(e.message))}Q.value=""})));const Z=document.getElementById("mazemaster_maze_profile_select");Z&&Z.addEventListener("change",(e=>{C.currentMazeProfile=e.target.value,o(),en()}));const $=document.getElementById("mazemaster_maze_new_profile_btn");$&&$.addEventListener("click",(async e=>{e.preventDefault(),e.stopPropagation();const n=await d("Enter new maze profile name:",p.INPUT,"");if(n&&n.trim()){const e=n.trim();C.mazeProfiles[e]?await d('Maze profile "'.concat(e,'" already exists.'),p.TEXT):(H(e,{gridSize:10}),C.currentMazeProfile=e,o(),pn(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_maze"))||void 0===e||e.click()}),100))}}));const ee=document.getElementById("mazemaster_maze_delete_profile_btn");ee&&ee.addEventListener("click",(async()=>{var e;const n=null===(e=document.getElementById("mazemaster_maze_profile_select"))||void 0===e?void 0:e.value;if(n){await d('Delete maze profile "'.concat(n,'"?'),p.CONFIRM)&&(!function(e){if(delete C.mazeProfiles[e],C.currentMazeProfile===e){const e=R();C.currentMazeProfile=e[0]||"default"}o()}(n),pn(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_maze"))||void 0===e||e.click()}),100))}}));const ne=document.getElementById("mazemaster_maze_save_btn");ne&&ne.addEventListener("click",(()=>{var e;const n=null===(e=document.getElementById("mazemaster_maze_profile_select"))||void 0===e?void 0:e.value;if(!n)return void alert("Please create a maze profile first");H(n,function(){var e,n,t,a,o,i,s,r,l,m,c,d,p,u,g,b,f,v,h,z,y,_,x,w,E,M,I,k,C,S;const P=q(null===(e=document.getElementById("mazemaster_maze_profile_select"))||void 0===e?void 0:e.value)||{},B=document.querySelectorAll("#mazemaster_maze_encounters_list .mazemaster-encounter-row"),T=[];B.forEach((e=>{var n,t;const a=null===(n=e.querySelector(".encounter-minion-select"))||void 0===n?void 0:n.value,o=parseInt(null===(t=e.querySelector(".encounter-percent-input"))||void 0===t?void 0:t.value)||5;a&&T.push({minionId:a,percent:o})}));const L=document.querySelectorAll("#mazemaster_maze_traps_list .mazemaster-trap-encounter-row"),O=[];L.forEach((e=>{var n,t;const a=null===(n=e.querySelector(".trap-encounter-select"))||void 0===n?void 0:n.value,o=parseInt(null===(t=e.querySelector(".trap-encounter-percent-input"))||void 0===t?void 0:t.value)||5;a&&O.push({trapId:a,percent:o})}));const D=((null===(n=document.getElementById("mazemaster_maze_random_messages"))||void 0===n?void 0:n.value)||"").split("\n").filter((e=>e.trim()));return{gridSize:parseInt(null===(t=document.getElementById("mazemaster_maze_size"))||void 0===t?void 0:t.value)||10,winCommand:(null===(a=document.getElementById("mazemaster_maze_win_cmd"))||void 0===a?void 0:a.value)||"",loseCommand:(null===(o=document.getElementById("mazemaster_maze_lose_cmd"))||void 0===o?void 0:o.value)||"",winMessage:(null===(i=document.getElementById("mazemaster_maze_win_message"))||void 0===i?void 0:i.value)||"",winImage:P.winImage||"",mainMinion:(null===(s=document.getElementById("mazemaster_maze_main_minion"))||void 0===s?void 0:s.value)||"",mainMinionIntroMessage:(null===(r=document.getElementById("mazemaster_maze_intro_message"))||void 0===r?void 0:r.value)||"",mainMinionRandomChance:parseInt(null===(l=document.getElementById("mazemaster_maze_random_chance"))||void 0===l?void 0:l.value)||15,mainMinionRandomMessages:D,mainMinionExitType:(null===(m=document.getElementById("mazemaster_maze_exit_type"))||void 0===m?void 0:m.value)||"messenger",mainMinionExitProfile:(null===(c=document.getElementById("mazemaster_maze_exit_profile"))||void 0===c?void 0:c.value)||"",minionEncounters:T,trapEncounters:O,onBattlebarLoss:(null===(d=document.getElementById("mazemaster_maze_loss_action"))||void 0===d?void 0:d.value)||"continue",chestTilePercent:parseInt(null===(p=document.getElementById("mazemaster_maze_chest_percent"))||void 0===p?void 0:p.value)||10,chestLockedPercent:parseInt(null===(u=document.getElementById("mazemaster_maze_locked_percent"))||void 0===u?void 0:u.value)||30,chestLockedBonusPercent:parseInt(null===(g=document.getElementById("mazemaster_maze_locked_bonus"))||void 0===g?void 0:g.value)||50,chestMimicPercent:parseInt(null===(b=document.getElementById("mazemaster_maze_mimic_percent"))||void 0===b?void 0:b.value)||15,chestLootMin:parseInt(null===(f=document.getElementById("mazemaster_maze_loot_min"))||void 0===f?void 0:f.value)||1,chestLootMax:parseInt(null===(v=document.getElementById("mazemaster_maze_loot_max"))||void 0===v?void 0:v.value)||2,chestKeyChance:parseInt(null===(h=document.getElementById("mazemaster_maze_chest_key"))||void 0===h?void 0:h.value)||30,chestPowChance:parseInt(null===(z=document.getElementById("mazemaster_maze_chest_pow"))||void 0===z?void 0:z.value)||50,chestStealthChance:parseInt(null===(y=document.getElementById("mazemaster_maze_chest_stealth"))||void 0===y?void 0:y.value)||0,chestGrandpowChance:parseInt(null===(_=document.getElementById("mazemaster_maze_chest_grandpow"))||void 0===_?void 0:_.value)||0,lockedChestKeyChance:parseInt(null===(x=document.getElementById("mazemaster_maze_locked_key"))||void 0===x?void 0:x.value)||40,lockedChestPowChance:parseInt(null===(w=document.getElementById("mazemaster_maze_locked_pow"))||void 0===w?void 0:w.value)||60,lockedChestStealthChance:parseInt(null===(E=document.getElementById("mazemaster_maze_locked_stealth"))||void 0===E?void 0:E.value)||30,lockedChestGrandpowChance:parseInt(null===(M=document.getElementById("mazemaster_maze_locked_grandpow"))||void 0===M?void 0:M.value)||5,startingInventory:{key:parseInt(null===(I=document.getElementById("mazemaster_start_key"))||void 0===I?void 0:I.value)||0,pow:parseInt(null===(k=document.getElementById("mazemaster_start_pow"))||void 0===k?void 0:k.value)||0,stealth:parseInt(null===(C=document.getElementById("mazemaster_start_stealth"))||void 0===C?void 0:C.value)||0,grandpow:parseInt(null===(S=document.getElementById("mazemaster_start_grandpow"))||void 0===S?void 0:S.value)||0},storyConfig:P.storyConfig||{mainStory:"",milestones:[]}}}()),alert('Maze profile "'.concat(n,'" saved!'))}));const te=document.getElementById("mazemaster_maze_story_btn");te&&te.addEventListener("click",(()=>{!async function(){var e,n,t,a;const o=null===(e=document.getElementById("mazemaster_maze_profile_select"))||void 0===e?void 0:e.value;if(!o)return void alert("Please create a maze profile first");const i=q(o)||{},s=i.storyConfig||{mainStory:"",milestones:[]},r='\n        <div id="mazemaster_story_modal" class="mazemaster-story-modal">\n            <div class="mazemaster-story-modal-content">\n                <h3><i class="fa-solid fa-book"></i> Story Milestones</h3>\n\n                <div class="mazemaster-section">\n                    <label class="mazemaster-label">Main Story</label>\n                    <textarea id="story_main_text" class="mazemaster-story-textarea" rows="4"\n                        placeholder="The maze stretches before you, filled with danger and mystery...">'.concat(Ze(s.mainStory||""),'</textarea>\n                </div>\n\n                <div class="mazemaster-section">\n                    <label class="mazemaster-label">Milestones</label>\n                    <div id="story_milestones_list" class="mazemaster-milestones-list">\n                        \x3c!-- Milestones rendered here --\x3e\n                    </div>\n                    <button id="story_add_milestone_btn" class="menu_button mazemaster-add-btn">\n                        <i class="fa-solid fa-plus"></i> Add Milestone\n                    </button>\n                </div>\n\n                <div class="mazemaster-story-modal-buttons">\n                    <button id="story_save_btn" class="menu_button menu_button_primary">\n                        <i class="fa-solid fa-save"></i> Save\n                    </button>\n                    <button id="story_cancel_btn" class="menu_button">\n                        Cancel\n                    </button>\n                </div>\n            </div>\n        </div>\n    '),l=document.createElement("div");l.innerHTML=r,document.body.appendChild(l.firstElementChild);const m=document.getElementById("mazemaster_story_modal"),c=document.getElementById("story_milestones_list");function d(){0!==s.milestones.length?(c.innerHTML=s.milestones.map(((e,n)=>'\n            <div class="mazemaster-milestone-row" data-index="'.concat(n,'">\n                <div class="milestone-percent">\n                    <input type="number" class="milestone-percent-input" min="1" max="99" value="').concat(e.percent||25,'" placeholder="%">\n                    <span>%</span>\n                </div>\n                <textarea class="milestone-text-input" rows="2" placeholder="Story update at this point...">').concat(Ze(e.storyUpdate||""),'</textarea>\n                <button class="menu_button menu_button_icon milestone-remove-btn" title="Remove">\n                    <i class="fa-solid fa-trash"></i>\n                </button>\n            </div>\n        '))).join(""),c.querySelectorAll(".milestone-remove-btn").forEach((e=>{e.addEventListener("click",(e=>{const n=e.target.closest(".mazemaster-milestone-row"),t=parseInt(n.dataset.index);s.milestones.splice(t,1),d()}))}))):c.innerHTML='<div class="mazemaster-empty-state">No milestones. Add milestones to show story updates at specific progress points.</div>'}d(),null===(n=document.getElementById("story_add_milestone_btn"))||void 0===n||n.addEventListener("click",(()=>{s.milestones.push({percent:50,storyUpdate:""}),d()})),null===(t=document.getElementById("story_save_btn"))||void 0===t||t.addEventListener("click",(()=>{var e;s.mainStory=(null===(e=document.getElementById("story_main_text"))||void 0===e?void 0:e.value)||"";const n=c.querySelectorAll(".mazemaster-milestone-row");s.milestones=[],n.forEach((e=>{var n,t;const a=parseInt(null===(n=e.querySelector(".milestone-percent-input"))||void 0===n?void 0:n.value)||25,o=(null===(t=e.querySelector(".milestone-text-input"))||void 0===t?void 0:t.value)||"";o.trim()&&s.milestones.push({percent:a,storyUpdate:o})})),s.milestones.sort(((e,n)=>e.percent-n.percent)),i.storyConfig=s,H(o,i),m.remove(),alert("Story milestones saved!")})),null===(a=document.getElementById("story_cancel_btn"))||void 0===a||a.addEventListener("click",(()=>{m.remove()})),m.addEventListener("click",(e=>{e.target===m&&m.remove()}))}()})),document.querySelectorAll(".mazemaster-collapsible-header").forEach((e=>{e.addEventListener("click",(()=>{const n=e.getAttribute("data-target"),t=document.getElementById(n),a=e.closest(".mazemaster-collapsible");if(t){const e="none"!==t.style.display;t.style.display=e?"none":"block",null==a||a.classList.toggle("expanded",!e)}}))})),cn();const ae=document.getElementById("mazemaster_intelligent_distribute");ae&&ae.addEventListener("click",rn);const oe=document.getElementById("mazemaster_maze_win_image_btn"),ie=document.getElementById("mazemaster_maze_win_image_file");oe&&ie&&(oe.addEventListener("click",(()=>{ie.click()})),ie.addEventListener("change",(async e=>{var n,t;const a=null===(n=e.target.files)||void 0===n?void 0:n[0];if(!a)return;const o=null===(t=document.getElementById("mazemaster_maze_profile_select"))||void 0===t?void 0:t.value;if(!o)return alert("Please create a profile first"),void(ie.value="");try{const e=await tn(a,"maze_win_".concat(o)),n=q(o)||{};n.winImage=e,H(o,n);const t=document.querySelector(".mazemaster-maze-win-image-preview");t&&(t.innerHTML='<img id="maze_win_image_preview" src="'.concat(e,'" alt="Victory">'))}catch(e){alert("Image upload failed: ".concat(e.message))}ie.value=""})));const se=document.getElementById("mazemaster_maze_main_minion");se&&se.addEventListener("change",(e=>{const n=document.getElementById("mazemaster_main_minion_settings");n&&(n.style.display=e.target.value?"":"none")}));const re=document.getElementById("mazemaster_maze_exit_type");re&&re.addEventListener("change",(()=>{nn(re.value,"")}));const le=document.getElementById("mazemaster_add_encounter_btn");le&&le.addEventListener("click",(()=>{const e=document.getElementById("mazemaster_maze_encounters_list");if(!e)return;const n=Object.keys(C.minions||{}).map((e=>{const n=C.minions[e];return'<option value="'.concat(e,'">').concat(n.name||e,"</option>")})).join(""),t=document.createElement("div");t.className="mazemaster-encounter-row",t.innerHTML='\n                <select class="encounter-minion-select">\n                    <option value="">Select Minion</option>\n                    '.concat(n,'\n                </select>\n                <input type="number" class="encounter-percent-input" min="1" max="100" value="5" placeholder="%">\n                <span class="encounter-percent-label">%</span>\n                <button class="encounter-remove-btn menu_button"><i class="fa-solid fa-trash"></i></button>\n            '),t.querySelector(".encounter-remove-btn").addEventListener("click",(()=>{t.remove()})),e.appendChild(t)}));const me=document.getElementById("mazemaster_add_trap_encounter_btn");me&&me.addEventListener("click",(()=>{const e=document.getElementById("mazemaster_maze_traps_list");if(!e)return;const n=Y().map((e=>{const n=U(e);return'<option value="'.concat(Ze(e),'">').concat(Ze((null==n?void 0:n.name)||e),"</option>")})).join("");if(!n)return void alert("No traps available. Create traps in the Traps tab first.");const t=document.createElement("div");t.className="mazemaster-encounter-row mazemaster-trap-encounter-row",t.innerHTML='\n                <select class="trap-encounter-select">\n                    <option value="">Select Trap</option>\n                    '.concat(n,'\n                </select>\n                <input type="number" class="trap-encounter-percent-input" min="1" max="100" value="5" placeholder="%">\n                <span class="encounter-percent-label">%</span>\n                <button class="trap-encounter-remove-btn menu_button"><i class="fa-solid fa-trash"></i></button>\n            '),t.querySelector(".trap-encounter-remove-btn").addEventListener("click",(()=>{t.remove()})),e.appendChild(t)}));const ce=document.getElementById("mazemaster_add_minion_btn"),de=document.getElementById("mazemaster_minion_image_file");ce&&de&&(ce.addEventListener("click",(()=>{de.click()})),de.addEventListener("change",(async e=>{var n;const t=null===(n=e.target.files)||void 0===n?void 0:n[0];if(t){try{const e="minion_".concat(Date.now()),n=await tn(t,e),a=await d("Enter minion name:",p.INPUT,"New Minion");a&&a.trim()&&(F(e,{name:a.trim(),imagePath:n}),an())}catch(e){alert("Image upload failed: ".concat(e.message))}de.value=""}})));const pe=document.getElementById("mazemaster_minion_profile_save_btn");pe&&pe.addEventListener("click",(async()=>{const e=await d("Enter profile name:",p.INPUT,"My Minions");if(e&&e.trim()){const n=e.trim();C.minionProfiles[n]=JSON.parse(JSON.stringify(C.minions||{})),o(),alert('Minion profile "'.concat(n,'" saved!')),pn(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_minions"))||void 0===e||e.click()}),100)}}));const ue=document.getElementById("mazemaster_minion_profile_load_btn");ue&&ue.addEventListener("click",(async()=>{const e=document.getElementById("mazemaster_minion_profile_select"),n=null==e?void 0:e.value;if(!n)return void alert("Select a profile to load");await d('Load minion profile "'.concat(n,'"? This will replace your current minions.'),p.CONFIRM)&&(C.minions=JSON.parse(JSON.stringify(C.minionProfiles[n]||{})),o(),an(),alert('Minion profile "'.concat(n,'" loaded!')))}));const ge=document.getElementById("mazemaster_minion_profile_delete_btn");ge&&ge.addEventListener("click",(async()=>{const e=document.getElementById("mazemaster_minion_profile_select"),n=null==e?void 0:e.value;if(!n)return void alert("Select a profile to delete");await d('Delete minion profile "'.concat(n,'"?'),p.CONFIRM)&&(delete C.minionProfiles[n],o(),pn(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_minions"))||void 0===e||e.click()}),100))}));const be=document.getElementById("mazemaster_add_trap_btn"),fe=document.getElementById("mazemaster_trap_image_file");be&&fe&&(be.addEventListener("click",(()=>{fe.click()})),fe.addEventListener("change",(async e=>{var n;const t=null===(n=e.target.files)||void 0===n?void 0:n[0];if(t){try{const e="trap_".concat(Date.now()),n=await tn(t,e),a=await d("Enter trap name:",p.INPUT,"New Trap");a&&a.trim()&&(J(e,{name:a.trim(),imagePath:n,message:"You triggered a trap!",script:""}),on())}catch(e){alert("Image upload failed: ".concat(e.message))}fe.value=""}})));const ve=document.getElementById("mazemaster_trap_profile_save_btn");ve&&ve.addEventListener("click",(async()=>{const e=await d("Enter profile name:",p.INPUT,"My Traps");if(e&&e.trim()){const n=e.trim();C.trapProfiles[n]=JSON.parse(JSON.stringify(C.traps||{})),o(),alert('Trap profile "'.concat(n,'" saved!')),pn(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_traps"))||void 0===e||e.click()}),100)}}));const he=document.getElementById("mazemaster_trap_profile_load_btn");he&&he.addEventListener("click",(async()=>{const e=document.getElementById("mazemaster_trap_profile_select"),n=null==e?void 0:e.value;if(!n)return void alert("Select a profile to load");await d('Load trap profile "'.concat(n,'"? This will replace your current traps.'),p.CONFIRM)&&(C.traps=JSON.parse(JSON.stringify(C.trapProfiles[n]||{})),o(),on(),alert('Trap profile "'.concat(n,'" loaded!')))}));const ze=document.getElementById("mazemaster_trap_profile_delete_btn");ze&&ze.addEventListener("click",(async()=>{const e=document.getElementById("mazemaster_trap_profile_select"),n=null==e?void 0:e.value;if(!n)return void alert("Select a profile to delete");await d('Delete trap profile "'.concat(n,'"?'),p.CONFIRM)&&(delete C.trapProfiles[n],o(),pn(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_traps"))||void 0===e||e.click()}),100))}))}function pn(){const e=document.getElementById("mazemaster_drawer");e&&(e.innerHTML=Xe(),dn(),Qe(),$e(),an(),on(),en())}async function un(e){if(L.has(e))return;if(e.classList.contains("streaming")||e.classList.contains("is-typing")||e.querySelector(".mes_text.streaming"))return;const n=e.querySelector(".mes_text .stle--content")||e.querySelector(".mes_text");if(!n)return;const t=n.textContent||"",a=/\{\{wheel:([^}]+)\}\}/gi,o=/\{\{battlebar:([^}]+)\}\}/gi,i=/\{\{maze:([^}]+)\}\}/gi,s=[],r=[],l=[];let m;for(;null!==(m=a.exec(t));)s.push({full:m[0],profile:m[1].trim()});for(;null!==(m=o.exec(t));)r.push({full:m[0],profile:m[1].trim()});for(;null!==(m=i.exec(t));)l.push({full:m[0],profile:m[1].trim()});if(0===s.length&&0===r.length&&0===l.length)return;L.add(e);const c=SillyTavern.getContext(),d=e.getAttribute("mesid");for(const n of s){console.log("[MazeMaster] Processing wheel macro: ".concat(n.full));if(!V(n.profile).error){K().valid&&Q()}const t="[ðŸŽ¡ Wheel: ".concat(n.profile,"]");if(c.chat&&null!==d){const a=parseInt(d);if(c.chat[a]){const o=c.chat[a].mes,i=o.replace(n.full,"").replace(/\s+/g," ").trim(),s=o.replace(n.full,t);c.chat[a].mes=i;const r=e.querySelector(".mes_text");r&&(r.innerHTML=s)}}}for(const n of r){console.log("[MazeMaster] Processing battlebar macro: ".concat(n.full)),ee(n.profile);const t="[âš”ï¸ Battlebar: ".concat(n.profile,"]");if(c.chat&&null!==d){const a=parseInt(d);if(c.chat[a]){const o=c.chat[a].mes,i=o.replace(n.full,"").replace(/\s+/g," ").trim(),s=o.replace(n.full,t);c.chat[a].mes=i;const r=e.querySelector(".mes_text");r&&(r.innerHTML=s)}}}for(const n of l){console.log("[MazeMaster] Processing maze macro: ".concat(n.full)),we(n.profile);const t="[ðŸ›ï¸ Maze: ".concat(n.profile,"]");if(c.chat&&null!==d){const a=parseInt(d);if(c.chat[a]){const o=c.chat[a].mes,i=o.replace(n.full,"").replace(/\s+/g," ").trim(),s=o.replace(n.full,t);c.chat[a].mes=i;const r=e.querySelector(".mes_text");r&&(r.innerHTML=s)}}}}function gn(){const e=SillyTavern.getContext();if(!e||!e.eventSource||!e.eventTypes)return console.warn("[MazeMaster] Context not ready for macro hooks, retrying..."),void setTimeout(gn,500);e.eventTypes.USER_MESSAGE_RENDERED&&e.eventSource.on(e.eventTypes.USER_MESSAGE_RENDERED,(e=>{setTimeout((()=>{const n=document.querySelector('#chat .mes[mesid="'.concat(e,'"]'));n&&un(n)}),500)})),e.eventTypes.CHARACTER_MESSAGE_RENDERED&&e.eventSource.on(e.eventTypes.CHARACTER_MESSAGE_RENDERED,(e=>{const n=function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;const a=document.querySelector('#chat .mes[mesid="'.concat(e,'"]'));if(!a)return;(a.classList.contains("streaming")||a.classList.contains("is-typing"))&&t<5?setTimeout((()=>n(t+1)),1e3):un(a)};setTimeout((()=>n()),500)})),console.log("[MazeMaster] Macro hooks registered")}!function(){const e=SillyTavern.getContext();e.extensionSettings[a]||(e.extensionSettings[a]=JSON.parse(JSON.stringify(y))),C=e.extensionSettings[a];for(const e in y)void 0===C[e]&&(C[e]=JSON.parse(JSON.stringify(y[e])));C.profiles||(C.profiles={}),C.battlebarProfiles||(C.battlebarProfiles={}),C.mazeProfiles||(C.mazeProfiles={}),C.minions||(C.minions={}),C.traps||(C.traps={}),C.savedMazes||(C.savedMazes={}),C.minionProfiles||(C.minionProfiles={}),C.trapProfiles||(C.trapProfiles={});let n=!1;for(const[e,t]of Object.entries(_))C.profiles[e]||(C.profiles[e]=JSON.parse(JSON.stringify(t)),n=!0,console.log("[MazeMaster] Added default wheel profile: ".concat(e)));C.currentProfile||(C.currentProfile="Reward Wheel");for(const[e,t]of Object.entries(x))C.battlebarProfiles[e]||(C.battlebarProfiles[e]=JSON.parse(JSON.stringify(t)),n=!0,console.log("[MazeMaster] Added default battlebar profile: ".concat(e)));C.currentBattlebarProfile||(C.currentBattlebarProfile="Easy Fight");for(const[e,t]of Object.entries(w))C.minions[e]||(C.minions[e]=JSON.parse(JSON.stringify(t)),n=!0,console.log("[MazeMaster] Added default minion: ".concat(e)));for(const[e,t]of Object.entries(E))C.traps[e]||(C.traps[e]=JSON.parse(JSON.stringify(t)),n=!0,console.log("[MazeMaster] Added default trap: ".concat(e)));for(const[e,t]of Object.entries(M))C.minionProfiles[e]||(C.minionProfiles[e]=JSON.parse(JSON.stringify(t)),n=!0,console.log("[MazeMaster] Added default minion profile: ".concat(e)));for(const[e,t]of Object.entries(I))C.trapProfiles[e]||(C.trapProfiles[e]=JSON.parse(JSON.stringify(t)),n=!0,console.log("[MazeMaster] Added default trap profile: ".concat(e)));for(const[e,t]of Object.entries(k))if(C.mazeProfiles[e]){const a=C.mazeProfiles[e];for(const[o,i]of Object.entries(t))(void 0===a[o]||Array.isArray(a[o])&&0===a[o].length)&&i&&(!Array.isArray(i)||i.length>0)&&(a[o]=JSON.parse(JSON.stringify(i)),n=!0,console.log("[MazeMaster] Added missing/empty field '".concat(o,"' to maze profile: ").concat(e)))}else C.mazeProfiles[e]=JSON.parse(JSON.stringify(t)),n=!0,console.log("[MazeMaster] Added default maze profile: ".concat(e));C.currentMazeProfile||(C.currentMazeProfile="Dungeon Crawl"),n&&o(),console.log("[MazeMaster] Loaded settings:",C)}(),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",(()=>{sn(),$(),gn()})):(sn(),$(),gn()),console.log("[".concat(a,"] Extension loaded"))})();