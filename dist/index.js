(()=>{function e(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function t(t){for(var a=1;a<arguments.length;a++){var o=null!=arguments[a]?arguments[a]:{};a%2?e(Object(o),!0).forEach((function(e){n(t,e,o[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(o)):e(Object(o)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(o,e))}))}return t}function n(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var a=n.call(e,t||"default");if("object"!=typeof a)return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}const a="MazeMaster";let o=a;try{const e="file:///home/saintorphan/Projects/ST-Extensions/SillyTavern-MazeMaster/src/index.js".match(/\/scripts\/extensions\/third-party\/([^/]+)\//);e&&e[1]&&(o=e[1])}catch(e){const t=document.querySelectorAll('script[src*="MazeMaster"]');for(const e of t){const t=e.src.match(/\/scripts\/extensions\/third-party\/([^/]+)\//);if(t&&t[1]){o=t[1];break}}}const{saveSettingsDebounced:i,SlashCommandParser:s,SlashCommand:r,ARGUMENT_TYPE:l,SlashCommandNamedArgument:c,executeSlashCommandsWithOptions:m,getRequestHeaders:d,callGenericPopup:p,POPUP_TYPE:u,generateQuietPrompt:h,getPresetManager:g,mainApi:f}=SillyTavern.getContext(),v=["#e74c3c","#3498db","#2ecc71","#f39c12","#9b59b6","#1abc9c","#e67e22","#34495e","#e91e63","#00bcd4","#8bc34a","#ff5722"],b={fraction:1,halfseg:.5,doubleseg:2},y=["fraction","halfseg","doubleseg"],z={1:{zoneWidth:.4,traverseTime:3500},2:{zoneWidth:.32,traverseTime:3e3},3:{zoneWidth:.26,traverseTime:2500},4:{zoneWidth:.2,traverseTime:2e3},5:{zoneWidth:.15,traverseTime:1600}},x={easy:{name:"Easy",gridSizeRange:{min:5,max:10},encounterDensityMult:.7,trapFrequencyMult:.5,battlebarZoneMult:1.3,battlebarSpeedMult:.8,inventoryStartMult:1.5,minionAggressionMult:.5,chestLootMult:1.2},normal:{name:"Normal",gridSizeRange:{min:5,max:20},encounterDensityMult:1,trapFrequencyMult:1,battlebarZoneMult:1,battlebarSpeedMult:1,inventoryStartMult:1,minionAggressionMult:1,chestLootMult:1},hard:{name:"Hard",gridSizeRange:{min:8,max:20},encounterDensityMult:1.3,trapFrequencyMult:1.5,battlebarZoneMult:.8,battlebarSpeedMult:1.2,inventoryStartMult:.7,minionAggressionMult:1.5,chestLootMult:.8},nightmare:{name:"Nightmare",gridSizeRange:{min:10,max:20},encounterDensityMult:1.6,trapFrequencyMult:2,battlebarZoneMult:.6,battlebarSpeedMult:1.4,inventoryStartMult:.5,minionAggressionMult:2,chestLootMult:.6}},w={fantasy:{name:"Fantasy",tileMappings:{wall:"stone wall",floor:"dungeon floor",chest:"treasure chest",exit:"portal to freedom",portal:"mystic gateway",trap:"arcane trap",stairUp:"ascending staircase",stairDown:"descending staircase",minion:"creature"},itemAliases:{key:"Iron Key",stealth:"Cloak of Shadows",pow:"Battle Fury",grandpow:"Divine Wrath",floorKey:"Stairway Key",portalStone:"Portal Stone",minionBane:"Monster Bane",mapFragment:"Ancient Map",timeShard:"Time Crystal",voidWalk:"Ghost Step Potion"},flavorMessages:{chestFind:"You discover an ancient treasure chest!",portalUse:"The mystic gateway shimmers and pulls you through!",trapTrigger:"An arcane glyph activates beneath your feet!",stairUp:"You ascend the ancient staircase...",stairDown:"You descend into the depths below...",victory:"Glory! You have conquered the dungeon!",defeat:"The darkness claims another soul..."},colors:{primary:"#2ecc71",secondary:"#27ae60",accent:"#f1c40f"}},horror:{name:"Horror",tileMappings:{wall:"blood-stained wall",floor:"creaking floorboard",chest:"ominous coffin",exit:"escape route",portal:"dark rift",trap:"deadly snare",stairUp:"rickety ladder up",stairDown:"descending pit",minion:"abomination"},itemAliases:{key:"Rusty Key",stealth:"Shadow Shroud",pow:"Adrenaline Rush",grandpow:"Survival Instinct",floorKey:"Cellar Key",portalStone:"Dark Crystal",minionBane:"Banishment Charm",mapFragment:"Torn Note",timeShard:"Slowing Serum",voidWalk:"Phase Vial"},flavorMessages:{chestFind:"A decrepit coffin... dare you open it?",portalUse:"The rift tears open, pulling you into darkness!",trapTrigger:"You hear a click... then screaming.",stairUp:"The ladder groans under your weight...",stairDown:"You descend into the suffocating darkness...",victory:"You escape... but the nightmares will follow.",defeat:"Your screams echo eternally in the void..."},colors:{primary:"#c0392b",secondary:"#8e1b1b",accent:"#7f8c8d"}},scifi:{name:"Sci-Fi",tileMappings:{wall:"reinforced bulkhead",floor:"metal grating",chest:"supply crate",exit:"escape pod",portal:"warp gate",trap:"security system",stairUp:"elevator up",stairDown:"elevator down",minion:"hostile entity"},itemAliases:{key:"Access Card",stealth:"Cloaking Device",pow:"Combat Stim",grandpow:"Overdrive Module",floorKey:"Deck Keycard",portalStone:"Teleport Beacon",minionBane:"EMP Grenade",mapFragment:"Data Pad",timeShard:"Temporal Disruptor",voidWalk:"Phase Shifter"},flavorMessages:{chestFind:"A sealed supply crate. Contents unknown.",portalUse:"Warp gate activated. Brace for teleportation.",trapTrigger:"SECURITY ALERT: Hostile detected!",stairUp:"Elevator ascending to upper deck...",stairDown:"Elevator descending to lower deck...",victory:"Mission complete. Extraction successful.",defeat:"SYSTEM FAILURE: Life signs terminated."},colors:{primary:"#3498db",secondary:"#2980b9",accent:"#1abc9c"}},action:{name:"Action",tileMappings:{wall:"concrete barrier",floor:"worn tile",chest:"ammo crate",exit:"extraction point",portal:"fast rope insertion",trap:"booby trap",stairUp:"ladder up",stairDown:"ladder down",minion:"hostile"},itemAliases:{key:"Master Key",stealth:"Smoke Grenade",pow:"Adrenaline Shot",grandpow:"Air Strike",floorKey:"Building Key",portalStone:"Zip Line",minionBane:"Flashbang",mapFragment:"Intel Report",timeShard:"Slow-Mo Serum",voidWalk:"Breach Charge"},flavorMessages:{chestFind:"Supply cache located. Check for booby traps.",portalUse:"Moving to new position!",trapTrigger:"Contact! Hostile fire!",stairUp:"Moving up! Watch your six!",stairDown:"Descending! Stay frosty!",victory:"Area secured. Good work, soldier.",defeat:"Man down! Mission failed."},colors:{primary:"#e67e22",secondary:"#d35400",accent:"#95a5a6"}},cyberpunk:{name:"Cyberpunk",tileMappings:{wall:"neon-lit barrier",floor:"chrome plating",chest:"data cache",exit:"extraction node",portal:"netrunner jack",trap:"ICE protocol",stairUp:"mag-lift up",stairDown:"mag-lift down",minion:"cyborg"},itemAliases:{key:"Access Chip",stealth:"Optical Camo",pow:"Combat Stims",grandpow:"Berserker Mode",floorKey:"Elevator Override",portalStone:"Fast Travel Chip",minionBane:"System Crash",mapFragment:"Hacked Schematic",timeShard:"Reflex Booster",voidWalk:"Ghost Protocol"},flavorMessages:{chestFind:"Data cache detected. Initiating decrypt...",portalUse:"Jacking in... connection established.",trapTrigger:"ICE DETECTED! Countermeasures active!",stairUp:"Mag-lift ascending to upper level...",stairDown:"Mag-lift descending to sub-level...",victory:"Run complete. Payout received, choom.",defeat:"Flatlined. Your chrome belongs to the corp now."},colors:{primary:"#ff00ff",secondary:"#00ffff",accent:"#ffff00"}},noir:{name:"Noir",tileMappings:{wall:"rain-streaked wall",floor:"wet pavement",chest:"locked safe",exit:"back alley exit",portal:"secret passage",trap:"hidden wire",stairUp:"fire escape up",stairDown:"cellar stairs",minion:"goon"},itemAliases:{key:"Skeleton Key",stealth:"Trench Coat",pow:"Brass Knuckles",grandpow:"Tommy Gun",floorKey:"Service Key",portalStone:"Secret Map",minionBane:"Blackmail File",mapFragment:"Case Notes",timeShard:"Pocket Watch",voidWalk:"Shadow Step"},flavorMessages:{chestFind:"A safe in the shadows. Someone has secrets...",portalUse:"The bookcase slides aside, revealing a passage.",trapTrigger:"You hear a click. This was a setup.",stairUp:"The fire escape groans in the rain...",stairDown:"Down into the cellar. Watch your back.",victory:"Case closed. Time for a drink.",defeat:"Another gumshoe lost to the city..."},colors:{primary:"#4a4a4a",secondary:"#2c2c2c",accent:"#c9a227"}},postapoc:{name:"Post-Apocalyptic",tileMappings:{wall:"crumbling rubble",floor:"irradiated ground",chest:"salvage pile",exit:"safe zone",portal:"collapsed tunnel",trap:"radiation hotspot",stairUp:"rusted ladder up",stairDown:"crater descent",minion:"mutant"},itemAliases:{key:"Vault Keycard",stealth:"Ghillie Wrap",pow:"Rad-X Boost",grandpow:"Mini Nuke",floorKey:"Bunker Code",portalStone:"Signal Flare",minionBane:"Purifier",mapFragment:"Scavenged Map",timeShard:"Stasis Field",voidWalk:"Hazmat Suit"},flavorMessages:{chestFind:"A salvage cache from the old world...",portalUse:"You squeeze through the collapsed tunnel.",trapTrigger:"GEIGER SPIKE! Radiation flooding the area!",stairUp:"The rusted ladder holds... barely.",stairDown:"Descending into the crater...",victory:"You survived. For now.",defeat:"The wasteland claims another soul..."},colors:{primary:"#8b7355",secondary:"#556b2f",accent:"#cd853f"}},comedy:{name:"Comedy",tileMappings:{wall:"suspiciously normal wall",floor:"slightly sticky floor",chest:"mystery box",exit:"extremely obvious exit",portal:"plot hole",trap:"banana peel",stairUp:"escalator (broken)",stairDown:"slide",minion:"weirdo"},itemAliases:{key:"Comically Large Key",stealth:"Cardboard Box",pow:"Energy Drink",grandpow:"Power of Friendship",floorKey:"Janitor's Master Key",portalStone:"Plot Device",minionBane:"Bad Pun",mapFragment:"Napkin Drawing",timeShard:"Dramatic Pause",voidWalk:"Fourth Wall Break"},flavorMessages:{chestFind:"Ooh, a mystery box! It could be anything!",portalUse:"You fall through a plot hole!",trapTrigger:"Classic banana peel. You saw it coming.",stairUp:"The escalator is broken. Guess it's just stairs now.",stairDown:"WHEEE! *slide noises*",victory:"You win! The crowd goes mild!",defeat:"Wah wah wahhh... Game Over, buddy."},colors:{primary:"#ff6b6b",secondary:"#feca57",accent:"#48dbfb"}},western:{name:"Western",tileMappings:{wall:"wooden planks",floor:"dusty floorboards",chest:"strongbox",exit:"town limits",portal:"mine shaft",trap:"rattlesnake den",stairUp:"rickety stairs up",stairDown:"cellar hatch",minion:"outlaw"},itemAliases:{key:"Skeleton Key",stealth:"Poncho",pow:"Whiskey Courage",grandpow:"Dynamite Bundle",floorKey:"Mine Key",portalStone:"Treasure Map",minionBane:"Silver Bullet",mapFragment:"Wanted Poster",timeShard:"High Noon Focus",voidWalk:"Tumbleweed Roll"},flavorMessages:{chestFind:"A locked strongbox. Could be gold inside...",portalUse:"You duck into the old mine shaft.",trapTrigger:"RATTLESNAKES! Draw!",stairUp:"The stairs creak with every step...",stairDown:"Down into the root cellar...",victory:"You ride off into the sunset, partner.",defeat:"This town wasn't big enough for both of ya."},colors:{primary:"#d2691e",secondary:"#8b4513",accent:"#ffd700"}}},_={fantasy:{adjectives:["Ancient","Mystical","Enchanted","Arcane","Forgotten"]},horror:{adjectives:["Blood-Stained","Haunted","Cursed","Rotting","Whispering"]},scifi:{adjectives:["Automated","Sterile","Malfunctioning","Quarantined","Pressurized"]},action:{adjectives:["Reinforced","Tactical","Fortified","Hostile","Secured"]},cyberpunk:{adjectives:["Neon-Lit","Chrome","Glitched","Hacked","Blackmarket"]},noir:{adjectives:["Shadowy","Smoky","Rain-Soaked","Dimly-Lit","Forgotten"]},postapoc:{adjectives:["Ruined","Overgrown","Irradiated","Collapsed","Scavenged"]},comedy:{adjectives:["Suspiciously Normal","Slightly Damp","Questionable","Overdecorated","Poorly Labeled"]},western:{adjectives:["Dusty","Sun-Bleached","Weathered","Abandoned","Rickety"]}},S={maze:{common:{prefixes:["Winding","Narrow","Long","Dark","Quiet"],nouns:["Corridor","Passage","Hallway","Path","Tunnel"],descriptions:["The walls press in from both sides.","Echoes fade into the distance.","The path stretches onward."]},junction:{prefixes:["Central","Open","Connecting","Main"],nouns:["Junction","Crossroads","Intersection","Hub"],descriptions:["Multiple paths branch from here.","A decision point in the maze.","Which way to go?"]},deadend:{prefixes:["Sealed","Blocked","Empty","Forgotten"],nouns:["Dead End","Alcove","Nook","Corner"],descriptions:["No way forward from here.","A quiet corner of the maze.","Time to backtrack."]},staircase:{names:["The Spiral Path","Winding Stairs","The Descent","Stone Steps"],descriptions:["Worn steps lead to another level.","The stairway beckons."]},portal:{names:["Mystic Gateway","Shimmering Portal","The Threshold","Warp Point"],descriptions:["Reality bends here.","Step through to somewhere else."]},chest:{names:["Treasure Alcove","Hidden Cache","Fortune's Corner","The Vault"],descriptions:["Something valuable awaits.","A promising discovery."]},minion:{names:["Guardian's Post","The Confrontation","Danger Zone","Enemy Territory"],descriptions:["You sense a presence.","Something stirs ahead."]},trap:{names:["Treacherous Ground","The Snare","Danger Ahead","False Safety"],descriptions:["The floor seems unstable.","Something feels wrong here."]},exit:{names:["The Final Gate","Freedom's Door","The End","Escape Route"],descriptions:["The exit is within reach!","Almost there..."]},start:{names:["The Beginning","Starting Point","Entry Hall","The Origin"],descriptions:["Your journey begins here.","The entrance to the maze."]}},dungeon:{common:{prefixes:["Damp","Crumbling","Moss-Covered","Torch-Lit","Stone"],nouns:["Corridor","Passage","Chamber","Tunnel","Crypt"],descriptions:["Water drips from the ceiling.","Ancient stones line the walls.","The air is thick and musty."]},junction:{prefixes:["Grand","Central","Ruined","Pillared"],nouns:["Hall","Atrium","Chamber","Rotunda"],descriptions:["Pillars support the vaulted ceiling.","Several passages meet here."]},deadend:{prefixes:["Collapsed","Sealed","Empty","Forgotten"],nouns:["Tomb","Cell","Alcove","Crypt"],descriptions:["The way is blocked by rubble.","Nothing but bones and dust."]},staircase:{names:["The Spiral Descent","Stone Stairwell","Dungeon Steps","The Deep Stairs"],descriptions:["Worn steps descend into darkness.","Each step echoes ominously."]},portal:{names:["Arcane Circle","The Dark Rift","Summoning Chamber","Void Gate"],descriptions:["Strange runes glow on the floor.","The air crackles with energy."]},chest:{names:["Treasure Vault","Burial Cache","Hidden Hoard","Ancient Coffer"],descriptions:["Gold glimmers in the torchlight.","What treasures lie within?"]},minion:{names:["Guardian's Lair","The Beast's Den","Cursed Chamber","Haunted Hall"],descriptions:["Something lurks in the shadows.","Eyes watch from the darkness."]},trap:{names:["Pressure Plates","Spike Corridor","The Gauntlet","Death Trap"],descriptions:["The floor has suspicious tiles.","Previous adventurers weren't so lucky."]},exit:{names:["Dungeon Gate","Surface Access","The Way Out","Freedom's Light"],descriptions:["Daylight streams through ahead!","The exit awaits!"]},start:{names:["Dungeon Entrance","The First Chamber","Entry Vault","Beginning of the End"],descriptions:["You enter the dungeon depths.","Adventure awaits within."]}},city:{common:{prefixes:["Narrow","Crowded","Busy","Quiet","Back"],nouns:["Street","Alley","Lane","Road","Avenue"],descriptions:["Buildings tower on either side.","The city hums around you.","Footsteps echo on cobblestones."]},junction:{prefixes:["Main","Central","Open","Market"],nouns:["Square","Plaza","Intersection","Crossroads"],descriptions:["Several streets converge here.","A bustling urban hub."]},deadend:{prefixes:["Blocked","Private","Forgotten","Secluded"],nouns:["Courtyard","Dead End","Cul-de-sac","Alley"],descriptions:["No way through here.","A quiet corner of the city."]},staircase:{names:["Fire Escape","Metro Stairs","Building Access","Service Stairwell"],descriptions:["Metal stairs lead up or down.","An urban vertical passage."]},portal:{names:["Subway Entrance","Secret Door","Hidden Passage","Underground Access"],descriptions:["A way to move quickly.","Not everyone knows about this."]},chest:{names:["Supply Cache","Abandoned Stash","Hidden Storage","Drop Point"],descriptions:["Someone left supplies here.","Could be useful items inside."]},minion:{names:["Gang Territory","Hostile Zone","Ambush Point","Danger Zone"],descriptions:["This area isn't safe.","Watch your back."]},trap:{names:["Construction Zone","Hazard Area","Unstable Ground","Danger Zone"],descriptions:["Caution signs litter the area.","Something's not right here."]},exit:{names:["City Limits","The Way Out","Freedom Boulevard","Exit Gate"],descriptions:["Safety is just ahead!","Almost out of the city!"]},start:{names:["Downtown Drop","Starting Block","Entry Point","Ground Zero"],descriptions:["Your urban adventure begins.","The city awaits."]}},forest:{common:{prefixes:["Overgrown","Shaded","Winding","Mossy","Dense"],nouns:["Path","Trail","Grove","Thicket","Clearing"],descriptions:["Leaves rustle overhead.","Sunlight filters through the canopy.","The forest is alive with sounds."]},junction:{prefixes:["Central","Open","Sunny","Ancient"],nouns:["Clearing","Glade","Meadow","Crossroads"],descriptions:["Several paths diverge here.","A peaceful clearing in the woods."]},deadend:{prefixes:["Tangled","Blocked","Overgrown","Dense"],nouns:["Thicket","Dead End","Brush","Undergrowth"],descriptions:["The vegetation is too thick to pass.","No way through this tangle."]},staircase:{names:["Root Steps","Cliff Path","Tree Ladder","Natural Stairs"],descriptions:["Natural formations create a path up or down.","The terrain changes elevation."]},portal:{names:["Fairy Ring","Ancient Tree","Spirit Gate","Enchanted Grove"],descriptions:["Magic lingers in this place.","The veil between worlds is thin here."]},chest:{names:["Hollow Tree","Hidden Cache","Nature's Gift","Forest Bounty"],descriptions:["Something hidden among the roots.","The forest provides."]},minion:{names:["Beast's Territory","Predator's Ground","Wild Zone","Creature's Lair"],descriptions:["Something territorial lives here.","The wildlife seems hostile."]},trap:{names:["Quicksand","Poison Ivy Patch","Hunter's Snare","Treacherous Ground"],descriptions:["The ground looks unstable.","Nature can be dangerous."]},exit:{names:["Forest Edge","The Clearing","Open Fields","Way Out"],descriptions:["The tree line ends ahead!","Almost out of the forest!"]},start:{names:["Forest Entrance","Trail Head","Woods Edge","Into the Wild"],descriptions:["The forest path begins here.","Adventure awaits in the trees."]}},outpost:{common:{prefixes:["Dusty","Wooden","Fortified","Patrol","Guard"],nouns:["Walkway","Corridor","Passage","Path","Route"],descriptions:["Wooden planks creak underfoot.","The outpost feels hastily constructed.","Frontier life is rough."]},junction:{prefixes:["Central","Main","Command","Trading"],nouns:["Courtyard","Square","Hub","Plaza"],descriptions:["The heart of the outpost.","People gather here."]},deadend:{prefixes:["Storage","Private","Blocked","Abandoned"],nouns:["Corner","Area","Section","Alcove"],descriptions:["This area is off-limits.","Nothing to see here."]},staircase:{names:["Watchtower Ladder","Rampart Stairs","Cellar Access","Tower Steps"],descriptions:["Rough-hewn steps lead up or down.","A vertical route through the outpost."]},portal:{names:["Secret Tunnel","Escape Route","Hidden Exit","Underground Path"],descriptions:["A hidden way to move quickly.","Not on any official maps."]},chest:{names:["Supply Crate","Armory Cache","Provisions Store","Trade Goods"],descriptions:["Frontier supplies are valuable.","Someone stockpiled resources here."]},minion:{names:["Hostile Territory","Raider Camp","Enemy Ground","Danger Zone"],descriptions:["This area isn't friendly.","Hostiles have been spotted here."]},trap:{names:["Perimeter Defense","Booby Trap","Defensive Line","Warning Zone"],descriptions:["The outpost has defenses.","Watch where you step."]},exit:{names:["Main Gate","Frontier Exit","The Way Out","Open Plains"],descriptions:["The frontier awaits beyond!","Almost to safety!"]},start:{names:["Outpost Gate","Arrival Point","Entry Post","Checkpoint"],descriptions:["Welcome to the frontier.","Your mission begins here."]}},spacestation:{common:{prefixes:["Pressurized","Maintenance","Crew","Service","Transit"],nouns:["Corridor","Deck","Section","Tube","Passageway"],descriptions:["The hum of life support fills the air.","Zero-G handles line the walls.","Status lights blink in sequence."]},junction:{prefixes:["Central","Main","Command","Hub"],nouns:["Atrium","Nexus","Hub","Junction"],descriptions:["Multiple decks connect here.","The station's central point."]},deadend:{prefixes:["Sealed","Depressurized","Locked","Abandoned"],nouns:["Airlock","Module","Section","Bay"],descriptions:["This section is sealed off.","No access beyond this point."]},staircase:{names:["Deck Ladder","Gravity Lift","Access Tube","Inter-deck Transit"],descriptions:["Vertical transit between decks.","Watch your head in zero-G."]},portal:{names:["Teleport Pad","Warp Gate","Transit Pod","Instant Travel"],descriptions:["Advanced technology enables instant travel.","Step on the pad to teleport."]},chest:{names:["Supply Locker","Cargo Pod","Equipment Bay","Resource Cache"],descriptions:["Standard station supplies.","Emergency equipment stored here."]},minion:{names:["Hostile Sector","Quarantine Zone","Breach Area","Danger Zone"],descriptions:["Security protocols are active.","Something hostile is aboard."]},trap:{names:["Radiation Leak","Decompression Risk","Electrical Hazard","System Failure"],descriptions:["Warning lights flash urgently.","Safety systems are offline."]},exit:{names:["Escape Pod Bay","Extraction Point","Docking Ring","The Way Out"],descriptions:["Rescue is just ahead!","Almost to the escape pods!"]},start:{names:["Docking Bay","Arrival Deck","Entry Point","Station Access"],descriptions:["Welcome aboard the station.","Your mission begins here."]}},college:{common:{prefixes:["Main","Academic","Student","Faculty","Campus"],nouns:["Hallway","Corridor","Wing","Path","Walkway"],descriptions:["Lockers line the walls.","Motivational posters are everywhere.","The smell of cafeteria food lingers."]},junction:{prefixes:["Central","Main","Student","Campus"],nouns:["Quad","Commons","Atrium","Hub"],descriptions:["Students gather between classes.","The heart of campus life."]},deadend:{prefixes:["Maintenance","Staff Only","Locked","Private"],nouns:["Closet","Office","Room","Storage"],descriptions:["This area is restricted.","Faculty only beyond this point."]},staircase:{names:["Main Stairwell","Fire Stairs","Back Stairs","Service Access"],descriptions:["Standard institutional stairs.","Watch out for students rushing to class."]},portal:{names:["Secret Passage","Underground Tunnel","Maintenance Route","Shortcut"],descriptions:["Not on the official campus map.","Students pass down secret knowledge."]},chest:{names:["Lost and Found","Supply Closet","Locker","Hidden Stash"],descriptions:["Someone left something behind.","Might find something useful."]},minion:{names:["Bully Territory","Staff Patrol","Security Zone","No-Go Area"],descriptions:["Best to avoid this area.","Someone unfriendly is here."]},trap:{names:["Wet Floor","Construction Zone","Prank Setup","Hazard Area"],descriptions:["Watch your step.","Something seems off here."]},exit:{names:["Main Exit","Campus Gate","Front Doors","Freedom"],descriptions:["School's out!","Almost to freedom!"]},start:{names:["Main Entrance","Welcome Hall","Registration","Starting Point"],descriptions:["Welcome to campus.","Your academic adventure begins."]}},apartment:{common:{prefixes:["Narrow","Dimly-Lit","Carpeted","Quiet","Long"],nouns:["Hallway","Corridor","Landing","Passage","Floor"],descriptions:["Apartment doors line both sides.","The building is eerily quiet.","Fluorescent lights flicker."]},junction:{prefixes:["Main","Central","Elevator","Stair"],nouns:["Lobby","Landing","Foyer","Hub"],descriptions:["Multiple hallways branch from here.","The building's central area."]},deadend:{prefixes:["Locked","Private","Utility","Maintenance"],nouns:["Apartment","Room","Closet","Unit"],descriptions:["This unit is locked.","No access here."]},staircase:{names:["Fire Stairs","Main Stairwell","Back Stairs","Service Stairs"],descriptions:["Concrete steps echo with each footfall.","Standard apartment building stairs."]},portal:{names:["Dumbwaiter","Laundry Chute","Hidden Panel","Secret Room"],descriptions:["A hidden way through the building.","Not everyone knows about this."]},chest:{names:["Storage Unit","Abandoned Locker","Supply Closet","Hidden Cache"],descriptions:["Someone left something behind.","Might contain useful items."]},minion:{names:["Hostile Unit","Occupied Floor","Danger Zone","Unfriendly Neighbors"],descriptions:["Something unfriendly lives here.","Best to be careful."]},trap:{names:["Broken Floor","Electrical Hazard","Gas Leak","Structural Damage"],descriptions:["The building isn't safe here.","Watch your step."]},exit:{names:["Main Exit","Front Door","Fire Exit","Street Access"],descriptions:["The street is just ahead!","Almost out of the building!"]},start:{names:["Building Entrance","Main Lobby","Entry Hall","Ground Floor"],descriptions:["You enter the apartment building.","Your urban exploration begins."]}},neotokyo:{common:{prefixes:["Neon","Crowded","Rain-Slicked","Holographic","Bustling"],nouns:["Street","Alley","Arcade","Passage","Lane"],descriptions:["Neon signs reflect off wet pavement.","Holographic ads fill the air.","The city never sleeps."]},junction:{prefixes:["Central","Shibuya-Style","Main","Mega"],nouns:["Crossing","Plaza","Square","Hub"],descriptions:["Thousands of screens illuminate the area.","A sensory overload of lights and sounds."]},deadend:{prefixes:["Sealed","Private","VIP","Restricted"],nouns:["Booth","Room","Alley","Zone"],descriptions:["No access without credentials.","This area is off-limits."]},staircase:{names:["Gravity Lift","Mag-Rail","Sky Bridge","Vertical Transit"],descriptions:["High-tech vertical transportation.","The city builds upward."]},portal:{names:["VR Hub","Data Port","Network Node","Fast Travel"],descriptions:["Jack in to move instantly.","The network connects all."]},chest:{names:["Vending Cache","Data Stash","Loot Box","Street Vendor"],descriptions:["Even garbage has value here.","Credits can buy anything."]},minion:{names:["Yakuza Turf","Corp Security","Gang Territory","Hostile Zone"],descriptions:["Someone owns this block.","You're not welcome here."]},trap:{names:["ICE Node","Security Grid","Drone Patrol","Surveillance Zone"],descriptions:["Automated defenses are active.","Big Brother is watching."]},exit:{names:["City Limits","Extraction Point","Safe House","The Way Out"],descriptions:["Almost out of the neon jungle!","Freedom awaits beyond!"]},start:{names:["Drop Zone","Street Level","Entry Point","Ground Zero"],descriptions:["Welcome to the future.","Your cyberpunk adventure begins."]}},arena:{common:{prefixes:["Stone","Sandy","Blood-Stained","Gladiator","Battle"],nouns:["Corridor","Passage","Tunnel","Path","Way"],descriptions:["The roar of the crowd echoes.","Sand and blood mix underfoot.","Glory or death awaits."]},junction:{prefixes:["Central","Main","Grand","Champion's"],nouns:["Arena","Ring","Pit","Stage"],descriptions:["The fighting grounds await.","All paths lead to battle."]},deadend:{prefixes:["Holding","Recovery","Equipment","Fighter's"],nouns:["Cell","Room","Bay","Quarters"],descriptions:["A moment of rest between fights.","Prepare for the next battle."]},staircase:{names:["Gladiator's Rise","Champion's Lift","Arena Access","Victory Steps"],descriptions:["The path to glory.","Rise to meet your opponent."]},portal:{names:["Fighter's Gate","Champion Portal","Mystery Entrance","Wild Card"],descriptions:["Where will you emerge?","The crowd loves surprises."]},chest:{names:["Weapon Rack","Prize Cache","Spoils of War","Victor's Reward"],descriptions:["The strong deserve rewards.","Claim your prize."]},minion:{names:["Fighter's Corner","Beast Pit","Champion's Ground","Battle Zone"],descriptions:["An opponent awaits.","Prepare for combat!"]},trap:{names:["Spike Pit","Fire Trap","Collapsing Floor","Arena Hazard"],descriptions:["The arena is dangerous.","Watch your footing!"]},exit:{names:["Victor's Gate","Champion's Exit","Freedom Gate","The Way Out"],descriptions:["Glory awaits the victor!","Survive and escape!"]},start:{names:["Challenger's Gate","Fighter's Entrance","Arena Entry","The Beginning"],descriptions:["The crowd awaits.","Prove your worth!"]}},hospital:{common:{prefixes:["Sterile","White","Quiet","Flickering","Abandoned"],nouns:["Corridor","Hallway","Ward","Wing","Section"],descriptions:["The smell of antiseptic lingers.","Medical equipment lies scattered.","Fluorescent lights hum overhead."]},junction:{prefixes:["Central","Main","Nurse's","Reception"],nouns:["Station","Hub","Desk","Lobby"],descriptions:["Multiple wards connect here.","The hospital's central hub."]},deadend:{prefixes:["Private","Quarantine","Restricted","Sealed"],nouns:["Room","Bay","Ward","Unit"],descriptions:["This area is restricted.","No access without clearance."]},staircase:{names:["Emergency Stairs","Service Elevator","Staff Access","Fire Stairs"],descriptions:["Standard hospital vertical access.","Watch for gurneys."]},portal:{names:["Morgue Tunnel","Utility Access","Hidden Passage","Underground Route"],descriptions:["Not on the hospital map.","A hidden way through."]},chest:{names:["Supply Closet","Medical Storage","Equipment Room","Pharmacy Cache"],descriptions:["Medical supplies could be useful.","Someone stockpiled resources."]},minion:{names:["Quarantine Zone","Infected Ward","Danger Area","Hostile Section"],descriptions:["Something isn't right here.","Proceed with caution."]},trap:{names:["Biohazard Zone","Contaminated Area","Structural Damage","Hazmat Zone"],descriptions:["Warning signs are everywhere.","This area isn't safe."]},exit:{names:["Emergency Exit","Main Entrance","Ambulance Bay","The Way Out"],descriptions:["Fresh air awaits!","Almost out of the hospital!"]},start:{names:["ER Entrance","Main Lobby","Admission","Ground Floor"],descriptions:["You enter the hospital.","Something feels wrong here."]}},highrise:{common:{prefixes:["Dusty","Abandoned","Crumbling","Empty","Dark"],nouns:["Hallway","Floor","Corridor","Office","Suite"],descriptions:["Abandoned furniture gathers dust.","The building creaks in the wind.","Nature reclaims the space."]},junction:{prefixes:["Main","Central","Executive","Open"],nouns:["Lobby","Atrium","Floor","Hub"],descriptions:["Once a place of business.","Multiple paths through the floor."]},deadend:{prefixes:["Collapsed","Sealed","Blocked","Destroyed"],nouns:["Office","Room","Section","Area"],descriptions:["The way is impassable.","Structural damage blocks the path."]},staircase:{names:["Fire Stairs","Emergency Exit","Service Stairs","Broken Elevator"],descriptions:["Concrete stairs wind upward.","The elevator hasn't worked in years."]},portal:{names:["Window Ledge","Broken Wall","Collapsed Floor","Vent Shaft"],descriptions:["An unconventional route.","Not for the faint of heart."]},chest:{names:["Old Safe","Forgotten Cache","Executive Stash","Supply Closet"],descriptions:["Something was left behind.","Previous occupants stored valuables."]},minion:{names:["Squatter's Territory","Hostile Floor","Danger Zone","Occupied Area"],descriptions:["Someone else calls this home.","You're not alone here."]},trap:{names:["Weak Floor","Broken Glass","Falling Debris","Structural Collapse"],descriptions:["The building is unstable.","Every step could be your last."]},exit:{names:["Ground Floor","Street Exit","Fire Escape","The Way Out"],descriptions:["Solid ground awaits!","Almost out of the building!"]},start:{names:["Rooftop Access","Upper Floor","Entry Point","The Beginning"],descriptions:["You enter the abandoned building.","Urban exploration begins."]}}};function k(e,t,n,a,o,i,s){const r=a.theme||"fantasy",l=a.mapStyle||"maze",c=function(e,t,n,a,o,i){if(0===t&&0===n)return"start";if(t===o&&n===i)return"exit";if(e.staircase)return"staircase";if(e.portal)return"portal";if(e.chest)return"chest";if(e.minion)return"minion";if(e.trap)return"trap";const s=[!e.walls.top,!e.walls.right,!e.walls.bottom,!e.walls.left].filter(Boolean).length;return s>=3?"junction":1===s?"deadend":"common"}(e,t,n,0,i,s),m=S[l]||S.maze,d=m[c]||m.common,p=_[r]||_.fantasy;let u,h;if(d.names)u=d.names[Math.floor(Math.random()*d.names.length)];else{const e=d.prefixes[Math.floor(Math.random()*d.prefixes.length)],t=d.nouns[Math.floor(Math.random()*d.nouns.length)];if(Math.random()<.3&&p.adjectives){const n=p.adjectives[Math.floor(Math.random()*p.adjectives.length)];u="".concat(n," ").concat(e," ").concat(t)}else u="".concat(e," ").concat(t)}return h=d.descriptions[Math.floor(Math.random()*d.descriptions.length)],{name:u,description:h,roomType:c}}function M(e,t,n,a,o){for(let i=0;i<n;i++)for(let s=0;s<n;s++){const n=e[i][s];n.roomInfo=k(n,s,i,t,0,a,o)}}class E{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.options=e,this.container=null,this.initialized=!1}getType(){return"base"}init(e,t){this.container=e,this.initialized=!0}getGridHTML(e){throw new Error("getGridHTML must be implemented by subclass")}getPlayerOverlayHTML(e){throw new Error("getPlayerOverlayHTML must be implemented by subclass")}getCellSize(e){return e<=5?50:e<=7?45:e<=10?38:e<=12?32:e<=15?26:22}render(e){throw new Error("render must be implemented by subclass")}updatePlayerPosition(e,t,n,a){throw new Error("updatePlayerPosition must be implemented by subclass")}highlightCell(e,t,n){}clearHighlights(){}playEffect(e,t,n){}getStyles(){return""}cleanup(){this.initialized=!1,this.container=null}}class C extends E{getType(){return"css-grid"}getGridHTML(e){const t=this.getCellSize(e);return'\n            <div id="maze_grid" class="maze-grid" style="\n                display: grid;\n                grid-template-columns: repeat('.concat(e,", ").concat(t,'px);\n                gap: 0;\n                position: relative;\n            "></div>\n        ')}getPlayerOverlayHTML(e){return'\n            <div id="maze_player_overlay" class="maze-player-overlay" style="width: '.concat(e,"px; height: ").concat(e,'px;">\n                <div class="maze-player-marker"></div>\n            </div>\n        ')}render(e){var t;const{grid:n,size:a,playerX:o,playerY:i,visited:s,exitX:r,exitY:l,isVictory:c,profile:m,currentFloor:d,totalFloors:p}=e,u=document.getElementById("maze_grid");if(!u)return;const h=this.getCellSize(a),g=null!==(t=null==m?void 0:m.fogOfWar)&&void 0!==t&&t;u.style.gridTemplateColumns="repeat(".concat(a,", ").concat(h,"px)"),u.innerHTML="";const f=p>1?"".concat(d,":"):"";for(let e=0;e<a;e++)for(let t=0;t<a;t++){const a=n[e][t],d=document.createElement("div");d.className="maze-cell",d.style.width="".concat(h,"px"),d.style.height="".concat(h,"px");const p="".concat(f).concat(t,",").concat(e),v="".concat(t,",").concat(e),b=s.has(p)||s.has(v),y=t===o&&e===i,z=t===r&&e===l,x=!g||b;if(x?(d.classList.add("visited"),a.walls.top&&d.classList.add("wall-top"),a.walls.right&&d.classList.add("wall-right"),a.walls.bottom&&d.classList.add("wall-bottom"),a.walls.left&&d.classList.add("wall-left")):d.classList.add("hidden"),y&&d.classList.add("player"),z&&x&&(d.classList.add("exit"),c&&d.classList.add("victory-glow")),a.minion&&x&&(d.classList.add("has-minion"),a.minion.triggered&&d.classList.add("minion-triggered")),a.chest&&x&&(d.classList.add("has-chest"),"locked"===a.chest.type&&d.classList.add("chest-locked"),a.chest.opened&&d.classList.add("chest-opened"),null!=m&&m.chestImage&&!a.chest.opened)){d.classList.add("has-custom-chest");const e=document.createElement("img");e.src=ie(m.chestImage),e.className="maze-chest-img",e.style.cssText="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 70%; height: 70%; object-fit: cover; border-radius: 3px; z-index: 1;","locked"===a.chest.type&&(e.style.filter="grayscale(50%)"),d.appendChild(e)}a.trap&&x&&(d.classList.add("has-trap"),a.trap.triggered&&d.classList.add("trap-triggered")),a.portal&&x&&(d.classList.add("has-portal"),d.dataset.portalColor=a.portal.color||"#9b59b6",d.style.setProperty("--portal-color",a.portal.color||"#9b59b6"),a.portal.bidirectional||a.portal.isStart||d.classList.add("portal-exit-only")),a.staircase&&x&&(d.classList.add("has-staircase"),d.classList.add("up"===a.staircase.direction?"staircase-up":"staircase-down"),a.staircase.requireKey&&d.classList.add("staircase-locked")),d.dataset.x=t,d.dataset.y=e,u.appendChild(d)}}updatePlayerPosition(e,t,n,a){const o=document.getElementById("maze_player_overlay");if(!o)return;const i=e*a,s=t*a;o.style.transition=n?"transform 0.15s ease-out":"none",o.style.transform="translate(".concat(i,"px, ").concat(s,"px)"),n||requestAnimationFrame((()=>{o.style.transition="transform 0.15s ease-out"}))}highlightCell(e,t,n){const a=document.querySelector('.maze-cell[data-x="'.concat(e,'"][data-y="').concat(t,'"]'));a&&a.classList.add("highlight-".concat(n))}clearHighlights(){document.querySelectorAll('.maze-cell[class*="highlight-"]').forEach((e=>{e.className=e.className.replace(/highlight-\w+/g,"").trim()}))}playEffect(e,t,n){const a=document.querySelector('.maze-cell[data-x="'.concat(e,'"][data-y="').concat(t,'"]'));a&&(a.classList.add("effect-".concat(n)),setTimeout((()=>{a.classList.remove("effect-".concat(n))}),500))}}class I extends E{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super(e),this.canvas=null,this.ctx=null,this.sprites={},this.tileSize=e.tileSize||32}getType(){return"canvas"}getGridHTML(e){const t=e*this.tileSize;return'\n            <canvas id="maze_canvas" width="'.concat(t,'" height="').concat(t,'" style="\n                display: block;\n                image-rendering: pixelated;\n            "></canvas>\n        ')}getPlayerOverlayHTML(e){return""}async loadSprites(e){const t=Object.entries(e).map((async e=>{let[t,n]=e;const a=new Image;a.src=n,await new Promise(((e,t)=>{a.onload=e,a.onerror=t})),this.sprites[t]=a}));await Promise.all(t)}init(e,t){super.init(e,t),this.canvas=document.getElementById("maze_canvas"),this.canvas&&(this.ctx=this.canvas.getContext("2d"))}render(e){var t;if(!this.ctx)return;const{grid:n,size:a,playerX:o,playerY:i,visited:s,exitX:r,exitY:l,profile:c}=e,m=this.tileSize,d=null!==(t=null==c?void 0:c.fogOfWar)&&void 0!==t&&t;this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);for(let e=0;e<a;e++)for(let t=0;t<a;t++){const a=n[e][t],o="".concat(t,",").concat(e),i=s.has(o);!d||i?(this.sprites.floor?this.ctx.drawImage(this.sprites.floor,t*m,e*m,m,m):(this.ctx.fillStyle="#2d2d44",this.ctx.fillRect(t*m,e*m,m,m)),this.ctx.strokeStyle="#8b5cf6",this.ctx.lineWidth=2,a.walls.top&&(this.ctx.beginPath(),this.ctx.moveTo(t*m,e*m),this.ctx.lineTo((t+1)*m,e*m),this.ctx.stroke()),a.walls.right&&(this.ctx.beginPath(),this.ctx.moveTo((t+1)*m,e*m),this.ctx.lineTo((t+1)*m,(e+1)*m),this.ctx.stroke()),a.walls.bottom&&(this.ctx.beginPath(),this.ctx.moveTo(t*m,(e+1)*m),this.ctx.lineTo((t+1)*m,(e+1)*m),this.ctx.stroke()),a.walls.left&&(this.ctx.beginPath(),this.ctx.moveTo(t*m,e*m),this.ctx.lineTo(t*m,(e+1)*m),this.ctx.stroke()),t===r&&e===l&&(this.sprites.exit?this.ctx.drawImage(this.sprites.exit,t*m,e*m,m,m):(this.ctx.fillStyle="#22c55e",this.ctx.fillRect(t*m+4,e*m+4,m-8,m-8))),a.chest&&!a.chest.opened&&(this.sprites.chest?this.ctx.drawImage(this.sprites.chest,t*m,e*m,m,m):(this.ctx.fillStyle="#f59e0b",this.ctx.fillRect(t*m+6,e*m+6,m-12,m-12))),a.minion&&!a.minion.triggered&&(this.sprites.minion?this.ctx.drawImage(this.sprites.minion,t*m,e*m,m,m):(this.ctx.fillStyle="#ef4444",this.ctx.beginPath(),this.ctx.arc(t*m+m/2,e*m+m/2,m/4,0,2*Math.PI),this.ctx.fill()))):(this.ctx.fillStyle="#1a1a2e",this.ctx.fillRect(t*m,e*m,m,m))}this.sprites.player?this.ctx.drawImage(this.sprites.player,o*m,i*m,m,m):(this.ctx.fillStyle="#3b82f6",this.ctx.beginPath(),this.ctx.arc(o*m+m/2,i*m+m/2,m/3,0,2*Math.PI),this.ctx.fill())}updatePlayerPosition(e,t,n,a){}getCellSize(e){return this.tileSize}}const T={renderers:{"css-grid":C,canvas:I,isometric:class extends I{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super(e),this.tileWidth=e.tileWidth||64,this.tileHeight=e.tileHeight||32,this.wallHeight=e.wallHeight||24,this.spriteCache={},this.spritesLoaded=!1,this.spritesLoading=!1,this.spritePaths={floor:"assets/isometric/dungeon/floor.png",wall:"assets/isometric/dungeon/wall.png",wallCorner:"assets/isometric/dungeon/wall_corner.png",fog:"assets/isometric/dungeon/fog.png",exit:"assets/isometric/dungeon/exit.png",chest:"assets/isometric/dungeon/chest_closed.png",chestOpen:"assets/isometric/dungeon/chest_open.png",portal:"assets/isometric/dungeon/portal.png",trap:"assets/isometric/dungeon/trap.png",minion:"assets/isometric/dungeon/minion.png",player:"assets/isometric/dungeon/player.png",stairsUp:"assets/isometric/dungeon/stairs_up.png",stairsDown:"assets/isometric/dungeon/stairs_down.png"},this.palette={floor:{top:"#3d3d5c",light:"#4a4a6a",dark:"#2d2d44"},wall:{top:"#6b5b95",light:"#8b7bb5",dark:"#4b3b75"},fog:{top:"#1a1a2e",light:"#222244",dark:"#111122"},exit:{top:"#22c55e",light:"#4ade80",dark:"#16a34a"},chest:{top:"#f59e0b",light:"#fbbf24",dark:"#d97706"},chestOpen:{top:"#78716c",light:"#a8a29e",dark:"#57534e"},minion:{top:"#ef4444",light:"#f87171",dark:"#dc2626"},trap:{top:"#a855f7",light:"#c084fc",dark:"#9333ea"},portal:{top:"#06b6d4",light:"#22d3ee",dark:"#0891b2"},stairUp:{top:"#10b981",light:"#34d399",dark:"#059669"},stairDown:{top:"#f97316",light:"#fb923c",dark:"#ea580c"},player:{top:"#3b82f6",light:"#60a5fa",dark:"#2563eb"}}}getType(){return"isometric"}async loadSprites(){if(this.spritesLoaded||this.spritesLoading)return;this.spritesLoading=!0;const e=Object.entries(this.spritePaths).map((async e=>{let[t,n]=e;try{const e=new Image;e.src="/scripts/extensions/third-party/SillyTavern-MazeMaster/"+n,await new Promise(((t,n)=>{e.onload=t,e.onerror=n})),this.spriteCache[t]=e}catch(e){console.warn("[MazeMaster] Failed to load sprite: ".concat(n))}}));await Promise.all(e),this.spritesLoaded=!0,this.spritesLoading=!1,console.log("[MazeMaster] Isometric sprites loaded:",Object.keys(this.spriteCache)),this.lastMazeState&&this.render(this.lastMazeState)}gridToIso(e,t){return{x:(e-t)*(this.tileWidth/2),y:(e+t)*(this.tileHeight/2)}}isoToGrid(e,t){const n=(e/(this.tileWidth/2)+t/(this.tileHeight/2))/2,a=(t/(this.tileHeight/2)-e/(this.tileWidth/2))/2;return{x:Math.floor(n),y:Math.floor(a)}}getGridHTML(e){const t=this.getCellSize(e),n=t/2,a=e*n+2*t+n;return'\n            <canvas id="maze_canvas" width="'.concat((e+1)*t,'" height="').concat(a,'" style="\n                display: block;\n                image-rendering: crisp-edges;\n                max-width: 100%;\n            "></canvas>\n        ')}getPlayerOverlayHTML(){return""}getCellSize(e){return e<=7?76:e<=10?64:e<=15?52:e<=20?44:36}init(e,t){if(null!=t&&t.size){const e=this.getCellSize(t.size);this.tileWidth=e,this.tileHeight=e/2,this.wallHeight=.375*e}super.init(e,t),this.loadSprites()}drawSprite(e,t,n){let a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;const o=this.spriteCache[e];if(!o)return!1;const i=o.height/o.width,s=this.tileWidth*a,r=s*i,l=t-s/2,c=n+this.tileHeight/2-r;return this.ctx.drawImage(o,l,c,s,r),!0}render(e){var t;if(!this.ctx&&(this.canvas=document.getElementById("maze_canvas"),this.canvas&&(this.ctx=this.canvas.getContext("2d")),!this.ctx))return;this.lastMazeState=e;const{grid:n,size:a,playerX:o,playerY:i,visited:s,exitX:r,exitY:l,isVictory:c,currentFloor:m,totalFloors:d,profile:p}=e,u=null!==(t=null==p?void 0:p.fogOfWar)&&void 0!==t&&t,h=2*this.tileWidth,g=(a+1)*this.tileWidth,f=a*this.tileHeight+h+this.tileHeight;this.canvas.width===g&&this.canvas.height===f||(this.canvas.width=g,this.canvas.height=f),this.ctx.fillStyle="#0a0a1a",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);const v=this.canvas.width/2,b=h,y=d>1?"".concat(m,":"):"";for(let e=0;e<a;e++)for(let t=0;t<a;t++){const a=n[e][t],m="".concat(y).concat(t,",").concat(e),d="".concat(t,",").concat(e),p=s.has(m)||s.has(d),h=this.gridToIso(t,e),g=h.x+v,f=h.y+b;if(!u||p){if(this.drawSprite("floor",g,f)||this.drawIsoDiamond(g,f,this.palette.floor),a.walls.left||a.walls.top){a.walls.left&&a.walls.top?this.drawSprite("wallCorner",g,f)||(this.drawWallLeft(g,f,this.palette.wall),this.drawWallTop(g,f,this.palette.wall)):a.walls.left?this.drawSprite("wall",g,f)||this.drawWallLeft(g,f,this.palette.wall):a.walls.top&&(this.drawSprite("wall",g,f)||this.drawWallTop(g,f,this.palette.wall))}const n=t===o&&e===i;if(t===r&&e===l&&(this.drawSprite("exit",g,f,1)||this.drawIsoBlock(g,f-2,c?this.palette.stairUp:this.palette.exit,4)),a.staircase){const e="up"===a.staircase.direction?"stairsUp":"stairsDown";if(!this.drawSprite(e,g,f,1)){const e="up"===a.staircase.direction?this.palette.stairUp:this.palette.stairDown;this.drawIsoBlock(g,f-2,e,6),this.drawStairIcon(g,f-6,a.staircase.direction)}}if(a.portal&&(this.drawSprite("portal",g,f,.8)||this.drawPortal(g,f)),a.chest){const e=a.chest.opened?"chestOpen":"chest";if(!this.drawSprite(e,g,f,.8)){const e=a.chest.opened?this.palette.chestOpen:this.palette.chest;this.drawChest(g,f,e,a.chest.opened)}}a.trap&&!a.trap.triggered&&(this.drawSprite("trap",g,f,1)||this.drawTrap(g,f)),a.minion&&!a.minion.triggered&&(this.drawSprite("minion",g,f,1)||this.drawMinion(g,f)),n&&(this.drawSprite("player",g,f,1)||this.drawPlayer(g,f))}else this.drawIsoBlock(g,f,this.palette.fog,0)}}drawIsoDiamond(e,t,n){const a=this.tileWidth/2,o=this.tileHeight/2;this.ctx.fillStyle=n.top,this.ctx.beginPath(),this.ctx.moveTo(e,t-o),this.ctx.lineTo(e+a,t),this.ctx.lineTo(e,t+o),this.ctx.lineTo(e-a,t),this.ctx.closePath(),this.ctx.fill()}drawIsoBlock(e,t,n){let a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:8;const o=this.tileWidth/2,i=this.tileHeight/2;this.ctx.fillStyle=n.dark,this.ctx.beginPath(),this.ctx.moveTo(e-o,t),this.ctx.lineTo(e,t+i),this.ctx.lineTo(e,t+i+a),this.ctx.lineTo(e-o,t+a),this.ctx.closePath(),this.ctx.fill(),this.ctx.fillStyle=n.light,this.ctx.beginPath(),this.ctx.moveTo(e+o,t),this.ctx.lineTo(e,t+i),this.ctx.lineTo(e,t+i+a),this.ctx.lineTo(e+o,t+a),this.ctx.closePath(),this.ctx.fill(),this.drawIsoDiamond(e,t,n)}drawWallLeft(e,t,n){const a=this.tileWidth/2,o=this.tileHeight/2,i=this.wallHeight;this.ctx.fillStyle=n.dark,this.ctx.beginPath(),this.ctx.moveTo(e-a,t),this.ctx.lineTo(e-a,t-i),this.ctx.lineTo(e,t-o-i),this.ctx.lineTo(e,t-o),this.ctx.closePath(),this.ctx.fill(),this.ctx.fillStyle=n.top,this.ctx.fillRect(e-a-1,t-i-2,4,4)}drawWallTop(e,t,n){const a=this.tileWidth/2,o=this.tileHeight/2,i=this.wallHeight;this.ctx.fillStyle=n.light,this.ctx.beginPath(),this.ctx.moveTo(e,t-o),this.ctx.lineTo(e,t-o-i),this.ctx.lineTo(e+a,t-i),this.ctx.lineTo(e+a,t),this.ctx.closePath(),this.ctx.fill(),this.ctx.fillStyle=n.top,this.ctx.fillRect(e+a-2,t-i-2,4,4)}drawPlayer(e,t){const n=this.palette.player,a=this.tileWidth/5;this.ctx.fillStyle="rgba(0,0,0,0.3)",this.ctx.beginPath(),this.ctx.ellipse(e,t+2,a,a/2,0,0,2*Math.PI),this.ctx.fill();const o=this.ctx.createRadialGradient(e-a/3,t-a-a/2,0,e,t-a/2,1.5*a);o.addColorStop(0,n.light),o.addColorStop(.5,n.top),o.addColorStop(1,n.dark),this.ctx.fillStyle=o,this.ctx.beginPath(),this.ctx.arc(e,t-a/2,a,0,2*Math.PI),this.ctx.fill(),this.ctx.fillStyle="rgba(255,255,255,0.4)",this.ctx.beginPath(),this.ctx.arc(e-a/3,t-a,a/4,0,2*Math.PI),this.ctx.fill()}drawChest(e,t,n,a){const o=this.tileWidth/3,i=this.tileHeight/2;this.ctx.fillStyle=n.dark,this.ctx.fillRect(e-o/2,t-i,o,i),this.ctx.fillStyle=n.top,this.ctx.fillRect(e-o/2,t-i,o,i/3),a?(this.ctx.fillStyle=n.light,this.ctx.fillRect(e-o/2,t-i-4,o,4)):(this.ctx.fillStyle="#ffd700",this.ctx.fillRect(e-2,t-i/2-2,4,4))}drawMinion(e,t){const n=this.palette.minion,a=this.tileWidth/6;this.ctx.fillStyle="rgba(0,0,0,0.3)",this.ctx.beginPath(),this.ctx.ellipse(e,t+2,a,a/2,0,0,2*Math.PI),this.ctx.fill(),this.ctx.fillStyle=n.top,this.ctx.beginPath(),this.ctx.arc(e,t-a/2,a,0,2*Math.PI),this.ctx.fill(),this.ctx.fillStyle="#fff",this.ctx.beginPath(),this.ctx.arc(e-3,t-a/2,2,0,2*Math.PI),this.ctx.arc(e+3,t-a/2,2,0,2*Math.PI),this.ctx.fill()}drawTrap(e,t){const n=this.palette.trap;this.ctx.fillStyle=n.top;for(let n=-1;n<=1;n++)this.ctx.beginPath(),this.ctx.moveTo(e+6*n-2,t),this.ctx.lineTo(e+6*n,t-6),this.ctx.lineTo(e+6*n+2,t),this.ctx.fill()}drawPortal(e,t){const n=this.palette.portal,a=this.tileWidth/4,o=this.ctx.createRadialGradient(e,t-a/2,0,e,t-a/2,1.5*a);o.addColorStop(0,n.light),o.addColorStop(.5,n.top+"88"),o.addColorStop(1,"transparent"),this.ctx.fillStyle=o,this.ctx.beginPath(),this.ctx.arc(e,t-a/2,1.5*a,0,2*Math.PI),this.ctx.fill(),this.ctx.fillStyle=n.top,this.ctx.beginPath(),this.ctx.arc(e,t-a/2,a/2,0,2*Math.PI),this.ctx.fill()}drawStairIcon(e,t,n){this.ctx.fillStyle="#fff",this.ctx.font="bold 12px Arial",this.ctx.textAlign="center",this.ctx.fillText("up"===n?"▲":"▼",e,t)}updatePlayerPosition(e,t,n,a){}}},currentRenderer:null,currentType:"css-grid",register(e,t){this.renderers[e]=t},create(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const n=this.renderers[e];return n?new n(t):(console.warn("[MazeMaster] Unknown renderer type: ".concat(e,", falling back to css-grid")),new C(t))},getRenderer(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return!t&&void 0!==de&&null!==(e=de)&&void 0!==e&&e.rendererType&&(t=de.rendererType),t&&t!==this.currentType&&(this.currentRenderer&&this.currentRenderer.cleanup(),this.currentType=t,this.currentRenderer=this.create(t)),this.currentRenderer||(this.currentRenderer=this.create(this.currentType)),this.currentRenderer},getAvailableTypes(){return Object.keys(this.renderers)}};function P(){var e;const t=(null===(e=de)||void 0===e?void 0:e.layoutMode)||"auto";return"auto"===t?function(){const e=window.innerWidth;return window.innerHeight>e||e<768?"mobile":"desktop"}():t}function B(){const e=document.getElementById("mazemaster_maze_modal");if(!e)return;const t=P();e.classList.remove("layout-mobile","layout-desktop"),e.classList.add("layout-".concat(t));const n=e.querySelector(".maze-modal-container");n&&(n.classList.remove("layout-mobile","layout-desktop"),n.classList.add("layout-".concat(t)))}"undefined"!=typeof window&&window.addEventListener("resize",(()=>{var e;"auto"===(null===(e=de)||void 0===e?void 0:e.layoutMode)&&B()}));async function L(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e4;if(!e||"string"!=typeof e||""===e.trim())return null;try{const n=new Promise(((e,n)=>{setTimeout((()=>n(new Error("STScript timed out after ".concat(t,"ms")))),t)}));return await Promise.race([m(e),n])}catch(t){var n;return null!==(n=t.message)&&void 0!==n&&n.includes("timed out")?console.warn("[MazeMaster] STScript timed out: ".concat(e.substring(0,50),"...")):console.error("[MazeMaster] STScript error:",t),null}}async function j(e){var t;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const a=null===(t=he)||void 0===t?void 0:t.profile;if(!a)return;let o=a[e];if(o&&"string"==typeof o&&o.trim()){for(const[e,t]of Object.entries(n))o=o.replaceAll("{{".concat(e,"}}"),String(t));await L(o)}}function O(e){const t="string"==typeof e?e:(null==e?void 0:e.difficulty)||"normal";return x[t]||x.normal}function A(){try{var e;const t=SillyTavern.getContext();return(null==t?void 0:t.name1)||(null==t?void 0:t.persona)||(null==t||null===(e=t.user_avatar)||void 0===e?void 0:e.replace(/\.[^/.]+$/,""))||"Default User"}catch(e){return console.warn("[MazeMaster] Could not get persona name:",e),"Default User"}}async function D(e){var t;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;null!==(t=he)&&void 0!==t&&t.stats&&"number"==typeof he.stats[e]&&(he.stats[e]+=n,N(),await j("onStatUpdate",{statName:e,value:he.stats[e]}))}function R(){var e;if(null===(e=he)||void 0===e||null===(e=e.stats)||void 0===e||!e.startTime)return"0:00";const t=Math.floor((Date.now()-he.stats.startTime)/1e3),n=Math.floor(t/3600),a=Math.floor(t%3600/60),o=t%60;return n>0?"".concat(n,":").concat(a.toString().padStart(2,"0"),":").concat(o.toString().padStart(2,"0")):"".concat(a,":").concat(o.toString().padStart(2,"0"))}function F(){var e,t;if(null===(e=he)||void 0===e||!e.visited||null===(t=he)||void 0===t||!t.size)return 0;const n=he.totalFloors||1,a=he.size*he.size*n;return Math.floor(he.visited.size/a*100)}function N(){var e;const t=document.getElementById("maze_stat_moves"),n=document.getElementById("maze_stat_time"),a=document.getElementById("maze_stat_explore");t&&(t.textContent=(null===(e=he)||void 0===e||null===(e=e.stats)||void 0===e?void 0:e.moves)||0),n&&(n.textContent=R()),a&&(a.textContent="".concat(F(),"%"))}function W(e,t,n,a,o){e.profileStats||(e.profileStats={});const i=e.profileStats[t]||{totalGames:0,wins:0,losses:0,bestTime:null,totalMoves:0};i.totalGames++,"win"===n?(i.wins++,(null===i.bestTime||a<i.bestTime)&&(i.bestTime=a)):i.losses++,i.totalMoves+=o,e.profileStats[t]=i,e.totalGames=(e.totalGames||0)+1,"win"===n?(e.wins=(e.wins||0)+1,(null===e.bestTime||a<e.bestTime)&&(e.bestTime=a)):e.losses=(e.losses||0)+1,e.totalMoves=(e.totalMoves||0)+o}function q(e){var n,a;if(null===(n=he)||void 0===n||!n.profileName||null===(a=he)||void 0===a||!a.stats)return;const o=he.profileName,s=A(),r=Date.now()-he.stats.startTime,l=he.stats.moves;de.mazeStats||(de.mazeStats={global:{totalGames:0,wins:0,losses:0,bestTime:null,totalMoves:0,profileStats:{}},personas:{}}),de.mazeStats.global||function(){if(!de.mazeStats)return;if(de.mazeStats.global)return;const e=de.mazeStats.profileStats||{};de.mazeStats={global:{totalGames:0,wins:0,losses:0,bestTime:null,totalMoves:0,profileStats:t({},e)},personas:{}};for(const t in e){const n=e[t];de.mazeStats.global.totalGames+=n.totalGames||0,de.mazeStats.global.wins+=n.wins||0,de.mazeStats.global.losses+=n.losses||0,de.mazeStats.global.totalMoves+=n.totalMoves||0,null!==n.bestTime&&(null===de.mazeStats.global.bestTime||n.bestTime<de.mazeStats.global.bestTime)&&(de.mazeStats.global.bestTime=n.bestTime)}console.log("[MazeMaster] Migrated stats to new global/persona format"),i()}(),W(de.mazeStats.global,o,e,r,l),de.mazeStats.personas[s]||(de.mazeStats.personas[s]={totalGames:0,wins:0,losses:0,bestTime:null,totalMoves:0,profileStats:{}}),W(de.mazeStats.personas[s],o,e,r,l),i()}let H=null;function G(){H&&(clearInterval(H),H=null)}function Y(e){const t=function(e){const t=(null==e?void 0:e.theme)||"fantasy",n=w[t]||w.fantasy;return(null==n?void 0:n.colors)||{primary:"#2ecc71",secondary:"#27ae60",accent:"#f1c40f"}}(e),n=document.querySelector(".mazemaster-maze-container");n&&(n.style.setProperty("--theme-primary",t.primary),n.style.setProperty("--theme-secondary",t.secondary),n.style.setProperty("--theme-accent",t.accent))}function U(){var e;const t=document.querySelector(".dpad-floor-up"),n=document.querySelector(".dpad-floor-down");if(!t||!n||!he)return;const a=null===(e=he.grid)||void 0===e||null===(e=e[he.playerY])||void 0===e?void 0:e[he.playerX],o=null==a?void 0:a.staircase;"up"===(null==o?void 0:o.direction)?t.classList.remove("hidden"):t.classList.add("hidden"),"down"===(null==o?void 0:o.direction)?n.classList.remove("hidden"):n.classList.add("hidden")}async function K(e){var t,n,a;if(null===(t=he)||void 0===t||!t.isOpen||he.isPaused)return!1;if(he.totalFloors<=1)return!1;const o=null===(n=he.grid)||void 0===n||null===(n=n[he.playerY])||void 0===n?void 0:n[he.playerX];if(null==o||!o.staircase)return console.log("[MazeMaster] Not on a staircase"),!1;if(o.staircase.direction!==e)return console.log("[MazeMaster] Staircase direction mismatch"),!1;if(o.staircase.requireKey&&"up"===e){if(!((null===(i=he)||void 0===i?void 0:i.inventory.floorKey)>0))return he.currentMinion={name:"Locked Staircase",imagePath:"",message:"This staircase is locked! You need a Floor Key to ascend."},_t(),!1;await async function(){var e;(null===(e=he)||void 0===e?void 0:e.inventory.floorKey)>0&&await Lt("floorKey",1)}()}var i;const s=o.staircase.targetFloor,r=o.staircase.targetX,l=o.staircase.targetY;if(s<0||s>=he.totalFloors)return console.error("[MazeMaster] Invalid target floor"),!1;he.currentFloor=s,he.grid=he.floors[s],he.playerX=r,he.playerY=l,he.visited.add("".concat(s,":").concat(r,",").concat(l));const c=w[null===(a=he.profile)||void 0===a?void 0:a.theme]||w.fantasy,m="up"===e?c.flavorMessages.stairUp:c.flavorMessages.stairDown;return he.currentMinion={name:"up"===e?"Ascending":"Descending",imagePath:"",message:m||"You ".concat("up"===e?"ascend":"descend"," to floor ").concat(s+1,"...")},_t(),await j("onMove",{x:r,y:l,direction:"up"===e?"floor-up":"floor-down",floor:s}),zt(),J(!1),N(),U(),X(),console.log("[MazeMaster] Changed to floor ".concat(s+1)),!0}function X(){const e=document.getElementById("maze_floor_current"),t=document.getElementById("maze_floor_total"),n=document.querySelector(".maze-floor-indicator");he.totalFloors<=1?n&&(n.style.display="none"):(n&&(n.style.display=""),e&&(e.textContent=he.currentFloor+1),t&&(t.textContent=he.totalFloors))}async function V(e,t){await Lt("portalStone",1),he.playerX=e,he.playerY=t,he.visited.add("".concat(he.currentFloor,":").concat(e,",").concat(t)),J(!0),zt(),he.currentMinion={name:"Portal Stone",imagePath:"",message:"The portal stone crumbles as you are whisked through space!"},_t(),await j("onTeleport",{x:e,y:t,source:"portalStone"})}function J(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(!he)return;const t=T.getRenderer(),n=ft(he.size);t.updatePlayerPosition(he.playerX,he.playerY,e,n),kt()}function Z(e,t,n,a,o,i){const{x:s,y:r,originX:l,originY:c,movement:m}=e,d=(null==i?void 0:i.minionAggressionMult)||1,p=function(e,t,n,a){const o=[],i=n[t][e];if(!i.walls.top&&t>0){n[t-1][e].minion||0===e&&t-1==0||o.push({x:e,y:t-1})}if(!i.walls.bottom&&t<a-1){n[t+1][e].minion||e===a-1&&t+1===a-1||o.push({x:e,y:t+1})}if(!i.walls.left&&e>0){n[t][e-1].minion||e-1==0&&0===t||o.push({x:e-1,y:t})}if(!i.walls.right&&e<a-1){n[t][e+1].minion||e+1===a-1&&t===a-1||o.push({x:e+1,y:t})}return o}(s,r,t,n);if(0===p.length)return null;switch(m.type){case"patrol":{const e=m.patrolRadius||3,t=p.filter((t=>Math.abs(t.x-l)+Math.abs(t.y-c)<=e));return 0===t.length?null:t[Math.floor(Math.random()*t.length)]}case"chase":{const e=m.chaseRange||5,t=Math.ceil(e*d),n=Math.abs(s-a)+Math.abs(r-o);if(n>t)return p[Math.floor(Math.random()*p.length)];let i=null,l=n;for(const e of p){const t=Math.abs(e.x-a)+Math.abs(e.y-o);t<l&&(l=t,i=e)}return i&&Math.random()<1/d*.5?p[Math.floor(Math.random()*p.length)]:i||p[Math.floor(Math.random()*p.length)]}default:return null}}function Q(e){const t={},n=e.objectives||[];for(const e of n)t[e.id]={current:0,completed:!1,target:e.count||1};return t}async function $(e,t){var n;let a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;if(!he||null===(n=he.profile)||void 0===n||!n.objectives)return;const o=he.profile.objectives,i=he.objectiveProgress;for(const n of o){if(n.type!==e)continue;if(("collect"===e||"defeat"===e)&&n.target!==t)continue;const o=i[n.id];o&&!o.completed&&(o.current+=a,await j("onObjectiveProgress",{objectiveId:n.id,current:o.current,target:n.count||1}),o.current>=(n.count||1)&&!o.completed&&(o.completed=!0,await j("onObjectiveComplete",{objectiveId:n.id}),n.reward&&n.reward.trim()&&await L(n.reward),console.log('[MazeMaster] Objective "'.concat(n.id,'" completed!'))))}te(),ee()}async function ee(){var e;if(!he||he.allObjectivesComplete)return;const t=(null===(e=he.profile)||void 0===e?void 0:e.objectives)||[],n=he.objectiveProgress;t.every((e=>{var t;return!e.required||(null===(t=n[e.id])||void 0===t?void 0:t.completed)}))&&t.some((e=>e.required))&&(he.allObjectivesComplete=!0,await j("onAllObjectivesComplete",{}),console.log("[MazeMaster] All required objectives complete!"))}function te(){var e,t;const n=document.getElementById("maze_objectives_list");if(!n||!he)return;const a=(null===(e=he.profile)||void 0===e?void 0:e.objectives)||[],o=he.objectiveProgress;var i;if(0===a.length)return n.innerHTML="",void(null===(i=n.closest(".maze-objectives-section"))||void 0===i||i.classList.add("hidden"));null===(t=n.closest(".maze-objectives-section"))||void 0===t||t.classList.remove("hidden"),n.innerHTML=a.map((e=>{const t=o[e.id]||{current:0,completed:!1},n=t.completed,a=n?"fa-check-circle":e.required?"fa-circle":"fa-circle-o",i=n?"objective-complete":e.required?"objective-required":"objective-optional";return'\n            <div class="objective-item '.concat(i,'">\n                <i class="fa-solid ').concat(a,'"></i>\n                <span class="objective-description">').concat($t(e.description||e.id),'</span>\n                <span class="objective-progress">').concat(t.current,"/").concat(e.count||1,"</span>\n            </div>\n        ")})).join("")}const ne={profiles:{},battlebarProfiles:{},mazeProfiles:{},minions:{},minionProfiles:{},trapProfiles:{},currentProfile:"default",currentBattlebarProfile:"default",currentMazeProfile:"default",currentMinionProfile:"default",currentTrapProfile:"default",activeGameConfig:"wheel",llmEnabled:!0,llmPreset:"",dpadConfig:{enabled:!0,floating:!0,position:{x:null,y:null}}},ae={"Reward Wheel":{segments:[{trigger:"",text:"Small Prize",command:"/echo You won a small prize!",size:"fraction",respin:!1},{trigger:"",text:"Medium Prize",command:"/echo You won a medium prize!",size:"fraction",respin:!1},{trigger:"",text:"Big Prize!",command:"/echo Amazing! You won the big prize!",size:"fraction",respin:!1},{trigger:"",text:"Try Again",command:"/echo Better luck next time...",size:"fraction",respin:!1},{trigger:"",text:"JACKPOT!",command:"/echo JACKPOT! Incredible luck!",size:"fraction",respin:!1},{trigger:"",text:"Bonus Spin",command:"/echo You get another spin!",size:"fraction",respin:!0}],randomize:!0,difficulty:1},"Challenge Wheel":{segments:[{trigger:"",text:"Easy Task",command:"/echo Easy task assigned!",size:"doubleseg",respin:!1},{trigger:"",text:"Medium Task",command:"/echo Medium task assigned!",size:"fraction",respin:!1},{trigger:"",text:"Hard Task",command:"/echo Hard task - good luck!",size:"halfseg",respin:!1},{trigger:"",text:"Free Pass",command:"/echo Lucky! You get a free pass!",size:"doubleseg",respin:!1},{trigger:"",text:"Double or Nothing",command:"/echo Spin again - double stakes!",size:"halfseg",respin:!0}],randomize:!1,difficulty:2}},oe={"Easy Fight":{difficulty:2,hitsToWin:3,missesToLose:5,description:"A minor enemy blocks your path - a quick skirmish to test your reflexes.",hitCommand:"/echo Hit! Keep going!",missCommand:"/echo Missed! Watch the timing!",winCommand:"/echo Victory! You defeated the enemy!",loseCommand:"/echo Defeated... Try again!",mainTitle:"Goblin",images:[{imagePath:"images/easy_fight.jpeg",stageMessage:"The enemy appears!"},{imagePath:"images/easy_fight.jpeg",stageMessage:"You land a blow!"},{imagePath:"images/easy_fight.jpeg",stageMessage:"Almost there!"},{imagePath:"images/easy_fight.jpeg",stageMessage:"Victory!"}],keyDropChance:40,powDropChance:20,stealthDropChance:10},"Boss Battle":{difficulty:4,hitsToWin:5,missesToLose:3,description:"A fearsome boss enemy stands before you - a brutal fight for survival with no room for error.",hitCommand:"/echo Critical hit!",missCommand:"/echo The boss counters!",winCommand:"/echo The boss has been defeated!",loseCommand:"/echo The boss was too powerful...",mainTitle:"Death Knight",images:[{imagePath:"images/boss_battle.jpeg",stageMessage:"The boss towers before you!"},{imagePath:"images/boss_battle.jpeg",stageMessage:"You find an opening!"},{imagePath:"images/boss_battle.jpeg",stageMessage:"The boss staggers!"},{imagePath:"images/boss_battle.jpeg",stageMessage:"Keep attacking!"},{imagePath:"images/boss_battle.jpeg",stageMessage:"One more hit!"},{imagePath:"images/boss_battle.jpeg",stageMessage:"VICTORY!"}],keyDropChance:50,powDropChance:30,stealthDropChance:20}};function ie(e){return e?e.startsWith("/")||e.startsWith("http")?e:"/scripts/extensions/third-party/".concat(o,"/").concat(e):""}const se={herald:{name:"Herald",imagePath:"images/herald.jpeg",type:"messenger",description:"A mysterious messenger cloaked in shadow who delivers cryptic warnings and hints about the maze ahead.",messages:["Greetings, traveler!","The maze master watches...","Beware what lies ahead!"],encounterScript:""},guardian:{name:"Guardian",imagePath:"images/guardian.jpeg",type:"battlebar",description:"A fearsome armored warrior who blocks the path, challenging all who dare to pass.",battlebarProfiles:["Easy Fight"],messages:["You shall not pass!","Prepare to fight!","Only the worthy may continue!"],encounterScript:""},fortune_teller:{name:"Fortune Teller",imagePath:"images/fortune_teller.jpeg",type:"prizewheel",description:"An enigmatic mystic with glowing eyes who offers to reveal your fate through a magical spinning wheel.",wheelProfiles:["Reward Wheel"],messages:["Spin the wheel of fate!","Let destiny decide!","What fortune awaits you?"],encounterScript:""},trader:{name:"Wandering Trader",imagePath:"images/merchant.jpeg",type:"merchant",description:"A cunning merchant draped in exotic fabrics who trades valuable items for powerful rewards.",merchantItemCount:{min:2,max:4},messages:["Care to make a trade?","I have something special...","A fair exchange benefits us both!"],encounterScript:""}},re={spike_trap:{name:"Spike Trap",imagePath:"images/spike_trap.jpg",message:"Sharp spikes shoot up from the floor!",script:"/echo You triggered a spike trap!"},poison_gas:{name:"Poison Gas",imagePath:"images/poison_trap.jpeg",message:"A cloud of noxious gas fills the corridor!",script:"/echo Poison gas surrounds you!"}},le={"Dungeon Crawl":{herald:{name:"Herald",imagePath:"images/herald.jpeg",type:"messenger",description:"A mysterious messenger cloaked in shadow who delivers cryptic warnings and hints about the maze ahead.",messages:["Greetings, traveler!","The maze master watches...","Beware what lies ahead!"],encounterScript:""},guardian:{name:"Guardian",imagePath:"images/guardian.jpeg",type:"battlebar",description:"A fearsome armored warrior who blocks the path, challenging all who dare to pass.",battlebarProfiles:["Easy Fight"],messages:["You shall not pass!","Prepare to fight!","Only the worthy may continue!"],encounterScript:""},fortune_teller:{name:"Fortune Teller",imagePath:"images/fortune_teller.jpeg",type:"prizewheel",description:"An enigmatic mystic with glowing eyes who offers to reveal your fate through a magical spinning wheel.",wheelProfiles:["Reward Wheel"],messages:["Spin the wheel of fate!","Let destiny decide!","What fortune awaits you?"],encounterScript:""},trader:{name:"Wandering Trader",imagePath:"images/merchant.jpeg",type:"merchant",description:"A cunning merchant draped in exotic fabrics who trades valuable items for powerful rewards.",merchantItemCount:{min:2,max:4},messages:["Care to make a trade?","I have something special...","A fair exchange benefits us both!"],encounterScript:""}}},ce={"Dungeon Crawl":{spike_trap:{name:"Spike Trap",imagePath:"images/spike_trap.jpg",message:"Sharp spikes shoot up from the floor!",script:"/echo You triggered a spike trap!"},poison_gas:{name:"Poison Gas",imagePath:"images/poison_trap.jpeg",message:"A cloud of noxious gas fills the corridor!",script:"/echo Poison gas surrounds you!"}}},me={"Dungeon Crawl":{gridSize:10,winCommand:"/echo Congratulations! You escaped the dungeon!",loseCommand:"/echo The dungeon claims another victim...",winMessage:"You found the exit and escaped!",winImage:"",mainMinion:"guardian",mainMinionIntroMessage:"Welcome to my dungeon, adventurer. Find the exit... if you can!",mainMinionRandomChance:20,mainMinionRandomMessages:["Still wandering, I see...","The exit grows ever closer... or does it?","Many have tried. Few have succeeded.","Your persistence is... admirable."],mainMinionExitType:"battlebar",mainMinionExitProfile:"Boss Battle",minionEncounters:[{minionId:"herald",percent:15},{minionId:"guardian",percent:10},{minionId:"fortune_teller",percent:8},{minionId:"trader",percent:3}],trapEncounters:[{trapId:"spike_trap",percent:4},{trapId:"poison_gas",percent:3}],onBattlebarLoss:"respawn",chestImage:"",chestTilePercent:15,chestLockedPercent:30,chestLockedBonusPercent:50,chestMimicPercent:15,chestLootMin:1,chestLootMax:3,chestKeyChance:35,chestPowChance:45,chestStealthChance:15,chestGrandpowChance:2,lockedChestKeyChance:25,lockedChestPowChance:55,lockedChestStealthChance:25,lockedChestGrandpowChance:8,startingInventory:{key:1,pow:0,stealth:1,grandpow:0},storyConfig:{mainStory:"You descend into the ancient dungeon. Shadows dance on the walls as torchlight flickers...",milestones:[{percent:25,storyUpdate:"You venture deeper. The air grows colder and the walls damper."},{percent:50,storyUpdate:"Halfway through! Strange sounds echo from the darkness ahead."},{percent:75,storyUpdate:"You sense the exit is near. But so is something else..."}]}}};let de={},pe={segments:[],isOpen:!1,isSpinning:!1,pendingRespin:!1,hasRespun:!1},ue={isOpen:!1,profile:null,hits:0,misses:0,arrowPosition:0,arrowDirection:1,zoneStart:0,zoneEnd:0,animationId:null,lastFrameTime:0,isVictory:!1,isDefeat:!1},he={isOpen:!1,profile:null,profileName:null,grid:[],size:10,playerX:0,playerY:0,exitX:0,exitY:0,visited:new Set,isVictory:!1,currentMinion:null,isPaused:!1,pendingEncounter:null,exitEncounterDone:!1,currentFloor:0,totalFloors:1,floors:[],inventory:{key:0,stealth:0,pow:0,grandpow:0,floorKey:0,portalStone:0,minionBane:0,mapFragment:0,timeShard:0,voidWalk:0},pendingConfirmation:null,pendingChest:null,voidWalkActive:!1,messageLog:[]};const ge={wheel:{},battlebar:{},maze:{}},fe=new WeakSet;async function ve(e){const{minionName:t,minionDescription:n,baseMessage:a,mainStory:o,currentMilestone:i,minionType:s}=e;if(!a)return"";if(!1===de.llmEnabled)return console.log("[MazeMaster] LLM generation disabled, using base message"),a;if("function"!=typeof h)return console.log("[MazeMaster] generateQuietPrompt not available, using base message"),a;let r=[];o&&r.push("Story Setting: ".concat(o)),i&&r.push("Current Progress: ".concat(i));const l=n||{messenger:"a mysterious messenger who delivers cryptic hints",battlebar:"a guardian who challenges travelers to combat",prizewheel:"a fortune teller who offers games of chance",merchant:"a wandering trader who barters for rare items"}[s]||"a mysterious figure",c=A(),m="You are ".concat(t,", ").concat(l,".\nThe player's name is ").concat(c,".\n\n").concat(r.length>0?r.join("\n")+"\n\n":"",'The player has encountered you in a maze. Based on this message template: "').concat(a,'"\n\nWrite a short, atmospheric response (1-2 sentences max, under 100 characters if possible). Stay in character. Be mysterious and engaging. You may address the player by name if appropriate. Do not use quotation marks around your response.');try{console.log("[MazeMaster] Generating LLM message for:",t);const e=await h(m,{quietToLoud:!1,skipWIAN:!0,skipWI:!0,max_length:80});if(e&&e.trim()){let t=e.trim();return t=t.replace(/^["']|["']$/g,""),t=t.replace(/^["""''']|["""''']$/g,""),console.log("[MazeMaster] Generated message:",t),t}}catch(e){console.error("[MazeMaster] LLM generation failed:",e)}return a}function be(){var e;if(!he.isOpen||!he.profile)return null;const t=he.profile.storyConfig;if(!t||!t.milestones||0===t.milestones.length)return null;const n=he.size*he.size,a=((null===(e=he.visited)||void 0===e?void 0:e.size)||0)/n*100;let o=null;for(const e of t.milestones)a>=e.percent&&(o=e.storyUpdate);return o}function ye(){var e;return he.isOpen&&he.profile&&(null===(e=he.profile.storyConfig)||void 0===e?void 0:e.mainStory)||null}function ze(){return Object.keys(de.profiles||{})}function xe(e){return de.profiles[e]}function we(){return Object.keys(de.battlebarProfiles||{})}function _e(e){return de.battlebarProfiles[e]}function Se(e,t){var n,a,o;de.battlebarProfiles[e]={mainTitle:t.mainTitle||"",description:t.description||"",difficulty:t.difficulty||3,hitsToWin:t.hitsToWin||5,missesToLose:t.missesToLose||3,hitCommand:t.hitCommand||"",missCommand:t.missCommand||"",winCommand:t.winCommand||"",loseCommand:t.loseCommand||"",images:t.images||[],keyDropChance:null!==(n=t.keyDropChance)&&void 0!==n?n:40,powDropChance:null!==(a=t.powDropChance)&&void 0!==a?a:20,stealthDropChance:null!==(o=t.stealthDropChance)&&void 0!==o?o:10},i(),console.log("[MazeMaster] Battlebar profile saved:",e,de.battlebarProfiles[e])}function ke(){return Object.keys(de.mazeProfiles||{})}function Me(e){return de.mazeProfiles[e]}function Ee(e,t){de.mazeProfiles[e]={gridSize:t.gridSize||10,winCommand:t.winCommand||"",winImage:t.winImage||"",winMessage:t.winMessage||"",mainMinion:t.mainMinion||"",mainMinionIntroMessage:t.mainMinionIntroMessage||"",mainMinionRandomChance:t.mainMinionRandomChance||15,mainMinionRandomMessages:t.mainMinionRandomMessages||[],mainMinionExitType:t.mainMinionExitType||"messenger",mainMinionExitProfile:t.mainMinionExitProfile||"",minionEncounters:t.minionEncounters||[],onBattlebarLoss:t.onBattlebarLoss||"continue",loseCommand:t.loseCommand||"",chestImage:t.chestImage||"",chestTilePercent:t.chestTilePercent||10,chestLockedPercent:t.chestLockedPercent||30,chestLockedBonusPercent:t.chestLockedBonusPercent||50,chestMimicPercent:t.chestMimicPercent||15,chestLootMin:t.chestLootMin||1,chestLootMax:t.chestLootMax||2,chestKeyChance:t.chestKeyChance||30,chestPowChance:t.chestPowChance||50,chestStealthChance:t.chestStealthChance||0,lockedChestKeyChance:t.lockedChestKeyChance||40,lockedChestPowChance:t.lockedChestPowChance||60,lockedChestStealthChance:t.lockedChestStealthChance||30,chestGrandpowChance:t.chestGrandpowChance||0,lockedChestGrandpowChance:t.lockedChestGrandpowChance||5,startingInventory:t.startingInventory||{key:0,stealth:0,pow:0,grandpow:0},trapEncounters:t.trapEncounters||[],storyConfig:t.storyConfig||{mainStory:"",milestones:[]}},i(),console.log("[MazeMaster] Maze profile saved:",e,de.mazeProfiles[e])}function Ce(){return Object.keys(de.minions||{})}function Ie(e){return de.minions[e]}function Te(e,t){de.minions[e]={name:t.name||"Unknown",imagePath:t.imagePath||"",description:t.description||"",type:t.type||"messenger",battlebarProfiles:t.battlebarProfiles||[],wheelProfiles:t.wheelProfiles||[],messages:t.messages||[],encounterScript:t.encounterScript||"",merchantItemCount:t.merchantItemCount||{min:1,max:3},movement:t.movement||{type:"stationary",patrolRadius:3,chaseRange:5,speed:1}},i(),console.log("[MazeMaster] Minion saved:",e,de.minions[e])}function Pe(){return Object.keys(de.traps||{})}function Be(e){var t;return null===(t=de.traps)||void 0===t?void 0:t[e]}function Le(e,t){de.traps||(de.traps={}),de.traps[e]={name:t.name||"Unknown Trap",imagePath:t.imagePath||"",message:t.message||"You triggered a trap!",script:t.script||""},i(),console.log("[MazeMaster] Trap saved:",e,de.traps[e])}function je(e){const n=xe(e);return n&&n.segments&&0!==n.segments.length?(pe.segments=n.segments.map(((e,n)=>t(t({},e),{},{units:b[e.size]||1,color:v[n%v.length]}))),pe.isOpen=!1,pe.isSpinning=!1,pe.pendingRespin=!1,pe.hasRespun=!1,{success:!0,count:pe.segments.length}):{error:'Profile "'.concat(e,'" not found or empty')}}function Oe(){const e=pe.segments.filter((e=>"halfseg"===e.size)).length,t=pe.segments.filter((e=>"doubleseg"===e.size)).length;return e!==t?(console.error("[MazeMaster] Wheel balance error: ".concat(e," halfseg(s) but ").concat(t," doubleseg(s). They must be equal.")),{valid:!1,error:"Wheel unbalanced: ".concat(e," halfseg(s) ≠ ").concat(t," doubleseg(s)")}):{valid:!0}}function Ae(){return pe.segments.reduce(((e,t)=>e+t.units),0)}function De(){const e=document.getElementById("mazemaster_wheel_modal");if(e&&e.remove(),!document.getElementById("mazemaster_wheel_styles")){const e=document.createElement("style");e.id="mazemaster_wheel_styles",e.textContent="\n        .mazemaster-wheel-overlay {\n            position: fixed;\n            top: 0;\n            left: 0;\n            right: 0;\n            bottom: 0;\n            background: rgba(0, 0, 0, 0.95);\n            display: flex;\n            align-items: flex-start;\n            justify-content: center;\n            z-index: 10002;\n            overflow-y: auto;\n            padding: 10px 0;\n            -webkit-overflow-scrolling: touch;\n        }\n\n        .mazemaster-wheel-container {\n            position: relative;\n            display: flex;\n            flex-direction: column;\n            align-items: center;\n            gap: 20px;\n            padding: 25px;\n            margin: auto;\n            background: #1a1a2e;\n            border-radius: 15px;\n            border: 2px solid #333;\n            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);\n        }\n\n        .mazemaster-wheel-pointer {\n            position: absolute;\n            top: -20px;\n            left: 50%;\n            transform: translateX(-50%);\n            width: 0;\n            height: 0;\n            border-left: 15px solid transparent;\n            border-right: 15px solid transparent;\n            border-top: 30px solid #fff;\n            z-index: 10;\n            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));\n        }\n\n        #mazemaster_wheel_canvas {\n            border-radius: 50%;\n            box-shadow: 0 0 30px rgba(0,0,0,0.5), inset 0 0 20px rgba(255,255,255,0.1);\n            transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99);\n        }\n\n        .mazemaster-spin-btn {\n            padding: 15px 40px;\n            font-size: 1.2em;\n            font-weight: bold;\n            background: linear-gradient(135deg, #e74c3c, #c0392b);\n            color: white;\n            border: none;\n            border-radius: 30px;\n            cursor: pointer;\n            display: flex;\n            align-items: center;\n            gap: 10px;\n            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);\n            transition: transform 0.2s, box-shadow 0.2s;\n        }\n\n        .mazemaster-spin-btn:hover {\n            transform: scale(1.05);\n            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.6);\n        }\n\n        .mazemaster-spin-btn:disabled {\n            background: #555;\n            cursor: not-allowed;\n            box-shadow: none;\n            transform: none;\n        }\n\n        .mazemaster-spin-btn.respin {\n            background: linear-gradient(135deg, #f39c12, #d68910);\n            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.4);\n        }\n\n        .mazemaster-spin-btn.respin:hover {\n            box-shadow: 0 6px 20px rgba(243, 156, 18, 0.6);\n        }\n    ",document.head.appendChild(e)}const t=document.createElement("div");t.innerHTML='\n        <div id="mazemaster_wheel_modal" style="position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:999999;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.95);">\n            <div class="mazemaster-wheel-container">\n                <div class="mazemaster-wheel-pointer"></div>\n                <canvas id="mazemaster_wheel_canvas" width="400" height="400"></canvas>\n                <button id="mazemaster_spin_btn" class="mazemaster-spin-btn">\n                    <i class="fa-solid fa-play"></i> SPIN\n                </button>\n            </div>\n        </div>\n    ',document.body.appendChild(t.firstElementChild);const n=document.getElementById("mazemaster_wheel_canvas");n&&function(e){const t=e.getContext("2d"),n=e.width/2,a=e.height/2,o=Math.min(n,a)-10;t.clearRect(0,0,e.width,e.height);const i=Ae();let s=-Math.PI/2;for(const e of pe.segments){const r=e.units/i*2*Math.PI;t.beginPath(),t.moveTo(n,a),t.arc(n,a,o,s,s+r),t.closePath(),t.fillStyle=e.color,t.fill(),t.strokeStyle="#222",t.lineWidth=2,t.stroke();const l=s+r/2,c=.55*o,m=n+Math.cos(l)*c,d=a+Math.sin(l)*c;t.save(),t.translate(m,d),t.rotate(l),t.fillStyle="#fff",t.font="bold 12px Arial",t.textAlign="center",t.textBaseline="middle",t.shadowColor="rgba(0,0,0,0.5)",t.shadowBlur=3;let p=e.text||e.trigger;p.length>12&&(p=p.substring(0,10)+"..."),t.fillText(p,0,0),t.restore(),s+=r}t.beginPath(),t.arc(n,a,20,0,2*Math.PI),t.fillStyle="#333",t.fill(),t.strokeStyle="#555",t.lineWidth=3,t.stroke()}(n);const a=document.getElementById("mazemaster_spin_btn");a&&a.addEventListener("click",Re),pe.isOpen=!0}async function Re(){var e,t;const n=document.getElementById("mazemaster_spin_btn");if(!n||pe.isSpinning)return;n.disabled=!0,n.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> Spinning...',pe.isSpinning=!0,pe.pendingRespin=!1;const a=function(){const e=Ae();let t=Math.random()*e;for(const e of pe.segments)if(t-=e.units,t<=0)return e;return pe.segments[pe.segments.length-1]}(),o=document.getElementById("mazemaster_wheel_canvas");if(!o)return void(pe.isSpinning=!1);const i=Ae();let s=0;for(const e of pe.segments){if(e===a)break;s+=e.units/i*360}const r=s+a.units/i*360/2,l=5+Math.floor(3*Math.random()),c=parseFloat((null===(e=o.style.transform)||void 0===e||null===(e=e.match(/rotate\((\d+\.?\d*)deg\)/))||void 0===e?void 0:e[1])||0)+360*l+(360-r);o.style.transition="transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99)",o.style.transform="rotate(".concat(c,"deg)"),await new Promise((e=>setTimeout(e,4200))),pe.isSpinning=!1;const m=null===(t=de.profiles[de.currentProfile])||void 0===t||null===(t=t.segments)||void 0===t?void 0:t.find((e=>e.trigger===a.trigger));m&&m.command&&(console.log('[MazeMaster] Executing command for "'.concat(a.text,'": ').concat(m.command)),await L(m.command)),ge.wheel[de.currentProfile]={segmentName:a.text,command:(null==m?void 0:m.command)||"",timestamp:Date.now()},a.respin&&!pe.hasRespun?(pe.pendingRespin=!0,pe.hasRespun=!0,n.disabled=!1,n.className="mazemaster-spin-btn respin",n.innerHTML='<i class="fa-solid fa-rotate"></i> RESPIN'):(!function(){const e=document.getElementById("mazemaster_wheel_modal");if(e&&e.remove(),pe.isOpen=!1,he.isOpen&&he.pendingEncounter){const e=he.pendingEncounter.type;"exit_wheel"===e?(he.exitEncounterDone=!0,he.isPaused=!1,Jt()):"wheel"===e&&Tt()}}(),pe.segments=[],pe.isOpen=!1,pe.isSpinning=!1,pe.pendingRespin=!1,pe.hasRespun=!1)}function Fe(){s.addCommandObject(r.fromProps({name:"wheel",callback:async e=>{const t=e.profile||"default",n=je(t);if(n.error)return"Error: ".concat(n.error);const a=Oe();return a.valid?(de.currentProfile=t,De(),'Wheel "'.concat(t,'" opened with ').concat(n.count," segments. Click SPIN!")):"Error: ".concat(a.error)},namedArgumentList:[c.fromProps({name:"profile",description:"Name of the wheel profile to use",typeList:[l.STRING],isRequired:!1,defaultValue:"default"})],helpString:'Open a wheel by profile name. Example: /wheel profile="mywheel"'})),s.addCommandObject(r.fromProps({name:"battlebar",callback:async e=>{const t=e.profile||"default",n=Ne(t);return n.error?"Error: ".concat(n.error):'Battlebar "'.concat(t,'" started! Press SPACE when the arrow is in the green zone.')},namedArgumentList:[c.fromProps({name:"profile",description:"Name of the battlebar profile to use",typeList:[l.STRING],isRequired:!1,defaultValue:"default"})],helpString:'Start a battlebar challenge. Example: /battlebar profile="boss1"'})),s.addCommandObject(r.fromProps({name:"maze",callback:async e=>{const t=e.profile||de.currentMazeProfile||"default",n=vt(t);return n.error?"Error: ".concat(n.error):'Maze "'.concat(t,'" started! Use arrow keys to navigate.')},namedArgumentList:[c.fromProps({name:"profile",description:"Name of the maze profile to use",typeList:[l.STRING],isRequired:!1})],helpString:'Start a maze game. Example: /maze profile="dungeon1"'})),s.addCommandObject(r.fromProps({name:"mazeminion",callback:async e=>{if(!he.isOpen)return"No maze is currently open.";const t=e.name,n=e.message||"",a=Ie(t);return he.currentMinion=a?{name:a.name,imagePath:a.imagePath,message:n}:{name:t||"Unknown",imagePath:"",message:n},_t(),""},namedArgumentList:[c.fromProps({name:"name",description:"Minion name (from config) or custom name",typeList:[l.STRING],isRequired:!1}),c.fromProps({name:"message",description:"Message to display",typeList:[l.STRING],isRequired:!1})],helpString:'Set the minion display in an active maze. Example: /mazeminion name="Goblin" message="You shall not pass!"'})),s.addCommandObject(r.fromProps({name:"mazestats",callback:async()=>{var e,t,n,a,o,i,s,r;if(!he.isOpen)return JSON.stringify({error:"No maze is currently open."});const l={moves:(null===(e=he.stats)||void 0===e?void 0:e.moves)||0,encountersTotal:(null===(t=he.stats)||void 0===t?void 0:t.encountersTotal)||0,encountersWon:(null===(n=he.stats)||void 0===n?void 0:n.encountersWon)||0,chestsOpened:(null===(a=he.stats)||void 0===a?void 0:a.chestsOpened)||0,trapsTriggered:(null===(o=he.stats)||void 0===o?void 0:o.trapsTriggered)||0,teleportsUsed:(null===(i=he.stats)||void 0===i?void 0:i.teleportsUsed)||0,itemsCollected:(null===(s=he.stats)||void 0===s?void 0:s.itemsCollected)||{},exploration:F(),elapsedTime:R(),difficulty:(null===(r=he.profile)||void 0===r?void 0:r.difficulty)||"normal"};return JSON.stringify(l)},helpString:"Get current maze session statistics as JSON. Example: /mazestats"})),s.addCommandObject(r.fromProps({name:"mazeexplore",callback:async()=>{if(!he.isOpen)return"No maze is currently open.";const e=F();return String(e)},helpString:"Get current maze exploration percentage (0-100). Example: /mazeexplore"})),s.addCommandObject(r.fromProps({name:"mazeobjective",callback:async e=>{var t;if(!he.isOpen)return JSON.stringify({error:"No maze is currently open."});const n=(null===(t=he.profile)||void 0===t?void 0:t.objectives)||[],a=he.objectiveProgress||{};if(e.id){const t=n.find((t=>t.id===e.id));if(!t)return JSON.stringify({error:'Objective "'.concat(e.id,'" not found.')});const o=a[e.id]||{current:0,completed:!1};return JSON.stringify({id:t.id,type:t.type,target:t.target,description:t.description,current:o.current,required:t.count,completed:o.completed,isRequired:t.required})}{const e=n.map((e=>{const t=a[e.id]||{current:0,completed:!1};return{id:e.id,type:e.type,description:e.description,current:t.current,required:e.count,completed:t.completed,isRequired:e.required}}));return JSON.stringify(e)}},namedArgumentList:[c.fromProps({name:"id",description:"Specific objective ID to get (optional, returns all if omitted)",typeList:[l.STRING],isRequired:!1})],helpString:'Get maze objective progress. Example: /mazeobjective id="collect_keys" or /mazeobjective (for all)'})),s.addCommandObject(r.fromProps({name:"mazedifficulty",callback:async e=>{var t,n;const a=null===(t=e.tier)||void 0===t?void 0:t.toLowerCase(),o=["easy","normal","hard","nightmare"];if(!a){var i;const e=null===(i=de.mazeProfiles)||void 0===i?void 0:i[de.currentMazeProfile||"default"];return(null==e?void 0:e.difficulty)||"normal"}if(!o.includes(a))return"Error: Invalid difficulty tier. Valid options: ".concat(o.join(", "));const s=de.currentMazeProfile||"default";return null!==(n=de.mazeProfiles)&&void 0!==n&&n[s]?(de.mazeProfiles[s].difficulty=a,saveSettings(),'Difficulty set to "'.concat(a,'" for profile "').concat(s,'".')):'Error: Profile "'.concat(s,'" not found.')},namedArgumentList:[c.fromProps({name:"tier",description:"Difficulty tier: easy, normal, hard, or nightmare",typeList:[l.STRING],isRequired:!1})],helpString:'Get or set maze difficulty. Example: /mazedifficulty tier="hard" or /mazedifficulty (to get current)'})),s.addCommandObject(r.fromProps({name:"mazepersonastats",callback:async e=>{var t;const n=e.persona||A(),a=null===(t=de.mazeStats)||void 0===t||null===(t=t.personas)||void 0===t?void 0:t[n];return a?JSON.stringify({persona:n,totalGames:a.totalGames||0,wins:a.wins||0,losses:a.losses||0,totalMoves:a.totalMoves||0,bestTime:a.bestTime,profileStats:a.profileStats||{}}):JSON.stringify({error:'No stats found for persona "'.concat(n,'".')})},namedArgumentList:[c.fromProps({name:"persona",description:"Name of the persona to get stats for (default: current persona)",typeList:[l.STRING],isRequired:!1})],helpString:'Get maze stats for a specific persona. Example: /mazepersonastats persona="Alice"'})),s.addCommandObject(r.fromProps({name:"mazefloor",callback:async()=>he.isOpen?JSON.stringify({current:(he.currentFloor||0)+1,total:he.totalFloors||1}):JSON.stringify({error:"No maze is currently open."}),helpString:"Get current floor information in an active maze. Example: /mazefloor"})),s.addCommandObject(r.fromProps({name:"mazetheme",callback:async e=>{var t,n;const a=null===(t=e.theme)||void 0===t?void 0:t.toLowerCase(),o=["fantasy","horror","scifi","action"];if(!a){var i;const e=de.currentMazeProfile||"default",t=null===(i=de.mazeProfiles)||void 0===i?void 0:i[e];return(null==t?void 0:t.theme)||"fantasy"}if(!o.includes(a))return"Error: Invalid theme. Valid options: ".concat(o.join(", "));const s=de.currentMazeProfile||"default";return null!==(n=de.mazeProfiles)&&void 0!==n&&n[s]?(de.mazeProfiles[s].theme=a,saveSettings(),'Theme set to "'.concat(a,'" for profile "').concat(s,'".')):'Error: Profile "'.concat(s,'" not found.')},namedArgumentList:[c.fromProps({name:"theme",description:"Theme: fantasy, horror, scifi, or action",typeList:[l.STRING],isRequired:!1})],helpString:'Get or set maze theme. Example: /mazetheme theme="horror" or /mazetheme (to get current)'})),s.addCommandObject(r.fromProps({name:"mazemapstyle",callback:async e=>{var t,n;const a=null===(t=e.style)||void 0===t?void 0:t.toLowerCase(),o=["maze","dungeon","city","forest","spaceship"];if(!a){var i;const e=de.currentMazeProfile||"default",t=null===(i=de.mazeProfiles)||void 0===i?void 0:i[e];return(null==t?void 0:t.mapStyle)||"maze"}if(!o.includes(a))return"Error: Invalid map style. Valid options: ".concat(o.join(", "));const s=de.currentMazeProfile||"default";return null!==(n=de.mazeProfiles)&&void 0!==n&&n[s]?(de.mazeProfiles[s].mapStyle=a,saveSettings(),'Map style set to "'.concat(a,'" for profile "').concat(s,'".')):'Error: Profile "'.concat(s,'" not found.')},namedArgumentList:[c.fromProps({name:"style",description:"Map style: maze, dungeon, city, forest, or spaceship",typeList:[l.STRING],isRequired:!1})],helpString:'Get or set maze map style. Example: /mazemapstyle style="dungeon" or /mazemapstyle (to get current)'})),console.log("[MazeMaster] Slash commands registered")}function Ne(e){const t=_e(e);if(!t)return{error:'Battlebar profile "'.concat(e,'" not found')};const n=null===(a=he)||void 0===a||!a.inventory.timeShard||he.inventory.timeShard<=0?1:.5;var a;const o=n<1;return ue={isOpen:!0,profile:t,hits:0,misses:0,arrowPosition:0,arrowDirection:1,zoneStart:0,zoneEnd:0,animationId:null,lastFrameTime:0,isVictory:!1,isDefeat:!1,speedMultiplier:n},Ve(),function(){const e=document.getElementById("mazemaster_battlebar_modal");e&&e.remove();if(!document.getElementById("mazemaster_battlebar_styles")){const e=document.createElement("style");e.id="mazemaster_battlebar_styles",e.textContent="\n        .mazemaster-bb-overlay {\n            position: fixed;\n            top: 0;\n            left: 0;\n            right: 0;\n            bottom: 0;\n            background: rgba(0, 0, 0, 0.9);\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            z-index: 10010;\n        }\n\n        .mazemaster-bb-container {\n            display: flex;\n            flex-direction: column;\n            align-items: center;\n            gap: 15px;\n            padding: 25px;\n            background: #1a1a2e;\n            border-radius: 15px;\n            border: 2px solid #333;\n            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);\n            width: 450px;\n            max-width: 95vw;\n            overflow-y: auto;\n        }\n\n        .mazemaster-bb-main-title {\n            font-size: 32px;\n            font-weight: bold;\n            color: #fff;\n            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);\n            text-align: center;\n        }\n\n        .mazemaster-bb-stage-title {\n            font-size: 18px;\n            color: #aaa;\n            text-align: center;\n            min-height: 24px;\n            max-width: 100%;\n            word-wrap: break-word;\n            overflow-wrap: break-word;\n        }\n\n        .mazemaster-bb-image-display {\n            width: min(300px, 80vw);\n            height: min(300px, 40vh);\n            border: 3px solid #444;\n            border-radius: 10px;\n            overflow: hidden;\n            background: #222;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n        }\n\n        .mazemaster-bb-image-display img {\n            max-width: 100%;\n            max-height: 100%;\n            object-fit: contain;\n        }\n\n        .mazemaster-bb-stats {\n            display: flex;\n            gap: 30px;\n            font-size: 1.2em;\n            font-weight: bold;\n        }\n\n        .bb-stat-hits {\n            color: #27ae60;\n        }\n\n        .bb-stat-misses {\n            color: #e74c3c;\n        }\n\n        .mazemaster-bb-bar-container {\n            padding: 10px;\n        }\n\n        .mazemaster-bb-bar {\n            position: relative;\n            width: min(400px, 90vw);\n            height: 50px;\n            background: linear-gradient(to bottom, #c0392b, #a93226);\n            border-radius: 8px;\n            overflow: hidden;\n            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5), inset 0 2px 5px rgba(0, 0, 0, 0.3);\n        }\n\n        .mazemaster-bb-zone {\n            position: absolute;\n            height: 100%;\n            background: linear-gradient(to bottom, #27ae60, #1e8449);\n            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.2);\n        }\n\n        .mazemaster-bb-arrow {\n            position: absolute;\n            width: 6px;\n            height: 100%;\n            background: #fff;\n            box-shadow: 0 0 15px #fff, 0 0 30px rgba(255, 255, 255, 0.5);\n            left: 0;\n            transition: none;\n        }\n\n        .mazemaster-bb-instructions {\n            font-size: 1.1em;\n            color: #aaa;\n        }\n\n        .mazemaster-bb-instructions kbd {\n            background: #444;\n            padding: 5px 15px;\n            border-radius: 5px;\n            font-weight: bold;\n            color: #fff;\n            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);\n        }\n\n        .mazemaster-bb-bar.flash-hit {\n            animation: flashHit 0.3s ease;\n        }\n\n        .mazemaster-bb-bar.flash-miss {\n            animation: flashMiss 0.3s ease;\n        }\n\n        @keyframes flashHit {\n            0%, 100% { box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5); }\n            50% { box-shadow: 0 0 30px rgba(39, 174, 96, 0.8), 0 0 60px rgba(39, 174, 96, 0.5); }\n        }\n\n        @keyframes flashMiss {\n            0%, 100% { box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5); }\n            50% { box-shadow: 0 0 30px rgba(231, 76, 60, 0.8), 0 0 60px rgba(231, 76, 60, 0.5); }\n        }\n\n        .mazemaster-bb-hit-btn {\n            width: min(100%, 90vw);\n            max-width: 400px;\n            padding: 20px 30px;\n            font-size: 24px;\n            font-weight: bold;\n            background: linear-gradient(135deg, #27ae60, #2ecc71);\n            color: white;\n            border: none;\n            border-radius: 12px;\n            cursor: pointer;\n            margin-top: 10px;\n            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);\n            transition: transform 0.1s ease, box-shadow 0.1s ease;\n            touch-action: manipulation;\n            -webkit-tap-highlight-color: transparent;\n        }\n\n        .mazemaster-bb-hit-btn:hover {\n            transform: scale(1.02);\n            box-shadow: 0 8px 25px rgba(39, 174, 96, 0.5);\n        }\n\n        .mazemaster-bb-hit-btn:active {\n            transform: scale(0.98);\n            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);\n        }\n\n        .mazemaster-bb-hit-btn i {\n            margin-right: 10px;\n        }\n\n        .mazemaster-bb-hit-btn.victory {\n            background: linear-gradient(135deg, #f39c12, #e67e22);\n            box-shadow: 0 6px 20px rgba(243, 156, 18, 0.4);\n        }\n\n        .mazemaster-bb-hit-btn.victory:hover {\n            box-shadow: 0 8px 25px rgba(243, 156, 18, 0.5);\n        }\n\n        .mazemaster-bb-hit-btn.defeat {\n            background: linear-gradient(135deg, #c0392b, #e74c3c);\n            box-shadow: 0 6px 20px rgba(192, 57, 43, 0.4);\n        }\n\n        .mazemaster-bb-hit-btn.defeat:hover {\n            box-shadow: 0 8px 25px rgba(192, 57, 43, 0.5);\n        }\n    ",document.head.appendChild(e)}const t=document.createElement("div");t.innerHTML='\n        <div id="mazemaster_battlebar_modal" style="position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:999999;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.9);">\n            <div class="mazemaster-bb-container">\n                <div id="bb_main_title" class="mazemaster-bb-main-title"></div>\n                <div class="mazemaster-bb-image-display">\n                    <img id="mazemaster_bb_img" src="" alt="">\n                </div>\n                <div id="bb_stage_title" class="mazemaster-bb-stage-title"></div>\n                <div class="mazemaster-bb-stats">\n                    <span class="bb-stat bb-stat-hits">\n                        Hits: <span id="bb_current_hits">0</span>/<span id="bb_needed_hits">5</span>\n                    </span>\n                    <span class="bb-stat bb-stat-misses">\n                        Misses: <span id="bb_current_misses">0</span>/<span id="bb_max_misses">3</span>\n                    </span>\n                </div>\n                <div class="mazemaster-bb-bar-container">\n                    <div class="mazemaster-bb-bar">\n                        <div class="mazemaster-bb-zone" id="bb_zone"></div>\n                        <div class="mazemaster-bb-arrow" id="bb_arrow"></div>\n                    </div>\n                </div>\n                <div class="mazemaster-bb-instructions">\n                    Press <kbd>SPACE</kbd> when the arrow is in the green zone!\n                </div>\n                <div class="mazemaster-bb-action-buttons">\n                    <button id="mazemaster_bb_hit_btn" class="mazemaster-bb-hit-btn">\n                        <i class="fa-solid fa-bullseye"></i> HIT!\n                    </button>\n                    <button id="mazemaster_bb_pow_btn" class="mazemaster-bb-pow-btn" style="display: none;">\n                        <i class="fa-solid fa-bolt"></i> POW! (<span id="bb_pow_count">0</span>)\n                    </button>\n                    <button id="mazemaster_bb_grandpow_btn" class="mazemaster-bb-grandpow-btn" style="display: none;">\n                        <i class="fa-solid fa-star"></i> GRANDPOW! (<span id="bb_grandpow_count">0</span>)\n                    </button>\n                </div>\n            </div>\n        </div>\n    ',document.body.appendChild(t.firstElementChild),Ze(),Je(),Qe(),We();const n=document.getElementById("mazemaster_bb_hit_btn");n&&(n.addEventListener("click",qe),n.addEventListener("touchend",(e=>{e.preventDefault(),qe(e)})));const a=document.getElementById("mazemaster_bb_pow_btn");a&&a.addEventListener("click",Ge);const o=document.getElementById("mazemaster_bb_grandpow_btn");o&&o.addEventListener("click",Ke);He(),Ue()}(),function(){const e=z[ue.profile.difficulty||3],t=100/e.traverseTime*(ue.speedMultiplier||1);function n(e){if(!ue.isOpen)return;0===ue.lastFrameTime&&(ue.lastFrameTime=e);const a=e-ue.lastFrameTime;ue.lastFrameTime=e,ue.arrowPosition+=t*a*ue.arrowDirection,ue.arrowPosition>=100?(ue.arrowPosition=100,ue.arrowDirection=-1):ue.arrowPosition<=0&&(ue.arrowPosition=0,ue.arrowDirection=1),function(){const e=document.getElementById("bb_arrow");e&&(e.style.left="".concat(ue.arrowPosition,"%"))}(),ue.animationId=requestAnimationFrame(n)}ue.lastFrameTime=0,ue.animationId=requestAnimationFrame(n)}(),document.addEventListener("keydown",$e),o&&async function(){var e;(null===(e=he)||void 0===e?void 0:e.inventory.timeShard)>0&&(await Lt("timeShard",1),he.currentMinion={name:"Time Shard",imagePath:"",message:"Time slows around you... The battlebar moves at half speed!"},_t())}(),{success:!0}}function We(){const e=ue.profile||{},t=document.getElementById("bb_main_title");t&&(t.textContent=e.mainTitle||"");const n=document.getElementById("bb_stage_title");if(n){const t=(e.images||[])[ue.hits||0];n.textContent=(null==t?void 0:t.stageMessage)||""}}function qe(e){if(e.preventDefault(),!ue.isOpen)return;if(ue.isVictory||ue.isDefeat)return void Xe();const t=ue.arrowPosition>=ue.zoneStart&&ue.arrowPosition<=ue.zoneEnd;console.log("[MazeMaster] Hit check:",{arrowPosition:ue.arrowPosition,zoneStart:ue.zoneStart,zoneEnd:ue.zoneEnd,inZone:t}),t?et():tt()}function He(){const e=document.getElementById("mazemaster_bb_pow_btn"),t=document.getElementById("bb_pow_count");e&&he.isOpen&&he.inventory.pow>0?(e.style.display="",t&&(t.textContent=he.inventory.pow)):e&&(e.style.display="none")}function Ge(e){e.preventDefault(),!he.isOpen||he.inventory.pow<=0||ue.isOpen&&(ue.isVictory||ue.isDefeat||(Lt("pow"),He(),ue.hits++,updateBattlebarDisplay(),ue.hits>=ue.profile.hitsToWin&&nt()))}function Ye(){return he.pendingEncounter&&"exit_battlebar"===he.pendingEncounter.type}function Ue(){const e=document.getElementById("mazemaster_bb_grandpow_btn"),t=document.getElementById("bb_grandpow_count");e&&he.isOpen&&he.inventory.grandpow>0&&!Ye()?(e.style.display="",t&&(t.textContent=he.inventory.grandpow)):e&&(e.style.display="none")}function Ke(e){e.preventDefault(),!he.isOpen||he.inventory.grandpow<=0||ue.isOpen&&(ue.isVictory||ue.isDefeat||(Ye()?console.log("[MazeMaster] GRANDPOW cannot be used against the main minion!"):(Lt("grandpow"),Ue(),ue.hits=ue.profile.hitsToWin,updateBattlebarDisplay(),nt())))}function Xe(){const e=ue.isVictory,t=ue.isDefeat;ue.animationId&&cancelAnimationFrame(ue.animationId),document.removeEventListener("keydown",$e);const n=document.getElementById("mazemaster_battlebar_modal");if(n&&n.remove(),ue.isOpen=!1,ue.isVictory=!1,ue.isDefeat=!1,he.isOpen&&he.pendingEncounter){const n=he.pendingEncounter.type;if(e)"exit_battlebar"===n?(he.exitEncounterDone=!0,he.isPaused=!1,Jt()):Tt();else if(t){const e=he.profile.onBattlebarLoss||"continue";if("exit_battlebar"===n)"gameover"===e?Xt():Vt();else switch(e){case"gameover":Xt();break;case"respawn":Vt();break;default:Tt()}}}}function Ve(){const e=ue.profile.difficulty||3,t=z[e];if(!t)return void console.error("[MazeMaster] Invalid difficulty level:",e);const n=100*t.zoneWidth,a=100-n;ue.zoneStart=Math.random()*a,ue.zoneEnd=ue.zoneStart+n,console.log("[MazeMaster] Zone randomized:",{difficulty:e,zoneWidth:n,zoneStart:ue.zoneStart,zoneEnd:ue.zoneEnd})}function Je(){const e=document.getElementById("bb_zone");e&&(e.style.left="".concat(ue.zoneStart,"%"),e.style.width="".concat(ue.zoneEnd-ue.zoneStart,"%"))}function Ze(){const e=document.getElementById("bb_current_hits"),t=document.getElementById("bb_needed_hits"),n=document.getElementById("bb_current_misses"),a=document.getElementById("bb_max_misses");e&&(e.textContent=ue.hits),t&&(t.textContent=ue.profile.hitsToWin||5),n&&(n.textContent=ue.misses),a&&(a.textContent=ue.profile.missesToLose||3)}function Qe(){const e=document.getElementById("mazemaster_bb_img");if(!e)return;const t=ue.profile.images||[];if(0===t.length)return void(e.style.display="none");const n=t[Math.min(ue.hits,t.length-1)],a=n.imagePath||n.path||"";a?(e.src=ie(a),e.style.display="block"):e.style.display="none"}function $e(e){if("Space"!==e.code||!ue.isOpen)return;if(e.preventDefault(),ue.isVictory||ue.isDefeat)return void Xe();ue.arrowPosition>=ue.zoneStart&&ue.arrowPosition<=ue.zoneEnd?et():tt()}async function et(){ue.hits++;const e=document.querySelector(".mazemaster-bb-bar");e&&(e.classList.remove("flash-hit","flash-miss"),e.offsetWidth,e.classList.add("flash-hit")),Ze(),Qe(),We(),ue.profile.hitCommand&&await L(ue.profile.hitCommand),ue.hits>=(ue.profile.hitsToWin||5)?await nt():(Ve(),Je())}async function tt(){ue.misses++;const e=document.querySelector(".mazemaster-bb-bar");e&&(e.classList.remove("flash-hit","flash-miss"),e.offsetWidth,e.classList.add("flash-miss")),Ze(),ue.profile.missCommand&&await L(ue.profile.missCommand),ue.misses>=(ue.profile.missesToLose||3)&&await async function(){const e=de.currentBattlebarProfile||"default";ge.battlebar[e]={result:"lose",hits:ue.hits,misses:ue.misses,timestamp:Date.now()},ue.isDefeat=!0,ue.animationId&&(cancelAnimationFrame(ue.animationId),ue.animationId=null);const t=document.querySelector(".mazemaster-bb-bar-container"),n=document.querySelector(".mazemaster-bb-instructions");t&&(t.style.display="none");n&&(n.style.display="none");const a=document.getElementById("bb_stage_title");a&&(a.textContent="Defeat...");const o=document.getElementById("mazemaster_bb_hit_btn");o&&(o.innerHTML='<i class="fa-solid fa-times"></i> Close',o.classList.add("defeat"));ue.profile.loseCommand&&await L(ue.profile.loseCommand)}()}async function nt(){const e=de.currentBattlebarProfile||"default";if(ge.battlebar[e]={result:"win",hits:ue.hits,misses:ue.misses,timestamp:Date.now()},ue.isVictory=!0,he.isOpen&&he.pendingEncounter){var t,n,a;const e=ue.profile;100*Math.random()<(null!==(t=e.keyDropChance)&&void 0!==t?t:40)&&Bt("key"),100*Math.random()<(null!==(n=e.powDropChance)&&void 0!==n?n:20)&&Bt("pow"),100*Math.random()<(null!==(a=e.stealthDropChance)&&void 0!==a?a:10)&&Bt("stealth")}ue.animationId&&(cancelAnimationFrame(ue.animationId),ue.animationId=null);const o=document.querySelector(".mazemaster-bb-bar-container"),i=document.querySelector(".mazemaster-bb-instructions");o&&(o.style.display="none"),i&&(i.style.display="none");const s=ue.profile.images||[],r=s.length>0?s[s.length-1]:null;if(r){const e=document.getElementById("mazemaster_bb_img");e&&(e.src="/"+r.path)}const l=document.getElementById("bb_stage_title");if(l){const e=(null==r?void 0:r.stageMessage)||"Victory!";l.textContent=e}const c=document.getElementById("mazemaster_bb_hit_btn");c&&(c.innerHTML='<i class="fa-solid fa-check"></i> Close',c.classList.add("victory")),ue.profile.winCommand&&await L(ue.profile.winCommand)}function at(e){const t=[];for(let n=0;n<e;n++){t[n]=[];for(let a=0;a<e;a++)t[n][a]={walls:{top:!0,right:!0,bottom:!0,left:!0},visited:!1,minion:null,trap:null}}const n=[];let a={x:0,y:0};function o(n,a){const o=[];return a>0&&!t[a-1][n].visited&&o.push({x:n,y:a-1,dir:"top"}),n<e-1&&!t[a][n+1].visited&&o.push({x:n+1,y:a,dir:"right"}),a<e-1&&!t[a+1][n].visited&&o.push({x:n,y:a+1,dir:"bottom"}),n>0&&!t[a][n-1].visited&&o.push({x:n-1,y:a,dir:"left"}),o}for(t[0][0].visited=!0;;){const e=o(a.x,a.y);if(e.length>0){const o=e[Math.floor(Math.random()*e.length)];n.push(a),"top"===o.dir?(t[a.y][a.x].walls.top=!1,t[o.y][o.x].walls.bottom=!1):"right"===o.dir?(t[a.y][a.x].walls.right=!1,t[o.y][o.x].walls.left=!1):"bottom"===o.dir?(t[a.y][a.x].walls.bottom=!1,t[o.y][o.x].walls.top=!1):"left"===o.dir&&(t[a.y][a.x].walls.left=!1,t[o.y][o.x].walls.right=!1),a={x:o.x,y:o.y},t[a.y][a.x].visited=!0}else{if(!(n.length>0))break;a=n.pop()}}!function(e,t){const n=Math.floor(t*t*.08);for(let a=0;a<n;a++){pt(e,1+Math.floor(Math.random()*(t-2)),1+Math.floor(Math.random()*(t-2)),["top","right","bottom","left"][Math.floor(4*Math.random())],t)}}(t,e);for(let n=0;n<e;n++)for(let a=0;a<e;a++)t[n][a].visited=!1;return t}function ot(e){const t=[];for(let n=0;n<e;n++){t[n]=[];for(let a=0;a<e;a++)t[n][a]={walls:{top:!0,right:!0,bottom:!0,left:!0},visited:!1,minion:null,trap:null}}const n=Math.max(3,Math.floor(e/4));for(let a=0;a<e;a++)if(a%n===1||0===a||a===e-1)for(let n=0;n<e-1;n++)t[a][n].walls.right=!1,t[a][n+1].walls.left=!1;for(let a=0;a<e;a++)if(a%n===1||0===a||a===e-1)for(let n=0;n<e-1;n++)t[n][a].walls.bottom=!1,t[n+1][a].walls.top=!1;for(let n=0;n<e-1;n++)for(let a=0;a<e-1;a++)if(Math.random()<.2){"right"===(Math.random()<.5?"right":"bottom")?(t[n][a].walls.right=!1,t[n][a+1].walls.left=!1):(t[n][a].walls.bottom=!1,t[n+1][a].walls.top=!1)}return dt(t,e,0,0,e-1,e-1),t}function it(e){const t=[];for(let n=0;n<e;n++){t[n]=[];for(let a=0;a<e;a++)t[n][a]={walls:{top:!0,right:!0,bottom:!0,left:!0},visited:!1,minion:null,trap:null}}const n=[],a=Math.max(3,Math.floor(e/3));for(let o=0;o<2*e;o++){const o=2+Math.floor(Math.random()*(a-2+1)),i=2+Math.floor(Math.random()*(a-2+1)),s=Math.floor(Math.random()*(e-o)),r=Math.floor(Math.random()*(e-i));let l=!0;for(const e of n)if(s<e.x+e.w+1&&s+o+1>e.x&&r<e.y+e.h+1&&r+i+1>e.y){l=!1;break}if(l){n.push({x:s,y:r,w:o,h:i});for(let e=r;e<r+i;e++)for(let n=s;n<s+o;n++)n<s+o-1&&(t[e][n].walls.right=!1,t[e][n+1].walls.left=!1),e<r+i-1&&(t[e][n].walls.bottom=!1,t[e+1][n].walls.top=!1)}}n.some((e=>e.x<=1&&e.y<=1))||(n.unshift({x:0,y:0,w:2,h:2}),t[0][0].walls.right=!1,t[0][1].walls.left=!1,t[1][0].walls.right=!1,t[1][1].walls.left=!1,t[0][0].walls.bottom=!1,t[1][0].walls.top=!1);for(let a=0;a<n.length-1;a++){mt(t,e,n[a],n[a+1])}return n.length>2&&mt(t,e,n[n.length-1],n[0]),dt(t,e,0,0,e-1,e-1),t}function st(e,t){switch(t){case"city":case"neotokyo":case"college":case"apartment":case"hospital":case"highrise":return ot(e);case"forest":return function(e){const t=[];for(let n=0;n<e;n++){t[n]=[];for(let a=0;a<e;a++)t[n][a]={walls:{top:!0,right:!0,bottom:!0,left:!0},visited:!1,minion:null,trap:null}}let n=0,a=0;const o=new Set(["0,0"]),i=[{x:0,y:0}];for(t[0][0].visited=!0;n!==e-1||a!==e-1;){const s=[];a>0&&s.push({dx:0,dy:-1,weight:.1}),n<e-1&&s.push({dx:1,dy:0,weight:.4}),a<e-1&&s.push({dx:0,dy:1,weight:.4}),n>0&&s.push({dx:-1,dy:0,weight:.1});const r=s.filter((t=>{const o=n+t.dx,i=a+t.dy;return o>=0&&o<e&&i>=0&&i<e}));if(0===r.length)break;const l=r.reduce(((e,t)=>e+t.weight),0);let c=Math.random()*l,m=r[0];for(const e of r)if(c-=e.weight,c<=0){m=e;break}const d=n+m.dx,p=a+m.dy;1===m.dx&&(t[a][n].walls.right=!1,t[p][d].walls.left=!1),-1===m.dx&&(t[a][n].walls.left=!1,t[p][d].walls.right=!1),1===m.dy&&(t[a][n].walls.bottom=!1,t[p][d].walls.top=!1),-1===m.dy&&(t[a][n].walls.top=!1,t[p][d].walls.bottom=!1),n=d,a=p,o.add("".concat(n,",").concat(a)),i.push({x:n,y:a}),t[a][n].visited=!0}const s=Math.floor(.8*e);for(let n=0;n<s;n++){const n=i[Math.floor(Math.random()*i.length)];rt(t,e,n.x,n.y,Math.floor(e/2))}const r=Math.floor(e/5);for(let n=0;n<r;n++)lt(t,1+Math.floor(Math.random()*(e-2)),1+Math.floor(Math.random()*(e-2)));for(let n=0;n<e;n++)for(let a=0;a<e;a++)t[n][a].visited=!1;return dt(t,e,0,0,e-1,e-1),t}(e);case"spaceship":case"spacestation":return function(e){const t=[];for(let n=0;n<e;n++){t[n]=[];for(let a=0;a<e;a++)t[n][a]={walls:{top:!0,right:!0,bottom:!0,left:!0},visited:!1,minion:null,trap:null}}const n=[],a=Math.max(4,Math.floor(e*e/20));for(let o=0;o<3*a&&!(n.length>=a);o++){const a=Math.random()<.5?2:3,o=Math.floor(Math.random()*(e-a)),i=Math.floor(Math.random()*(e-a));let s=!1;for(const e of n)if(o<e.x+e.size+1&&o+a+1>e.x&&i<e.y+e.size+1&&i+a+1>e.y){s=!0;break}if(!s){n.push({x:o,y:i,size:a});for(let e=0;e<a;e++)for(let n=0;n<a;n++)n<a-1&&(t[i+e][o+n].walls.right=!1,t[i+e][o+n+1].walls.left=!1),e<a-1&&(t[i+e][o+n].walls.bottom=!1,t[i+e+1][o+n].walls.top=!1)}}n.some((e=>0===e.x&&0===e.y))||(n.unshift({x:0,y:0,size:2}),t[0][0].walls.right=!1,t[0][1].walls.left=!1,t[1][0].walls.right=!1,t[1][1].walls.left=!1,t[0][0].walls.bottom=!1,t[1][0].walls.top=!1,t[0][1].walls.bottom=!1,t[1][1].walls.top=!1);for(let a=0;a<n.length-1;a++)ct(t,e,n[a],n[a+1]);return n.length>2&&ct(t,e,n[n.length-1],n[0]),dt(t,e,0,0,e-1,e-1),t}(e);case"dungeon":case"outpost":case"arena":return it(e);default:return at(e)}}function rt(e,t,n,a,o){let i=n,s=a;for(let n=0;n<o;n++){const n=[];if(s>0&&n.push({dx:0,dy:-1}),i<t-1&&n.push({dx:1,dy:0}),s<t-1&&n.push({dx:0,dy:1}),i>0&&n.push({dx:-1,dy:0}),0===n.length)break;const a=n[Math.floor(Math.random()*n.length)],o=i+a.dx,r=s+a.dy;1===a.dx&&(e[s][i].walls.right=!1,e[r][o].walls.left=!1),-1===a.dx&&(e[s][i].walls.left=!1,e[r][o].walls.right=!1),1===a.dy&&(e[s][i].walls.bottom=!1,e[r][o].walls.top=!1),-1===a.dy&&(e[s][i].walls.top=!1,e[r][o].walls.bottom=!1),i=o,s=r}}function lt(e,t,n){t>0&&n>0&&t<e[0].length-1&&n<e.length-1&&(e[n][t].walls.right=!1,e[n][t+1].walls.left=!1,e[n+1][t].walls.right=!1,e[n+1][t+1].walls.left=!1,e[n][t].walls.bottom=!1,e[n+1][t].walls.top=!1,e[n][t+1].walls.bottom=!1,e[n+1][t+1].walls.top=!1)}function ct(e,t,n,a){const o=Math.floor(n.x+n.size/2),i=Math.floor(n.y+n.size/2),s=Math.floor(a.x+a.size/2),r=Math.floor(a.y+a.size/2);let l=o,c=i;for(;l!==s;){const n=l<s?l+1:l-1;if(!(n>=0&&n<t))break;l<s?(e[c][l].walls.right=!1,e[c][n].walls.left=!1):(e[c][l].walls.left=!1,e[c][n].walls.right=!1),l=n}for(;c!==r;){const n=c<r?c+1:c-1;if(!(n>=0&&n<t))break;c<r?(e[c][l].walls.bottom=!1,e[n][l].walls.top=!1):(e[c][l].walls.top=!1,e[n][l].walls.bottom=!1),c=n}}function mt(e,t,n,a){const o=Math.floor(n.x+n.w/2),i=Math.floor(n.y+n.h/2),s=Math.floor(a.x+a.w/2),r=Math.floor(a.y+a.h/2);let l=o,c=i;if(Math.random()<.5){for(;l!==s;){const n=l<s?l+1:l-1;if(!(n>=0&&n<t))break;l<s?(e[c][l].walls.right=!1,e[c][n].walls.left=!1):(e[c][l].walls.left=!1,e[c][n].walls.right=!1),l=n}for(;c!==r;){const n=c<r?c+1:c-1;if(!(n>=0&&n<t))break;c<r?(e[c][l].walls.bottom=!1,e[n][l].walls.top=!1):(e[c][l].walls.top=!1,e[n][l].walls.bottom=!1),c=n}}else{for(;c!==r;){const n=c<r?c+1:c-1;if(!(n>=0&&n<t))break;c<r?(e[c][l].walls.bottom=!1,e[n][l].walls.top=!1):(e[c][l].walls.top=!1,e[n][l].walls.bottom=!1),c=n}for(;l!==s;){const n=l<s?l+1:l-1;if(!(n>=0&&n<t))break;l<s?(e[c][l].walls.right=!1,e[c][n].walls.left=!1):(e[c][l].walls.left=!1,e[c][n].walls.right=!1),l=n}}}function dt(e,t,n,a,o,i){const s=new Set(["".concat(n,",").concat(a)]),r=[{x:n,y:a}];for(;r.length>0;){const{x:n,y:a}=r.shift();if(n===o&&a===i)return;!e[a][n].walls.top&&a>0&&!s.has("".concat(n,",").concat(a-1))&&(s.add("".concat(n,",").concat(a-1)),r.push({x:n,y:a-1})),!e[a][n].walls.right&&n<t-1&&!s.has("".concat(n+1,",").concat(a))&&(s.add("".concat(n+1,",").concat(a)),r.push({x:n+1,y:a})),!e[a][n].walls.bottom&&a<t-1&&!s.has("".concat(n,",").concat(a+1))&&(s.add("".concat(n,",").concat(a+1)),r.push({x:n,y:a+1})),!e[a][n].walls.left&&n>0&&!s.has("".concat(n-1,",").concat(a))&&(s.add("".concat(n-1,",").concat(a)),r.push({x:n-1,y:a}))}let l=n,c=a;for(;l!==o||c!==i;)if(l<o)e[c][l].walls.right=!1,e[c][l+1].walls.left=!1,l++;else{if(!(c<i))break;e[c][l].walls.bottom=!1,e[c+1][l].walls.top=!1,c++}}function pt(e,t,n,a,o){const i=e[n][t];"top"===a&&n>0?(i.walls.top=!1,e[n-1][t].walls.bottom=!1):"right"===a&&t<o-1?(i.walls.right=!1,e[n][t+1].walls.left=!1):"bottom"===a&&n<o-1?(i.walls.bottom=!1,e[n+1][t].walls.top=!1):"left"===a&&t>0&&(i.walls.left=!1,e[n][t-1].walls.right=!1)}function ut(e){const t=100*Math.random();return t<(e.chestMimicPercent||0)?"mimic":t<(e.chestMimicPercent||0)+(e.chestLockedPercent||0)?"locked":"normal"}function ht(e,t,n){const a=[];for(let e=0;e<n;e++)for(let t=0;t<n;t++)0===t&&0===e||t===n-1&&e===n-1||a.push({x:t,y:e});!function(e){for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}}(a);const o=function(e,t){const n={minionPlacements:[],trapPlacements:[],chestCount:0},a=O(e),o=a.encounterDensityMult||1,i=a.trapFrequencyMult||1,s=e.chestTilePercent||0,r=e.minionEncounters||[],l=e.trapEncounters||[],c=s+r.reduce(((e,t)=>e+(t.percent||0)*o),0)+l.reduce(((e,t)=>e+(t.percent||0)*i),0);let m=1;c>100&&(m=100/c,console.log("[MazeMaster] Distribution over 100% (".concat(c,"%), scaling down by ").concat(m.toFixed(2)))),n.chestCount=Math.floor(t*(s*m)/100);for(const e of r){const a=(e.percent||0)*o*m,i=Math.floor(t*a/100);i>0&&n.minionPlacements.push({minionId:e.minionId,count:i})}for(const e of l){const a=(e.percent||0)*i*m,o=Math.floor(t*a/100);o>0&&n.trapPlacements.push({trapId:e.trapId,count:o})}return n}(t,a.length);let i=0;for(let n=0;n<o.chestCount&&i<a.length;n++){const n=a[i++],o=ut(t);e[n.y][n.x].chest={type:o,opened:!1}}const s=i;for(const t of o.minionPlacements)for(let n=0;n<t.count&&i<a.length;n++){const n=a[i++];e[n.y][n.x].minion={minionId:t.minionId,triggered:!1}}const r=i-s,l=i;for(const t of o.trapPlacements)for(let n=0;n<t.count&&i<a.length;n++){const n=a[i++];e[n.y][n.x].trap={trapId:t.trapId,triggered:!1}}const c=i-l,m=function(e,t,n,a){if(!t.portals||0===t.portals.length)return;const o=[];for(const i of t.portals){let t=i.startX,s=i.startY,r=i.endX,l=i.endY;if(null==t||null==s){const o=a.find((t=>!(e[t.y][t.x].chest||e[t.y][t.x].minion||e[t.y][t.x].trap||e[t.y][t.x].portal||0===t.x&&0===t.y||t.x===n-1&&t.y===n-1)));if(!o)continue;{t=o.x,s=o.y;const e=a.indexOf(o);e>-1&&a.splice(e,1)}}if(null==r||null==l){const o=a.find((a=>!(e[a.y][a.x].chest||e[a.y][a.x].minion||e[a.y][a.x].trap||e[a.y][a.x].portal||a.x===t&&a.y===s||0===a.x&&0===a.y||a.x===n-1&&a.y===n-1)));if(!o)continue;{r=o.x,l=o.y;const e=a.indexOf(o);e>-1&&a.splice(e,1)}}const c=i.id||"portal_".concat(o.length+1),m=i.color||"#9b59b6",d=!1!==i.bidirectional;e[s][t].portal={id:c,target:{x:r,y:l},isStart:!0,color:m,bidirectional:d},e[l][r].portal={id:c,target:{x:t,y:s},isStart:!1,color:m,bidirectional:d},o.push({id:c,startX:t,startY:s,endX:r,endY:l,color:m,bidirectional:d})}return o.length>0&&console.log("[MazeMaster] Placed ".concat(o.length," portal pair(s)")),o}(e,t,n,a.slice(i));return console.log("[MazeMaster] Placed ".concat(o.chestCount," chests, ").concat(r," minions, ").concat(c," traps")),{placedPortals:m||[]}}function gt(e){return e&&0!==e.length?e[Math.floor(Math.random()*e.length)]:null}function ft(e){return T.getRenderer().getCellSize(e)}function vt(e){var n;const a=Me(e);if(!a)return console.error('[MazeMaster] Maze profile "'.concat(e,'" not found')),{error:'Profile "'.concat(e,'" not found')};const o=a.gridSize||10,i=a.mapStyle||"maze",s=Math.max(1,Math.min(10,a.floors||1)),r=[],l=o-1,c=o-1;for(let e=0;e<s;e++){const e=st(o,i);ht(e,a,o),M(e,a,o,l,c),r.push(e)}s>1&&function(e,t,n){const a=e.length;for(let o=0;o<a-1;o++){const a=e[o],i=e[o+1],s=[];for(let e=0;e<t;e++)for(let n=0;n<t;n++){if(0===n&&0===e||n===t-1&&e===t-1)continue;const o=a[e][n],r=i[e][n];o.minion||o.trap||o.chest||r.minion||r.trap||r.chest||s.push({x:n,y:e})}if(s.length<2)continue;const r=Math.min(2,Math.max(1,Math.floor(t/5)));for(let e=0;e<r&&s.length>0;e++){const e=Math.floor(Math.random()*s.length),t=s.splice(e,1)[0];a[t.y][t.x].staircase={direction:"up",targetFloor:o+1,targetX:t.x,targetY:t.y,requireKey:n},i[t.y][t.x].staircase={direction:"down",targetFloor:o,targetX:t.x,targetY:t.y,requireKey:!1}}}}(r,o,a.requireFloorKey||!1);const m=r[0],d=a.startingInventory||{key:0,stealth:0,pow:0,grandpow:0},p=O(a).inventoryStartMult||1,u={key:Math.floor((d.key||0)*p),stealth:Math.floor((d.stealth||0)*p),pow:Math.floor((d.pow||0)*p),grandpow:Math.floor((d.grandpow||0)*p),floorKey:Math.floor((d.floorKey||0)*p),portalStone:Math.floor((d.portalStone||0)*p),minionBane:Math.floor((d.minionBane||0)*p),mapFragment:Math.floor((d.mapFragment||0)*p),timeShard:Math.floor((d.timeShard||0)*p),voidWalk:Math.floor((d.voidWalk||0)*p)};let h={name:"The Maze",imagePath:"",message:"Find your way to the exit..."};const g=a.mainMinion?Ie(a.mainMinion):null;return null!==(n=a.storyConfig)&&void 0!==n&&n.mainStory?h={name:(null==g?void 0:g.name)||"Story",role:"Narrator",imagePath:(null==g?void 0:g.imagePath)||"",message:a.storyConfig.mainStory}:g&&(h={name:g.name,role:"Main Minion",imagePath:g.imagePath,message:a.mainMinionIntroMessage||"Welcome to my maze..."}),he={isOpen:!0,profile:a,profileName:e,grid:m,size:o,playerX:0,playerY:0,exitX:o-1,exitY:o-1,visited:new Set(["0:0,0"]),isVictory:!1,currentMinion:h,isPaused:!1,pendingEncounter:null,exitEncounterDone:!1,pendingConfirmation:null,pendingChest:null,inventory:{key:u.key||0,stealth:u.stealth||0,pow:u.pow||0,grandpow:u.grandpow||0,floorKey:u.floorKey||0,portalStone:u.portalStone||0,minionBane:u.minionBane||0,mapFragment:u.mapFragment||0,timeShard:u.timeShard||0,voidWalk:u.voidWalk||0},shownMilestones:new Set,stats:{startTime:Date.now(),moves:0,encountersTotal:0,encountersWon:0,encountersLost:0,chestsOpened:0,trapsTriggered:0,teleportsUsed:0,itemsCollected:{key:0,pow:0,stealth:0,grandpow:0}},explorationComplete:!1,moveCount:0,movingMinions:[],portals:[],objectiveProgress:Q(a),allObjectivesComplete:!1,currentFloor:0,totalFloors:s,floors:r,voidWalkActive:!1,messageLog:[]},he.movingMinions=function(e,n){const a=[];for(let o=0;o<n;o++)for(let i=0;i<n;i++){const n=e[o][i];if(n.minion&&!n.minion.triggered){const e=Ie(n.minion.minionId),s=(null==e?void 0:e.movement)||{type:"stationary"};"stationary"!==s.type&&a.push({minionId:n.minion.minionId,x:i,y:o,originX:i,originY:o,triggered:!1,movement:t({},s)})}}return console.log("[MazeMaster] Initialized ".concat(a.length," moving minion(s)")),a}(m,o),bt(),zt(),J(!1),_t(),kt(),Pt(),N(),te(),H&&clearInterval(H),H=setInterval((()=>{var e,t;null===(e=he)||void 0===e||!e.isOpen||null!==(t=he)&&void 0!==t&&t.isVictory?(clearInterval(H),H=null):N()}),1e3),X(),U(),document.addEventListener("keydown",Mt,{capture:!0}),console.log('[MazeMaster] Maze "'.concat(e,'" started (').concat(o,"x").concat(o,", ").concat(s," floor").concat(s>1?"s":"",")")),{success:!0}}function bt(){var e,n,a,o;const s=document.getElementById("mazemaster_maze_modal");s&&s.remove();const r=ft(he.size),l=document.createElement("div");l.id="mazemaster_maze_modal",l.style.cssText="position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:999999;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.95);",l.innerHTML='\n        <div class="mazemaster-maze-overlay">\n            <div class="mazemaster-maze-container">\n                \x3c!-- TOP PANEL: Info & Controls --\x3e\n                <div class="mazemaster-maze-top">\n                    \x3c!-- Left Column: Message Box, Stats, Inventory --\x3e\n                    <div class="mazemaster-maze-left-column">\n                        \x3c!-- Hero Section (Message Box) --\x3e\n                        <div class="mazemaster-maze-hero">\n                            <div class="mazemaster-maze-hero-content">\n                                <div class="mazemaster-maze-hero-avatar">\n                                    <img id="maze_minion_img" src="" alt="" style="display: none;">\n                                    <div id="maze_generating_indicator" class="maze-generating-indicator">\n                                        <i class="fa-solid fa-comment-dots"></i>\n                                    </div>\n                                </div>\n                                <div class="maze-hero-text">\n                                    <div id="maze_minion_name" class="maze-minion-name"></div>\n                                    <div id="maze_minion_role" class="maze-minion-role"></div>\n                                    <div id="maze_message_log" class="maze-message-log"></div>\n                                </div>\n                            </div>\n                        </div>\n\n                    \x3c!-- ROW 2: Stats and Inventory --\x3e\n                    <div class="mazemaster-maze-info-stack">\n                        \x3c!-- Stats Bar --\x3e\n                        <div class="mazemaster-maze-stats-bar">\n                            <div class="stats-item" title="Moves">\n                                <i class="fa-solid fa-shoe-prints"></i>\n                                <span id="maze_stat_moves">0</span>\n                            </div>\n                            <div class="stats-item" title="Time Elapsed">\n                                <i class="fa-solid fa-clock"></i>\n                                <span id="maze_stat_time">0:00</span>\n                            </div>\n                            <div class="stats-item" title="Exploration">\n                                <i class="fa-solid fa-map"></i>\n                                <span id="maze_stat_explore">0%</span>\n                            </div>\n                            <div class="stats-item" title="Difficulty">\n                                <i class="fa-solid fa-skull"></i>\n                                <span id="maze_stat_difficulty">'.concat(O(he.profile).name,'</span>\n                            </div>\n                            <div class="stats-item maze-floor-indicator" title="Current Floor" style="').concat(he.totalFloors<=1?"display:none;":"",'">\n                                <i class="fa-solid fa-layer-group"></i>\n                                <span><span id="maze_floor_current">').concat(he.currentFloor+1,'</span>/<span id="maze_floor_total">').concat(he.totalFloors,'</span></span>\n                            </div>\n                        </div>\n\n                        \x3c!-- Inventory (clickable to expand drawer) --\x3e\n                        <div class="mazemaster-maze-inventory" id="maze_inventory_bar">\n                            <div class="inventory-item" title="Keys - Unlock locked chests">\n                                <i class="fa-solid fa-key"></i>\n                                <span id="maze_inv_key">').concat(he.inventory.key,'</span>\n                            </div>\n                            <div class="inventory-item" title="Stealth - Sneak past enemies">\n                                <i class="fa-solid fa-user-ninja"></i>\n                                <span id="maze_inv_stealth">').concat(he.inventory.stealth,'</span>\n                            </div>\n                            <div class="inventory-item" title="POW - Combat boost">\n                                <i class="fa-solid fa-bolt"></i>\n                                <span id="maze_inv_pow">').concat(he.inventory.pow,'</span>\n                            </div>\n                            <div class="inventory-item grandpow" title="GRANDPOW - Instant Win!">\n                                <i class="fa-solid fa-star"></i>\n                                <span id="maze_inv_grandpow">').concat(he.inventory.grandpow,'</span>\n                            </div>\n                            <div class="inventory-item floor-key" title="Floor Key - Unlock staircases">\n                                <i class="fa-solid fa-stairs"></i>\n                                <span id="maze_inv_floorKey">').concat(he.inventory.floorKey,'</span>\n                            </div>\n                            <div class="inventory-item portal-stone" title="Portal Stone - Teleport to any revealed portal" data-usable="true">\n                                <i class="fa-solid fa-gem"></i>\n                                <span id="maze_inv_portalStone">').concat(he.inventory.portalStone,'</span>\n                            </div>\n                            <div class="inventory-item minion-bane" title="Minion Bane - Auto-defeat next minion">\n                                <i class="fa-solid fa-skull-crossbones"></i>\n                                <span id="maze_inv_minionBane">').concat(he.inventory.minionBane,'</span>\n                            </div>\n                            <div class="inventory-item map-fragment" title="Map Fragment - Reveal 3x3 area (click to use)" data-usable="true">\n                                <i class="fa-solid fa-scroll"></i>\n                                <span id="maze_inv_mapFragment">').concat(he.inventory.mapFragment,'</span>\n                            </div>\n                            <div class="inventory-item time-shard" title="Time Shard - Slow next battlebar by 50%">\n                                <i class="fa-solid fa-hourglass-half"></i>\n                                <span id="maze_inv_timeShard">').concat(he.inventory.timeShard,'</span>\n                            </div>\n                            <div class="inventory-item void-walk" title="Void Walk - Phase through one wall (click to activate)" data-usable="true">\n                                <i class="fa-solid fa-ghost"></i>\n                                <span id="maze_inv_voidWalk">').concat(he.inventory.voidWalk,'</span>\n                            </div>\n                            <div class="inventory-expand-icon">\n                                <i class="fa-solid fa-chevron-down"></i>\n                            </div>\n                        </div>\n\n                        \x3c!-- Inventory Drawer (expands on click) --\x3e\n                        <div id="maze_inventory_drawer" class="maze-inventory-drawer hidden">\n                            <div class="inventory-drawer-content">\n                                \x3c!-- Populated dynamically --\x3e\n                            </div>\n                        </div>\n                    </div>\n\n                    \x3c!-- Objectives Section (if any) --\x3e\n                    <div class="maze-objectives-section ').concat(0===((null===(e=he.profile)||void 0===e||null===(e=e.objectives)||void 0===e?void 0:e.length)||0)?"hidden":"",'">\n                        <div class="objectives-header">\n                            <i class="fa-solid fa-list-check"></i>\n                            <span>Objectives</span>\n                        </div>\n                        <div id="maze_objectives_list" class="objectives-list">\n                            \x3c!-- Populated by updateObjectivesDisplay() --\x3e\n                        </div>\n                    </div>\n                    </div>\n\n                    \x3c!-- ROOM INFO BOX (right side, full height) --\x3e\n                    <div class="mazemaster-maze-room-info" id="maze_room_info">\n                        <div class="room-info-content">\n                            <div class="room-info-name" id="room_info_name">Unknown Room</div>\n                            <div class="room-info-desc" id="room_info_desc">...</div>\n                            <div class="room-info-section">\n                                <div class="room-info-label"><i class="fa-solid fa-compass"></i> Exits</div>\n                                <div id="room_info_exits">None</div>\n                            </div>\n                            <div class="room-info-section">\n                                <div class="room-info-label"><i class="fa-solid fa-users"></i> Occupants</div>\n                                <div id="room_info_occupants">None</div>\n                            </div>\n                            <div class="room-info-section">\n                                <div class="room-info-label"><i class="fa-solid fa-skull"></i> Defeated</div>\n                                <div id="room_info_defeated">None</div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n\n                \x3c!-- Power Button (top right corner) --\x3e\n                <button id="maze_power_btn" class="maze-power-btn" title="Exit Maze">\n                    <i class="fa-solid fa-power-off"></i>\n                </button>\n\n                \x3c!-- Encounter Actions (shows when needed) --\x3e\n                <div id="maze_encounter_confirm" class="maze-action-buttons">\n                    \x3c!-- Populated dynamically when encounter happens --\x3e\n                </div>\n\n                \x3c!-- BOTTOM PANEL: Map Area --\x3e\n                <div class="mazemaster-maze-bottom">\n                    <div class="mazemaster-maze-area">\n                        <div id="maze_grid_container" class="mazemaster-maze-grid-wrapper" style="position: relative;">\n                            \x3c!-- Renderer inserts grid/canvas here --\x3e\n                        </div>\n                    </div>\n                </div>\n\n                \x3c!-- Circular D-Pad (floating) --\x3e\n                <div id="maze_dpad" class="maze-dpad ').concat(null!==(n=de.dpadConfig)&&void 0!==n&&n.floating?"floating":"",'"\n                     style="').concat(null!==(a=de.dpadConfig)&&void 0!==a&&null!==(a=a.position)&&void 0!==a&&a.x?"left: ".concat(de.dpadConfig.position.x,"px; top: ").concat(de.dpadConfig.position.y,"px;"):"",'">\n                    <div class="dpad-ring">\n                        <button class="dpad-btn dpad-up" data-dir="up" title="Move Up (Arrow Up)">\n                            <i class="fa-solid fa-chevron-up"></i>\n                        </button>\n                        <button class="dpad-btn dpad-right" data-dir="right" title="Move Right (Arrow Right)">\n                            <i class="fa-solid fa-chevron-right"></i>\n                        </button>\n                        <button class="dpad-btn dpad-down" data-dir="down" title="Move Down (Arrow Down)">\n                            <i class="fa-solid fa-chevron-down"></i>\n                        </button>\n                        <button class="dpad-btn dpad-left" data-dir="left" title="Move Left (Arrow Left)">\n                            <i class="fa-solid fa-chevron-left"></i>\n                        </button>\n                        \x3c!-- Floor navigation buttons (shown when on staircase) --\x3e\n                        <button class="dpad-btn dpad-floor-up hidden" data-dir="floor-up" title="Go Up Floor (Shift+Up)">\n                            <i class="fa-solid fa-arrow-up"></i><span>UP</span>\n                        </button>\n                        <button class="dpad-btn dpad-floor-down hidden" data-dir="floor-down" title="Go Down Floor (Shift+Down)">\n                            <i class="fa-solid fa-arrow-down"></i><span>DN</span>\n                        </button>\n                    </div>\n                    <div class="dpad-center"></div>\n                    <div class="dpad-drag-handle" title="Drag to reposition">\n                        <i class="fa-solid fa-grip"></i>\n                    </div>\n                </div>\n\n                \x3c!-- Close Button (shown on victory) --\x3e\n                <button id="maze_close_btn" class="menu_button menu_button_primary maze-close-btn" style="display: none;">\n                    <i class="fa-solid fa-check"></i> Close\n                </button>\n            </div>\n        </div>\n\n        <style>\n            .mazemaster-maze-overlay {\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                width: 100%;\n                height: 100%;\n                overflow-y: auto;\n                -webkit-overflow-scrolling: touch;\n            }\n\n            .mazemaster-maze-container {\n                position: relative;\n                display: flex;\n                flex-direction: column;\n                gap: 12px;\n                padding: 15px;\n                width: 90vw;\n                max-width: 1200px;\n                height: 94vh;\n                max-height: 960px;\n                margin: 10px;\n                background: #1a1a2e;\n                border-radius: 15px;\n                border: 2px solid #333;\n                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);\n                overflow: hidden;\n            }\n\n            /* Top Panel - Info & Controls */\n            .mazemaster-maze-top {\n                display: flex;\n                flex-direction: row;\n                gap: 16px;\n                flex-shrink: 0;\n                min-height: 240px;\n                height: 280px;\n            }\n\n            /* Left Column - Message Box, Stats, Inventory stacked */\n            .mazemaster-maze-left-column {\n                display: flex;\n                flex-direction: column;\n                gap: 8px;\n                width: 50.1%;\n                flex-shrink: 0;\n            }\n\n            /* Info Stack - Stats and Inventory */\n            .mazemaster-maze-info-stack {\n                display: flex;\n                flex-direction: column;\n                gap: 8px;\n                width: 100%;\n                position: relative;\n            }\n\n            /* ROOM INFO BOX - right side, full height */\n            .mazemaster-maze-room-info {\n                flex: 1;\n                margin-right: 46px; /* Space for power button */\n                background: rgba(0, 0, 0, 0.3);\n                border-radius: 8px;\n                padding: 10px 12px;\n                border: 1px solid #444;\n                display: flex;\n                flex-direction: column;\n            }\n\n            .room-info-content {\n                flex: 1;\n                display: flex;\n                flex-direction: column;\n                color: #aaa;\n                font-size: 0.9em;\n                gap: 8px;\n                overflow-y: auto;\n            }\n\n            .room-info-name {\n                font-size: 1.1em;\n                font-weight: 600;\n                color: #ecf0f1;\n                margin-bottom: 2px;\n            }\n\n            .room-info-desc {\n                font-style: italic;\n                color: #bdc3c7;\n                font-size: 0.9em;\n                line-height: 1.3;\n                padding-bottom: 8px;\n                border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n            }\n\n            .room-info-section {\n                display: flex;\n                flex-direction: column;\n                gap: 2px;\n            }\n\n            .room-info-label {\n                font-size: 0.75em;\n                color: #7f8c8d;\n                text-transform: uppercase;\n                display: flex;\n                align-items: center;\n                gap: 6px;\n            }\n\n            .room-info-label i {\n                font-size: 0.9em;\n                color: #3498db;\n            }\n\n            .room-info-section > div:last-child {\n                color: #ecf0f1;\n                font-size: 0.95em;\n            }\n\n            .maze-hero-text {\n                display: flex;\n                flex-direction: column;\n                flex: 1;\n                min-width: 0;\n            }\n\n            /* Power Button - Top Right Corner */\n            .maze-power-btn {\n                position: absolute;\n                top: 16px;\n                right: 10px;\n                width: 40px;\n                height: 40px;\n                border-radius: 50%;\n                border: 2px solid #e94560;\n                background: rgba(233, 69, 96, 0.2);\n                color: #e94560;\n                font-size: 18px;\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                transition: all 0.2s ease;\n                z-index: 100;\n            }\n\n            .maze-power-btn:hover {\n                background: #e94560;\n                color: #fff;\n                transform: scale(1.1);\n            }\n\n            /* Save Dialog */\n            #maze_save_dialog {\n                position: absolute;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                z-index: 1000;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n            }\n\n            .maze-save-dialog-backdrop {\n                position: absolute;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                background: rgba(0, 0, 0, 0.7);\n            }\n\n            .maze-save-dialog-content {\n                position: relative;\n                background: #1a1a2e;\n                border: 2px solid #4a90d9;\n                border-radius: 12px;\n                padding: 24px 32px;\n                text-align: center;\n                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);\n            }\n\n            .maze-save-dialog-title {\n                color: #fff;\n                font-size: 18px;\n                font-weight: 600;\n                margin-bottom: 20px;\n            }\n\n            .maze-save-dialog-buttons {\n                display: flex;\n                gap: 12px;\n                justify-content: center;\n            }\n\n            .maze-save-btn {\n                padding: 10px 24px;\n                border-radius: 6px;\n                border: none;\n                font-size: 14px;\n                font-weight: 600;\n                cursor: pointer;\n                transition: all 0.2s ease;\n            }\n\n            .maze-save-yes {\n                background: #27ae60;\n                color: #fff;\n            }\n\n            .maze-save-yes:hover {\n                background: #2ecc71;\n            }\n\n            .maze-save-no {\n                background: #e74c3c;\n                color: #fff;\n            }\n\n            .maze-save-no:hover {\n                background: #c0392b;\n            }\n\n            .maze-save-cancel {\n                background: #7f8c8d;\n                color: #fff;\n            }\n\n            .maze-save-cancel:hover {\n                background: #95a5a6;\n            }\n\n            /* Bottom Panel - Map Area */\n            .mazemaster-maze-bottom {\n                display: flex;\n                flex-direction: column;\n                align-items: center;\n                justify-content: flex-end;\n                flex: 1;\n                min-height: 200px;\n                padding-bottom: 15px;\n                overflow: auto;\n            }\n\n            /* Hero Section - Minion Area (fills remaining height) */\n            .mazemaster-maze-hero {\n                display: flex;\n                flex-direction: column;\n                flex: 1;\n                width: 100%;\n                background: rgba(0, 0, 0, 0.3);\n                border-radius: 8px;\n                padding: 10px 12px;\n                border: 1px solid #444;\n                min-height: 80px;\n            }\n\n            .maze-minion-name {\n                font-weight: bold;\n                font-size: 1.2em;\n                color: #e94560;\n                flex-shrink: 0;\n                margin-bottom: 0;\n            }\n\n            .maze-minion-role {\n                font-size: 0.8em;\n                color: #f1c40f;\n                flex-shrink: 0;\n                margin-bottom: 4px;\n            }\n\n            .mazemaster-maze-hero-content {\n                display: flex;\n                gap: 10px;\n                align-items: flex-start;\n                flex: 1;\n            }\n\n            .mazemaster-maze-hero-avatar {\n                width: 72px;\n                height: 72px;\n                min-width: 72px;\n                flex-shrink: 0;\n                border-radius: 6px;\n                overflow: hidden;\n                background: #16213e;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                position: relative;\n            }\n\n            .mazemaster-maze-hero-avatar img {\n                width: 100%;\n                height: 100%;\n                object-fit: cover;\n                object-position: center top;\n                display: block;\n            }\n\n            /* LLM Generating Indicator - overlays the entire image */\n            .maze-generating-indicator {\n                position: absolute;\n                top: 0;\n                left: 0;\n                right: 0;\n                bottom: 0;\n                background: rgba(52, 152, 219, 0.7);\n                border-radius: 8px;\n                display: none;\n                align-items: center;\n                justify-content: center;\n                z-index: 10;\n            }\n\n            .maze-generating-indicator.active {\n                display: flex;\n            }\n\n            .maze-generating-indicator i {\n                color: #fff;\n                font-size: 32px;\n                animation: maze-pulse 1s ease-in-out infinite;\n                text-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);\n            }\n\n            @keyframes maze-pulse {\n                0%, 100% { transform: scale(1); opacity: 1; }\n                50% { transform: scale(1.2); opacity: 0.7; }\n            }\n\n            .maze-message-log {\n                flex: 1;\n                color: #eee;\n                line-height: 1.4;\n                font-size: 0.9em;\n                overflow-y: auto;\n                max-height: 120px;\n                display: flex;\n                flex-direction: column;\n                gap: 4px;\n                padding-right: 4px;\n            }\n\n            .maze-message-log::-webkit-scrollbar {\n                width: 6px;\n            }\n\n            .maze-message-log::-webkit-scrollbar-track {\n                background: rgba(0, 0, 0, 0.2);\n                border-radius: 3px;\n            }\n\n            .maze-message-log::-webkit-scrollbar-thumb {\n                background: rgba(255, 255, 255, 0.3);\n                border-radius: 3px;\n            }\n\n            .maze-message-log::-webkit-scrollbar-thumb:hover {\n                background: rgba(255, 255, 255, 0.5);\n            }\n\n            .maze-message-entry {\n                padding: 4px 8px;\n                background: rgba(0, 0, 0, 0.2);\n                border-radius: 6px;\n                border-left: 3px solid rgba(52, 152, 219, 0.6);\n            }\n\n            .maze-message-entry:last-child {\n                border-left-color: rgba(46, 204, 113, 0.8);\n            }\n\n            .maze-message-speaker {\n                font-weight: 600;\n                color: #3498db;\n                font-size: 0.85em;\n                margin-bottom: 2px;\n            }\n\n            .maze-message-text {\n                font-style: italic;\n                color: #ecf0f1;\n            }\n\n            /* Stats Bar */\n            .mazemaster-maze-stats-bar {\n                display: flex;\n                justify-content: center;\n                flex-wrap: wrap;\n                gap: 12px;\n                width: 100%;\n                padding: 6px 12px;\n                background: linear-gradient(135deg, rgba(52, 73, 94, 0.4) 0%, rgba(44, 62, 80, 0.4) 100%);\n                border-radius: 8px;\n                border: 1px solid rgba(255, 255, 255, 0.1);\n            }\n\n            .stats-item {\n                display: flex;\n                align-items: center;\n                gap: 6px;\n                font-size: 0.85em;\n                color: #bdc3c7;\n            }\n\n            .stats-item i {\n                color: #3498db;\n                font-size: 0.9em;\n            }\n\n            .stats-item span {\n                font-weight: 500;\n                color: #ecf0f1;\n            }\n\n            /* Objectives Section */\n            .maze-objectives-section {\n                width: 550px;\n                max-width: 95vw;\n                padding: 8px 12px;\n                background: linear-gradient(135deg, rgba(52, 73, 94, 0.4) 0%, rgba(44, 62, 80, 0.4) 100%);\n                border-radius: 8px;\n                border: 1px solid rgba(255, 255, 255, 0.1);\n            }\n\n            .maze-objectives-section.hidden {\n                display: none;\n            }\n\n            .maze-objectives-section .objectives-header {\n                display: flex;\n                align-items: center;\n                gap: 6px;\n                font-size: 0.8em;\n                color: #95a5a6;\n                margin-bottom: 6px;\n            }\n\n            .maze-objectives-section .objectives-list {\n                display: flex;\n                flex-direction: column;\n                gap: 4px;\n            }\n\n            .maze-objectives-section .objective-item {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                font-size: 0.85em;\n                padding: 4px 8px;\n                background: rgba(0, 0, 0, 0.2);\n                border-radius: 4px;\n            }\n\n            .maze-objectives-section .objective-item i {\n                font-size: 0.9em;\n            }\n\n            .maze-objectives-section .objective-description {\n                flex: 1;\n            }\n\n            .maze-objectives-section .objective-progress {\n                font-weight: 500;\n                font-size: 0.9em;\n            }\n\n            .maze-objectives-section .objective-required i {\n                color: #e74c3c;\n            }\n\n            .maze-objectives-section .objective-optional i {\n                color: #95a5a6;\n            }\n\n            .maze-objectives-section .objective-complete {\n                opacity: 0.7;\n            }\n\n            .maze-objectives-section .objective-complete i {\n                color: #27ae60 !important;\n            }\n\n            .maze-objectives-section.objectives-flash {\n                animation: objectives-flash-anim 0.5s ease-out;\n            }\n\n            @keyframes objectives-flash-anim {\n                0%, 100% {\n                    border-color: rgba(255, 255, 255, 0.1);\n                }\n                50% {\n                    border-color: #e74c3c;\n                    box-shadow: 0 0 10px rgba(231, 76, 60, 0.5);\n                }\n            }\n\n            /* Player Overlay for Smooth Movement Animation */\n            .maze-player-overlay {\n                position: absolute;\n                top: 2px;\n                left: 2px;\n                pointer-events: none;\n                z-index: 10;\n                transition: transform 0.15s ease-out;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n            }\n\n            .maze-player-marker {\n                width: 60%;\n                height: 60%;\n                background: radial-gradient(circle, #4ecdc4 0%, #2d8f8f 100%);\n                border-radius: 50%;\n                box-shadow: 0 0 10px rgba(78, 205, 196, 0.6), 0 0 20px rgba(78, 205, 196, 0.3);\n                animation: player-pulse 1.5s ease-in-out infinite;\n            }\n\n            @keyframes player-pulse {\n                0%, 100% { transform: scale(1); opacity: 1; }\n                50% { transform: scale(1.1); opacity: 0.9; }\n            }\n\n            .maze-player-overlay.teleporting .maze-player-marker {\n                animation: teleport-flash 0.2s ease-out;\n            }\n\n            @keyframes teleport-flash {\n                0% { opacity: 1; transform: scale(1); }\n                50% { opacity: 0; transform: scale(0.2); }\n                100% { opacity: 1; transform: scale(1); }\n            }\n\n            /* Control Bar */\n            .maze-action-buttons {\n                display: flex;\n                gap: 6px;\n                justify-content: center;\n                flex-wrap: wrap;\n            }\n\n            .mazemaster-maze-inventory {\n                display: flex;\n                flex-wrap: wrap;\n                justify-content: space-evenly;\n                background: rgba(0, 0, 0, 0.3);\n                padding: 8px 12px;\n                border-radius: 6px;\n            }\n\n            .inventory-item {\n                display: flex;\n                align-items: center;\n                gap: 4px;\n                font-size: 0.9em;\n            }\n\n            /* Inventory item icon colors */\n            .inventory-item i.fa-key { color: #f1c40f; }\n            .inventory-item i.fa-user-ninja { color: #9b59b6; }\n            .inventory-item i.fa-bolt { color: #e74c3c; }\n            .inventory-item.grandpow i { color: #ffd700; text-shadow: 0 0 4px #ffd700; }\n            .inventory-item.floor-key i { color: #3498db; }\n            .inventory-item.portal-stone i { color: #9b59b6; }\n            .inventory-item.minion-bane i { color: #c0392b; }\n            .inventory-item.map-fragment i { color: #27ae60; }\n            .inventory-item.time-shard i { color: #f39c12; }\n            .inventory-item.void-walk i { color: #7f8c8d; }\n\n            /* Inventory expand icon */\n            .inventory-expand-icon {\n                margin-left: auto;\n                padding-left: 8px;\n                color: #888;\n                cursor: pointer;\n                transition: transform 0.2s;\n            }\n            .mazemaster-maze-inventory.expanded .inventory-expand-icon {\n                transform: rotate(180deg);\n            }\n            .mazemaster-maze-inventory {\n                cursor: pointer;\n            }\n\n            /* Inventory Drawer */\n            .maze-inventory-drawer {\n                position: absolute;\n                top: 100%;\n                left: 0;\n                right: 0;\n                background: rgba(26, 26, 46, 0.98);\n                border: 1px solid #444;\n                border-top: none;\n                border-radius: 0 0 8px 8px;\n                padding: 10px 12px;\n                z-index: 200;\n                max-height: 300px;\n                overflow-y: auto;\n                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);\n            }\n            .maze-inventory-drawer.hidden {\n                display: none;\n            }\n            .inventory-drawer-content {\n                display: flex;\n                flex-direction: column;\n                gap: 6px;\n            }\n            .inventory-drawer-item {\n                display: flex;\n                align-items: center;\n                gap: 10px;\n                padding: 6px 8px;\n                background: rgba(255, 255, 255, 0.05);\n                border-radius: 4px;\n            }\n            .inventory-drawer-item.empty {\n                opacity: 0.4;\n            }\n            .inventory-drawer-item i {\n                width: 20px;\n                text-align: center;\n            }\n            .inventory-drawer-item .item-name {\n                flex: 1;\n                font-size: 0.9em;\n            }\n            .inventory-drawer-item .item-count {\n                font-weight: bold;\n                min-width: 24px;\n                text-align: right;\n            }\n            /* Drawer item icon colors - match the bar */\n            .inventory-drawer-item i.fa-key { color: #f1c40f; }\n            .inventory-drawer-item i.fa-user-ninja { color: #9b59b6; }\n            .inventory-drawer-item i.fa-bolt { color: #e74c3c; }\n            .inventory-drawer-item.grandpow i { color: #ffd700; text-shadow: 0 0 4px #ffd700; }\n            .inventory-drawer-item.floor-key i { color: #3498db; }\n            .inventory-drawer-item.portal-stone i { color: #9b59b6; }\n            .inventory-drawer-item.minion-bane i { color: #c0392b; }\n            .inventory-drawer-item.map-fragment i { color: #27ae60; }\n            .inventory-drawer-item.time-shard i { color: #f39c12; }\n            .inventory-drawer-item.void-walk i { color: #7f8c8d; }\n\n            /* Usable items have click cursor and glow */\n            .inventory-item[data-usable="true"] {\n                cursor: pointer;\n                transition: transform 0.2s, box-shadow 0.2s;\n            }\n            .inventory-item[data-usable="true"]:hover {\n                transform: scale(1.1);\n                text-shadow: 0 0 8px currentColor;\n            }\n            .inventory-item.hidden { display: none; }\n\n            .mazemaster-maze-save-exit {\n                display: flex;\n                gap: 8px;\n                justify-content: center;\n                margin-top: auto;\n                padding-top: 10px;\n            }\n\n            /* Maze Area */\n            .mazemaster-maze-area {\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                width: 100%;\n                height: 100%;\n                overflow: hidden;\n                cursor: grab;\n                user-select: none;\n                background: #0a0a1a;\n                border-radius: 8px;\n            }\n\n            .mazemaster-maze-grid-wrapper {\n                flex: 1;\n                display: flex;\n                justify-content: center;\n            }\n\n            /* Circular D-Pad */\n            .maze-dpad {\n                position: absolute;\n                bottom: 60px;\n                right: 20px;\n                width: 140px;\n                height: 140px;\n                z-index: 100;\n            }\n\n            .maze-dpad.floating {\n                position: fixed;\n                z-index: 10001;\n                bottom: 20px;\n                right: 20px;\n            }\n\n            .dpad-ring {\n                position: relative;\n                width: 100%;\n                height: 100%;\n                border-radius: 50%;\n                background: radial-gradient(circle, #2c3e50 0%, #1a1a2e 100%);\n                border: 3px solid var(--theme-primary, #3498db);\n                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);\n            }\n\n            .dpad-btn {\n                position: absolute;\n                width: 40px;\n                height: 40px;\n                border-radius: 50%;\n                background: linear-gradient(to bottom, var(--theme-primary, #3498db), var(--theme-secondary, #2980b9));\n                border: 2px solid var(--theme-accent, #5dade2);\n                color: white;\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                transition: all 0.15s;\n                font-size: 1em;\n            }\n\n            .dpad-btn:hover {\n                transform: scale(1.1);\n                filter: brightness(1.2);\n            }\n\n            .dpad-btn:active {\n                transform: scale(0.95);\n            }\n\n            .dpad-up { top: 5px; left: 50%; transform: translateX(-50%); }\n            .dpad-right { right: 5px; top: 50%; transform: translateY(-50%); }\n            .dpad-down { bottom: 5px; left: 50%; transform: translateX(-50%); }\n            .dpad-left { left: 5px; top: 50%; transform: translateY(-50%); }\n\n            .dpad-center {\n                position: absolute;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                width: 30px;\n                height: 30px;\n                border-radius: 50%;\n                background: #1a1a2e;\n                border: 2px solid #34495e;\n            }\n\n            /* Floor navigation buttons */\n            .dpad-floor-up, .dpad-floor-down {\n                width: 50px;\n                height: 36px;\n                border-radius: 8px;\n                font-size: 0.65em;\n                background: linear-gradient(to bottom, #27ae60, #1e8449);\n                border-color: #2ecc71;\n                flex-direction: column;\n                gap: 2px;\n            }\n\n            .dpad-floor-up { top: 50%; left: -58px; transform: translateY(-50%); }\n            .dpad-floor-down { top: 50%; right: -58px; transform: translateY(-50%); }\n\n            .dpad-floor-up.hidden, .dpad-floor-down.hidden {\n                display: none;\n            }\n\n            .dpad-drag-handle {\n                position: absolute;\n                bottom: -22px;\n                left: 50%;\n                transform: translateX(-50%);\n                padding: 3px 8px;\n                background: rgba(0, 0, 0, 0.5);\n                border-radius: 4px;\n                color: #666;\n                font-size: 0.75em;\n                cursor: grab;\n                display: none;\n            }\n\n            .maze-dpad.floating .dpad-drag-handle {\n                display: block;\n            }\n\n            .maze-dpad:not(.floating) .dpad-drag-handle {\n                display: none;\n            }\n\n            /* Void Walk active indicator */\n            .maze-dpad.void-walk-active .dpad-ring {\n                animation: void-walk-pulse 1s infinite;\n                border-color: #7f8c8d;\n            }\n            .maze-dpad.void-walk-active .dpad-btn {\n                background: linear-gradient(to bottom, #7f8c8d, #5d6d7e);\n                border-color: #95a5a6;\n            }\n            @keyframes void-walk-pulse {\n                0%, 100% { box-shadow: 0 4px 15px rgba(127, 140, 141, 0.5); }\n                50% { box-shadow: 0 4px 25px rgba(127, 140, 141, 0.8); }\n            }\n\n            .mazemaster-maze-grid {\n                display: grid;\n                gap: 0;\n                background: #333;\n                padding: 2px;\n                border-radius: 5px;\n                border: 2px solid #555;\n            }\n\n            .maze-cell {\n                width: ').concat(r,"px;\n                height: ").concat(r,"px;\n                background: #1a1a2e;\n                position: relative;\n                box-sizing: border-box;\n            }\n\n            .maze-cell.hidden {\n                background: #0a0a0a;\n            }\n\n            .maze-cell.wall-top { border-top: 2px solid #fff; }\n            .maze-cell.wall-right { border-right: 2px solid #fff; }\n            .maze-cell.wall-bottom { border-bottom: 2px solid #fff; }\n            .maze-cell.wall-left { border-left: 2px solid #fff; }\n\n            /* Player marker now handled by .maze-player-overlay for smooth animation */\n            .maze-cell.player {\n                /* Player position cell styling - marker is in overlay */\n            }\n\n            .maze-cell.exit::before {\n                content: '';\n                position: absolute;\n                top: 50%; left: 50%;\n                transform: translate(-50%, -50%);\n                width: 70%; height: 70%;\n                background: #27ae60;\n                border-radius: 3px;\n            }\n\n            .maze-cell.visited:not(.hidden) {\n                background: #1e2a4a;\n            }\n\n            /* Legacy arrow buttons (kept for backwards compatibility) */\n            .maze-arrow-btn {\n                display: none; /* Hide legacy buttons */\n            }\n\n            /* Action buttons */\n            .maze-action-btn {\n                padding: 8px 14px;\n                font-size: 0.85em;\n                border-radius: 5px;\n                display: inline-flex;\n                align-items: center;\n                justify-content: center;\n                gap: 6px;\n            }\n\n            .maze-exit-btn {\n                background: linear-gradient(to bottom, #555, #444) !important;\n            }\n\n            .maze-close-btn {\n                padding: 10px 28px;\n                font-size: 1em;\n            }\n\n            .maze-cell.victory-glow {\n                animation: victoryPulse 1s infinite;\n            }\n\n            @keyframes victoryPulse {\n                0%, 100% { background: #27ae60; }\n                50% { background: #2ecc71; }\n            }\n\n            /* =====================================================\n               MOBILE / PORTRAIT LAYOUT (v1.2.0)\n               ===================================================== */\n            .layout-mobile .mazemaster-maze-container,\n            #mazemaster_maze_modal.layout-mobile .mazemaster-maze-container {\n                width: 100vw;\n                height: 100vh;\n                max-width: 100vw;\n                max-height: 100vh;\n                padding: 8px;\n                gap: 6px;\n                border-radius: 0;\n                margin: 0;\n            }\n\n            .layout-mobile .mazemaster-maze-top {\n                flex-direction: column;\n                max-height: none;\n                gap: 8px;\n            }\n\n            .layout-mobile .mazemaster-maze-hero {\n                width: 100%;\n                max-width: 100%;\n                min-width: unset;\n            }\n\n            .layout-mobile .mazemaster-maze-info-col {\n                width: 100%;\n            }\n\n            .layout-mobile .mazemaster-maze-buttons-col {\n                flex-direction: row;\n                width: 100%;\n                justify-content: center;\n            }\n\n            .layout-mobile .mazemaster-maze-stats-bar {\n                flex-wrap: wrap;\n                gap: 6px;\n                justify-content: center;\n            }\n\n            .layout-mobile .mazemaster-maze-inventory {\n                flex-wrap: wrap;\n                justify-content: center;\n            }\n\n            .layout-mobile .maze-action-buttons {\n                flex-wrap: wrap;\n                justify-content: center;\n            }\n\n            .layout-mobile .maze-dpad {\n                position: fixed;\n                bottom: 10px;\n                right: 10px;\n                z-index: 10000;\n            }\n\n            /* Make grid scrollable on mobile */\n            .layout-mobile .maze-grid-area {\n                overflow: auto;\n                max-height: 50vh;\n            }\n\n            /* Larger touch targets on mobile */\n            .layout-mobile .dpad-btn {\n                min-width: 50px;\n                min-height: 50px;\n            }\n\n            @media (max-width: 600px) {\n                .mazemaster-maze-hero {\n                    height: auto;\n                    min-height: 80px;\n                }\n\n                .maze-message-log {\n                    font-size: 0.85em;\n                    max-height: 80px;\n                }\n\n                .stats-item {\n                    font-size: 0.75em;\n                    padding: 3px 6px;\n                }\n\n                .inventory-item {\n                    padding: 4px 6px;\n                    font-size: 0.85em;\n                }\n            }\n        </style>\n    "),document.body.appendChild(l);const c=T.getRenderer(),m=document.getElementById("maze_grid_container");if(m){m.innerHTML=c.getGridHTML(he.size);const e=c.getPlayerOverlayHTML(r);e&&m.insertAdjacentHTML("beforeend",e),c.init(m,he)}B(),l.querySelectorAll(".dpad-btn").forEach((e=>{e.addEventListener("click",(()=>{const t=e.dataset.dir;"up"===t?Et(0,-1):"down"===t?Et(0,1):"left"===t?Et(-1,0):"right"===t?Et(1,0):"floor-up"===t?K("up"):"floor-down"===t&&K("down")})),e.addEventListener("touchend",(t=>{t.preventDefault(),e.click()}))})),function(){const e=document.getElementById("maze_dpad");if(!e||!e.classList.contains("floating"))return;const t=e.querySelector(".dpad-drag-handle");if(!t)return;let n=!1,a=0,o=0;const s=(t,i)=>{n=!0,a=t-e.offsetLeft,o=i-e.offsetTop,e.style.cursor="grabbing"},r=(t,i)=>{if(!n)return;const s=Math.max(0,Math.min(window.innerWidth-e.offsetWidth,t-a)),r=Math.max(0,Math.min(window.innerHeight-e.offsetHeight,i-o));e.style.left="".concat(s,"px"),e.style.top="".concat(r,"px"),e.style.right="auto",e.style.bottom="auto"},l=()=>{n&&(n=!1,e.style.cursor="",de.dpadConfig||(de.dpadConfig={enabled:!0,floating:!0,position:{}}),de.dpadConfig.position={x:e.offsetLeft,y:e.offsetTop},i())};t.addEventListener("mousedown",(e=>{e.preventDefault(),s(e.clientX,e.clientY)})),document.addEventListener("mousemove",(e=>r(e.clientX,e.clientY))),document.addEventListener("mouseup",l),t.addEventListener("touchstart",(e=>{const t=e.touches[0];s(t.clientX,t.clientY)})),document.addEventListener("touchmove",(e=>{if(!n)return;const t=e.touches[0];r(t.clientX,t.clientY)})),document.addEventListener("touchend",l)}(),function(){const e=document.getElementById("maze_grid_container"),t=document.querySelector(".mazemaster-maze-area");if(!e||!t)return;let n=1,a=0,o=0,i=!1,s=0,r=0,l=0,c=1;const m=()=>{e.style.transform="translate(".concat(a,"px, ").concat(o,"px) scale(").concat(n,")"),e.style.transformOrigin="center center"};t.addEventListener("wheel",(e=>{e.preventDefault();const t=e.deltaY>0?.9:1.1;n=Math.max(.5,Math.min(3,n*t)),m()}),{passive:!1}),t.addEventListener("mousedown",(e=>{e.target.closest(".maze-cell, canvas")&&(i=!0,s=e.clientX-a,r=e.clientY-o,t.style.cursor="grabbing")})),document.addEventListener("mousemove",(e=>{i&&(a=e.clientX-s,o=e.clientY-r,m())})),document.addEventListener("mouseup",(()=>{i=!1,t.style.cursor=""}));const d=e=>{if(e.length<2)return 0;const t=e[0].clientX-e[1].clientX,n=e[0].clientY-e[1].clientY;return Math.sqrt(t*t+n*n)};t.addEventListener("touchstart",(e=>{2===e.touches.length?(l=d(e.touches),c=n):1===e.touches.length&&(i=!0,s=e.touches[0].clientX-a,r=e.touches[0].clientY-o)}),{passive:!0}),t.addEventListener("touchmove",(e=>{if(2===e.touches.length){e.preventDefault();const t=d(e.touches);if(l>0){const e=t/l;n=Math.max(.5,Math.min(3,c*e)),m()}}else 1===e.touches.length&&i&&(a=e.touches[0].clientX-s,o=e.touches[0].clientY-r,m())}),{passive:!1}),t.addEventListener("touchend",(()=>{i=!1,l=0,c=n}));let p=0;t.addEventListener("touchend",(e=>{const t=Date.now();t-p<300&&1===e.changedTouches.length&&(n=1,a=0,o=0,m()),p=t})),t.style.cursor="grab"}();const d=l.querySelector(".inventory-item.map-fragment");d&&d.addEventListener("click",(()=>async function(){if(!he||he.isPaused)return!1;if(!he.inventory.mapFragment||he.inventory.mapFragment<=0)return console.log("[MazeMaster] No Map Fragments available"),!1;const{playerX:e,playerY:t,grid:n,size:a}=he;let o=0;for(let i=-1;i<=1;i++)for(let s=-1;s<=1;s++){const r=e+s,l=t+i;if(r>=0&&r<a&&l>=0&&l<a){const e="".concat(r,",").concat(l);he.visited.has(e)||(he.visited.add(e),n[l][r].visited=!0,o++)}}return await Lt("mapFragment",1),zt(),he.currentMinion={name:"Map Fragment",imagePath:"",message:o>0?"The ancient map reveals ".concat(o," hidden area").concat(o>1?"s":"","!"):"The map shows only what you already knew."},_t(),await j("onItemRemove",{item:"mapFragment",count:1,total:he.inventory.mapFragment}),!0}()));const p=l.querySelector(".inventory-item.portal-stone");p&&p.addEventListener("click",(()=>async function(){if(!he||he.isPaused)return!1;if(!he.inventory.portalStone||he.inventory.portalStone<=0)return console.log("[MazeMaster] No Portal Stones available"),!1;const e=[];for(const n of he.visited){var t;const[a,o]=n.split(",").map(Number),i=null===(t=he.grid[o])||void 0===t?void 0:t[a];null==i||!i.portal||a===he.playerX&&o===he.playerY||e.push({x:a,y:o,portal:i.portal})}if(0===e.length)return he.currentMinion={name:"Portal Stone",imagePath:"",message:"No revealed portals to teleport to. Explore more to find portals first!"},_t(),!1;if(1===e.length){const t=e[0];return await V(t.x,t.y),!0}const n=e[0];return await V(n.x,n.y),!0}()));const u=l.querySelector(".inventory-item.void-walk");u&&u.addEventListener("click",(e=>{e.stopPropagation(),function(){if(!he||he.isPaused)return!1;if(!he.inventory.voidWalk||he.inventory.voidWalk<=0)return console.log("[MazeMaster] No Void Walk available"),!1;if(he.voidWalkActive)return console.log("[MazeMaster] Void Walk already active"),!1;he.voidWalkActive=!0;const e=document.getElementById("maze_dpad");e&&e.classList.add("void-walk-active"),he.currentMinion={name:"Void Walk",imagePath:"",message:"You become ethereal... Your next move can phase through walls!"},_t()}()}));const h=document.getElementById("maze_inventory_bar"),g=document.getElementById("maze_inventory_drawer");h&&g&&h.addEventListener("click",(e=>{if(e.target.closest('[data-usable="true"]'))return;!g.classList.contains("hidden")?(g.classList.add("hidden"),h.classList.remove("expanded")):(!function(){const e=document.querySelector(".inventory-drawer-content");if(!e)return;const t=he.profile,n=he.inventory,a=[{id:"key",icon:"fa-key",colorClass:""},{id:"stealth",icon:"fa-user-ninja",colorClass:""},{id:"pow",icon:"fa-bolt",colorClass:""},{id:"grandpow",icon:"fa-star",colorClass:"grandpow"},{id:"floorKey",icon:"fa-stairs",colorClass:"floor-key"},{id:"portalStone",icon:"fa-gem",colorClass:"portal-stone"},{id:"minionBane",icon:"fa-skull-crossbones",colorClass:"minion-bane"},{id:"mapFragment",icon:"fa-scroll",colorClass:"map-fragment"},{id:"timeShard",icon:"fa-hourglass-half",colorClass:"time-shard"},{id:"voidWalk",icon:"fa-ghost",colorClass:"void-walk"}];e.innerHTML=a.map((e=>{const a=n[e.id]||0,o=function(e,t){var n;const a=(null==t?void 0:t.theme)||"fantasy",o=w[a]||w.fantasy;return(null==o||null===(n=o.itemAliases)||void 0===n?void 0:n[e])||e}(e.id,t),i=0===a?"empty":"";return'\n            <div class="inventory-drawer-item '.concat(e.colorClass," ").concat(i,'">\n                <i class="fa-solid ').concat(e.icon,'"></i>\n                <span class="item-name">').concat(o,'</span>\n                <span class="item-count">x').concat(a,"</span>\n            </div>\n        ")})).join("")}(),g.classList.remove("hidden"),h.classList.add("expanded"))})),Y(he.profile);const f=document.getElementById("maze_close_btn");f&&(f.addEventListener("click",yt),f.addEventListener("touchend",(e=>{e.preventDefault(),yt()})));null===(o=document.getElementById("maze_power_btn"))||void 0===o||o.addEventListener("click",(()=>{!function(){const e=document.getElementById("maze_save_dialog");e&&e.remove();const n=document.createElement("div");n.id="maze_save_dialog",n.innerHTML='\n        <div class="maze-save-dialog-backdrop"></div>\n        <div class="maze-save-dialog-content">\n            <div class="maze-save-dialog-title">Do you wish to save?</div>\n            <div class="maze-save-dialog-buttons">\n                <button id="maze_save_yes" class="maze-save-btn maze-save-yes">Yes</button>\n                <button id="maze_save_no" class="maze-save-btn maze-save-no">No</button>\n                <button id="maze_save_cancel" class="maze-save-btn maze-save-cancel">Cancel</button>\n            </div>\n        </div>\n    ';const a=document.getElementById("mazemaster_maze_modal");a?a.appendChild(n):document.body.appendChild(n);document.getElementById("maze_save_yes").addEventListener("click",(()=>{n.remove(),function(){if(!he.isOpen||!he.profileName)return console.warn("[MazeMaster] No active maze to save"),!1;const e={profileName:he.profileName,size:he.size,playerX:he.playerX,playerY:he.playerY,exitX:he.exitX,exitY:he.exitY,visited:Array.from(he.visited),inventory:t({},he.inventory),exitEncounterDone:he.exitEncounterDone,shownMilestones:Array.from(he.shownMilestones||[]),currentFloor:he.currentFloor||0,totalFloors:he.totalFloors||1,floors:(he.floors||[he.grid]).map((e=>e.map((e=>e.map((e=>({walls:e.walls,visited:e.visited,minion:e.minion,trap:e.trap,chest:e.chest,staircase:e.staircase,roomInfo:e.roomInfo}))))))),grid:he.grid.map((e=>e.map((e=>({walls:e.walls,visited:e.visited,minion:e.minion,trap:e.trap,chest:e.chest,staircase:e.staircase,roomInfo:e.roomInfo}))))),messageLog:he.messageLog||[],timestamp:Date.now()};de.savedMazes[he.profileName]=e,i(),console.log('[MazeMaster] Maze progress saved for "'.concat(he.profileName,'"'))}(),yt(),hn()})),document.getElementById("maze_save_no").addEventListener("click",(()=>{n.remove(),yt()})),document.getElementById("maze_save_cancel").addEventListener("click",(()=>{n.remove()})),n.querySelector(".maze-save-dialog-backdrop").addEventListener("click",(()=>{n.remove()}))}()}))}function yt(){he.isOpen=!1,document.removeEventListener("keydown",Mt,{capture:!0});const e=document.getElementById("mazemaster_maze_modal");e&&e.remove()}function zt(){T.getRenderer().render(he)}function xt(e,t){t&&(arguments.length>2&&void 0!==arguments[2]&&arguments[2]||he.messageLog.push({speaker:e,message:t,timestamp:Date.now()}),wt())}function wt(){const e=document.getElementById("maze_message_log");e&&(e.innerHTML=he.messageLog.map((e=>'\n        <div class="maze-message-entry">\n            <div class="maze-message-speaker">'.concat($t(e.speaker),'</div>\n            <div class="maze-message-text">').concat($t(e.message),"</div>\n        </div>\n    "))).join(""),e.scrollTop=e.scrollHeight)}function _t(){const{currentMinion:e,isVictory:t,profile:n,messageLog:a}=he,o=document.getElementById("maze_minion_img"),i=document.getElementById("maze_minion_name"),s=document.getElementById("maze_minion_role");if(t){n.winImage&&o&&(o.src=ie(n.winImage),o.style.display=""),i&&(i.textContent="Victory!"),s&&(s.textContent="");const e=n.winMessage||"You escaped the maze!",t=a[a.length-1];t&&t.message===e||xt("Victory!",e)}else if(e&&(e.imagePath&&o?(o.src=ie(e.imagePath),o.style.display="block"):o&&(o.style.display="none"),i&&(i.textContent=e.name||""),s&&(s.textContent=e.role||""),e.message)){const t=a[a.length-1];t&&t.message===e.message||xt(e.name||"Unknown",e.message)}wt()}function St(e){const t=document.getElementById("maze_generating_indicator");t&&t.classList.toggle("active",e)}function kt(){var e,t,n;if(!he.isOpen)return;const{playerX:a,playerY:o,grid:i}=he,s=null===(e=i[o])||void 0===e?void 0:e[a];if(!s)return;const r=document.getElementById("room_info_name"),l=document.getElementById("room_info_desc");r&&(r.textContent=(null===(t=s.roomInfo)||void 0===t?void 0:t.name)||"Unknown Room"),l&&(l.textContent=(null===(n=s.roomInfo)||void 0===n?void 0:n.description)||"...");const c=document.getElementById("room_info_exits");if(c){const e=[];s.walls.top||e.push("North"),s.walls.right||e.push("East"),s.walls.bottom||e.push("South"),s.walls.left||e.push("West"),c.textContent=e.length?e.join(", "):"None"}const m=document.getElementById("room_info_occupants");if(m){const e=[];if(s.minion&&!s.minion.defeated&&!s.minion.triggered){const t=Ie(s.minion.minionId);e.push((null==t?void 0:t.name)||"Unknown Entity")}s.chest&&!s.chest.opened&&e.push("locked"===s.chest.type?"Locked Chest":"Chest"),s.trap&&!s.trap.triggered&&e.push("Something feels off..."),m.textContent=e.length?e.join(", "):"None"}const d=document.getElementById("room_info_defeated");if(d){var p,u,h,g;const e=[];if(null!==(p=s.minion)&&void 0!==p&&p.defeated||null!==(u=s.minion)&&void 0!==u&&u.triggered){const t=Ie(s.minion.minionId);e.push((null==t?void 0:t.name)||"Unknown")}null!==(h=s.chest)&&void 0!==h&&h.opened&&e.push("Opened Chest"),null!==(g=s.trap)&&void 0!==g&&g.triggered&&e.push("Triggered Trap"),d.textContent=e.length?e.join(", "):"None"}}function Mt(e){if(!he.isOpen||he.isVictory)return;if(e.shiftKey&&("ArrowUp"===e.key||"ArrowDown"===e.key)){const t="ArrowUp"===e.key?"up":"down";return e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),void K(t)}let t=0,n=0;if("ArrowUp"===e.key)n=-1;else if("ArrowDown"===e.key)n=1;else if("ArrowLeft"===e.key)t=-1;else{if("ArrowRight"!==e.key)return;t=1}e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),Et(t,n)}async function Et(e,t){if(!he.isOpen||he.isVictory)return;if(he.isPaused)return;const{playerX:n,playerY:a,grid:o,size:i}=he,s=n+e,r=a+t;if(s<0||s>=i||r<0||r>=i)return;const l=o[a][n];let c=!1;if(1===e&&l.walls.right&&(c=!0),-1===e&&l.walls.left&&(c=!0),1===t&&l.walls.bottom&&(c=!0),-1===t&&l.walls.top&&(c=!0),c){if(!he.voidWalkActive)return;await async function(){var e;if(null!==(e=he)&&void 0!==e&&e.voidWalkActive){he.voidWalkActive=!1,await Lt("voidWalk",1);const e=document.getElementById("maze_dpad");e&&e.classList.remove("void-walk-active")}}(),c=!1}else he.voidWalkActive&&function(){var e;if(null!==(e=he)&&void 0!==e&&e.voidWalkActive){he.voidWalkActive=!1;const e=document.getElementById("maze_dpad");e&&e.classList.remove("void-walk-active")}}();const m=1===e?"right":-1===e?"left":1===t?"down":"up";if(he.playerX=s,he.playerY=r,he.visited.add("".concat(he.currentFloor,":").concat(s,",").concat(r)),he.moveCount++,await D("moves",1),await j("onMove",{x:s,y:r,direction:m}),N(),async function(){var e;if(!he)return;const t=F();if(null!==(e=he.profile)&&void 0!==e&&e.objectives){for(const e of he.profile.objectives)if("explore"===e.type){const n=he.objectiveProgress[e.id];n&&!n.completed&&(n.current=t,t>=(e.count||100)&&(n.completed=!0,await j("onObjectiveComplete",{objectiveId:e.id}),e.reward&&e.reward.trim()&&await L(e.reward)))}te(),ee()}!he.explorationComplete&&t>=100&&(he.explorationComplete=!0,await j("onExploreComplete",{percentage:100}))}(),J(!0),zt(),s===he.exitX&&r===he.exitY)return void async function(){const e=he.profile;if(!function(){var e;if(!he||null===(e=he.profile)||void 0===e||!e.objectives)return!0;const t=he.profile.objectives,n=he.objectiveProgress,a=t.filter((e=>e.required));return 0===a.length||a.every((e=>{var t;return null===(t=n[e.id])||void 0===t?void 0:t.completed}))}()){const t=e.mainMinion?Ie(e.mainMinion):null;he.currentMinion={name:(null==t?void 0:t.name)||"Exit",imagePath:(null==t?void 0:t.imagePath)||"",message:"You haven't completed all required objectives yet! Explore the maze to find what you need."},_t();const n=document.querySelector(".maze-objectives-section");return void(n&&(n.classList.add("objectives-flash"),setTimeout((()=>n.classList.remove("objectives-flash")),500)))}if(!e.mainMinion||he.exitEncounterDone)return void Jt();const t=Ie(e.mainMinion);if(!t)return void Jt();he.isPaused=!0,he.currentMinion={name:t.name,imagePath:t.imagePath,message:"You've reached the exit... but first, face me!"},_t();const n=e.mainMinionExitType||"messenger",a=e.mainMinionExitProfile;switch(n){case"messenger":await(o=2e3,new Promise((e=>setTimeout(e,o)))),he.exitEncounterDone=!0,he.isPaused=!1,Jt();break;case"battlebar":a?(he.pendingEncounter={type:"exit_battlebar",profile:a},Ne(a)):(he.exitEncounterDone=!0,he.isPaused=!1,Jt());break;case"prizewheel":a?(he.pendingEncounter={type:"exit_wheel",profile:a},je(a),De()):(he.exitEncounterDone=!0,he.isPaused=!1,Jt());break;default:Jt()}var o}();const d=o[r][s];if(!d.chest||d.chest.opened)if(!d.minion||d.minion.triggered)if(!d.trap||d.trap.triggered){if(d.portal){if(await async function(e,t,n){if(!n)return!1;if(!n.bidirectional&&!n.isStart)return!1;const a=n.target;if(!a||null==a.x||null==a.y)return!1;await j("onTeleport",{portalId:n.id,fromX:e,fromY:t,toX:a.x,toY:a.y}),he.playerX=a.x,he.playerY=a.y,he.visited.add("".concat(he.currentFloor,":").concat(a.x,",").concat(a.y)),J(!1),await D("teleportsUsed",1);const o=document.querySelector('.maze-cell[data-x="'.concat(e,'"][data-y="').concat(t,'"]')),i=document.querySelector('.maze-cell[data-x="'.concat(a.x,'"][data-y="').concat(a.y,'"]'));return o&&(o.classList.add("portal-flash"),setTimeout((()=>o.classList.remove("portal-flash")),300)),i&&(i.classList.add("portal-flash"),setTimeout((()=>i.classList.remove("portal-flash")),300)),console.log("[MazeMaster] Teleported from (".concat(e,",").concat(t,") to (").concat(a.x,",").concat(a.y,")")),!0}(s,r,d.portal)){zt();const e=o[he.playerY][he.playerX];if(e.chest&&!e.chest.opened)return void jt(e.chest,he.playerX,he.playerY);if(e.minion&&!e.minion.triggered)return void Ct(e.minion.minionId,he.playerX,he.playerY);if(e.trap&&!e.trap.triggered)return void It(e.trap.trapId,he.playerX,he.playerY)}}!async function(){const e=he.profile;if(!e.mainMinion)return;if(!e.mainMinionRandomChance)return;if(!e.mainMinionRandomMessages||0===e.mainMinionRandomMessages.length)return;if(100*Math.random()>e.mainMinionRandomChance)return;const t=Ie(e.mainMinion);if(!t)return;const n=gt(e.mainMinionRandomMessages);if(!n)return;he.currentMinion={name:t.name,imagePath:t.imagePath,message:"..."},_t(),St(!0);let a=n;try{a=await ve({minionName:t.name,minionDescription:t.description,baseMessage:n,mainStory:ye(),currentMilestone:be(),minionType:t.type||"messenger"})}catch(e){console.error("[MazeMaster] Random message LLM generation error:",e)}St(!1),he.currentMinion.message=a,_t()}(),function(){const e=he.profile;if(!e.storyConfig||!e.storyConfig.milestones||0===e.storyConfig.milestones.length)return;const t=he.size*he.size,n=he.visited.size,a=Math.floor(n/t*100);for(const t of e.storyConfig.milestones)if(a>=t.percent&&!he.shownMilestones.has(t.percent)){he.shownMilestones.add(t.percent);const n=e.mainMinion?Ie(e.mainMinion):null;return he.currentMinion={name:(null==n?void 0:n.name)||"Story",imagePath:(null==n?void 0:n.imagePath)||"",message:t.storyUpdate},void _t()}}(),await async function(){if(!he||!he.movingMinions||0===he.movingMinions.length)return;const{grid:e,size:t,playerX:n,playerY:a,moveCount:o}=he,i=O(he.profile);for(const r of he.movingMinions){var s;if(r.triggered)continue;if(o%(r.movement.speed||1)!==0)continue;const l=Z(r,e,t,n,a,i);if(!l)continue;const c=r.x,m=r.y;if((null===(s=e[m][c].minion)||void 0===s?void 0:s.minionId)===r.minionId&&(e[m][c].minion=null),r.x=l.x,r.y=l.y,e[l.y][l.x].minion={minionId:r.minionId,triggered:!1},await j("onEnemyMove",{minionId:r.minionId,fromX:c,fromY:m,toX:l.x,toY:l.y}),l.x===n&&l.y===a)return console.log("[MazeMaster] Moving minion ".concat(r.minionId," caught the player!")),r.triggered=!0,e[l.y][l.x].minion.triggered=!0,void Ct(r.minionId,l.x,l.y)}}(),he.movingMinions&&he.movingMinions.length>0&&zt()}else It(d.trap.trapId,s,r);else Ct(d.minion.minionId,s,r);else jt(d.chest,s,r)}async function Ct(e,t,n){var a;const o=Ie(e);if(!o)return void console.warn('[MazeMaster] Minion "'.concat(e,'" not found'));const i=he.grid[n][t];if(null!==(a=i.minion)&&void 0!==a&&a.triggered)return void console.log("[MazeMaster] Minion at ".concat(t,",").concat(n," already triggered, skipping"));i.minion.triggered=!0,console.log("[MazeMaster] Marked minion at ".concat(t,",").concat(n," as triggered"));if("messenger"!==(o.type||"messenger")&&he.inventory.minionBane>0){if(await async function(){var e;return!(null===(e=he)||void 0===e||!e.inventory.minionBane||he.inventory.minionBane<=0||(await Lt("minionBane",1),he.currentMinion={name:"Minion Bane",imagePath:"",message:"Your Minion Bane flares with power, instantly vanquishing the foe!"},_t(),0))}())return i.minion.defeated=!0,await D("encountersWon",1),await $("defeat",e,1),zt(),void setTimeout((()=>{he.isPaused=!1,resetMazeHero()}),2e3)}await D("encountersTotal",1),await $("defeat",e,1),he.isPaused=!0,he.currentMinion={name:o.name,imagePath:o.imagePath,message:"..."},_t(),zt();const s=gt(o.messages)||"You encountered ".concat(o.name,"!");St(!0);let r=s;try{r=await ve({minionName:o.name,minionDescription:o.description,baseMessage:s,mainStory:ye(),currentMilestone:be(),minionType:o.type||"messenger"})}catch(e){console.error("[MazeMaster] LLM generation error:",e)}St(!1),he.currentMinion.message=r,_t(),o.encounterScript&&o.encounterScript.trim()&&(console.log("[MazeMaster] Executing encounter script for ".concat(o.name)),await L(o.encounterScript)),function(e,t,n,a){var o,i,s,r,l;const c=Ie(e),m="messenger"!==a&&"merchant"!==a&&he.inventory.stealth>0;he.pendingConfirmation={type:a,minionId:e,x:t,y:n,canSlipAway:m};const d=document.getElementById("maze_encounter_confirm");if(!d)return;let p="";if("messenger"===a)p='<button id="maze_confirm_ok" class="menu_button maze-confirm-btn">OK</button>';else if("merchant"===a){const e=c.merchantItemCount||{min:1,max:3},t=e.min+Math.floor(Math.random()*(e.max-e.min+1));he.pendingConfirmation.merchantItemCount=t;const n="I'll give you a GRANDPOW for ".concat(t," of your items...");he.currentMinion.message=n,_t(),p='\n            <button id="maze_confirm_accept" class="menu_button maze-confirm-btn maze-accept-btn">Accept</button>\n            <button id="maze_confirm_decline" class="menu_button maze-confirm-btn">Decline</button>\n        '}else{p='<button id="maze_confirm_action" class="menu_button maze-confirm-btn">'.concat("battlebar"===a?"Fight!":"Spin!","</button>"),m&&(p+='<button id="maze_confirm_slip" class="menu_button maze-confirm-btn maze-slip-btn">Slip Away</button>')}d.innerHTML=p,d.style.display="flex",null===(o=document.getElementById("maze_confirm_ok"))||void 0===o||o.addEventListener("click",Ht),null===(i=document.getElementById("maze_confirm_action"))||void 0===i||i.addEventListener("click",Gt),null===(s=document.getElementById("maze_confirm_slip"))||void 0===s||s.addEventListener("click",Yt),null===(r=document.getElementById("maze_confirm_accept"))||void 0===r||r.addEventListener("click",Ut),null===(l=document.getElementById("maze_confirm_decline"))||void 0===l||l.addEventListener("click",Kt)}(e,t,n,o.type||"messenger")}async function It(e,t,n){const a=Be(e);if(!a)return void console.warn('[MazeMaster] Trap "'.concat(e,'" not found'));he.grid[n][t].trap.triggered=!0,zt(),await D("trapsTriggered",1),he.isPaused=!0,he.currentMinion={name:a.name,imagePath:a.imagePath,message:"..."},_t(),St(!0);const o=a.message||"You triggered a trap!";let i=o;try{i=await async function(e){const{trapName:t,baseMessage:n,mainStory:a}=e;if(!n)return"";if(!1===de.llmEnabled)return n;if("function"!=typeof h)return n;const o=A(),i="The player ".concat(o,' has triggered a trap called "').concat(t,'" in a maze.\n\n').concat(a?"Story Setting: ".concat(a,"\n\n"):"",'Based on this trap description: "').concat(n,'"\n\nWrite a short, dramatic narration of the trap being triggered (1-2 sentences, under 100 characters). Make it visceral and immediate. You may reference the player by name. Do not use quotation marks.');try{console.log("[MazeMaster] Generating LLM message for trap:",t);const e=await h(i,{quietToLoud:!1,skipWIAN:!0,skipWI:!0,max_length:80});if(e&&e.trim()){let t=e.trim();return t=t.replace(/^["']|["']$/g,""),t=t.replace(/^["""''']|["""''']$/g,""),console.log("[MazeMaster] Generated trap message:",t),t}}catch(e){console.error("[MazeMaster] Trap LLM generation failed:",e)}return n}({trapName:a.name,baseMessage:o,mainStory:ye()})}catch(e){console.error("[MazeMaster] Trap LLM generation error:",e)}St(!1),he.currentMinion.message=i,_t(),a.script&&a.script.trim()&&(console.log("[MazeMaster] Executing trap script for ".concat(a.name)),await L(a.script)),function(){var e;const t=document.getElementById("maze_encounter_confirm");if(!t)return;t.innerHTML='\n        <button id="maze_trap_continue" class="menu_button maze-confirm-btn">Continue</button>\n    ',t.style.display="flex",null===(e=document.getElementById("maze_trap_continue"))||void 0===e||e.addEventListener("click",(()=>{t.style.display="none",t.innerHTML="",Tt()}))}()}function Tt(){he.isPaused=!1,he.pendingEncounter=null;const e=document.getElementById("maze_encounter_confirm");e&&(e.innerHTML="",e.style.display="none");const t=he.profile;if(t.mainMinion){const e=Ie(t.mainMinion);if(e)return he.currentMinion={name:e.name,imagePath:e.imagePath,message:"Continue onward..."},void _t()}he.currentMinion={name:"The Maze",imagePath:"",message:"Find your way to the exit..."},_t()}function Pt(){const e=document.getElementById("maze_inv_key"),t=document.getElementById("maze_inv_stealth"),n=document.getElementById("maze_inv_pow"),a=document.getElementById("maze_inv_grandpow");e&&(e.textContent=he.inventory.key),t&&(t.textContent=he.inventory.stealth),n&&(n.textContent=he.inventory.pow),a&&(a.textContent=he.inventory.grandpow||0);const o=["floorKey","portalStone","minionBane","mapFragment","timeShard","voidWalk"];for(const e of o){const t=document.getElementById("maze_inv_".concat(e));t&&(t.textContent=he.inventory[e]||0)}}async function Bt(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;var n;void 0!==he.inventory[e]&&(he.inventory[e]+=t,Pt(),void 0!==(null===(n=he.stats)||void 0===n||null===(n=n.itemsCollected)||void 0===n?void 0:n[e])&&(he.stats.itemsCollected[e]+=t),await j("onItemAdd",{item:e,count:t,total:he.inventory[e]}),await $("collect",e,t))}async function Lt(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;if(void 0!==he.inventory[e]){const n=he.inventory[e];he.inventory[e]=Math.max(0,n-t),Pt(),await j("onItemRemove",{item:e,count:Math.min(n,t),total:he.inventory[e]})}}async function jt(e,t,n){var a;he.isPaused=!0,he.pendingChest={chestData:e,x:t,y:n};const o="locked"===e.type,i=he.inventory.key>0,s=o?i?"A locked chest! Use a key to open it?":"A locked chest! You need a Key to open it.":"You found a chest!";he.currentMinion={name:o?"Locked Chest":"Chest",imagePath:"",message:s},_t();const r=(null===(a=he.profile)||void 0===a||null===(a=a.storyConfig)||void 0===a?void 0:a.mainStory)||"";St(!0);try{const e=await async function(e){const{chestType:t,baseMessage:n,mainStory:a,hasKey:o}=e;if(!n)return"";if(!1===de.llmEnabled)return n;if("function"!=typeof h)return n;const i="locked"===t?o?"a locked treasure chest - the player has a key to open it":"a locked treasure chest - the player lacks the key":"a treasure chest waiting to be opened",s=A(),r="The player ".concat(s," has discovered ").concat(i," in a maze.\n\n").concat(a?"Story Setting: ".concat(a,"\n\n"):"",'Based on this chest discovery message: "').concat(n,'"\n\nWrite a short, atmospheric description of finding the chest (1-2 sentences, under 100 characters). Make it feel rewarding and mysterious. You may reference the player by name. Do not use quotation marks.');try{console.log("[MazeMaster] Generating LLM message for chest");const e=await h(r,{quietToLoud:!1,skipWIAN:!0,skipWI:!0,max_length:80});if(e&&e.trim()){let t=e.trim();return t=t.replace(/^["']|["']$/g,""),t=t.replace(/^["""''']|["""''']$/g,""),console.log("[MazeMaster] Generated chest message:",t),t}}catch(e){console.error("[MazeMaster] Chest LLM generation failed:",e)}return n}({chestType:o?"locked":"normal",baseMessage:s,mainStory:r,hasKey:i});he.currentMinion.message=e,_t()}catch(e){console.error("[MazeMaster] Chest message generation failed:",e)}finally{St(!1)}!function(e,t){var n,a,o;const i=document.getElementById("maze_encounter_confirm");if(!i)return;let s="";s=e?t?'\n                <button id="maze_chest_unlock" class="menu_button maze-confirm-btn">Unlock</button>\n                <button id="maze_chest_ignore" class="menu_button maze-confirm-btn">Ignore</button>\n            ':'\n                <button id="maze_chest_ignore" class="menu_button maze-confirm-btn">Continue</button>\n            ':'\n            <button id="maze_chest_open" class="menu_button maze-confirm-btn">Open</button>\n            <button id="maze_chest_ignore" class="menu_button maze-confirm-btn">Ignore</button>\n        ';i.innerHTML=s,i.style.display="flex",null===(n=document.getElementById("maze_chest_open"))||void 0===n||n.addEventListener("click",Ot),null===(a=document.getElementById("maze_chest_unlock"))||void 0===a||a.addEventListener("click",At),null===(o=document.getElementById("maze_chest_ignore"))||void 0===o||o.addEventListener("click",Dt)}(o,i)}function Ot(){const e=document.getElementById("maze_encounter_confirm");e&&(e.style.display="none",e.innerHTML="");const{chestData:t,x:n,y:a}=he.pendingChest||{};t&&(he.grid[a][n].chest.opened=!0,zt(),"mimic"!==t.type?async function(e,t){he.pendingChest=null;const n=Rt(he.profile,!1);Ft(n),Wt(n,"Chest"),await D("chestsOpened",1),await j("onChestOpen",{type:"normal",loot:JSON.stringify(n),x:e,y:t})}(n,a):qt(n,a))}function At(){const e=document.getElementById("maze_encounter_confirm");e&&(e.style.display="none",e.innerHTML="");const{chestData:t,x:n,y:a}=he.pendingChest||{};t&&(Lt("key"),he.grid[a][n].chest.opened=!0,zt(),"mimic"!==t.type?async function(e,t){he.pendingChest=null;const n=Rt(he.profile,!0);Ft(n),Wt(n,"Locked Chest"),await D("chestsOpened",1),await j("onChestOpen",{type:"locked",loot:JSON.stringify(n),x:e,y:t})}(n,a):qt(n,a))}function Dt(){const e=document.getElementById("maze_encounter_confirm");e&&(e.style.display="none",e.innerHTML=""),he.pendingChest=null,Tt()}function Rt(e,t){const n={key:0,pow:0,stealth:0,grandpow:0,floorKey:0,portalStone:0,minionBane:0,mapFragment:0,timeShard:0,voidWalk:0},a=e.chestLootMin||1,o=e.chestLootMax||2,i=a+Math.floor(Math.random()*(o-a+1)),s=O(e).chestLootMult||1,r=t?{key:(e.lockedChestKeyChance||40)*s,pow:(e.lockedChestPowChance||60)*s,stealth:(e.lockedChestStealthChance||30)*s,grandpow:(e.lockedChestGrandpowChance||5)*s}:{key:(e.chestKeyChance||30)*s,pow:(e.chestPowChance||50)*s,stealth:(e.chestStealthChance||0)*s,grandpow:(e.chestGrandpowChance||0)*s},l={floorKey:(t?20:10)*s,portalStone:(t?15:8)*s,minionBane:(t?12:5)*s,mapFragment:(t?25:15)*s,timeShard:(t?10:5)*s,voidWalk:(t?8:3)*s};if(t){const t=1+(e.chestLockedBonusPercent||50)/100;r.key=Math.min(100,r.key*t),r.pow=Math.min(100,r.pow*t),r.stealth=Math.min(100,r.stealth*t),r.grandpow=Math.min(100,r.grandpow*t);for(const e of Object.keys(l))l[e]=Math.min(100,l[e]*t)}for(let e=0;e<i;e++)100*Math.random()<r.key&&n.key++,100*Math.random()<r.pow&&n.pow++,100*Math.random()<r.stealth&&n.stealth++,100*Math.random()<r.grandpow&&n.grandpow++,100*Math.random()<l.floorKey&&n.floorKey++,100*Math.random()<l.portalStone&&n.portalStone++,100*Math.random()<l.minionBane&&n.minionBane++,100*Math.random()<l.mapFragment&&n.mapFragment++,100*Math.random()<l.timeShard&&n.timeShard++,100*Math.random()<l.voidWalk&&n.voidWalk++;return n}function Ft(e){e.key>0&&Bt("key",e.key),e.pow>0&&Bt("pow",e.pow),e.stealth>0&&Bt("stealth",e.stealth),e.grandpow>0&&Bt("grandpow",e.grandpow),e.floorKey>0&&Bt("floorKey",e.floorKey),e.portalStone>0&&Bt("portalStone",e.portalStone),e.minionBane>0&&Bt("minionBane",e.minionBane),e.mapFragment>0&&Bt("mapFragment",e.mapFragment),e.timeShard>0&&Bt("timeShard",e.timeShard),e.voidWalk>0&&Bt("voidWalk",e.voidWalk)}function Nt(e,t){he.currentMinion={name:t,imagePath:"",message:e},_t()}function Wt(e,t){const n=[];e.key>0&&n.push("".concat(e.key," Key").concat(e.key>1?"s":"")),e.pow>0&&n.push("".concat(e.pow," POW").concat(e.pow>1?"s":"")),e.stealth>0&&n.push("".concat(e.stealth," Stealth").concat(e.stealth>1?"s":"")),e.grandpow>0&&n.push("".concat(e.grandpow," GRANDPOW!")),e.floorKey>0&&n.push("".concat(e.floorKey," Floor Key").concat(e.floorKey>1?"s":"")),e.portalStone>0&&n.push("".concat(e.portalStone," Portal Stone").concat(e.portalStone>1?"s":"")),e.minionBane>0&&n.push("".concat(e.minionBane," Minion Bane").concat(e.minionBane>1?"s":"")),e.mapFragment>0&&n.push("".concat(e.mapFragment," Map Fragment").concat(e.mapFragment>1?"s":"")),e.timeShard>0&&n.push("".concat(e.timeShard," Time Shard").concat(e.timeShard>1?"s":"")),e.voidWalk>0&&n.push("".concat(e.voidWalk," Void Walk").concat(e.voidWalk>1?"s":""));Nt(n.length>0?"You found: ".concat(n.join(", "),"!"):"The chest was empty!",t),setTimeout((()=>Tt()),2e3)}function qt(e,t){he.pendingChest=null;const n=we();if(n.length>0){const e=n[Math.floor(Math.random()*n.length)];he.pendingEncounter={type:"mimic_battlebar",profile:e},he.currentMinion={name:"Mimic!",imagePath:"",message:"The chest was a mimic! Prepare to fight!"},_t(),setTimeout((()=>{Ne(e)}),1e3)}else Nt("The chest was empty... and creepy.","Mimic"),setTimeout((()=>Tt()),1500)}function Ht(){he.pendingConfirmation=null,Tt()}function Gt(){const e=he.pendingConfirmation;if(!e)return;const t=Ie(e.minionId);if(he.pendingConfirmation=null,"battlebar"===e.type){const e=gt(t.battlebarProfiles);e?(he.pendingEncounter={type:"battlebar",profile:e},Ne(e)):Tt()}else if("prizewheel"===e.type){const e=gt(t.wheelProfiles);e?(he.pendingEncounter={type:"wheel",profile:e},je(e),De()):Tt()}}function Yt(){he.inventory.stealth>0&&(Lt("stealth"),he.pendingConfirmation=null,Tt())}function Ut(){const e=he.pendingConfirmation;if(!e||"merchant"!==e.type)return;const t=e.merchantItemCount||1,n=(he.inventory.key||0)+(he.inventory.stealth||0)+(he.inventory.pow||0);if(n<t){he.currentMinion.message="You don't have enough items! You need ".concat(t," but only have ").concat(n,"."),_t();const e=document.getElementById("maze_encounter_confirm");var a;if(e)e.innerHTML='<button id="maze_confirm_decline" class="menu_button maze-confirm-btn">OK</button>',e.style.display="flex",null===(a=document.getElementById("maze_confirm_decline"))||void 0===a||a.addEventListener("click",Kt);return}let o=t;const i=["key","stealth","pow"];for(;o>0;){const e=i.filter((e=>he.inventory[e]>0));if(0===e.length)break;Lt(e[Math.floor(Math.random()*e.length)]),o--}Bt("grandpow"),he.currentMinion.message="Pleasure doing business with you! Here's your GRANDPOW!",_t();const s=document.getElementById("maze_encounter_confirm");var r;s&&(s.innerHTML='<button id="maze_confirm_ok" class="menu_button maze-confirm-btn">OK</button>',s.style.display="flex",null===(r=document.getElementById("maze_confirm_ok"))||void 0===r||r.addEventListener("click",Ht))}function Kt(){he.pendingConfirmation=null,Tt()}function Xt(){he.isVictory=!1,he.isPaused=!0,G(),q("lose"),ge.maze[he.profileName]={result:"lose",timestamp:Date.now()},document.getElementById("maze_minion_name").textContent="Defeat!",xt("Defeat!","You have been defeated...");const e=document.getElementById("maze_minion_img");e&&(e.style.display="none");const t=document.getElementById("maze_close_btn");t&&(t.style.display=""),he.profile.loseCommand&&L(he.profile.loseCommand),document.removeEventListener("keydown",Mt,{capture:!0})}function Vt(){he.playerX=0,he.playerY=0,he.isPaused=!1,he.pendingEncounter=null,zt();const e=he.profile;if(e.mainMinion){const t=Ie(e.mainMinion);if(t)return he.currentMinion={name:t.name,imagePath:t.imagePath,message:"Back to the beginning with you!"},void _t()}he.currentMinion={name:"The Maze",imagePath:"",message:"Find your way to the exit..."},_t()}async function Jt(){he.isVictory=!0,G(),q("win"),ge.maze[he.profileName]={result:"win",timestamp:Date.now()},_t(),zt();const e=document.getElementById("maze_close_btn");e&&(e.style.display="");const t=document.querySelector(".mazemaster-maze-controls");t&&(t.style.display="none"),document.removeEventListener("keydown",Mt,{capture:!0}),he.profile.winCommand&&await L(he.profile.winCommand),console.log('[MazeMaster] Maze "'.concat(he.profileName,'" completed!'))}function Zt(){var e,t,n,a,o,i,s,r,l,c;const m=ze(),d=de.currentProfile||"default",p=we(),u=de.currentBattlebarProfile||"default",h=_e(u)||{},g=ke(),f=de.currentMazeProfile||"default",v=Me(f)||{},b=Ce(),y=de.activeGameConfig||"wheel";return'\n        <div class="mazemaster-panel">\n            <div class="mazemaster-panel-header">\n                <h2><i class="fa-solid fa-gamepad"></i> MazeMaster</h2>\n            </div>\n            <div class="mazemaster-tabs">\n                <button class="mazemaster-tab" data-tab="game">Game</button>\n                <button class="mazemaster-tab active" data-tab="config">Config</button>\n            </div>\n            <div class="mazemaster-panel-content">\n                \x3c!-- GAME TAB --\x3e\n                <div class="mazemaster-tab-content" id="mazemaster-tab-game">\n                    <div class="mazemaster-game-launch">\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Maze Profile</label>\n                            <select id="mazemaster_play_profile" class="mazemaster-select">\n                                '.concat(0===g.length?'<option value="">No profiles</option>':"","\n                                ").concat(g.map((e=>'<option value="'.concat($t(e),'" ').concat(e===f?"selected":"",">").concat($t(e),"</option>"))).join(""),'\n                            </select>\n                        </div>\n                        <button id="mazemaster_play_maze" class="menu_button menu_button_primary mazemaster-play-btn">\n                            <i class="fa-solid fa-play"></i> Play Maze\n                        </button>\n                    </div>\n\n                    \x3c!-- LLM Generation Settings --\x3e\n                    <div class="mazemaster-section">\n                        <label class="mazemaster-label"><i class="fa-solid fa-brain"></i> LLM Message Generation</label>\n                        <div class="mazemaster-form-group">\n                            <label>Generation Preset</label>\n                            <select id="mazemaster_llm_preset" class="mazemaster-select">\n                                <option value="">(Use Current)</option>\n                                \x3c!-- Presets populated dynamically --\x3e\n                            </select>\n                        </div>\n                        <label class="mazemaster-checkbox-label">\n                            <input type="checkbox" id="mazemaster_llm_enabled" ').concat(!1!==de.llmEnabled?"checked":"",'>\n                            Enable LLM message generation\n                        </label>\n                    </div>\n\n                    \x3c!-- D-Pad Settings --\x3e\n                    <div class="mazemaster-section">\n                        <label class="mazemaster-label"><i class="fa-solid fa-gamepad"></i> D-Pad Controls</label>\n                        <label class="mazemaster-checkbox-label">\n                            <input type="checkbox" id="mazemaster_dpad_enabled" ').concat(!1!==(null===(e=de.dpadConfig)||void 0===e?void 0:e.enabled)?"checked":"",'>\n                            Enable D-Pad controls\n                        </label>\n                        <label class="mazemaster-checkbox-label">\n                            <input type="checkbox" id="mazemaster_dpad_floating" ').concat(!1!==(null===(t=de.dpadConfig)||void 0===t?void 0:t.floating)?"checked":"",'>\n                            Floating D-Pad (draggable position)\n                        </label>\n                        <button id="mazemaster_dpad_reset" class="menu_button" style="margin-top: 6px;">\n                            <i class="fa-solid fa-rotate-left"></i> Reset D-Pad Position\n                        </button>\n                    </div>\n\n                    \x3c!-- Renderer Settings --\x3e\n                    <div class="mazemaster-section">\n                        <label class="mazemaster-label"><i class="fa-solid fa-cube"></i> Renderer</label>\n                        <select id="mazemaster_renderer_type" class="mazemaster-select">\n                            <option value="css-grid" ').concat("css-grid"===(de.rendererType||"css-grid")?"selected":"",'>Classic (CSS Grid)</option>\n                            <option value="isometric" ').concat("isometric"===de.rendererType?"selected":"",'>Isometric 2.5D</option>\n                            <option value="canvas" ').concat("canvas"===de.rendererType?"selected":"",'>Canvas (Experimental)</option>\n                        </select>\n                        <div class="mazemaster-help-small"><small>Isometric gives a 3D-like view. Requires restart of active maze.</small></div>\n                    </div>\n\n                    \x3c!-- Layout Mode --\x3e\n                    <div class="mazemaster-section">\n                        <label class="mazemaster-label"><i class="fa-solid fa-mobile-screen"></i> Layout Mode</label>\n                        <select id="mazemaster_layout_mode" class="mazemaster-select">\n                            <option value="auto" ').concat("auto"===(de.layoutMode||"auto")?"selected":"",'>Auto-detect</option>\n                            <option value="desktop" ').concat("desktop"===de.layoutMode?"selected":"",'>Desktop (Horizontal)</option>\n                            <option value="mobile" ').concat("mobile"===de.layoutMode?"selected":"",'>Mobile (Vertical)</option>\n                        </select>\n                        <div class="mazemaster-help-small"><small>Mobile layout stacks UI vertically for portrait screens.</small></div>\n                    </div>\n\n                    \x3c!-- Saved Games in Game Tab --\x3e\n                    <div class="mazemaster-section">\n                        <label class="mazemaster-label"><i class="fa-solid fa-floppy-disk"></i> Saved Games</label>\n                        <div id="mazemaster_game_tab_saves" class="mazemaster-saved-games-list">\n                            \x3c!-- Saved games rendered here --\x3e\n                        </div>\n                    </div>\n                </div>\n\n                \x3c!-- CONFIG TAB --\x3e\n                <div class="mazemaster-tab-content active" id="mazemaster-tab-config">\n                    \x3c!-- Game Selector --\x3e\n                    <div class="mazemaster-game-selector">\n                        <button id="mazemaster_show_wheel" class="menu_button mazemaster-game-btn ').concat("wheel"===y?"active":"",'">\n                            <i class="fa-solid fa-dharmachakra"></i> Wheel\n                        </button>\n                        <button id="mazemaster_show_battlebar" class="menu_button mazemaster-game-btn ').concat("battlebar"===y?"active":"",'">\n                            <i class="fa-solid fa-bars-progress"></i> Battlebar\n                        </button>\n                        <button id="mazemaster_show_maze" class="menu_button mazemaster-game-btn ').concat("maze"===y?"active":"",'">\n                            <i class="fa-solid fa-border-all"></i> Maze\n                        </button>\n                        <button id="mazemaster_show_minions" class="menu_button mazemaster-game-btn ').concat("minions"===y?"active":"",'">\n                            <i class="fa-solid fa-ghost"></i> Minions\n                        </button>\n                        <button id="mazemaster_show_traps" class="menu_button mazemaster-game-btn ').concat("traps"===y?"active":"",'">\n                            <i class="fa-solid fa-dungeon"></i> Traps\n                        </button>\n                    </div>\n\n                    \x3c!-- WHEEL CONFIG --\x3e\n                    <div id="mazemaster_wheel_config" class="mazemaster-game-config" style="').concat("wheel"===y?"":"display: none;",'">\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Wheel Profile</label>\n                            <div class="mazemaster-profile-row">\n                                <select id="mazemaster_profile_select" class="mazemaster-select">\n                                    ').concat(0===m.length?'<option value="">No profiles</option>':"","\n                                    ").concat(m.map((e=>'<option value="'.concat($t(e),'" ').concat(e===d?"selected":"",">").concat($t(e),"</option>"))).join(""),'\n                                </select>\n                                <button id="mazemaster_new_profile_btn" class="menu_button menu_button_icon" title="New Profile">\n                                    <i class="fa-solid fa-plus"></i>\n                                </button>\n                                <button id="mazemaster_delete_profile_btn" class="menu_button menu_button_icon" title="Delete Profile">\n                                    <i class="fa-solid fa-trash"></i>\n                                </button>\n                                <button id="mazemaster_rename_profile_btn" class="menu_button menu_button_icon" title="Rename Profile">\n                                    <i class="fa-solid fa-pen"></i>\n                                </button>\n                                <button id="mazemaster_export_btn" class="menu_button menu_button_icon" title="Export Profile">\n                                    <i class="fa-solid fa-download"></i>\n                                </button>\n                                <button id="mazemaster_import_btn" class="menu_button menu_button_icon" title="Import Profile">\n                                    <i class="fa-solid fa-upload"></i>\n                                </button>\n                                <input type="file" id="mazemaster_import_file" accept=".json" style="display: none;">\n                                <button id="mazemaster_preview_wheel_btn" class="menu_button menu_button_icon" title="Preview Wheel">\n                                    <i class="fa-solid fa-eye"></i>\n                                </button>\n                            </div>\n                        </div>\n\n                        <div class="mazemaster-section mazemaster-profile-settings">\n                            <div class="mazemaster-profile-options">\n                                <label class="mazemaster-checkbox-label">\n                                    <input type="checkbox" id="mazemaster_randomize" ').concat(null!==(n=xe(d))&&void 0!==n&&n.randomize?"checked":"",'>\n                                    Randomize segment positions\n                                </label>\n                                <div class="mazemaster-difficulty-row">\n                                    <label>Difficulty:</label>\n                                    <select id="mazemaster_difficulty" class="mazemaster-select-small">\n                                        ').concat([1,2,3,4,5].map((e=>{var t;return'<option value="'.concat(e,'" ').concat(((null===(t=xe(d))||void 0===t?void 0:t.difficulty)||1)===e?"selected":"",">").concat(e,"</option>")})).join(""),'\n                                    </select>\n                                </div>\n                            </div>\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Segments</label>\n                            <div id="mazemaster_segments_list" class="mazemaster-segments-list">\n                                \x3c!-- Segments rendered here --\x3e\n                            </div>\n                            <button id="mazemaster_add_segment_btn" class="menu_button mazemaster-add-btn">\n                                <i class="fa-solid fa-plus"></i> Add Segment\n                            </button>\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <button id="mazemaster_save_btn" class="menu_button menu_button_primary mazemaster-save-btn">\n                                <i class="fa-solid fa-save"></i> Save Profile\n                            </button>\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <div class="mazemaster-help">\n                                <div class="mazemaster-help-title">Usage:</div>\n                                <code>/wheel profile="profileName"</code>\n                                <div class="mazemaster-help-title">Sizes:</div>\n                                <ul>\n                                    <li><code>fraction</code> - Normal (1x)</li>\n                                    <li><code>halfseg</code> - Half (0.5x)</li>\n                                    <li><code>doubleseg</code> - Double (2x)</li>\n                                </ul>\n                                <small>halfseg count must equal doubleseg count</small>\n                            </div>\n                        </div>\n                    </div>\n\n                    \x3c!-- BATTLEBAR CONFIG --\x3e\n                    <div id="mazemaster_battlebar_config" class="mazemaster-game-config" style="').concat("battlebar"===y?"":"display: none;",'">\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Battlebar Profile</label>\n                            <div class="mazemaster-profile-row">\n                                <select id="mazemaster_bb_profile_select" class="mazemaster-select">\n                                    ').concat(0===p.length?'<option value="">No profiles</option>':"","\n                                    ").concat(p.map((e=>'<option value="'.concat($t(e),'" ').concat(e===u?"selected":"",">").concat($t(e),"</option>"))).join(""),'\n                                </select>\n                                <button id="mazemaster_bb_new_profile_btn" class="menu_button menu_button_icon" title="New Profile">\n                                    <i class="fa-solid fa-plus"></i>\n                                </button>\n                                <button id="mazemaster_bb_delete_profile_btn" class="menu_button menu_button_icon" title="Delete Profile">\n                                    <i class="fa-solid fa-trash"></i>\n                                </button>\n                                <button id="mazemaster_bb_rename_profile_btn" class="menu_button menu_button_icon" title="Rename Profile">\n                                    <i class="fa-solid fa-pen"></i>\n                                </button>\n                                <button id="mazemaster_bb_export_btn" class="menu_button menu_button_icon" title="Export Profile">\n                                    <i class="fa-solid fa-download"></i>\n                                </button>\n                                <button id="mazemaster_bb_import_btn" class="menu_button menu_button_icon" title="Import Profile">\n                                    <i class="fa-solid fa-upload"></i>\n                                </button>\n                                <input type="file" id="mazemaster_bb_import_file" accept=".json" style="display: none;">\n                                <button id="mazemaster_preview_battlebar_btn" class="menu_button menu_button_icon" title="Preview Battlebar">\n                                    <i class="fa-solid fa-eye"></i>\n                                </button>\n                            </div>\n                        </div>\n\n                        <div class="mazemaster-section mazemaster-profile-settings">\n                            <div class="mazemaster-bb-settings">\n                                <div class="mazemaster-bb-row">\n                                    <div class="mazemaster-bb-field">\n                                        <label>Difficulty</label>\n                                        <select id="mazemaster_bb_difficulty" class="mazemaster-select">\n                                            ').concat([1,2,3,4,5].map((e=>'<option value="'.concat(e,'" ').concat((h.difficulty||3)===e?"selected":"",">").concat(e,"</option>"))).join(""),'\n                                        </select>\n                                    </div>\n                                    <div class="mazemaster-bb-field">\n                                        <label>Hits to Win</label>\n                                        <input type="number" id="mazemaster_bb_hits" min="1" max="20" value="').concat(h.hitsToWin||5,'">\n                                    </div>\n                                    <div class="mazemaster-bb-field">\n                                        <label>Misses to Lose</label>\n                                        <input type="number" id="mazemaster_bb_misses" min="1" max="20" value="').concat(h.missesToLose||3,'">\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Main Title</label>\n                            <input type="text" id="mazemaster_bb_main_title" class="mazemaster-input" placeholder="e.g. Boss Battle!" value="').concat($t(h.mainTitle||""),'">\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Commands</label>\n                            <div class="mazemaster-bb-commands">\n                                <div class="mazemaster-bb-command">\n                                    <label>On Hit:</label>\n                                    <textarea id="mazemaster_bb_hit_cmd" placeholder="/echo Hit!">').concat($t(h.hitCommand||""),'</textarea>\n                                </div>\n                                <div class="mazemaster-bb-command">\n                                    <label>On Miss:</label>\n                                    <textarea id="mazemaster_bb_miss_cmd" placeholder="/echo Miss!">').concat($t(h.missCommand||""),'</textarea>\n                                </div>\n                                <div class="mazemaster-bb-command">\n                                    <label>On Win:</label>\n                                    <textarea id="mazemaster_bb_win_cmd" placeholder="/echo Victory!">').concat($t(h.winCommand||""),'</textarea>\n                                </div>\n                                <div class="mazemaster-bb-command">\n                                    <label>On Lose:</label>\n                                    <textarea id="mazemaster_bb_lose_cmd" placeholder="/echo Defeat!">').concat($t(h.loseCommand||""),'</textarea>\n                                </div>\n                            </div>\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Stages (click image to edit message)</label>\n                            <div id="mazemaster_bb_images_list" class="mazemaster-bb-images-list">\n                                \x3c!-- Images rendered here --\x3e\n                            </div>\n                            <button id="mazemaster_bb_add_image_btn" class="menu_button mazemaster-add-btn">\n                                <i class="fa-solid fa-plus"></i> Add Image\n                            </button>\n                            <input type="file" id="mazemaster_bb_image_file" accept="image/*" style="display: none;">\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Item Drops on Win (Maze Only)</label>\n                            <div class="mazemaster-row">\n                                <label>Key %</label>\n                                <input type="number" id="mazemaster_bb_key_drop" class="mazemaster-input-small" min="0" max="100" value="').concat(null!==(a=h.keyDropChance)&&void 0!==a?a:40,'">\n                            </div>\n                            <div class="mazemaster-row">\n                                <label>POW %</label>\n                                <input type="number" id="mazemaster_bb_pow_drop" class="mazemaster-input-small" min="0" max="100" value="').concat(null!==(o=h.powDropChance)&&void 0!==o?o:20,'">\n                            </div>\n                            <div class="mazemaster-row">\n                                <label>Stealth %</label>\n                                <input type="number" id="mazemaster_bb_stealth_drop" class="mazemaster-input-small" min="0" max="100" value="').concat(null!==(i=h.stealthDropChance)&&void 0!==i?i:10,'">\n                            </div>\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <button id="mazemaster_bb_save_btn" class="menu_button menu_button_primary mazemaster-save-btn">\n                                <i class="fa-solid fa-save"></i> Save Profile\n                            </button>\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <div class="mazemaster-help">\n                                <div class="mazemaster-help-title">Usage:</div>\n                                <code>/battlebar profile="profileName"</code>\n                                <div class="mazemaster-help-title">Difficulty:</div>\n                                <ul>\n                                    <li><code>1</code> - Easy (large zone, slow)</li>\n                                    <li><code>3</code> - Medium</li>\n                                    <li><code>5</code> - Hard (small zone, fast)</li>\n                                </ul>\n                            </div>\n                        </div>\n                    </div>\n\n                    \x3c!-- MAZE CONFIG --\x3e\n                    <div id="mazemaster_maze_config" class="mazemaster-game-config" style="').concat("maze"===y?"":"display: none;",'">\n                        \x3c!-- Profile Selection --\x3e\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Maze Profile</label>\n                            <div class="mazemaster-profile-row">\n                                <select id="mazemaster_maze_profile_select" class="mazemaster-select">\n                                    ').concat(0===g.length?'<option value="">No profiles</option>':"","\n                                    ").concat(g.map((e=>'<option value="'.concat($t(e),'" ').concat(e===f?"selected":"",">").concat($t(e),"</option>"))).join(""),'\n                                </select>\n                                <button id="mazemaster_maze_new_profile_btn" class="menu_button menu_button_icon" title="New Profile">\n                                    <i class="fa-solid fa-plus"></i>\n                                </button>\n                                <button id="mazemaster_maze_delete_profile_btn" class="menu_button menu_button_icon" title="Delete Profile">\n                                    <i class="fa-solid fa-trash"></i>\n                                </button>\n                                <button id="mazemaster_maze_rename_profile_btn" class="menu_button menu_button_icon" title="Rename Profile">\n                                    <i class="fa-solid fa-pen"></i>\n                                </button>\n                            </div>\n                        </div>\n\n                        \x3c!-- Grid Size and Difficulty --\x3e\n                        <div class="mazemaster-inline-row">\n                            <div class="mazemaster-section mazemaster-flex-1">\n                                <label class="mazemaster-label">Grid Size</label>\n                                <select id="mazemaster_maze_size" class="mazemaster-select">\n                                    <option value="7" ').concat(7===(v.gridSize||10)?"selected":"",'>7x7</option>\n                                    <option value="10" ').concat(10===(v.gridSize||10)?"selected":"",'>10x10</option>\n                                    <option value="15" ').concat(15===(v.gridSize||10)?"selected":"",'>15x15</option>\n                                    <option value="20" ').concat(20===(v.gridSize||10)?"selected":"",'>20x20</option>\n                                </select>\n                            </div>\n                            <div class="mazemaster-section mazemaster-flex-1">\n                                <label class="mazemaster-label">Difficulty</label>\n                                <select id="mazemaster_maze_difficulty" class="mazemaster-select">\n                                    <option value="easy" ').concat("easy"===(v.difficulty||"normal")?"selected":"",'>Easy</option>\n                                    <option value="normal" ').concat("normal"===(v.difficulty||"normal")?"selected":"",'>Normal</option>\n                                    <option value="hard" ').concat("hard"===(v.difficulty||"normal")?"selected":"",'>Hard</option>\n                                    <option value="nightmare" ').concat("nightmare"===(v.difficulty||"normal")?"selected":"",'>Nightmare</option>\n                                </select>\n                            </div>\n                        </div>\n                        <div class="mazemaster-help-small"><small>Difficulty affects encounter density, trap frequency, loot, and starting inventory</small></div>\n\n                        <div class="mazemaster-flex-row">\n                            <div class="mazemaster-section mazemaster-flex-1">\n                                <label class="mazemaster-label">Theme</label>\n                                <select id="mazemaster_maze_theme" class="mazemaster-select">\n                                    <option value="fantasy" ').concat("fantasy"===(v.theme||"fantasy")?"selected":"",'>Fantasy</option>\n                                    <option value="horror" ').concat("horror"===(v.theme||"fantasy")?"selected":"",'>Horror</option>\n                                    <option value="scifi" ').concat("scifi"===(v.theme||"fantasy")?"selected":"",'>Sci-Fi</option>\n                                    <option value="action" ').concat("action"===(v.theme||"fantasy")?"selected":"",'>Action</option>\n                                    <option value="cyberpunk" ').concat("cyberpunk"===(v.theme||"fantasy")?"selected":"",'>Cyberpunk</option>\n                                    <option value="noir" ').concat("noir"===(v.theme||"fantasy")?"selected":"",'>Noir</option>\n                                    <option value="postapoc" ').concat("postapoc"===(v.theme||"fantasy")?"selected":"",'>Post-Apocalyptic</option>\n                                    <option value="comedy" ').concat("comedy"===(v.theme||"fantasy")?"selected":"",'>Comedy</option>\n                                    <option value="western" ').concat("western"===(v.theme||"fantasy")?"selected":"",'>Western</option>\n                                </select>\n                            </div>\n                            <div class="mazemaster-section mazemaster-flex-1">\n                                <label class="mazemaster-label">Map Style</label>\n                                <select id="mazemaster_maze_mapstyle" class="mazemaster-select">\n                                    <option value="maze" ').concat("maze"===(v.mapStyle||"maze")?"selected":"",'>Classic Maze</option>\n                                    <option value="dungeon" ').concat("dungeon"===(v.mapStyle||"maze")?"selected":"",'>Dungeon</option>\n                                    <option value="city" ').concat("city"===(v.mapStyle||"maze")?"selected":"",'>City Streets</option>\n                                    <option value="forest" ').concat("forest"===(v.mapStyle||"maze")?"selected":"",'>Forest</option>\n                                    <option value="outpost" ').concat("outpost"===(v.mapStyle||"maze")?"selected":"",'>Outpost</option>\n                                    <option value="spacestation" ').concat("spacestation"===(v.mapStyle||"maze")?"selected":"",'>Space Station</option>\n                                    <option value="college" ').concat("college"===(v.mapStyle||"maze")?"selected":"",'>College Campus</option>\n                                    <option value="apartment" ').concat("apartment"===(v.mapStyle||"maze")?"selected":"",'>Apartment Complex</option>\n                                    <option value="neotokyo" ').concat("neotokyo"===(v.mapStyle||"maze")?"selected":"",'>Neo Tokyo</option>\n                                    <option value="arena" ').concat("arena"===(v.mapStyle||"maze")?"selected":"",'>Battle Arena</option>\n                                    <option value="hospital" ').concat("hospital"===(v.mapStyle||"maze")?"selected":"",'>Hospital</option>\n                                    <option value="highrise" ').concat("highrise"===(v.mapStyle||"maze")?"selected":"",'>Abandoned Highrise</option>\n                                </select>\n                            </div>\n                            <div class="mazemaster-section mazemaster-flex-1">\n                                <label class="mazemaster-label">Floors</label>\n                                <select id="mazemaster_maze_floors" class="mazemaster-select">\n                                    <option value="1" ').concat(1===(v.floors||1)?"selected":"",'>1 Floor</option>\n                                    <option value="2" ').concat(2===(v.floors||1)?"selected":"",'>2 Floors</option>\n                                    <option value="3" ').concat(3===(v.floors||1)?"selected":"",'>3 Floors</option>\n                                    <option value="4" ').concat(4===(v.floors||1)?"selected":"",'>4 Floors</option>\n                                    <option value="5" ').concat(5===(v.floors||1)?"selected":"",'>5 Floors</option>\n                                </select>\n                            </div>\n                        </div>\n                        <div class="mazemaster-help-small"><small>Theme affects flavor text and item names. Map style changes the generation algorithm. Floors adds vertical navigation with staircases.</small></div>\n\n                        <div class="mazemaster-row" style="margin-top: 8px;">\n                            <label class="mazemaster-checkbox-label">\n                                <input type="checkbox" id="mazemaster_maze_fog_of_war" ').concat(v.fogOfWar?"checked":"",'>\n                                <span>Enable Fog of War</span>\n                            </label>\n                        </div>\n\n                        \x3c!-- COLLAPSIBLE: Teleport Portals --\x3e\n                        <div class="mazemaster-collapsible ').concat(v.portals&&v.portals.length>0?"expanded":"",'">\n                            <button class="mazemaster-collapsible-header" data-target="portals_section">\n                                <i class="fa-solid fa-chevron-right mazemaster-collapse-icon"></i>\n                                <span>Teleport Portals</span>\n                                <span class="mazemaster-collapse-hint">(').concat((v.portals||[]).length,' portal pairs)</span>\n                            </button>\n                            <div id="portals_section" class="mazemaster-collapsible-content" style="display: ').concat(v.portals&&v.portals.length>0?"block":"none",';">\n                                <div class="mazemaster-section">\n                                    <div class="mazemaster-help-small"><small>Add portals that teleport the player between two points. Leave coordinates blank for random placement.</small></div>\n                                    <div id="mazemaster_portals_list" class="mazemaster-portals-list">\n                                        ').concat((v.portals||[]).map(((e,t)=>{var n,a,o,i;return'\n                                            <div class="mazemaster-portal-item" data-portal-index="'.concat(t,'">\n                                                <div class="portal-header">\n                                                    <span class="portal-color" style="background: ').concat(e.color||"#9b59b6",'"></span>\n                                                    <span class="portal-name">').concat($t(e.id||"Portal "+(t+1)),'</span>\n                                                    <button class="menu_button remove-portal-btn" data-index="').concat(t,'" title="Remove Portal">\n                                                        <i class="fa-solid fa-trash"></i>\n                                                    </button>\n                                                </div>\n                                                <div class="portal-details">\n                                                    <div class="portal-row">\n                                                        <label>ID:</label>\n                                                        <input type="text" class="portal-id mazemaster-input" value="').concat($t(e.id||""),'" placeholder="portal1">\n                                                    </div>\n                                                    <div class="portal-row">\n                                                        <label>Color:</label>\n                                                        <input type="color" class="portal-color-input" value="').concat(e.color||"#9b59b6",'">\n                                                    </div>\n                                                    <div class="portal-row">\n                                                        <label>Bidirectional:</label>\n                                                        <input type="checkbox" class="portal-bidirectional" ').concat(!1!==e.bidirectional?"checked":"",'>\n                                                    </div>\n                                                    <div class="portal-row coords-row">\n                                                        <span>Start: X</span>\n                                                        <input type="number" class="portal-start-x mazemaster-input" value="').concat(null!==(n=e.startX)&&void 0!==n?n:"",'" placeholder="auto" min="0">\n                                                        <span>Y</span>\n                                                        <input type="number" class="portal-start-y mazemaster-input" value="').concat(null!==(a=e.startY)&&void 0!==a?a:"",'" placeholder="auto" min="0">\n                                                    </div>\n                                                    <div class="portal-row coords-row">\n                                                        <span>End: X</span>\n                                                        <input type="number" class="portal-end-x mazemaster-input" value="').concat(null!==(o=e.endX)&&void 0!==o?o:"",'" placeholder="auto" min="0">\n                                                        <span>Y</span>\n                                                        <input type="number" class="portal-end-y mazemaster-input" value="').concat(null!==(i=e.endY)&&void 0!==i?i:"",'" placeholder="auto" min="0">\n                                                    </div>\n                                                </div>\n                                            </div>\n                                        ')})).join(""),'\n                                    </div>\n                                    <button id="mazemaster_add_portal_btn" class="menu_button">\n                                        <i class="fa-solid fa-plus"></i> Add Portal Pair\n                                    </button>\n                                </div>\n                            </div>\n                        </div>\n\n                        \x3c!-- COLLAPSIBLE: Objectives --\x3e\n                        <div class="mazemaster-collapsible ').concat(v.objectives&&v.objectives.length>0?"expanded":"",'">\n                            <button class="mazemaster-collapsible-header" data-target="objectives_section">\n                                <i class="fa-solid fa-chevron-right mazemaster-collapse-icon"></i>\n                                <span>Objectives</span>\n                                <span class="mazemaster-collapse-hint">(').concat((v.objectives||[]).length,' objectives)</span>\n                            </button>\n                            <div id="objectives_section" class="mazemaster-collapsible-content" style="display: ').concat(v.objectives&&v.objectives.length>0?"block":"none",';">\n                                <div class="mazemaster-section">\n                                    <div class="mazemaster-help-small"><small>Define objectives the player must complete. Required objectives must be done before exiting.</small></div>\n                                    <div id="mazemaster_objectives_list" class="mazemaster-objectives-list">\n                                        ').concat((v.objectives||[]).map(((e,t)=>'\n                                            <div class="mazemaster-objective-item" data-objective-index="'.concat(t,'">\n                                                <div class="objective-config-header">\n                                                    <span class="objective-name">').concat($t(e.description||e.id||"Objective "+(t+1)),'</span>\n                                                    <button class="menu_button remove-objective-btn" data-index="').concat(t,'" title="Remove Objective">\n                                                        <i class="fa-solid fa-trash"></i>\n                                                    </button>\n                                                </div>\n                                                <div class="objective-config-details">\n                                                    <div class="objective-config-row">\n                                                        <label>ID:</label>\n                                                        <input type="text" class="objective-id mazemaster-input" value="').concat($t(e.id||""),'" placeholder="obj1">\n                                                    </div>\n                                                    <div class="objective-config-row">\n                                                        <label>Type:</label>\n                                                        <select class="objective-type mazemaster-select">\n                                                            <option value="collect" ').concat("collect"===e.type?"selected":"",'>Collect Item</option>\n                                                            <option value="defeat" ').concat("defeat"===e.type?"selected":"",'>Defeat Minion</option>\n                                                            <option value="explore" ').concat("explore"===e.type?"selected":"",'>Explore %</option>\n                                                        </select>\n                                                    </div>\n                                                    <div class="objective-config-row objective-target-row" style="display: ').concat("explore"!==e.type?"flex":"none",';">\n                                                        <label>Target:</label>\n                                                        <input type="text" class="objective-target mazemaster-input" value="').concat($t(e.target||""),'" placeholder="').concat("collect"===e.type?"key, pow, stealth...":"minion ID",'">\n                                                    </div>\n                                                    <div class="objective-config-row">\n                                                        <label>Count:</label>\n                                                        <input type="number" class="objective-count mazemaster-input" value="').concat(e.count||1,'" min="1" placeholder="').concat("explore"===e.type?"% to explore":"amount",'">\n                                                    </div>\n                                                    <div class="objective-config-row">\n                                                        <label>Description:</label>\n                                                        <input type="text" class="objective-description mazemaster-input" value="').concat($t(e.description||""),'" placeholder="Find 3 Keys">\n                                                    </div>\n                                                    <div class="objective-config-row">\n                                                        <label>Required:</label>\n                                                        <input type="checkbox" class="objective-required" ').concat(e.required?"checked":"",'>\n                                                    </div>\n                                                    <div class="objective-config-row">\n                                                        <label>Reward Script:</label>\n                                                        <input type="text" class="objective-reward mazemaster-input" value="').concat($t(e.reward||""),'" placeholder="/echo Objective complete!">\n                                                    </div>\n                                                </div>\n                                            </div>\n                                        '))).join(""),'\n                                    </div>\n                                    <button id="mazemaster_add_objective_btn" class="menu_button">\n                                        <i class="fa-solid fa-plus"></i> Add Objective\n                                    </button>\n                                </div>\n                            </div>\n                        </div>\n\n                        \x3c!-- COLLAPSIBLE: Main Minion --\x3e\n                        <div class="mazemaster-collapsible ').concat(v.mainMinion?"expanded":"",'">\n                            <button class="mazemaster-collapsible-header" data-target="main_minion_section">\n                                <i class="fa-solid fa-chevron-right mazemaster-collapse-icon"></i>\n                                <span>Main Minion</span>\n                                <span class="mazemaster-collapse-hint">(narrator/boss)</span>\n                            </button>\n                            <div id="main_minion_section" class="mazemaster-collapsible-content" style="display: ').concat(v.mainMinion?"block":"none",';">\n                                <div class="mazemaster-section">\n                                    <select id="mazemaster_maze_main_minion" class="mazemaster-select">\n                                        <option value="">None</option>\n                                        ').concat(b.map((e=>{const t=Ie(e);return'<option value="'.concat($t(e),'" ').concat(v.mainMinion===e?"selected":"",">").concat($t((null==t?void 0:t.name)||e),"</option>")})).join(""),'\n                                    </select>\n                                    <div class="mazemaster-help-small"><small>The main minion narrates the maze and guards the exit</small></div>\n                                </div>\n\n                                <div id="mazemaster_main_minion_settings" class="mazemaster-subsection" style="display: ').concat(v.mainMinion?"block":"none",';">\n                                    <div class="mazemaster-section">\n                                        <label class="mazemaster-label">Intro Message</label>\n                                        <input type="text" id="mazemaster_maze_intro_message" class="mazemaster-input" placeholder="Welcome to my maze..." value="').concat($t(v.mainMinionIntroMessage||""),'">\n                                    </div>\n\n                                    <div class="mazemaster-inline-row">\n                                        <div class="mazemaster-section mazemaster-flex-1">\n                                            <label class="mazemaster-label">Random Msg %</label>\n                                            <input type="number" id="mazemaster_maze_random_chance" class="mazemaster-input" min="0" max="100" value="').concat(v.mainMinionRandomChance||15,'">\n                                        </div>\n                                    </div>\n\n                                    <div class="mazemaster-section">\n                                        <label class="mazemaster-label">Random Messages (one per line)</label>\n                                        <textarea id="mazemaster_maze_random_messages" class="mazemaster-textarea" rows="2" placeholder="You\'re still here?&#10;Getting lost yet?">').concat($t((v.mainMinionRandomMessages||[]).join("\n")),'</textarea>\n                                    </div>\n\n                                    <div class="mazemaster-section">\n                                        <label class="mazemaster-label">Exit Encounter</label>\n                                        <div class="mazemaster-help-small"><small>What happens when the player reaches the exit</small></div>\n                                        <select id="mazemaster_maze_exit_type" class="mazemaster-select">\n                                            <option value="messenger" ').concat("messenger"===(v.mainMinionExitType||"messenger")?"selected":"",'>Message Only (no challenge)</option>\n                                            <option value="battlebar" ').concat("battlebar"===v.mainMinionExitType?"selected":"",'>Battlebar Fight</option>\n                                            <option value="prizewheel" ').concat("prizewheel"===v.mainMinionExitType?"selected":"",'>Prize Wheel</option>\n                                        </select>\n                                    </div>\n\n                                    <div id="mazemaster_exit_profile_section" class="mazemaster-section" style="display: ').concat(v.mainMinionExitType&&"messenger"!==v.mainMinionExitType?"block":"none",';">\n                                        <label class="mazemaster-label">Exit Game Profile</label>\n                                        <div class="mazemaster-help-small"><small>Which Battlebar/Wheel profile to use for the exit boss</small></div>\n                                        <select id="mazemaster_maze_exit_profile" class="mazemaster-select">\n                                            <option value="">Select...</option>\n                                        </select>\n                                    </div>\n\n                                    <div class="mazemaster-section">\n                                        <button id="mazemaster_maze_story_btn" class="menu_button">\n                                            <i class="fa-solid fa-book"></i> Story Milestones\n                                        </button>\n                                        <div class="mazemaster-help-small"><small>Configure story text shown as player progresses</small></div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n\n                        \x3c!-- COLLAPSIBLE: Encounters --\x3e\n                        <div class="mazemaster-collapsible expanded">\n                            <button class="mazemaster-collapsible-header" data-target="encounters_section">\n                                <i class="fa-solid fa-chevron-right mazemaster-collapse-icon"></i>\n                                <span>Encounters</span>\n                                <span class="mazemaster-collapse-hint">(minions & traps)</span>\n                            </button>\n                            <div id="encounters_section" class="mazemaster-collapsible-content" style="display: block;">\n                                <div class="mazemaster-section">\n                                    <label class="mazemaster-label">Minion Encounters</label>\n                                    <div id="mazemaster_maze_encounters_list" class="mazemaster-encounters-list">\n                                        \x3c!-- Encounter rows rendered here --\x3e\n                                    </div>\n                                    <button id="mazemaster_add_encounter_btn" class="menu_button mazemaster-add-btn">\n                                        <i class="fa-solid fa-plus"></i> Add Minion\n                                    </button>\n                                </div>\n\n                                <div class="mazemaster-section">\n                                    <label class="mazemaster-label">Trap Tiles</label>\n                                    <div id="mazemaster_maze_traps_list" class="mazemaster-encounters-list">\n                                        \x3c!-- Trap encounter rows rendered here --\x3e\n                                    </div>\n                                    <button id="mazemaster_add_trap_encounter_btn" class="menu_button mazemaster-add-btn">\n                                        <i class="fa-solid fa-plus"></i> Add Trap\n                                    </button>\n                                </div>\n\n                                <div class="mazemaster-section">\n                                    <button id="mazemaster_intelligent_distribute" class="menu_button mazemaster-distribute-btn">\n                                        <i class="fa-solid fa-wand-magic-sparkles"></i> Intelligent Distribute\n                                    </button>\n                                    <div class="mazemaster-help-small">\n                                        <small>Auto-sets tile percentages based on minion types</small>\n                                    </div>\n                                </div>\n\n                                <div class="mazemaster-section">\n                                    <label class="mazemaster-label">On Battlebar Loss</label>\n                                    <select id="mazemaster_maze_loss_action" class="mazemaster-select">\n                                        <option value="continue" ').concat("continue"===(v.onBattlebarLoss||"continue")?"selected":"",'>Continue (skip encounter)</option>\n                                        <option value="respawn" ').concat("respawn"===v.onBattlebarLoss?"selected":"",'>Respawn at Start</option>\n                                        <option value="gameover" ').concat("gameover"===v.onBattlebarLoss?"selected":"",'>Game Over</option>\n                                    </select>\n                                </div>\n                            </div>\n                        </div>\n\n                        \x3c!-- COLLAPSIBLE: Chests & Loot --\x3e\n                        <div class="mazemaster-collapsible">\n                            <button class="mazemaster-collapsible-header" data-target="chests_section">\n                                <i class="fa-solid fa-chevron-right mazemaster-collapse-icon"></i>\n                                <span>Chests & Loot</span>\n                            </button>\n                            <div id="chests_section" class="mazemaster-collapsible-content" style="display: none;">\n                                <div class="mazemaster-section">\n                                    <label class="mazemaster-label">Chest Image</label>\n                                    <div class="mazemaster-row" style="gap: 10px; align-items: center;">\n                                        <div class="mazemaster-chest-preview" style="width: 50px; height: 50px; border-radius: 5px; overflow: hidden; background: rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center;">\n                                            ').concat(v.chestImage?'<img id="mazemaster_chest_preview_img" src="'.concat(ie(v.chestImage),'" style="width: 100%; height: 100%; object-fit: cover;">'):'<i id="mazemaster_chest_preview_icon" class="fa-solid fa-box" style="color: #888;"></i>','\n                                        </div>\n                                        <button id="mazemaster_chest_image_btn" class="menu_button menu_button_icon" title="Upload Chest Image">\n                                            <i class="fa-solid fa-upload"></i>\n                                        </button>\n                                        <input type="file" id="mazemaster_chest_image_file" accept="image/*" style="display: none;">\n                                        <small style="color: #888;">Custom chest appearance</small>\n                                    </div>\n                                </div>\n\n                                <div class="mazemaster-section">\n                                    <label class="mazemaster-label">Chest Distribution</label>\n                                    <div class="mazemaster-grid-2col">\n                                        <div class="mazemaster-row">\n                                            <label>Chest Tiles %</label>\n                                            <input type="number" id="mazemaster_maze_chest_percent" class="mazemaster-input-small" min="0" max="50" value="').concat(v.chestTilePercent||10,'">\n                                        </div>\n                                        <div class="mazemaster-row">\n                                            <label>Locked %</label>\n                                            <input type="number" id="mazemaster_maze_locked_percent" class="mazemaster-input-small" min="0" max="100" value="').concat(v.chestLockedPercent||30,'">\n                                        </div>\n                                        <div class="mazemaster-row">\n                                            <label>Locked Bonus %</label>\n                                            <input type="number" id="mazemaster_maze_locked_bonus" class="mazemaster-input-small" min="0" max="200" value="').concat(v.chestLockedBonusPercent||50,'">\n                                        </div>\n                                        <div class="mazemaster-row">\n                                            <label>Mimic %</label>\n                                            <input type="number" id="mazemaster_maze_mimic_percent" class="mazemaster-input-small" min="0" max="100" value="').concat(v.chestMimicPercent||15,'">\n                                        </div>\n                                    </div>\n                                </div>\n\n                                <div class="mazemaster-section">\n                                    <label class="mazemaster-label">Loot per Chest</label>\n                                    <div class="mazemaster-row">\n                                        <input type="number" id="mazemaster_maze_loot_min" class="mazemaster-input-small" min="1" max="10" value="').concat(v.chestLootMin||1,'" style="width:50px">\n                                        <span>to</span>\n                                        <input type="number" id="mazemaster_maze_loot_max" class="mazemaster-input-small" min="1" max="10" value="').concat(v.chestLootMax||2,'" style="width:50px">\n                                        <span>items</span>\n                                    </div>\n                                </div>\n\n                                <div class="mazemaster-section">\n                                    <label class="mazemaster-label">Regular Chest Loot %</label>\n                                    <div class="mazemaster-grid-4col">\n                                        <div class="mazemaster-row"><label>Key</label><input type="number" id="mazemaster_maze_chest_key" class="mazemaster-input-small" min="0" max="100" value="').concat(v.chestKeyChance||30,'"></div>\n                                        <div class="mazemaster-row"><label>POW</label><input type="number" id="mazemaster_maze_chest_pow" class="mazemaster-input-small" min="0" max="100" value="').concat(v.chestPowChance||50,'"></div>\n                                        <div class="mazemaster-row"><label>Stealth</label><input type="number" id="mazemaster_maze_chest_stealth" class="mazemaster-input-small" min="0" max="100" value="').concat(v.chestStealthChance||0,'"></div>\n                                        <div class="mazemaster-row"><label>G-POW</label><input type="number" id="mazemaster_maze_chest_grandpow" class="mazemaster-input-small" min="0" max="100" value="').concat(v.chestGrandpowChance||0,'"></div>\n                                    </div>\n                                </div>\n\n                                <div class="mazemaster-section">\n                                    <label class="mazemaster-label">Locked Chest Loot %</label>\n                                    <div class="mazemaster-grid-4col">\n                                        <div class="mazemaster-row"><label>Key</label><input type="number" id="mazemaster_maze_locked_key" class="mazemaster-input-small" min="0" max="100" value="').concat(v.lockedChestKeyChance||40,'"></div>\n                                        <div class="mazemaster-row"><label>POW</label><input type="number" id="mazemaster_maze_locked_pow" class="mazemaster-input-small" min="0" max="100" value="').concat(v.lockedChestPowChance||60,'"></div>\n                                        <div class="mazemaster-row"><label>Stealth</label><input type="number" id="mazemaster_maze_locked_stealth" class="mazemaster-input-small" min="0" max="100" value="').concat(v.lockedChestStealthChance||30,'"></div>\n                                        <div class="mazemaster-row"><label>G-POW</label><input type="number" id="mazemaster_maze_locked_grandpow" class="mazemaster-input-small" min="0" max="100" value="').concat(v.lockedChestGrandpowChance||5,'"></div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n\n                        \x3c!-- COLLAPSIBLE: Victory & Loss --\x3e\n                        <div class="mazemaster-collapsible">\n                            <button class="mazemaster-collapsible-header" data-target="victory_section">\n                                <i class="fa-solid fa-chevron-right mazemaster-collapse-icon"></i>\n                                <span>Victory & Loss</span>\n                            </button>\n                            <div id="victory_section" class="mazemaster-collapsible-content" style="display: none;">\n                                <div class="mazemaster-section">\n                                    <label class="mazemaster-label">Victory Message</label>\n                                    <input type="text" id="mazemaster_maze_win_message" class="mazemaster-input" placeholder="You escaped the maze!" value="').concat($t(v.winMessage||""),'">\n                                </div>\n\n                                <div class="mazemaster-section">\n                                    <label class="mazemaster-label">Victory Image</label>\n                                    <div class="mazemaster-maze-win-image-row">\n                                        <div class="mazemaster-maze-win-image-preview">\n                                            ').concat(v.winImage?'<img id="maze_win_image_preview" src="'.concat($t(v.winImage),'" alt="Victory">'):'<div id="maze_win_image_preview" class="no-image">No image</div>','\n                                        </div>\n                                        <button id="mazemaster_maze_win_image_btn" class="menu_button">\n                                            <i class="fa-solid fa-upload"></i> Upload\n                                        </button>\n                                    </div>\n                                    <input type="file" id="mazemaster_maze_win_image_file" accept="image/*" style="display: none;">\n                                </div>\n\n                                <div class="mazemaster-section">\n                                    <label class="mazemaster-label">Win Command</label>\n                                    <textarea id="mazemaster_maze_win_cmd" class="mazemaster-textarea" rows="2" placeholder="/echo Victory!">').concat($t(v.winCommand||""),'</textarea>\n                                </div>\n\n                                <div class="mazemaster-section">\n                                    <label class="mazemaster-label">Lose Command</label>\n                                    <textarea id="mazemaster_maze_lose_cmd" class="mazemaster-textarea" rows="2" placeholder="/echo Defeated...">').concat($t(v.loseCommand||""),'</textarea>\n                                </div>\n                            </div>\n                        </div>\n\n                        \x3c!-- COLLAPSIBLE: Starting Inventory --\x3e\n                        <div class="mazemaster-collapsible">\n                            <button class="mazemaster-collapsible-header" data-target="starting_inv_section">\n                                <i class="fa-solid fa-chevron-right mazemaster-collapse-icon"></i>\n                                <span>Starting Inventory</span>\n                            </button>\n                            <div id="starting_inv_section" class="mazemaster-collapsible-content" style="display: none;">\n                                <div class="mazemaster-section">\n                                    <div class="mazemaster-grid-4col">\n                                        <div class="mazemaster-row"><label><i class="fa-solid fa-key"></i> Keys</label><input type="number" id="mazemaster_start_key" class="mazemaster-input-small" min="0" max="99" value="').concat((null===(s=v.startingInventory)||void 0===s?void 0:s.key)||0,'"></div>\n                                        <div class="mazemaster-row"><label><i class="fa-solid fa-bolt"></i> POW</label><input type="number" id="mazemaster_start_pow" class="mazemaster-input-small" min="0" max="99" value="').concat((null===(r=v.startingInventory)||void 0===r?void 0:r.pow)||0,'"></div>\n                                        <div class="mazemaster-row"><label><i class="fa-solid fa-user-ninja"></i> Stealth</label><input type="number" id="mazemaster_start_stealth" class="mazemaster-input-small" min="0" max="99" value="').concat((null===(l=v.startingInventory)||void 0===l?void 0:l.stealth)||0,'"></div>\n                                        <div class="mazemaster-row"><label><i class="fa-solid fa-star"></i> G-POW</label><input type="number" id="mazemaster_start_grandpow" class="mazemaster-input-small" min="0" max="99" value="').concat((null===(c=v.startingInventory)||void 0===c?void 0:c.grandpow)||0,'"></div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n\n                        \x3c!-- COLLAPSIBLE: STScript Hooks --\x3e\n                        <div class="mazemaster-collapsible">\n                            <button class="mazemaster-collapsible-header" data-target="hooks_section">\n                                <i class="fa-solid fa-chevron-right mazemaster-collapse-icon"></i>\n                                <span>STScript Hooks</span>\n                                <span class="mazemaster-collapse-hint">(advanced)</span>\n                            </button>\n                            <div id="hooks_section" class="mazemaster-collapsible-content" style="display: none;">\n                                <div class="mazemaster-help-small"><small>Run STScript commands when events occur. Use {{variable}} placeholders for event data.</small></div>\n\n                                <div class="mazemaster-hooks-group">\n                                    <label class="mazemaster-hooks-label">Movement</label>\n                                    <div class="mazemaster-hooks-items">\n                                        <div class="hook-item">\n                                            <label>On Move</label>\n                                            <input type="text" id="mazemaster_hook_onMove" class="mazemaster-input" value="').concat($t(v.onMove||""),'" placeholder="{{x}}, {{y}}, {{direction}}">\n                                        </div>\n                                        <div class="hook-item">\n                                            <label>On Milestone</label>\n                                            <input type="text" id="mazemaster_hook_onMilestone" class="mazemaster-input" value="').concat($t(v.onMilestone||""),'" placeholder="{{percentage}}">\n                                        </div>\n                                        <div class="hook-item">\n                                            <label>On Explore Complete</label>\n                                            <input type="text" id="mazemaster_hook_onExploreComplete" class="mazemaster-input" value="').concat($t(v.onExploreComplete||""),'" placeholder="Fires at 100%">\n                                        </div>\n                                    </div>\n                                </div>\n\n                                <div class="mazemaster-hooks-group">\n                                    <label class="mazemaster-hooks-label">Items</label>\n                                    <div class="mazemaster-hooks-items">\n                                        <div class="hook-item">\n                                            <label>On Item Add</label>\n                                            <input type="text" id="mazemaster_hook_onItemAdd" class="mazemaster-input" value="').concat($t(v.onItemAdd||""),'" placeholder="{{item}}, {{count}}, {{total}}">\n                                        </div>\n                                        <div class="hook-item">\n                                            <label>On Item Remove</label>\n                                            <input type="text" id="mazemaster_hook_onItemRemove" class="mazemaster-input" value="').concat($t(v.onItemRemove||""),'" placeholder="{{item}}, {{count}}, {{remaining}}">\n                                        </div>\n                                        <div class="hook-item">\n                                            <label>On Chest Open</label>\n                                            <input type="text" id="mazemaster_hook_onChestOpen" class="mazemaster-input" value="').concat($t(v.onChestOpen||""),'" placeholder="{{type}}, {{loot}}">\n                                        </div>\n                                        <div class="hook-item">\n                                            <label>On Trade</label>\n                                            <input type="text" id="mazemaster_hook_onTrade" class="mazemaster-input" value="').concat($t(v.onTrade||""),'" placeholder="{{given}}, {{received}}">\n                                        </div>\n                                    </div>\n                                </div>\n\n                                <div class="mazemaster-hooks-group">\n                                    <label class="mazemaster-hooks-label">Special Tiles</label>\n                                    <div class="mazemaster-hooks-items">\n                                        <div class="hook-item">\n                                            <label>On Enemy Move</label>\n                                            <input type="text" id="mazemaster_hook_onEnemyMove" class="mazemaster-input" value="').concat($t(v.onEnemyMove||""),'" placeholder="{{minionId}}, {{fromX}}, {{fromY}}, {{toX}}, {{toY}}">\n                                        </div>\n                                        <div class="hook-item">\n                                            <label>On Teleport</label>\n                                            <input type="text" id="mazemaster_hook_onTeleport" class="mazemaster-input" value="').concat($t(v.onTeleport||""),'" placeholder="{{portalId}}, {{fromX}}, {{fromY}}, {{toX}}, {{toY}}">\n                                        </div>\n                                    </div>\n                                </div>\n\n                                <div class="mazemaster-hooks-group">\n                                    <label class="mazemaster-hooks-label">Objectives</label>\n                                    <div class="mazemaster-hooks-items">\n                                        <div class="hook-item">\n                                            <label>On Progress</label>\n                                            <input type="text" id="mazemaster_hook_onObjectiveProgress" class="mazemaster-input" value="').concat($t(v.onObjectiveProgress||""),'" placeholder="{{objectiveId}}, {{current}}, {{target}}">\n                                        </div>\n                                        <div class="hook-item">\n                                            <label>On Complete</label>\n                                            <input type="text" id="mazemaster_hook_onObjectiveComplete" class="mazemaster-input" value="').concat($t(v.onObjectiveComplete||""),'" placeholder="{{objectiveId}}">\n                                        </div>\n                                        <div class="hook-item">\n                                            <label>On All Complete</label>\n                                            <input type="text" id="mazemaster_hook_onAllObjectivesComplete" class="mazemaster-input" value="').concat($t(v.onAllObjectivesComplete||""),'" placeholder="All required done">\n                                        </div>\n                                    </div>\n                                </div>\n\n                                <div class="mazemaster-hooks-group">\n                                    <label class="mazemaster-hooks-label">Stats</label>\n                                    <div class="mazemaster-hooks-items">\n                                        <div class="hook-item">\n                                            <label>On Stat Update</label>\n                                            <input type="text" id="mazemaster_hook_onStatUpdate" class="mazemaster-input" value="').concat($t(v.onStatUpdate||""),'" placeholder="{{statName}}, {{value}}">\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n\n                        \x3c!-- Save Button --\x3e\n                        <div class="mazemaster-section">\n                            <button id="mazemaster_maze_save_btn" class="menu_button menu_button_primary mazemaster-save-btn">\n                                <i class="fa-solid fa-save"></i> Save Profile\n                            </button>\n                        </div>\n\n                        \x3c!-- Saved Games --\x3e\n                        <div class="mazemaster-collapsible">\n                            <button class="mazemaster-collapsible-header" data-target="saved_games_section">\n                                <i class="fa-solid fa-chevron-right mazemaster-collapse-icon"></i>\n                                <span>Saved Games</span>\n                            </button>\n                            <div id="saved_games_section" class="mazemaster-collapsible-content" style="display: none;">\n                                <div id="mazemaster_saved_games_list" class="mazemaster-saved-games-list">\n                                    \x3c!-- Saved games rendered here --\x3e\n                                </div>\n                            </div>\n                        </div>\n\n                        \x3c!-- Usage Help --\x3e\n                        <div class="mazemaster-section">\n                            <div class="mazemaster-help">\n                                <div class="mazemaster-help-title">Usage:</div>\n                                <code>/maze profile="profileName"</code>\n                            </div>\n                        </div>\n                    </div>\n\n                    \x3c!-- MINIONS CONFIG --\x3e\n                    <div id="mazemaster_minions_config" class="mazemaster-game-config" style="').concat("minions"===y?"":"display: none;",'">\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Minion Profile</label>\n                            <div class="mazemaster-profile-row">\n                                <select id="mazemaster_minion_profile_select" class="mazemaster-select">\n                                    <option value="">(Current Minions)</option>\n                                    ').concat(Object.keys(de.minionProfiles||{}).map((e=>'<option value="'.concat($t(e),'">').concat($t(e),"</option>"))).join(""),'\n                                </select>\n                                <button id="mazemaster_minion_profile_save_btn" class="menu_button menu_button_icon" title="Save Current as Profile">\n                                    <i class="fa-solid fa-floppy-disk"></i>\n                                </button>\n                                <button id="mazemaster_minion_profile_load_btn" class="menu_button menu_button_icon" title="Load Profile">\n                                    <i class="fa-solid fa-folder-open"></i>\n                                </button>\n                                <button id="mazemaster_minion_profile_delete_btn" class="menu_button menu_button_icon" title="Delete Profile">\n                                    <i class="fa-solid fa-trash"></i>\n                                </button>\n                            </div>\n                            <div class="mazemaster-help-small"><small>Save/load sets of minions as profiles</small></div>\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Minions</label>\n                            <div id="mazemaster_minions_list" class="mazemaster-minions-list">\n                                \x3c!-- Minions rendered here --\x3e\n                            </div>\n                            <button id="mazemaster_add_minion_btn" class="menu_button mazemaster-add-btn">\n                                <i class="fa-solid fa-plus"></i> Add Minion\n                            </button>\n                            <input type="file" id="mazemaster_minion_image_file" accept="image/*" style="display: none;">\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <div class="mazemaster-help">\n                                <div class="mazemaster-help-title">Usage:</div>\n                                <code>/mazeminion name="MinionName" message="Hello!"</code>\n                                <p><small>Sets the minion display in an active maze game.</small></p>\n                            </div>\n                        </div>\n                    </div>\n\n                    \x3c!-- TRAPS CONFIG --\x3e\n                    <div id="mazemaster_traps_config" class="mazemaster-game-config" style="').concat("traps"===y?"":"display: none;",'">\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Trap Profile</label>\n                            <div class="mazemaster-profile-row">\n                                <select id="mazemaster_trap_profile_select" class="mazemaster-select">\n                                    <option value="">(Current Traps)</option>\n                                    ').concat(Object.keys(de.trapProfiles||{}).map((e=>'<option value="'.concat($t(e),'">').concat($t(e),"</option>"))).join(""),'\n                                </select>\n                                <button id="mazemaster_trap_profile_save_btn" class="menu_button menu_button_icon" title="Save Current as Profile">\n                                    <i class="fa-solid fa-floppy-disk"></i>\n                                </button>\n                                <button id="mazemaster_trap_profile_load_btn" class="menu_button menu_button_icon" title="Load Profile">\n                                    <i class="fa-solid fa-folder-open"></i>\n                                </button>\n                                <button id="mazemaster_trap_profile_delete_btn" class="menu_button menu_button_icon" title="Delete Profile">\n                                    <i class="fa-solid fa-trash"></i>\n                                </button>\n                            </div>\n                            <div class="mazemaster-help-small"><small>Save/load sets of traps as profiles</small></div>\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <label class="mazemaster-label">Traps</label>\n                            <div id="mazemaster_traps_list" class="mazemaster-traps-list">\n                                \x3c!-- Traps rendered here --\x3e\n                            </div>\n                            <button id="mazemaster_add_trap_btn" class="menu_button mazemaster-add-btn">\n                                <i class="fa-solid fa-plus"></i> Add Trap\n                            </button>\n                            <input type="file" id="mazemaster_trap_image_file" accept="image/*" style="display: none;">\n                        </div>\n\n                        <div class="mazemaster-section">\n                            <div class="mazemaster-help">\n                                <div class="mazemaster-help-title">Traps:</div>\n                                <p><small>Traps can be placed on maze tiles. When a player steps on a trap, it shows the image/message and runs the script.</small></p>\n                                <p><small>Add traps to maze profiles in the Maze tab under "Trap Tiles".</small></p>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n\n        <style>\n            .mazemaster-panel {\n                display: flex;\n                flex-direction: column;\n                height: 100%;\n            }\n\n            .mazemaster-panel-header {\n                padding: 10px 15px;\n                border-bottom: 1px solid var(--SmartThemeBorderColor, #555);\n            }\n\n            .mazemaster-panel-header h2 {\n                margin: 0;\n                font-size: 1.2em;\n                display: flex;\n                align-items: center;\n                gap: 10px;\n            }\n\n            .mazemaster-tabs {\n                display: flex;\n                border-bottom: 1px solid var(--SmartThemeBorderColor, #555);\n                padding: 0 10px;\n            }\n\n            .mazemaster-tab {\n                padding: 8px 16px;\n                background: transparent;\n                border: none;\n                border-bottom: 2px solid transparent;\n                cursor: pointer;\n                color: var(--SmartThemeBodyColor);\n                font-size: 0.9em;\n            }\n\n            .mazemaster-tab:hover {\n                background: rgba(255, 255, 255, 0.05);\n            }\n\n            .mazemaster-tab.active {\n                border-bottom-color: var(--SmartThemeQuoteColor, #4a7c59);\n                color: var(--SmartThemeQuoteColor, #4a7c59);\n            }\n\n            .mazemaster-panel-content {\n                flex: 1;\n                overflow-y: auto;\n                padding: 15px;\n            }\n\n            .mazemaster-tab-content {\n                display: none;\n            }\n\n            .mazemaster-tab-content.active {\n                display: block;\n            }\n\n            .mazemaster-section {\n                margin-bottom: 15px;\n            }\n\n            .mazemaster-label {\n                display: block;\n                font-weight: bold;\n                margin-bottom: 5px;\n                font-size: 0.9em;\n            }\n\n            .mazemaster-profile-row {\n                display: flex;\n                gap: 5px;\n            }\n\n            .mazemaster-profile-row select {\n                flex: 1;\n            }\n\n            .mazemaster-select {\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 6px 8px;\n                color: var(--SmartThemeBodyColor);\n            }\n\n            .mazemaster-segments-list {\n                display: flex;\n                flex-direction: column;\n                gap: 8px;\n                margin-bottom: 10px;\n                max-height: 300px;\n                overflow-y: auto;\n            }\n\n            .mazemaster-segment-item {\n                background: rgba(0, 0, 0, 0.2);\n                border-radius: 5px;\n                padding: 10px;\n            }\n\n            .mazemaster-segment-row {\n                display: flex;\n                gap: 8px;\n                margin-bottom: 8px;\n                align-items: center;\n            }\n\n            .mazemaster-segment-row:last-child {\n                margin-bottom: 0;\n            }\n\n            .mazemaster-segment-field {\n                flex: 1;\n                display: flex;\n                flex-direction: column;\n                gap: 2px;\n            }\n\n            .mazemaster-segment-field label {\n                font-size: 0.7em;\n                opacity: 0.7;\n            }\n\n            .mazemaster-segment-field input:not([type="checkbox"]),\n            .mazemaster-segment-field select,\n            .mazemaster-segment-field textarea {\n                width: 100%;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 5px 8px;\n                color: var(--SmartThemeBodyColor);\n                font-size: 0.85em;\n            }\n\n            .mazemaster-segment-field textarea {\n                min-height: 40px;\n                resize: vertical;\n                font-family: monospace;\n            }\n\n            .mazemaster-segment-field.small {\n                flex: 0 0 80px;\n            }\n\n            .mazemaster-segment-field.tiny {\n                flex: 0 0 100px;\n                overflow: visible;\n            }\n\n            .mazemaster-segment-checkbox {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                font-size: 0.85em;\n                cursor: pointer;\n                white-space: nowrap;\n                padding: 5px;\n                margin: 0;\n            }\n\n            .mazemaster-segment-checkbox input[type="checkbox"] {\n                width: 18px;\n                height: 18px;\n                min-width: 18px;\n                min-height: 18px;\n                cursor: pointer;\n                pointer-events: auto;\n                margin: 0;\n                flex-shrink: 0;\n            }\n\n            .mazemaster-profile-settings {\n                background: rgba(0, 0, 0, 0.15);\n                padding: 10px;\n                border-radius: 5px;\n            }\n\n            .mazemaster-profile-options {\n                display: flex;\n                flex-direction: column;\n                gap: 10px;\n            }\n\n            .mazemaster-checkbox-label {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                cursor: pointer;\n                font-size: 0.9em;\n            }\n\n            .mazemaster-checkbox-label input[type="checkbox"] {\n                width: 16px;\n                height: 16px;\n                cursor: pointer;\n            }\n\n            .mazemaster-difficulty-row {\n                display: flex;\n                align-items: center;\n                gap: 10px;\n                font-size: 0.9em;\n            }\n\n            .mazemaster-select-small {\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 4px 8px;\n                color: var(--SmartThemeBodyColor);\n                width: 60px;\n            }\n\n            .mazemaster-segment-delete {\n                padding: 5px 8px;\n            }\n\n            .mazemaster-add-btn,\n            .mazemaster-save-btn {\n                width: 100%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 5px;\n            }\n\n            .mazemaster-distribute-btn {\n                width: 100%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 8px;\n                background: linear-gradient(135deg, #9b59b6, #8e44ad) !important;\n                color: #fff !important;\n            }\n\n            .mazemaster-distribute-btn:hover {\n                background: linear-gradient(135deg, #8e44ad, #7d3c98) !important;\n            }\n\n            .mazemaster-help-small {\n                margin-top: 5px;\n                color: #888;\n                text-align: center;\n            }\n\n            .menu_button_primary {\n                background: var(--SmartThemeQuoteColor, #4a7c59) !important;\n            }\n\n            .mazemaster-help {\n                background: rgba(0, 0, 0, 0.2);\n                padding: 10px;\n                border-radius: 5px;\n                font-size: 0.85em;\n            }\n\n            .mazemaster-help-title {\n                font-weight: bold;\n                margin-bottom: 5px;\n                margin-top: 10px;\n            }\n\n            .mazemaster-help-title:first-child {\n                margin-top: 0;\n            }\n\n            .mazemaster-help code {\n                background: rgba(0, 0, 0, 0.3);\n                padding: 2px 6px;\n                border-radius: 3px;\n                font-family: monospace;\n                font-size: 0.9em;\n            }\n\n            .mazemaster-help ul {\n                margin: 5px 0;\n                padding-left: 20px;\n            }\n\n            .mazemaster-help li {\n                margin: 3px 0;\n            }\n\n            .mazemaster-help small {\n                opacity: 0.7;\n                display: block;\n                margin-top: 5px;\n            }\n\n            .mazemaster-empty-state {\n                text-align: center;\n                padding: 15px;\n                opacity: 0.6;\n            }\n\n            /* Game Selector */\n            .mazemaster-game-selector {\n                display: flex;\n                gap: 10px;\n                margin-bottom: 15px;\n            }\n\n            .mazemaster-game-btn {\n                flex: 1;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 8px;\n                padding: 10px;\n                border-radius: 5px;\n                transition: all 0.2s;\n            }\n\n            .mazemaster-game-btn.active {\n                background: var(--SmartThemeQuoteColor, #4a7c59) !important;\n                color: white;\n            }\n\n            .mazemaster-game-config {\n                animation: fadeIn 0.2s ease;\n            }\n\n            @keyframes fadeIn {\n                from { opacity: 0; }\n                to { opacity: 1; }\n            }\n\n            /* Battlebar Styles */\n            .mazemaster-bb-settings {\n                display: flex;\n                flex-direction: column;\n                gap: 10px;\n            }\n\n            .mazemaster-bb-row {\n                display: flex;\n                gap: 10px;\n            }\n\n            .mazemaster-bb-field {\n                flex: 1;\n                display: flex;\n                flex-direction: column;\n                gap: 4px;\n            }\n\n            .mazemaster-bb-field label {\n                font-size: 0.8em;\n                opacity: 0.8;\n            }\n\n            .mazemaster-bb-field input,\n            .mazemaster-bb-field select {\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 6px 8px;\n                color: var(--SmartThemeBodyColor);\n            }\n\n            .mazemaster-bb-commands {\n                display: flex;\n                flex-direction: column;\n                gap: 10px;\n            }\n\n            .mazemaster-bb-command {\n                display: flex;\n                flex-direction: column;\n                gap: 4px;\n            }\n\n            .mazemaster-bb-command label {\n                font-size: 0.85em;\n                font-weight: bold;\n            }\n\n            .mazemaster-bb-command textarea {\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 8px;\n                color: var(--SmartThemeBodyColor);\n                font-family: monospace;\n                font-size: 0.85em;\n                min-height: 40px;\n                resize: vertical;\n            }\n\n            .mazemaster-bb-images-list {\n                display: flex;\n                flex-wrap: wrap;\n                gap: 10px;\n                margin-bottom: 10px;\n            }\n\n            .mazemaster-input {\n                width: 100%;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 8px 10px;\n                color: var(--SmartThemeBodyColor, #fff);\n                font-size: 1em;\n            }\n\n            .mazemaster-input::placeholder {\n                color: var(--SmartThemeBodyColor, #888);\n                opacity: 0.6;\n            }\n\n            .mazemaster-bb-image-item {\n                position: relative;\n                width: 120px;\n                display: flex;\n                flex-direction: column;\n                border-radius: 5px;\n                overflow: hidden;\n                border: 2px solid var(--SmartThemeBorderColor, #444);\n                cursor: pointer;\n                background: rgba(0, 0, 0, 0.2);\n            }\n\n            .mazemaster-bb-image-item:hover {\n                border-color: var(--SmartThemeQuoteColor, #888);\n            }\n\n            .mazemaster-bb-image-item img {\n                width: 100%;\n                height: 80px;\n                object-fit: cover;\n            }\n\n            .mazemaster-bb-image-item .bb-image-index {\n                position: absolute;\n                top: 2px;\n                left: 2px;\n                background: rgba(0, 0, 0, 0.7);\n                color: white;\n                font-size: 0.7em;\n                padding: 2px 5px;\n                border-radius: 3px;\n            }\n\n            .mazemaster-bb-image-item .bb-image-message {\n                padding: 4px 6px;\n                font-size: 0.7em;\n                color: var(--SmartThemeBodyColor, #aaa);\n                text-align: center;\n                overflow: hidden;\n                text-overflow: ellipsis;\n                white-space: nowrap;\n                max-height: 20px;\n            }\n\n            .mazemaster-bb-image-item .bb-image-delete {\n                position: absolute;\n                top: 2px;\n                right: 2px;\n                background: rgba(231, 76, 60, 0.9);\n                color: white;\n                border: none;\n                width: 20px;\n                height: 20px;\n                border-radius: 50%;\n                cursor: pointer;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                font-size: 0.7em;\n            }\n\n            .mazemaster-bb-image-item .bb-image-delete:hover {\n                background: #c0392b;\n            }\n\n            /* Game Tab Styles */\n            .mazemaster-game-launch {\n                display: flex;\n                flex-direction: column;\n                gap: 15px;\n                padding: 10px 0;\n            }\n\n            .mazemaster-play-btn {\n                width: 100%;\n                padding: 15px 20px;\n                font-size: 1.2em;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 10px;\n            }\n\n            /* Maze Config Styles */\n            .mazemaster-textarea {\n                width: 100%;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 8px 10px;\n                color: var(--SmartThemeBodyColor, #fff);\n                font-family: monospace;\n                font-size: 0.9em;\n                min-height: 60px;\n                resize: vertical;\n            }\n\n            .mazemaster-maze-win-image-row {\n                display: flex;\n                gap: 10px;\n                align-items: flex-start;\n            }\n\n            .mazemaster-maze-win-image-preview {\n                width: 80px;\n                height: 80px;\n                border-radius: 5px;\n                border: 2px solid var(--SmartThemeBorderColor, #444);\n                overflow: hidden;\n                background: rgba(0, 0, 0, 0.2);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n            }\n\n            .mazemaster-maze-win-image-preview img {\n                width: 100%;\n                height: 100%;\n                object-fit: cover;\n            }\n\n            .mazemaster-maze-win-image-preview .no-image {\n                font-size: 0.7em;\n                opacity: 0.5;\n                text-align: center;\n            }\n\n            /* Maze Subsection Styles */\n            .mazemaster-subsection {\n                background: rgba(0, 0, 0, 0.15);\n                border-left: 3px solid var(--SmartThemeQuoteColor, #666);\n                padding: 10px;\n                margin: 10px 0;\n                border-radius: 0 5px 5px 0;\n            }\n\n            /* Encounters List Styles */\n            .mazemaster-encounters-list {\n                display: flex;\n                flex-direction: column;\n                gap: 8px;\n                margin-bottom: 10px;\n            }\n\n            .mazemaster-encounter-row {\n                display: flex;\n                gap: 8px;\n                align-items: center;\n            }\n\n            .mazemaster-encounter-row select {\n                flex: 1;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 6px 8px;\n                color: var(--SmartThemeBodyColor);\n            }\n\n            .mazemaster-encounter-row input[type="number"] {\n                width: 60px;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 6px 8px;\n                color: var(--SmartThemeBodyColor);\n                text-align: center;\n            }\n\n            .mazemaster-encounter-row .encounter-remove-btn {\n                padding: 5px 8px;\n            }\n\n            /* Maze Cell Minion Indicators */\n            .maze-cell.has-minion:not(.hidden)::before {\n                content: \'?\';\n                position: absolute;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                font-size: 0.7em;\n                color: #f39c12;\n                font-weight: bold;\n                z-index: 1;\n            }\n\n            .maze-cell.minion-triggered:not(.hidden)::before {\n                content: \'\\2713\';\n                color: #27ae60;\n            }\n\n            /* Moving Minion Indicators */\n            .maze-cell.minion-moving:not(.hidden):not(.minion-triggered)::before {\n                animation: minion-move-pulse 0.8s ease-in-out infinite;\n            }\n\n            .maze-cell.minion-chase:not(.hidden):not(.minion-triggered)::before {\n                content: \'\\f06d\';\n                font-family: \'Font Awesome 6 Free\';\n                font-weight: 900;\n                color: #e74c3c;\n            }\n\n            .maze-cell.minion-patrol:not(.hidden):not(.minion-triggered)::before {\n                content: \'\\f554\';\n                font-family: \'Font Awesome 6 Free\';\n                font-weight: 900;\n                color: #9b59b6;\n            }\n\n            @keyframes minion-move-pulse {\n                0%, 100% {\n                    transform: translate(-50%, -50%) scale(1);\n                    opacity: 1;\n                }\n                50% {\n                    transform: translate(-50%, -50%) scale(1.15);\n                    opacity: 0.8;\n                }\n            }\n\n            /* Maze Cell Chest Indicators */\n            .maze-cell.has-chest:not(.hidden)::before {\n                content: \'\\f187\';\n                font-family: \'Font Awesome 6 Free\';\n                font-weight: 900;\n                position: absolute;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                font-size: 0.6em;\n                color: #f39c12;\n                z-index: 1;\n            }\n\n            .maze-cell.chest-locked:not(.hidden)::before {\n                color: #95a5a6;\n            }\n\n            .maze-cell.chest-opened:not(.hidden)::before {\n                color: #666;\n                opacity: 0.5;\n            }\n\n            /* Hide default icon when custom chest image is used */\n            .maze-cell.has-custom-chest::before {\n                display: none !important;\n            }\n\n            /* Maze Cell Trap Indicators */\n            .maze-cell.has-trap:not(.hidden)::before {\n                content: \'\\f6e2\';\n                font-family: \'Font Awesome 6 Free\';\n                font-weight: 900;\n                position: absolute;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                font-size: 0.6em;\n                color: #e74c3c;\n                z-index: 1;\n            }\n\n            .maze-cell.trap-triggered:not(.hidden)::before {\n                color: #666;\n                opacity: 0.5;\n            }\n\n            /* Portal Indicators */\n            .maze-cell.has-portal:not(.hidden)::before {\n                content: \'\\f111\';\n                font-family: \'Font Awesome 6 Free\';\n                font-weight: 900;\n                position: absolute;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                font-size: 0.7em;\n                color: var(--portal-color, #9b59b6);\n                z-index: 1;\n                animation: portal-pulse 1.2s ease-in-out infinite;\n                text-shadow: 0 0 8px var(--portal-color, #9b59b6);\n            }\n\n            .maze-cell.portal-exit-only:not(.hidden)::before {\n                opacity: 0.5;\n                animation: none;\n            }\n\n            .maze-cell.portal-flash {\n                animation: teleport-flash 0.3s ease-out;\n            }\n\n            @keyframes portal-pulse {\n                0%, 100% {\n                    opacity: 0.7;\n                    transform: translate(-50%, -50%) scale(1);\n                }\n                50% {\n                    opacity: 1;\n                    transform: translate(-50%, -50%) scale(1.2);\n                }\n            }\n\n            @keyframes teleport-flash {\n                0% {\n                    background: rgba(155, 89, 182, 0.8);\n                    box-shadow: 0 0 20px rgba(155, 89, 182, 0.8);\n                }\n                100% {\n                    background: rgba(0, 0, 0, 0.4);\n                    box-shadow: none;\n                }\n            }\n\n            /* Staircase Indicators (v1.2.0) */\n            .maze-cell.has-staircase:not(.hidden)::before {\n                content: \'\\f54b\';\n                font-family: \'Font Awesome 6 Free\';\n                font-weight: 900;\n                position: absolute;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                font-size: 0.8em;\n                color: #3498db;\n                z-index: 1;\n                text-shadow: 0 0 4px rgba(52, 152, 219, 0.6);\n            }\n\n            .maze-cell.staircase-up:not(.hidden)::before {\n                content: \'\\f148\';\n                color: #27ae60;\n                text-shadow: 0 0 4px rgba(39, 174, 96, 0.6);\n            }\n\n            .maze-cell.staircase-down:not(.hidden)::before {\n                content: \'\\f149\';\n                color: #e67e22;\n                text-shadow: 0 0 4px rgba(230, 126, 34, 0.6);\n            }\n\n            .maze-cell.staircase-locked:not(.hidden)::after {\n                content: \'\\f023\';\n                font-family: \'Font Awesome 6 Free\';\n                font-weight: 900;\n                position: absolute;\n                top: 2px;\n                right: 2px;\n                font-size: 0.45em;\n                color: #e74c3c;\n                z-index: 2;\n            }\n\n            /* Inventory Display */\n            .mazemaster-maze-inventory {\n                display: flex;\n                justify-content: center;\n                gap: 12px;\n                padding: 6px 12px;\n                background: rgba(0, 0, 0, 0.4);\n                border-radius: 6px;\n                margin-bottom: 8px;\n            }\n\n            .inventory-item {\n                display: flex;\n                align-items: center;\n                gap: 4px;\n                font-size: 0.85em;\n                color: #fff;\n            }\n\n            .inventory-item i { font-size: 0.9em; }\n            .inventory-item i.fa-key { color: #f1c40f; }\n            .inventory-item i.fa-user-ninja { color: #9b59b6; }\n            .inventory-item i.fa-bolt { color: #e74c3c; }\n            .inventory-item.grandpow i.fa-star { color: #ffd700; text-shadow: 0 0 5px #ffd700; }\n            .inventory-item.grandpow { font-weight: bold; }\n\n            /* Encounter Confirmation Buttons */\n            .maze-confirm-buttons {\n                margin-top: 8px;\n                display: flex;\n                gap: 8px;\n                justify-content: center;\n            }\n\n            .maze-confirm-btn {\n                padding: 8px 16px;\n                font-size: 0.9em;\n                font-weight: bold;\n                border-radius: 6px;\n                background: linear-gradient(to bottom, #3498db, #2980b9);\n                color: #fff;\n                border: 2px solid #5dade2;\n                box-shadow: 0 2px 8px rgba(52, 152, 219, 0.4);\n                transition: all 0.2s;\n            }\n\n            .maze-confirm-btn:hover {\n                background: linear-gradient(to bottom, #5dade2, #3498db);\n                transform: scale(1.05);\n                box-shadow: 0 4px 12px rgba(52, 152, 219, 0.6);\n            }\n\n            .maze-slip-btn {\n                background: linear-gradient(to bottom, #9b59b6, #8e44ad);\n                border-color: #bb8fce;\n                box-shadow: 0 2px 8px rgba(155, 89, 182, 0.4);\n            }\n\n            .maze-slip-btn:hover {\n                background: linear-gradient(to bottom, #bb8fce, #9b59b6);\n                box-shadow: 0 4px 12px rgba(155, 89, 182, 0.6);\n            }\n\n            .maze-accept-btn {\n                background: linear-gradient(to bottom, #27ae60, #1e8449);\n                border-color: #58d68d;\n                box-shadow: 0 2px 8px rgba(39, 174, 96, 0.4);\n            }\n\n            .maze-accept-btn:hover {\n                background: linear-gradient(to bottom, #58d68d, #27ae60);\n                box-shadow: 0 4px 12px rgba(39, 174, 96, 0.6);\n            }\n\n            /* Battlebar Action Buttons */\n            .mazemaster-bb-action-buttons {\n                display: flex;\n                gap: 10px;\n                justify-content: center;\n                flex-wrap: wrap;\n                width: 100%;\n                max-width: 400px;\n            }\n\n            .mazemaster-bb-pow-btn,\n            .mazemaster-bb-grandpow-btn {\n                flex: 1;\n                min-width: 120px;\n                max-width: 180px;\n                padding: 12px 15px;\n                font-size: 1em;\n                border-radius: 10px;\n                cursor: pointer;\n                font-weight: bold;\n                border: none;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                gap: 8px;\n                transition: transform 0.1s, box-shadow 0.1s;\n            }\n\n            .mazemaster-bb-pow-btn {\n                background: linear-gradient(to bottom, #e74c3c, #c0392b);\n                color: #fff;\n                box-shadow: 0 4px 10px rgba(231, 76, 60, 0.3);\n            }\n\n            .mazemaster-bb-pow-btn:hover {\n                background: linear-gradient(to bottom, #c0392b, #a93226);\n                transform: scale(1.02);\n            }\n\n            .mazemaster-bb-grandpow-btn {\n                background: linear-gradient(135deg, #ffd700, #ffaa00);\n                color: #000;\n                text-shadow: 0 1px 0 rgba(255,255,255,0.5);\n                box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);\n            }\n\n            .mazemaster-bb-grandpow-btn:hover {\n                background: linear-gradient(135deg, #ffea00, #ffc400);\n                box-shadow: 0 4px 20px rgba(255, 215, 0, 0.6);\n                transform: scale(1.02);\n            }\n\n            /* Encounter Percent Label */\n            .encounter-percent-label {\n                font-size: 0.9em;\n                color: #888;\n            }\n\n            .encounter-percent-input {\n                width: 50px;\n            }\n\n            /* Small input for config rows */\n            .mazemaster-input-small {\n                width: 60px;\n                padding: 4px 8px;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                color: var(--SmartThemeBodyColor);\n            }\n\n            /* Grid layout for config rows */\n            .mazemaster-row {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                margin-bottom: 6px;\n            }\n\n            .mazemaster-row label {\n                min-width: 90px;\n                font-size: 0.85em;\n                color: var(--SmartThemeBodyColor);\n                opacity: 0.9;\n            }\n\n            /* Two-column grid for percentage fields */\n            .mazemaster-grid-2col {\n                display: grid;\n                grid-template-columns: 1fr 1fr;\n                gap: 8px 16px;\n            }\n\n            .mazemaster-grid-2col .mazemaster-row {\n                margin-bottom: 0;\n            }\n\n            .mazemaster-grid-2col .mazemaster-row label {\n                min-width: 80px;\n            }\n\n            /* Three-column grid for loot percentages */\n            .mazemaster-grid-3col {\n                display: grid;\n                grid-template-columns: repeat(3, 1fr);\n                gap: 8px;\n            }\n\n            .mazemaster-grid-3col .mazemaster-row {\n                flex-direction: column;\n                align-items: flex-start;\n                gap: 4px;\n                margin-bottom: 0;\n            }\n\n            .mazemaster-grid-3col .mazemaster-row label {\n                min-width: auto;\n                font-size: 0.8em;\n                opacity: 0.8;\n            }\n\n            .mazemaster-grid-3col .mazemaster-input-small {\n                width: 100%;\n            }\n\n            /* 4-column grid */\n            .mazemaster-grid-4col {\n                display: grid;\n                grid-template-columns: repeat(4, 1fr);\n                gap: 8px;\n            }\n\n            .mazemaster-grid-4col .mazemaster-row {\n                flex-direction: column;\n                align-items: flex-start;\n                gap: 2px;\n                margin-bottom: 0;\n            }\n\n            .mazemaster-grid-4col .mazemaster-row label {\n                min-width: auto;\n                font-size: 0.75em;\n                opacity: 0.8;\n            }\n\n            .mazemaster-grid-4col .mazemaster-input-small {\n                width: 100%;\n            }\n\n            /* Collapsible Sections */\n            .mazemaster-collapsible {\n                margin-bottom: 8px;\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 6px;\n                overflow: hidden;\n            }\n\n            .mazemaster-collapsible-header {\n                width: 100%;\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                padding: 10px 12px;\n                background: rgba(0, 0, 0, 0.2);\n                border: none;\n                cursor: pointer;\n                text-align: left;\n                font-size: 0.95em;\n                font-weight: 500;\n                color: inherit;\n                transition: background 0.2s;\n            }\n\n            .mazemaster-collapsible-header:hover {\n                background: rgba(0, 0, 0, 0.3);\n            }\n\n            .mazemaster-collapse-icon {\n                font-size: 0.8em;\n                transition: transform 0.2s;\n            }\n\n            .mazemaster-collapsible.expanded .mazemaster-collapse-icon {\n                transform: rotate(90deg);\n            }\n\n            .mazemaster-collapse-hint {\n                font-size: 0.8em;\n                opacity: 0.6;\n                margin-left: auto;\n            }\n\n            .mazemaster-collapsible-content {\n                padding: 12px;\n                border-top: 1px solid var(--SmartThemeBorderColor, #444);\n                background: rgba(0, 0, 0, 0.1);\n            }\n\n            .mazemaster-collapsible-content .mazemaster-section:last-child {\n                margin-bottom: 0;\n            }\n\n            /* Portal Config List */\n            .mazemaster-portals-list {\n                display: flex;\n                flex-direction: column;\n                gap: 8px;\n                margin-bottom: 10px;\n            }\n\n            .mazemaster-portal-item {\n                background: rgba(0, 0, 0, 0.2);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 6px;\n                overflow: hidden;\n            }\n\n            .mazemaster-portal-item .portal-header {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                padding: 8px 10px;\n                background: rgba(0, 0, 0, 0.2);\n                border-bottom: 1px solid var(--SmartThemeBorderColor, #444);\n            }\n\n            .mazemaster-portal-item .portal-color {\n                width: 16px;\n                height: 16px;\n                border-radius: 50%;\n                flex-shrink: 0;\n            }\n\n            .mazemaster-portal-item .portal-name {\n                flex: 1;\n                font-weight: 500;\n            }\n\n            .mazemaster-portal-item .portal-details {\n                padding: 10px;\n                display: flex;\n                flex-direction: column;\n                gap: 6px;\n            }\n\n            .mazemaster-portal-item .portal-row {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n            }\n\n            .mazemaster-portal-item .portal-row label {\n                width: 90px;\n                font-size: 0.85em;\n                color: var(--SmartThemeBodyColor, #ccc);\n            }\n\n            .mazemaster-portal-item .portal-row input[type="text"],\n            .mazemaster-portal-item .portal-row input[type="number"] {\n                flex: 1;\n                max-width: 80px;\n            }\n\n            .mazemaster-portal-item .coords-row {\n                gap: 4px;\n            }\n\n            .mazemaster-portal-item .coords-row span {\n                font-size: 0.8em;\n                color: var(--SmartThemeBodyColor, #999);\n            }\n\n            .mazemaster-portal-item .coords-row input {\n                width: 50px !important;\n                max-width: 50px !important;\n            }\n\n            .mazemaster-portal-item .portal-color-input {\n                width: 32px;\n                height: 24px;\n                padding: 0;\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                cursor: pointer;\n            }\n\n            .mazemaster-portal-item .remove-portal-btn {\n                padding: 4px 8px;\n                font-size: 0.8em;\n            }\n\n            /* Objectives Config List */\n            .mazemaster-objectives-list {\n                display: flex;\n                flex-direction: column;\n                gap: 8px;\n                margin-bottom: 10px;\n            }\n\n            .mazemaster-objective-item {\n                background: rgba(0, 0, 0, 0.2);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 6px;\n                overflow: hidden;\n            }\n\n            .mazemaster-objective-item .objective-config-header {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                padding: 8px 10px;\n                background: rgba(0, 0, 0, 0.2);\n                border-bottom: 1px solid var(--SmartThemeBorderColor, #444);\n            }\n\n            .mazemaster-objective-item .objective-name {\n                flex: 1;\n                font-weight: 500;\n            }\n\n            .mazemaster-objective-item .objective-config-details {\n                padding: 10px;\n                display: flex;\n                flex-direction: column;\n                gap: 6px;\n            }\n\n            .mazemaster-objective-item .objective-config-row {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n            }\n\n            .mazemaster-objective-item .objective-config-row label {\n                width: 100px;\n                font-size: 0.85em;\n                color: var(--SmartThemeBodyColor, #ccc);\n            }\n\n            .mazemaster-objective-item .objective-config-row input[type="text"],\n            .mazemaster-objective-item .objective-config-row input[type="number"],\n            .mazemaster-objective-item .objective-config-row select {\n                flex: 1;\n            }\n\n            .mazemaster-objective-item .remove-objective-btn {\n                padding: 4px 8px;\n                font-size: 0.8em;\n            }\n\n            /* STScript Hooks Config */\n            .mazemaster-hooks-group {\n                margin-top: 12px;\n            }\n\n            .mazemaster-hooks-group:first-of-type {\n                margin-top: 8px;\n            }\n\n            .mazemaster-hooks-label {\n                display: block;\n                font-size: 0.85em;\n                font-weight: 500;\n                color: #3498db;\n                margin-bottom: 6px;\n                padding-bottom: 4px;\n                border-bottom: 1px solid rgba(52, 152, 219, 0.3);\n            }\n\n            .mazemaster-hooks-items {\n                display: flex;\n                flex-direction: column;\n                gap: 6px;\n            }\n\n            .mazemaster-hooks-items .hook-item {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n            }\n\n            .mazemaster-hooks-items .hook-item > label {\n                width: 120px;\n                flex-shrink: 0;\n                font-size: 0.85em;\n                color: var(--SmartThemeBodyColor, #ccc);\n            }\n\n            .mazemaster-hooks-items .hook-item input {\n                flex: 1;\n            }\n\n            /* Inline row */\n            .mazemaster-inline-row {\n                display: flex;\n                gap: 12px;\n            }\n\n            .mazemaster-flex-1 {\n                flex: 1;\n            }\n\n            /* Saved Games */\n            .mazemaster-saved-games-list {\n                display: flex;\n                flex-direction: column;\n                gap: 8px;\n            }\n\n            .mazemaster-saved-game {\n                display: flex;\n                justify-content: space-between;\n                align-items: center;\n                padding: 8px 12px;\n                background: rgba(0, 0, 0, 0.2);\n                border-radius: 4px;\n            }\n\n            .mazemaster-saved-game-info {\n                display: flex;\n                flex-direction: column;\n                gap: 2px;\n            }\n\n            .mazemaster-saved-game-name {\n                font-weight: 500;\n            }\n\n            .mazemaster-saved-game-details {\n                font-size: 0.8em;\n                opacity: 0.7;\n            }\n\n            .mazemaster-saved-game-actions {\n                display: flex;\n                gap: 6px;\n            }\n\n            .mazemaster-no-saves {\n                text-align: center;\n                opacity: 0.6;\n                padding: 12px;\n                font-style: italic;\n            }\n\n            /* Side-by-side sections */\n            .mazemaster-section-row {\n                display: grid;\n                grid-template-columns: 1fr 1fr;\n                gap: 16px;\n            }\n\n            .mazemaster-section-row .mazemaster-section {\n                margin-bottom: 0;\n            }\n\n            /* Minions Config Styles */\n            .mazemaster-minions-list {\n                display: flex;\n                flex-direction: column;\n                gap: 10px;\n                margin-bottom: 10px;\n            }\n\n            .mazemaster-minion-card {\n                display: flex;\n                gap: 10px;\n                align-items: center;\n                padding: 10px;\n                background: rgba(0, 0, 0, 0.2);\n                border-radius: 5px;\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n            }\n\n            .mazemaster-minion-card .minion-image {\n                width: 50px;\n                height: 50px;\n                border-radius: 5px;\n                overflow: hidden;\n                background: rgba(0, 0, 0, 0.3);\n                flex-shrink: 0;\n                position: relative;\n                cursor: pointer;\n            }\n\n            .mazemaster-minion-card .minion-image img {\n                width: 100%;\n                height: 100%;\n                object-fit: cover;\n            }\n\n            .mazemaster-minion-card .minion-image:hover {\n                outline: 2px solid var(--SmartThemeQuoteColor, #e74c3c);\n                outline-offset: 2px;\n            }\n\n            .mazemaster-minion-card .minion-image::after {\n                content: \'\\f030\';\n                font-family: \'Font Awesome 6 Free\';\n                font-weight: 900;\n                position: absolute;\n                bottom: 2px;\n                right: 2px;\n                font-size: 10px;\n                color: white;\n                background: rgba(0, 0, 0, 0.6);\n                padding: 2px 4px;\n                border-radius: 3px;\n                opacity: 0;\n                transition: opacity 0.2s;\n            }\n\n            .mazemaster-minion-card .minion-image:hover::after {\n                opacity: 1;\n            }\n\n            .mazemaster-minion-card .minion-info {\n                flex: 1;\n            }\n\n            .mazemaster-minion-card .minion-row {\n                display: flex;\n                gap: 8px;\n                margin-bottom: 8px;\n            }\n\n            .mazemaster-minion-card .minion-name-input {\n                flex: 1;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 6px 8px;\n                color: var(--SmartThemeBodyColor);\n            }\n\n            .mazemaster-minion-card .minion-type-select {\n                width: 110px;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 6px 8px;\n                color: var(--SmartThemeBodyColor);\n            }\n\n            .mazemaster-minion-card .minion-profiles {\n                margin-top: 8px;\n            }\n\n            .mazemaster-minion-card .minion-profiles label {\n                display: block;\n                font-size: 0.85em;\n                color: var(--SmartThemeQuoteColor);\n                margin-bottom: 4px;\n            }\n\n            .mazemaster-minion-card .minion-profiles select {\n                width: 100%;\n                min-height: 60px;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 4px;\n                color: var(--SmartThemeBodyColor);\n            }\n\n            .mazemaster-minion-card .minion-profiles textarea {\n                width: 100%;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 6px 8px;\n                color: var(--SmartThemeBodyColor);\n                resize: vertical;\n            }\n\n            .mazemaster-minion-card .merchant-range-row {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n            }\n\n            .mazemaster-minion-card .merchant-range-row span {\n                color: var(--SmartThemeBodyColor);\n                opacity: 0.8;\n            }\n\n            .mazemaster-minion-card .minion-encounter-script {\n                margin-top: 10px;\n                padding-top: 10px;\n                border-top: 1px solid var(--SmartThemeBorderColor, #333);\n            }\n\n            .mazemaster-minion-card .minion-encounter-script label {\n                display: block;\n                font-size: 0.85em;\n                color: var(--SmartThemeQuoteColor);\n                margin-bottom: 4px;\n            }\n\n            .mazemaster-minion-card .minion-encounter-script textarea {\n                width: 100%;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 6px 8px;\n                color: var(--SmartThemeBodyColor);\n                resize: vertical;\n                font-family: monospace;\n            }\n\n            .mazemaster-minion-card .minion-delete-btn {\n                padding: 5px 8px;\n                flex-shrink: 0;\n                align-self: flex-start;\n            }\n\n            /* Minion Movement Settings */\n            .mazemaster-minion-card .minion-movement-settings {\n                margin-top: 8px;\n                padding-top: 8px;\n                border-top: 1px solid var(--SmartThemeBorderColor, #444);\n            }\n\n            .mazemaster-minion-card .minion-movement-settings > label {\n                display: block;\n                font-size: 0.85em;\n                color: var(--SmartThemeBodyColor, #999);\n                margin-bottom: 4px;\n            }\n\n            .mazemaster-minion-card .movement-row {\n                display: flex;\n                gap: 8px;\n                margin-bottom: 6px;\n            }\n\n            .mazemaster-minion-card .minion-movement-type {\n                flex: 1;\n            }\n\n            .mazemaster-minion-card .movement-params {\n                display: flex;\n                gap: 12px;\n                flex-wrap: wrap;\n            }\n\n            .mazemaster-minion-card .movement-param {\n                display: flex;\n                align-items: center;\n                gap: 4px;\n                font-size: 0.85em;\n            }\n\n            .mazemaster-minion-card .movement-param span {\n                color: var(--SmartThemeBodyColor, #999);\n            }\n\n            .mazemaster-minion-card .movement-param input {\n                width: 50px;\n            }\n\n            /* TRAP CARD STYLES */\n            .mazemaster-traps-list {\n                display: flex;\n                flex-direction: column;\n                gap: 10px;\n                margin-bottom: 10px;\n                max-height: 400px;\n                overflow-y: auto;\n            }\n\n            .mazemaster-trap-card {\n                display: flex;\n                gap: 10px;\n                background: rgba(0, 0, 0, 0.2);\n                border-radius: 8px;\n                padding: 10px;\n                align-items: flex-start;\n            }\n\n            .mazemaster-trap-card .trap-image {\n                width: 80px;\n                height: 80px;\n                flex-shrink: 0;\n                border-radius: 6px;\n                overflow: hidden;\n                background: rgba(0, 0, 0, 0.3);\n                position: relative;\n                cursor: pointer;\n            }\n\n            .mazemaster-trap-card .trap-image img {\n                width: 100%;\n                height: 100%;\n                object-fit: cover;\n            }\n\n            .mazemaster-trap-card .trap-image:hover {\n                outline: 2px solid var(--SmartThemeQuoteColor, #e74c3c);\n                outline-offset: 2px;\n            }\n\n            .mazemaster-trap-card .trap-image::after {\n                content: \'\\f030\';\n                font-family: \'Font Awesome 6 Free\';\n                font-weight: 900;\n                position: absolute;\n                bottom: 4px;\n                right: 4px;\n                font-size: 12px;\n                color: white;\n                background: rgba(0, 0, 0, 0.6);\n                padding: 3px 5px;\n                border-radius: 3px;\n                opacity: 0;\n                transition: opacity 0.2s;\n            }\n\n            .mazemaster-trap-card .trap-image:hover::after {\n                opacity: 1;\n            }\n\n            .mazemaster-trap-card .trap-no-image {\n                width: 100%;\n                height: 100%;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                color: var(--SmartThemeBodyColor);\n                opacity: 0.5;\n                font-size: 24px;\n            }\n\n            .mazemaster-trap-card .trap-info {\n                flex: 1;\n                display: flex;\n                flex-direction: column;\n                gap: 8px;\n            }\n\n            .mazemaster-trap-card .trap-row {\n                display: flex;\n                gap: 8px;\n            }\n\n            .mazemaster-trap-card .trap-name-input {\n                flex: 1;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 6px 8px;\n                color: var(--SmartThemeBodyColor);\n            }\n\n            .mazemaster-trap-card .trap-message-row,\n            .mazemaster-trap-card .trap-script-row {\n                display: flex;\n                flex-direction: column;\n                gap: 4px;\n            }\n\n            .mazemaster-trap-card .trap-message-row label,\n            .mazemaster-trap-card .trap-script-row label {\n                font-size: 0.75em;\n                opacity: 0.7;\n            }\n\n            .mazemaster-trap-card .trap-message-input,\n            .mazemaster-trap-card .trap-script-input {\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 6px 8px;\n                color: var(--SmartThemeBodyColor);\n                resize: vertical;\n                font-family: inherit;\n            }\n\n            .mazemaster-trap-card .trap-delete-btn {\n                padding: 5px 8px;\n                flex-shrink: 0;\n                align-self: flex-start;\n            }\n\n            /* Story Milestones Modal */\n            .mazemaster-story-modal {\n                position: fixed;\n                top: 0;\n                left: 0;\n                width: 100%;\n                height: 100%;\n                background: rgba(0, 0, 0, 0.7);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                z-index: 10000;\n            }\n\n            .mazemaster-story-modal-content {\n                background: var(--SmartThemeBlurTintColor, #1a1a1a);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 10px;\n                padding: 20px;\n                width: 90%;\n                max-width: 600px;\n                max-height: 80vh;\n                overflow-y: auto;\n            }\n\n            .mazemaster-story-modal-content h3 {\n                margin: 0 0 15px 0;\n                display: flex;\n                align-items: center;\n                gap: 10px;\n            }\n\n            .mazemaster-story-textarea {\n                width: 100%;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 8px;\n                color: var(--SmartThemeBodyColor);\n                resize: vertical;\n                font-family: inherit;\n            }\n\n            .mazemaster-milestones-list {\n                display: flex;\n                flex-direction: column;\n                gap: 10px;\n                margin-bottom: 10px;\n                max-height: 200px;\n                overflow-y: auto;\n            }\n\n            .mazemaster-milestone-row {\n                display: flex;\n                gap: 10px;\n                align-items: flex-start;\n                background: rgba(0, 0, 0, 0.2);\n                padding: 10px;\n                border-radius: 6px;\n            }\n\n            .milestone-percent {\n                display: flex;\n                align-items: center;\n                gap: 4px;\n                flex-shrink: 0;\n            }\n\n            .milestone-percent-input {\n                width: 50px;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 6px;\n                color: var(--SmartThemeBodyColor);\n                text-align: center;\n            }\n\n            .milestone-text-input {\n                flex: 1;\n                background: rgba(0, 0, 0, 0.3);\n                border: 1px solid var(--SmartThemeBorderColor, #444);\n                border-radius: 4px;\n                padding: 6px;\n                color: var(--SmartThemeBodyColor);\n                resize: vertical;\n                font-family: inherit;\n            }\n\n            .mazemaster-story-modal-buttons {\n                display: flex;\n                gap: 10px;\n                justify-content: flex-end;\n                margin-top: 15px;\n            }\n        </style>\n    ')}function Qt(){var e;const t=document.getElementById("mazemaster_segments_list");if(!t)return;const n=xe(null===(e=document.getElementById("mazemaster_profile_select"))||void 0===e?void 0:e.value),a=(null==n?void 0:n.segments)||[];0!==a.length?(t.innerHTML=a.map(((e,t)=>'\n        <div class="mazemaster-segment-item" data-index="'.concat(t,'">\n            <div class="mazemaster-segment-row">\n                <div class="mazemaster-segment-field small">\n                    <label>Trigger</label>\n                    <input type="text" class="seg-trigger" value="').concat($t(e.trigger||""),'" placeholder="com1">\n                </div>\n                <div class="mazemaster-segment-field">\n                    <label>Display Text</label>\n                    <input type="text" class="seg-text" value="').concat($t(e.text||""),'" placeholder="Prize name">\n                </div>\n                <div class="mazemaster-segment-field small">\n                    <label>Size</label>\n                    <select class="seg-size">\n                        ').concat(y.map((t=>'<option value="'.concat(t,'" ').concat(e.size===t?"selected":"",">").concat(t,"</option>"))).join(""),'\n                    </select>\n                </div>\n                <button class="menu_button menu_button_icon mazemaster-segment-delete" title="Delete">\n                    <i class="fa-solid fa-trash"></i>\n                </button>\n            </div>\n            <div class="mazemaster-segment-row">\n                <div class="mazemaster-segment-field">\n                    <label>STScript Command</label>\n                    <textarea class="seg-command" placeholder="/echo You won!">').concat($t(e.command||""),'</textarea>\n                </div>\n                <div class="mazemaster-segment-field tiny">\n                    <label>&nbsp;</label>\n                    <label class="mazemaster-segment-checkbox">\n                        <input type="checkbox" class="seg-respin" ').concat(e.respin?"checked":"",">\n                        Respin\n                    </label>\n                </div>\n            </div>\n        </div>\n    "))).join(""),t.querySelectorAll(".mazemaster-segment-delete").forEach((e=>{e.addEventListener("click",(e=>{e.target.closest(".mazemaster-segment-item").remove()}))}))):t.innerHTML='<div class="mazemaster-empty-state">No segments. Click "Add Segment" to create one.</div>'}function $t(e){const t=document.createElement("div");return t.textContent=e||"",t.innerHTML}function en(){var e;const t=document.getElementById("mazemaster_bb_images_list");if(!t)return;const n=null===(e=document.getElementById("mazemaster_bb_profile_select"))||void 0===e?void 0:e.value;if(!n)return void(t.innerHTML='<div class="mazemaster-empty-state">Select or create a profile first.</div>');const a=(_e(n)||{}).images||[];0!==a.length?(t.innerHTML=a.map(((e,t)=>'\n        <div class="mazemaster-bb-image-item" data-index="'.concat(t,'" title="Click to edit stage message">\n            <img src="/').concat(e.path,'" alt="').concat($t(e.stageMessage||""),'">\n            <span class="bb-image-index">').concat(t,'</span>\n            <div class="bb-image-message">').concat($t(e.stageMessage||"(no message)"),'</div>\n            <button class="bb-image-delete" title="Delete">\n                <i class="fa-solid fa-times"></i>\n            </button>\n        </div>\n    '))).join(""),t.querySelectorAll(".mazemaster-bb-image-item").forEach((e=>{e.addEventListener("click",(async t=>{var a;if(t.target.closest(".bb-image-delete"))return;const o=parseInt(e.dataset.index),i=_e(n)||{},s=i.images||[],r=(null===(a=s[o])||void 0===a?void 0:a.stageMessage)||"",l=await p("Stage ".concat(o," Message:"),u.INPUT,r);null!=l&&(s[o].stageMessage=l,Se(n,i),en())}))})),t.querySelectorAll(".bb-image-delete").forEach((e=>{e.addEventListener("click",(async e=>{e.stopPropagation();const t=e.target.closest(".mazemaster-bb-image-item"),a=parseInt(t.dataset.index);if(!await p("Delete stage ".concat(a,"?"),u.CONFIRM))return;const o=_e(n)||{};o.images=(o.images||[]).filter(((e,t)=>t!==a)),Se(n,o),en()}))}))):t.innerHTML='<div class="mazemaster-empty-state">No stages. Add images to create stages.</div>'}function tn(){var e,t,n,a;const o=null===(e=document.getElementById("mazemaster_maze_profile_select"))||void 0===e?void 0:e.value,s=Me(o)||{},r=document.getElementById("mazemaster_maze_size");r&&(r.value=s.gridSize||10);const l=document.getElementById("mazemaster_maze_win_cmd");l&&(l.value=s.winCommand||"");const c=document.getElementById("mazemaster_maze_lose_cmd");c&&(c.value=s.loseCommand||"");const m=document.getElementById("mazemaster_maze_win_message");m&&(m.value=s.winMessage||"");const d=document.getElementById("mazemaster_maze_main_minion");if(d){const e=Ce();d.innerHTML='<option value="">None</option>'+e.map((e=>{const t=Ie(e);return'<option value="'.concat($t(e),'" ').concat(s.mainMinion===e?"selected":"",">").concat($t((null==t?void 0:t.name)||e),"</option>")})).join("")}const p=document.getElementById("mazemaster_main_minion_settings");p&&(p.style.display=s.mainMinion?"block":"none");const u=document.getElementById("mazemaster_maze_intro_message");u&&(u.value=s.mainMinionIntroMessage||"");const h=document.getElementById("mazemaster_maze_random_chance");h&&(h.value=s.mainMinionRandomChance||15);const g=document.getElementById("mazemaster_maze_random_messages");g&&(g.value=(s.mainMinionRandomMessages||[]).join("\n"));const f=document.getElementById("mazemaster_maze_exit_type");f&&(f.value=s.mainMinionExitType||"messenger"),nn(s.mainMinionExitType||"messenger",s.mainMinionExitProfile);const v=document.getElementById("mazemaster_maze_loss_action");v&&(v.value=s.onBattlebarLoss||"continue");const b=document.querySelector(".mazemaster-maze-win-image-preview");b&&(s.winImage?b.innerHTML='<img id="maze_win_image_preview" src="'.concat(s.winImage,'" alt="Victory">'):b.innerHTML='<div id="maze_win_image_preview" class="no-image">No image</div>');const y=document.getElementById("mazemaster_maze_chest_percent");y&&(y.value=s.chestTilePercent||10);const z=document.getElementById("mazemaster_maze_locked_percent");z&&(z.value=s.chestLockedPercent||30);const x=document.getElementById("mazemaster_maze_locked_bonus");x&&(x.value=s.chestLockedBonusPercent||50);const w=document.getElementById("mazemaster_maze_mimic_percent");w&&(w.value=s.chestMimicPercent||15);const _=document.getElementById("mazemaster_maze_loot_min");_&&(_.value=s.chestLootMin||1);const S=document.getElementById("mazemaster_maze_loot_max");S&&(S.value=s.chestLootMax||2);const k=document.getElementById("mazemaster_maze_chest_key");k&&(k.value=s.chestKeyChance||30);const M=document.getElementById("mazemaster_maze_chest_pow");M&&(M.value=s.chestPowChance||50);const E=document.getElementById("mazemaster_maze_chest_stealth");E&&(E.value=s.chestStealthChance||0);const C=document.getElementById("mazemaster_maze_chest_grandpow");C&&(C.value=s.chestGrandpowChance||0);const I=document.getElementById("mazemaster_maze_locked_key");I&&(I.value=s.lockedChestKeyChance||40);const T=document.getElementById("mazemaster_maze_locked_pow");T&&(T.value=s.lockedChestPowChance||60);const P=document.getElementById("mazemaster_maze_locked_stealth");P&&(P.value=s.lockedChestStealthChance||30);const B=document.getElementById("mazemaster_maze_locked_grandpow");B&&(B.value=s.lockedChestGrandpowChance||5);let L=s.startingInventory||{};!(L.key||L.stealth||L.pow||L.grandpow)&&null!==(t=me[o])&&void 0!==t&&t.startingInventory&&(L=me[o].startingInventory,s.startingInventory=JSON.parse(JSON.stringify(L)),i());const j=document.getElementById("mazemaster_start_key");j&&(j.value=L.key||0);const O=document.getElementById("mazemaster_start_stealth");O&&(O.value=L.stealth||0);const A=document.getElementById("mazemaster_start_pow");A&&(A.value=L.pow||0);const D=document.getElementById("mazemaster_start_grandpow");D&&(D.value=L.grandpow||0);let R=s.minionEncounters||[],F=s.trapEncounters||[];0===R.length&&null!==(n=me[o])&&void 0!==n&&n.minionEncounters&&(R=me[o].minionEncounters,s.minionEncounters=JSON.parse(JSON.stringify(R)),i()),0===F.length&&null!==(a=me[o])&&void 0!==a&&a.trapEncounters&&(F=me[o].trapEncounters,s.trapEncounters=JSON.parse(JSON.stringify(F)),i()),function(e){const t=document.getElementById("mazemaster_maze_encounters_list");if(!t)return;const n=Ce();if(0===e.length)return void(t.innerHTML='<div class="mazemaster-empty-state" style="font-size: 0.85em;">No encounters. Minions will be randomly placed in the maze.</div>');t.innerHTML=e.map(((e,t)=>{Ie(e.minionId);return'\n            <div class="mazemaster-encounter-row" data-index="'.concat(t,'">\n                <select class="encounter-minion-select">\n                    ').concat(n.map((t=>{const n=Ie(t);return'<option value="'.concat($t(t),'" ').concat(e.minionId===t?"selected":"",">").concat($t((null==n?void 0:n.name)||t),"</option>")})).join(""),'\n                </select>\n                <input type="number" class="encounter-percent-input" min="1" max="100" value="').concat(e.percent||5,'" placeholder="%">\n                <span class="encounter-percent-label">%</span>\n                <button class="menu_button menu_button_icon encounter-remove-btn" title="Remove">\n                    <i class="fa-solid fa-trash"></i>\n                </button>\n            </div>\n        ')})).join(""),t.querySelectorAll(".mazemaster-encounter-row").forEach((e=>{var t,n,a;parseInt(e.dataset.index);null===(t=e.querySelector(".encounter-minion-select"))||void 0===t||t.addEventListener("change",(()=>{})),null===(n=e.querySelector(".encounter-percent-input"))||void 0===n||n.addEventListener("change",(()=>{})),null===(a=e.querySelector(".encounter-remove-btn"))||void 0===a||a.addEventListener("click",(()=>{e.remove()}))}))}(R),function(e){const t=document.getElementById("mazemaster_maze_traps_list");if(!t)return;const n=Pe();if(0===e.length)return void(t.innerHTML='<div class="mazemaster-empty-state" style="font-size: 0.85em;">No traps. Add traps to place trap tiles in the maze.</div>');t.innerHTML=e.map(((e,t)=>{Be(e.trapId);return'\n            <div class="mazemaster-encounter-row mazemaster-trap-encounter-row" data-index="'.concat(t,'">\n                <select class="trap-encounter-select">\n                    ').concat(n.map((t=>{const n=Be(t);return'<option value="'.concat($t(t),'" ').concat(e.trapId===t?"selected":"",">").concat($t((null==n?void 0:n.name)||t),"</option>")})).join(""),'\n                </select>\n                <input type="number" class="trap-encounter-percent-input" min="1" max="100" value="').concat(e.percent||5,'" placeholder="%">\n                <span class="encounter-percent-label">%</span>\n                <button class="menu_button menu_button_icon trap-encounter-remove-btn" title="Remove">\n                    <i class="fa-solid fa-trash"></i>\n                </button>\n            </div>\n        ')})).join(""),t.querySelectorAll(".mazemaster-trap-encounter-row").forEach((e=>{var t;null===(t=e.querySelector(".trap-encounter-remove-btn"))||void 0===t||t.addEventListener("click",(()=>{e.remove()}))}))}(F)}function nn(e,t){const n=document.getElementById("mazemaster_exit_profile_section"),a=document.getElementById("mazemaster_maze_exit_profile");if(!n||!a)return;if("messenger"===e)return void(n.style.display="none");n.style.display="block";let o=[];"battlebar"===e?(o=we(),0===o.length&&(o=Object.keys(oe))):"prizewheel"===e&&(o=ze(),0===o.length&&(o=Object.keys(ae))),a.innerHTML='<option value="">Select...</option>'+o.map((e=>'<option value="'.concat($t(e),'" ').concat(e===t?"selected":"",">").concat($t(e),"</option>"))).join("")}function an(){var e,t,n,a,o,i,s,r,l,c,m,d,p,u,h,g,f,v,b,y,z,x,w,_,S,k,M,E,C,I,T,P,B,L,j,O,A,D,R,F,N,W,q,H,G,Y,U,K;const X=Me(null===(e=document.getElementById("mazemaster_maze_profile_select"))||void 0===e?void 0:e.value)||{},V=document.querySelectorAll("#mazemaster_maze_encounters_list .mazemaster-encounter-row"),J=[];V.forEach((e=>{var t,n;const a=null===(t=e.querySelector(".encounter-minion-select"))||void 0===t?void 0:t.value,o=parseInt(null===(n=e.querySelector(".encounter-percent-input"))||void 0===n?void 0:n.value)||5;a&&J.push({minionId:a,percent:o})}));const Z=document.querySelectorAll("#mazemaster_maze_traps_list .mazemaster-trap-encounter-row"),Q=[];Z.forEach((e=>{var t,n;const a=null===(t=e.querySelector(".trap-encounter-select"))||void 0===t?void 0:t.value,o=parseInt(null===(n=e.querySelector(".trap-encounter-percent-input"))||void 0===n?void 0:n.value)||5;a&&Q.push({trapId:a,percent:o})}));const $=((null===(t=document.getElementById("mazemaster_maze_random_messages"))||void 0===t?void 0:t.value)||"").split("\n").filter((e=>e.trim()));return{gridSize:parseInt(null===(n=document.getElementById("mazemaster_maze_size"))||void 0===n?void 0:n.value)||10,difficulty:(null===(a=document.getElementById("mazemaster_maze_difficulty"))||void 0===a?void 0:a.value)||"normal",theme:(null===(o=document.getElementById("mazemaster_maze_theme"))||void 0===o?void 0:o.value)||"fantasy",mapStyle:(null===(i=document.getElementById("mazemaster_maze_mapstyle"))||void 0===i?void 0:i.value)||"maze",floors:parseInt(null===(s=document.getElementById("mazemaster_maze_floors"))||void 0===s?void 0:s.value)||1,fogOfWar:(null===(r=document.getElementById("mazemaster_maze_fog_of_war"))||void 0===r?void 0:r.checked)||!1,winCommand:(null===(l=document.getElementById("mazemaster_maze_win_cmd"))||void 0===l?void 0:l.value)||"",loseCommand:(null===(c=document.getElementById("mazemaster_maze_lose_cmd"))||void 0===c?void 0:c.value)||"",winMessage:(null===(m=document.getElementById("mazemaster_maze_win_message"))||void 0===m?void 0:m.value)||"",winImage:X.winImage||"",chestImage:X.chestImage||"",mainMinion:(null===(d=document.getElementById("mazemaster_maze_main_minion"))||void 0===d?void 0:d.value)||"",mainMinionIntroMessage:(null===(p=document.getElementById("mazemaster_maze_intro_message"))||void 0===p?void 0:p.value)||"",mainMinionRandomChance:parseInt(null===(u=document.getElementById("mazemaster_maze_random_chance"))||void 0===u?void 0:u.value)||15,mainMinionRandomMessages:$,mainMinionExitType:(null===(h=document.getElementById("mazemaster_maze_exit_type"))||void 0===h?void 0:h.value)||"messenger",mainMinionExitProfile:(null===(g=document.getElementById("mazemaster_maze_exit_profile"))||void 0===g?void 0:g.value)||"",minionEncounters:J,trapEncounters:Q,onBattlebarLoss:(null===(f=document.getElementById("mazemaster_maze_loss_action"))||void 0===f?void 0:f.value)||"continue",chestTilePercent:parseInt(null===(v=document.getElementById("mazemaster_maze_chest_percent"))||void 0===v?void 0:v.value)||10,chestLockedPercent:parseInt(null===(b=document.getElementById("mazemaster_maze_locked_percent"))||void 0===b?void 0:b.value)||30,chestLockedBonusPercent:parseInt(null===(y=document.getElementById("mazemaster_maze_locked_bonus"))||void 0===y?void 0:y.value)||50,chestMimicPercent:parseInt(null===(z=document.getElementById("mazemaster_maze_mimic_percent"))||void 0===z?void 0:z.value)||15,chestLootMin:parseInt(null===(x=document.getElementById("mazemaster_maze_loot_min"))||void 0===x?void 0:x.value)||1,chestLootMax:parseInt(null===(w=document.getElementById("mazemaster_maze_loot_max"))||void 0===w?void 0:w.value)||2,chestKeyChance:parseInt(null===(_=document.getElementById("mazemaster_maze_chest_key"))||void 0===_?void 0:_.value)||30,chestPowChance:parseInt(null===(S=document.getElementById("mazemaster_maze_chest_pow"))||void 0===S?void 0:S.value)||50,chestStealthChance:parseInt(null===(k=document.getElementById("mazemaster_maze_chest_stealth"))||void 0===k?void 0:k.value)||0,chestGrandpowChance:parseInt(null===(M=document.getElementById("mazemaster_maze_chest_grandpow"))||void 0===M?void 0:M.value)||0,lockedChestKeyChance:parseInt(null===(E=document.getElementById("mazemaster_maze_locked_key"))||void 0===E?void 0:E.value)||40,lockedChestPowChance:parseInt(null===(C=document.getElementById("mazemaster_maze_locked_pow"))||void 0===C?void 0:C.value)||60,lockedChestStealthChance:parseInt(null===(I=document.getElementById("mazemaster_maze_locked_stealth"))||void 0===I?void 0:I.value)||30,lockedChestGrandpowChance:parseInt(null===(T=document.getElementById("mazemaster_maze_locked_grandpow"))||void 0===T?void 0:T.value)||5,startingInventory:{key:parseInt(null===(P=document.getElementById("mazemaster_start_key"))||void 0===P?void 0:P.value)||0,pow:parseInt(null===(B=document.getElementById("mazemaster_start_pow"))||void 0===B?void 0:B.value)||0,stealth:parseInt(null===(L=document.getElementById("mazemaster_start_stealth"))||void 0===L?void 0:L.value)||0,grandpow:parseInt(null===(j=document.getElementById("mazemaster_start_grandpow"))||void 0===j?void 0:j.value)||0},portals:on(),objectives:sn(),onMove:(null===(O=document.getElementById("mazemaster_hook_onMove"))||void 0===O?void 0:O.value)||"",onMilestone:(null===(A=document.getElementById("mazemaster_hook_onMilestone"))||void 0===A?void 0:A.value)||"",onExploreComplete:(null===(D=document.getElementById("mazemaster_hook_onExploreComplete"))||void 0===D?void 0:D.value)||"",onItemAdd:(null===(R=document.getElementById("mazemaster_hook_onItemAdd"))||void 0===R?void 0:R.value)||"",onItemRemove:(null===(F=document.getElementById("mazemaster_hook_onItemRemove"))||void 0===F?void 0:F.value)||"",onChestOpen:(null===(N=document.getElementById("mazemaster_hook_onChestOpen"))||void 0===N?void 0:N.value)||"",onTrade:(null===(W=document.getElementById("mazemaster_hook_onTrade"))||void 0===W?void 0:W.value)||"",onEnemyMove:(null===(q=document.getElementById("mazemaster_hook_onEnemyMove"))||void 0===q?void 0:q.value)||"",onTeleport:(null===(H=document.getElementById("mazemaster_hook_onTeleport"))||void 0===H?void 0:H.value)||"",onObjectiveProgress:(null===(G=document.getElementById("mazemaster_hook_onObjectiveProgress"))||void 0===G?void 0:G.value)||"",onObjectiveComplete:(null===(Y=document.getElementById("mazemaster_hook_onObjectiveComplete"))||void 0===Y?void 0:Y.value)||"",onAllObjectivesComplete:(null===(U=document.getElementById("mazemaster_hook_onAllObjectivesComplete"))||void 0===U?void 0:U.value)||"",onStatUpdate:(null===(K=document.getElementById("mazemaster_hook_onStatUpdate"))||void 0===K?void 0:K.value)||"",storyConfig:X.storyConfig||{mainStory:"",milestones:[]}}}function on(){const e=[];return document.querySelectorAll("#mazemaster_portals_list .mazemaster-portal-item").forEach((t=>{var n,a,o,i,s,r,l,c;const m=(null===(n=t.querySelector(".portal-id"))||void 0===n||null===(n=n.value)||void 0===n?void 0:n.trim())||"",d=(null===(a=t.querySelector(".portal-color-input"))||void 0===a?void 0:a.value)||"#9b59b6",p=null===(o=null===(i=t.querySelector(".portal-bidirectional"))||void 0===i?void 0:i.checked)||void 0===o||o,u=null===(s=t.querySelector(".portal-start-x"))||void 0===s?void 0:s.value,h=null===(r=t.querySelector(".portal-start-y"))||void 0===r?void 0:r.value,g=null===(l=t.querySelector(".portal-end-x"))||void 0===l?void 0:l.value,f=null===(c=t.querySelector(".portal-end-y"))||void 0===c?void 0:c.value;e.push({id:m||"portal_".concat(e.length+1),color:d,bidirectional:p,startX:""!==u?parseInt(u):null,startY:""!==h?parseInt(h):null,endX:""!==g?parseInt(g):null,endY:""!==f?parseInt(f):null})})),e}function sn(){const e=[];return document.querySelectorAll("#mazemaster_objectives_list .mazemaster-objective-item").forEach(((t,n)=>{var a,o,i,s,r,l,c,m;const d=(null===(a=t.querySelector(".objective-id"))||void 0===a||null===(a=a.value)||void 0===a?void 0:a.trim())||"obj_".concat(n+1),p=(null===(o=t.querySelector(".objective-type"))||void 0===o?void 0:o.value)||"collect",u=(null===(i=t.querySelector(".objective-target"))||void 0===i||null===(i=i.value)||void 0===i?void 0:i.trim())||"",h=parseInt(null===(s=t.querySelector(".objective-count"))||void 0===s?void 0:s.value)||1,g=(null===(r=t.querySelector(".objective-description"))||void 0===r||null===(r=r.value)||void 0===r?void 0:r.trim())||"",f=null===(l=null===(c=t.querySelector(".objective-required"))||void 0===c?void 0:c.checked)||void 0===l||l,v=(null===(m=t.querySelector(".objective-reward"))||void 0===m||null===(m=m.value)||void 0===m?void 0:m.trim())||"";e.push({id:d,type:p,target:"explore"===p?null:u,count:h,description:g||"".concat("collect"===p?"Collect":"defeat"===p?"Defeat":"Explore"," ").concat(h).concat("explore"===p?"%":" "+u),required:f,reward:v})})),e}async function rn(e,t){let n;try{n=await async function(e){return new Promise(((t,n)=>{const a=new Image,o=URL.createObjectURL(e);a.onload=()=>{URL.revokeObjectURL(o);const i=Math.min(a.width,a.height),s=(a.width-i)/2,r=(a.height-i)/2,l=document.createElement("canvas");l.width=i,l.height=i,l.getContext("2d").drawImage(a,s,r,i,i,0,0,i,i),l.toBlob((e=>{e?t(e):n(new Error("Failed to create cropped image"))}),e.type||"image/png")},a.onerror=()=>{URL.revokeObjectURL(o),n(new Error("Failed to load image"))},a.src=o}))}(e)}catch(t){console.warn("[MazeMaster] Could not crop image, using original:",t),n=e}return new Promise(((a,o)=>{const i=new FileReader;i.onload=async n=>{try{const i=n.target.result.split(",")[1],s=e.name.split(".").pop().toLowerCase(),r=Date.now(),l="".concat(t,"_").concat(r),c=await fetch("/api/images/upload",{method:"POST",headers:d(),body:JSON.stringify({image:i,ch_name:"MazeMaster",filename:l,format:s})});if(c.ok)a("user/images/MazeMaster/".concat(l,".").concat(s));else{const e=await c.json().catch((()=>({})));o(new Error(e.error||"Upload failed"))}}catch(e){o(e)}},i.onerror=()=>o(new Error("Failed to read file")),i.readAsDataURL(n)}))}function ln(){const e=document.getElementById("mazemaster_minions_list");if(!e)return;const t=Ce();if(0===t.length)return void(e.innerHTML='<div class="mazemaster-empty-state">No minions. Add minions for use in the maze game.</div>');const n=we(),a=ze();e.innerHTML=t.map((e=>{const t=Ie(e),o=t.type||"messenger",i=t.battlebarProfiles||[],s=t.wheelProfiles||[],r=t.messages||[],l=t.encounterScript||"",c=t.merchantItemCount||{min:1,max:3},m=t.movement||{type:"stationary",patrolRadius:3,chaseRange:5,speed:1};return'\n            <div class="mazemaster-minion-card" data-id="'.concat($t(e),'">\n                <div class="minion-image">\n                    ').concat(t.imagePath?'<img src="'.concat($t(ie(t.imagePath)),'" alt="').concat($t(t.name),'">'):"",'\n                </div>\n                <div class="minion-info">\n                    <div class="minion-row">\n                        <input type="text" class="minion-name-input" value="').concat($t(t.name),'" placeholder="Minion name">\n                        <select class="minion-type-select">\n                            <option value="messenger" ').concat("messenger"===o?"selected":"",'>Messenger</option>\n                            <option value="battlebar" ').concat("battlebar"===o?"selected":"",'>Battlebar</option>\n                            <option value="prizewheel" ').concat("prizewheel"===o?"selected":"",'>PrizeWheel</option>\n                            <option value="merchant" ').concat("merchant"===o?"selected":"",'>Merchant</option>\n                        </select>\n                    </div>\n                    <div class="minion-profiles battlebar-profiles" style="display: ').concat("battlebar"===o?"block":"none",';">\n                        <label>Battlebar Profiles:</label>\n                        <select multiple class="minion-battlebar-select">\n                            ').concat(n.map((e=>'<option value="'.concat($t(e),'" ').concat(i.includes(e)?"selected":"",">").concat($t(e),"</option>"))).join(""),'\n                        </select>\n                    </div>\n                    <div class="minion-profiles wheel-profiles" style="display: ').concat("prizewheel"===o?"block":"none",';">\n                        <label>Wheel Profiles:</label>\n                        <select multiple class="minion-wheel-select">\n                            ').concat(a.map((e=>'<option value="'.concat($t(e),'" ').concat(s.includes(e)?"selected":"",">").concat($t(e),"</option>"))).join(""),'\n                        </select>\n                    </div>\n                    <div class="minion-profiles messenger-messages" style="display: ').concat("messenger"===o?"block":"none",';">\n                        <label>Messages (one per line):</label>\n                        <textarea class="minion-messages-input" rows="2" placeholder="Hello traveler!&#10;Beware the maze...">').concat($t(r.join("\n")),'</textarea>\n                    </div>\n                    <div class="minion-profiles merchant-settings" style="display: ').concat("merchant"===o?"block":"none",';">\n                        <label>Trade Items Required:</label>\n                        <div class="merchant-range-row">\n                            <input type="number" class="merchant-min-input mazemaster-input-small" min="1" max="10" value="').concat(c.min,'">\n                            <span>to</span>\n                            <input type="number" class="merchant-max-input mazemaster-input-small" min="1" max="10" value="').concat(c.max,'">\n                            <span>items for 1 Grandpow</span>\n                        </div>\n                    </div>\n                    <div class="minion-encounter-script">\n                        <label>Encounter Script (STScript):</label>\n                        <textarea class="minion-script-input" rows="2" placeholder="/echo Custom action on encounter...">').concat($t(l),'</textarea>\n                    </div>\n                    <div class="minion-movement-settings">\n                        <label>Maze Movement:</label>\n                        <div class="movement-row">\n                            <select class="minion-movement-type">\n                                <option value="stationary" ').concat("stationary"===m.type?"selected":"",'>Stationary</option>\n                                <option value="patrol" ').concat("patrol"===m.type?"selected":"",'>Patrol</option>\n                                <option value="chase" ').concat("chase"===m.type?"selected":"",'>Chase Player</option>\n                            </select>\n                        </div>\n                        <div class="movement-params" style="display: ').concat("stationary"!==m.type?"flex":"none",';">\n                            <div class="movement-param patrol-param" style="display: ').concat("patrol"===m.type?"flex":"none",';">\n                                <span>Radius:</span>\n                                <input type="number" class="minion-patrol-radius mazemaster-input-small" min="1" max="10" value="').concat(m.patrolRadius||3,'">\n                            </div>\n                            <div class="movement-param chase-param" style="display: ').concat("chase"===m.type?"flex":"none",';">\n                                <span>Range:</span>\n                                <input type="number" class="minion-chase-range mazemaster-input-small" min="1" max="20" value="').concat(m.chaseRange||5,'">\n                            </div>\n                            <div class="movement-param">\n                                <span>Speed:</span>\n                                <input type="number" class="minion-movement-speed mazemaster-input-small" min="1" max="5" value="').concat(m.speed||1,'" title="Moves every N player moves">\n                            </div>\n                        </div>\n                    </div>\n                </div>\n                <button class="menu_button menu_button_icon minion-delete-btn" title="Delete Minion">\n                    <i class="fa-solid fa-trash"></i>\n                </button>\n            </div>\n        ')})).join(""),e.querySelectorAll(".mazemaster-minion-card").forEach((e=>{const t=e.dataset.id,n=e.querySelector(".minion-name-input");n&&n.addEventListener("change",(()=>{const e=Ie(t);e&&(e.name=n.value.trim()||"Unknown",Te(t,e))}));const a=e.querySelector(".minion-type-select");a&&a.addEventListener("change",(()=>{const n=Ie(t);if(n){n.type=a.value,Te(t,n);const o=e.querySelector(".battlebar-profiles"),i=e.querySelector(".wheel-profiles"),s=e.querySelector(".messenger-messages"),r=e.querySelector(".merchant-settings");o&&(o.style.display="battlebar"===n.type?"block":"none"),i&&(i.style.display="prizewheel"===n.type?"block":"none"),s&&(s.style.display="messenger"===n.type?"block":"none"),r&&(r.style.display="merchant"===n.type?"block":"none")}}));const o=e.querySelector(".minion-battlebar-select");o&&o.addEventListener("change",(()=>{const e=Ie(t);e&&(e.battlebarProfiles=Array.from(o.selectedOptions).map((e=>e.value)),Te(t,e))}));const s=e.querySelector(".minion-wheel-select");s&&s.addEventListener("change",(()=>{const e=Ie(t);e&&(e.wheelProfiles=Array.from(s.selectedOptions).map((e=>e.value)),Te(t,e))}));const r=e.querySelector(".minion-messages-input");r&&r.addEventListener("change",(()=>{const e=Ie(t);e&&(e.messages=r.value.split("\n").filter((e=>e.trim())),Te(t,e))}));const l=e.querySelector(".merchant-min-input"),c=e.querySelector(".merchant-max-input");l&&l.addEventListener("change",(()=>{const e=Ie(t);e&&(e.merchantItemCount=e.merchantItemCount||{min:1,max:3},e.merchantItemCount.min=parseInt(l.value)||1,Te(t,e))})),c&&c.addEventListener("change",(()=>{const e=Ie(t);e&&(e.merchantItemCount=e.merchantItemCount||{min:1,max:3},e.merchantItemCount.max=parseInt(c.value)||3,Te(t,e))}));const m=e.querySelector(".minion-script-input");m&&m.addEventListener("change",(()=>{const e=Ie(t);e&&(e.encounterScript=m.value,Te(t,e))}));const d=e.querySelector(".minion-movement-type"),h=e.querySelector(".movement-params"),g=e.querySelector(".patrol-param"),f=e.querySelector(".chase-param"),v=e.querySelector(".minion-patrol-radius"),b=e.querySelector(".minion-chase-range"),y=e.querySelector(".minion-movement-speed");d&&d.addEventListener("change",(()=>{const e=Ie(t);e&&(e.movement=e.movement||{type:"stationary",patrolRadius:3,chaseRange:5,speed:1},e.movement.type=d.value,Te(t,e),h&&(h.style.display="stationary"!==d.value?"flex":"none"),g&&(g.style.display="patrol"===d.value?"flex":"none"),f&&(f.style.display="chase"===d.value?"flex":"none"))})),v&&v.addEventListener("change",(()=>{const e=Ie(t);e&&(e.movement=e.movement||{type:"patrol",patrolRadius:3,chaseRange:5,speed:1},e.movement.patrolRadius=parseInt(v.value)||3,Te(t,e))})),b&&b.addEventListener("change",(()=>{const e=Ie(t);e&&(e.movement=e.movement||{type:"chase",patrolRadius:3,chaseRange:5,speed:1},e.movement.chaseRange=parseInt(b.value)||5,Te(t,e))})),y&&y.addEventListener("change",(()=>{const e=Ie(t);e&&(e.movement=e.movement||{type:"stationary",patrolRadius:3,chaseRange:5,speed:1},e.movement.speed=parseInt(y.value)||1,Te(t,e))}));const z=e.querySelector(".minion-image");z&&(z.style.cursor="pointer",z.title="Click to change image",z.addEventListener("click",(()=>{const e=document.createElement("input");e.type="file",e.accept="image/*",e.style.display="none",document.body.appendChild(e),e.addEventListener("change",(async n=>{var a;const o=null===(a=n.target.files)||void 0===a?void 0:a[0];if(o){try{const e=await rn(o,t),n=Ie(t);n&&(n.imagePath=e,Te(t,n),ln())}catch(e){console.error("[MazeMaster] Image upload failed:",e),alert("Image upload failed: ".concat(e.message))}document.body.removeChild(e)}else document.body.removeChild(e)})),e.click()})));const x=e.querySelector(".minion-delete-btn");x&&x.addEventListener("click",(async()=>{const e=Ie(t);var n;await p('Delete minion "'.concat((null==e?void 0:e.name)||t,'"?'),u.CONFIRM)&&(n=t,delete de.minions[n],i(),ln())}))}))}function cn(){const e=document.getElementById("mazemaster_traps_list");if(!e)return;const t=Pe();0!==t.length?(e.innerHTML=t.map((e=>{const t=Be(e);return'\n            <div class="mazemaster-trap-card" data-id="'.concat($t(e),'">\n                <div class="trap-image">\n                    ').concat(t.imagePath?'<img src="'.concat($t(ie(t.imagePath)),'" alt="').concat($t(t.name),'">'):'<div class="trap-no-image"><i class="fa-solid fa-dungeon"></i></div>','\n                </div>\n                <div class="trap-info">\n                    <div class="trap-row">\n                        <input type="text" class="trap-name-input mazemaster-input" value="').concat($t(t.name),'" placeholder="Trap name">\n                    </div>\n                    <div class="trap-message-row">\n                        <label>Message:</label>\n                        <textarea class="trap-message-input" rows="2" placeholder="You triggered a trap!">').concat($t(t.message||""),'</textarea>\n                    </div>\n                    <div class="trap-script-row">\n                        <label>Script (STScript):</label>\n                        <textarea class="trap-script-input" rows="2" placeholder="/echo Trap triggered!">').concat($t(t.script||""),'</textarea>\n                    </div>\n                </div>\n                <button class="menu_button menu_button_icon trap-delete-btn" title="Delete Trap">\n                    <i class="fa-solid fa-trash"></i>\n                </button>\n            </div>\n        ')})).join(""),e.querySelectorAll(".mazemaster-trap-card").forEach((e=>{const t=e.dataset.id,n=e.querySelector(".trap-name-input");n&&n.addEventListener("change",(()=>{const e=Be(t);e&&(e.name=n.value.trim()||"Unknown Trap",Le(t,e))}));const a=e.querySelector(".trap-message-input");a&&a.addEventListener("change",(()=>{const e=Be(t);e&&(e.message=a.value,Le(t,e))}));const o=e.querySelector(".trap-script-input");o&&o.addEventListener("change",(()=>{const e=Be(t);e&&(e.script=o.value,Le(t,e))}));const s=e.querySelector(".trap-image");s&&(s.style.cursor="pointer",s.title="Click to change image",s.addEventListener("click",(()=>{const e=document.createElement("input");e.type="file",e.accept="image/*",e.style.display="none",document.body.appendChild(e),e.addEventListener("change",(async n=>{var a;const o=null===(a=n.target.files)||void 0===a?void 0:a[0];if(o){try{const e=await rn(o,t),n=Be(t);n&&(n.imagePath=e,Le(t,n),cn())}catch(e){console.error("[MazeMaster] Image upload failed:",e),alert("Image upload failed: ".concat(e.message))}document.body.removeChild(e)}else document.body.removeChild(e)})),e.click()})));const r=e.querySelector(".trap-delete-btn");r&&r.addEventListener("click",(async()=>{const e=Be(t);var n;await p('Delete trap "'.concat((null==e?void 0:e.name)||t,'"?'),u.CONFIRM)&&(n=t,delete de.traps[n],i(),cn())}))}))):e.innerHTML='<div class="mazemaster-empty-state">No traps. Add traps for use in maze profiles.</div>'}function mn(){let e;console.log("[MazeMaster] initUI called");try{e=Zt(),console.log("[MazeMaster] getPanelHtml succeeded")}catch(t){console.error("[MazeMaster] getPanelHtml FAILED:",t),e="<div>Error loading panel</div>"}const t=document.createElement("div");t.id="mazemaster-button",t.className="drawer",t.innerHTML='\n        <div class="drawer-toggle drawer-header">\n            <div class="drawer-icon fa-solid fa-dharmachakra fa-fw closedIcon" title="MazeMaster"></div>\n        </div>\n        <div id="mazemaster_drawer" class="drawer-content closedDrawer">\n            '.concat(e,"\n        </div>\n    ");const n=document.getElementById("extensions-settings-button");console.log("[MazeMaster] extensions-settings-button:",n),n?(n.after(t),console.log("[MazeMaster] Drawer inserted after extensions button")):console.error("[MazeMaster] extensions-settings-button NOT FOUND!");const a=t.querySelector(".drawer-toggle");if(a&&window.jQuery){const e=window.jQuery;e(a).on("click",(async function(){const t=e(this).find(".drawer-icon"),n=e(this).parent().find(".drawer-content");n.hasClass("openDrawer")||(e(".openDrawer:not(.pinnedOpen)").removeClass("openDrawer").addClass("closedDrawer"),e(".openIcon:not(.drawerPinnedOpen)").removeClass("openIcon").addClass("closedIcon")),t.toggleClass("openIcon closedIcon"),n.toggleClass("openDrawer closedDrawer")}))}gn(),Qt(),ln(),cn(),tn(),"battlebar"===de.activeGameConfig&&en()}function dn(){var e;const t=document.getElementById("mazemaster_maze_chest_percent");t&&(t.value="15");const n=document.getElementById("mazemaster_maze_encounters_list"),a=(null==n?void 0:n.querySelectorAll(".mazemaster-encounter-row"))||[],o={messenger:10,prizewheel:6,battlebar:4,merchant:1};let i=0;const s=[];a.forEach((e=>{const t=e.getAttribute("data-minion-id");if(!t)return;const n=Ie(t),a=(null==n?void 0:n.type)||"battlebar",r=o[a]||4;i+=r,s.push({row:e,type:a,weight:r})}));i>0&&s.forEach((e=>{let{row:t,weight:n}=e;const a=Math.round(n/i*60),o=t.querySelector(".encounter-percent-input");o&&(o.value=a)}));const r=document.getElementById("mazemaster_maze_traps_list"),l=(null==r?void 0:r.querySelectorAll(".mazemaster-encounter-row"))||[];if(l.length>0){const e=Math.floor(5/l.length);l.forEach((t=>{const n=t.querySelector(".encounter-percent-input");n&&(n.value=e||1)}))}const c=null===(e=document.getElementById("mazemaster_maze_profile_select"))||void 0===e?void 0:e.value;if(c){Ee(c,an()),loadMazeProfileSettings()}console.log("[MazeMaster] Intelligent Distribute applied: Chests 15%, Traps 5%, Minions distributed")}function pn(e){var n;const a=null===(n=de.savedMazes)||void 0===n?void 0:n[e];if(!a)return console.warn('[MazeMaster] No saved game for "'.concat(e,'"')),!1;const o=Me(e);if(!o)return console.error('[MazeMaster] Profile "'.concat(e,'" no longer exists')),!1;const i=a.totalFloors||1,s=a.currentFloor||0;let r;r=a.floors&&a.floors.length>0?a.floors.map((e=>e.map((e=>e.map((e=>({walls:e.walls,visited:e.visited,minion:e.minion,trap:e.trap,chest:e.chest,staircase:e.staircase,roomInfo:e.roomInfo}))))))):[a.grid.map((e=>e.map((e=>({walls:e.walls,visited:e.visited,minion:e.minion,trap:e.trap,chest:e.chest,staircase:e.staircase,roomInfo:e.roomInfo})))))];const l=r[s];let c={name:"The Maze",imagePath:"",message:"Find your way to the exit..."};const m=o.mainMinion?Ie(o.mainMinion):null;return m&&(c={name:m.name,imagePath:m.imagePath,message:"Continuing your journey..."}),he={isOpen:!0,profile:o,profileName:e,grid:l,size:a.size,playerX:a.playerX,playerY:a.playerY,exitX:a.exitX,exitY:a.exitY,visited:new Set(a.visited),isVictory:!1,currentMinion:c,isPaused:!1,pendingEncounter:null,exitEncounterDone:a.exitEncounterDone,pendingConfirmation:null,pendingChest:null,inventory:t({key:0,stealth:0,pow:0,grandpow:0,floorKey:0,portalStone:0,minionBane:0,mapFragment:0,timeShard:0,voidWalk:0},a.inventory),shownMilestones:new Set(a.shownMilestones||[]),currentFloor:s,totalFloors:i,floors:r,voidWalkActive:!1,messageLog:a.messageLog||[]},bt(),zt(),J(!1),wt(),_t(),Pt(),X(),U(),document.addEventListener("keydown",Mt,{capture:!0}),console.log('[MazeMaster] Loaded saved maze "'.concat(e,'" (floor ').concat(s+1,"/").concat(i,")")),!0}function un(e){var t;return!(null===(t=de.savedMazes)||void 0===t||!t[e])&&(delete de.savedMazes[e],i(),console.log('[MazeMaster] Deleted saved maze "'.concat(e,'"')),!0)}function hn(){const e=["mazemaster_saved_games_list","mazemaster_game_tab_saves"],t=Object.keys(de.savedMazes||{});for(const n of e){const e=document.getElementById(n);e&&(0!==t.length?(e.innerHTML=t.map((e=>{const t=de.savedMazes[e],n=new Date(t.timestamp),a=t.visited?Math.round(t.visited.length/(t.size*t.size)*100):0;return'\n                <div class="mazemaster-saved-game" data-profile="'.concat($t(e),'">\n                    <div class="mazemaster-saved-game-info">\n                        <div class="mazemaster-saved-game-name">').concat($t(e),'</div>\n                        <div class="mazemaster-saved-game-details">').concat(a,"% explored - ").concat(n.toLocaleDateString(),'</div>\n                    </div>\n                    <div class="mazemaster-saved-game-actions">\n                        <button class="menu_button menu_button_icon saved-game-load" title="Resume">\n                            <i class="fa-solid fa-play"></i>\n                        </button>\n                        <button class="menu_button menu_button_icon saved-game-delete" title="Delete">\n                            <i class="fa-solid fa-trash"></i>\n                        </button>\n                    </div>\n                </div>\n            ')})).join(""),e.querySelectorAll(".mazemaster-saved-game").forEach((e=>{var t,n;const a=e.dataset.profile;null===(t=e.querySelector(".saved-game-load"))||void 0===t||t.addEventListener("click",(()=>{pn(a)})),null===(n=e.querySelector(".saved-game-delete"))||void 0===n||n.addEventListener("click",(async()=>{await p('Delete saved game "'.concat(a,'"?'),u.CONFIRM)&&(un(a),hn())}))}))):e.innerHTML='<div class="mazemaster-no-saves">No saved games</div>')}}function gn(){const e=document.getElementById("mazemaster_profile_select");e&&e.addEventListener("change",(e=>{de.currentProfile=e.target.value,i(),function(){var e;const t=xe(null===(e=document.getElementById("mazemaster_profile_select"))||void 0===e?void 0:e.value),n=document.getElementById("mazemaster_randomize");n&&(n.checked=(null==t?void 0:t.randomize)||!1);const a=document.getElementById("mazemaster_difficulty");a&&(a.value=(null==t?void 0:t.difficulty)||1)}(),Qt()}));const t=document.getElementById("mazemaster_new_profile_btn");t&&t.addEventListener("click",(async e=>{e.preventDefault(),e.stopPropagation();const t=await p("Enter new wheel profile name:",u.INPUT,"");if(t&&t.trim()){const e=t.trim();de.profiles[e]?await p('Profile "'.concat(e,'" already exists.'),u.TEXT):(de.profiles[e]={segments:[],randomize:!1,difficulty:1},de.currentProfile=e,i(),fn())}}));const n=document.getElementById("mazemaster_delete_profile_btn");n&&n.addEventListener("click",(async()=>{var e;const t=null===(e=document.getElementById("mazemaster_profile_select"))||void 0===e?void 0:e.value;if(t){await p('Delete wheel profile "'.concat(t,'"?'),u.CONFIRM)&&(!function(e){if(delete de.profiles[e],de.currentProfile===e){const e=ze();de.currentProfile=e[0]||"default"}i()}(t),fn())}}));const a=document.getElementById("mazemaster_rename_profile_btn");a&&a.addEventListener("click",(async()=>{var e;const t=null===(e=document.getElementById("mazemaster_profile_select"))||void 0===e?void 0:e.value;if(!t)return void alert("No profile selected to rename");const n=await p("Enter new profile name:",u.INPUT,t);if(n&&n.trim()&&n.trim()!==t){const e=n.trim();if(de.profiles[e])return void alert("A profile with that name already exists");de.profiles[e]=de.profiles[t],delete de.profiles[t],de.currentProfile=e,i(),fn()}}));const o=document.getElementById("mazemaster_export_btn");o&&o.addEventListener("click",(()=>{var e;const t=null===(e=document.getElementById("mazemaster_profile_select"))||void 0===e?void 0:e.value;t?function(e){const t=xe(e);if(!t)return void alert('Profile "'.concat(e,'" not found'));const n={name:e,profile:t,exportedAt:(new Date).toISOString(),version:"1.0"},a=JSON.stringify(n,null,2),o=new Blob([a],{type:"application/json"}),i=URL.createObjectURL(o),s=document.createElement("a");s.href=i,s.download="mazemaster-".concat(e,".json"),document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(i),console.log('[MazeMaster] Exported profile "'.concat(e,'"'))}(t):alert("No profile selected to export")}));const s=document.getElementById("mazemaster_import_btn"),r=document.getElementById("mazemaster_import_file");s&&r&&(s.addEventListener("click",(()=>{r.click()})),r.addEventListener("change",(async e=>{var t;const n=null===(t=e.target.files)||void 0===t?void 0:t[0];if(n){try{const e=await function(e){return new Promise(((t,n)=>{const a=new FileReader;a.onload=e=>{try{const a=JSON.parse(e.target.result);if(!a.profile||!a.name)return void n(new Error("Invalid profile format: missing name or profile data"));let o=a.name;if(de.profiles[o]){const e=prompt('Profile "'.concat(o,'" already exists. Enter a new name:'),"".concat(o,"_imported"));if(!e||!e.trim())return void n(new Error("Import cancelled"));o=e.trim()}const s=a.profile;s.segments&&Array.isArray(s.segments)||(s.segments=[]),"boolean"!=typeof s.randomize&&(s.randomize=!1),("number"!=typeof s.difficulty||s.difficulty<1||s.difficulty>5)&&(s.difficulty=1),de.profiles[o]=s,de.currentProfile=o,i(),console.log('[MazeMaster] Imported profile "'.concat(o,'":'),s),t(o)}catch(e){n(new Error("Failed to parse JSON: ".concat(e.message)))}},a.onerror=()=>n(new Error("Failed to read file")),a.readAsText(e)}))}(n);alert('Profile "'.concat(e,'" imported successfully!')),fn()}catch(e){alert("Import failed: ".concat(e.message))}r.value=""}})));const l=document.getElementById("mazemaster_add_segment_btn");l&&l.addEventListener("click",(()=>{const e=document.getElementById("mazemaster_segments_list");if(!e)return;const t=e.querySelector(".mazemaster-empty-state");t&&t.remove();const n=e.querySelectorAll(".mazemaster-segment-item").length,a=document.createElement("div");a.className="mazemaster-segment-item",a.dataset.index=n,a.innerHTML='\n                <div class="mazemaster-segment-row">\n                    <div class="mazemaster-segment-field small">\n                        <label>Trigger</label>\n                        <input type="text" class="seg-trigger" value="com'.concat(n+1,'" placeholder="com1">\n                    </div>\n                    <div class="mazemaster-segment-field">\n                        <label>Display Text</label>\n                        <input type="text" class="seg-text" value="" placeholder="Prize name">\n                    </div>\n                    <div class="mazemaster-segment-field small">\n                        <label>Size</label>\n                        <select class="seg-size">\n                            ').concat(y.map((e=>'<option value="'.concat(e,'" ').concat("fraction"===e?"selected":"",">").concat(e,"</option>"))).join(""),'\n                        </select>\n                    </div>\n                    <button class="menu_button menu_button_icon mazemaster-segment-delete" title="Delete">\n                        <i class="fa-solid fa-trash"></i>\n                    </button>\n                </div>\n                <div class="mazemaster-segment-row">\n                    <div class="mazemaster-segment-field">\n                        <label>STScript Command</label>\n                        <textarea class="seg-command" placeholder="/echo You won!"></textarea>\n                    </div>\n                    <div class="mazemaster-segment-field tiny">\n                        <label>&nbsp;</label>\n                        <label class="mazemaster-segment-checkbox">\n                            <input type="checkbox" class="seg-respin">\n                            Respin\n                        </label>\n                    </div>\n                </div>\n            '),a.querySelector(".mazemaster-segment-delete").addEventListener("click",(()=>{a.remove()})),e.appendChild(a)}));const c=document.getElementById("mazemaster_save_btn");c&&c.addEventListener("click",(()=>{var e,t,n;const a=null===(e=document.getElementById("mazemaster_profile_select"))||void 0===e?void 0:e.value;if(!a)return void alert("Please create a profile first");const o=function(){const e=document.querySelectorAll(".mazemaster-segment-item"),t=[];return e.forEach((e=>{const n=e.querySelector(".seg-trigger").value.trim(),a=e.querySelector(".seg-text").value.trim(),o=e.querySelector(".seg-command").value.trim(),i=e.querySelector(".seg-size").value,s=e.querySelector(".seg-respin").checked;(n||a)&&t.push({trigger:n,text:a,command:o,size:i,respin:s})})),t}(),s=(null===(t=document.getElementById("mazemaster_randomize"))||void 0===t?void 0:t.checked)||!1,r=parseInt(null===(n=document.getElementById("mazemaster_difficulty"))||void 0===n?void 0:n.value)||1;if(0===o.length)return void alert("Error: Wheel must have at least one segment");const l=o.filter((e=>"halfseg"===e.size)).length,c=o.filter((e=>"doubleseg"===e.size)).length;l===c?(!function(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;de.profiles[e]={segments:t,randomize:n,difficulty:a},i(),console.log("[MazeMaster] Profile saved:",e,de.profiles[e])}(a,o,s,r),console.log('[MazeMaster] Saved profile "'.concat(a,'":'),{segments:o,randomize:s,difficulty:r}),alert('Profile "'.concat(a,'" saved!'))):alert("Error: Wheel unbalanced!\n\n".concat(l," halfseg(s) ≠ ").concat(c," doubleseg(s)\n\nFor every halfseg, you need a doubleseg to balance the wheel."))}));const h=document.getElementById("mazemaster_preview_wheel_btn");h&&h.addEventListener("click",(()=>{var e;const t=null===(e=document.getElementById("mazemaster_profile_select"))||void 0===e?void 0:e.value;if(!t)return void alert("Please select or create a wheel profile first");const n=je(t);if(n.error)return void alert("Error: ".concat(n.error));const a=Oe();a.valid?De():alert("Error: ".concat(a.error))}));const f=document.getElementById("mazemaster_preview_battlebar_btn");f&&f.addEventListener("click",(()=>{var e;const t=null===(e=document.getElementById("mazemaster_bb_profile_select"))||void 0===e?void 0:e.value;if(!t)return void alert("Please select or create a battlebar profile first");const n=Ne(t);n.error&&alert("Error: ".concat(n.error))}));const v=document.getElementById("mazemaster_show_wheel"),b=document.getElementById("mazemaster_show_battlebar"),z=document.getElementById("mazemaster_show_maze"),x=document.getElementById("mazemaster_show_minions"),w=document.getElementById("mazemaster_show_traps"),_=document.getElementById("mazemaster_wheel_config"),S=document.getElementById("mazemaster_battlebar_config"),k=document.getElementById("mazemaster_maze_config"),M=document.getElementById("mazemaster_minions_config"),E=document.getElementById("mazemaster_traps_config");function C(e){de.activeGameConfig=e,i(),null==v||v.classList.toggle("active","wheel"===e),null==b||b.classList.toggle("active","battlebar"===e),null==z||z.classList.toggle("active","maze"===e),null==x||x.classList.toggle("active","minions"===e),null==w||w.classList.toggle("active","traps"===e),_&&(_.style.display="wheel"===e?"block":"none"),S&&(S.style.display="battlebar"===e?"block":"none"),k&&(k.style.display="maze"===e?"block":"none"),M&&(M.style.display="minions"===e?"block":"none"),E&&(E.style.display="traps"===e?"block":"none"),"battlebar"===e&&en(),"minions"===e&&ln(),"traps"===e&&cn()}v&&v.addEventListener("click",(()=>C("wheel"))),b&&b.addEventListener("click",(()=>C("battlebar"))),z&&z.addEventListener("click",(()=>C("maze"))),x&&x.addEventListener("click",(()=>C("minions"))),w&&w.addEventListener("click",(()=>C("traps")));const I=document.querySelectorAll(".mazemaster-tab"),P=document.querySelectorAll(".mazemaster-tab-content");I.forEach((e=>{e.addEventListener("click",(()=>{const t=e.dataset.tab;I.forEach((t=>t.classList.toggle("active",t===e))),P.forEach((e=>{const n=e.id==="mazemaster-tab-".concat(t);e.classList.toggle("active",n)}))}))}));const L=document.getElementById("mazemaster_play_maze");L&&L.addEventListener("click",(async()=>{const e=document.getElementById("mazemaster_play_profile"),t=(null==e?void 0:e.value)||de.currentMazeProfile||"default";try{await m("/closechat")}catch(e){console.log("[MazeMaster] No active chat to close")}vt(t)})),function(){const e=document.getElementById("mazemaster_llm_preset");if(e){e.innerHTML='<option value="">(Use Current)</option>';try{if("function"==typeof g){const t=g();if(t&&"function"==typeof t.getAllPresets){const n=t.getAllPresets();n.forEach((t=>{const n=document.createElement("option");n.value=t,n.textContent=t,t===de.llmPreset&&(n.selected=!0),e.appendChild(n)})),console.log("[MazeMaster] Populated LLM preset dropdown with ".concat(n.length," presets"))}}}catch(e){console.warn("[MazeMaster] Could not populate LLM presets:",e)}}}();const j=document.getElementById("mazemaster_llm_preset");j&&j.addEventListener("change",(e=>{de.llmPreset=e.target.value,i()}));const O=document.getElementById("mazemaster_llm_enabled");O&&O.addEventListener("change",(e=>{de.llmEnabled=e.target.checked,i()}));const A=document.getElementById("mazemaster_dpad_enabled");A&&A.addEventListener("change",(e=>{de.dpadConfig||(de.dpadConfig={enabled:!0,floating:!0,position:{x:null,y:null}}),de.dpadConfig.enabled=e.target.checked,i()}));const D=document.getElementById("mazemaster_dpad_floating");D&&D.addEventListener("change",(e=>{de.dpadConfig||(de.dpadConfig={enabled:!0,floating:!0,position:{x:null,y:null}}),de.dpadConfig.floating=e.target.checked,i()}));const R=document.getElementById("mazemaster_dpad_reset");R&&R.addEventListener("click",(()=>{de.dpadConfig||(de.dpadConfig={enabled:!0,floating:!0,position:{x:null,y:null}}),de.dpadConfig.position={x:null,y:null},i();const e=document.getElementById("maze_dpad");e&&(e.style.left="",e.style.top="",e.style.right="20px",e.style.bottom="20px")}));const F=document.getElementById("mazemaster_renderer_type");F&&F.addEventListener("change",(e=>{de.rendererType=e.target.value,T.getRenderer(e.target.value),i()}));const N=document.getElementById("mazemaster_layout_mode");N&&N.addEventListener("change",(e=>{de.layoutMode=e.target.value,i(),B()}));const W=document.getElementById("mazemaster_bb_profile_select");W&&W.addEventListener("change",(e=>{de.currentBattlebarProfile=e.target.value,i(),function(){var e;const t=_e(null===(e=document.getElementById("mazemaster_bb_profile_select"))||void 0===e?void 0:e.value)||{},n=document.getElementById("mazemaster_bb_difficulty");n&&(n.value=t.difficulty||3);const a=document.getElementById("mazemaster_bb_hits");a&&(a.value=t.hitsToWin||5);const o=document.getElementById("mazemaster_bb_misses");o&&(o.value=t.missesToLose||3);const i=document.getElementById("mazemaster_bb_hit_cmd");i&&(i.value=t.hitCommand||"");const s=document.getElementById("mazemaster_bb_miss_cmd");s&&(s.value=t.missCommand||"");const r=document.getElementById("mazemaster_bb_win_cmd");r&&(r.value=t.winCommand||"");const l=document.getElementById("mazemaster_bb_lose_cmd");l&&(l.value=t.loseCommand||"");const c=document.getElementById("mazemaster_bb_main_title");c&&(c.value=t.mainTitle||"")}(),en()}));const q=document.getElementById("mazemaster_bb_new_profile_btn");q&&q.addEventListener("click",(async e=>{e.preventDefault(),e.stopPropagation();const t=await p("Enter new battlebar profile name:",u.INPUT,"");if(t&&t.trim()){const e=t.trim();de.battlebarProfiles[e]?await p('Battlebar profile "'.concat(e,'" already exists.'),u.TEXT):(Se(e,{}),de.currentBattlebarProfile=e,i(),fn(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_battlebar"))||void 0===e||e.click()}),100))}}));const H=document.getElementById("mazemaster_bb_delete_profile_btn");H&&H.addEventListener("click",(async()=>{var e;const t=null===(e=document.getElementById("mazemaster_bb_profile_select"))||void 0===e?void 0:e.value;if(t){await p('Delete battlebar profile "'.concat(t,'"?'),u.CONFIRM)&&(!function(e){if(delete de.battlebarProfiles[e],de.currentBattlebarProfile===e){const e=we();de.currentBattlebarProfile=e[0]||"default"}i()}(t),fn(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_battlebar"))||void 0===e||e.click()}),100))}}));const G=document.getElementById("mazemaster_bb_rename_profile_btn");G&&G.addEventListener("click",(async()=>{var e;const t=null===(e=document.getElementById("mazemaster_bb_profile_select"))||void 0===e?void 0:e.value;if(!t)return void alert("No profile selected to rename");const n=await p("Enter new profile name:",u.INPUT,t);if(n&&n.trim()&&n.trim()!==t){const e=n.trim();if(de.battlebarProfiles[e])return void alert("A profile with that name already exists");de.battlebarProfiles[e]=de.battlebarProfiles[t],delete de.battlebarProfiles[t],de.currentBattlebarProfile=e,i(),fn(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_battlebar"))||void 0===e||e.click()}),100)}}));const Y=document.getElementById("mazemaster_bb_export_btn");Y&&Y.addEventListener("click",(()=>{var e;const t=null===(e=document.getElementById("mazemaster_bb_profile_select"))||void 0===e?void 0:e.value;t?function(e){const t=_e(e);if(!t)return void alert('Battlebar profile "'.concat(e,'" not found'));const n={name:e,type:"battlebar",profile:t,exportedAt:(new Date).toISOString(),version:"1.0"},a=JSON.stringify(n,null,2),o=new Blob([a],{type:"application/json"}),i=URL.createObjectURL(o),s=document.createElement("a");s.href=i,s.download="mazemaster-battlebar-".concat(e,".json"),document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(i),console.log('[MazeMaster] Exported battlebar profile "'.concat(e,'"'))}(t):alert("No profile selected to export")}));const U=document.getElementById("mazemaster_bb_import_btn"),K=document.getElementById("mazemaster_bb_import_file");U&&K&&(U.addEventListener("click",(()=>{K.click()})),K.addEventListener("change",(async e=>{var t;const n=null===(t=e.target.files)||void 0===t?void 0:t[0];if(n){try{var a;const e=await function(e){return new Promise(((t,n)=>{const a=new FileReader;a.onload=e=>{try{const a=JSON.parse(e.target.result);if(!a.profile||!a.name)return void n(new Error("Invalid profile format: missing name or profile data"));let o=a.name;if(de.battlebarProfiles[o]){const e=prompt('Battlebar profile "'.concat(o,'" already exists. Enter a new name:'),"".concat(o,"_imported"));if(!e||!e.trim())return void n(new Error("Import cancelled"));o=e.trim()}Se(o,a.profile),de.currentBattlebarProfile=o,i(),console.log('[MazeMaster] Imported battlebar profile "'.concat(o,'":'),a.profile),t(o)}catch(e){n(new Error("Failed to parse JSON: ".concat(e.message)))}},a.onerror=()=>n(new Error("Failed to read file")),a.readAsText(e)}))}(n);alert('Battlebar profile "'.concat(e,'" imported successfully!')),fn(),null===(a=document.getElementById("mazemaster_show_battlebar"))||void 0===a||a.click()}catch(e){alert("Import failed: ".concat(e.message))}K.value=""}})));const X=document.getElementById("mazemaster_bb_save_btn");X&&X.addEventListener("click",(()=>{var e;const t=null===(e=document.getElementById("mazemaster_bb_profile_select"))||void 0===e?void 0:e.value;if(!t)return void alert("Please create a battlebar profile first");const n=function(){var e,t,n,a,o,i,s,r,l,c,m,d,p,u,h;const g=_e(null===(e=document.getElementById("mazemaster_bb_profile_select"))||void 0===e?void 0:e.value)||{};return{difficulty:parseInt(null===(t=document.getElementById("mazemaster_bb_difficulty"))||void 0===t?void 0:t.value)||3,hitsToWin:parseInt(null===(n=document.getElementById("mazemaster_bb_hits"))||void 0===n?void 0:n.value)||5,missesToLose:parseInt(null===(a=document.getElementById("mazemaster_bb_misses"))||void 0===a?void 0:a.value)||3,mainTitle:(null===(o=document.getElementById("mazemaster_bb_main_title"))||void 0===o?void 0:o.value)||"",hitCommand:(null===(i=document.getElementById("mazemaster_bb_hit_cmd"))||void 0===i?void 0:i.value)||"",missCommand:(null===(s=document.getElementById("mazemaster_bb_miss_cmd"))||void 0===s?void 0:s.value)||"",winCommand:(null===(r=document.getElementById("mazemaster_bb_win_cmd"))||void 0===r?void 0:r.value)||"",loseCommand:(null===(l=document.getElementById("mazemaster_bb_lose_cmd"))||void 0===l?void 0:l.value)||"",images:g.images||[],keyDropChance:null!==(c=parseInt(null===(m=document.getElementById("mazemaster_bb_key_drop"))||void 0===m?void 0:m.value))&&void 0!==c?c:40,powDropChance:null!==(d=parseInt(null===(p=document.getElementById("mazemaster_bb_pow_drop"))||void 0===p?void 0:p.value))&&void 0!==d?d:20,stealthDropChance:null!==(u=parseInt(null===(h=document.getElementById("mazemaster_bb_stealth_drop"))||void 0===h?void 0:h.value))&&void 0!==u?u:10}}(),a=[];(!n.hitsToWin||n.hitsToWin<1)&&a.push("Hits to Win must be at least 1"),(!n.missesToLose||n.missesToLose<1)&&a.push("Misses to Lose must be at least 1"),(!n.difficulty||n.difficulty<1||n.difficulty>5)&&a.push("Difficulty must be between 1 and 5"),a.length>0?alert("Validation Error:\n\n"+a.join("\n")):(Se(t,n),alert('Battlebar profile "'.concat(t,'" saved!')))}));const V=document.getElementById("mazemaster_bb_add_image_btn"),J=document.getElementById("mazemaster_bb_image_file");V&&J&&(V.addEventListener("click",(()=>{J.click()})),J.addEventListener("change",(async e=>{var t,n;const a=null===(t=e.target.files)||void 0===t?void 0:t[0];if(!a)return;const o=null===(n=document.getElementById("mazemaster_bb_profile_select"))||void 0===n?void 0:n.value;if(!o)return alert("Please create a profile first"),void(J.value="");try{const e=await async function(e,t){return new Promise(((n,a)=>{const o=new FileReader;o.onload=async o=>{try{const i=o.target.result.split(",")[1],s=e.name.split(".").pop().toLowerCase(),r=Date.now(),l="battlebar_".concat(t,"_").concat(r),c=await fetch("/api/images/upload",{method:"POST",headers:d(),body:JSON.stringify({image:i,ch_name:"MazeMaster",filename:l,format:s})});if(c.ok)n("user/images/MazeMaster/".concat(l,".").concat(s));else{const e=await c.json().catch((()=>({})));a(new Error(e.error||"Upload failed"))}}catch(e){a(e)}},o.onerror=()=>a(new Error("Failed to read file")),o.readAsDataURL(e)}))}(a,o),t=_e(o)||{},n=t.images||[];n.push({path:e,name:a.name}),t.images=n,Se(o,t),en()}catch(e){alert("Image upload failed: ".concat(e.message))}J.value=""})));const Z=document.getElementById("mazemaster_maze_profile_select");Z&&Z.addEventListener("change",(e=>{de.currentMazeProfile=e.target.value,i(),tn()}));const Q=document.getElementById("mazemaster_maze_new_profile_btn");Q&&Q.addEventListener("click",(async e=>{e.preventDefault(),e.stopPropagation();const t=await p("Enter new maze profile name:",u.INPUT,"");if(t&&t.trim()){const e=t.trim();de.mazeProfiles[e]?await p('Maze profile "'.concat(e,'" already exists.'),u.TEXT):(Ee(e,{gridSize:10}),de.currentMazeProfile=e,i(),fn(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_maze"))||void 0===e||e.click()}),100))}}));const $=document.getElementById("mazemaster_maze_delete_profile_btn");$&&$.addEventListener("click",(async()=>{var e;const t=null===(e=document.getElementById("mazemaster_maze_profile_select"))||void 0===e?void 0:e.value;if(t){await p('Delete maze profile "'.concat(t,'"?'),u.CONFIRM)&&(!function(e){if(delete de.mazeProfiles[e],de.currentMazeProfile===e){const e=ke();de.currentMazeProfile=e[0]||"default"}i()}(t),fn(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_maze"))||void 0===e||e.click()}),100))}}));const ee=document.getElementById("mazemaster_maze_rename_profile_btn");ee&&ee.addEventListener("click",(async()=>{var e;const t=null===(e=document.getElementById("mazemaster_maze_profile_select"))||void 0===e?void 0:e.value;if(!t)return void alert("No profile selected to rename");const n=await p("Enter new profile name:",u.INPUT,t);if(n&&n.trim()&&n.trim()!==t){const e=n.trim();if(de.mazeProfiles[e])return void alert("A profile with that name already exists");de.mazeProfiles[e]=de.mazeProfiles[t],delete de.mazeProfiles[t],de.currentMazeProfile=e,i(),fn(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_maze"))||void 0===e||e.click()}),100)}}));const te=document.getElementById("mazemaster_maze_save_btn");te&&te.addEventListener("click",(()=>{var e;const t=null===(e=document.getElementById("mazemaster_maze_profile_select"))||void 0===e?void 0:e.value;if(!t)return void alert("Please create a maze profile first");const n=an(),a=[];if((!n.gridSize||n.gridSize<5||n.gridSize>20)&&a.push("Grid Size must be between 5 and 20"),n.minionEncounters&&n.minionEncounters.length>0){const e=n.minionEncounters.reduce(((e,t)=>e+(t.percent||0)),0);e>100&&a.push("Encounter percentages total ".concat(e,"% (max 100%)"))}a.length>0?alert("Validation Error:\n\n"+a.join("\n")):(Ee(t,n),alert('Maze profile "'.concat(t,'" saved!')))}));const ne=document.getElementById("mazemaster_maze_story_btn");ne&&ne.addEventListener("click",(()=>{!async function(){var e,t,n,a;const o=null===(e=document.getElementById("mazemaster_maze_profile_select"))||void 0===e?void 0:e.value;if(!o)return void alert("Please create a maze profile first");const i=Me(o)||{},s=i.storyConfig||{mainStory:"",milestones:[]},r='\n        <div id="mazemaster_story_modal" class="mazemaster-story-modal">\n            <div class="mazemaster-story-modal-content">\n                <h3><i class="fa-solid fa-book"></i> Story Milestones</h3>\n\n                <div class="mazemaster-section">\n                    <label class="mazemaster-label">Main Story</label>\n                    <textarea id="story_main_text" class="mazemaster-story-textarea" rows="4"\n                        placeholder="The maze stretches before you, filled with danger and mystery...">'.concat($t(s.mainStory||""),'</textarea>\n                </div>\n\n                <div class="mazemaster-section">\n                    <label class="mazemaster-label">Milestones</label>\n                    <div id="story_milestones_list" class="mazemaster-milestones-list">\n                        \x3c!-- Milestones rendered here --\x3e\n                    </div>\n                    <button id="story_add_milestone_btn" class="menu_button mazemaster-add-btn">\n                        <i class="fa-solid fa-plus"></i> Add Milestone\n                    </button>\n                </div>\n\n                <div class="mazemaster-story-modal-buttons">\n                    <button id="story_save_btn" class="menu_button menu_button_primary">\n                        <i class="fa-solid fa-save"></i> Save\n                    </button>\n                    <button id="story_cancel_btn" class="menu_button">\n                        Cancel\n                    </button>\n                </div>\n            </div>\n        </div>\n    '),l=document.createElement("div");l.innerHTML=r,document.body.appendChild(l.firstElementChild);const c=document.getElementById("mazemaster_story_modal"),m=document.getElementById("story_milestones_list");function d(){0!==s.milestones.length?(m.innerHTML=s.milestones.map(((e,t)=>'\n            <div class="mazemaster-milestone-row" data-index="'.concat(t,'">\n                <div class="milestone-percent">\n                    <input type="number" class="milestone-percent-input" min="1" max="99" value="').concat(e.percent||25,'" placeholder="%">\n                    <span>%</span>\n                </div>\n                <textarea class="milestone-text-input" rows="2" placeholder="Story update at this point...">').concat($t(e.storyUpdate||""),'</textarea>\n                <button class="menu_button menu_button_icon milestone-remove-btn" title="Remove">\n                    <i class="fa-solid fa-trash"></i>\n                </button>\n            </div>\n        '))).join(""),m.querySelectorAll(".milestone-remove-btn").forEach((e=>{e.addEventListener("click",(e=>{const t=e.target.closest(".mazemaster-milestone-row"),n=parseInt(t.dataset.index);s.milestones.splice(n,1),d()}))}))):m.innerHTML='<div class="mazemaster-empty-state">No milestones. Add milestones to show story updates at specific progress points.</div>'}d(),null===(t=document.getElementById("story_add_milestone_btn"))||void 0===t||t.addEventListener("click",(()=>{s.milestones.push({percent:50,storyUpdate:""}),d()})),null===(n=document.getElementById("story_save_btn"))||void 0===n||n.addEventListener("click",(()=>{var e;s.mainStory=(null===(e=document.getElementById("story_main_text"))||void 0===e?void 0:e.value)||"";const t=m.querySelectorAll(".mazemaster-milestone-row");s.milestones=[],t.forEach((e=>{var t,n;const a=parseInt(null===(t=e.querySelector(".milestone-percent-input"))||void 0===t?void 0:t.value)||25,o=(null===(n=e.querySelector(".milestone-text-input"))||void 0===n?void 0:n.value)||"";o.trim()&&s.milestones.push({percent:a,storyUpdate:o})})),s.milestones.sort(((e,t)=>e.percent-t.percent)),i.storyConfig=s,Ee(o,i),c.remove(),alert("Story milestones saved!")})),null===(a=document.getElementById("story_cancel_btn"))||void 0===a||a.addEventListener("click",(()=>{c.remove()})),c.addEventListener("click",(e=>{e.target===c&&c.remove()}))}()})),document.querySelectorAll(".mazemaster-collapsible-header").forEach((e=>{e.addEventListener("click",(()=>{const t=e.getAttribute("data-target"),n=document.getElementById(t),a=e.closest(".mazemaster-collapsible");if(n){const e="none"!==n.style.display;n.style.display=e?"none":"block",null==a||a.classList.toggle("expanded",!e)}}))})),hn();const ae=document.getElementById("mazemaster_intelligent_distribute");ae&&ae.addEventListener("click",dn);const oe=document.getElementById("mazemaster_maze_win_image_btn"),ie=document.getElementById("mazemaster_maze_win_image_file");oe&&ie&&(oe.addEventListener("click",(()=>{ie.click()})),ie.addEventListener("change",(async e=>{var t,n;const a=null===(t=e.target.files)||void 0===t?void 0:t[0];if(!a)return;const o=null===(n=document.getElementById("mazemaster_maze_profile_select"))||void 0===n?void 0:n.value;if(!o)return alert("Please create a profile first"),void(ie.value="");try{const e=await rn(a,"maze_win_".concat(o)),t=Me(o)||{};t.winImage=e,Ee(o,t);const n=document.querySelector(".mazemaster-maze-win-image-preview");n&&(n.innerHTML='<img id="maze_win_image_preview" src="'.concat(e,'" alt="Victory">'))}catch(e){alert("Image upload failed: ".concat(e.message))}ie.value=""})));const se=document.getElementById("mazemaster_chest_image_btn"),re=document.getElementById("mazemaster_chest_image_file");se&&re&&(se.addEventListener("click",(()=>{re.click()})),re.addEventListener("change",(async e=>{var t,n;const a=null===(t=e.target.files)||void 0===t?void 0:t[0];if(!a)return;const o=null===(n=document.getElementById("mazemaster_maze_profile_select"))||void 0===n?void 0:n.value;if(!o)return alert("Please create a profile first"),void(re.value="");try{const e=await rn(a,"chest_".concat(o)),t=Me(o);if(t){t.chestImage=e,Ee(o,t);const n=document.querySelector(".mazemaster-chest-preview");n&&(n.innerHTML='<img id="mazemaster_chest_preview_img" src="'.concat(e,'" style="width: 100%; height: 100%; object-fit: cover;">'))}}catch(e){alert("Image upload failed: ".concat(e.message))}re.value=""})));const le=document.getElementById("mazemaster_maze_main_minion");le&&le.addEventListener("change",(e=>{const t=document.getElementById("mazemaster_main_minion_settings");t&&(t.style.display=e.target.value?"":"none")}));const ce=document.getElementById("mazemaster_maze_exit_type");ce&&ce.addEventListener("change",(()=>{nn(ce.value,"")}));const me=document.getElementById("mazemaster_add_portal_btn");function pe(){var e;const t=document.getElementById("mazemaster_portals_list"),n=null===(e=document.querySelector('[data-target="portals_section"]'))||void 0===e||null===(e=e.closest(".mazemaster-collapsible"))||void 0===e?void 0:e.querySelector(".mazemaster-collapse-hint");t&&n&&(n.textContent="(".concat(t.children.length," portal pairs)"))}me&&me.addEventListener("click",(()=>{const e=document.getElementById("mazemaster_portals_list");if(!e)return;const t=e.children.length,n=document.createElement("div");n.className="mazemaster-portal-item",n.dataset.portalIndex=t,n.innerHTML='\n                <div class="portal-header">\n                    <span class="portal-color" style="background: #9b59b6"></span>\n                    <span class="portal-name">Portal '.concat(t+1,'</span>\n                    <button class="menu_button remove-portal-btn" title="Remove Portal">\n                        <i class="fa-solid fa-trash"></i>\n                    </button>\n                </div>\n                <div class="portal-details">\n                    <div class="portal-row">\n                        <label>ID:</label>\n                        <input type="text" class="portal-id mazemaster-input" value="" placeholder="portal').concat(t+1,'">\n                    </div>\n                    <div class="portal-row">\n                        <label>Color:</label>\n                        <input type="color" class="portal-color-input" value="#9b59b6">\n                    </div>\n                    <div class="portal-row">\n                        <label>Bidirectional:</label>\n                        <input type="checkbox" class="portal-bidirectional" checked>\n                    </div>\n                    <div class="portal-row coords-row">\n                        <span>Start: X</span>\n                        <input type="number" class="portal-start-x mazemaster-input" value="" placeholder="auto" min="0">\n                        <span>Y</span>\n                        <input type="number" class="portal-start-y mazemaster-input" value="" placeholder="auto" min="0">\n                    </div>\n                    <div class="portal-row coords-row">\n                        <span>End: X</span>\n                        <input type="number" class="portal-end-x mazemaster-input" value="" placeholder="auto" min="0">\n                        <span>Y</span>\n                        <input type="number" class="portal-end-y mazemaster-input" value="" placeholder="auto" min="0">\n                    </div>\n                </div>\n            '),n.querySelector(".remove-portal-btn").addEventListener("click",(()=>{n.remove(),pe()})),n.querySelector(".portal-color-input").addEventListener("input",(e=>{n.querySelector(".portal-color").style.background=e.target.value})),n.querySelector(".portal-id").addEventListener("input",(e=>{n.querySelector(".portal-name").textContent=e.target.value||"Portal ".concat(t+1)})),e.appendChild(n),pe()})),document.querySelectorAll("#mazemaster_portals_list .remove-portal-btn").forEach((e=>{e.addEventListener("click",(()=>{e.closest(".mazemaster-portal-item").remove(),pe()}))})),document.querySelectorAll("#mazemaster_portals_list .portal-color-input").forEach((e=>{e.addEventListener("input",(e=>{e.target.closest(".mazemaster-portal-item").querySelector(".portal-color").style.background=e.target.value}))}));const ue=document.getElementById("mazemaster_add_objective_btn");function he(){var e;const t=document.getElementById("mazemaster_objectives_list"),n=null===(e=document.querySelector('[data-target="objectives_section"]'))||void 0===e||null===(e=e.closest(".mazemaster-collapsible"))||void 0===e?void 0:e.querySelector(".mazemaster-collapse-hint");t&&n&&(n.textContent="(".concat(t.children.length," objectives)"))}ue&&ue.addEventListener("click",(()=>{const e=document.getElementById("mazemaster_objectives_list");if(!e)return;const t=e.children.length,n=document.createElement("div");n.className="mazemaster-objective-item",n.dataset.objectiveIndex=t,n.innerHTML='\n                <div class="objective-config-header">\n                    <span class="objective-name">Objective '.concat(t+1,'</span>\n                    <button class="menu_button remove-objective-btn" title="Remove Objective">\n                        <i class="fa-solid fa-trash"></i>\n                    </button>\n                </div>\n                <div class="objective-config-details">\n                    <div class="objective-config-row">\n                        <label>ID:</label>\n                        <input type="text" class="objective-id mazemaster-input" value="" placeholder="obj').concat(t+1,'">\n                    </div>\n                    <div class="objective-config-row">\n                        <label>Type:</label>\n                        <select class="objective-type mazemaster-select">\n                            <option value="collect">Collect Item</option>\n                            <option value="defeat">Defeat Minion</option>\n                            <option value="explore">Explore %</option>\n                        </select>\n                    </div>\n                    <div class="objective-config-row objective-target-row">\n                        <label>Target:</label>\n                        <input type="text" class="objective-target mazemaster-input" value="" placeholder="key, pow, stealth...">\n                    </div>\n                    <div class="objective-config-row">\n                        <label>Count:</label>\n                        <input type="number" class="objective-count mazemaster-input" value="1" min="1">\n                    </div>\n                    <div class="objective-config-row">\n                        <label>Description:</label>\n                        <input type="text" class="objective-description mazemaster-input" value="" placeholder="Find 3 Keys">\n                    </div>\n                    <div class="objective-config-row">\n                        <label>Required:</label>\n                        <input type="checkbox" class="objective-required" checked>\n                    </div>\n                    <div class="objective-config-row">\n                        <label>Reward Script:</label>\n                        <input type="text" class="objective-reward mazemaster-input" value="" placeholder="/echo Objective complete!">\n                    </div>\n                </div>\n            '),n.querySelector(".remove-objective-btn").addEventListener("click",(()=>{n.remove(),he()}));const a=n.querySelector(".objective-type"),o=n.querySelector(".objective-target-row");a.addEventListener("change",(()=>{o.style.display="explore"===a.value?"none":"flex"})),n.querySelector(".objective-description").addEventListener("input",(e=>{n.querySelector(".objective-name").textContent=e.target.value||"Objective ".concat(t+1)})),e.appendChild(n),he()})),document.querySelectorAll("#mazemaster_objectives_list .remove-objective-btn").forEach((e=>{e.addEventListener("click",(()=>{e.closest(".mazemaster-objective-item").remove(),he()}))})),document.querySelectorAll("#mazemaster_objectives_list .objective-type").forEach((e=>{const t=e.closest(".mazemaster-objective-item").querySelector(".objective-target-row");e.addEventListener("change",(()=>{t.style.display="explore"===e.value?"none":"flex"}))}));const ge=document.getElementById("mazemaster_add_encounter_btn");ge&&ge.addEventListener("click",(()=>{const e=document.getElementById("mazemaster_maze_encounters_list");if(!e)return;const t=Object.keys(de.minions||{}).map((e=>{const t=de.minions[e];return'<option value="'.concat(e,'">').concat(t.name||e,"</option>")})).join(""),n=document.createElement("div");n.className="mazemaster-encounter-row",n.innerHTML='\n                <select class="encounter-minion-select">\n                    <option value="">Select Minion</option>\n                    '.concat(t,'\n                </select>\n                <input type="number" class="encounter-percent-input" min="1" max="100" value="5" placeholder="%">\n                <span class="encounter-percent-label">%</span>\n                <button class="encounter-remove-btn menu_button"><i class="fa-solid fa-trash"></i></button>\n            '),n.querySelector(".encounter-remove-btn").addEventListener("click",(()=>{n.remove()})),e.appendChild(n)}));const fe=document.getElementById("mazemaster_add_trap_encounter_btn");fe&&fe.addEventListener("click",(()=>{const e=document.getElementById("mazemaster_maze_traps_list");if(!e)return;const t=Pe().map((e=>{const t=Be(e);return'<option value="'.concat($t(e),'">').concat($t((null==t?void 0:t.name)||e),"</option>")})).join("");if(!t)return void alert("No traps available. Create traps in the Traps tab first.");const n=document.createElement("div");n.className="mazemaster-encounter-row mazemaster-trap-encounter-row",n.innerHTML='\n                <select class="trap-encounter-select">\n                    <option value="">Select Trap</option>\n                    '.concat(t,'\n                </select>\n                <input type="number" class="trap-encounter-percent-input" min="1" max="100" value="5" placeholder="%">\n                <span class="encounter-percent-label">%</span>\n                <button class="trap-encounter-remove-btn menu_button"><i class="fa-solid fa-trash"></i></button>\n            '),n.querySelector(".trap-encounter-remove-btn").addEventListener("click",(()=>{n.remove()})),e.appendChild(n)}));const ve=document.getElementById("mazemaster_add_minion_btn"),be=document.getElementById("mazemaster_minion_image_file");ve&&be&&(ve.addEventListener("click",(()=>{be.click()})),be.addEventListener("change",(async e=>{var t;const n=null===(t=e.target.files)||void 0===t?void 0:t[0];if(n){try{const e="minion_".concat(Date.now()),t=await rn(n,e),a=await p("Enter minion name:",u.INPUT,"New Minion");a&&a.trim()&&(Te(e,{name:a.trim(),imagePath:t}),ln())}catch(e){alert("Image upload failed: ".concat(e.message))}be.value=""}})));const ye=document.getElementById("mazemaster_minion_profile_save_btn");ye&&ye.addEventListener("click",(async()=>{const e=await p("Enter profile name:",u.INPUT,"My Minions");if(e&&e.trim()){const t=e.trim();de.minionProfiles[t]=JSON.parse(JSON.stringify(de.minions||{})),i(),alert('Minion profile "'.concat(t,'" saved!')),fn(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_minions"))||void 0===e||e.click()}),100)}}));const Ce=document.getElementById("mazemaster_minion_profile_load_btn");Ce&&Ce.addEventListener("click",(async()=>{const e=document.getElementById("mazemaster_minion_profile_select"),t=null==e?void 0:e.value;if(!t)return void alert("Select a profile to load");await p('Load minion profile "'.concat(t,'"? This will replace your current minions.'),u.CONFIRM)&&(de.minions=JSON.parse(JSON.stringify(de.minionProfiles[t]||{})),i(),ln(),alert('Minion profile "'.concat(t,'" loaded!')))}));const Ie=document.getElementById("mazemaster_minion_profile_delete_btn");Ie&&Ie.addEventListener("click",(async()=>{const e=document.getElementById("mazemaster_minion_profile_select"),t=null==e?void 0:e.value;if(!t)return void alert("Select a profile to delete");await p('Delete minion profile "'.concat(t,'"?'),u.CONFIRM)&&(delete de.minionProfiles[t],i(),fn(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_minions"))||void 0===e||e.click()}),100))}));const Ae=document.getElementById("mazemaster_add_trap_btn"),Re=document.getElementById("mazemaster_trap_image_file");Ae&&Re&&(Ae.addEventListener("click",(()=>{Re.click()})),Re.addEventListener("change",(async e=>{var t;const n=null===(t=e.target.files)||void 0===t?void 0:t[0];if(n){try{const e="trap_".concat(Date.now()),t=await rn(n,e),a=await p("Enter trap name:",u.INPUT,"New Trap");a&&a.trim()&&(Le(e,{name:a.trim(),imagePath:t,message:"You triggered a trap!",script:""}),cn())}catch(e){alert("Image upload failed: ".concat(e.message))}Re.value=""}})));const Fe=document.getElementById("mazemaster_trap_profile_save_btn");Fe&&Fe.addEventListener("click",(async()=>{const e=await p("Enter profile name:",u.INPUT,"My Traps");if(e&&e.trim()){const t=e.trim();de.trapProfiles[t]=JSON.parse(JSON.stringify(de.traps||{})),i(),alert('Trap profile "'.concat(t,'" saved!')),fn(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_traps"))||void 0===e||e.click()}),100)}}));const We=document.getElementById("mazemaster_trap_profile_load_btn");We&&We.addEventListener("click",(async()=>{const e=document.getElementById("mazemaster_trap_profile_select"),t=null==e?void 0:e.value;if(!t)return void alert("Select a profile to load");await p('Load trap profile "'.concat(t,'"? This will replace your current traps.'),u.CONFIRM)&&(de.traps=JSON.parse(JSON.stringify(de.trapProfiles[t]||{})),i(),cn(),alert('Trap profile "'.concat(t,'" loaded!')))}));const qe=document.getElementById("mazemaster_trap_profile_delete_btn");qe&&qe.addEventListener("click",(async()=>{const e=document.getElementById("mazemaster_trap_profile_select"),t=null==e?void 0:e.value;if(!t)return void alert("Select a profile to delete");await p('Delete trap profile "'.concat(t,'"?'),u.CONFIRM)&&(delete de.trapProfiles[t],i(),fn(),setTimeout((()=>{var e;null===(e=document.getElementById("mazemaster_show_traps"))||void 0===e||e.click()}),100))}))}function fn(){const e=document.getElementById("mazemaster_drawer");e&&(e.innerHTML=Zt(),gn(),Qt(),en(),ln(),cn(),tn())}async function vn(e){if(fe.has(e))return;if(e.classList.contains("streaming")||e.classList.contains("is-typing")||e.querySelector(".mes_text.streaming"))return;const t=e.querySelector(".mes_text .stle--content")||e.querySelector(".mes_text");if(!t)return;const n=t.textContent||"",a=/\{\{wheel:([^}]+)\}\}/gi,o=/\{\{battlebar:([^}]+)\}\}/gi,i=/\{\{maze:([^}]+)\}\}/gi,s=[],r=[],l=[];let c;for(;null!==(c=a.exec(n));)s.push({full:c[0],profile:c[1].trim()});for(;null!==(c=o.exec(n));)r.push({full:c[0],profile:c[1].trim()});for(;null!==(c=i.exec(n));)l.push({full:c[0],profile:c[1].trim()});if(0===s.length&&0===r.length&&0===l.length)return;fe.add(e);const m=SillyTavern.getContext(),d=e.getAttribute("mesid");for(const t of s){console.log("[MazeMaster] Processing wheel macro: ".concat(t.full));if(!je(t.profile).error){Oe().valid&&De()}const n="[🎡 Wheel: ".concat(t.profile,"]");if(m.chat&&null!==d){const a=parseInt(d);if(m.chat[a]){const o=m.chat[a].mes,i=o.replace(t.full,"").replace(/\s+/g," ").trim(),s=o.replace(t.full,n);m.chat[a].mes=i;const r=e.querySelector(".mes_text");r&&(r.innerHTML=s)}}}for(const t of r){console.log("[MazeMaster] Processing battlebar macro: ".concat(t.full)),Ne(t.profile);const n="[⚔️ Battlebar: ".concat(t.profile,"]");if(m.chat&&null!==d){const a=parseInt(d);if(m.chat[a]){const o=m.chat[a].mes,i=o.replace(t.full,"").replace(/\s+/g," ").trim(),s=o.replace(t.full,n);m.chat[a].mes=i;const r=e.querySelector(".mes_text");r&&(r.innerHTML=s)}}}for(const t of l){console.log("[MazeMaster] Processing maze macro: ".concat(t.full)),vt(t.profile);const n="[🏛️ Maze: ".concat(t.profile,"]");if(m.chat&&null!==d){const a=parseInt(d);if(m.chat[a]){const o=m.chat[a].mes,i=o.replace(t.full,"").replace(/\s+/g," ").trim(),s=o.replace(t.full,n);m.chat[a].mes=i;const r=e.querySelector(".mes_text");r&&(r.innerHTML=s)}}}}function bn(){const e=SillyTavern.getContext();if(!e||!e.eventSource||!e.eventTypes)return console.warn("[MazeMaster] Context not ready for macro hooks, retrying..."),void setTimeout(bn,500);e.eventTypes.USER_MESSAGE_RENDERED&&e.eventSource.on(e.eventTypes.USER_MESSAGE_RENDERED,(e=>{setTimeout((()=>{const t=document.querySelector('#chat .mes[mesid="'.concat(e,'"]'));t&&vn(t)}),500)})),e.eventTypes.CHARACTER_MESSAGE_RENDERED&&e.eventSource.on(e.eventTypes.CHARACTER_MESSAGE_RENDERED,(e=>{const t=function(){let n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;const a=document.querySelector('#chat .mes[mesid="'.concat(e,'"]'));if(!a)return;(a.classList.contains("streaming")||a.classList.contains("is-typing"))&&n<5?setTimeout((()=>t(n+1)),1e3):vn(a)};setTimeout((()=>t()),500)})),console.log("[MazeMaster] Macro hooks registered")}!function(){const e=SillyTavern.getContext();e.extensionSettings[a]||(e.extensionSettings[a]=JSON.parse(JSON.stringify(ne))),de=e.extensionSettings[a];for(const e in ne)void 0===de[e]&&(de[e]=JSON.parse(JSON.stringify(ne[e])));de.profiles||(de.profiles={}),de.battlebarProfiles||(de.battlebarProfiles={}),de.mazeProfiles||(de.mazeProfiles={}),de.minions||(de.minions={}),de.traps||(de.traps={}),de.savedMazes||(de.savedMazes={}),de.minionProfiles||(de.minionProfiles={}),de.trapProfiles||(de.trapProfiles={});let t=!1;for(const[e,n]of Object.entries(ae))de.profiles[e]||(de.profiles[e]=JSON.parse(JSON.stringify(n)),t=!0,console.log("[MazeMaster] Added default wheel profile: ".concat(e)));de.currentProfile||(de.currentProfile="Reward Wheel");for(const[e,n]of Object.entries(oe))de.battlebarProfiles[e]||(de.battlebarProfiles[e]=JSON.parse(JSON.stringify(n)),t=!0,console.log("[MazeMaster] Added default battlebar profile: ".concat(e)));de.currentBattlebarProfile||(de.currentBattlebarProfile="Easy Fight");const n=oe["Easy Fight"];for(const[e,a]of Object.entries(de.battlebarProfiles))for(const[o,i]of Object.entries(n))void 0===a[o]&&(a[o]=JSON.parse(JSON.stringify(i)),t=!0,console.log('[MazeMaster] Added missing field "'.concat(o,'" to battlebar profile: ').concat(e)));for(const[e,n]of Object.entries(se))de.minions[e]||(de.minions[e]=JSON.parse(JSON.stringify(n)),t=!0,console.log("[MazeMaster] Added default minion: ".concat(e)));for(const[e,n]of Object.entries(re))de.traps[e]||(de.traps[e]=JSON.parse(JSON.stringify(n)),t=!0,console.log("[MazeMaster] Added default trap: ".concat(e)));for(const[e,n]of Object.entries(le))de.minionProfiles[e]||(de.minionProfiles[e]=JSON.parse(JSON.stringify(n)),t=!0,console.log("[MazeMaster] Added default minion profile: ".concat(e)));for(const[e,n]of Object.entries(ce))de.trapProfiles[e]||(de.trapProfiles[e]=JSON.parse(JSON.stringify(n)),t=!0,console.log("[MazeMaster] Added default trap profile: ".concat(e)));for(const[e,n]of Object.entries(me))if(de.mazeProfiles[e]){const a=de.mazeProfiles[e];for(const[o,i]of Object.entries(n)){const n=Array.isArray(a[o])&&0===a[o].length,s="object"==typeof a[o]&&null!==a[o]&&!Array.isArray(a[o])&&0===Object.keys(a[o]).length,r=void 0===a[o]||n||s,l="startingInventory"===o&&a[o]&&"object"==typeof a[o]&&0===(a[o].key||0)&&0===(a[o].stealth||0)&&0===(a[o].pow||0)&&0===(a[o].grandpow||0);(r||l)&&i&&(!Array.isArray(i)||i.length>0)&&(a[o]=JSON.parse(JSON.stringify(i)),t=!0,console.log("[MazeMaster] Added missing/empty field '".concat(o,"' to maze profile: ").concat(e)))}}else de.mazeProfiles[e]=JSON.parse(JSON.stringify(n)),t=!0,console.log("[MazeMaster] Added default maze profile: ".concat(e));de.currentMazeProfile||(de.currentMazeProfile="Dungeon Crawl"),t&&i(),console.log("[MazeMaster] Loaded settings:",de)}(),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",(()=>{mn(),Fe(),bn()})):(mn(),Fe(),bn()),console.log("[".concat(a,"] Extension loaded (folder: ").concat(o,")"))})();